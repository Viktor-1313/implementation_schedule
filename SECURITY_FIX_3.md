# Исправление критической проблемы #3: Настройка CORS и заголовки безопасности

**Дата:** 2025-01-XX  
**Статус:** ✅ Выполнено

## Проблема

`app.use(cors())` разрешал запросы с любых доменов без ограничений. Это создавало серьезную уязвимость безопасности:
- Любой сайт мог делать запросы к API (CSRF атаки)
- Отсутствовали заголовки безопасности
- Не было принудительного HTTPS в продакшене

## Решение

### 1. Настроен CORS с ограничением доменов

Создана конфигурация CORS, которая:
- ✅ Разрешает запросы только с указанных доменов
- ✅ Поддерживает переменные окружения для гибкой настройки
- ✅ Разрешает локальные домены в режиме разработки
- ✅ Разрешает запросы без origin (Postman, curl, мобильные приложения) - безопасно, так как есть проверка авторизации

#### Разрешенные домены по умолчанию:
- `http://localhost:3001` - локальная разработка
- `http://127.0.0.1:3001` - локальная разработка (альтернативный адрес)
- `http://icona_academy.corppn.ru:3001` - внутренний сервер компании

#### Настройка через переменные окружения:

```bash
# Указать домен продакшена
export PRODUCTION_URL="https://ваш-проект.onrender.com"

# Указать дополнительные разрешенные домены (через запятую)
export ALLOWED_ORIGINS="https://example.com,https://another-domain.com"
```

#### Параметры CORS:
- `credentials: true` - разрешена отправка cookies и заголовков авторизации
- `methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']` - разрешенные HTTP методы
- `allowedHeaders` - разрешенные заголовки, включая наши кастомные заголовки авторизации
- `exposedHeaders` - заголовки, доступные клиенту

### 2. Добавлены заголовки безопасности

Установлены следующие заголовки безопасности:

#### `X-Content-Type-Options: nosniff`
- Запрещает браузеру определять MIME-тип файла автоматически
- Защита от MIME-sniffing атак

#### `X-Frame-Options: SAMEORIGIN`
- Защита от clickjacking атак
- Разрешает встраивание в iframe только с того же домена
- Можно изменить на `DENY` для полного запрета iframe

#### `X-XSS-Protection: 1; mode=block`
- Включает встроенную защиту от XSS в старых браузерах
- Современные браузеры используют CSP вместо этого

#### `Content-Security-Policy`
- Базовая политика безопасности контента
- Разрешает только ресурсы с того же домена (`'self'`)
- Разрешает inline скрипты и стили (для работы существующего кода)
- Можно ужесточить в будущем

#### `Strict-Transport-Security` (HSTS)
- Принудительное использование HTTPS
- Действует 1 год (`max-age=31536000`)
- Включает поддомены (`includeSubDomains`)
- Поддержка preload списка

#### `Referrer-Policy: strict-origin-when-cross-origin`
- Контролирует, какая информация отправляется в заголовке Referer
- Баланс между безопасностью и функциональностью

#### `Permissions-Policy`
- Отключает неиспользуемые функции браузера (геолокация, микрофон, камера)
- Снижает поверхность атаки

### 3. Принудительный HTTPS в продакшене

Добавлена проверка HTTPS для POST/PUT/DELETE запросов в продакшене:
- GET запросы разрешены по HTTP (для обратной совместимости)
- POST/PUT/DELETE запросы требуют HTTPS в продакшене
- Проверка работает через заголовки прокси (`x-forwarded-proto`)

## Конфигурация

### Переменные окружения

Для настройки CORS и безопасности можно использовать следующие переменные:

```bash
# Режим работы (production/development)
NODE_ENV=production

# URL продакшена (для добавления в список разрешенных доменов)
PRODUCTION_URL=https://ваш-проект.onrender.com

# Дополнительные разрешенные домены (через запятую)
ALLOWED_ORIGINS=https://example.com,https://another-domain.com
```

### Пример настройки для Render.com

```bash
# В настройках Render.com добавить переменные окружения:
NODE_ENV=production
PRODUCTION_URL=https://ваш-проект.onrender.com
```

## Безопасность

✅ CORS настроен правильно - только разрешенные домены  
✅ Заголовки безопасности установлены  
✅ Принудительный HTTPS для модифицирующих запросов в продакшене  
✅ Защита от clickjacking, MIME-sniffing, XSS  
✅ HSTS для принудительного HTTPS  

## Обратная совместимость

- ✅ Локальная разработка продолжает работать
- ✅ Внутренний сервер компании продолжает работать
- ✅ Запросы без origin разрешены (для инструментов разработки)
- ✅ В режиме разработки разрешены все локальные домены

## Тестирование

### Проверка CORS:

1. **С разрешенного домена** (должно работать):
   ```bash
   curl -H "Origin: http://localhost:3001" \
        -H "X-User-Login: Driga_VA" \
        http://localhost:3001/api/companies
   ```

2. **С неразрешенного домена** (должно быть отклонено):
   ```bash
   curl -H "Origin: https://evil-site.com" \
        http://localhost:3001/api/companies
   # Должно вернуть ошибку CORS
   ```

3. **Без origin** (должно работать для инструментов):
   ```bash
   curl -H "X-User-Login: Driga_VA" \
        http://localhost:3001/api/companies
   ```

### Проверка заголовков безопасности:

```bash
curl -I http://localhost:3001/auth.html

# Должны присутствовать:
# X-Content-Type-Options: nosniff
# X-Frame-Options: SAMEORIGIN
# X-XSS-Protection: 1; mode=block
# Content-Security-Policy: ...
```

## Рекомендации для продакшена

1. **Установить переменную окружения `PRODUCTION_URL`** с реальным URL продакшена
2. **Убедиться, что используется HTTPS** (Render.com предоставляет его автоматически)
3. **Рассмотреть ужесточение CSP** после исправления XSS уязвимостей
4. **Мониторить логи** на предмет попыток доступа с неразрешенных доменов

## Следующие шаги

После исправления XSS уязвимостей можно ужесточить Content-Security-Policy:
- Убрать `'unsafe-inline'` для скриптов
- Убрать `'unsafe-eval'` для скриптов
- Использовать nonce или hash для inline скриптов

---

**Важно:** После этого исправления все запросы с неразрешенных доменов будут отклоняться с ошибкой CORS.









