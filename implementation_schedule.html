<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>–ì—Ä–∞—Ñ–∏–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏ –æ–±—É—á–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã ICONA</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <!-- Open Graph –º–µ—Ç–∞—Ç–µ–≥–∏ –¥–ª—è –ø—Ä–µ–≤—å—é —Å—Å—ã–ª–æ–∫ -->
    <meta property="og:title" content="–ì—Ä–∞—Ñ–∏–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏ –æ–±—É—á–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã ICONA">
    <meta property="og:description" content="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏ –æ–±—É—á–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–µ ICONA">
    <meta property="og:image" content="logo.png">
    <meta property="og:type" content="website">
    <meta property="og:url" content="">
    <!-- html2pdf.js –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (–ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ PDF) -->
    <!-- –õ–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–ø–∏—è XLSX –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å–µ—Ç–∏ (–±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç CDN).
         –§–∞–π–ª xlsx.min.js –¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º —Å implementation_schedule.html –∏–ª–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ. -->
    <script src="xlsx.min.js"></script>
    <style>
        :root {
            --color-primary: #1e88e5;
            --color-primary-hover: #1565c0;
            --color-bg: #f5f5f5;
            --color-surface: #ffffff;
            --color-text: #1a1a1a;
            --color-text-secondary: #666666;
            --color-border: #e0e0e0;
            --color-success: #4caf50;
            --color-warning: #ff9800;
            --color-error: #f44336;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
        [data-theme="dark"] {
            --color-primary: #42a5f5;
            --color-primary-hover: #64b5f6;
            --color-bg: #121212;
            --color-surface: #1e1e1e;
            --color-text: #e0e0e0;
            --color-text-secondary: #b0b0b0;
            --color-border: #333333;
            --color-success: #66bb6a;
            --color-warning: #ffa726;
            --color-error: #ef5350;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            opacity: 0;
            animation: fadeInFromFog 1.5s ease-out forwards;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∏–∑ —Ç—É–º–∞–Ω–∞ */
        @keyframes fadeInFromFog {
            0% {
                opacity: 0;
                filter: blur(30px);
                transform: scale(0.95);
            }
            50% {
                opacity: 0.3;
                filter: blur(15px);
                transform: scale(0.98);
            }
            100% {
                opacity: 1;
                filter: blur(0px);
                transform: scale(1);
            }
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç —Ç—É–º–∞–Ω–∞ –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 50% 50%, rgba(200, 230, 255, 0.4) 0%, transparent 60%),
                radial-gradient(circle at 30% 30%, rgba(173, 216, 230, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(135, 206, 250, 0.3) 0%, transparent 50%);
            animation: fogDissolve 1.5s ease-out forwards;
            z-index: 9999;
            pointer-events: none;
        }

        [data-theme="dark"] body::before {
            background: 
                radial-gradient(circle at 50% 50%, rgba(30, 30, 50, 0.6) 0%, transparent 60%),
                radial-gradient(circle at 30% 30%, rgba(20, 20, 40, 0.5) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(25, 25, 45, 0.5) 0%, transparent 50%);
        }

        @keyframes fogDissolve {
            0% {
                opacity: 1;
                transform: scale(1.2);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.1);
            }
            100% {
                opacity: 0;
                transform: scale(1);
            }
        }

        .container {
            /* –ë—ã–ª–æ 1400px ‚Äî —É–≤–µ–ª–∏—á–∏–ª–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ 400px –ø–æ –≤–∞—à–µ–π –ø—Ä–æ—Å—å–±–µ */
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 0;
            animation: containerAppear 1.5s ease-out 0.3s both;
        }

        @keyframes containerAppear {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header {
            position: relative; /* –î–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫ */
            background: var(--color-surface);
            padding: 30px 20px;
            border-bottom: 2px solid var(--color-primary);
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            position: relative;
        }

        /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã */
        .theme-toggle-btn {
            position: absolute !important;
            top: 30px !important;
            right: 80px !important;
            left: auto !important;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
            border: 2px solid #2c2c2c;
            cursor: pointer;
            display: flex !important;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            z-index: 1001 !important;
            overflow: visible;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* –ó–æ–ª–æ—Ç–∞—è —Ç–æ—á–∫–∞, –≤—Ä–∞—â–∞—é—â–∞—è—Å—è –ø–æ –∫—Ä—É–≥—É –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        .theme-toggle-btn::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(255, 215, 0, 0.8);
            top: 50%;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            opacity: 0;
            z-index: 1002;
            transition: opacity 0.3s ease;
        }

        /* –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–æ–ª–æ—Ç—É—é —Ç–æ—á–∫—É –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é */
        .theme-toggle-btn:hover::after {
            opacity: 1;
            animation: rotateDot 2s linear infinite;
        }

        .theme-toggle-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(66, 165, 245, 0.4);
        }

        .theme-toggle-btn::before {
            content: 'üåô';
            font-size: 20px;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.3s ease;
            display: inline-block;
            z-index: 1003;
            position: relative;
        }

        [data-theme="dark"] .theme-toggle-btn::before {
            content: '‚òÄÔ∏è';
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã */
        .theme-toggle-btn.animating {
            animation: themeTogglePulse 0.8s ease-in-out;
        }

        .theme-toggle-btn.animating::before {
            animation: themeIconRotate 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes themeTogglePulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.08);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes themeIconRotate {
            0% {
                transform: rotate(0deg) scale(1);
                opacity: 1;
            }
            50% {
                transform: rotate(180deg) scale(0.7);
                opacity: 0.5;
            }
            100% {
                transform: rotate(360deg) scale(1);
                opacity: 1;
            }
        }

        .theme-toggle-btn:hover .theme-tooltip {
            opacity: 1 !important;
            visibility: visible !important;
            transition-delay: 1s;
        }

        .theme-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #000000;
            color: #ffffff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 1001;
        }

        .theme-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #000000;
        }

        /* –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É */
        .profile-btn {
            position: absolute !important;
            top: 30px !important;
            right: 30px !important;
            left: auto !important;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
            border: 2px solid #2c2c2c;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            z-index: 1000;
            overflow: visible;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è –∑–æ–ª–æ—Ç–æ–π —Ç–æ—á–∫–∏ –ø–æ –∫—Ä—É–≥—É –ø–æ —á–∞—Å–æ–≤–æ–π —Å—Ç—Ä–µ–ª–∫–µ */
        @keyframes rotateDot {
            0% {
                transform: translateX(-50%) rotate(0deg) translateY(20px) rotate(0deg);
            }
            100% {
                transform: translateX(-50%) rotate(360deg) translateY(20px) rotate(-360deg);
            }
        }

        /* –ó–æ–ª–æ—Ç–∞—è —Ç–æ—á–∫–∞, –≤—Ä–∞—â–∞—é—â–∞—è—Å—è –ø–æ –∫—Ä—É–≥—É –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        .profile-btn::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(255, 215, 0, 0.8);
            top: 50%;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            opacity: 0;
            z-index: 1001;
            transition: opacity 0.3s ease;
        }

        /* –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–æ–ª–æ—Ç—É—é —Ç–æ—á–∫—É –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é */
        .profile-btn:hover::after {
            opacity: 1;
            animation: rotateDot 2s linear infinite;
        }

        .profile-btn:hover:not(.animating) {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(66, 165, 245, 0.4);
        }

        /* –ò–∫–æ–Ω–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è (–≥–æ–ª–æ–≤–∞) */
        .profile-btn .profile-icon-head {
            position: absolute;
            width: 18px;
            height: 18px;
            background: var(--color-surface);
            border-radius: 50%;
            top: 8px;
            z-index: 1002;
        }

        /* –ì–ª–∞–∑–∞ –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-btn .profile-icon-head::before,
        .profile-btn .profile-icon-head::after {
            content: '';
            position: absolute;
            width: 2.5px;
            height: 2.5px;
            background: #42a5f5;
            border-radius: 50%;
            top: 5.5px;
        }

        .profile-btn .profile-icon-head::before {
            left: 4.5px;
        }

        .profile-btn .profile-icon-head::after {
            right: 4.5px;
        }

        /* –†–æ—Ç –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-icon-mouth {
            position: absolute;
            width: 7px;
            height: 3.5px;
            border: 2px solid #42a5f5;
            border-top: none;
            border-radius: 0 0 7px 7px;
            top: 17px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1003;
            background: transparent;
        }

        /* –ò–∫–æ–Ω–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è (–ø–ª–µ—á–∏) */
        .profile-btn .profile-icon-shoulders {
            position: absolute;
            width: 22px;
            height: 12px;
            background: white;
            border-radius: 12px 12px 0 0;
            bottom: 6px;
            z-index: 1002;
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-btn[data-tooltip] {
            position: relative;
        }

        .profile-btn[data-tooltip]:hover .profile-tooltip {
            opacity: 1;
            transition-delay: 1s;
        }

        .profile-tooltip {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: #000000 !important;
            color: white !important;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: normal;
            min-width: max-content;
            max-width: 200px;
            word-wrap: break-word;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 10001;
            width: auto;
            height: auto;
        }

        /* –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –∫ –≤—ã–±–æ—Ä—É –∫–æ–º–ø–∞–Ω–∏–π (—Å–∫—Ä—ã—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∏–∂–µ) */
        .companies-btn {
            display: none !important;
        }

        /* –ó–æ–ª–æ—Ç–∞—è —Ç–æ—á–∫–∞, –≤—Ä–∞—â–∞—é—â–∞—è—Å—è –ø–æ –∫—Ä—É–≥—É –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        .companies-btn::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(255, 215, 0, 0.8);
            top: 50%;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            opacity: 0;
            z-index: 1001;
            transition: opacity 0.3s ease;
        }

        /* –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–æ–ª–æ—Ç—É—é —Ç–æ—á–∫—É –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é */
        .companies-btn:hover::after {
            opacity: 1;
            animation: rotateDot 2s linear infinite;
        }

        .companies-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        /* –ò–∫–æ–Ω–∫–∞ –∫–≤–∞–¥—Ä–∞—Ç–∞ —Å —Ç–æ—á–∫–æ–π –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π */
        .companies-btn .companies-icon {
            width: 18px;
            height: 18px;
            border: 2px solid white;
            border-radius: 4px;
            position: absolute;
            z-index: 1002;
        }

        /* –¢–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–≤–∞–¥—Ä–∞—Ç–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π */
        .companies-btn .companies-icon::before {
            content: '';
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 4px;
            left: 4px;
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π */
        .companies-btn {
            position: relative;
        }
        
        .companies-btn:hover .companies-tooltip {
            opacity: 1 !important;
            visibility: visible !important;
            transition-delay: 1s;
        }

        .companies-tooltip {
            position: absolute;
            top: 50%;
            right: calc(100% + 8px);
            transform: translateY(-50%);
            padding: 8px 12px;
            border-radius: 8px;
            background: #000000;
            color: #ffffff;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 10001;
        }

        /* –¢–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–≤–∞–¥—Ä–∞—Ç–∞ */
        .companies-btn > span {
            content: '';
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 4px;
            left: 4px;
            z-index: 2;
        }

        /* –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ */
        .logout-btn {
            position: absolute;
            top: 80px;
            right: 30px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
            border: 2px solid #2c2c2c;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            z-index: 1000;
            overflow: visible;
        }

        /* –ó–æ–ª–æ—Ç–∞—è —Ç–æ—á–∫–∞, –≤—Ä–∞—â–∞—é—â–∞—è—Å—è –ø–æ –∫—Ä—É–≥—É –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        .logout-btn::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(255, 215, 0, 0.8);
            top: 50%;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            opacity: 0;
            z-index: 1001;
            transition: opacity 0.3s ease;
        }

        /* –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–æ–ª–æ—Ç—É—é —Ç–æ—á–∫—É –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é */
        .logout-btn:hover::after {
            opacity: 1;
            animation: rotateDot 2s linear infinite;
        }

        .logout-btn:hover:not(.animating) {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(66, 165, 245, 0.4);
        }

        /* –ò–∫–æ–Ω–∫–∞ –≤—ã—Ö–æ–¥–∞ (—Å—Ç—Ä–µ–ª–∫–∞ –≤–ª–µ–≤–æ) */
        .logout-btn .logout-icon {
            width: 12px;
            height: 12px;
            border-left: 3px solid white;
            border-top: 3px solid white;
            transform: rotate(-45deg) translateX(2px);
            z-index: 1002;
            position: absolute;
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞ */
        .logout-btn[data-tooltip]:hover .logout-tooltip {
            opacity: 1;
            transform: translate(-6px, -50%);
            transition-delay: 1s;
        }

        .logout-tooltip {
            content: attr(data-tooltip);
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translate(0, -50%);
            padding: 8px 12px;
            border-radius: 8px;
            background: #000000 !important;
            color: #fff !important;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: right center;
            margin-right: 8px;
            z-index: 10001;
        }

        /* –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π –≤—ã—Ö–æ–¥–∞ */
        .companies-bottom-btn {
            position: absolute !important;
            top: 130px;
            right: 30px !important;
            left: auto !important;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
            border: 2px solid #2c2c2c;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            z-index: 1000;
            overflow: visible;
        }

        /* –ó–æ–ª–æ—Ç–∞—è —Ç–æ—á–∫–∞, –≤—Ä–∞—â–∞—é—â–∞—è—Å—è –ø–æ –∫—Ä—É–≥—É –¥–ª—è –Ω–∏–∂–Ω–µ–π –∫–Ω–æ–ø–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π */
        .companies-bottom-btn::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(255, 215, 0, 0.8);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -20px);
            opacity: 0;
            z-index: 1001;
            transition: opacity 0.3s ease;
        }

        .companies-bottom-btn:hover:not(.animating) {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(66, 165, 245, 0.4);
        }

        .companies-bottom-btn:hover::after {
            opacity: 1;
            animation: rotateDot 2s linear infinite;
        }

        /* –ò–∫–æ–Ω–∫–∞ —Å–µ—Ç–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π (4 –∫–≤–∞–¥—Ä–∞—Ç–∞ –≤ —Å–µ—Ç–∫–µ) */
        .companies-bottom-icon {
            width: 18px;
            height: 18px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='3' width='7' height='7'%3E%3C/rect%3E%3Crect x='14' y='3' width='7' height='7'%3E%3C/rect%3E%3Crect x='14' y='14' width='7' height='7'%3E%3C/rect%3E%3Crect x='3' y='14' width='7' height='7'%3E%3C/rect%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π */
        .companies-bottom-btn:hover .companies-bottom-tooltip {
            opacity: 1 !important;
            visibility: visible !important;
            transition-delay: 1s;
        }

        .companies-bottom-tooltip {
            position: absolute;
            top: 50%;
            right: calc(100% + 8px);
            transform: translateY(-50%);
            padding: 8px 12px;
            border-radius: 8px;
            background: #000000;
            color: #ffffff;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 10001;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .profile-modal.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 10vh; /* –ü–æ–¥–Ω–∏–º–∞–µ–º –æ–∫–Ω–æ –≤—ã—à–µ */
        }

        @media (max-width: 768px) {
            .profile-modal.show {
                padding-top: 5vh;
                align-items: center;
            }
        }

        @media (max-width: 480px) {
            .profile-modal.show {
                padding-top: 2vh;
                padding-left: 5px;
                padding-right: 5px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .profile-modal-content {
            background: var(--color-surface);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            position: relative;
            margin-top: 10vh; /* –ü–æ–¥–Ω–∏–º–∞–µ–º –æ–∫–Ω–æ –≤—ã—à–µ */
            cursor: default;
        }

        .profile-modal-header {
            cursor: move;
            user-select: none;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .profile-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .profile-modal-header h2 {
            color: #1565c0;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .profile-modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: #999;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .profile-modal-close:hover {
            background: #f5f5f5;
            color: #333;
        }

        .profile-form-group {
            margin-bottom: 25px;
        }

        .profile-form-group label {
            display: block;
            color: #1565c0;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .profile-form-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(100, 181, 246, 0.3);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--color-bg);
            color: var(--color-text);
        }

        [data-theme="dark"] .profile-form-group input {
            border-color: rgba(100, 181, 246, 0.5);
            background: var(--color-surface);
        }

        .profile-form-group input:focus {
            outline: none;
            border-color: #42a5f5;
            box-shadow: 0 0 0 4px rgba(66, 165, 245, 0.15);
            background: var(--color-surface);
        }

        .profile-form-group input::placeholder {
            color: var(--color-text-secondary);
        }

        [data-theme="dark"] .profile-form-group input::placeholder {
            color: rgba(176, 176, 176, 0.7);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –ì–∞–Ω—Ç–∞ */
        [data-theme="dark"] .gantt-chart {
            background: var(--color-surface);
        }

        [data-theme="dark"] .gantt-chart::-webkit-scrollbar-thumb {
            background: #64b5f6;
        }

        [data-theme="dark"] .gantt-chart::-webkit-scrollbar-track {
            background: #2e2e2e;
        }

        [data-theme="dark"] .gantt-chart {
            scrollbar-color: #64b5f6 #2e2e2e;
        }

        [data-theme="dark"] .gantt-header {
            background: var(--color-surface);
            border-color: var(--color-border);
        }

        [data-theme="dark"] .gantt-header-first-row {
            background: var(--color-surface);
        }

        [data-theme="dark"] .gantt-header-label {
            background: var(--color-surface);
            border-color: var(--color-border);
            color: var(--color-text);
        }

        [data-theme="dark"] .gantt-details-cell {
            background: var(--color-surface);
            border-color: var(--color-border);
            color: var(--color-text);
        }

        [data-theme="dark"] .gantt-details-input {
            background: var(--color-bg);
            color: var(--color-text);
            border-color: var(--color-border);
        }

        [data-theme="dark"] .gantt-details-input:focus {
            background: var(--color-surface);
            border-color: var(--color-primary);
        }

        [data-theme="dark"] body.view-mode .gantt-details-input[readonly],
        [data-theme="dark"] body.view-mode .gantt-details-input[data-field="startDate"],
        [data-theme="dark"] body.view-mode .gantt-details-input[data-field="endDate"],
        [data-theme="dark"] body.view-mode .gantt-details-input[data-field="days"],
        [data-theme="dark"] body.view-mode .gantt-details-input[disabled] {
            background-color: var(--color-bg);
            color: var(--color-text-secondary);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –∑–∞–¥–∞—á –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
        [data-theme="dark"] body.view-mode .tasks-table-input[readonly],
        [data-theme="dark"] body.view-mode .tasks-table-input[data-field="startDate"],
        [data-theme="dark"] body.view-mode .tasks-table-input[data-field="endDate"],
        [data-theme="dark"] body.view-mode .tasks-table-input[data-field="days"],
        [data-theme="dark"] body.view-mode .tasks-table-input[data-field="stageSuffix"],
        [data-theme="dark"] body.view-mode .tasks-table-input[data-field="control"],
        [data-theme="dark"] body.view-mode .tasks-table-input[data-field="taskTitle"],
        [data-theme="dark"] body.view-mode .tasks-table-input-select[disabled] {
            background-color: var(--color-bg);
            color: var(--color-text-secondary);
            opacity: 0.7;
        }

        [data-theme="dark"] .stage-row-collapsed .gantt-details-cell.link-cell select[disabled],
        [data-theme="dark"] .stage-row-collapsed .gantt-details-cell.responsible-cell {
            background-color: var(--color-bg);
            color: var(--color-text-secondary);
        }

        [data-theme="dark"] .gantt-cell {
            background: var(--color-surface);
            border-color: var(--color-border);
        }

        [data-theme="dark"] .gantt-weekend {
            background: #4a2c2c;
        }

        [data-theme="dark"] .gantt-holiday {
            background: #4a4a2c;
        }

        [data-theme="dark"] .gantt-future-header {
            background: #2e2e2e;
            color: var(--color-text-secondary);
        }

        [data-theme="dark"] .gantt-future-cell {
            background: #1a1a1a;
        }

        [data-theme="dark"] .gantt-cell.drag-target {
            background: rgba(66, 165, 245, 0.2) !important;
            box-shadow: inset 0 0 0 2px #42a5f5;
        }

        [data-theme="dark"] .gantt-cell.resize-target {
            background: rgba(102, 187, 106, 0.2) !important;
            box-shadow: inset 0 0 0 2px #66bb6a;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –∑–∞–¥–∞—á */
        [data-theme="dark"] .task-table {
            background: var(--color-surface);
            border-color: var(--color-border);
        }

        [data-theme="dark"] .task-table th {
            background: var(--color-surface);
            border-color: var(--color-border);
            color: var(--color-text);
        }

        [data-theme="dark"] .task-table td {
            background: var(--color-surface);
            border-color: var(--color-border);
            color: var(--color-text);
        }

        [data-theme="dark"] .task-table tr:hover {
            background: var(--color-bg);
        }

        [data-theme="dark"] .task-table input,
        [data-theme="dark"] .task-table select {
            background: var(--color-bg);
            color: var(--color-text);
            border-color: var(--color-border);
        }

        [data-theme="dark"] .task-table input:focus,
        [data-theme="dark"] .task-table select:focus {
            background: var(--color-surface);
            border-color: var(--color-primary);
        }

        [data-theme="dark"] .task-table input[readonly],
        [data-theme="dark"] .task-table input[disabled] {
            background-color: var(--color-bg);
            color: var(--color-text-secondary);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –∑–∞–¥–∞—á */
        [data-theme="dark"] .table-section {
            background: var(--color-surface);
            border-color: var(--color-border);
            box-shadow: var(--shadow-md);
        }

        [data-theme="dark"] .table-section h2 {
            color: var(--color-primary);
        }

        [data-theme="dark"] .table-section.view-active {
            background-color: var(--color-surface) !important;
            box-shadow: 0 0 0 2px rgba(66, 165, 245, 0.3), var(--shadow-md) !important;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –∑–∞–¥–∞—á (.tasks-table) */
        [data-theme="dark"] .tasks-table {
            background: var(--color-surface);
            border-color: var(--color-border);
        }

        [data-theme="dark"] .tasks-table th {
            background: var(--color-primary);
            border-color: var(--color-border);
            color: white;
        }

        [data-theme="dark"] #tasksTable thead th {
            background: var(--color-primary);
            border-color: var(--color-border);
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        [data-theme="dark"] .tasks-table td {
            background: var(--color-surface);
            border-color: var(--color-border);
            color: var(--color-text);
        }

        [data-theme="dark"] .tasks-table tr:hover {
            background: var(--color-bg);
        }

        [data-theme="dark"] .tasks-table tr:nth-child(even) {
            background: var(--color-bg);
        }

        [data-theme="dark"] .tasks-table tr.selected {
            background: rgba(66, 165, 245, 0.2) !important;
        }

        [data-theme="dark"] .tasks-table tr.selected td {
            color: var(--color-text) !important;
        }

        [data-theme="dark"] .tasks-table-input,
        [data-theme="dark"] .tasks-table-input-select {
            background: var(--color-bg);
            color: var(--color-text);
            border-color: var(--color-border);
        }

        [data-theme="dark"] .tasks-table-input:focus,
        [data-theme="dark"] .tasks-table-input-select:focus {
            background: var(--color-surface);
            border-color: var(--color-primary);
        }

        [data-theme="dark"] .tasks-table-input[readonly],
        [data-theme="dark"] .tasks-table-input[disabled] {
            background-color: var(--color-bg);
            color: var(--color-text-secondary);
            opacity: 0.7;
        }

        [data-theme="dark"] .tasks-table tr.selected .tasks-table-input {
            color: var(--color-text) !important;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –æ–±–µ—Ä—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –∏ scrollbar */
        [data-theme="dark"] .tasks-table-wrapper {
            background: var(--color-surface);
            scrollbar-color: var(--color-primary) var(--color-surface);
        }

        [data-theme="dark"] .tasks-table-wrapper::-webkit-scrollbar {
            background: var(--color-surface);
        }

        [data-theme="dark"] .tasks-table-wrapper::-webkit-scrollbar-thumb {
            background: var(--color-primary);
            border-color: var(--color-surface);
        }

        [data-theme="dark"] .tasks-table-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary-hover);
        }

        [data-theme="dark"] .table-row.selected {
            background: rgba(66, 165, 245, 0.2) !important;
        }

        [data-theme="dark"] .table-row.stage-filtered {
            background: rgba(100, 181, 246, 0.1);
        }

        [data-theme="dark"] .table-row.stage-filtered.selected {
            background: rgba(66, 165, 245, 0.3) !important;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞ */
        [data-theme="dark"] .chart-container {
            background: var(--color-surface);
            border-color: var(--color-border);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –º–µ—Ç–æ–∫ —ç—Ç–∞–ø–æ–≤ */
        [data-theme="dark"] .stage-marker {
            background: var(--color-primary);
            color: white;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —Å—Ç—Ä–æ–∫ —ç—Ç–∞–ø–æ–≤ */
        [data-theme="dark"] .stage-row-collapsed {
            background: var(--color-bg);
        }

        [data-theme="dark"] .stage-row-collapsed td {
            background: var(--color-bg);
            color: var(--color-text);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–Ω–æ–ø–æ–∫ —ç—Ç–∞–ø–æ–≤ */
        [data-theme="dark"] .stage-tabs-buttons {
            background: transparent;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —ç—Ç–∞–ø–æ–≤ */
        [data-theme="dark"] .stage-tab-btn {
            background: rgba(66, 165, 245, 0.15);
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        [data-theme="dark"] .stage-tab-btn:hover {
            background: rgba(66, 165, 245, 0.25);
            border-color: var(--color-primary-hover);
        }

        [data-theme="dark"] .stage-tab-btn.active {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: #ffffff;
            border-color: var(--color-primary);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç—Ç–∞–ø–∞–º–∏ */
        [data-theme="dark"] .stage-controls-buttons {
            background: transparent;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–Ω–æ–ø–æ–∫ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —ç—Ç–∞–ø–æ–≤ */
        [data-theme="dark"] .gantt-stage-controls {
            background: rgba(66, 165, 245, 0.1);
            border-right-color: var(--color-primary);
            border-bottom-color: rgba(66, 165, 245, 0.3);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —ç—Ç–∞–ø–æ–≤ */
        [data-theme="dark"] .gantt-stage-control-btn {
            background: var(--color-primary);
            color: white;
        }

        [data-theme="dark"] .gantt-stage-control-btn:hover {
            background: var(--color-primary-hover);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –º–µ—Ç–æ–∫ —ç—Ç–∞–ø–æ–≤ */
        [data-theme="dark"] .gantt-stage-label {
            background: rgba(66, 165, 245, 0.1);
            border-right-color: var(--color-primary);
            color: var(--color-primary);
        }

        [data-theme="dark"] .gantt-stage-label:hover {
            background: rgba(66, 165, 245, 0.25);
            border-right-color: var(--color-primary-hover);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —Å–≤–µ—Ä–Ω—É—Ç—ã—Ö —Å—Ç—Ä–æ–∫ —ç—Ç–∞–ø–æ–≤ */
        [data-theme="dark"] .gantt-row.stage-row-collapsed,
        [data-theme="dark"] #tasksTableBody tr.stage-row-collapsed {
            background: rgba(66, 165, 245, 0.05);
        }

        [data-theme="dark"] .gantt-row.stage-row-collapsed:hover,
        [data-theme="dark"] #tasksTableBody tr.stage-row-collapsed:hover {
            background: rgba(66, 165, 245, 0.15);
        }

        [data-theme="dark"] .gantt-row.stage-row-collapsed .gantt-label span,
        [data-theme="dark"] #tasksTableBody tr.stage-row-collapsed td span {
            color: var(--color-primary);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–ª–æ—Å—ã –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏ */
        [data-theme="dark"] .gantt-stage-divider {
            background: var(--color-primary);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —ç—Ç–∞–ø–æ–≤ */
        [data-theme="dark"] .stage-settings-btn {
            background: rgba(66, 165, 245, 0.15);
            border-color: var(--color-primary);
        }

        [data-theme="dark"] .stage-settings-btn:hover {
            background: rgba(66, 165, 245, 0.25);
            border-color: var(--color-primary-hover);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–°–≤—è–∑—å", "–ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω", "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" –∏ "–î–µ—Ç–∞–ª—å–Ω—ã–π –≤–∏–¥" */
        [data-theme="dark"] .link-toggle-btn,
        [data-theme="dark"] .baseline-toggle-btn,
        [data-theme="dark"] .baseline-set-btn,
        [data-theme="dark"] .responsible-toggle-btn,
        [data-theme="dark"] .gantt-style-toggle-btn {
            background: rgba(66, 165, 245, 0.15);
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        [data-theme="dark"] .link-toggle-btn:hover,
        [data-theme="dark"] .baseline-toggle-btn:hover,
        [data-theme="dark"] .baseline-set-btn:hover,
        [data-theme="dark"] .responsible-toggle-btn:hover,
        [data-theme="dark"] .gantt-style-toggle-btn:hover {
            background: rgba(66, 165, 245, 0.25);
            border-color: var(--color-primary-hover);
        }

        [data-theme="dark"] .link-toggle-btn.active,
        [data-theme="dark"] .baseline-toggle-btn.active,
        [data-theme="dark"] .gantt-style-toggle-btn.active {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: #ffffff;
            border-color: var(--color-primary);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —ç—Ç–∞–ø–æ–≤ */
        [data-theme="dark"] .stage-tabs-container {
            background: transparent;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –≤ –≥—Ä–∞—Ñ–∏–∫–µ */
        [data-theme="dark"] .gantt-row.selected {
            background: rgba(66, 165, 245, 0.2) !important;
            box-shadow: inset 0 0 0 2px var(--color-primary), 0 2px 8px rgba(66, 165, 245, 0.3) !important;
        }

        [data-theme="dark"] .gantt-row.selected .gantt-label,
        [data-theme="dark"] .gantt-row.selected .gantt-details-cell {
            background: rgba(66, 165, 245, 0.2) !important;
            color: var(--color-text) !important;
        }

        [data-theme="dark"] .gantt-row.selected .gantt-label span {
            color: var(--color-text) !important;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ */
        [data-theme="dark"] tr.selected {
            background: rgba(66, 165, 245, 0.2) !important;
        }

        [data-theme="dark"] tr.selected td {
            color: var(--color-text) !important;
        }

        [data-theme="dark"] tr.selected .tasks-table-input {
            color: var(--color-text) !important;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è hover —Å—Ç—Ä–æ–∫ */
        [data-theme="dark"] .gantt-row:hover {
            background: var(--color-bg);
        }

        [data-theme="dark"] tr:hover {
            background: var(--color-bg);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ */
        [data-theme="dark"] .gantt-row.stage-active {
            background: rgba(66, 165, 245, 0.1);
        }

        [data-theme="dark"] tr.stage-active {
            background: rgba(66, 165, 245, 0.1);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞ */
        [data-theme="dark"] .chart-container.view-active {
            background-color: var(--color-surface) !important;
            box-shadow: 0 0 0 2px rgba(66, 165, 245, 0.3), var(--shadow-md) !important;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –º–µ—Ç–æ–∫ –∑–∞–¥–∞—á */
        [data-theme="dark"] .gantt-label {
            background: var(--color-surface);
            color: var(--color-text);
        }

        [data-theme="dark"] .gantt-label span {
            color: var(--color-text);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —á–µ—Ç–Ω—ã—Ö —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã */
        [data-theme="dark"] tr:nth-child(even) {
            background: var(--color-bg);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –≤—Å–µ—Ö —è—á–µ–µ–∫ —Ç–∞–±–ª–∏—Ü—ã */
        [data-theme="dark"] .task-table td {
            color: var(--color-text) !important;
        }

        [data-theme="dark"] .task-table td .tasks-table-input {
            color: var(--color-text) !important;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –≤ –º–µ—Ç–∫–∞—Ö –∑–∞–¥–∞—á */
        [data-theme="dark"] .gantt-label,
        [data-theme="dark"] .gantt-label * {
            color: var(--color-text) !important;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ controls */
        [data-theme="dark"] .controls {
            background: var(--color-surface) !important;
            border-color: var(--color-border) !important;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        [data-theme="dark"] .controls {
            background: var(--color-surface);
            border-color: var(--color-border);
        }

        [data-theme="dark"] .zoom-controls {
            background: var(--color-surface);
            border-color: var(--color-border);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
        [data-theme="dark"] .gantt-bar[data-tooltip]::after {
            background: rgba(0, 0, 0, 0.9);
            color: white;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤ –≤ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ */
        [data-theme="dark"] .gantt-details-cell select {
            background: var(--color-bg);
            color: var(--color-text);
            border-color: var(--color-border);
        }

        [data-theme="dark"] .gantt-details-cell select:focus {
            background: var(--color-surface);
            border-color: var(--color-primary);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª—ã */
        [data-theme="dark"] .gantt-time-scale {
            background: var(--color-surface);
            border-color: var(--color-border);
        }

        [data-theme="dark"] .gantt-time-scale-cell {
            background: var(--color-surface);
            border-color: var(--color-border);
            color: var(--color-text);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª—ã */
        [data-theme="dark"] .gantt-time-scale-header {
            background: var(--color-surface);
            color: var(--color-text);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∑–∞–¥–∞—á–∞–º */
        [data-theme="dark"] #searchInput {
            background: var(--color-bg) !important;
            border-color: var(--color-border) !important;
            color: var(--color-text) !important;
        }

        [data-theme="dark"] #searchInput:focus {
            background: var(--color-surface) !important;
            border-color: var(--color-primary) !important;
        }

        [data-theme="dark"] #searchInput::placeholder {
            color: rgba(100, 181, 246, 0.6) !important;
        }

        [data-theme="dark"] .search-icon {
            color: #64b5f6 !important;
            opacity: 0.8 !important;
        }

        [data-theme="dark"] #searchPrevBtn,
        [data-theme="dark"] #searchNextBtn {
            background: var(--color-surface) !important;
            border-color: var(--color-primary) !important;
            color: #64b5f6 !important;
        }

        [data-theme="dark"] #searchPrevBtn:hover,
        [data-theme="dark"] #searchNextBtn:hover {
            background: var(--color-bg) !important;
            border-color: var(--color-primary-hover) !important;
            color: var(--color-primary-hover) !important;
        }

        [data-theme="dark"] #searchPrevBtn:active,
        [data-theme="dark"] #searchNextBtn:active {
            background: var(--color-primary) !important;
            border-color: var(--color-primary) !important;
            color: white !important;
        }

        [data-theme="dark"] #searchCounter {
            color: #64b5f6 !important;
        }

        .profile-form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .profile-btn-save {
            flex: 1;
            padding: 14px 24px;
            background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }

        .profile-btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
        }

        .profile-btn-cancel {
            flex: 1;
            padding: 14px 24px;
            background: #e0e0e0;
            color: #666;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-btn-cancel:hover {
            background: #d0d0d0;
        }

        .profile-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 0.9rem;
        }

        .profile-message.success {
            background: rgba(129, 199, 132, 0.2);
            color: #2e7d32;
            border: 1px solid rgba(129, 199, 132, 0.5);
        }

        .profile-message.error {
            background: rgba(239, 83, 80, 0.2);
            color: #c62828;
            border: 1px solid rgba(239, 83, 80, 0.5);
        }

        .profile-message.show {
            display: block;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-subtitle {
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .header-icon {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            background: radial-gradient(circle at 20% 20%, #ffffff 0, #ffffff 10%, #bbdefb 30%, #1e88e5 80%);
            box-shadow: 0 0 0 2px rgba(30, 136, 229, 0.3), 0 4px 8px rgba(0, 0, 0, 0.18);
            position: relative;
        }

        .header-icon::before {
            content: '';
            position: absolute;
            inset: 6px;
            border-radius: 4px;
            border: 2px solid #ffffff;
            box-shadow: inset 0 0 0 1px rgba(21, 101, 192, 0.6);
        }

        .header-icon::after {
            content: '';
            position: absolute;
            left: 6px;
            right: 6px;
            bottom: 7px;
            height: 2px;
            background: rgba(255, 255, 255, 0.9);
        }

        .company-info {
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .company-logo-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
        }

        .company-logo-preview {
            width: 192px;
            height: 192px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            object-fit: contain;
            background: var(--color-bg);
            padding: 4px;
        }

        .company-logo-hint {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--color-text-secondary);
            pointer-events: none;
            text-align: center;
        }

        .company-name-block {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .company-name-label {
            font-size: 11px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .company-name-display {
            font-size: 40px;
            color: #9e9e9e;
            font-style: italic;
            min-height: 32px;
            outline: none;
            cursor: default;
            user-select: none;
        }

        .company-object-name-display {
            color: #64b5f6;
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 4px;
            line-height: 1.4;
        }

        .company-name-display.has-value {
            font-size: 64px;
            font-weight: 700;
            background: linear-gradient(135deg, #f44336 0%, #5b0001 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-style: normal;
        }

        .controls {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 3px solid var(--color-primary);
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
        }

        .zoom-controls .btn {
            min-width: auto !important;
            width: auto !important;
            justify-content: center;
            padding: 6px 8px !important;
            flex-shrink: 0;
        }

        .zoom-label {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .zoom-range {
            width: 120px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-icon {
            width: 18px;
            height: 18px;
            display: inline-block;
            position: relative;
        }

        /* –ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (PDF, Excel, –ì–∞–Ω—Ç/–¢–∞–±–ª–∏—Ü–∞, –°–±—Ä–æ—Å–∏—Ç—å –ø–ª–∞–Ω) */
        .controls .btn-primary,
        .controls .btn-secondary {
            background: var(--color-primary);
            color: #ffffff;
            border-radius: 6px;
            border: 1px solid var(--color-primary-hover);
            width: 180px;
            justify-content: flex-start;
            height: 40px;
            padding-left: 16px;
        }

        /* –ò—Å–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –º–∞—Å—à—Ç–∞–±–∞ –∏–∑ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —à–∏—Ä–∏–Ω—ã */
        .zoom-controls .btn-primary,
        .zoom-controls .btn-secondary {
            width: auto;
        }

        .controls .btn-primary:hover,
        .controls .btn-secondary:hover {
            background: var(--color-primary-hover);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .btn-primary .btn-icon {
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.3));
        }

        .btn-secondary .btn-icon {
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.15));
        }

        /* –ò–∫–æ–Ω–∫–∞ PDF: —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ª–∏—Å—Ç —Å —É–≥–æ–ª–∫–æ–º */
        .btn-icon-pdf::before {
            content: '';
            position: absolute;
            inset: 1px 3px 3px 3px;
            border-radius: 3px;
            border: 2px solid currentColor;
        }

        .btn-icon-pdf::after {
            content: '';
            position: absolute;
            top: 1px;
            right: 3px;
            width: 7px;
            height: 7px;
            border-top: 2px solid currentColor;
            border-right: 2px solid currentColor;
            border-radius: 0 3px 0 0;
        }

        /* –ò–∫–æ–Ω–∫–∞ Excel: —Ç–∞–±–ª–∏—Ü–∞ */
        .btn-icon-excel::before {
            content: '';
            position: absolute;
            inset: 2px;
            border-radius: 3px;
            border: 2px solid currentColor;
        }

        .btn-icon-excel::after {
            content: '';
            position: absolute;
            inset: 5px 3px;
            border-top: 2px solid currentColor;
            border-bottom: 2px solid currentColor;
            box-shadow: inset 0 0 0 1px transparent;
        }

        .btn-icon-excel {
            --col: currentColor;
        }

        .btn-icon-excel::before,
        .btn-icon-excel::after {
            color: inherit;
        }

        /* –ò–∫–æ–Ω–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∞: –¥–≤–∞ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ */
        .btn-icon-toggle::before,
        .btn-icon-toggle::after {
            content: '';
            position: absolute;
            width: 7px;
            height: 10px;
            border-radius: 2px;
            border: 2px solid currentColor;
        }

        .btn-icon-toggle::before {
            left: 1px;
            top: 3px;
        }

        .btn-icon-toggle::after {
            right: 1px;
            top: 3px;
        }

        /* –ò–∫–æ–Ω–∫–∞ —Å–±—Ä–æ—Å–∞: —Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –∫–∞–∫ —è–¥–µ—Ä–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
        .btn-icon-reset {
            position: relative;
            width: 20px;
            height: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        /* –ö—Ä—É–≥ —è–¥–µ—Ä–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
        .btn-icon-reset::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }

        /* –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ –≤–Ω—É—Ç—Ä–∏ –∫—Ä—É–≥–∞ (—Å–∏–º–≤–æ–ª —è–¥–µ—Ä–Ω–æ–π –∫–Ω–æ–ø–∫–∏) */
        .btn-icon-reset::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 6px solid currentColor;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }
        
        /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º "–±–µ–∑ –ø—Ä–∞–≤–∞ –Ω–∞ –æ—à–∏–±–∫—É" */
        .reset-plan-btn:hover .btn-icon-reset {
            opacity: 1;
            filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.8));
        }
        
        .reset-plan-btn:hover .btn-icon-reset::before {
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
            animation: pulse-nuclear 1.5s ease-in-out infinite;
        }
        
        .reset-plan-btn:hover .btn-icon-reset::after {
            animation: pulse-nuclear-icon 1.5s ease-in-out infinite;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ "–±–µ–∑ –ø—Ä–∞–≤–∞ –Ω–∞ –æ—à–∏–±–∫—É" */
        @keyframes pulse-nuclear {
            0%, 100% {
                box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
            }
            50% {
                box-shadow: 0 0 12px rgba(255, 255, 255, 0.9);
            }
        }
        
        /* –ü—É–ª—å—Å–∞—Ü–∏—è –∏–∫–æ–Ω–∫–∏ */
        @keyframes pulse-nuclear-icon {
            0%, 100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        /* –ò–∫–æ–Ω–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ "–î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á" */
        .btn-icon-table::before,
        .btn-icon-table::after {
            content: '';
            position: absolute;
        }

        .btn-icon-table::before {
            inset: 2px;
            border-radius: 3px;
            border: 2px solid currentColor;
        }

        .btn-icon-table::after {
            inset: 5px 3px;
            border-top: 2px solid currentColor;
            border-bottom: 2px solid currentColor;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è */
        #saveButton {
            background: #4caf50 !important;
            border-color: #4caf50 !important;
            font-weight: 600 !important;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3) !important;
            position: relative;
            display: none !important; /* –°–∫—Ä—ã—Ç–∞, —Ç–∞–∫ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ */
        }

        #saveButton:hover {
            background: #45a049 !important;
            border-color: #45a049 !important;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4) !important;
            transform: translateY(-2px);
        }

        #saveButton.saving-success {
            background: #4caf50 !important;
            border-color: #4caf50 !important;
        }

        #saveButton.saving-error {
            background: #f44336 !important;
            border-color: #f44336 !important;
        }

        #saveButton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
        body.view-mode #saveButton {
            display: none !important;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: #e8e8e8;
        }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å "–ì–∞–Ω—Ç / –¢–∞–±–ª–∏—Ü–∞" —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ */
        .view-toggle-label {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            font-size: 13px;
            height: 100%;
        }

        .view-toggle-part {
            display: inline-flex;
            align-items: center;
            line-height: 1.2;
            padding: 2px 10px;
            border-radius: 999px;
            transition: background-color 0.4s ease, color 0.4s ease,
                        transform 0.4s ease, box-shadow 0.4s ease;
        }

        .view-toggle-part.active {
            background: #e3f2fd;
            color: var(--color-primary);
            font-weight: 600;
            box-shadow: 0 0 0 1px rgba(30,136,229,0.5);
        }

        .view-toggle-part:not(.active) {
            opacity: 0.75;
        }

        /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –ì–∞–Ω—Ç / –¢–∞–±–ª–∏—Ü–∞ ‚Äî —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ */
        .view-toggle-btn {
            justify-content: center !important;
            padding-left: 16px;
            padding-right: 16px;
        }

        /* –õ—ë–≥–∫–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–ª–æ–∫–∞ (–ì–∞–Ω—Ç / –¢–∞–±–ª–∏—Ü–∞)
           –û—Å—Ç–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –ø–æ opacity/transform (GPU),
           —á—Ç–æ–±—ã –Ω–µ —Ñ—Ä–∏–∑–∏–ª–æ –∏–∑-–∑–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ –≤—ã—Å–æ—Ç—ã –∏ –æ—Ç—Å—Ç—É–ø–æ–≤ */
        .chart-container,
        .table-section {
            transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), 
                        transform 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                        box-shadow 0.6s cubic-bezier(0.4, 0, 0.2, 1), 
                        background-color 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        /* –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - —ç–ª–µ–º–µ–Ω—Ç —Å–∫—Ä—ã—Ç –∏ —Å–Ω–∏–∑—É */
        .chart-container:not(.view-active),
        .table-section:not(.view-active) {
            opacity: 0;
            transform: translateY(20px);
            max-height: 0;
            overflow: hidden;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
        }

        /* –ê–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç - –≤–∏–¥–∏–º –∏ –Ω–∞ –º–µ—Å—Ç–µ */
        .chart-container.view-active,
        .table-section.view-active {
            box-shadow: 0 0 0 2px #bbdefb, var(--shadow-md);
            background-color: #f9fcff;
            opacity: 1;
            transform: translateY(0);
            max-height: 2000px;
        }

        /* –°–∫—Ä—ã—Ç—ã–π —ç–ª–µ–º–µ–Ω—Ç - —É–µ–∑–∂–∞–µ—Ç –≤–Ω–∏–∑ */
        .view-hidden {
            max-height: 0;
            opacity: 0;
            transform: translateY(20px);
            overflow: hidden;
            pointer-events: none;
            margin-bottom: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), 
                        transform 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                        box-shadow 0.6s cubic-bezier(0.4, 0, 0.2, 1), 
                        background-color 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                        margin-bottom 0.6s cubic-bezier(0.4, 0, 0.2, 1), 
                        padding-top 0.6s cubic-bezier(0.4, 0, 0.2, 1), 
                        padding-bottom 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–±—Ä–æ—Å–∏—Ç—å –ø–ª–∞–Ω" –≤ —Å—Ç–∏–ª–µ —Ä–µ–¥–∞–∫—Ü–∏–∏ —ç—Ç–∞–ø–æ–≤ */
        .reset-plan-btn {
            position: relative;
            width: 40px !important;
            height: 40px !important;
            min-width: 40px !important;
            border-radius: 50% !important;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%) !important;
            border: 2px solid #2c2c2c !important;
            color: #ffffff !important;
            box-shadow: 0 2px 8px rgba(238, 90, 82, 0.3);
            transition: all 0.3s ease;
            padding: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            overflow: visible;
        }
        
        .reset-plan-btn:hover {
            background: linear-gradient(135deg, #ff5252 0%, #d63031 100%) !important;
            box-shadow: 0 4px 12px rgba(238, 90, 82, 0.5);
            transform: translateY(-2px) scale(1.05);
        }
        
        .reset-plan-btn:active {
            transform: translateY(0) scale(1);
            box-shadow: 0 2px 6px rgba(238, 90, 82, 0.4);
        }
        
        .reset-plan-btn .btn-icon {
            margin: 0 !important;
        }
        
        /* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ "–°–±—Ä–æ—Å–∏—Ç—å –ø–ª–∞–Ω" –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (—Ç–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª—å–Ω–∞—è, –∫–Ω–æ–ø–∫–∞ –≤–∏–¥–Ω–∞) */
        .reset-plan-btn.view-mode-disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: auto; /* –†–∞–∑—Ä–µ—à–∞–µ–º –∫–ª–∏–∫–∏, –Ω–æ —Ñ—É–Ω–∫—Ü–∏—è canEdit() –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ */
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%) !important;
            border: 1px solid #636e72 !important;
        }
        
        .reset-plan-btn.view-mode-disabled:hover {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%) !important;
            transform: none;
            box-shadow: 0 2px 8px rgba(238, 90, 82, 0.3);
        }

        .reset-plan-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translate(-50%, 0);
            padding: 4px 8px;
            border-radius: 6px;
            background: #000000;
            color: #fff;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: bottom center;
            z-index: 1001;
        }

        .reset-plan-btn:hover::after {
            opacity: 1;
            transform: translate(-50%, -6px);
            transition-delay: 1s;
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –¥–ª–∏–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ (—á—ë—Ä–Ω—ã–π —Ñ–æ–Ω, –∫–∞–∫ —É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö) */
        .table-col-responsible[data-tooltip] {
            position: relative;
        }

        .table-col-responsible[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translate(-50%, 4px);
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: top center;
            z-index: 9999;
        }

        .table-col-responsible[data-tooltip]:hover::after {
            opacity: 1;
            transform: translate(-50%, 0);
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ —Ç–∞–±–ª–∏—Ü—ã (—ç—Ç–∞–ø, –≤–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ) - —á—ë—Ä–Ω—ã–π —Ñ–æ–Ω, –∫–∞–∫ —É —Ä–µ–¥–∞–∫—Ü–∏–∏ —ç—Ç–∞–ø–æ–≤ */
        .tasks-table td[data-tooltip] {
            position: relative;
        }

        .tasks-table td[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translate(-50%, 0);
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.8) !important;
            color: #fff !important;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: bottom center;
            z-index: 9999;
        }

        .tasks-table td[data-tooltip]:hover::after {
            opacity: 1 !important;
            transform: translate(-50%, -6px);
            transition-delay: 1s;
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è select "–°–≤—è–∑—å" –≤ —Ç–∞–±–ª–∏—Ü–µ (—á—ë—Ä–Ω—ã–π —Ñ–æ–Ω, –∫–∞–∫ —É —Ä–µ–¥–∞–∫—Ü–∏–∏ —ç—Ç–∞–ø–æ–≤) */
        .tasks-table .link-select[data-tooltip] {
            position: relative;
        }

        .tasks-table .link-select[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translate(-50%, 0);
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.8) !important;
            color: #fff !important;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: bottom center;
            z-index: 9999;
        }

        .tasks-table .link-select[data-tooltip]:hover::after {
            opacity: 1 !important;
            transform: translate(-50%, -6px);
            transition-delay: 1s;
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –¥–ª–∏–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤ –ì–∞–Ω—Ç–µ (—á—ë—Ä–Ω—ã–π —Ñ–æ–Ω, –∫–∞–∫ —É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö) */
        .gantt-details-cell[data-tooltip] {
            position: relative;
        }

        .gantt-details-cell[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translate(-50%, 4px);
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: top center;
            z-index: 9999;
        }

        .gantt-details-cell[data-tooltip]:hover::after {
            opacity: 1;
            transform: translate(-50%, 0);
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è select "–°–≤—è–∑—å" –≤ –¥–∏–∞–≥—Ä–∞–º–º–µ –ì–∞–Ω—Ç–∞ (—á—ë—Ä–Ω—ã–π —Ñ–æ–Ω, –∫–∞–∫ —É —Ä–µ–¥–∞–∫—Ü–∏–∏ —ç—Ç–∞–ø–æ–≤) */
        .gantt-details-cell .link-select[data-tooltip] {
            position: relative;
        }

        .gantt-details-cell .link-select[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translate(-50%, 4px);
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: top center;
            z-index: 9999;
        }

        .gantt-details-cell .link-select[data-tooltip]:hover::after {
            opacity: 1;
            transform: translate(-50%, 0);
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è —Å—Ç–æ–ª–±—Ü–∞ "–ó–∞–¥–∞—á–∞" –≤ –¥–∏–∞–≥—Ä–∞–º–º–µ –ì–∞–Ω—Ç–∞ (—á—ë—Ä–Ω—ã–π —Ñ–æ–Ω, –∫–∞–∫ —É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö) */
        .gantt-label[data-tooltip] {
            position: relative;
            overflow: visible !important;
            clip-path: none !important; /* —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–µ –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –ø—Ä–µ–¥–µ–ª—ã label */
        }

        /* –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –ø–æ–¥–Ω–∏–º–∞–µ–º –≤–µ—Å—å label –≤—ã—à–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
        .gantt-label[data-tooltip]:hover {
            z-index: 100 !important; /* –í—ã—à–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (z-index: 11) */
        }

        .gantt-label[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 6px);
            left: 0;
            transform: translateY(0);
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.85) !important;
            color: #fff !important;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: bottom left;
            z-index: 100000 !important; /* –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π z-index –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .gantt-label[data-tooltip]:hover::after {
            opacity: 1 !important;
            transform: translateY(-6px);
            transition-delay: 1s;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        .form-group input {
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 14px;
        }

        .pdf-content-toggle {
            gap: 10px;
        }

        .pdf-toggle-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .pdf-toggle-option {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text-primary);
        }

        .pdf-toggle-option input[type="radio"] {
            width: auto;
            accent-color: var(--color-primary);
        }

        .chart-container {
            background: var(--color-surface);
            padding: 20px 20px 20px 70px; /* –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ 70px (20px padding + 50px –¥–ª—è –º–µ—Ç–æ–∫) */
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            overflow-x: auto;
            overflow-y: auto;
            max-height: 480px;
            margin-bottom: 20px;
            border-bottom: 3px solid var(--color-primary);
            position: relative; /* –î–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–æ–∫ —ç—Ç–∞–ø–æ–≤ */
        }

        .gantt-chart {
            display: flex;
            flex-direction: column;
            min-width: 100%;
            font-size: 12px;
            position: relative;
            /* –£–±–∏—Ä–∞–µ–º padding-left, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —Ç–µ–ø–µ—Ä—å –≤ .chart-container */
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–∫—Ä–æ–ª–ª–±–∞—Ä –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ */
            scrollbar-width: thin; /* –î–ª—è Firefox */
            scrollbar-color: #90caf9 #e3f2fd; /* –î–ª—è Firefox */
        }

        /* –§–æ–Ω–æ–≤–∞—è –ø–æ–¥–ª–æ–∂–∫–∞ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫, —á—Ç–æ–±—ã —Ç—è–Ω—É—Ç—å—Å—è –ø–æ –≤—Å–µ–π –≤—ã—Å–æ—Ç–µ */
        .gantt-chart.has-sticky-columns::before {
            content: '';
            position: sticky;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--sticky-left-width, 0px);
            background: var(--color-bg);
            border-right: 1px solid var(--color-border);
            z-index: 6;
            pointer-events: none;
        }
        
        /* –°—Ç–∏–ª–∏ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ */
        .gantt-chart::-webkit-scrollbar {
            height: 8px;
        }
        
        .gantt-chart::-webkit-scrollbar-thumb {
            background: #90caf9;
            border-radius: 4px;
        }
        
        .gantt-chart::-webkit-scrollbar-track {
            background: #e3f2fd;
        }

        /* –î–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –∏ –º–æ–±–∏–ª—å–Ω—ã—Ö —É–±–∏—Ä–∞–µ–º contain, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
        @media (max-width: 1024px) {
            .gantt-chart {
                contain: none; /* –£–±–∏—Ä–∞–µ–º contain –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
            }
        }

        .gantt-header {
            display: flex;
            margin-bottom: 2px;
            background: var(--color-bg);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .gantt-header-first-row {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--color-bg);
        }

        .gantt-header-label {
            min-width: 180px;
            max-width: 180px;
            padding: 10px 10px 26px 10px; /* –£–≤–µ–ª–∏—á–µ–Ω –Ω–∏–∂–Ω–∏–π padding –¥–ª—è —Ç–æ–≥–ª–∞ */
            border-right: 2px solid var(--color-border);
            background: var(--color-bg);
            position: static;
            left: auto;
            z-index: auto;
            font-size: 16px;
            font-weight: 700;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .gantt-details-header {
            display: flex;
        }

        .gantt-details-row {
            display: flex;
        }

        /* --- –¢–æ–≥–≥–ª—ã —Ñ–∏–∫—Å–∞—Ü–∏–∏ –∫–æ–ª–æ–Ω–æ–∫ –≤–Ω—É—Ç—Ä–∏ —è—á–µ–µ–∫ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ --- */
        .header-sticky-toggle {
            position: absolute;
            bottom: 4px;
            right: 4px;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            z-index: 10;
        }

        .header-sticky-toggle input {
            display: none;
        }

        .header-sticky-switch {
            position: relative;
            width: 28px;
            height: 16px;
            border-radius: 16px;
            background: #d8d8d8;
            border: 1px solid #c5c5c5;
            transition: background 0.2s ease, border-color 0.2s ease;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.06);
        }

        .header-sticky-switch::after {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }

        .header-sticky-toggle input:checked + .header-sticky-switch {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            border-color: var(--color-primary);
        }

        .header-sticky-toggle input:checked + .header-sticky-switch::after {
            transform: translateX(12px);
        }

        .header-label-text {
            flex: 1;
            text-align: center;
        }

        [data-theme="dark"] .header-sticky-switch {
            background: #2b2b2b;
            border-color: #3a3a3a;
        }

        [data-theme="dark"] .header-sticky-toggle input:checked + .header-sticky-switch {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            border-color: var(--color-primary);
        }

        /* –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ç–æ–≥–ª–æ–≤ */
        .gantt-header-label {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 8px;
            position: relative;
        }

        .gantt-details-cell {
            padding: 8px 6px;
            border-right: 1px solid var(--color-border);
            background: var(--color-bg);
            font-size: 11px;
            box-sizing: border-box;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            position: relative;
        }

        .gantt-details-cell .header-label-text {
            flex: 1;
            text-align: center;
            margin-left: 0; /* –¢–æ–≥–ª —Ç–µ–ø–µ—Ä—å –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω, –æ—Ç—Å—Ç—É–ø –Ω–µ –Ω—É–∂–µ–Ω */
        }

        .gantt-header-label .header-label-text {
            flex: 1;
            text-align: center;
            margin-left: 0; /* –¢–æ–≥–ª —Ç–µ–ø–µ—Ä—å –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω, –æ—Ç—Å—Ç—É–ø –Ω–µ –Ω—É–∂–µ–Ω */
        }

        /* –°–∫—Ä—ã—Ç–∏–µ —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∞ "–§–∏–∫—Å–∞—Ü–∏—è:" —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ –Ω–∞–¥ —Ç–∞–±–ª–∏—Ü–µ–π */
        .sticky-controls {
            display: none !important;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" –≤ –ì–∞–Ω—Ç–µ */
        .gantt-details-cell.link-cell {
            flex-basis: 0 !important;
            width: 0 !important;
            min-width: 0 !important;
            max-width: 0 !important;
            opacity: 0;
            overflow: hidden;
            padding-left: 0;
            padding-right: 0;
            margin-right: 0;
            border-right: none;
            flex-shrink: 0;
            flex-grow: 0;
            transition: flex-basis 0.7s cubic-bezier(0.4, 0, 0.2, 1),
                        max-width 0.7s cubic-bezier(0.4, 0, 0.2, 1), 
                        min-width 0.7s cubic-bezier(0.4, 0, 0.2, 1),
                        width 0.7s cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 0.7s cubic-bezier(0.4, 0, 0.2, 1),
                        padding-left 0.7s cubic-bezier(0.4, 0, 0.2, 1), 
                        padding-right 0.7s cubic-bezier(0.4, 0, 0.2, 1), 
                        margin-right 0.7s cubic-bezier(0.4, 0, 0.2, 1),
                        border-right 0.7s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.show-link .gantt-details-cell.link-cell {
            flex-basis: 70px !important;
            width: 70px !important;
            min-width: 50px !important;
            max-width: 70px !important;
            opacity: 1;
            padding-left: 4px;
            padding-right: 4px;
            margin-right: 0;
            border-right: 1px solid var(--color-border);
        }

        .gantt-details-cell.responsible-cell {
            flex-basis: 0 !important;
            width: 0 !important;
            min-width: 0 !important;
            max-width: 0 !important;
            opacity: 0;
            overflow: hidden;
            padding-left: 0;
            padding-right: 0;
            margin-right: 0;
            border-right: none;
            flex-shrink: 0;
            flex-grow: 0;
            transition: flex-basis 0.7s cubic-bezier(0.4, 0, 0.2, 1),
                        max-width 0.7s cubic-bezier(0.4, 0, 0.2, 1), 
                        min-width 0.7s cubic-bezier(0.4, 0, 0.2, 1),
                        width 0.7s cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 0.7s cubic-bezier(0.4, 0, 0.2, 1),
                        padding-left 0.7s cubic-bezier(0.4, 0, 0.2, 1), 
                        padding-right 0.7s cubic-bezier(0.4, 0, 0.2, 1), 
                        margin-right 0.7s cubic-bezier(0.4, 0, 0.2, 1),
                        border-right 0.7s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.show-responsible .gantt-details-cell.responsible-cell {
            flex-basis: 200px !important;
            width: 200px !important;
            min-width: 150px !important;
            max-width: 200px !important;
            opacity: 1;
            padding-left: 6px;
            padding-right: 6px;
            margin-right: 0;
            border-right: 1px solid var(--color-border);
        }

        .gantt-details-input {
            width: 100%;
            padding: 4px 6px;
            font-size: 11px;
            border-radius: 4px;
            border: 1px solid var(--color-border);
            box-sizing: border-box;
        }

        /* –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
        body.view-mode .gantt-details-input[readonly],
        body.view-mode .gantt-details-input[data-field="startDate"],
        body.view-mode .gantt-details-input[data-field="endDate"],
        body.view-mode .gantt-details-input[data-field="days"],
        body.view-mode .gantt-details-input[disabled] {
            background-color: #f5f5f5;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —è—á–µ–π–∫–∏ –≤ —Å–≤–µ—Ä–Ω—É—Ç—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö —ç—Ç–∞–ø–æ–≤ */
        .stage-row-collapsed .gantt-details-cell.link-cell select[disabled],
        .stage-row-collapsed .gantt-details-cell.responsible-cell {
            background-color: #f5f5f5;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .stage-row-collapsed .table-col-link select[disabled],
        .stage-row-collapsed .table-col-responsible {
            background-color: #f5f5f5;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .gantt-resizable {
            position: relative;
        }

        .gantt-resizer {
            position: absolute;
            top: 0;
            right: -2px;
            width: 4px;
            height: 100%;
            cursor: col-resize;
            z-index: 20;
        }

        .gantt-header-dates-row {
            display: flex;
            flex: 1;
        }

        .gantt-header-month-row {
            display: flex;
            background: var(--color-bg);
            font-weight: 600;
            margin-bottom: 2px;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .gantt-header-month-label {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            font-size: 14px;
            border-bottom: 2px solid var(--color-border);
            background: #f9f9f9;
        }

        .gantt-header-month-spacer {
            min-width: 300px;
        }

        .gantt-header-cell {
            min-width: 60px;
            padding: 10px 5px;
            text-align: center;
            border-right: 1px solid var(--color-border);
            border-bottom: 2px solid var(--color-border);
            background: var(--color-primary);
            color: white;
            line-height: 1.1;
        }

        .gantt-header-week-days {
            display: block;
        }

        .gantt-header-week-month {
            display: block;
            margin-top: 2px;
            font-size: 11px;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–µ—Ç–æ–∫ —ç—Ç–∞–ø–æ–≤ - –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç—Å—è —Å–ª–µ–≤–∞ –æ—Ç —Ç–∞–±–ª–∏—Ü—ã */
        .gantt-stage-labels {
            position: absolute;
            left: 0; /* –°–ª–µ–≤–∞ –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—Å —É—á–µ—Ç–æ–º padding) */
            top: 0;
            width: 50px;
            z-index: 15;
            pointer-events: none; /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è, –Ω–æ –º–µ—Ç–∫–∏ —ç—Ç–∞–ø–æ–≤ –±—É–¥—É—Ç –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã */
            background: transparent;
            /* –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ - –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ */
            /* background: rgba(255, 0, 0, 0.1); */
        }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ–º –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ */
        .gantt-stage-controls {
            position: absolute;
            left: 0;
            top: 0;
            width: 50px;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            z-index: 30;
            pointer-events: auto;
            background: rgba(30, 136, 229, 0.1);
            border-right: 2px solid var(--color-primary);
            border-bottom: 1px solid rgba(30, 136, 229, 0.3);
        }

        .gantt-stage-control-btn {
            width: 32px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
            user-select: none;
        }

        .gantt-stage-control-btn:hover {
            background: rgba(30, 136, 229, 0.9);
            transform: scale(1.05);
        }

        .gantt-stage-control-btn:active {
            transform: scale(0.95);
        }

        /* –ú–µ—Ç–∫–∞ —ç—Ç–∞–ø–∞ */
        .gantt-stage-label {
            position: absolute;
            left: 0;
            width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(30, 136, 229, 0.1);
            border-right: 2px solid var(--color-primary);
            color: var(--color-primary);
            font-weight: 600;
            font-size: 0.75rem;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg); /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ (12 —á–∞—Å–æ–≤) */
            white-space: nowrap;
            padding: 8px 4px;
            box-sizing: border-box;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease, writing-mode 0.3s ease, width 0.3s ease, height 0.3s ease, background 0.2s ease;
            z-index: 20;
            user-select: none;
            pointer-events: auto; /* –ú–µ—Ç–∫–∏ —ç—Ç–∞–ø–æ–≤ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã */
        }

        /* Hover —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –º–µ—Ç–∫–∏ —ç—Ç–∞–ø–∞ */
        .gantt-stage-label:hover {
            background: rgba(30, 136, 229, 0.25);
            border-right-color: rgba(30, 136, 229, 0.8);
        }

        /* –ö–∞—Å—Ç–æ–º–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –º–µ—Ç–æ–∫ —ç—Ç–∞–ø–æ–≤ */

        /* –°–≤–µ—Ä–Ω—É—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ—Ç–∫–∏ —ç—Ç–∞–ø–∞ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ) */
        .gantt-stage-label.collapsed {
            writing-mode: horizontal-tb;
            text-orientation: unset;
            transform: rotate(270deg); /* –ü–æ–≤–æ—Ä–æ—Ç –Ω–∞ 90 –≥—Ä–∞–¥—É—Å–æ–≤ –ø–æ —á–∞—Å–æ–≤–æ–π —Å—Ç—Ä–µ–ª–∫–µ (—Å 12 –Ω–∞ 3 —á–∞—Å–∞) */
            width: auto;
            min-width: 100px;
            height: 35px;
            padding: 8px 12px;
            position: absolute;
            left: 0;
            z-index: 25;
            pointer-events: auto; /* –°–≤–µ—Ä–Ω—É—Ç—ã–µ –º–µ—Ç–∫–∏ —Ç–∞–∫–∂–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã */
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–æ–∫ –∑–∞–¥–∞—á */
        .gantt-row.collapsing {
            animation: collapseRow 0.3s ease forwards;
            overflow: hidden;
        }

        .gantt-row.expanding {
            animation: expandRow 0.3s ease forwards;
            overflow: hidden;
        }

        @keyframes collapseRow {
            from {
                max-height: 35px;
                opacity: 1;
                margin-bottom: 0;
            }
            to {
                max-height: 0;
                opacity: 0;
                margin-bottom: 0;
                padding-top: 0;
                padding-bottom: 0;
            }
        }

        @keyframes expandRow {
            from {
                max-height: 0;
                opacity: 0;
                margin-bottom: 0;
                padding-top: 0;
                padding-bottom: 0;
            }
            to {
                max-height: 35px;
                opacity: 1;
                margin-bottom: 0;
            }
        }

        /* –°–∫—Ä—ã—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∑–∞–¥–∞—á */
        .gantt-row.stage-collapsed {
            display: none;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ –∑–∞–¥–∞—á */
        #tasksTableBody tr.collapsing {
            animation: collapseRow 0.3s ease forwards;
            overflow: hidden;
        }

        #tasksTableBody tr.expanding {
            animation: expandRow 0.3s ease forwards;
            overflow: hidden;
        }

        #tasksTableBody tr.stage-collapsed {
            display: none;
        }

        /* –°—Ç—Ä–æ–∫–∞ —ç—Ç–∞–ø–∞ (—Å–≤–µ—Ä–Ω—É—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ) */
        .gantt-row.stage-row-collapsed,
        #tasksTableBody tr.stage-row-collapsed {
            background: rgba(30, 136, 229, 0.05);
            cursor: pointer;
            height: 35px;
            min-height: 35px;
            max-height: 35px;
        }

        .gantt-row.stage-row-collapsed:hover,
        #tasksTableBody tr.stage-row-collapsed:hover {
            background: rgba(30, 136, 229, 0.15);
        }

        .gantt-row.stage-row-collapsed .gantt-label span,
        #tasksTableBody tr.stage-row-collapsed td span {
            font-weight: 600;
            color: var(--color-primary);
        }

        /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–ª–æ—Å–∞ –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏ - –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç—Å—è —Å–ª–µ–≤–∞ –æ—Ç —Ç–∞–±–ª–∏—Ü—ã */
        .gantt-stage-divider {
            position: absolute;
            left: 0; /* –°–ª–µ–≤–∞ –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—Å —É—á–µ—Ç–æ–º padding) */
            width: 50px;
            height: 2px;
            background: var(--color-primary);
            z-index: 12;
            pointer-events: none;
            opacity: 0.6;
        }

        .gantt-row {
            display: flex;
            border-bottom: 1px solid var(--color-border);
            min-height: 35px;
            align-items: center;
            transition: background 0.15s ease, box-shadow 0.15s ease, max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease, padding 0.3s ease;
            overflow: visible; /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∞–º –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Å—Ç—Ä–æ–∫–∏ */
        }

        .gantt-row:hover {
            background: #f9f9f9;
        }

        .gantt-row.selected {
            background: #bbdefb !important;
            box-shadow: inset 0 0 0 2px #2196f3, 0 2px 8px rgba(33, 150, 243, 0.2) !important;
            position: relative;
        }

        /* –ü—Ä–∏ –≤—ã–¥–µ–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∏ —Ç—Ä–∏ –∫–æ–ª–æ–Ω–∫–∏ —Å –¥–∞—Ç–∞–º–∏/–¥–Ω—è–º–∏,
           —á—Ç–æ–±—ã –≤–∏–∑—É–∞–ª—å–Ω–æ –≤—Å—è —Å—Ç—Ä–æ–∫–∞ –≤ –ì–∞–Ω—Ç–µ –≤–µ–ª–∞ —Å–µ–±—è —Ç–∞–∫ –∂–µ, –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ */
        .gantt-row.selected .gantt-label,
        .gantt-row.selected .gantt-details-cell {
            background: #bbdefb !important;
        }

        /* –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á - –±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω–∞—è */
        .gantt-row.selected::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #2196f3 0%, #1976d2 100%);
            box-shadow: 0 0 8px rgba(33, 150, 243, 0.6);
        }

        .gantt-row.dragging {
            opacity: 0.6;
        }

        .gantt-row-drop-target {
            background: #e3f2fd;
            box-shadow: inset 0 3px 0 var(--color-primary);
        }

        .gantt-label {
            min-width: 180px;
            padding: 8px 10px;
            border-right: 2px solid var(--color-border);
            background: var(--color-bg);
            font-weight: 500;
            font-size: 11px;
            position: static;
            left: auto;
            z-index: auto;
            box-sizing: border-box;
            overflow: visible;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .gantt-label span {
            display: inline-block;
            max-width: 100%;
            overflow: visible;
            white-space: nowrap;
        }

        .gantt-task-input {
            width: 100%;
            padding: 4px 6px;
            font-size: 11px;
            border-radius: 4px;
            border: 1px solid var(--color-primary);
            box-sizing: border-box;
        }

        .gantt-cell {
            min-width: 60px;
            height: 100%;
            border-right: 1px solid var(--color-border);
            padding: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* –ñ—ë–ª—Ç–∞—è –ø–æ–ª–æ—Å–∫–∞ –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ (baseline) –ø–æ–¥ –æ—Å–Ω–æ–≤–Ω—ã–º –±–∞—Ä–æ–º */
        .baseline-bar {
            position: absolute;
            left: 3px;
            right: 3px;
            height: 4px;
            bottom: 2px;
            background: #ffd54f;
            border-radius: 2px;
            pointer-events: none; /* –Ω–µ –º–µ—à–∞–µ—Ç –∫–ª–∏–∫–∞–º –ø–æ –æ—Å–Ω–æ–≤–Ω–æ–º—É –±–∞—Ä—É */
            opacity: 0.9;
            z-index: 100;
        }

        .gantt-bar {
            height: 24px;
            background: linear-gradient(135deg, var(--color-primary) 0%, #0b5ed7 100%);
            border-radius: 3px;
            border: 1px solid var(--color-primary-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            width: 100%;
            min-width: 20px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–∂–µ –≤ –º–∞–ª–µ–Ω—å–∫–∏—Ö —è—á–µ–π–∫–∞—Ö */
            flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞–µ—Ç—Å—è –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —à–∏—Ä–∏–Ω—ã */
        }

        .gantt-bar:hover {
            transform: scaleY(1.2);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg, var(--color-primary-hover) 0%, #073a3d 100%);
        }

        /* –í—ã–¥–µ–ª–µ–Ω–∏–µ —è—á–µ–µ–∫ –¥–ª—è –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞ */
        .gantt-bar.cell-selected {
            box-shadow: 0 0 0 2px #2196f3, 0 0 8px rgba(33, 150, 243, 0.6);
            outline: 2px solid #2196f3;
            outline-offset: -2px;
            z-index: 10;
        }

        .gantt-bar.completed {
            background: linear-gradient(135deg, var(--color-success) 0%, #388e3c 100%);
            border-color: #2e7d32;
        }

        .gantt-bar.in-progress {
            background: linear-gradient(135deg, var(--color-warning) 0%, #f57c00 100%);
            border-color: #e65100;
        }

        /* –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Ü–µ–ª–µ–≤–æ–π —è—á–µ–π–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –±–∞—Ä–∞ */
        .gantt-cell.drag-target {
            background: rgba(33, 150, 243, 0.3) !important;
            box-shadow: inset 0 0 0 2px #2196f3;
        }

        /* –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Ü–µ–ª–µ–≤–æ–π —è—á–µ–π–∫–∏ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ –±–∞—Ä–∞ */
        .gantt-cell.resize-target {
            background: rgba(76, 175, 80, 0.3) !important;
            box-shadow: inset 0 0 0 2px #4caf50;
        }

        /* –°—Ç–∏–ª—å –±–∞—Ä–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Ä–µ—Å–∞–π–∑–µ */
        .gantt-bar.resizing {
            opacity: 0.7;
            cursor: ew-resize !important;
        }

        /* –ö—É—Ä—Å–æ—Ä –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π –±–∞—Ä–∞ –¥–ª—è —Ä–µ—Å–∞–π–∑–∞ */
        .gantt-bar.resize-handle {
            cursor: ew-resize !important;
        }

        /* –í —Ä–µ–∂–∏–º–µ —Å–ø–ª–æ—à–Ω—ã—Ö –ø–æ–ª–æ—Å —É–±–∏—Ä–∞–µ–º –∑–∞–∑–æ—Ä—ã –º–µ–∂–¥—É –¥–Ω—è–º–∏, –±–∞—Ä—ã –≤—ã–≥–ª—è–¥—è—Ç –∫–∞–∫ –µ–¥–∏–Ω–∞—è –ª–∏–Ω–∏—è */
        body.gantt-style-segments .gantt-cell {
            padding: 0;
            border-right: none;
        }

        body.gantt-style-segments .gantt-bar {
            border-radius: 0;
            width: 100%;
            /* –û–¥–Ω–æ—Ä–æ–¥–Ω—ã–µ —Ü–≤–µ—Ç–∞ –±–µ–∑ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –≤–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–ª—É—á–∞–ª–∞—Å—å —Å–ø–ª–æ—à–Ω–∞—è –ø–æ–ª–æ—Å–∞ */
            background: var(--color-primary);
            border-color: var(--color-primary-hover);
        }

        body.gantt-style-segments .gantt-bar.in-progress {
            background: var(--color-warning);
            border-color: #e65100;
        }

        body.gantt-style-segments .gantt-bar.completed {
            background: var(--color-success);
            border-color: #2e7d32;
        }

        /* –í —Ä–µ–∂–∏–º–µ –ø–æ–ª–æ—Å —Å–≥–ª–∞–∂–∏–≤–∞–µ–º —Å–µ—Ä–µ–¥–∏–Ω—É –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –∫—Ä–∞—è—Ö –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –æ—Ç—Ä–µ–∑–∫–∞ */
        body.gantt-style-segments .gantt-bar.segment-middle {
            border-radius: 0;
            border-left: none;
            border-right: none;
        }

        body.gantt-style-segments .gantt-bar.segment-start {
            border-radius: 12px 0 0 12px;
            border-right: none;
        }

        body.gantt-style-segments .gantt-bar.segment-end {
            border-radius: 0 12px 12px 0;
            border-left: none;
        }

        /* –û–¥–∏–Ω–æ—á–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç (–∑–∞–¥–∞—á–∞ –Ω–µ —Ç—è–Ω–µ—Ç—Å—è –Ω–∞ —Å–æ—Å–µ–¥–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã)
           ‚Äî —Å–∫—Ä—É–≥–ª—è–µ–º –æ–±–∞ –∫—Ä–∞—è, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ¬´–æ—Å—Ç—Ä—ã—Ö¬ª –∫–æ–Ω—Ü–æ–≤. */
        body.gantt-style-segments .gantt-bar.segment-single {
            border-radius: 12px;
        }

        body.gantt-style-segments .gantt-bar:hover {
            transform: scaleY(1.05);
            box-shadow: var(--shadow-md);
        }

        .gantt-weekend {
            background: #ffe0e0;
        }

        .gantt-holiday {
            background: #fff9c4;
        }

        /* –Ø—á–µ–π–∫–∏ –±—É–¥—É—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ (–ø–æ—Å–ª–µ –∫–æ–Ω—Ü–∞ –ø–ª–∞–Ω–∞) */
        .gantt-future-header {
            background: #d4d4d4;
            color: #555555;
        }

        .gantt-future-cell {
            background: #f1f1f1;
        }

        /* –ö–æ–ª–æ–Ω–∫–∞ "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" –≤ —Ç–∞–±–ª–∏—Ü–µ –∑–∞–¥–∞—á ‚Äî —É–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å—é —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å –Ω–∞ body */
        .table-col-responsible {
            display: table-cell;
            width: 0 !important;
            min-width: 0 !important;
            max-width: 0 !important;
            opacity: 0;
            overflow: hidden;
            padding-left: 0;
            padding-right: 0;
            border-left: none;
            border-right: none;
            white-space: nowrap;
            transition: width 0.7s cubic-bezier(0.4, 0, 0.2, 1),
                        max-width 0.7s cubic-bezier(0.4, 0, 0.2, 1),
                        min-width 0.7s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.7s cubic-bezier(0.4, 0, 0.2, 1),
                        padding-left 0.7s cubic-bezier(0.4, 0, 0.2, 1), 
                        padding-right 0.7s cubic-bezier(0.4, 0, 0.2, 1), 
                        border-left 0.7s cubic-bezier(0.4, 0, 0.2, 1), 
                        border-right 0.7s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .table-col-link {
            display: none;
        }

        body.show-link .table-col-link {
            display: table-cell;
            width: 70px !important;
            min-width: 50px !important;
            max-width: 70px !important;
        }

        body.show-responsible .table-col-responsible {
            width: 200px !important;
            min-width: 150px !important;
            max-width: 300px !important;
            opacity: 1;
            padding-left: 12px;
            padding-right: 12px;
            border-left: 1px solid var(--color-border);
            border-right: 1px solid var(--color-border);
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —è—á–µ–µ–∫ –ì–∞–Ω—Ç–∞ */
        .gantt-bar[data-tooltip] {
            position: relative;
            z-index: 5; /* –ø–æ–¥–Ω–∏–º–∞–µ–º —è—á–µ–π–∫—É –Ω–∞–¥ —à–∫–∞–ª–æ–π –¥–∞—Ç */
        }

        .gantt-bar[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translate(-50%, 4px);
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            font-size: 11px;
            white-space: pre-line;
            width: 300px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            text-align: left;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: top center;
            z-index: 9999; /* –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö –¥–∞—Ç –∏ –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ì–∞–Ω—Ç–∞ */
        }

        .gantt-bar[data-tooltip]:hover::after {
            opacity: 1;
            transform: translate(-50%, 0);
        }

        .status-comment-input {
            width: 100%;
            resize: vertical;
            min-height: 70px;
            padding: 6px 8px;
            font-size: 13px;
            border-radius: 6px;
            border: 1px solid var(--color-border);
        }

        /* –ú–µ–Ω—é —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏ –ø–æ –¥–∞—Ç–µ */
        .status-menu {
            position: fixed;
            z-index: 200;
            background: var(--color-surface);
            border-radius: 6px;
            box-shadow: var(--shadow-md);
            padding: 8px 0;
            min-width: 180px;
            border: 1px solid var(--color-border);
            display: none;
        }

        @media (max-width: 480px) {
            .status-menu {
                min-width: 160px;
                padding: 6px 0;
            }
        }

        .status-menu-item {
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-menu-item:hover {
            background: #f5f5f5;
        }

        .status-color-box {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid #999;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background: var(--color-bg);
            border-radius: 6px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .legend {
                gap: 15px;
                padding: 12px;
                margin-top: 15px;
            }
        }

        @media (max-width: 480px) {
            .legend {
                gap: 10px;
                padding: 10px;
                margin-top: 12px;
            }
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        @media (max-width: 480px) {
            .legend-item {
                font-size: 0.7rem;
                gap: 6px;
            }

            .status-color-box {
                width: 12px;
                height: 12px;
            }
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #999;
        }

        .stats {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            border-bottom: 3px solid var(--color-primary);
        }

        .stat-card {
            padding: 15px;
            background: var(--color-bg);
            border-left: 4px solid var(--color-primary);
            border-radius: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .table-section {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
            margin-top: 0;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 600px;
            border-bottom: 3px solid var(--color-primary);
        }

        .table-section h2 {
            font-size: 16px;
            margin-bottom: 15px;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th {
            background: var(--color-primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border: 1px solid var(--color-primary-hover);
        }

        /* –®–∞–ø–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–¥–∞—á: –¥–µ–ª–∞–µ–º –ø–æ–¥–ø–∏—Å–∏ –∫—Ä—É–ø–Ω–µ–µ –∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
        #tasksTable thead th {
            font-size: 13px;
            text-align: center;
            vertical-align: middle;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–æ–ª–±—Ü–∞ "‚Ññ –ø/–ø" –≤ —à–∞–ø–∫–µ */
        #tasksTable thead th:first-child {
            min-width: 60px;
            width: auto;
        }

        td {
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ –≤ —è—á–µ–π–∫–∞—Ö –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
            white-space: normal;
        }

        .tasks-table-input {
            width: 100%;
            padding: 4px 6px;
            font-size: 11px;
            border-radius: 4px;
            border: 1px solid var(--color-border);
            /* –£–±–∏—Ä–∞–µ–º –æ–±—Ä–µ–∑–∫—É —Ç–µ–∫—Å—Ç–∞ - –ø—Ä–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏ —Å—Ç–æ–ª–±—Ü–∞ —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é */
            overflow: visible !important;
            text-overflow: clip !important;
            white-space: normal !important;
            word-wrap: break-word;
        }
        
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ—Å—Ç—å –¥–ª—è input –ø–æ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ */
        .tasks-table td .tasks-table-input {
            overflow: visible !important;
            text-overflow: clip !important;
            white-space: normal !important;
        }

        .tasks-table-input[type="number"] {
            text-align: center;
        }

        /* –ò–∫–æ–Ω–∫–∞ —Å–∞–º–æ–ª–µ—Ç–∏–∫–∞ –¥–ª—è –∑–∞–¥–∞—á "–Ω–∞ –≤—ã–µ–∑–¥–µ" */
        .travel-icon {
            display: inline-block;
            font-size: 14px;
            color: #ffc107;
            font-weight: bold;
            vertical-align: middle;
            cursor: default;
            flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞–µ—Ç—Å—è –≤ flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ */
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —è—á–µ–π–∫–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∑–∞–¥–∞—á–∏ */
        .task-cell-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
            width: 100%;
        }
        
        /* –ò–∫–æ–Ω–∫–∞ —Å–∞–º–æ–ª–µ—Ç–∏–∫–∞ –≤ –∫–æ–ª–æ–Ω–∫–µ —Å –Ω–æ–º–µ—Ä–æ–º */
        .travel-icon-row {
            display: inline-block;
            font-size: 18px;
            color: #ffc107;
            font-weight: bold;
            cursor: default;
            line-height: 1;
            flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞–µ—Ç—Å—è –≤ flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ */
        }
        
        /* –ö–æ–ª–æ–Ω–∫–∞ —Å –Ω–æ–º–µ—Ä–æ–º –∑–∞–¥–∞—á–∏ */
        .task-number-cell {
            min-width: 60px;
            padding: 6px 8px;
            vertical-align: middle;
            text-align: left;
        }
        
        .task-number-cell span {
            display: inline-block;
            vertical-align: middle;
        }
        
        .task-number-cell .travel-icon-row {
            margin-right: 4px;
        }

        /* –Ø—á–µ–π–∫–∞ —Å —Ç–µ–∫—Å—Ç–æ–º –∑–∞–¥–∞—á–∏ - –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∞–º–æ–ª–µ—Ç–∏–∫–∞ */
        .task-cell-with-icon {
            position: relative;
        }

        /* –ò–∫–æ–Ω–∫–∞ —Å–∞–º–æ–ª–µ—Ç–∏–∫–∞ –≤ –≤–µ—Ä—Ö–Ω–µ–º –ø—Ä–∞–≤–æ–º —É–≥–ª—É —è—á–µ–π–∫–∏ —Å —Ç–µ–∫—Å—Ç–æ–º –∑–∞–¥–∞—á–∏ */
        .travel-icon-cell {
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 18px;
            color: #ffc107;
            font-weight: bold;
            z-index: 10;
            cursor: default;
            line-height: 1;
            pointer-events: none;
        }

        .gantt-travel-icon {
            font-size: 18px !important;
            color: #ffc107 !important;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8), 0 0 2px rgba(0, 0, 0, 0.5);
            font-weight: bold;
        }

        /* –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
        body.view-mode .tasks-table-input[readonly],
        body.view-mode .tasks-table-input[data-field="startDate"],
        body.view-mode .tasks-table-input[data-field="endDate"],
        body.view-mode .tasks-table-input[data-field="days"],
        body.view-mode .tasks-table-input[data-field="stageSuffix"],
        body.view-mode .tasks-table-input[data-field="control"],
        body.view-mode .tasks-table-input[data-field="taskTitle"] {
            background-color: #f5f5f5;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ select –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
        body.view-mode .tasks-table-input-select[disabled] {
            background-color: #f5f5f5;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .tasks-table-input-select {
            width: 100%;
            padding: 4px 6px;
            font-size: 11px;
            border-radius: 4px;
            border: 1px solid var(--color-border);
            background: #fff;
        }

        tr:nth-child(even) {
            background: #f9f9f9;
        }

        tr:hover {
            background: #f0f0f0;
        }

        tr.selected {
            background: #bbdefb !important;
        }

        /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞/–∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —ç—Ç–∞–ø–∞–º */
        .gantt-row.stage-active {
            background: #e3f2fd;
        }

        .gantt-row.inactive {
            opacity: 0.25;
            filter: grayscale(0.4);
            pointer-events: none;
        }

        tr.stage-active {
            background: #e3f2fd;
        }

        tr.inactive {
            opacity: 0.4;
            color: #aaaaaa;
            pointer-events: none;
        }

        tr.dragging {
            opacity: 0.6;
        }

        tr.table-row-drop-target {
            background: #e3f2fd;
            box-shadow: inset 0 3px 0 var(--color-primary);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.75);
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            backdrop-filter: blur(5px);
        }

        .modal[style*="display: block"],
        .modal[style*="display: flex"],
        .modal.show {
            display: flex !important;
        }

        .baseline-toast {
            position: fixed;
            left: 50%;
            top: 50%;
            max-width: 320px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.95);
            color: #fff;
            font-size: 13px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            pointer-events: none;
            transform: translate(-50%, calc(-50% + 10px));
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 10000;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .baseline-toast {
                max-width: calc(100% - 30px);
                font-size: 11px;
                padding: 10px 14px;
            }
        }

        @media (max-width: 480px) {
            .baseline-toast {
                max-width: calc(100% - 20px);
                font-size: 10px;
                padding: 8px 12px;
            }
        }

        .baseline-toast.visible {
            opacity: 1;
            transform: translate(-50%, -50%);
        }

        /* –û–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è —ç—Ç–∞–ø–∞ –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —ç—Ç–∞–ø–æ–≤ */
        #stageDeleteModal {
            z-index: 10001;
        }

        /* –û–∫–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —ç—Ç–∞–ø–∞ –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —ç—Ç–∞–ø–æ–≤ */
        #renameStageModal {
            z-index: 10001;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –º–∞—Å—à—Ç–∞–±–µ - –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
        #scaleWarningModal {
            z-index: 10002 !important;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è - –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
        #welcomeModal {
            z-index: 10003 !important;
        }

        .modal-content {
            background-color: var(--color-surface);
            margin: auto;
            padding: 20px;
            position: relative;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: calc(100vh - 40px);
            box-shadow: var(--shadow-md);
            position: relative;
            align-self: center;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 10001;
        }

        /* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö */
        .modal-content .btn {
            pointer-events: auto !important;
            position: relative;
            z-index: 10002;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ PDF */
        .pdf-preview-page {
            background: white;
            border: 1px solid #ccc;
            margin: 0 auto 16px auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .pdf-preview-page-content {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .pdf-preview-margin {
            position: absolute;
            border: 2px dashed #ff9800;
            background: rgba(255, 152, 0, 0.05);
            pointer-events: none;
        }
        
        .pdf-preview-margin-label {
            position: absolute;
            font-size: 10px;
            color: #ff9800;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: 600;
        }
        
        .pdf-preview-page-number {
            position: absolute;
            bottom: 4px;
            right: 4px;
            font-size: 11px;
            color: #999;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .pdf-preview-content-area {
            position: relative;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            margin: 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 12px;
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ, –æ—Å—Ç–∞–≤–ª—è—è –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
        #pdfPreviewContainer {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
            overflow-x: hidden !important; /* —Å–∫—Ä—ã–≤–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
            overflow-y: auto !important;  /* –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
        }
        #pdfPreviewContainer::-webkit-scrollbar {
            display: none; /* WebKit */
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 1024px) {
            #pdfExportSettingsGrid {
                grid-template-columns: 1fr !important;
            }
            
            #pdfPreviewContainer {
                max-height: 300px !important;
            }
            
            #pdfExportModal .modal-content {
                max-width: 95% !important;
                width: 95% !important;
            }
        }
        
        /* –î–ª—è –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É */
        @media (min-width: 1920px) {
            #pdfExportModal .modal-content {
                max-width: 95% !important;
                width: 95% !important;
            }
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ—Å–∞–π–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ PDF */
        #pdfExportModal .modal-content {
            /* –û—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É, –Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–æ—Å—É —Å–∫—Ä–æ–ª–ª–∞ */
            overflow: auto !important;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
            min-width: 800px;
            min-height: 600px;
            max-width: 98vw;
            max-height: 98vh;
            display: flex;
            flex-direction: column;
        }
        #pdfExportModal .modal-content::-webkit-scrollbar {
            display: none; /* WebKit */
        }
        
        /* –†–µ—Å–∞–π–∑-—Ö–µ–Ω–¥–ª—ã –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ PDF */
        .resize-handle {
            position: absolute;
            background: transparent;
            z-index: 10003;
            pointer-events: auto;
            transition: background 0.2s ease;
        }
        
        /* –£–≥–ª–æ–≤—ã–µ —Ö–µ–Ω–¥–ª—ã (–¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ—Å–∞–π–∑) */
        .resize-handle-nw {
            top: 0;
            left: 0;
            width: 20px;
            height: 20px;
            cursor: nw-resize;
        }
        
        .resize-handle-ne {
            top: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: ne-resize;
        }
        
        .resize-handle-sw {
            bottom: 0;
            left: 0;
            width: 20px;
            height: 20px;
            cursor: sw-resize;
        }
        
        .resize-handle-se {
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: se-resize;
        }
        
        /* –ë–æ–∫–æ–≤—ã–µ —Ö–µ–Ω–¥–ª—ã (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π/–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Ä–µ—Å–∞–π–∑) */
        .resize-handle-n {
            top: 0;
            left: 20px;
            right: 20px;
            height: 10px;
            cursor: n-resize;
        }
        
        .resize-handle-s {
            bottom: 0;
            left: 20px;
            right: 20px;
            height: 10px;
            cursor: s-resize;
        }
        
        .resize-handle-w {
            left: 0;
            top: 20px;
            bottom: 20px;
            width: 10px;
            cursor: w-resize;
        }
        
        .resize-handle-e {
            right: 0;
            top: 20px;
            bottom: 20px;
            width: 10px;
            cursor: e-resize;
        }
        
        /* –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Ö–µ–Ω–¥–ª–æ–≤ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        .resize-handle:hover {
            background: rgba(33, 150, 243, 0.3);
        }
        
        .resize-handle-nw:hover,
        .resize-handle-ne:hover,
        .resize-handle-sw:hover,
        .resize-handle-se:hover {
            background: rgba(33, 150, 243, 0.4);
        }
        
        /* –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Ä–µ—Å–∞–π–∑–µ */
        .resize-handle:active {
            background: rgba(33, 150, 243, 0.5);
        }
        

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            font-size: 18px;
            color: var(--color-primary);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ */
        .text-input-modal-textarea {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
            box-sizing: border-box;
        }

        .text-input-modal-textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        @media (max-width: 768px) {
            .text-input-modal-textarea {
                font-size: 16px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iOS */
                min-height: 100px;
            }
        }

        .stage-settings-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .stage-settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px dashed var(--color-border);
            background: #fafafa;
            cursor: grab;
        }

        .stage-settings-item.dragging {
            opacity: 0.7;
            background: #e3f2fd;
        }

        .stage-settings-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stage-settings-handle {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid var(--color-border);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--color-muted);
        }

        .stage-settings-name {
            font-size: 14px;
            font-weight: 500;
            cursor: default;
        }

        .stage-settings-name.editable {
            border-bottom: 1px dashed var(--color-border);
        }

        .stage-settings-delete-btn {
            border: none;
            background: transparent;
            color: #d32f2f;
            cursor: pointer;
            font-size: 13px;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .stage-settings-delete-btn:hover {
            background: #ffebee;
        }

        .stage-settings-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: var(--color-text-secondary);
        }

        .close:hover {
            color: var(--color-text);
        }

        .hidden {
            display: none;
        }

        .stage-tabs-container {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .stage-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            flex: 1;
        }

        .stage-tabs-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            overflow: visible;
            position: relative;
        }

        .undo-btn,
        .redo-btn {
            padding: 10px 14px;
            border-radius: 20px;
            border: 2px solid #1976d2;
            background: #2196f3 !important;
            color: #ffffff !important;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 3px 10px rgba(33, 150, 243, 0.4);
            width: 44px;
            height: 44px;
            text-align: center;
            display: inline-flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 100;
            white-space: nowrap;
            margin-right: 0;
            flex-shrink: 0;
        }
        
        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã (—á—ë—Ä–Ω—ã–π —Ñ–æ–Ω, –∫–∞–∫ —É —Ä–µ–¥–∞–∫—Ü–∏–∏ —ç—Ç–∞–ø–æ–≤) */
        .undo-btn[data-tooltip],
        .redo-btn[data-tooltip] {
            position: relative;
        }
        
        .undo-btn[data-tooltip]::after,
        .redo-btn[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.85) !important;
            color: #fff !important;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: bottom center;
            z-index: 9999;
        }
        
        .undo-btn[data-tooltip]:hover::after,
        .redo-btn[data-tooltip]:hover::after {
            opacity: 1 !important;
            transform: translateX(-50%) translateY(-6px);
            transition-delay: 1s;
        }

        .undo-btn:hover:not(.disabled),
        .redo-btn:hover:not(.disabled) {
            background: #1976d2 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
            border-color: #1565c0;
        }

        .undo-btn.disabled,
        .redo-btn.disabled {
            background: #f5f5f5;
            border-color: #e0e0e0;
            color: #bdbdbd;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .undo-btn::before,
        .redo-btn::before {
            content: '';
        }

        .stage-tab-btn {
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid var(--color-primary);
            background: #e3f2fd;
            color: var(--color-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
            min-width: 120px;
            text-align: center;
        }

        .stage-tab-btn:hover {
            background: #bbdefb;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stage-tab-btn.active {
            background: var(--color-primary);
            color: #fff;
            box-shadow: var(--shadow-md);
        }

        /* –ö–Ω–æ–ø–∫–∞ "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" ‚Äî –ø–æ —Ä–∞–∑–º–µ—Ä—É –∏ —Ñ–æ—Ä–º–µ –∫–∞–∫ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∞,
           –Ω–æ —Å —Ü–≤–µ—Ç–∞–º–∏, –∫–∞–∫ —É —Ç–∞–±–æ–≤ —ç—Ç–∞–ø–æ–≤. */
        .responsible-toggle-btn {
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* –ö–Ω–æ–ø–∫–∞ "–ó–∞–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω" ‚Äî —Ç–∞–∫–æ–π –∂–µ —Å—Ç–∏–ª—å –∫–∞–∫ "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" –∏ "–î–µ—Ç–∞–ª—å–Ω—ã–π –≤–∏–¥" */
        .baseline-set-btn {
            padding: 6px 14px !important;
            border-radius: 999px !important;
            font-size: 12px !important;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* –ö–Ω–æ–ø–∫–∞ "–°–≤—è–∑—å" ‚Äî —Ç–∞–∫–æ–π –∂–µ —Å—Ç–∏–ª—å –∫–∞–∫ –∫–Ω–æ–ø–∫–∞ "–î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω" */
        .link-toggle-btn {
            padding: 6px 14px;
            border-radius: 999px;
            border: 1px solid var(--color-primary);
            background: #e3f2fd;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: var(--color-primary);
            box-shadow: var(--shadow-sm);
            transition:
                background 0.25s ease,
                color 0.25s ease,
                box-shadow 0.25s ease,
                transform 0.25s ease;
        }

        .link-toggle-btn.active {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: #ffffff;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .link-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* –ö–Ω–æ–ø–∫–∞ "–î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω" ‚Äî —Ç–∞–∫–æ–π –∂–µ —Å—Ç–∏–ª—å –∫–∞–∫ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
        .baseline-toggle-btn {
            padding: 6px 14px;
            border-radius: 999px;
            border: 1px solid var(--color-primary);
            background: #e3f2fd;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: var(--color-primary);
            box-shadow: var(--shadow-sm);
            transition:
                background 0.25s ease,
                color 0.25s ease,
                box-shadow 0.25s ease,
                transform 0.25s ease;
        }

        .baseline-toggle-btn.active {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: #ffffff;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .baseline-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç–∏–ª—è –±–∞—Ä–æ–≤ –≤ –ì–∞–Ω—Ç–µ (–¥–µ—Ç–∞–ª—å–Ω—ã–π / –æ–±—â–∏–π –≤–∏–¥).
           –í –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç ¬´–î–µ—Ç–∞–ª—å–Ω–æ–º—É –≤–∏–¥—É¬ª –∏ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ —Ç–∞–± —ç—Ç–∞–ø–æ–≤
           (–≥–æ–ª—É–±–æ–π —Ñ–æ–Ω, —Å–∏–Ω–∏–π –±–æ—Ä–¥–µ—Ä). –í –∞–∫—Ç–∏–≤–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ¬´–û–±—â–∏–π –≤–∏–¥¬ª –∏
           —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–∏–Ω–µ–π ¬´–ø–∏–ª—é–ª–µ–π¬ª. */
        .gantt-style-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 999px;
            border: 1px solid var(--color-primary);
            background: #e3f2fd;
            font-size: 12px;
            cursor: pointer;
            color: var(--color-primary);
            box-shadow: var(--shadow-sm);
            transition:
                background 0.25s ease,
                color 0.25s ease,
                box-shadow 0.25s ease,
                transform 0.25s ease;
        }

        .gantt-style-toggle-btn span {
            white-space: nowrap;
        }

        .gantt-style-toggle-btn.active {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: #ffffff;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .gantt-style-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stage-settings-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 32px;
            border-radius: 10px;
            border: 1px solid var(--color-primary);
            background: #e3f2fd;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
            position: relative;
        }

        .stage-settings-btn:hover {
            background: #bbdefb;
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–∞–ø–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
        body.view-mode .stage-settings-btn {
            display: none;
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å –¥–≤—É–º—è —Å—Ç—Ä–æ–∫–∞–º–∏ (data-tooltip-line1 –∏ data-tooltip-line2) */
        .stage-settings-btn[data-tooltip-line1]::after,
        .gantt-style-toggle-btn[data-tooltip-line1]::after,
        .baseline-toggle-btn[data-tooltip-line1]::after {
            content: attr(data-tooltip-line1) "\A" attr(data-tooltip-line2);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translate(-50%, 0);
            padding: 6px 10px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            font-size: 11px;
            white-space: pre;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: bottom center;
            text-align: left;
            line-height: 1.4;
            min-width: 200px;
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π (data-tooltip) */
        .stage-settings-btn[data-tooltip]:not([data-tooltip-line1])::after,
        .gantt-style-toggle-btn[data-tooltip]:not([data-tooltip-line1])::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translate(-50%, 0);
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: bottom center;
            z-index: 9999;
        }

        .baseline-set-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translate(-50%, 0);
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: bottom center;
        }

        .stage-settings-btn:hover::after,
        .gantt-style-toggle-btn:hover::after,
        .baseline-toggle-btn:hover::after {
            opacity: 1;
            transform: translate(-50%, -6px);
            transition-delay: 1s;
        }

        /* Hover –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ —Å –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π */
        .stage-settings-btn[data-tooltip]:not([data-tooltip-line1]):hover::after,
        .gantt-style-toggle-btn[data-tooltip]:not([data-tooltip-line1]):hover::after {
            opacity: 1 !important;
            transform: translate(-50%, -6px);
            transition-delay: 1s;
        }

        .baseline-set-btn:hover::after {
            opacity: 1;
            transform: translate(-50%, -6px);
            transition-delay: 1s;
        }

        .stage-settings-icon {
            position: relative;
            width: 18px;
            height: 16px;
        }

        .stage-settings-bar {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--color-primary);
            border-radius: 999px;
        }

        .stage-settings-bar-1 {
            top: 2px;
        }

        .stage-settings-bar-2 {
            top: 7px;
        }

        .stage-settings-bar-3 {
            top: 12px;
        }

        .stage-settings-knob {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            border: 2px solid var(--color-primary);
            background: #fff;
        }

        .stage-settings-knob-1 {
            top: -1px;
            left: 2px;
        }

        .stage-settings-knob-2 {
            top: 4px;
            right: 2px;
        }

        .stage-settings-knob-3 {
            top: 9px;
            left: 6px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –∏ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media (max-width: 1024px) {
            .container {
                max-width: 100%;
                padding: 15px;
            }

            header {
                padding: 25px 15px;
            }

            header h1 {
                font-size: 1.4rem;
            }

            .header-subtitle {
                font-size: 0.9rem;
            }

            .company-info {
                flex-direction: column;
                gap: 20px;
                align-items: center;
            }

            .company-logo-display {
                width: 100%;
                max-width: 300px;
                justify-content: center;
                margin: 0 auto;
            }
            
            .company-logo-preview {
                margin: 0 auto;
            }

            .company-name-block {
                width: 100%;
                text-align: center;
            }

            .controls {
                flex-wrap: wrap;
                gap: 10px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            /* –î–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –≤–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –≥—Ä–∞—Ñ–∏–∫–∞ */
            .chart-container {
                overflow-x: auto;
                overflow-y: visible;
                -webkit-overflow-scrolling: touch;
                touch-action: pan-x pan-y pinch-zoom; /* –†–∞–∑—Ä–µ—à–∞–µ–º pinch-to-zoom */
            }

            .gantt-chart {
                overflow-x: auto;
                overflow-y: visible;
                -webkit-overflow-scrolling: touch;
                touch-action: pan-x pan-y pinch-zoom; /* –†–∞–∑—Ä–µ—à–∞–µ–º pinch-to-zoom */
                min-width: 100%;
            }

            .gantt-label {
                min-width: 120px;
                font-size: 0.75rem;
            }

            .gantt-header-cell {
                min-width: 35px;
                font-size: 0.7rem;
            }

            /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏ */
            .profile-btn,
            .companies-btn,
            .companies-bottom-btn,
            .logout-btn {
                width: 40px;
                height: 40px;
                right: 25px !important;
            }
            
            .theme-toggle-btn {
                width: 40px;
                height: 40px;
            }

            .profile-btn {
                top: 25px;
            }

            .theme-toggle-btn {
                right: 70px !important;
                left: auto !important;
                top: 25px !important;
                position: absolute !important;
            }

            .logout-btn {
                top: 129px; /* 77px (top –≤—Ç–æ—Ä–æ–π) + 40px (–≤—ã—Å–æ—Ç–∞ –≤—Ç–æ—Ä–æ–π) + 12px (–æ—Ç—Å—Ç—É–ø) = 129px */
            }

            .companies-bottom-btn {
                top: 181px; /* 129px (top –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞) + 40px (–≤—ã—Å–æ—Ç–∞ –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞) + 12px (–æ—Ç—Å—Ç—É–ø) = 181px */
            }

            .help-btn {
                top: 233px !important; /* 181px (top –∫–Ω–æ–ø–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π) + 40px (–≤—ã—Å–æ—Ç–∞ –∫–Ω–æ–ø–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π) + 12px (–æ—Ç—Å—Ç—É–ø) = 233px */
                right: 25px !important;
                width: 40px !important;
                height: 40px !important;
            }

            /* –•–æ–≤–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ */
            .profile-btn:hover:not(.animating),
            .logout-btn:hover:not(.animating),
            .companies-bottom-btn:hover:not(.animating),
            .help-btn:hover:not(.animating) {
                transform: translateY(-2px) scale(1.05) !important;
                box-shadow: 0 4px 12px rgba(66, 165, 245, 0.4) !important;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header {
                padding: 20px 15px;
                margin-bottom: 20px;
            }

            header h1 {
                font-size: 1.2rem;
                line-height: 1.3;
            }

            .header-subtitle {
                font-size: 0.85rem;
                margin-top: 8px;
            }

            .company-info {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
                align-items: center;
            }

            .company-logo-display {
                width: 100%;
                max-width: 250px;
                justify-content: center;
                margin: 0 auto;
            }

            .company-logo-preview {
                max-width: 200px;
                max-height: 150px;
                margin: 0 auto;
                display: block;
            }

            .company-name-display {
                font-size: 1.2rem;
                padding: 10px;
            }

            .controls {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }

            .controls-left,
            .controls-right {
                width: 100%;
                flex-direction: column;
                gap: 10px;
            }

            .btn {
                width: 100%;
                padding: 12px;
                font-size: 0.9rem;
                justify-content: center;
                min-height: 44px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è touch –Ω–∞ iOS */
                touch-action: manipulation; /* –£–ª—É—á—à–∞–µ—Ç –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å –Ω–∞ touch */
            }

            .btn-icon {
                margin-right: 8px;
            }

            /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏ */
            .profile-btn,
            .companies-btn,
            .companies-bottom-btn,
            .logout-btn {
                width: 38px;
                height: 38px;
                right: 15px !important;
            }

            .profile-btn {
                top: 15px;
            }

            .logout-btn {
                top: 65px; /* 15px (top –ø–µ—Ä–≤–æ–π) + 38px (–≤—ã—Å–æ—Ç–∞ –ø–µ—Ä–≤–æ–π) + 12px (–æ—Ç—Å—Ç—É–ø) = 65px */
            }

            .companies-bottom-btn {
                top: 115px; /* 65px (top –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞) + 38px (–≤—ã—Å–æ—Ç–∞ –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞) + 12px (–æ—Ç—Å—Ç—É–ø) = 115px */
            }

            .help-btn {
                top: 165px !important; /* 115px (top –∫–Ω–æ–ø–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π) + 38px (–≤—ã—Å–æ—Ç–∞ –∫–Ω–æ–ø–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π) + 12px (–æ—Ç—Å—Ç—É–ø) = 165px */
                right: 15px !important;
                width: 38px !important;
                height: 38px !important;
            }

            /* –•–æ–≤–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .profile-btn:hover:not(.animating),
            .logout-btn:hover:not(.animating),
            .companies-bottom-btn:hover:not(.animating) {
                transform: translateY(-2px) scale(1.05) !important;
                box-shadow: 0 4px 12px rgba(66, 165, 245, 0.4) !important;
            }

            .profile-btn::before {
                width: 18px;
                height: 18px;
                border-width: 2.5px;
            }

            .companies-btn::before {
                width: 16px;
                height: 16px;
                border-width: 1.5px;
            }

            .logout-btn::before {
                border-right-width: 10px;
                border-top-width: 7px;
                border-bottom-width: 7px;
            }

            /* –ì—Ä–∞—Ñ–∏–∫ –ì–∞–Ω—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .chart-container {
                isolation: isolate;
                contain: layout style;
                position: relative;
                z-index: 1;
                max-width: 100%;
                overflow: hidden;
            }

            .gantt-chart {
                overflow-x: auto;
                overflow-y: visible;
                -webkit-overflow-scrolling: touch;
                position: relative;
                max-width: 100%;
                box-sizing: border-box;
                z-index: 1;
                touch-action: pan-x pan-y pinch-zoom; /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –∏ pinch-to-zoom –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö –∏ –º–æ–±–∏–ª—å–Ω—ã—Ö */
                /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–∫—Ä–æ–ª–ª–±–∞—Ä –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ */
                scrollbar-width: thin; /* –î–ª—è Firefox */
                scrollbar-color: #90caf9 #e3f2fd; /* –î–ª—è Firefox */
            }

            /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –æ—Ç–∫–ª—é—á–∞–µ–º sticky –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞–∑–≤–∞–Ω–∏–π, —á—Ç–æ–±—ã –æ–Ω–∞ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–∞ –≥—Ä–∞—Ñ–∏–∫ */
            .gantt-header-label,
            .gantt-label {
                position: static !important; /* –û—Ç–∫–ª—é—á–∞–µ–º sticky –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
                max-width: 100%;
                width: 100%;
                min-width: auto;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                z-index: auto;
            }

            /* –Ø—á–µ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ */
            .gantt-row .gantt-cell {
                position: relative;
                z-index: 1;
                background: var(--color-bg);
            }

            .gantt-chart::-webkit-scrollbar {
                height: 8px;
            }

            .gantt-chart::-webkit-scrollbar-thumb {
                background: #90caf9;
                border-radius: 4px;
            }

            .gantt-chart::-webkit-scrollbar-track {
                background: #e3f2fd;
            }

            .gantt-label {
                min-width: 120px;
                max-width: 120px;
                width: 120px;
                font-size: 0.7rem;
                padding: 8px 6px;
                z-index: auto;
                position: static !important; /* –û—Ç–∫–ª—é—á–∞–µ–º sticky –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            }

            .gantt-header-label {
                min-width: 120px;
                max-width: 120px;
                width: 120px;
                z-index: auto;
                position: static !important; /* –û—Ç–∫–ª—é—á–∞–µ–º sticky –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            }

            /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≥—Ä–∞—Ñ–∏–∫ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç—Å—è */
            .gantt-cell,
            .gantt-header-cell {
                position: relative;
                z-index: 1;
            }

            .gantt-header-cell {
                min-width: 30px;
                font-size: 0.65rem;
                padding: 6px 4px;
            }

            .gantt-cell {
                min-width: 30px;
            }

            .gantt-bar {
                min-width: 20px;
            }

            /* –¢–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .table-section {
                position: relative;
                z-index: 1;
                max-width: 100%;
                overflow-x: auto;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* –û—Ç–∫–ª—é—á–∞–µ–º sticky –¥–ª—è —à–∞–ø–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
            #tasksTable thead th {
                position: static !important;
            }

            .tasks-table-wrapper {
                overflow-x: auto;
                overflow-y: visible;
                -webkit-overflow-scrolling: touch;
                position: relative;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                touch-action: pan-x pan-y pinch-zoom; /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –∏ pinch-to-zoom –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            }

            .tasks-table-wrapper::-webkit-scrollbar {
                height: 8px;
            }

            .tasks-table-wrapper::-webkit-scrollbar-thumb {
                background: #90caf9;
                border-radius: 4px;
            }

            .tasks-table-wrapper::-webkit-scrollbar-track {
                background: #e3f2fd;
            }

            .tasks-table {
                width: 100%;
                font-size: 0.85rem;
                min-width: 800px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
            }

            .tasks-table th,
            .tasks-table td {
                padding: 8px 6px;
                font-size: 0.8rem;
            }

            .tasks-table-input {
                padding: 6px 8px;
                font-size: 0.8rem;
            }

            /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
            .statistics {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }

            .stat-item {
                width: 100%;
                padding: 12px;
            }

            /* –≠—Ç–∞–ø—ã */
            .stage-tabs {
                flex-wrap: wrap;
                gap: 8px;
                padding: 10px;
                flex-direction: column;
            }

            .stage-tabs-buttons {
                width: 100%;
                display: flex;
                flex-direction: column; /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö */
                gap: 8px;
            }

            .stage-tab-btn {
                width: 100%; /* –í—Å–µ –∫–Ω–æ–ø–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —à–∏—Ä–∏–Ω—ã */
                padding: 10px 12px;
                font-size: 0.85rem;
                min-height: 44px;
            }

            /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ —Ç–æ–∂–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö */
            .stage-controls-buttons {
                flex-direction: column !important;
                width: 100%;
                gap: 8px !important;
            }

            /* –û–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö - –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —à–∏—Ä–∏–Ω—ã */
            .responsible-toggle-btn,
            .gantt-style-toggle-btn,
            .baseline-set-btn,
            .baseline-toggle-btn,
            .stage-settings-btn {
                width: 100%; /* –í—Å–µ –∫–Ω–æ–ø–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —à–∏—Ä–∏–Ω—ã */
                padding: 10px 12px;
                font-size: 0.8rem;
                min-height: 44px;
                justify-content: center;
            }

            /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–æ–∫ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö */
            .link-toggle-btn {
                font-size: 0.75rem;
            }
            .baseline-toggle-btn {
                font-size: 0.75rem;
            }

            /* –£–±–∏—Ä–∞–µ–º min-width –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö */
            .stage-tab-btn.responsible-toggle-btn {
                min-width: auto;
                flex: 0 0 auto;
            }

            .stage-tab {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            /* –ö–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω–∏—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å - –∫—Ä—É–≥–ª—ã–µ, –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞, –ø–æ–¥ –¥—Ä—É–≥–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ */
            .stage-tabs-container {
                flex-direction: column;
                align-items: stretch;
            }

            .stage-tabs {
                order: 1;
                width: 100%;
            }

            /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ undo/redo - –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ */
            .stage-tabs-container > .undo-btn,
            .stage-tabs-container > .redo-btn {
                order: 2;
                width: 44px !important;
                height: 44px !important;
                min-width: 44px !important;
                padding: 0 !important;
                border-radius: 50% !important;
                margin-top: 8px;
                margin-right: 8px;
                display: inline-flex !important;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }

            .stage-tabs-container > .redo-btn {
                margin-right: 0;
            }

            /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
            .modal-content {
                width: 95%;
                max-width: 95%;
                padding: 20px 15px;
                margin: 10% auto;
            }

            .modal-header h2 {
                font-size: 1.3rem;
            }

            .profile-modal-content {
                width: 95%;
                max-width: 95%;
                padding: 20px 15px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }

            header {
                padding: 15px 12px;
                margin-bottom: 15px;
            }

            header h1 {
                font-size: 1rem;
                line-height: 1.2;
            }

            .header-subtitle {
                font-size: 0.75rem;
                margin-top: 6px;
            }

            .company-info {
                padding: 12px;
                align-items: center;
            }
            
            .company-logo-display {
                justify-content: center;
                margin: 0 auto;
            }

            .company-logo-preview {
                max-width: 150px;
                max-height: 120px;
                margin: 0 auto;
                display: block;
            }

            .company-name-display {
                font-size: 1rem;
                padding: 8px;
            }

            .controls {
                padding: 12px;
            }

            .btn {
                padding: 10px;
                font-size: 0.85rem;
                min-height: 44px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è touch –Ω–∞ iOS */
                touch-action: manipulation; /* –£–ª—É—á—à–∞–µ—Ç –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å –Ω–∞ touch */
            }

            /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏ */
            .profile-btn,
            .companies-btn,
            .companies-bottom-btn,
            .logout-btn {
                width: 35px;
                height: 35px;
                right: 12px !important;
            }
            
            .theme-toggle-btn {
                width: 35px;
                height: 35px;
            }

            .profile-btn {
                top: 12px;
            }

            .theme-toggle-btn {
                right: 60px !important;
                left: auto !important;
                top: 15px !important;
                position: absolute !important;
            }

            .logout-btn {
                top: 59px; /* 12px (top –ø–µ—Ä–≤–æ–π) + 35px (–≤—ã—Å–æ—Ç–∞ –ø–µ—Ä–≤–æ–π) + 12px (–æ—Ç—Å—Ç—É–ø) = 59px */
            }

            .companies-bottom-btn {
                top: 106px; /* 59px (top –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞) + 35px (–≤—ã—Å–æ—Ç–∞ –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞) + 12px (–æ—Ç—Å—Ç—É–ø) = 106px */
            }

            .help-btn {
                top: 153px !important; /* 106px (top –∫–Ω–æ–ø–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π) + 35px (–≤—ã—Å–æ—Ç–∞ –∫–Ω–æ–ø–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π) + 12px (–æ—Ç—Å—Ç—É–ø) = 153px */
                right: 12px !important;
                width: 35px !important;
                height: 35px !important;
            }

            /* –•–æ–≤–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
            .profile-btn:hover:not(.animating),
            .logout-btn:hover:not(.animating),
            .companies-bottom-btn:hover:not(.animating) {
                transform: translateY(-2px) scale(1.05) !important;
                box-shadow: 0 4px 12px rgba(66, 165, 245, 0.4) !important;
            }

            .gantt-label {
                min-width: 80px;
                max-width: 80px;
                font-size: 0.65rem;
                padding: 6px 4px;
                word-break: break-word;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .gantt-header-cell {
                min-width: 25px;
                font-size: 0.6rem;
                padding: 4px 2px;
            }

            .gantt-cell {
                min-width: 25px;
            }

            /* –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å–∫—Ä–æ–ª–ª –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .gantt-chart {
                overflow-x: auto;
                overflow-y: visible;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                scrollbar-color: #90caf9 #e3f2fd;
            }

            .tasks-table {
                font-size: 0.75rem;
            }

            .tasks-table th,
            .tasks-table td {
                padding: 6px 4px;
                font-size: 0.7rem;
                /* –£–±–∏—Ä–∞–µ–º nowrap –¥–ª—è —è—á–µ–µ–∫, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –≤ input –ø–æ–ª—è—Ö –º–æ–≥ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å—Å—è */
                white-space: normal;
            }

            .tasks-table-input {
                padding: 4px 6px;
                font-size: 0.7rem;
                width: 100%;
                min-width: 60px;
                /* –£–±–∏—Ä–∞–µ–º –æ–±—Ä–µ–∑–∫—É —Ç–µ–∫—Å—Ç–∞ - –ø—Ä–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏ —Å—Ç–æ–ª–±—Ü–∞ —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é */
                overflow: visible !important;
                text-overflow: clip !important;
                white-space: normal !important;
                word-wrap: break-word;
            }

            /* –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å–∫—Ä–æ–ª–ª –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .tasks-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                scrollbar-color: #90caf9 #e3f2fd;
            }

            .statistics {
                padding: 12px;
            }

            .stat-item {
                padding: 10px;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .stat-label {
                font-size: 0.75rem;
            }

            .stage-tabs {
                padding: 8px;
                flex-direction: column;
            }

            .stage-tabs-buttons {
                width: 100%;
                display: flex;
                flex-direction: column; /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
                gap: 8px;
            }

            .stage-tab-btn {
                width: 100%; /* –í—Å–µ –∫–Ω–æ–ø–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —à–∏—Ä–∏–Ω—ã */
                min-height: 44px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è touch –Ω–∞ iOS */
                padding: 10px 12px;
                font-size: 0.875rem;
                touch-action: manipulation; /* –£–ª—É—á—à–∞–µ—Ç –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å –Ω–∞ touch */
            }

            /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ —Ç–æ–∂–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .stage-controls-buttons {
                flex-direction: column !important;
                width: 100%;
                gap: 8px !important;
            }

            /* –û–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö - –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —à–∏—Ä–∏–Ω—ã */
            .link-toggle-btn,
            .responsible-toggle-btn,
            .gantt-style-toggle-btn,
            .baseline-set-btn,
            .baseline-toggle-btn,
            .stage-settings-btn {
                width: 100% !important; /* –í—Å–µ –∫–Ω–æ–ø–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —à–∏—Ä–∏–Ω—ã */
                padding: 10px 12px;
                font-size: 0.75rem;
                min-height: 44px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è touch –Ω–∞ iOS */
                touch-action: manipulation;
                justify-content: center;
                display: flex !important;
                align-items: center;
            }

            /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏ "–î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω" –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .baseline-toggle-btn {
                font-size: 0.7rem;
                white-space: nowrap;
            }

            /* –ö–Ω–æ–ø–∫–∞ "–†–µ–¥–∞–∫—Ü–∏—è —ç—Ç–∞–ø–æ–≤" –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö - –ø–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ —Å —Ç–µ–∫—Å—Ç–æ–º */
            .stage-settings-btn {
                height: auto !important;
            }

            /* –£–±–∏—Ä–∞–µ–º min-width –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö, —á—Ç–æ–±—ã –æ–Ω–∞ –±—ã–ª–∞ —Ç–∞–∫–æ–≥–æ –∂–µ —Ä–∞–∑–º–µ—Ä–∞ */
            .stage-tab-btn.responsible-toggle-btn {
                min-width: auto;
                flex: 0 0 auto;
            }

            /* –ö–Ω–æ–ø–∫–∞ "–æ—Ç–º–µ–Ω–∞" –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö - –ø–æ–¥ –∫–Ω–æ–ø–∫–∞–º–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–∞–ø–æ–≤ */
            .stage-tabs-container {
                flex-direction: column;
                align-items: stretch;
            }

            .stage-tabs {
                order: 1;
                width: 100%;
            }

            /* –ö–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω–∏—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å - –∫—Ä—É–≥–ª—ã–µ, –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞, –ø–æ–¥ –¥—Ä—É–≥–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ */
            .stage-tabs-container > .undo-btn,
            .stage-tabs-container > .redo-btn {
                order: 2;
                width: 44px !important;
                height: 44px !important;
                min-width: 44px !important;
                padding: 0 !important;
                border-radius: 50% !important;
                margin-top: 8px;
                margin-right: 8px;
                display: inline-flex !important;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }

            .stage-tabs-container > .redo-btn {
                margin-right: 0;
            }
            
            /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ undo/redo - –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ */
            .stage-tabs-container > .undo-btn,
            .stage-tabs-container > .redo-btn {
                display: inline-flex;
            }

            .stage-tab {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            .modal-content {
                width: 98%;
                max-width: 98%;
                padding: 15px 12px;
                margin: 5% auto;
            }

            .modal-header h2 {
                font-size: 1.1rem;
            }

            .profile-modal-content {
                width: 98%;
                max-width: 98%;
                padding: 15px 12px;
            }

            .profile-modal-header h2 {
                font-size: 1.1rem;
            }

            .profile-form-group input {
                padding: 10px;
                font-size: 16px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iOS */
            }
        }

        /* Landscape –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media (max-width: 768px) and (orientation: landscape) {
            .container {
                padding: 8px;
            }

            header {
                padding: 15px 12px;
                margin-bottom: 10px;
            }

            header h1 {
                font-size: 1.1rem;
            }

            .controls {
                padding: 10px;
                gap: 8px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .gantt-chart {
                max-height: 50vh;
            }

            .tasks-table-wrapper {
                max-height: 40vh;
            }
        }

        @media (max-width: 360px) {
            header h1 {
                font-size: 0.9rem;
            }

            .gantt-label {
                min-width: 70px;
                font-size: 0.6rem;
            }

            .gantt-header-cell {
                min-width: 20px;
                font-size: 0.55rem;
            }
        }

        /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö –∏ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media (max-width: 1024px) {
            .chart-container {
                overflow-x: auto;
                overflow-y: visible;
                -webkit-overflow-scrolling: touch;
                touch-action: pan-x pan-y;
            }

            .gantt-chart-wrapper {
                overflow-x: auto;
                overflow-y: visible;
                -webkit-overflow-scrolling: touch;
                position: relative;
                touch-action: pan-x pan-y;
            }

            .gantt-chart {
                min-width: 800px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è */
                touch-action: pan-x pan-y;
            }
        }

        @media (max-width: 768px) {
            .tasks-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                touch-action: pan-x pan-y;
            }

            .tasks-table {
                min-width: 600px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
            }
        }

        @media print {
            .controls {
                display: none;
            }

            .chart-container {
                box-shadow: none;
                border: 1px solid var(--color-border);
            }
        }
        /* –§—É—Ç—Ç–µ—Ä */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--color-surface);
            border-top: 2px solid var(--color-primary);
            padding: 15px 20px;
            text-align: center;
            color: var(--color-text-secondary);
            font-size: 0.85rem;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        
        /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        html {
            overflow-x: hidden;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        
        body {
            min-height: 100vh;
            overflow-x: hidden;
            height: auto;
            padding: 0;
            margin: 0;
            padding-bottom: 70px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ—É—Ç–µ—Ä–∞ */
        }
        
        .container {
            padding-bottom: 0;
            margin-bottom: 0;
        }
        
        /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
        .container > *:last-child {
            margin-bottom: 0 !important;
        }
        
        /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã —É –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –∫–æ–Ω—Ü–µ */
        body > .container:last-of-type {
            margin-bottom: 0 !important;
            padding-bottom: 0 !important;
        }
        
        /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ —É –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ —Ñ—É—Ç–µ—Ä–æ–º */
        body > *:not(.footer) {
            margin-bottom: 0;
        }
        
        /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ —É —Ñ—É—Ç–µ—Ä–∞ */
        .footer {
            margin-top: 0;
        }

        .footer p {
            margin: 0;
        }

        @media (max-width: 768px) {
            .footer {
                font-size: 0.75rem;
                padding: 12px 15px;
            }
        }

        /* ========== –°–ò–°–¢–ï–ú–ê –ü–û–î–°–ö–ê–ó–û–ö –î–õ–Ø –ù–û–í–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ========== */
        
        /* –ö–Ω–æ–ø–∫–∞ —Å–ø—Ä–∞–≤–∫–∏ */
        .help-btn {
            position: absolute;
            top: 180px;
            right: 30px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
            border: 2px solid #2c2c2c;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            z-index: 1000;
            font-size: 20px;
            font-weight: bold;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: visible;
        }

        .help-btn:hover {
            transform: translateY(-2px) scale(1.1);
            box-shadow: 0 6px 20px rgba(66, 165, 245, 0.6);
        }

        /* –ó–æ–ª–æ—Ç–∞—è —Ç–æ—á–∫–∞, –≤—Ä–∞—â–∞—é—â–∞—è—Å—è –ø–æ –∫—Ä—É–≥—É –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        .help-btn::before {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(255, 215, 0, 0.8);
            top: 50%;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            opacity: 0;
            z-index: 1003;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        /* –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–æ–ª–æ—Ç—É—é —Ç–æ—á–∫—É –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é */
        .help-btn:hover::before {
            opacity: 1;
            animation: rotateDot 2s linear infinite;
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∫–∏ –≤ —Å—Ç–∏–ª–µ —Ä–µ–¥–∞–∫—Ü–∏–∏ —ç—Ç–∞–ø–æ–≤ */
        .help-btn[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            top: calc(100% + 8px);
            left: 50%;
            transform: translate(-50%, 0);
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: top center;
            z-index: 9999;
        }

        .help-btn[data-tooltip]:hover::after {
            opacity: 1 !important;
            transform: translate(-50%, 6px);
            transition-delay: 1s;
        }

        /* –°–∏–º–≤–æ–ª ? –≤–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏ */
        .help-btn .help-icon {
            position: relative;
            z-index: 1002;
            font-size: 20px;
            font-weight: bold;
            color: white;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π */
        .new-feature-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 18px;
            height: 18px;
            background: #f44336;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
        }

        /* Overlay –¥–ª—è —Ç—É—Ä–æ–≤ */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tour-overlay.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ —Ç—É—Ä–µ */
        .tour-highlight {
            position: relative;
            z-index: 10001;
            box-shadow: 0 0 0 4px rgba(66, 165, 245, 0.8),
                        0 0 20px rgba(66, 165, 245, 0.6),
                        0 0 40px rgba(66, 165, 245, 0.4);
            border-radius: 8px;
            animation: highlightPulse 2s infinite;
        }

        @keyframes highlightPulse {
            0%, 100% {
        box-shadow: 0 0 0 4px rgba(66, 165, 245, 0.8),
                    0 0 20px rgba(66, 165, 245, 0.6),
                    0 0 40px rgba(66, 165, 245, 0.4);
            }
            50% {
        box-shadow: 0 0 0 6px rgba(66, 165, 245, 1),
                    0 0 30px rgba(66, 165, 245, 0.8),
                    0 0 60px rgba(66, 165, 245, 0.6);
            }
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Ç—É—Ä–∞ */
        .tour-tooltip {
            position: fixed;
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 10002;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tour-tooltip h3 {
            margin: 0 0 10px 0;
            color: #2196f3;
            font-size: 1.2rem;
        }

        .tour-tooltip p {
            margin: 0 0 15px 0;
            color: #333;
            line-height: 1.6;
        }

        .tour-tooltip .tour-progress {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 15px;
        }

        .tour-tooltip .tour-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .tour-tooltip button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .tour-tooltip .tour-btn-skip {
            background: #e0e0e0;
            color: #333;
        }

        .tour-tooltip .tour-btn-skip:hover {
            background: #d0d0d0;
        }

        .tour-tooltip .tour-btn-next {
            background: #2196f3;
            color: white;
        }

        .tour-tooltip .tour-btn-next:hover {
            background: #1976d2;
        }

        .tour-tooltip .tour-btn-finish {
            background: #4caf50;
            color: white;
        }

        .tour-tooltip .tour-btn-finish:hover {
            background: #45a049;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–ø—Ä–∞–≤–∫–∏ */
        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10003;
            animation: fadeIn 0.3s ease;
        }

        .help-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            position: relative;
            /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–∫—Ä–æ–ª–ª–∞ */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE –∏ Edge */
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è Chrome, Safari –∏ Opera */
        .help-modal-content::-webkit-scrollbar {
            display: none;
        }

        .help-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .help-modal-header h2 {
            margin: 0;
            color: #2196f3;
            font-size: 1.5rem;
        }

        .help-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .help-modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .help-section {
            margin-bottom: 25px;
        }

        .help-section h3 {
            color: #2196f3;
            margin: 0 0 10px 0;
            font-size: 1.2rem;
        }

        .help-section ul {
            margin: 0;
            padding-left: 20px;
        }

        .help-section li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .help-key {
            display: inline-block;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 2px 8px;
            font-family: monospace;
            font-size: 0.9em;
            margin: 0 2px;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–ø—Ä–∞–≤–∫–∏ */
        [data-theme="dark"] .help-modal-content {
            background: var(--color-surface);
            color: var(--color-text);
        }

        [data-theme="dark"] .help-modal-header {
            border-bottom: 2px solid rgba(224, 224, 224, 0.2);
        }

        [data-theme="dark"] .help-modal-header h2 {
            color: #64b5f6;
        }

        [data-theme="dark"] .help-modal-close {
            color: #b0b0b0;
        }

        [data-theme="dark"] .help-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text);
        }

        [data-theme="dark"] .help-section h3 {
            color: #64b5f6;
        }

        [data-theme="dark"] .help-section li {
            color: var(--color-text);
        }

        [data-theme="dark"] .help-key {
            background: var(--color-bg);
            border: 1px solid rgba(100, 181, 246, 0.3);
            color: var(--color-text);
        }

        /* –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π */
        .feature-tooltip {
            position: fixed;
            background: #2196f3;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 10004;
            max-width: 300px;
            animation: slideIn 0.3s ease;
            pointer-events: none;
        }

        .feature-tooltip::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #2196f3;
        }

        @media (max-width: 768px) {
            /* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —É–∂–µ –∑–∞–¥–∞–Ω–æ –≤ –º–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å–∞—Ö –≤—ã—à–µ, –∑–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
            .help-btn {
                font-size: 18px;
            }

            .tour-tooltip {
                max-width: 90%;
                padding: 15px;
            }

            .help-modal-content {
                max-width: 90%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- –ù–∞–¥–ø–∏—Å—å DeadLinePro –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
    <div id="deadlineProLabel" style="position: fixed; top: 20px; right: 20px; z-index: 9999; font-size: 32px; font-weight: 600; color: rgba(33, 150, 243, 0.5); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; pointer-events: none; user-select: none;">DeadLinePro</div>
    <div class="container">
        <header>
            <button class="logout-btn" id="logoutBtn" data-tooltip="–í—ã—Ö–æ–¥" style="display: none;" onclick="logout()">
                <span class="logout-icon"></span>
                <span class="logout-tooltip">–í—ã—Ö–æ–¥</span>
            </button>
            <button class="profile-btn" id="profileBtn" data-tooltip="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å" style="display: none;">
                <span class="profile-icon-head"></span>
                <span class="profile-icon-mouth"></span>
                <span class="profile-icon-shoulders"></span>
                <span class="profile-tooltip">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</span>
            </button>
            <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —Å–ø–∏—Å–∫—É –∫–æ–º–ø–∞–Ω–∏–π (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∞—Ä—Ö–∏–≤–æ–º) -->
            <button class="companies-bottom-btn" id="companiesBottomBtn" data-tooltip="–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–æ–º–ø–∞–Ω–∏—è–º" style="display: none;" onclick="goToCompanies()">
                <span class="companies-bottom-icon"></span>
                <span class="companies-bottom-tooltip">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–æ–º–ø–∞–Ω–∏—è–º</span>
            </button>
            <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã -->
            <button class="theme-toggle-btn" id="themeToggleBtn" data-tooltip="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" onclick="toggleTheme()">
                <span class="theme-tooltip">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É</span>
            </button>
            <!-- –ö–Ω–æ–ø–∫–∞ —Å–ø—Ä–∞–≤–∫–∏ -->
            <button class="help-btn" id="helpBtn" data-tooltip="–°–ø—Ä–∞–≤–∫–∞ –ø–æ –≥–æ—Ä—è—á–∏–º –∫–ª–∞–≤–∏—à–∞–º" style="display: none;">
                <span class="help-icon">?</span>
                <span class="new-feature-badge" id="helpBadge" style="display: none;">!</span>
            </button>
            <h1>
                <span class="header-icon"></span>
                <span>–ì—Ä–∞—Ñ–∏–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏ –æ–±—É—á–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã ICONA</span>
            </h1>
            <p class="header-subtitle">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞–Ω–∞ —Ü–∏—Ñ—Ä–æ–≤–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤</p>
            <div class="company-info">
                <div class="company-logo-display" id="companyLogoWrapper">
                    <img id="companyLogo" class="company-logo-preview" src="favicon.png" alt="–õ–æ–≥–æ—Ç–∏–ø –∫–æ–º–ø–∞–Ω–∏–∏">
                </div>
                <div class="company-name-block">
                    <span class="company-name-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</span>
                    <div
                        id="companyNameDisplay"
                        class="company-name-display"
                        data-placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏"
                    >–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</div>
                    <div
                        id="companyObjectNameDisplay"
                        class="company-object-name-display"
                        style="display: none;"
                    ></div>
                </div>
            </div>
        </header>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">–í—Å–µ–≥–æ —ç—Ç–∞–ø–æ–≤</div>
                <div class="stat-value" id="totalStages">4</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                <div class="stat-value" id="totalTasks">51</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π</div>
                <div class="stat-value" id="totalDays">265</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–ù–µ–¥–µ–ª—å</div>
                <div class="stat-value" id="totalWeeks">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–ú–µ—Å—è—Ü–µ–≤</div>
                <div class="stat-value" id="totalMonths">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</div>
                <div class="stat-value" id="completionDate">-</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-secondary reset-plan-btn" onclick="resetSchedule()" data-tooltip="–°–±—Ä–æ—Å–∏—Ç—å –ø–ª–∞–Ω">
                <span class="btn-icon btn-icon-reset"></span>
            </button>
            <button class="btn btn-primary" id="saveButton" onclick="manualSaveGantt()" data-tooltip="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è">
                <span class="btn-icon">üíæ</span>
                <span id="saveButtonText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
            </button>
            <button class="btn btn-secondary view-toggle-btn" onclick="toggleView()">
                <span class="btn-icon btn-icon-toggle"></span>
                <span class="view-toggle-label">
                    <span class="view-toggle-part view-toggle-gantt">–ì–∞–Ω—Ç</span>
                    <span class="view-toggle-separator">/</span>
                    <span class="view-toggle-part view-toggle-table">–¢–∞–±–ª–∏—Ü–∞</span>
                </span>
            </button>
            <button class="btn btn-primary" id="exportUnifiedButton" onclick="openPDFExportModal('pdf')">
                <span class="btn-icon btn-icon-pdf"></span>
                <span>–≠–∫—Å–ø–æ—Ä—Ç</span>
            </button>
            <div style="display: inline-flex; align-items: center; gap: 8px;">
                <div class="search-input-container" style="position: relative; display: inline-block;">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–¥–∞—á–∞–º..."
                        style="
                            padding: 8px 40px 8px 12px;
                            font-size: 14px;
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            width: 250px;
                            box-sizing: border-box;
                            transition: border-color 0.3s ease;
                        "
                        autocomplete="off"
                        data-tooltip="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–¥–∞—á–∞–º (Ctrl+Enter)"
                    >
                    <span class="search-icon" style="
                        position: absolute;
                        right: 12px;
                        top: 50%;
                        transform: translateY(-50%);
                        width: 18px;
                        height: 18px;
                        pointer-events: none;
                        opacity: 0.6;
                    ">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 100%; height: 100%;">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </span>
                </div>
                <div id="searchNavigation" style="display: none; align-items: center; gap: 4px;">
                    <button 
                        id="searchPrevBtn"
                        onclick="navigateSearchResults(-1)"
                        style="
                            padding: 4px 8px;
                            font-size: 16px;
                            border: 2px solid #2196f3;
                            border-radius: 4px;
                            background: #fff;
                            color: #2196f3;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            width: 32px;
                            height: 32px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            line-height: 1;
                        "
                        onmouseover="this.style.background='#e3f2fd'"
                        onmouseout="this.style.background='#fff'"
                        data-tooltip="–ü—Ä–µ–¥—ã–¥—É—â–∞—è (Shift+Enter)"
                    >
                        ‚Üê
                    </button>
                    <span 
                        id="searchCounter"
                        style="
                            font-size: 12px;
                            color: #666;
                            min-width: 50px;
                            text-align: center;
                        "
                    ></span>
                    <button 
                        id="searchNextBtn"
                        onclick="navigateSearchResults(1)"
                        style="
                            padding: 4px 8px;
                            font-size: 16px;
                            border: 2px solid #2196f3;
                            border-radius: 4px;
                            background: #fff;
                            color: #2196f3;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            width: 32px;
                            height: 32px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            line-height: 1;
                        "
                        onmouseover="this.style.background='#e3f2fd'"
                        onmouseout="this.style.background='#fff'"
                        data-tooltip="–°–ª–µ–¥—É—é—â–∞—è (Enter)"
                    >
                        ‚Üí
                    </button>
                </div>
            </div>

            <div class="zoom-controls">
                <span class="zoom-label">–ú–∞—Å—à—Ç–∞–± –ø–æ –≤—Ä–µ–º–µ–Ω–∏:</span>
                <button class="btn btn-secondary" onclick="decreaseZoom()">‚àí</button>
                <input type="range" id="zoomRange" class="zoom-range" min="40" max="200" value="120" step="5" onchange="onZoomChange(this.value)">
                <button class="btn btn-secondary" onclick="increaseZoom()">+</button>
                <span class="zoom-label" style="margin-left: 8px;">–î–ª—è –∑—É–º–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∂–º–∏—Ç–µ Z+–∫–æ–ª–µ—Å–æ –º—ã—à–∏</span>
            </div>
        </div>

        <div class="stage-tabs-container" style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">
            <button 
                class="undo-btn" 
                id="undoBtn"
                onclick="undoLastAction()"
                data-tooltip="–û—Ç–º–µ–Ω–∏—Ç—å"
            >‚Ü∂</button>
            <button 
                class="redo-btn" 
                id="redoBtn"
                onclick="redoLastAction()"
                data-tooltip="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å"
            >‚Ü∑</button>
            <div class="stage-tabs">
                <div class="stage-tabs-buttons" style="display: none;">
                    <button class="stage-tab-btn active">–í—Å–µ —ç—Ç–∞–ø—ã</button>
                    <button class="stage-tab-btn">–≠—Ç–∞–ø 1</button>
                    <button class="stage-tab-btn">–≠—Ç–∞–ø 2</button>
                    <button class="stage-tab-btn">–≠—Ç–∞–ø 3</button>
                    <button class="stage-tab-btn">–≠—Ç–∞–ø 4</button>
                </div>
                <div class="stage-controls-buttons" style="display: flex; align-items: center; gap: 8px;">
                <button
                    class="link-toggle-btn"
                    id="linkToggleBtn"
                    onclick="toggleLinkColumn()"
                    data-tooltip="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å—Ç–æ–ª–±–µ—Ü '–°–≤—è–∑—å'"
                >
                    –°–≤—è–∑—å
                </button>
                <button
                    class="stage-tab-btn responsible-toggle-btn"
                    id="responsibleToggleBtn"
                    onclick="toggleResponsibleColumn()"
                    data-tooltip="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å—Ç–æ–ª–±–µ—Ü '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'"
                >
                    –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π
                </button>
                <button
                    class="baseline-toggle-btn"
                    id="baselineToggleBtn"
                    onclick="toggleBaselineDisplay()"
                    data-tooltip-line1="–ó–∞–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω (F2)"
                    data-tooltip-line2="–°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω (F3)"
                >
                    –ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω
                </button>
                <button
                    class="gantt-style-toggle-btn"
                    id="ganttStyleToggleBtn"
                    onclick="toggleGanttBarStyle()"
                    data-tooltip="–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–Ω–µ–π –≤ –¥–∏–∞–≥—Ä–∞–º–º–µ –ì–∞–Ω—Ç–∞"
                >
                    <span>–î–µ—Ç–∞–ª—å–Ω—ã–π –≤–∏–¥</span>
                </button>
                <button class="stage-settings-btn" onclick="openStageSettingsModal(event)" data-tooltip="–†–µ–¥–∞–∫—Ü–∏—è —ç—Ç–∞–ø–æ–≤">
                    <span class="stage-settings-icon">
                        <span class="stage-settings-bar stage-settings-bar-1"></span>
                        <span class="stage-settings-bar stage-settings-bar-2"></span>
                        <span class="stage-settings-bar stage-settings-bar-3"></span>
                        <span class="stage-settings-knob stage-settings-knob-1"></span>
                        <span class="stage-settings-knob stage-settings-knob-2"></span>
                        <span class="stage-settings-knob stage-settings-knob-3"></span>
                    </span>
                </button>
                <div class="sticky-controls">
                    <span class="zoom-label">–§–∏–∫—Å–∞—Ü–∏—è:</span>
                    <label class="sticky-toggle" data-tooltip="–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü '–ó–∞–¥–∞—á–∞'">
                        <input type="checkbox" id="stickyLabelToggle" onchange="toggleStickyColumn('label')">
                        <span class="sticky-switch"></span>
                        <span class="sticky-toggle-text">–ó–∞–¥–∞—á–∞</span>
                    </label>
                    <label class="sticky-toggle" data-tooltip="–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'">
                        <input type="checkbox" id="stickyStartToggle" onchange="toggleStickyColumn('start')">
                        <span class="sticky-switch"></span>
                        <span class="sticky-toggle-text">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</span>
                    </label>
                    <label class="sticky-toggle" data-tooltip="–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è'">
                        <input type="checkbox" id="stickyEndToggle" onchange="toggleStickyColumn('end')">
                        <span class="sticky-switch"></span>
                        <span class="sticky-toggle-text">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</span>
                    </label>
                    <label class="sticky-toggle" data-tooltip="–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü '–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π'">
                        <input type="checkbox" id="stickyDaysToggle" onchange="toggleStickyColumn('days')">
                        <span class="sticky-switch"></span>
                        <span class="sticky-toggle-text">–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π</span>
                    </label>
                    <label class="sticky-toggle" data-tooltip="–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü '–°–≤—è–∑—å'">
                        <input type="checkbox" id="stickyLinkToggle" onchange="toggleStickyColumn('link')">
                        <span class="sticky-switch"></span>
                        <span class="sticky-toggle-text">–°–≤—è–∑—å</span>
                    </label>
                    <label class="sticky-toggle" data-tooltip="–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'">
                        <input type="checkbox" id="stickyResponsibleToggle" onchange="toggleStickyColumn('responsible')">
                        <span class="sticky-switch"></span>
                        <span class="sticky-toggle-text">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</span>
                    </label>
                </div>
                </div>
            </div>
        </div>

        <div class="chart-container view-active">
            <div id="ganttChart" class="gantt-chart"></div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #1e88e5 0%, #0b5ed7 100%);"></div>
                    <span>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);"></div>
                    <span>–í –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);"></div>
                    <span>–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                </div>
            </div>
        </div>

        <div class="table-section view-hidden">
            <h2><span class="btn-icon btn-icon-table"></span> –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á</h2>
            <table id="tasksTable" class="tasks-table">
                <thead>
                    <tr>
                        <th>‚Ññ –ø/–ø</th>
                        <th>–í—ã–±–æ—Ä —ç—Ç–∞–ø–∞</th>
                        <th>–≠—Ç–∞–ø</th>
                        <th>–í–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è</th>
                        <th>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</th>
                        <th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th>
                        <th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
                        <th>–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π</th>
                        <th class="table-col-responsible">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody id="tasksTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- –ú–µ–Ω—é –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —è—á–µ–π–∫–∏/–¥–∏–∞–ø–∞–∑–æ–Ω–∞ –ø–æ –¥–∞—Ç–µ -->
    <div id="statusMenu" class="status-menu">
        <div class="status-menu-item" data-status="pending">
            <div class="status-color-box" style="background: linear-gradient(135deg, #1e88e5 0%, #0b5ed7 100%);"></div>
            <span>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</span>
        </div>
        <div class="status-menu-item" data-status="in-progress">
            <div class="status-color-box" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);"></div>
            <span>–í —Ä–∞–±–æ—Ç–µ</span>
        </div>
        <div class="status-menu-item" data-status="completed">
            <div class="status-color-box" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);"></div>
            <span>–ó–∞–≤–µ—Ä—à–µ–Ω–æ (—Å –Ω–∞—á–∞–ª–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É)</span>
        </div>
    </div>

    <!-- –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞ –¥–Ω—è (—Ä–∞–±–æ—á–∏–π/–≤—ã—Ö–æ–¥–Ω–æ–π) -->
    <div id="dayStatusMenu" class="status-menu">
        <div class="status-menu-item" data-day-status="workday">
            <div class="status-color-box" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);"></div>
            <span>–†–∞–±–æ—á–∏–π –¥–µ–Ω—å</span>
        </div>
        <div class="status-menu-item" data-day-status="holiday">
            <div class="status-color-box" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);"></div>
            <span>–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å</span>
        </div>
        <div class="status-menu-item" data-day-status="reset" style="border-top: 1px solid var(--color-border); margin-top: 5px; padding-top: 5px;">
            <div class="status-color-box" style="background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);"></div>
            <span>–°–±—Ä–æ—Å–∏—Ç—å (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π)</span>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="startDateInput">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ (—Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å):</label>
                <input type="date" id="startDateInput" value="">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="updateStartDate()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∫ —Å—Ç–∞—Ç—É—Å—É "–í —Ä–∞–±–æ—Ç–µ"/"–ó–∞–≤–µ—Ä—à–µ–Ω–æ" -->
    <div id="statusCommentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Å—Ç–∞—Ç—É—Å—É</h2>
                <span class="close" onclick="cancelStatusComment()">&times;</span>
            </div>
            <div class="form-group">
                <label for="statusCommentInput">–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                <textarea id="statusCommentInput" class="status-comment-input" rows="3"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="confirmStatusComment()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="cancelStatusComment()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div id="welcomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
                <span class="close" onclick="closeWelcomeModal()">&times;</span>
            </div>
            <div class="form-group">
                <p style="margin-bottom: 15px; line-height: 1.6; color: var(--color-text);">
                    –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è <span style="color: #4FC3F7; font-size: 1.15em; font-weight: 600;">DeadLinePro</span>! 
                    –ú—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –¥–ª—è –≤–∞—Å –∫—Ä–∞—Ç–∫–∏–π —Ç—É—Ä –ø–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç –±—ã—Å—Ç—Ä–æ –æ—Å–≤–æ–∏—Ç—å—Å—è.
                </p>
                <p style="margin-bottom: 20px; line-height: 1.6; color: var(--color-text-secondary);">
                    –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–π—Ç–∏ –∫—Ä–∞—Ç–∫–∏–π —Ç—É—Ä –ø–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É?
                </p>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeWelcomeModal()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
                <button class="btn btn-primary" onclick="startTourFromWelcome()">–ù–∞—á–∞—Ç—å —Ç—É—Ä</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –≤ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ -->
    <div id="textInputModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="textInputModalTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
                <span class="close" onclick="closeTextInputModal()">&times;</span>
            </div>
            <div class="form-group">
                <label id="textInputModalLabel" for="textInputModalTextarea">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç:</label>
                <textarea id="textInputModalTextarea" class="text-input-modal-textarea" rows="5" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveTextInputModal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="closeTextInputModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div id="pdfExportModal" class="modal">
        <div class="modal-content" style="max-width: 1900px; width: 98%; max-height: 95vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>–≠–∫—Å–ø–æ—Ä—Ç</h2>
                <span class="close" onclick="closePDFExportModal()">&times;</span>
            </div>
            
            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px; flex-wrap: wrap;">
                <label for="exportFormatSelect" style="font-weight: 600; font-size: 13px;">–§–æ—Ä–º–∞—Ç –≤—ã–≥—Ä—É–∑–∫–∏:</label>
                <select id="exportFormatSelect" onchange="handleExportFormatChange()" style="min-width: 160px; padding: 6px; font-size: 13px;">
                    <option value="pdf" selected>PDF</option>
                    <option value="excel">Excel</option>
                </select>
            </div>

            <div id="pdfExportSection">
                <div id="pdfExportSettingsGrid" style="display: grid; grid-template-columns: 1fr 3fr; gap: 20px; margin-bottom: 20px;">
                    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                    <div style="min-width: 300px;">
                        <p style="margin-bottom: 12px; font-size: 13px;">
                            –ë—É–¥–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω PDF-—Ñ–∞–π–ª —Å –¥–∏–∞–≥—Ä–∞–º–º–æ–π –ì–∞–Ω—Ç–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–∞—Å—à—Ç–∞–±–µ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π –∑–∞–¥–∞—á —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏.
                        </p>
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label for="pdfScaleMode" style="font-size: 13px;">–ú–∞—Å—à—Ç–∞–± –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ì–∞–Ω—Ç–∞:</label>
                            <select id="pdfScaleMode" onchange="updatePDFPreview()" style="width: 100%; padding: 6px; font-size: 13px;">
                                <option value="day">–î–Ω–∏</option>
                                <option value="week">–ù–µ–¥–µ–ª–∏</option>
                                <option value="month">–ú–µ—Å—è—Ü—ã</option>
                            </select>
                        </div>
                        <div class="form-group pdf-content-toggle" style="margin-bottom: 16px;">
                            <label style="font-size: 13px;">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ PDF:</label>
                            <div class="pdf-toggle-options">
                                <label class="pdf-toggle-option">
                                    <input type="radio" name="pdfContentMode" value="full" checked onchange="updatePDFPreview()">
                                    <span>–° –¥–∏–∞–≥—Ä–∞–º–º–æ–π</span>
                                </label>
                                <label class="pdf-toggle-option">
                                    <input type="radio" name="pdfContentMode" value="table" onchange="updatePDFPreview()">
                                    <span>–¢–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü–∞</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- –ú–∞—Å—Å–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—Å—Ç—É–ø–æ–≤ -->
                        <div class="form-group" style="margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px;">
                            <label style="font-weight: 600; margin-bottom: 8px; display: block; font-size: 13px;">–û—Ç—Å—Ç—É–ø—ã –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü (–º–º):</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <div>
                                    <label for="pdfMarginTop" style="display: block; margin-bottom: 4px; font-size: 12px;">–í–µ—Ä—Ö:</label>
                                    <input type="number" id="pdfMarginTop" min="0" max="50" value="10" step="1" 
                                           style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
                                           oninput="applyMarginsToAll()">
                                </div>
                                <div>
                                    <label for="pdfMarginBottom" style="display: block; margin-bottom: 4px; font-size: 12px;">–ù–∏–∑:</label>
                                    <input type="number" id="pdfMarginBottom" min="0" max="50" value="20" step="1" 
                                           style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
                                           oninput="applyMarginsToAll()">
                                </div>
                                <div>
                                    <label for="pdfMarginLeft" style="display: block; margin-bottom: 4px; font-size: 12px;">–°–ª–µ–≤–∞:</label>
                                    <input type="number" id="pdfMarginLeft" min="0" max="50" value="5" step="1" 
                                           style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
                                           oninput="applyMarginsToAll()">
                                </div>
                                <div>
                                    <label for="pdfMarginRight" style="display: block; margin-bottom: 4px; font-size: 12px;">–°–ø—Ä–∞–≤–∞:</label>
                                    <input type="number" id="pdfMarginRight" min="0" max="50" value="5" step="1" 
                                           style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
                                           oninput="applyMarginsToAll()">
                                </div>
                            </div>
                            <button onclick="applyMarginsToAll()" style="width: 100%; margin-top: 8px; padding: 6px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
                            </button>
                        </div>
                        
                        <!-- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ –º–∞–∫–µ—Ç–∞ -->
                        <div class="form-group" style="margin-bottom: 16px; padding: 12px; background: #e3f2fd; border-radius: 8px;">
                            <label style="font-weight: 600; margin-bottom: 8px; display: block; font-size: 13px;">–ú–∞–∫–µ—Ç –æ—Ç—Å—Ç—É–ø–æ–≤:</label>
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                <button onclick="savePDFLayout()" style="width: 100%; padding: 6px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞–∫–µ—Ç
                                </button>
                                <button onclick="loadPDFLayout()" style="width: 100%; padding: 6px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∞–∫–µ—Ç
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <label style="font-weight: 600; font-size: 14px;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü:</label>
                            <span id="pdfPagesCount" style="color: #666; font-size: 12px;"></span>
                        </div>
                        <div id="pdfPreviewContainer" style="background: #f9f9f9; border: 2px solid #ddd; border-radius: 8px; padding: 16px; min-height: 600px; max-height: calc(95vh - 220px); overflow-y: auto; overflow-x: auto;">
                            <div style="text-align: center; color: #999; padding: 40px;">
                                –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="excelExportSection" style="display: none; margin-bottom: 20px;">
                <p style="margin-bottom: 12px; font-size: 13px;">
                    –ë—É–¥–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω —Ñ–∞–π–ª Excel —Å –¥–≤—É–º—è –ª–∏—Å—Ç–∞–º–∏: –Ω–∞ –ø–µ—Ä–≤–æ–º ‚Äî –¥–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–∞—Å—à—Ç–∞–±–µ, –Ω–∞ –≤—Ç–æ—Ä–æ–º ‚Äî —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á.
                </p>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="exportExcelScale" style="display: block; margin-bottom: 4px; font-size: 13px;">–ú–∞—Å—à—Ç–∞–± –ì–∞–Ω—Ç–∞:</label>
                    <select id="exportExcelScale" style="width: 100%; max-width: 240px; padding: 6px; font-size: 13px;">
                        <option value="day">–î–Ω–∏</option>
                        <option value="week">–ù–µ–¥–µ–ª–∏</option>
                        <option value="month">–ú–µ—Å—è—Ü—ã</option>
                        <option value="year">–ì–æ–¥—ã</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 16px;">
                <button class="btn btn-primary" onclick="confirmExportByFormat()" style="flex: 1;">–≠–∫—Å–ø–æ—Ä—Ç</button>
                <button class="btn btn-secondary" onclick="closePDFExportModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div id="excelExportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</h2>
                <span class="close" onclick="closeExcelExportModal()">&times;</span>
            </div>
            <p style="margin-bottom: 12px;">
                –ë—É–¥–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω —Ñ–∞–π–ª Excel —Å –¥–≤—É–º—è –ª–∏—Å—Ç–∞–º–∏:
                –Ω–∞ –ø–µ—Ä–≤–æ–º ‚Äî –¥–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–∞—Å—à—Ç–∞–±–µ, –Ω–∞ –≤—Ç–æ—Ä–æ–º ‚Äî —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á.
            </p>
            <div class="form-group" style="margin-bottom: 16px;">
                <label for="excelScaleMode">–ú–∞—Å—à—Ç–∞–± –ì–∞–Ω—Ç–∞:</label>
                <select id="excelScaleMode">
                    <option value="day">–î–Ω–∏</option>
                    <option value="week">–ù–µ–¥–µ–ª–∏</option>
                    <option value="month">–ú–µ—Å—è—Ü—ã</option>
                    <option value="year">–ì–æ–¥—ã</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-primary" onclick="confirmExcelExport()">–≠–∫—Å–ø–æ—Ä—Ç</button>
                <button class="btn btn-secondary" onclick="closeExcelExportModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?</h2>
                <span class="close" onclick="cancelDeleteTask()">&times;</span>
            </div>
            <p>–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–∞–¥–∞—á—É –∏–∑ –≥—Ä–∞—Ñ–∏–∫–∞?</p>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                <button class="btn btn-primary" onclick="confirmDeleteTask()">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="cancelDeleteTask()">–ù–µ—Ç</button>
            </div>
        </div>
    </div>

    <div id="stageDeleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–£–¥–∞–ª–∏—Ç—å —ç—Ç–∞–ø?</h2>
                <span class="close" onclick="cancelDeleteStage()">&times;</span>
            </div>
            <p id="stageDeleteText">–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç—Ç–∞–ø —Å–æ –≤—Å–µ–º–∏ –µ–≥–æ –∑–∞–¥–∞—á–∞–º–∏?</p>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                <button class="btn btn-primary" onclick="confirmDeleteStage()">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="cancelDeleteStage()">–ù–µ—Ç</button>
            </div>
        </div>
    </div>

    <div id="resetPlanConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–°–±—Ä–æ—Å–∏—Ç—å –ø–ª–∞–Ω?</h2>
                <span class="close" onclick="cancelResetPlan()">&times;</span>
            </div>
            <p>–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å –º–Ω–æ–≥–æ–µ, —á—Ç–æ –≤—ã —Å–¥–µ–ª–∞–ª–∏, –≤—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                <button class="btn btn-primary" onclick="confirmResetPlan()">–î–∞</button>
                <button class="btn btn-secondary" onclick="cancelResetPlan()">–ù–µ—Ç</button>
            </div>
        </div>
    </div>


    <div id="scaleWarningModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–í–Ω–∏–º–∞–Ω–∏–µ!</h2>
                <span class="close" onclick="cancelScaleWarning()">&times;</span>
            </div>
            <p id="scaleWarningText">–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ–π –Ω–µ–¥–µ–ª–µ. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å?</p>
            <p style="color: #ff9800; font-weight: 500; margin-top: 10px;">–°—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω—ë–Ω –∫–æ –≤—Å–µ–º –¥–Ω—è–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞.</p>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                <button class="btn btn-primary" onclick="confirmScaleWarning()">–î–∞, –ø—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="cancelScaleWarning()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div id="undoConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–û—Ç–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ?</h2>
                <span class="close" onclick="cancelUndo()">&times;</span>
            </div>
            <p>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–∏—Ç –≤–∞—à–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è.</p>
            <p style="color: #ff9800; font-weight: 500; margin-top: 10px;">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–∞—Ç–∏—Ç—å?</p>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                <button class="btn btn-primary" onclick="confirmUndo()">–î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="cancelUndo()">–ù–µ—Ç</button>
            </div>
        </div>
    </div>

    <div id="stageSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç—Ç–∞–ø–æ–≤</h2>
                <span class="close" onclick="closeStageSettingsModal()">&times;</span>
            </div>
            <p style="margin-bottom: 12px;">
                –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —ç—Ç–∞–ø—ã, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫. –î–≤–∞–∂–¥—ã –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å.
            </p>
            <div id="stageSettingsList" class="stage-settings-list"></div>
            <div class="stage-settings-footer">
                <button class="btn btn-secondary" onclick="addNewStage()">–î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ø</button>
                <button class="btn btn-secondary" onclick="closeStageSettingsModal()">–ì–æ—Ç–æ–≤–æ</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —ç—Ç–∞–ø–∞ -->
    <div id="renameStageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —ç—Ç–∞–ø</h2>
                <span class="close" onclick="closeRenameStageModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="renameStageInput">–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞:</label>
                <input type="text" id="renameStageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                <button class="btn btn-primary" onclick="confirmRenameStage()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="closeRenameStageModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ –±–∞–∑–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞ -->
    <div id="baselineConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω?</h2>
                <span class="close" onclick="cancelBaselineOverwrite()">&times;</span>
            </div>
            <p>–î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –µ–≥–æ —Ç–µ–∫—É—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∑–∞–¥–∞—á?</p>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                <button class="btn btn-primary" onclick="confirmBaselineOverwrite()">–î–∞, –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å</button>
                <button class="btn btn-secondary" onclick="cancelBaselineOverwrite()">–ù–µ—Ç</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞—Ç -->
    <div id="dateValidationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–∞—Ç</h2>
                <span class="close" onclick="closeDateValidationModal()">&times;</span>
            </div>
            <p id="dateValidationMessage">
                –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞.
            </p>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                <button class="btn btn-primary" onclick="closeDateValidationModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
        </div>
    </div>

    <!-- –ù–µ–±–æ–ª—å—à–æ–π toast –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –±–∞–∑–æ–≤–æ–º—É –ø–ª–∞–Ω—É -->
    <div id="baselineToast" class="baseline-toast">    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
    <div id="profileModal" class="profile-modal">
        <div class="profile-modal-content">
            <div class="profile-modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h2>
                <button class="profile-modal-close" onclick="closeProfileModal()">&times;</button>
            </div>
            <form id="profileForm">
                <div class="profile-form-group">
                    <label for="profileName">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                    <input type="text" id="profileName" required>
                </div>
                <div class="profile-form-group">
                    <label for="profileLogin">–õ–æ–≥–∏–Ω:</label>
                    <input type="text" id="profileLogin" required>
                </div>
                <div class="profile-form-group">
                    <label for="profilePassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤):</label>
                    <input type="password" id="profilePassword" minlength="6" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å">
                </div>
                <div class="profile-form-group">
                    <label for="profilePasswordConfirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="profilePasswordConfirm" minlength="6" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å">
                </div>
                <div id="profileMessage" class="profile-message"></div>
                <div class="profile-form-actions">
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeProfileModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // –î–∞–Ω–Ω—ã–µ –æ –∑–∞–¥–∞—á–∞—Ö –∏–∑ Excel —Ñ–∞–π–ª–∞
        // ========== –ü–û–õ–£–ß–ï–ù–ò–ï COMPANY –ò–ó URL ==========
        function getCompanyFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('company') || localStorage.getItem('gantt-company') || null;
        }

        let currentCompany = getCompanyFromURL();
        if (currentCompany) {
            localStorage.setItem('gantt-company', currentCompany);
            console.log('üè¢ –¢–µ–∫—É—â–∞—è –∫–æ–º–ø–∞–Ω–∏—è:', currentCompany);
        } else {
            console.warn('‚ö†Ô∏è –ö–æ–º–ø–∞–Ω–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∏–∑ URL –∏–ª–∏ localStorage');
        }

        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ (–º–∞–∫—Å–∏–º—É–º 80 —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ)
        function formatCommentForTooltip(text) {
            if (!text) return '';
            const maxLength = 80;
            const words = text.split(/\s+/);
            const lines = [];
            let currentLine = '';

            for (let i = 0; i < words.length; i++) {
                const word = words[i];
                const testLine = currentLine ? currentLine + ' ' + word : word;

                if (testLine.length <= maxLength) {
                    // –°–ª–æ–≤–æ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
                    currentLine = testLine;
                } else {
                    // –°–ª–æ–≤–æ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è
                    if (currentLine) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É –∏ –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é
                        lines.push(currentLine);
                        currentLine = word;
                    } else {
                        // –°–ª–æ–≤–æ –¥–ª–∏–Ω–Ω–µ–µ maxLength —Å–∏–º–≤–æ–ª–æ–≤ - —Ä–∞–∑–±–∏–≤–∞–µ–º –µ–≥–æ
                        if (word.length > maxLength) {
                            // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–µ –ø—É—Å—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ—ë
                            if (currentLine) {
                                lines.push(currentLine);
                                currentLine = '';
                            }
                            // –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω–æ–µ —Å–ª–æ–≤–æ
                            let remainingWord = word;
                            while (remainingWord.length > maxLength) {
                                lines.push(remainingWord.substring(0, maxLength));
                                remainingWord = remainingWord.substring(maxLength);
                            }
                            currentLine = remainingWord;
                        } else {
                            currentLine = word;
                        }
                    }
                }
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É
            if (currentLine) {
                lines.push(currentLine);
            }

            return lines.join('\n');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–Ω—å—à–µ, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∏–∂–µ)
        function showAuthButtons() {
            const ganttMode = localStorage.getItem('gantt-mode') || 'edit';
            const isViewMode = ganttMode === 'view';
            
            // –í —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (isViewMode) {
                return;
            }
            
            const profileBtn = document.getElementById('profileBtn');
            const companiesBottomBtn = document.getElementById('companiesBottomBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            
            console.log('üîß showAuthButtons called', { 
                profileBtn: !!profileBtn, 
                companiesBottomBtn: !!companiesBottomBtn,
                logoutBtn: !!logoutBtn 
            });
            
            if (profileBtn) {
                profileBtn.style.display = 'flex';
                profileBtn.style.visibility = 'visible';
                profileBtn.style.opacity = '1';
            }
            if (companiesBottomBtn) {
                companiesBottomBtn.style.display = 'flex';
                companiesBottomBtn.style.visibility = 'visible';
                companiesBottomBtn.style.opacity = '1';
                console.log('‚úÖ –ù–∏–∂–Ω—è—è –∫–Ω–æ–ø–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π –ø–æ–∫–∞–∑–∞–Ω–∞ —á–µ—Ä–µ–∑ showAuthButtons');
            }
            if (logoutBtn) {
                logoutBtn.style.display = 'flex';
                logoutBtn.style.visibility = 'visible';
                logoutBtn.style.opacity = '1';
            }
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        (function checkAuthButtons() {
            const userStr = localStorage.getItem('gantt-user');
            const ganttMode = localStorage.getItem('gantt-mode') || 'edit';
            const isViewMode = ganttMode === 'view';
            
            // –í —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (isViewMode) {
                return;
            }
            
            if (userStr) {
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–æ–∫
                const tryShowButtons = () => {
                    const companiesBottomBtn = document.getElementById('companiesBottomBtn');
                    const profileBtn = document.getElementById('profileBtn');
                    const logoutBtn = document.getElementById('logoutBtn');
                    
                    if (companiesBottomBtn) {
                        companiesBottomBtn.style.display = 'flex';
                        companiesBottomBtn.style.visibility = 'visible';
                        companiesBottomBtn.style.opacity = '1';
                        console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π –ø–æ–∫–∞–∑–∞–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
                    }
                    if (profileBtn) {
                        profileBtn.style.display = 'flex';
                        profileBtn.style.visibility = 'visible';
                    }
                    if (logoutBtn) {
                        logoutBtn.style.display = 'flex';
                        logoutBtn.style.visibility = 'visible';
                    }
                };
                
                // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        tryShowButtons();
                        setTimeout(tryShowButtons, 100);
                        setTimeout(tryShowButtons, 500);
                    });
                } else {
                    tryShowButtons();
                    setTimeout(tryShowButtons, 100);
                    setTimeout(tryShowButtons, 500);
                }
            }
        })();
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function() {
            if (currentCompany && !isViewMode) {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ä–∞–∑—É —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                if (saveTimeout) {
                    clearTimeout(saveTimeout);
                    saveTimeout = null;
                }
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º navigator.sendBeacon –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                try {
                    // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤, –≤–∫–ª—é—á–∞—è Praktis ID
                    const snapshot = createFullGanttSnapshot();
                    const companyParam = `?company=${currentCompany}`;
                    // sendBeacon —Ç—Ä–µ–±—É–µ—Ç FormData –∏–ª–∏ Blob, –Ω–æ –Ω–∞—à API –æ–∂–∏–¥–∞–µ—Ç JSON
                    // –ü–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π fetch —Å keepalive
                    fetch(`/api/gantt-state${companyParam}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(snapshot),
                        keepalive: true // –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—É –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –¥–∞–∂–µ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    }).catch(e => console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ —É—Ö–æ–¥–µ:', e));
                    console.log('üíæ –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø—Ä–∏ —É—Ö–æ–¥–µ');
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ —É—Ö–æ–¥–µ:', e);
                }
            }
        });

        // ========== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –¢–ï–ú–´ ==========
        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã
        function toggleTheme() {
            const html = document.documentElement;
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏
            if (themeToggleBtn) {
                themeToggleBtn.classList.add('animating');
                
                // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                setTimeout(() => {
                    themeToggleBtn.classList.remove('animating');
                }, 1200);
            }
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('gantt-theme', newTheme);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –Ω–∞–¥–ø–∏—Å–∏ DeadLinePro
            const label = document.getElementById('deadlineProLabel');
            if (label) {
                label.style.color = newTheme === 'dark' ? 'rgba(66, 165, 245, 0.3)' : 'rgba(33, 150, 243, 0.5)';
            }
            
            console.log(`‚úÖ –¢–µ–º–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞ –Ω–∞: ${newTheme}`);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function initTheme() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const savedTheme = localStorage.getItem('gantt-theme');
            const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            const theme = savedTheme || systemTheme;
            
            document.documentElement.setAttribute('data-theme', theme);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –Ω–∞–¥–ø–∏—Å–∏ DeadLinePro
            const label = document.getElementById('deadlineProLabel');
            if (label) {
                label.style.color = theme === 'dark' ? 'rgba(66, 165, 245, 0.3)' : 'rgba(33, 150, 243, 0.5)';
            }
            
            console.log(`‚úÖ –¢–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞: ${theme}`);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–º—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        initTheme();

        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞
        function ensureThemeToggleVisible() {
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            if (themeToggleBtn) {
                themeToggleBtn.style.display = 'flex';
                themeToggleBtn.style.visibility = 'visible';
                themeToggleBtn.style.opacity = '1';
                console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã —Å–¥–µ–ª–∞–Ω–∞ –≤–∏–¥–∏–º–æ–π');
            }
        }

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', ensureThemeToggleVisible);
        } else {
            ensureThemeToggleVisible();
        }

        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤—ã–±—Ä–∞–ª —Ç–µ–º—É –≤—Ä—É—á–Ω—É—é, —Å–ª–µ–¥—É–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–π
            if (!localStorage.getItem('gantt-theme')) {
                const theme = e.matches ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', theme);
            }
        });

        // ========== –†–ï–ñ–ò–ú –î–û–°–¢–£–ü–ê ==========
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –∏–∑ localStorage (edit –∏–ª–∏ view)
        const ganttMode = localStorage.getItem('gantt-mode') || 'edit';
        const isViewMode = ganttMode === 'view';
        
        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function canEdit() {
            if (isViewMode) {
                return false;
            }
            return true;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        if (isViewMode) {
            document.body.classList.add('view-mode');
            document.addEventListener('DOMContentLoaded', function() {
                const style = document.createElement('style');
                style.textContent = `
                    body::after {
                        content: '–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞';
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: rgba(100, 180, 255, 0.9);
                        color: white;
                        padding: 10px 20px;
                        border-radius: 20px;
                        font-size: 14px;
                        font-weight: 600;
                        z-index: 10000;
                        box-shadow: 0 4px 15px rgba(100, 180, 255, 0.3);
                        pointer-events: none;
                    }
                `;
                document.head.appendChild(style);
            });
        }

        let projectData = [
            {
                stage: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–æ–≤–æ–π –≤–µ—Ç–∫–∏ –ü–û",
                control: "",
                task: "–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ü–û ICONA (—Å–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å)",
                days: 14,
                substage: ""
            },
            {
                stage: "–≠—Ç–∞–ø 1. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤–æ–π –º–æ–¥–µ–ª–∏",
                control: "ICONA –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É",
                task: "–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ–±—ä–µ–∫—Ç–∞ (Excel)",
                days: 3,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 1"
            },
            {
                stage: "–≠—Ç–∞–ø 1. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤–æ–π –º–æ–¥–µ–ª–∏",
                control: "ICONA –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É",
                task: "–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º –æ–±—ä–µ–∫—Ç–∞",
                days: 3,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 2"
            },
            {
                stage: "–≠—Ç–∞–ø 1. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤–æ–π –º–æ–¥–µ–ª–∏",
                control: "ICONA –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É",
                task: "–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Å–ø–æ—Ä—Ç–∞ –æ–±—ä–µ–∫—Ç–∞, –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Ä–æ–ª—è–º",
                days: 2,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 3"
            },
            {
                stage: "–≠—Ç–∞–ø 1. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤–æ–π –º–æ–¥–µ–ª–∏",
                control: "ICONA –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É",
                task: "–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ —Å—Ö–µ–º –≤ –ü–û ICONA",
                days: 2,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 4"
            },
            {
                stage: "–≠—Ç–∞–ø 1. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤–æ–π –º–æ–¥–µ–ª–∏",
                control: "ICONA –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É",
                task: "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ª–∏–≤–∫–∏ –ª–æ–∫–∞—Ü–∏–π –Ω–∞ —Å—Ö–µ–º–∞—Ö",
                days: 3,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 5"
            },
            {
                stage: "–≠—Ç–∞–ø 1. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤–æ–π –º–æ–¥–µ–ª–∏",
                control: "ICONA –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É",
                task: "–°–æ–∑–¥–∞–Ω–∏–µ –¢–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–∞–Ω–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ (–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –°–ú–†)",
                days: 11,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 6"
            },
            {
                stage: "–≠—Ç–∞–ø 1. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤–æ–π –º–æ–¥–µ–ª–∏",
                control: "ICONA –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É",
                task: "–†–∞—Å—á–µ—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ –°–¢–ö",
                days: 10,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 7"
            },
            {
                stage: "–≠—Ç–∞–ø 1. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤–æ–π –º–æ–¥–µ–ª–∏",
                control: "ICONA –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É",
                task: "–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –°–¢–ö (–ø—Ä–∏–≤—è–∑–∫–∞ –°–¢–ö –∫ –ª–æ–∫–∞—Ü–∏—è–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ–±—ä–µ–∫—Ç–∞)",
                days: 3,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 8"
            },
            {
                stage: "–≠—Ç–∞–ø 1. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤–æ–π –º–æ–¥–µ–ª–∏",
                control: "ICONA –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É",
                task: "–ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–∑—ã –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤ –∏ –ø—Ä–∏–≤—è–∑–∫–∞ –ø–æ–¥—Ä—è–¥—á–∏–∫–∞ –∫ —Ü–∏—Ñ—Ä–æ–≤–æ–π –º–æ–¥–µ–ª–∏",
                days: 3,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 9"
            },
            {
                stage: "–≠—Ç–∞–ø 1. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤–æ–π –º–æ–¥–µ–ª–∏",
                control: "ICONA –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É",
                task: "–°–æ–∑–¥–∞–Ω–∏–µ –î–∏—Ä–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –∏ –†–∞–±–æ—á–µ–≥–æ –ì–ü–†",
                days: 17,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 10"
            },
            {
                stage: "–≠—Ç–∞–ø 1. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤–æ–π –º–æ–¥–µ–ª–∏",
                control: "ICONA –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É",
                task: "–ü—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–∫—Ç–∞ –≤ –ü–û ICONA –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤ (web, desktop –∏ android –≤–µ—Ä—Å–∏–∏)",
                days: 15,
                substage: "–ö–æ–Ω—Ç—Ä–æ–ª—å"
            },
            {
                stage: "–≠—Ç–∞–ø 2. –û–±—É—á–µ–Ω–∏–µ –ü–ª–∞–Ω–µ—Ä–∫–∞",
                control: "ICONA –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
                task: "–û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–æ —ç—Ç–∞–ø–∞–º",
                days: 2,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 1"
            },
            {
                stage: "–≠—Ç–∞–ø 2. –û–±—É—á–µ–Ω–∏–µ –ü–ª–∞–Ω–µ—Ä–∫–∞",
                control: "ICONA –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
                task: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ ICONA –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —à—Ç—Ä–∞—Ñ–æ–≤)",
                days: 2,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 2"
            },
            {
                stage: "–≠—Ç–∞–ø 2. –û–±—É—á–µ–Ω–∏–µ –ü–ª–∞–Ω–µ—Ä–∫–∞",
                control: "ICONA –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
                task: "–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∫–æ–Ω—Ç—Ä–æ–ª—è",
                days: 1,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 3"
            },
            {
                stage: "–≠—Ç–∞–ø 2. –û–±—É—á–µ–Ω–∏–µ –ü–ª–∞–Ω–µ—Ä–∫–∞",
                control: "ICONA –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
                task: "–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ (android)",
                days: 2,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 4"
            },
            {
                stage: "–≠—Ç–∞–ø 2. –û–±—É—á–µ–Ω–∏–µ –ü–ª–∞–Ω–µ—Ä–∫–∞",
                control: "ICONA –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
                task: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫–ª–∞–¥–∞ (ICONA –∞–≤—Ç–æ–¥–æ–∫–ª–∞–¥)",
                days: 3,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 5"
            },
            {
                stage: "–≠—Ç–∞–ø 2. –û–±—É—á–µ–Ω–∏–µ –ü–ª–∞–Ω–µ—Ä–∫–∞",
                control: "ICONA –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
                task: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø–ª–∞–Ω–µ—Ä–∫–µ –∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –ø–ª–∞–Ω–µ—Ä–∫–∏",
                days: 2,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 6"
            },
            {
                stage: "–≠—Ç–∞–ø 2. –û–±—É—á–µ–Ω–∏–µ –ü–ª–∞–Ω–µ—Ä–∫–∞",
                control: "ICONA –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
                task: "–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–æ—Å–ª–µ –ø–ª–∞–Ω–µ—Ä–∫–∏",
                days: 1,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 7"
            },
            {
                stage: "–≠—Ç–∞–ø 2. –û–±—É—á–µ–Ω–∏–µ –ü–ª–∞–Ω–µ—Ä–∫–∞",
                control: "ICONA –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
                task: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤",
                days: 6,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 8"
            },
            {
                stage: "–≠—Ç–∞–ø 3. –°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
                control: "ICONA –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–º—É –∫–æ–Ω—Ç—Ä–æ–ª—é",
                task: "–û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –ò–°–ö –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞",
                days: 2,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 1"
            },
            {
                stage: "–≠—Ç–∞–ø 3. –°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
                control: "ICONA –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–º—É –∫–æ–Ω—Ç—Ä–æ–ª—é",
                task: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –°–¢–ö",
                days: 20,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 2"
            },
            {
                stage: "–≠—Ç–∞–ø 3. –°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
                control: "ICONA –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–º—É –∫–æ–Ω—Ç—Ä–æ–ª—é",
                task: "–û–±—É—á–µ–Ω–∏–µ –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤ ICONA –í—ã–∑–æ–≤ —Ç–µ—Ö–Ω–∞–¥–∑–æ—Ä–∞ (web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)",
                days: 10,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 3"
            },
            {
                stage: "–≠—Ç–∞–ø 3. –°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
                control: "ICONA –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–º—É –∫–æ–Ω—Ç—Ä–æ–ª—é",
                task: "–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –ò–°–ö –Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ (android)",
                days: 10,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 4"
            },
            {
                stage: "–≠—Ç–∞–ø 3. –°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
                control: "ICONA –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–º—É –∫–æ–Ω—Ç—Ä–æ–ª—é",
                task: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤",
                days: 9,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 5"
            },
            {
                stage: "–≠—Ç–∞–ø 4. –ü—Ä–∏–µ–º–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä",
                control: "ICONA –ü—Ä–∏–µ–º–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä",
                task: "–û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏–µ–º–∫–∏ –∫–≤–∞—Ä—Ç–∏—Ä –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞",
                days: 5,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 1"
            },
            {
                stage: "–≠—Ç–∞–ø 4. –ü—Ä–∏–µ–º–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä",
                control: "ICONA –ü—Ä–∏–µ–º–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä",
                task: "–û–±—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–∏–µ–º–∫–∏ –∫–≤–∞—Ä—Ç–∏—Ä",
                days: 4,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 2"
            },
            {
                stage: "–≠—Ç–∞–ø 4. –ü—Ä–∏–µ–º–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä",
                control: "ICONA –ü—Ä–∏–µ–º–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä",
                task: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤",
                days: 3,
                substage: "–ü–æ–¥–∑–∞–¥–∞—á–∞ 3"
            }
        ];

        // –°–∫–µ–ª–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è —Ç–∏–ø–∞ "Praktis ID"
        let projectDataPraktis = [
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–¥–∞—á –¥–ª—è Praktis ID
            // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º, –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –≤—Ä—É—á–Ω—É—é
        ];

        // –†–æ—Å—Å–∏–π—Å–∫–∏–µ –≤—ã—Ö–æ–¥–Ω—ã–µ –∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏
        const holidays = [
            "2025-01-01", "2025-01-02", "2025-01-03", "2025-01-04", "2025-01-05",
            "2025-01-06", "2025-01-07", "2025-01-08", "2025-02-23", "2025-03-08",
            "2025-05-01", "2025-05-09", "2025-06-12", "2025-11-04"
        ];

        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å: –æ–±—ä–µ–∫—Ç, –≥–¥–µ –∫–ª—é—á - –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "YYYY-MM-DD", –∑–Ω–∞—á–µ–Ω–∏–µ - 'workday' –∏–ª–∏ 'holiday'
        // –ù–∞–ø—Ä–∏–º–µ—Ä: { "2025-01-01": "workday", "2025-01-15": "holiday" }
        let customCalendar = {};

        const INITIAL_START_DATE = new Date(2025, 0, 9); // 9 —è–Ω–≤–∞—Ä—è 2025 (–¥–µ—Ñ–æ–ª—Ç –¥–ª—è —Å–±—Ä–æ—Å–∞)
        let startDate = new Date(INITIAL_START_DATE); // —Ç–µ–∫—É—â–µ–µ –Ω–∞—á–∞–ª–æ –ø—Ä–æ–µ–∫—Ç–∞
        let tasks = [];
        // –°—á—ë—Ç—á–∏–∫ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö id –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á (–ø–æ–≤–µ—Ä—Ö –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞)
        let nextTaskId = projectData.length;
        let currentView = 'gantt';
        // –°—Ç–∏–ª—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞—Ä–æ–≤ –≤ –ì–∞–Ω—Ç–µ: 'dots' (–∫–∞–∫ —Å–µ–π—á–∞—Å, —Ç–æ—á–∫–∏/–∫–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç—Ä–µ–∑–∫–∏)
        // –∏–ª–∏ 'segments' (—Å–ª–∏—Ç–Ω—ã–µ –ø–æ–ª–æ—Å—ã –±–µ–∑ –ø–æ–∫—Ä–∞—Å–∫–∏ –ø–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º –¥–Ω—è–º)
        let ganttBarStyle = 'dots';
        // –§–ª–∞–≥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π"
        let showLink = false;
        let showResponsible = false;
        // –û–∂–∏–¥–∞—é—â–∏–π –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        let pendingStatusForComment = null;
        // –¢–µ–∫—É—â–∏–π –º–∞—Å—à—Ç–∞–± –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ì–∞–Ω—Ç–∞ (day/week/month)
        let currentScaleMode = 'day';
        // –û–∂–∏–¥–∞—é—â–∏–π –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –º–∞—Å—à—Ç–∞–±–µ
        let pendingStatusAfterScaleWarning = null;
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π target –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –º–∞—Å—à—Ç–∞–±–µ
        let pendingStatusTargetAfterScaleWarning = null;
        // –û–∂–∏–¥–∞—é—â–∏–π –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã (–∏–Ω–¥–µ–∫—Å –∑–∞–¥–∞—á–∏ –∏ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å)
        let pendingStatusFromTable = null;
        let zoomLevel = 1; // 1 = 100%, –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
        let viewStartDate = null; // –µ—Å–ª–∏ –∑–∞–¥–∞–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –ª–µ–≤—É—é –≥—Ä–∞–Ω–∏—Ü—É –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        let viewEndDate = null;   // –µ—Å–ª–∏ –∑–∞–¥–∞–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –ø—Ä–∞–≤—É—é –≥—Ä–∞–Ω–∏—Ü—É –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        let isExporting = false;  // —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –¥–ª—è PDF
        let saveTimeout = null; // —Ç–∞–π–º–µ—Ä –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        
        // –°–∏—Å—Ç–µ–º–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ—Ç–º–µ–Ω—ã (undo)
        const MAX_UNDO_HISTORY = 10;
        const MAX_REDO_HISTORY = 10;
        let undoHistory = [];
        let redoHistory = [];
        let isUndoing = false; // –§–ª–∞–≥, —á—Ç–æ–±—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
        let isRedoing = false; // –§–ª–∞–≥, —á—Ç–æ–±—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ
        let lastActionWasReset = false; // –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –±—ã–ª–æ —Å–±—Ä–æ—Å–æ–º –ø–ª–∞–Ω–∞




        // –¢–µ–∫—É—â–∞—è —è—á–µ–π–∫–∞, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π –æ—Ç–∫—Ä—ã—Ç–æ –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–∞
        let currentStatusTarget = null; // { taskId, dateStrs }
        // –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, —á—Ç–æ –º–µ–Ω—é –±—ã–ª–æ –æ—Ç–∫—Ä—ã—Ç–æ –∏–∑ select (—á—Ç–æ–±—ã –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –µ–≥–æ —Å—Ä–∞–∑—É)
        let statusMenuOpenedFromSelect = false;
        // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
        let lastClickCoordinates = { x: 0, y: 0 };
        
        // –ú—É–ª—å—Ç–∏–≤—ã–±–æ—Ä —è—á–µ–µ–∫ (Ctrl/Cmd + –∫–ª–∏–∫)
        let selectedCells = new Set(); // Set<string> –≥–¥–µ —Å—Ç—Ä–æ–∫–∞ = "taskId:dateStr"
        let isCtrlPressed = false; // –§–ª–∞–≥ –Ω–∞–∂–∞—Ç–∏—è Ctrl/Cmd

        // –í—ã–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á (–º–æ–∂–Ω–æ –≤—ã–¥–µ–ª—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫)
        let selectedTaskIds = new Set(); // –º–Ω–æ–∂–µ—Å—Ç–≤–æ id –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
        let lastSelectedTaskId = null;   // –ø–æ—Å–ª–µ–¥–Ω—è—è "–±–∞–∑–æ–≤–∞—è" –∑–∞–¥–∞—á–∞ –¥–ª—è Shift-–≤—ã–¥–µ–ª–µ–Ω–∏—è
        let copiedTask = null; // —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
        // –§–ª–∞–≥ –∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –º–æ–¥–∞–ª —É–¥–∞–ª–µ–Ω–∏—è
        let isDeleteConfirmOpen = false;
        // –¢–µ–∫—É—â–∏–π —Ñ–∏–ª—å—Ç—Ä –ø–æ —ç—Ç–∞–ø—É: 'all' | '–≠—Ç–∞–ø 1' | '–≠—Ç–∞–ø 2' | ...
        let currentStageFilter = 'all';
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–≤–µ—Ä–Ω—É—Ç—ã—Ö —ç—Ç–∞–ø–æ–≤ (Set —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ —ç—Ç–∞–ø–æ–≤)
        let collapsedStages = new Set();

        // –î–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —ç—Ç–∞–ø–∞
        let pendingStageToDelete = null;
        let pendingStageToRename = null;

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —ç—Ç–∞–ø–æ–≤ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ –∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        let stageConfig = [];
        let draggedStageIndex = null;

        function initializeStageConfig() {
            const stagesSet = new Set();
            
            // –°–æ–±–∏—Ä–∞–µ–º —ç—Ç–∞–ø—ã –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á (tasks)
            tasks.forEach(task => {
                if (!task.stage) return;
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞ (–ø—Ä–µ—Ñ–∏–∫—Å "–≠—Ç–∞–ø N" –∏–ª–∏ –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —ç—Ç–∞–ø–æ–≤)
                const match = task.stage.match(/^(–≠—Ç–∞–ø\s+\d+)/);
                if (match) {
                    stagesSet.add(match[1]); // –î–æ–±–∞–≤–ª—è–µ–º "–≠—Ç–∞–ø 1", "–≠—Ç–∞–ø 2" –∏ —Ç.–¥.
                } else {
                    // –ï—Å–ª–∏ —ç—Ç–∞–ø –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É "–≠—Ç–∞–ø N", –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –∫–∞–∫ –µ—Å—Ç—å (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —ç—Ç–∞–ø)
                    stagesSet.add(task.stage);
                }
            });
            
            // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º —ç—Ç–∞–ø—ã –∏–∑ projectData (—Å–∫–µ–ª–µ—Ç–∞) –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            projectData.forEach(item => {
                if (!item.stage) return;
                const match = item.stage.match(/^(–≠—Ç–∞–ø\s+\d+)/);
                if (match) {
                    stagesSet.add(match[1]);
                } else {
                    stagesSet.add(item.stage);
                }
            });
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º: —Å–Ω–∞—á–∞–ª–∞ "–≠—Ç–∞–ø N" –ø–æ –Ω–æ–º–µ—Ä—É, –∑–∞—Ç–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
            const stagesArray = Array.from(stagesSet);
            stageConfig = stagesArray.sort((a, b) => {
                const matchA = a.match(/^–≠—Ç–∞–ø\s+(\d+)/);
                const matchB = b.match(/^–≠—Ç–∞–ø\s+(\d+)/);
                if (matchA && matchB) {
                    return parseInt(matchA[1], 10) - parseInt(matchB[1], 10);
                }
                if (matchA) return -1;
                if (matchB) return 1;
                return a.localeCompare(b);
            });
        }

        initializeStageConfig();

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤ –∏–∑ –∑–∞–¥–∞—á
        function getAvailableStages() {
            const stagesSet = new Set();
            
            // –°–æ–±–∏—Ä–∞–µ–º —ç—Ç–∞–ø—ã –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á
            tasks.forEach(task => {
                if (!task.stage) return;
                const match = task.stage.match(/^(–≠—Ç–∞–ø\s+\d+)/);
                if (match) {
                    // –î–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ "–≠—Ç–∞–ø N"
                    stagesSet.add(match[1]);
                } else {
                    // –ï—Å–ª–∏ —ç—Ç–∞–ø –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É "–≠—Ç–∞–ø N", –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –∫–∞–∫ –µ—Å—Ç—å (–ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —ç—Ç–∞–ø–∞)
                    stagesSet.add(task.stage);
                }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ç–∞–ø—ã –∏–∑ stageConfig (–≤–∫–ª—é—á–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —ç—Ç–∞–ø—ã)
            stageConfig.forEach(stage => {
                stagesSet.add(stage);
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —ç—Ç–∞–ø—ã: —Å–Ω–∞—á–∞–ª–∞ "–≠—Ç–∞–ø N" –ø–æ –Ω–æ–º–µ—Ä—É, –∑–∞—Ç–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
            const stagesArray = Array.from(stagesSet);
            return stagesArray.sort((a, b) => {
                const matchA = a.match(/^–≠—Ç–∞–ø\s+(\d+)/);
                const matchB = b.match(/^–≠—Ç–∞–ø\s+(\d+)/);
                if (matchA && matchB) {
                    return parseInt(matchA[1], 10) - parseInt(matchB[1], 10);
                }
                if (matchA) return -1;
                if (matchB) return 1;
                return a.localeCompare(b);
            });
        }

        // –î–∞–Ω–Ω—ã–µ –æ –∫–æ–º–ø–∞–Ω–∏–∏ (–Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –ª–æ–≥–æ—Ç–∏–ø)
        let companyName = '';
        let companyObjectName = '';
        let companyLogoData = null; // data URL (base64) –∏–ª–∏ null

        // –¢–µ–∫—É—â–∏–µ —à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫ –≤ –ª–µ–≤–æ–π —á–∞—Å—Ç–∏ –ì–∞–Ω—Ç–∞ (–≤ –ø–∏–∫—Å–µ–ª—è—Ö)
        let ganttColumnWidths = {
            label: 260,
            start: 120,
            end: 120,
            days: 90,
            responsible: 160
        };
        // –ù–∞–±–æ—Ä –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ)
        const stickyColumns = new Set();

        function formatDateForInput(date) {
            // –ï—Å–ª–∏ date —É–∂–µ —Å—Ç—Ä–æ–∫–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ—ë –∫–∞–∫ –µ—Å—Ç—å
            if (typeof date === 'string') {
                return date;
            }
            // –ï—Å–ª–∏ date –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º Date, –ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å
            if (!(date instanceof Date)) {
                // –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ—ë
                if (typeof date === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(date)) {
                    return date;
                }
                // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å Date –∏–∑ —Å—Ç—Ä–æ–∫–∏
                const parsedDate = new Date(date);
                if (isNaN(parsedDate.getTime())) {
                    console.error('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –¥–∞—Ç—É:', date);
                    return '';
                }
                date = parsedDate;
            }
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ YYYY-MM-DD
        function parseDateKey(dateStr) {
            if (!dateStr) return null;
            if (dateStr instanceof Date) return dateStr;
            // –§–æ—Ä–º–∞—Ç: YYYY-MM-DD
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            }
            // –ü—Ä–æ–±—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥
            const parsed = new Date(dateStr);
            return isNaN(parsed.getTime()) ? null : parsed;
        }

        function formatDateKey(date) {
            return formatDateForInput(date);
        }

        // --- –ë–ª–æ–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–ø–∞–Ω–∏–∏ ---

        function applyCompanyInfoToUI() {
            const logoEl = document.getElementById('companyLogo');
            const nameDisplay = document.getElementById('companyNameDisplay');

            if (logoEl) {
                if (companyLogoData) {
                    logoEl.src = companyLogoData;
                } else {
                    logoEl.src = 'favicon.png';
                }
            }

            if (nameDisplay) {
                if (companyName && companyName.trim().length > 0) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerText –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –ª—é–±–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–µ
                    nameDisplay.innerText = companyName;
                    nameDisplay.classList.add('has-value');
                } else {
                    const placeholder = nameDisplay.getAttribute('data-placeholder') || '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏';
                    nameDisplay.innerText = placeholder;
                    nameDisplay.classList.remove('has-value');
                }
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–æ–º–ø–∞–Ω–∏–∏
            const objectNameDisplay = document.getElementById('companyObjectNameDisplay');
            if (objectNameDisplay) {
                if (companyObjectName && companyObjectName.trim().length > 0) {
                    objectNameDisplay.innerText = companyObjectName;
                    objectNameDisplay.style.display = 'block';
                } else {
                    objectNameDisplay.style.display = 'none';
                }
            }
        }

        function saveCompanyInfoLocally() {
            try {
                const payload = {
                    name: companyName,
                    objectName: companyObjectName,
                    logoData: companyLogoData,
                    customCalendar: customCalendar
                };
                localStorage.setItem('iconaCompanyInfo', JSON.stringify(payload));
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏ –≤ localStorage:', e);
            }
        }

        async function saveCompanyInfoToServer() {
            try {
                const payload = {
                    name: companyName,
                    logoData: companyLogoData,
                    customCalendar: customCalendar
                };
                const companyParam = currentCompany ? `?company=${currentCompany}` : '';
                await fetch(`/api/company-info${companyParam}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...payload, company: currentCompany })
                });
            } catch (e) {
                // –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ/–±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:', e);
            }
        }

        function handleCompanyNameInput(event) {
            if (!canEdit()) {
                event.preventDefault();
                return; // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            }
            const raw = (event.target.innerText || event.target.textContent) || '';
            const placeholder = event.target.getAttribute('data-placeholder') || '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏';

            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç—ë—Ä –≤—Å—ë ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–µ—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
            companyName = raw.trim() === '' || raw === placeholder ? '' : raw.trim();

            // –í–æ –≤—Ä–µ–º—è –≤–≤–æ–¥–∞ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º —Ç–µ–∫—Å—Ç –≤ DOM –∏ –∫–∞—Ä–µ—Ç–∫—É, —Ç–æ–ª—å–∫–æ –º–µ–Ω—è–µ–º –∫–ª–∞—Å—Å
            if (companyName) {
                event.target.classList.add('has-value');
            } else {
                event.target.classList.remove('has-value');
            }

            saveCompanyInfoLocally();
            saveCompanyInfoToServer();
        }

        function handleCompanyNameFocus(event) {
            const el = event.target;
            const placeholder = el.getAttribute('data-placeholder') || '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏';
            if (!el.classList.contains('has-value') && el.textContent === placeholder) {
                el.textContent = '';
            }
        }

        function handleCompanyLogoChange(event) {
            if (!canEdit()) {
                event.target.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞
                return; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ª–æ–≥–æ—Ç–∏–ø–∞ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            }
            const file = event.target.files && event.target.files[0];
            if (!file) return;

            if (file.type !== 'image/png') {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –ª–æ–≥–æ—Ç–∏–ø –≤ —Ñ–æ—Ä–º–∞—Ç–µ PNG.');
                return;
            }

            const reader = new FileReader();
            reader.onload = () => {
                companyLogoData = reader.result;
                applyCompanyInfoToUI();
                saveCompanyInfoLocally();
                saveCompanyInfoToServer();
            };
            reader.readAsDataURL(file);
        }

        let companyChartType = 'icona'; // –¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏
        let chartTypeContainerName = 'ICONA'; // –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
        let skeletonColumns = null; // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—Ç–æ–ª–±—Ü–æ–≤ –∏–∑ —Å–∫–µ–ª–µ—Ç–∞
        let loadedSkeletonData = null; // –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Å–∫–µ–ª–µ—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ç–∏–ø–æ–≤

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ —Ç–∏–ø—É –≥—Ä–∞—Ñ–∏–∫–∞
        async function loadChartTypeContainerName(chartType) {
            try {
                const response = await fetch('/api/chart-types');
                if (response.ok) {
                    const chartTypes = await response.json();
                    const chartTypeData = chartTypes.find(ct => ct.id === chartType);
                    if (chartTypeData && chartTypeData.containerName) {
                        chartTypeContainerName = chartTypeData.containerName;
                        return chartTypeData.containerName;
                    }
                }
            } catch (error) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∏–ø—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤:', error);
            }
            
            // –§–æ–ª–ª–±–µ–∫ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            if (chartType === 'praktis') {
                chartTypeContainerName = 'Praktis ID';
            } else {
                chartTypeContainerName = 'ICONA';
            }
            return chartTypeContainerName;
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞
        function updatePageTitle() {
            const titleText = `–ì—Ä–∞—Ñ–∏–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏ –æ–±—É—á–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã ${chartTypeContainerName}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ header (–∏—â–µ–º span –≤–Ω—É—Ç—Ä–∏ h1, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –∏–º–µ–µ—Ç –∫–ª–∞—Å—Å–∞ header-icon)
            const headerTitle = document.querySelector('h1 span:not(.header-icon)');
            if (headerTitle) {
                headerTitle.textContent = titleText;
            } else {
                // –§–æ–ª–ª–±–µ–∫: –∏—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π span –≤ h1
                const h1 = document.querySelector('h1');
                if (h1) {
                    const spans = h1.querySelectorAll('span');
                    if (spans.length > 0) {
                        spans[spans.length - 1].textContent = titleText;
                    }
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º title —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.title = titleText;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º og:title
            const ogTitle = document.querySelector('meta[property="og:title"]');
            if (ogTitle) {
                ogTitle.setAttribute('content', titleText);
            }
        }

        async function loadCompanyInfo() {
            // 1. –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            try {
                const companyParam = currentCompany ? `?company=${currentCompany}` : '';
                const res = await fetch(`/api/company-info${companyParam}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data && (data.name || data.logoData || data.chartType)) {
                        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç—Å—è
                        companyName = data.name ? String(data.name) : '';
                        companyObjectName = data.objectName ? String(data.objectName) : '';
                        companyLogoData = data.logoData || null;
                        companyChartType = data.chartType || 'icona';
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                        if (data.customCalendar && typeof data.customCalendar === 'object') {
                            customCalendar = data.customCalendar;
                        } else {
                            customCalendar = {};
                        }
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                        await loadChartTypeContainerName(companyChartType);
                        updatePageTitle();
                        
                        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è Praktis ID - –º–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –≥—Ä–∞—Ñ–∏–∫–æ–º
                        applyCompanyInfoToUI();
                        return;
                    }
                }
            } catch (e) {
                // –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –∏–¥—ë–º –≤ localStorage
            }

            // 2. –§–æ–ª–ª–±–µ–∫ –Ω–∞ localStorage
            try {
                const raw = localStorage.getItem('iconaCompanyInfo');
                if (raw) {
                    const stored = JSON.parse(raw);
                    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç—Å—è
                    companyName = stored.name ? String(stored.name) : '';
                    companyObjectName = stored.objectName ? String(stored.objectName) : '';
                    companyLogoData = stored.logoData || null;
                    companyChartType = stored.chartType || 'icona';
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                    if (stored.customCalendar && typeof stored.customCalendar === 'object') {
                        customCalendar = stored.customCalendar;
                    } else {
                        customCalendar = {};
                    }
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    await loadChartTypeContainerName(companyChartType);
                    updatePageTitle();
                    
                    // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è Praktis ID - –º–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –≥—Ä–∞—Ñ–∏–∫–æ–º
                }
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ localStorage:', e);
            }
            
            // –ï—Å–ª–∏ —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–µ –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞
            if (!companyChartType || companyChartType === 'icona') {
                await loadChartTypeContainerName(companyChartType || 'icona');
                updatePageTitle();
            }

            applyCompanyInfoToUI();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ" –¥–ª—è Praktis ID
        function showDevelopmentMessage() {
            const container = document.querySelector('.container');
            if (container) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 100px 20px; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 10px 40px rgba(33, 150, 243, 0.2); margin-top: 50px;">
                        <h1 style="color: #666; font-size: 2rem; margin-bottom: 20px; font-weight: 300;">–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</h1>
                        <p style="color: #999; font-size: 1.2rem; line-height: 1.6;">
                            –ì—Ä–∞—Ñ–∏–∫ "–í–Ω–µ–¥—Ä–µ–Ω–∏–µ Praktis ID" –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.<br>
                            –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —ç—Ç–∏–º —Ç–∏–ø–æ–º –≥—Ä–∞—Ñ–∏–∫–∞.
                        </p>
                    </div>
                `;
            }
        }

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –≤–∫–ª–∞–¥–∫–∏ —ç—Ç–∞–ø–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        function renderStageTabs() {
            const container = document.querySelector('.stage-tabs-buttons');
            if (!container) return;

            container.innerHTML = '';

            const allBtn = document.createElement('button');
            allBtn.className = 'stage-tab-btn';
            allBtn.textContent = '–í—Å–µ —ç—Ç–∞–ø—ã';
            if (currentStageFilter === 'all') {
                allBtn.classList.add('active');
            }
            allBtn.addEventListener('click', () => {
                currentStageFilter = 'all';
                renderStageTabs();
                renderGantt();
                renderTable();
                applySelectionHighlight();
            });
            container.appendChild(allBtn);

            stageConfig.forEach(shortName => {
                const btn = document.createElement('button');
                btn.className = 'stage-tab-btn';
                btn.textContent = shortName;
                if (currentStageFilter === shortName) {
                    btn.classList.add('active');
                }
                btn.addEventListener('click', () => {
                    // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —ç—Ç–∞–ø, –µ—Å–ª–∏ –æ–Ω –±—ã–ª —Å–≤–µ—Ä–Ω—É—Ç
                    expandStageByShortName(shortName);
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —ç—Ç–∞–ø—É
                    currentStageFilter = shortName;
                    renderStageTabs();
                    
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –∏ —Ç–∞–±–ª–∏—Ü—É
                    renderGantt();
                    renderTable();
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –º–µ—Ç–æ–∫ —ç—Ç–∞–ø–æ–≤ –ø–æ—Å–ª–µ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
                    setTimeout(() => {
                        recalculateStageLabelsPositions();
                    }, 350);
                    
                    applySelectionHighlight();
                });
                container.appendChild(btn);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç—Ç–∞–ø–∞ –ø–æ –∫–æ—Ä–æ—Ç–∫–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é
        function expandStageByShortName(shortName) {
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø–æ–ª–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —ç—Ç–∞–ø–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∫–æ—Ä–æ—Ç–∫–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é
            const fullStageNames = new Set();
            tasks.forEach(task => {
                if (!task.stage) return;
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞ –∏–∑ –ø–æ–ª–Ω–æ–≥–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–≠—Ç–∞–ø 2" –∏–∑ "–≠—Ç–∞–ø 2. –û–±—É—á–µ–Ω–∏–µ –ü–ª–∞–Ω–µ—Ä–∫–∞")
                const match = task.stage.match(/^(–≠—Ç–∞–ø\s+\d+)/);
                if (match) {
                    const taskShortName = match[1];
                    // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–Ω–æ–µ –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å –∏—Å–∫–æ–º—ã–º
                    if (taskShortName === shortName) {
                        fullStageNames.add(task.stage);
                    }
                } else {
                    // –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —ç—Ç–∞–ø–æ–≤ (–±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∞ "–≠—Ç–∞–ø N") —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é
                    if (task.stage === shortName) {
                        fullStageNames.add(task.stage);
                    }
                }
            });
            
            // –£–¥–∞–ª—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —ç—Ç–∞–ø—ã –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–≤–µ—Ä–Ω—É—Ç—ã—Ö
            let wasExpanded = false;
            fullStageNames.forEach(fullStageName => {
                if (collapsedStages.has(fullStageName)) {
                    collapsedStages.delete(fullStageName);
                    wasExpanded = true;
                    console.log(`‚úÖ –†–∞–∑–≤–µ—Ä–Ω—É—Ç —ç—Ç–∞–ø: ${fullStageName}`);
                }
            });
            
            if (!wasExpanded && fullStageNames.size > 0) {
                console.log(`‚ÑπÔ∏è –≠—Ç–∞–ø "${shortName}" —É–∂–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç (–Ω–∞–π–¥–µ–Ω–æ —ç—Ç–∞–ø–æ–≤: ${fullStageNames.size})`);
            } else if (fullStageNames.size === 0) {
                console.log(`‚ö†Ô∏è –≠—Ç–∞–ø—ã —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º "${shortName}" –Ω–µ –Ω–∞–π–¥–µ–Ω—ã`);
            }
            
            return wasExpanded;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –∑–∞–¥–∞—á–∞ –∫ —Ç–µ–∫—É—â–µ–º—É –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —ç—Ç–∞–ø—É
        function isTaskInCurrentStage(task) {
            if (currentStageFilter === 'all') return true;
            if (!task.stage) return false;
            return task.stage.startsWith(currentStageFilter);
        }

        function isTaskSelected(taskId) {
            return selectedTaskIds.has(taskId);
        }

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∫ —Ç–µ–∫—É—â–µ–º—É –Ω–∞–±–æ—Ä—É –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
        function applySelectionHighlight() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π
            const savedSelectedTaskIds = new Set(selectedTaskIds);
            
            document.querySelectorAll('.gantt-row').forEach(row => {
                if (!row.dataset.taskId) return;
                const idStr = row.dataset.taskId;
                const taskId = Number(idStr);
                const isSelected = savedSelectedTaskIds.has(taskId);
                row.classList.toggle('selected', isSelected);
            });

            const tbody = document.getElementById('tasksTableBody');
            if (tbody) {
                tbody.querySelectorAll('tr').forEach(tr => {
                    if (!tr.dataset.taskId) return;
                    const idStr = tr.dataset.taskId;
                    const taskId = Number(idStr);
                    const isSelected = savedSelectedTaskIds.has(taskId);
                    tr.classList.toggle('selected', isSelected);
                });
            }
        }

        function clearSelection() {
            selectedTaskIds.clear();
            lastSelectedTaskId = null;
            applySelectionHighlight();
        }

        function getPrimarySelectedTaskId() {
            if (lastSelectedTaskId !== null && selectedTaskIds.has(lastSelectedTaskId)) {
                return lastSelectedTaskId;
            }
            const first = selectedTaskIds.values().next();
            return first.done ? null : first.value;
        }

        // –í—ã–±–æ—Ä –∑–∞–¥–∞—á –ø–æ –∫–ª–∏–∫—É (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ Shift –¥–ª—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞)
        function selectTask(taskId, options = {}) {
            const { range = false, preserveSelection = false } = options;

            if (range && lastSelectedTaskId !== null) {
                // –î–∏–∞–ø–∞–∑–æ–Ω –º–µ–∂–¥—É lastSelectedTaskId –∏ —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–µ–π
                const startIndex = tasks.findIndex(t => t.id === lastSelectedTaskId);
                const endIndex = tasks.findIndex(t => t.id === taskId);
                if (startIndex === -1 || endIndex === -1) {
                    // –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–±—ã—á–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                    selectedTaskIds.clear();
                    selectedTaskIds.add(taskId);
                    lastSelectedTaskId = taskId;
                    applySelectionHighlight();
                    return;
                }
                // –ü—Ä–∏ Shift+–∫–ª–∏–∫–µ –¥–æ–±–∞–≤–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –≤—ã–¥–µ–ª–µ–Ω–∏—é
                const [from, to] = startIndex < endIndex ? [startIndex, endIndex] : [endIndex, startIndex];
                for (let i = from; i <= to; i++) {
                    selectedTaskIds.add(tasks[i].id);
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º lastSelectedTaskId –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–¥–∞—á—É –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
                lastSelectedTaskId = taskId;
            } else if (preserveSelection) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ - –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º lastSelectedTaskId, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ —É–∂–µ –≤—ã–¥–µ–ª–µ–Ω–∞
                if (selectedTaskIds.has(taskId)) {
                    lastSelectedTaskId = taskId;
                } else {
                    // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–µ –≤—ã–¥–µ–ª–µ–Ω–∞, –Ω–æ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ - –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë
                    selectedTaskIds.add(taskId);
                    lastSelectedTaskId = taskId;
                }
            } else {
                // –û–¥–∏–Ω–æ—á–Ω—ã–π –∫–ª–∏–∫ ‚Äî –≤—ã–¥–µ–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
                // –ù–û: –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ —É–∂–µ –≤—ã–¥–µ–ª–µ–Ω–∞ –∏ –µ—Å—Ç—å –¥—Ä—É–≥–∏–µ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                if (selectedTaskIds.size > 1 && selectedTaskIds.has(taskId)) {
                    // –ó–∞–¥–∞—á–∞ —É–∂–µ –≤—ã–¥–µ–ª–µ–Ω–∞ —Å—Ä–µ–¥–∏ –¥—Ä—É–≥–∏—Ö - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º lastSelectedTaskId
                    lastSelectedTaskId = taskId;
                } else {
                    // –û–±—ã—á–Ω—ã–π –∫–ª–∏–∫ - –≤—ã–¥–µ–ª—è–µ–º —Ç–æ–ª—å–∫–æ —ç—Ç—É –∑–∞–¥–∞—á—É
                    selectedTaskIds.clear();
                    selectedTaskIds.add(taskId);
                    lastSelectedTaskId = taskId;
                }
            }

            applySelectionHighlight();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —Å—Ç—Ä–æ–∫–µ (–ì–∞–Ω—Ç –∏–ª–∏ —Ç–∞–±–ª–∏—Ü–∞)
        function handleTaskRowClick(taskId, event) {
            if (event.shiftKey) {
                selectTask(taskId, { range: true });
            } else {
                selectTask(taskId, { range: false });
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è
        function isWorkday(date) {
            const dayOfWeek = date.getDay();
            const dateStr = formatDateKey(date);
            
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            if (customCalendar[dateStr]) {
                return customCalendar[dateStr] === 'workday';
            }
            
            // –ó–∞—Ç–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞: –Ω–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ (0), –Ω–µ —Å—É–±–±–æ—Ç–∞ (6), –Ω–µ –ø—Ä–∞–∑–¥–Ω–∏–∫
            return dayOfWeek !== 0 && dayOfWeek !== 6 && !holidays.includes(dateStr);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–Ω–µ–π –¥–ª—è –∑–∞–¥–∞—á–∏
        function getTaskDates(startDate, workDays) {
            const dates = [];
            let currentDate = new Date(startDate);
            let daysAdded = 0;

            while (daysAdded < workDays) {
                if (isWorkday(currentDate)) {
                    dates.push(new Date(currentDate));
                    daysAdded++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            return dates;
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏ –º–µ–∂–¥—É –¥–∞—Ç–∞–º–∏ (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)
        function getWorkdaysBetween(start, end) {
            const dates = [];
            const current = new Date(start);
            const last = new Date(end);
            while (current <= last) {
                if (isWorkday(current)) {
                    dates.push(new Date(current));
                }
                current.setDate(current.getDate() + 1);
            }
            return dates;
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏ –º–µ–∂–¥—É –¥–∞—Ç–∞–º–∏, –∏—Å–∫–ª—é—á–∞—è –¥–Ω–∏, –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ –≤—ã—Ö–æ–¥–Ω—ã–µ (weekend-manual)
        function getWorkdaysBetweenExcludingWeekends(start, end, weekendManualDates) {
            const dates = [];
            const current = new Date(start);
            const last = new Date(end);
            while (current <= last) {
                const dateKey = formatDateKey(current);
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –ò –æ–Ω –Ω–µ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –≤—ã—Ö–æ–¥–Ω–æ–π
                if (isWorkday(current) && !weekendManualDates.has(dateKey)) {
                    dates.push(new Date(current));
                }
                current.setDate(current.getDate() + 1);
            }
            return dates;
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏, —Å—á–∏—Ç–∞—è –Ω–∞–∑–∞–¥ –æ—Ç –∫–æ–Ω–µ—á–Ω–æ–π –¥–∞—Ç—ã
        function getWorkdaysBackward(endDate, workDays) {
            const dates = [];
            const current = new Date(endDate);
            while (dates.length < workDays) {
                if (isWorkday(current)) {
                    dates.push(new Date(current));
                }
                current.setDate(current.getDate() - 1);
            }
            return dates.reverse();
        }

        // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏ —Å —É—á–µ—Ç–æ–º –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–Ω–µ–π (weekend-manual)
        // –î–Ω–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "weekend-manual" –Ω–µ —Å—á–∏—Ç–∞—é—Ç—Å—è —Ä–∞–±–æ—á–∏–º–∏, –ø–æ—ç—Ç–æ–º—É
        // –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–¥–≤–∏–≥–∞–µ—Ç—Å—è –≤–ø–µ—Ä–µ–¥ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–Ω–µ–π
        function recalculateTaskDatesWithWeekends(task) {
            if (!task || !task.startDate) return;
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ task.days –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ
            if (!task.days || task.days <= 0) {
                task.days = task.dates && task.dates.length > 0 ? task.dates.length : 1;
                console.log('‚ö†Ô∏è recalculateTaskDatesWithWeekends: task.days –±—ã–ª–æ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:', task.days);
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º dateStatuses, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if (!task.dateStatuses) {
                task.dateStatuses = {};
            }

            const dates = [];
            let currentDate = new Date(task.startDate);
            let daysAdded = 0;
            let iterations = 0;
            const maxIterations = task.days * 10; // –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞

            // –°–æ–±–∏—Ä–∞–µ–º —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏, –ø—Ä–æ–ø—É—Å–∫–∞—è –¥–Ω–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "weekend-manual"
            while (daysAdded < task.days && iterations < maxIterations) {
                iterations++;
                const dateKey = formatDateKey(currentDate);
                const isWeekendManual = task.dateStatuses[dateKey] === 'weekend-manual';
                
                // –ï—Å–ª–∏ —ç—Ç–æ —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –ò –æ–Ω –Ω–µ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –≤—ã—Ö–æ–¥–Ω–æ–π - –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
                if (isWorkday(currentDate) && !isWeekendManual) {
                    dates.push(new Date(currentDate));
                    daysAdded++;
                }
                // –ï—Å–ª–∏ –¥–µ–Ω—å –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –≤—ã—Ö–æ–¥–Ω–æ–π, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ–≥–æ (–Ω–µ —Å—á–∏—Ç–∞–µ–º —Ä–∞–±–æ—á–∏–º)
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏—Å–∫–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏
                
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏
            if (dates.length > 0) {
                task.dates = dates;
                task.startDate = dates[0];
                task.endDate = dates[dates.length - 1];
            } else {
                console.warn('‚ö†Ô∏è recalculateTaskDatesWithWeekends: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏ –¥–ª—è –∑–∞–¥–∞—á–∏');
            }
        }

        function parseDateFromInput(value) {
            if (!value) return null;
            const [year, month, day] = value.split('-').map(Number);
            if (!year || !month || !day) return null;
            return new Date(year, month - 1, day);
        }

        // –§–ª–∞–≥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω–æ–≥–æ (baseline) –ø–ª–∞–Ω–∞ –≤ –ì–∞–Ω—Ç–µ
        let showBaseline = false;
        // –ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π baseline-–ø–ª–∞–Ω (–∫–∞–∫ –ø—Ä–∏—à—ë–ª —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ –ø–æ—Å–ª–µ F2)
        let baselineSnapshot = null;
        // –°–Ω–∞–ø—à–æ—Ç, –æ–∂–∏–¥–∞—é—â–∏–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
        let pendingBaselineSnapshot = null;
        // –¢–∞–π–º–µ—Ä –¥–ª—è toast-—Å–æ–æ–±—â–µ–Ω–∏–π
        let baselineToastTimer = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á
        async function initializeTasks() {
            console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é...');
            
            // –í—ã–±–∏—Ä–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∫–µ–ª–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞
            let skeletonData = projectData; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º Icona
            if (companyChartType === 'praktis') {
                skeletonData = projectDataPraktis;
                console.log('üìä –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∫–µ–ª–µ—Ç –¥–ª—è Praktis ID');
            } else if (companyChartType === 'icona') {
                skeletonData = projectData;
                console.log('üìä –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∫–µ–ª–µ—Ç –¥–ª—è Icona');
            } else {
                // –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Å–∫–µ–ª–µ—Ç
                skeletonData = loadedSkeletonData || projectData;
                console.log(`üìä –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∫–µ–ª–µ—Ç –¥–ª—è —Ç–∏–ø–∞ "${companyChartType}"`);
            }
            
            console.log('   skeletonData.length:', skeletonData ? skeletonData.length : 'undefined');
            console.log('   startDate:', startDate);
            
            tasks = [];
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ id (–∏—Å—Ö–æ–¥–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏–¥—É—Ç —Å 0..N-1)
            nextTaskId = skeletonData ? skeletonData.length : 0;
            let currentDate = new Date(startDate);

            if (!skeletonData || !Array.isArray(skeletonData) || skeletonData.length === 0) {
                console.warn('‚ö†Ô∏è –°–∫–µ–ª–µ—Ç –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω! –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞...');
                // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫–µ–ª–µ—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                const skeletonLoaded = await loadSkeletonFromServer();
                if (skeletonLoaded) {
                    // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–∫–µ–ª–µ—Ç–æ–º
                    if (companyChartType === 'praktis') {
                        skeletonData = projectDataPraktis;
                    } else if (companyChartType === 'icona') {
                        skeletonData = projectData;
                    } else {
                        // –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Å–∫–µ–ª–µ—Ç
                        skeletonData = loadedSkeletonData || projectData;
                    }
                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é, –µ—Å–ª–∏ —Å–∫–µ–ª–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω
                    if (skeletonData && skeletonData.length > 0) {
                        console.log('‚úÖ –°–∫–µ–ª–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å', skeletonData.length, '–∑–∞–¥–∞—á–∞–º–∏');
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–∞–ª—å—à–µ, –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è
                    } else {
                        console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –°–∫–µ–ª–µ—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –ø—É—Å—Ç–æ–π –ø–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏!');
                        return;
                    }
                } else {
                    console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫–µ–ª–µ—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞!');
                    return;
                }
            }

            skeletonData.forEach((item, index) => {
                try {
                    const taskDates = getTaskDates(currentDate, item.days);
                    if (!taskDates || taskDates.length === 0) {
                        console.warn(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—ã –¥–ª—è –∑–∞–¥–∞—á–∏ ${index}:`, item);
                        return;
                    }
                    const taskObj = {
                        id: index,
                        ...item,
                        startDate: taskDates[0],
                        endDate: taskDates[taskDates.length - 1],
                        dates: taskDates,
                        status: 'pending',
                        dateStatuses: {}, // –∫–ª—é—á: YYYY-MM-DD, –∑–Ω–∞—á–µ–Ω–∏–µ: 'pending' | 'in-progress' | 'completed' | 'weekend-manual'
                        link: item.link || '–û_–ù' // –í—Å–µ –∑–∞–¥–∞—á–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –û_–ù (–ø–µ—Ä–≤–∞—è —Ç–æ–∂–µ, –Ω–æ select –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)
                    };
                    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º task –∏ name –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                    if (taskObj.task && !taskObj.name) {
                        taskObj.name = taskObj.task;
                    } else if (taskObj.name && !taskObj.task) {
                        taskObj.task = taskObj.name;
                    }
                    tasks.push(taskObj);
                    currentDate = new Date(taskDates[taskDates.length - 1]);
                    currentDate.setDate(currentDate.getDate() + 1);
                } catch (e) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ ${index}:`, e, item);
                }
            });

            console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–¥–∞—á:', tasks.length);
            
            if (tasks.length === 0) {
                console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏!');
                return;
            }

            updateStatistics();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            if (searchResults.length > 0) {
                highlightSearchResults();
            }
	    // –ª–æ–∫ –Ω–∞—á–∞–ª–æ: –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
	    autoSaveGanttState();
	    // —ç–Ω–¥ –∫–æ–Ω–µ—Ü
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫–µ–ª–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadSkeletonFromServer() {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–∞–ø—Ä—è–º—É—é, –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω
                const chartType = companyChartType || 'icona';
                console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–µ–ª–µ—Ç–∞ –¥–ª—è —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞:', chartType);
                console.log('üì• companyChartType:', companyChartType);
                const response = await fetch(`/api/gantt-skeleton?chartType=${encodeURIComponent(chartType)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.skeleton && Array.isArray(data.skeleton) && data.skeleton.length > 0) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—Ç–æ–ª–±—Ü–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                        if (data.columns && Array.isArray(data.columns) && data.columns.length > 0) {
                            skeletonColumns = data.columns;
                            console.log('‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—Ç–æ–ª–±—Ü–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', skeletonColumns.length, '—Å—Ç–æ–ª–±—Ü–æ–≤');
                        } else {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã
                            skeletonColumns = [
                                { id: 'stage', name: '–≠—Ç–∞–ø', field: 'stage', order: 0 },
                                { id: 'control', name: '–í–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è', field: 'control', order: 1 },
                                { id: 'task', name: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ', field: 'task', order: 2 }
                            ];
                        }
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫–µ–ª–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞
                        if (chartType === 'praktis') {
                            projectDataPraktis = data.skeleton;
                            loadedSkeletonData = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º projectDataPraktis
                            console.log('‚úÖ –°–∫–µ–ª–µ—Ç –¥–ª—è Praktis ID –∑–∞–≥—Ä—É–∂–µ–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞, –∑–∞–¥–∞—á:', projectDataPraktis.length);
                        } else if (chartType === 'icona') {
                            // –î–ª—è Icona –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å projectData, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                            loadedSkeletonData = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º projectData
                            console.log('‚úÖ –°–∫–µ–ª–µ—Ç –¥–ª—è Icona –∑–∞–≥—Ä—É–∂–µ–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞, –∑–∞–¥–∞—á:', data.skeleton.length);
                        } else {
                            // –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫–µ–ª–µ—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                            loadedSkeletonData = data.skeleton;
                            console.log(`‚úÖ –°–∫–µ–ª–µ—Ç –¥–ª—è —Ç–∏–ø–∞ "${chartType}" –∑–∞–≥—Ä—É–∂–µ–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞, –∑–∞–¥–∞—á:`, data.skeleton.length);
                        }
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
                        updateTableHeader();
                        return true;
                    } else {
                        console.warn('‚ö†Ô∏è –°–∫–µ–ª–µ—Ç –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è —Ç–∏–ø–∞:', chartType);
                    }
                } else {
                    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–µ–ª–µ—Ç–∞:', response.status, response.statusText);
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫–µ–ª–µ—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞:', e);
            }
            return false;
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∫–µ–ª–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function saveSkeletonToServer(chartType, skeleton) {
            try {
                const response = await fetch('/api/gantt-skeleton', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chartType, skeleton })
                });
                
                if (response.ok) {
                    console.log(`‚úÖ –°–∫–µ–ª–µ—Ç –¥–ª—è ${chartType} —Å–æ—Ö—Ä–∞–Ω—ë–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä`);
                    return true;
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∫–µ–ª–µ—Ç–∞:', response.statusText);
                    return false;
                }
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∫–µ–ª–µ—Ç–∞:', e);
                return false;
            }
            renderGantt();
            renderTable();
            applyCompanyInfoToUI();
            renderStageTabs();
        }

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π baseline-–ø–ª–∞–Ω –∫ —Ç–µ–∫—É—â–µ–º—É –º–∞—Å—Å–∏–≤—É tasks
        function applyBaselineToTasks() {
            if (!baselineSnapshot || !Array.isArray(baselineSnapshot.tasks)) return;

            const byId = new Map();
            baselineSnapshot.tasks.forEach(b => {
                byId.set(b.id, b);
            });

            tasks.forEach(task => {
                const b = byId.get(task.id);
                if (!b || !Array.isArray(b.baselineDates) || !b.baselineDates.length) {
                    task.baselineDates = undefined;
                    task.baselineStartDate = undefined;
                    task.baselineEndDate = undefined;
                    return;
                }

                const parsedDates = b.baselineDates
                    .map(ds => parseDateFromInput(ds))
                    .filter(d => d instanceof Date && !isNaN(d.getTime()))
                    .sort((a, b) => a - b);

                if (!parsedDates.length) {
                    task.baselineDates = undefined;
                    task.baselineStartDate = undefined;
                    task.baselineEndDate = undefined;
                    return;
                }

                task.baselineDates = parsedDates;
                task.baselineStartDate = parsedDates[0];
                task.baselineEndDate = parsedDates[parsedDates.length - 1];
            });
        }

        // –ü–æ—Å—Ç—Ä–æ–∏—Ç—å snapshot –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ –ø–æ —Ç–µ–∫—É—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é –∑–∞–¥–∞—á
        function buildBaselineSnapshot() {
            return {
                generatedAt: new Date().toISOString(),
                tasks: tasks.map(task => ({
                    id: task.id,
                    baselineDates: Array.isArray(task.dates)
                        ? task.dates.map(d => formatDateKey(d))
                        : []
                }))
            };
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
        let lastSavedState = null;
        
        // –°–æ–∑–¥–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        function createChangeDescription(snapshot = null) {
            if (!lastSavedState) {
                return {
                    action: '–ò–∑–º–µ–Ω–∏–ª –≥—Ä–∞—Ñ–∏–∫',
                    details: '–ü–µ—Ä–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞'
                };
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π, –µ—Å–ª–∏ snapshot –ø–µ—Ä–µ–¥–∞–Ω
            if (snapshot && !snapshot.detailedChanges) {
                snapshot.detailedChanges = [];
            }
            
            const changes = [];
            
            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∑–∞–¥–∞—á–∏
            const oldTasks = lastSavedState.tasks || [];
            const newTasks = tasks;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            if (newTasks.length > oldTasks.length) {
                const addedCount = newTasks.length - oldTasks.length;
                changes.push(`–î–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞–¥–∞—á: ${addedCount}`);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            if (newTasks.length < oldTasks.length) {
                const removedCount = oldTasks.length - newTasks.length;
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö –∏–∑ window.pendingDeletedTasks
                const deletedTasksInfo = window.pendingDeletedTasks || [];
                
                if (deletedTasksInfo.length > 0) {
                    // –î–µ—Ç–∞–ª—å–Ω–æ –ª–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é —É–¥–∞–ª–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É
                    deletedTasksInfo.forEach((deletedTask, idx) => {
                        const taskName = deletedTask.taskName || `–ó–∞–¥–∞—á–∞ ${deletedTask.taskIndex + 1}`;
                        const statusNames = {
                            'pending': '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞',
                            'in-progress': '–í —Ä–∞–±–æ—Ç–µ',
                            'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ'
                        };
                        const statusName = statusNames[deletedTask.status] || deletedTask.status || '‚Äî';
                        
                        changes.push(`–£–î–ê–õ–ï–ù–û: "${taskName}" (–≠—Ç–∞–ø: ${deletedTask.stage || '‚Äî'}, –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞: ${deletedTask.startDate || '‚Äî'}, –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: ${deletedTask.endDate || '‚Äî'}, –°—Ç–∞—Ç—É—Å: ${statusName})`);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤ detailedChanges —Å —Ç–∏–ø–æ–º "deleted"
                        if (snapshot) {
                            if (!snapshot.detailedChanges) {
                                snapshot.detailedChanges = [];
                            }
                            snapshot.detailedChanges.push({
                                changeType: 'deleted', // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–∏–ø –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
                                taskIndex: deletedTask.taskIndex,
                                taskId: deletedTask.id,
                                taskName: deletedTask.taskName,
                                stage: deletedTask.stage || '',
                                control: deletedTask.control || '',
                                oldStartDate: deletedTask.startDate || null,
                                newStartDate: null, // –£–¥–∞–ª–µ–Ω–æ, –ø–æ—ç—Ç–æ–º—É –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ null
                                oldEndDate: deletedTask.endDate || null,
                                newEndDate: null,
                                oldDays: deletedTask.days || 0,
                                newDays: 0,
                                oldStatus: deletedTask.status || null,
                                newStatus: null,
                                oldLink: deletedTask.link || null,
                                newLink: null,
                                oldResponsible: deletedTask.responsible || null,
                                newResponsible: null,
                                oldName: deletedTask.taskName || null,
                                newName: null,
                                dateStatuses: deletedTask.dateStatuses || {},
                                dateComments: deletedTask.dateComments || {}
                            });
                        }
                    });
                    
                    // –û—á–∏—â–∞–µ–º –º–∞—Å—Å–∏–≤ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                    window.pendingDeletedTasks = [];
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø—Ä–æ—Å—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                    changes.push(`–£–¥–∞–ª–µ–Ω–æ –∑–∞–¥–∞—á: ${removedCount}`);
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–¥–∞—á–∞—Ö
            const maxLength = Math.min(oldTasks.length, newTasks.length);
            for (let i = 0; i < maxLength; i++) {
                const oldTask = oldTasks[i];
                const newTask = newTasks[i];
                const taskChanges = [];
                
                if (oldTask.name !== newTask.name && oldTask.task !== newTask.task) {
                    const oldName = oldTask.name || oldTask.task || '';
                    const newName = newTask.name || newTask.task || '';
                    if (oldName !== newName) {
                        taskChanges.push(`–ù–∞–∑–≤–∞–Ω–∏–µ: "${oldName.substring(0, 30)}..." ‚Üí "${newName.substring(0, 30)}..."`);
                    }
                }
                
                if (oldTask.startDate !== newTask.startDate) {
                    taskChanges.push(`–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞: ${oldTask.startDate || '‚Äî'} ‚Üí ${newTask.startDate || '‚Äî'}`);
                }
                
                if (oldTask.endDate !== newTask.endDate) {
                    taskChanges.push(`–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: ${oldTask.endDate || '‚Äî'} ‚Üí ${newTask.endDate || '‚Äî'}`);
                }
                
                if (oldTask.days !== newTask.days) {
                    taskChanges.push(`–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π: ${oldTask.days || 0} ‚Üí ${newTask.days || 0}`);
                }
                
                if (oldTask.status !== newTask.status) {
                    const statusNames = {
                        'pending': '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞',
                        'in-progress': '–í —Ä–∞–±–æ—Ç–µ',
                        'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ'
                    };
                    taskChanges.push(`–°—Ç–∞—Ç—É—Å: ${statusNames[oldTask.status] || oldTask.status} ‚Üí ${statusNames[newTask.status] || newTask.status}`);
                }
                
                if (oldTask.link !== newTask.link) {
                    taskChanges.push(`–°–≤—è–∑—å: ${oldTask.link || '‚Äî'} ‚Üí ${newTask.link || '‚Äî'}`);
                }
                
                if (oldTask.responsible !== newTask.responsible) {
                    taskChanges.push(`–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: ${oldTask.responsible || '‚Äî'} ‚Üí ${newTask.responsible || '‚Äî'}`);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –¥–Ω–µ–π (dateStatuses)
                const oldDateStatuses = oldTask.dateStatuses || {};
                const newDateStatuses = newTask.dateStatuses || {};
                const allDateKeys = new Set([...Object.keys(oldDateStatuses), ...Object.keys(newDateStatuses)]);
                const dateStatusChanges = [];
                
                allDateKeys.forEach(dateKey => {
                    const oldStatus = oldDateStatuses[dateKey];
                    const newStatus = newDateStatuses[dateKey];
                    
                    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è –∏–ª–∏ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω/—É–¥–∞–ª–µ–Ω
                    if (oldStatus !== newStatus) {
                        const statusNames = {
                            'pending': '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞',
                            'in-progress': '–í —Ä–∞–±–æ—Ç–µ',
                            'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
                            'holiday': '–ü—Ä–∞–∑–¥–Ω–∏–∫',
                            'weekend': '–í—ã—Ö–æ–¥–Ω–æ–π'
                        };
                        const oldStatusName = oldStatus ? (statusNames[oldStatus] || oldStatus) : '‚Äî';
                        const newStatusName = newStatus ? (statusNames[newStatus] || newStatus) : '‚Äî';
                        dateStatusChanges.push({
                            date: dateKey,
                            oldStatus: oldStatus || null,
                            newStatus: newStatus || null,
                            oldStatusName: oldStatusName,
                            newStatusName: newStatusName
                        });
                    }
                });
                
                if (dateStatusChanges.length > 0) {
                    taskChanges.push(`–°—Ç–∞—Ç—É—Å—ã –¥–Ω–µ–π: –∏–∑–º–µ–Ω–µ–Ω–æ ${dateStatusChanges.length} –¥–∞—Ç`);
                }
                
                if (taskChanges.length > 0) {
                    const taskName = (newTask.name || newTask.task || `–ó–∞–¥–∞—á–∞ ${i + 1}`).substring(0, 40);
                    changes.push(`${taskName}: ${taskChanges.join(', ')}`);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
                    if (snapshot) {
                        if (!snapshot.detailedChanges) {
                            snapshot.detailedChanges = [];
                        }
                        const changeEntry = {
                        taskIndex: i,
                        taskName: newTask.name || newTask.task || `–ó–∞–¥–∞—á–∞ ${i + 1}`,
                        oldStartDate: oldTask.startDate || null,
                        newStartDate: newTask.startDate || null,
                        oldEndDate: oldTask.endDate || null,
                        newEndDate: newTask.endDate || null,
                        oldDays: oldTask.days || 0,
                        newDays: newTask.days || 0,
                        oldStatus: oldTask.status || null,
                        newStatus: newTask.status || null,
                        oldLink: oldTask.link || null,
                        newLink: newTask.link || null,
                        oldResponsible: oldTask.responsible || null,
                        newResponsible: newTask.responsible || null,
                        oldName: oldTask.name || oldTask.task || null,
                        newName: newTask.name || newTask.task || null
                        };
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –¥–Ω–µ–π
                        if (dateStatusChanges.length > 0) {
                            changeEntry.dateStatusChanges = dateStatusChanges;
                        }
                        
                        snapshot.detailedChanges.push(changeEntry);
                    }
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞
            if (lastSavedState.startDate !== (startDate ? formatDateKey(startDate) : null)) {
                changes.push(`–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞: ${lastSavedState.startDate || '‚Äî'} ‚Üí ${startDate ? formatDateKey(startDate) : '‚Äî'}`);
            }
            
            if (changes.length === 0) {
                return {
                    action: '–ò–∑–º–µ–Ω–∏–ª –≥—Ä–∞—Ñ–∏–∫',
                    details: '–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –≥—Ä–∞—Ñ–∏–∫–µ (–¥–µ—Ç–∞–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã)'
                };
            }
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ —Ç–∏–ø–∞–º –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
            const groupedChanges = {
                tasks: [], // –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á
                project: [], // –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ (–¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞)
                added: [], // –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
                removed: [] // –£–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            };
            
            changes.forEach(change => {
                if (change.includes('–î–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞–¥–∞—á:')) {
                    groupedChanges.added.push(change);
                } else if (change.includes('–£–¥–∞–ª–µ–Ω–æ –∑–∞–¥–∞—á:')) {
                    groupedChanges.removed.push(change);
                } else if (change.includes('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞:')) {
                    groupedChanges.project.push(change);
                } else {
                    groupedChanges.tasks.push(change);
                }
            });
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
            const detailsParts = [];
            
            // –°–Ω–∞—á–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
            if (groupedChanges.project.length > 0) {
                detailsParts.push(...groupedChanges.project);
            }
            
            // –ó–∞—Ç–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ/—É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            if (groupedChanges.added.length > 0) {
                detailsParts.push(...groupedChanges.added);
            }
            if (groupedChanges.removed.length > 0) {
                detailsParts.push(...groupedChanges.removed);
            }
            
            // –ó–∞—Ç–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞–¥–∞—á–∞—Ö (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –∫–∞–∂–¥–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è)
            if (groupedChanges.tasks.length > 0) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤
                const maxDetailsLength = 500; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –¥–µ—Ç–∞–ª–µ–π
                let currentLength = detailsParts.join('; ').length;
                
                for (let i = 0; i < groupedChanges.tasks.length; i++) {
                    const taskChange = groupedChanges.tasks[i];
                    const testLength = currentLength + (detailsParts.length > 0 ? '; ' : '') + taskChange.length;
                    
                    if (testLength <= maxDetailsLength) {
                        detailsParts.push(taskChange);
                        currentLength = testLength;
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ –µ—â–µ –æ—Å—Ç–∞–ª–æ—Å—å
                        const remaining = groupedChanges.tasks.length - i;
                        if (remaining > 0) {
                            detailsParts.push(`... –∏ –µ—â–µ ${remaining} –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∑–∞–¥–∞—á–∞—Ö`);
                        }
                        break;
                    }
                }
            }
            
            const details = detailsParts.join('; ');
            
            return {
                action: '–ò–∑–º–µ–Ω–∏–ª –≥—Ä–∞—Ñ–∏–∫',
                details: details
            };
        }
        
        // –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª–Ω—ã–π snapshot —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        function createFullGanttSnapshot() {
            return {
                version: '1.0',
                savedAt: new Date().toISOString(),
                startDate: startDate ? formatDateKey(startDate) : null,
                tasks: tasks.map(task => {
                    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º task –∏ name –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
                    const taskName = task.task || task.name || '';
                    return {
                        id: task.id,
                        stage: task.stage || '',
                        substage: task.substage || '',
                        control: task.control || task.controlType || '', // –ò—Å–ø–æ–ª—å–∑—É–µ–º control, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π controlType
                        controlType: task.control || task.controlType || '', // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–∫–∂–µ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                        name: taskName,
                        task: taskName, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–∫–∂–µ –≤ –ø–æ–ª–µ task –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                        days: task.days || 0,
                    startDate: task.startDate ? formatDateKey(task.startDate) : null,
                    endDate: task.endDate ? formatDateKey(task.endDate) : null,
                    dates: Array.isArray(task.dates) ? task.dates.map(d => formatDateKey(d)) : [],
                    status: task.status || 'pending',
                    dateStatuses: task.dateStatuses || {},
                    dateComments: task.dateComments || {},
                    responsible: task.responsible || '',
                    link: task.link || '',
                    onTravel: task.onTravel || false,
                    baselineDates: Array.isArray(task.baselineDates) ? task.baselineDates.map(d => formatDateKey(d)) : [],
                    baselineStartDate: task.baselineStartDate ? formatDateKey(task.baselineStartDate) : null,
                    baselineEndDate: task.baselineEndDate ? formatDateKey(task.baselineEndDate) : null
                    };
                }),
                settings: {
                    ganttBarStyle: ganttBarStyle || 'dots',
                    showLink: showLink || false,
                    showResponsible: showResponsible || false,
                    zoomLevel: zoomLevel || 1
                },
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º baselineSnapshot –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –±–∞–∑–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞
                baselineSnapshot: baselineSnapshot || null
            };
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function saveFullGanttState() {
            try {
                if (!currentCompany) {
                    console.warn('‚ö†Ô∏è –ö–æ–º–ø–∞–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ. currentCompany:', currentCompany);
                    console.warn('‚ö†Ô∏è URL:', window.location.href);
                    console.warn('‚ö†Ô∏è localStorage gantt-company:', localStorage.getItem('gantt-company'));
                    return;
                }
                
                if (isViewMode) {
                    console.warn('‚ö†Ô∏è –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ');
                    return;
                }
                
                // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤, –≤–∫–ª—é—á–∞—è Praktis ID
                const snapshot = createFullGanttSnapshot();
                const companyParam = `?company=${currentCompany}`;
                const url = `/api/gantt-state${companyParam}`;
                
                console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏:', currentCompany);
                console.log('üìä –¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞:', companyChartType);
                console.log('üì¶ –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:', JSON.stringify(snapshot).length, '–±–∞–π—Ç');
                console.log('üîó URL –∑–∞–ø—Ä–æ—Å–∞:', url);
                console.log('üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á:', snapshot.tasks ? snapshot.tasks.length : 0);
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                const userStr = localStorage.getItem('gantt-user');
                let userName = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                let userLogin = null;
                
                console.log('üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:');
                console.log('   localStorage.getItem("gantt-user"):', userStr ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω');
                
                if (userStr) {
                    try {
                        const user = JSON.parse(userStr);
                        console.log('   –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user);
                        console.log('   user.name:', user.name);
                        console.log('   user.login:', user.login);
                        
                        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: name > login > '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞: login –∏ Login (–Ω–∞ —Å–ª—É—á–∞–π —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤)
                        if (user.name && user.name.trim()) {
                            userName = user.name.trim();
                        } else if (user.login && user.login.trim()) {
                            userName = user.login.trim();
                        } else if (user.Login && user.Login.trim()) {
                            userName = user.Login.trim();
                        } else {
                            console.warn('‚ö†Ô∏è –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –Ω–∏ name, –Ω–∏ login');
                            userName = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞: login –∏ Login
                        userLogin = user.login || user.Login || null;
                        console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:', { name: userName, login: userLogin });
                    } catch (e) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
                        console.error('   –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ:', userStr);
                        userName = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                    }
                } else {
                    console.error('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage (gantt-user)');
                    console.error('   –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:', isViewMode);
                    console.error('   –í—Å–µ –∫–ª—é—á–∏ localStorage:', Object.keys(localStorage));
                    // –í —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                    if (!isViewMode) {
                        console.error('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!');
                    }
                }
                
                // –°–æ–∑–¥–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
                let changeInfo = snapshot.changeInfo || null;
                if (!changeInfo) {
                    // –°–æ–∑–¥–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                    console.log('üìù –°–æ–∑–¥–∞–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π...');
                    console.log('   lastSavedState:', lastSavedState ? '–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω' : 'null (–ø–µ—Ä–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)');
                    changeInfo = createChangeDescription(snapshot);
                    console.log('üìù –î–µ—Ç–∞–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π:', JSON.stringify(changeInfo, null, 2));
                    console.log('üìù –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π:', snapshot.detailedChanges ? snapshot.detailedChanges.length : 0);
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –Ω–æ –µ—Å—Ç—å –∑–∞–¥–∞—á–∏, —Å–æ–∑–¥–∞–µ–º –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                    if (!lastSavedState && tasks && tasks.length > 0) {
                        const taskCount = tasks.length;
                        changeInfo = {
                            action: '–ò–∑–º–µ–Ω–∏–ª –≥—Ä–∞—Ñ–∏–∫',
                            details: `–ü–µ—Ä–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ (–∑–∞–¥–∞—á: ${taskCount})`
                        };
                        console.log('üìù –û–±–Ω–æ–≤–ª–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', changeInfo);
                    }
                } else {
                    console.log('üìù –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ changeInfo:', JSON.stringify(changeInfo, null, 2));
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                // (–±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞)
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ –∑–∞–ø—Ä–æ—Å
                const requestBody = {
                    ...snapshot,
                    userName: userName,
                    userLogin: userLogin, // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–∏–Ω –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                    changeInfo: changeInfo,
                    detailedChanges: snapshot.detailedChanges || null // –î–µ—Ç–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
                };
                
                // –ö–æ–¥–∏—Ä—É–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ ISO-8859-1)
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º base64 –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
                const encodedUserName = btoa(encodeURIComponent(userName));
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-User-Name': encodedUserName,
                        'X-User-Name-Encoded': 'base64' // –§–ª–∞–≥, —á—Ç–æ –∏–º—è –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå –û—à–∏–±–∫–∞ HTTP:', response.status, response.statusText);
                    console.error('‚ùå –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const responseData = await response.json();
                
                if (responseData && responseData.ok) {
                    console.log('‚úÖ –ü–æ–ª–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');
                    console.log('‚úÖ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', responseData);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
                    lastSavedState = JSON.parse(JSON.stringify(snapshot));
                    
                    // –û—á–∏—â–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                    if (window.pendingDeletedTasks) {
                        window.pendingDeletedTasks = [];
                    }
                    
                    showSaveIndicator(true);
                    // –ù–ï –æ—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å
                    // –æ—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–∫–æ—Ç–æ—Ä–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–∞–∂–µ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
                    // –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
                    // clearUndoHistory(); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–º–µ–Ω—ã –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                } else {
                    console.error('‚ùå –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É:', responseData);
                    throw new Error(responseData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:', e);
                console.error('‚ùå –°—Ç–µ–∫ –æ—à–∏–±–∫–∏:', e.stack);
                showSaveIndicator(false);
                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ–º
                // alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message + '\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        function showSaveIndicator(success) {
            const saveButton = document.getElementById('saveButton');
            const saveButtonText = document.getElementById('saveButtonText');
            
            if (!saveButton || !saveButtonText) return;
            
            if (success) {
                saveButton.classList.add('saving-success');
                saveButtonText.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
                console.log('üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    saveButton.classList.remove('saving-success');
                    saveButtonText.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                }, 2000);
            } else {
                saveButton.classList.add('saving-error');
                saveButtonText.textContent = '‚úó –û—à–∏–±–∫–∞';
                
                setTimeout(() => {
                    saveButton.classList.remove('saving-error');
                    saveButtonText.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                }, 2000);
            }
        }

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ
        async function manualSaveGantt() {
            const saveButton = document.getElementById('saveButton');
            const saveButtonText = document.getElementById('saveButtonText');
            
            if (saveButton) {
                saveButton.disabled = true;
                if (saveButtonText) {
                    saveButtonText.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                }
            }
            
            try {
                await saveFullGanttState();
                showSaveIndicator(true);
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä—É—á–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', error);
                showSaveIndicator(false);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            } finally {
                if (saveButton) {
                    saveButton.disabled = false;
                }
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π (debounce)
        function autoSaveGanttState() {
            console.log('üîÑ autoSaveGanttState –≤—ã–∑–≤–∞–Ω–∞');
            console.log('   currentCompany:', currentCompany);
            console.log('   isViewMode:', isViewMode);
            console.log('   URL:', window.location.href);
            
            if (!currentCompany) {
                console.warn('‚ö†Ô∏è autoSaveGanttState: –∫–æ–º–ø–∞–Ω–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ');
                console.warn('   –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ localStorage:', localStorage.getItem('gantt-company'));
                // –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ localStorage
                const savedCompany = localStorage.getItem('gantt-company');
                if (savedCompany) {
                    currentCompany = savedCompany;
                    console.log('‚úÖ –ö–æ–º–ø–∞–Ω–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ localStorage:', currentCompany);
                } else {
                return;
                }
            }
            
            if (isViewMode) {
                console.warn('‚ö†Ô∏è autoSaveGanttState: —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ');
                return;
            }
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
            if (saveTimeout) {
                clearTimeout(saveTimeout);
                console.log('   –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä –æ—á–∏—â–µ–Ω');
            }
            
            console.log('‚è±Ô∏è –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É');
            
            // –£–º–µ–Ω—å—à–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–æ 1 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            saveTimeout = setTimeout(() => {
                console.log('‚è∞ –¢–∞–π–º–µ—Ä —Å—Ä–∞–±–æ—Ç–∞–ª, –Ω–∞—á–∏–Ω–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
                saveFullGanttState();
            }, 1000);
        }

        // ========== –°–∏—Å—Ç–µ–º–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ—Ç–º–µ–Ω—ã (Undo) ==========
        
        // –ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –≤ localStorage
        function getUndoHistoryKey() {
            if (!currentCompany) return null;
            return `gantt-undo-history-${currentCompany}`;
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑ localStorage
        function loadUndoHistory() {
            const key = getUndoHistoryKey();
            if (!key) return;
            
            try {
                const stored = localStorage.getItem(key);
                if (stored) {
                    undoHistory = JSON.parse(stored);
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ MAX_UNDO_HISTORY
                    if (undoHistory.length > MAX_UNDO_HISTORY) {
                        undoHistory = undoHistory.slice(-MAX_UNDO_HISTORY);
                    }
                } else {
                    undoHistory = [];
                }
                // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–≤—Ç–æ—Ä–æ–≤
                redoHistory = [];
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–º–µ–Ω—ã:', e);
                undoHistory = [];
                redoHistory = [];
            }
            updateUndoButtonState();
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤ localStorage
        function saveUndoHistory() {
            const key = getUndoHistoryKey();
            if (!key) return;
            
            try {
                localStorage.setItem(key, JSON.stringify(undoHistory));
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–º–µ–Ω—ã:', e);
            }
        }

        // –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
        function addToUndoHistory() {
            // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ —ç—Ç–æ –æ—Ç–º–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è
            if (isUndoing || isRedoing) {
                console.log('‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç–º–µ–Ω–∞/–ø–æ–≤—Ç–æ—Ä)');
                return;
            }
            
            // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            if (isViewMode) {
                console.log('‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é (—Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞)');
                return;
            }
            
            // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º, –µ—Å–ª–∏ –∫–æ–º–ø–∞–Ω–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
            if (!currentCompany) {
                console.log('‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é (–∫–æ–º–ø–∞–Ω–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞)');
                return;
            }
            
            console.log('üìù addToUndoHistory: –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–º–µ–Ω—ã');
            console.log('   –¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ–π—Å—Ç–≤–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏:', undoHistory.length);
            
            // –°–æ–∑–¥–∞–µ–º —Å–Ω–∏–º–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            const snapshot = createFullGanttSnapshot();
            console.log('   –°–Ω–∏–º–æ–∫ —Å–æ–∑–¥–∞–Ω, –∑–∞–¥–∞—á –≤ —Å–Ω–∏–º–∫–µ:', snapshot.tasks?.length || 0);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            undoHistory.push(snapshot);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
            if (undoHistory.length > MAX_UNDO_HISTORY) {
                const removed = undoHistory.shift(); // –£–¥–∞–ª—è–µ–º —Å–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
                console.log('   –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–≤—ã—Å–∏–ª–∞ –ª–∏–º–∏—Ç, —É–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ');
            }
            
            console.log('   –ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ–π—Å—Ç–≤–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏:', undoHistory.length);
            
            // –õ—é–±–æ–µ –Ω–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –æ–±–Ω—É–ª—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–µ
            if (redoHistory.length > 0) {
                redoHistory = [];
                console.log('   –ò—Å—Ç–æ—Ä–∏—è –ø–æ–≤—Ç–æ—Ä–æ–≤ –æ—á–∏—â–µ–Ω–∞ –ø–æ—Å–ª–µ –Ω–æ–≤–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è');
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            saveUndoHistory();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
            updateUndoButtonState();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Å–±—Ä–æ—Å–∞ –ø–ª–∞–Ω–∞ –ø—Ä–∏ –ª—é–±–æ–º –Ω–æ–≤–æ–º –¥–µ–π—Å—Ç–≤–∏–∏
            // (—Ñ–ª–∞–≥ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∑–∞–Ω–æ–≤–æ –≤ confirmResetPlan() –µ—Å–ª–∏ —ç—Ç–æ —Å–±—Ä–æ—Å –ø–ª–∞–Ω–∞)
            lastActionWasReset = false;
            
            console.log('   ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
        }

        // –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ –ø–ª–∞–Ω–∞
        function undoLastAction() {
            // –ù–µ –æ—Ç–º–µ–Ω—è–µ–º –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            if (isViewMode) {
                console.warn('–û—Ç–º–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —á—Ç–æ –æ—Ç–º–µ–Ω—è—Ç—å
            if (undoHistory.length === 0) {
                console.warn('–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ—Ç–º–µ–Ω—ã');
                return;
            }
            
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            if (!tasks || !Array.isArray(tasks)) {
                console.warn('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –æ—Ç–º–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                showMobileNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ—Ç–º–µ–Ω–æ–π –¥–µ–π—Å—Ç–≤–∏—è');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏
            const lastState = undoHistory[undoHistory.length - 1];
            if (!lastState || !lastState.tasks || !Array.isArray(lastState.tasks) || lastState.tasks.length === 0) {
                console.warn('‚ö†Ô∏è –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö');
                showMobileNotification('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –±—ã–ª–æ —Å–±—Ä–æ—Å–æ–º –ø–ª–∞–Ω–∞
            if (lastActionWasReset) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
                const modal = document.getElementById('undoConfirmModal');
                if (modal) {
                    modal.style.display = 'block';
                    
                    // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π
                    const isMobile = window.innerWidth <= 1024;
                    if (isMobile) {
                        requestAnimationFrame(() => {
                            const undoButton = document.getElementById('undoBtn');
                            if (undoButton) {
                                const modalContent = modal.querySelector('.modal-content');
                                if (modalContent) {
                                    const buttonRect = undoButton.getBoundingClientRect();
                                    const viewportHeight = window.innerHeight;
                                    const buttonBottom = buttonRect.bottom;
                                    const spaceBelow = viewportHeight - buttonBottom;
                                    const spaceAbove = buttonRect.top;
                                    
                                    let topPosition;
                                    if (spaceBelow < 300 && spaceAbove > spaceBelow) {
                                        topPosition = buttonRect.top - 350;
                                    } else {
                                        topPosition = buttonBottom + 10;
                                    }
                                    
                                    modalContent.style.position = 'fixed';
                                    modalContent.style.top = `${Math.max(10, Math.min(topPosition, viewportHeight - 400))}px`;
                                    modalContent.style.left = '50%';
                                    modalContent.style.transform = 'translateX(-50%)';
                                    modalContent.style.margin = '0';
                                    modalContent.style.width = '90%';
                                    modalContent.style.maxWidth = '400px';
                                }
                            }
                        });
                    }
                }
            } else {
                // –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï –±—ã–ª–æ —Å–±—Ä–æ—Å–æ–º –ø–ª–∞–Ω–∞ - –≤—ã–ø–æ–ª–Ω—è–µ–º –æ—Ç–º–µ–Ω—É —Å—Ä–∞–∑—É –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                performUndo();
            }
        }
        
        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è Undo/Redo)
        function applySnapshotState(targetState, loadingMessage = '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...') {
            if (!targetState || !targetState.tasks || !Array.isArray(targetState.tasks) || targetState.tasks.length === 0) {
                console.warn('‚ö†Ô∏è –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–¥–∞—á –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
                showMobileNotification('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–¥–∞—á');
                return false;
            }

            showLoadingIndicator(loadingMessage);

            try {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É —Å—Ç–∞—Ä—Ç–∞
                if (targetState.startDate) {
                    startDate = parseDateKey(targetState.startDate);
                }

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–¥–∞—á–∏
                tasks = targetState.tasks.map(task => ({
                    id: task.id,
                    stage: task.stage || '',
                    substage: task.substage || '',
                    control: task.control || task.controlType || '',
                    controlType: task.control || task.controlType || '',
                    name: task.name || task.task || '',
                    task: task.task || task.name || '',
                    days: task.days || 0,
                    startDate: task.startDate ? parseDateKey(task.startDate) : null,
                    endDate: task.endDate ? parseDateKey(task.endDate) : null,
                    dates: Array.isArray(task.dates) ? task.dates.map(d => parseDateKey(d)) : [],
                    status: task.status || 'pending',
                    dateStatuses: task.dateStatuses || {},
                    dateComments: task.dateComments || {},
                    responsible: task.responsible || '',
                    link: task.link || '',
                    onTravel: task.onTravel || false,
                    baselineDates: Array.isArray(task.baselineDates) ? task.baselineDates.map(d => parseDateKey(d)) : [],
                    baselineStartDate: task.baselineStartDate ? parseDateKey(task.baselineStartDate) : null,
                    baselineEndDate: task.baselineEndDate ? parseDateKey(task.baselineEndDate) : null
                }));

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                if (targetState.settings) {
                    ganttBarStyle = targetState.settings.ganttBarStyle || 'dots';
                    showLink = targetState.settings.showLink || false;
                    showResponsible = targetState.settings.showResponsible || false;
                    zoomLevel = targetState.settings.zoomLevel || 1;
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º nextTaskId
                if (tasks.length > 0) {
                    const maxId = Math.max(...tasks.map(t => t.id));
                    nextTaskId = maxId + 1;
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∏ –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π
                const scrollY = window.scrollY || window.pageYOffset;
                const scrollX = window.scrollX || window.pageXOffset;

                // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–∏–∞–≥—Ä–∞–º–º—ã, –µ—Å–ª–∏ –µ—Å—Ç—å
                const chartContainer = document.getElementById('ganttChart');
                const chartScrollTop = chartContainer ? chartContainer.scrollTop : 0;
                const chartScrollLeft = chartContainer ? chartContainer.scrollLeft : 0;

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏ —É–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É
                const activeElement = document.activeElement;
                const activeElementInfo = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA') 
                    ? { element: activeElement, selectionStart: activeElement.selectionStart, selectionEnd: activeElement.selectionEnd }
                    : null;

                if (activeElementInfo) {
                    activeElementInfo.element.blur();
                }

                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                renderGantt();
                renderTable();
                updateStatistics();

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
                if (searchResults.length > 0) {
                    highlightSearchResults();
                }
                renderStageTabs();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
                if (!tasks || tasks.length === 0) {
                    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –∑–∞–¥–∞—á–∏ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
                    showMobileNotification('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    return false;
                }

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å—Ä–∞–∑—É, –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
                window.scrollTo(scrollX, scrollY);
                const newChartContainer = document.getElementById('ganttChart');
                if (newChartContainer) {
                    newChartContainer.scrollTop = chartScrollTop;
                    newChartContainer.scrollLeft = chartScrollLeft;
                }

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏)
                if (activeElementInfo && document.contains(activeElementInfo.element)) {
                    requestAnimationFrame(() => {
                        try {
                            activeElementInfo.element.focus({ preventScroll: true });
                            if (activeElementInfo.element.setSelectionRange && 
                                activeElementInfo.selectionStart !== null && 
                                activeElementInfo.selectionEnd !== null) {
                                activeElementInfo.element.setSelectionRange(
                                    activeElementInfo.selectionStart, 
                                    activeElementInfo.selectionEnd
                                );
                            }
                        } catch (e) {
                            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–æ–∫—É—Å–∞
                        }
                    });
                }

                return true;
            } finally {
                hideLoadingIndicator();
            }
        }

        // –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ - –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é –æ—Ç–º–µ–Ω—É
        function performUndo() {
            isUndoing = true;
            
            try {
                const previousState = undoHistory.pop();
                
                if (!previousState) {
                    console.warn('‚ö†Ô∏è –ù–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
                    showMobileNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
                    cancelUndo();
                    return;
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Å—Ç–µ–∫ –ø–æ–≤—Ç–æ—Ä–æ–≤
                const currentSnapshot = createFullGanttSnapshot();
                redoHistory.push(currentSnapshot);
                if (redoHistory.length > MAX_REDO_HISTORY) {
                    redoHistory.shift();
                }
                
                const restored = applySnapshotState(previousState, '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');
                if (!restored) {
                    return;
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
                saveUndoHistory();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                updateUndoButtonState();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Å–±—Ä–æ—Å–∞ –ø–ª–∞–Ω–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–º–µ–Ω—ã
                lastActionWasReset = false;
                
                console.log('‚úÖ –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ, –æ—Å—Ç–∞–ª–æ—Å—å –¥–µ–π—Å—Ç–≤–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏:', undoHistory.length);
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–º–µ–Ω—ã
                cancelUndo();
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –¥–µ–π—Å—Ç–≤–∏—è:', e);
                showMobileNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –¥–µ–π—Å—Ç–≤–∏—è: ' + e.message);
                cancelUndo();
            } finally {
                isUndoing = false;
            }
        }

        // –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
        function redoLastAction() {
            if (isViewMode) {
                console.warn('–ü–æ–≤—Ç–æ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
                return;
            }

            if (redoHistory.length === 0) {
                console.warn('–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞');
                return;
            }

            if (!tasks || !Array.isArray(tasks)) {
                console.warn('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø–æ–≤—Ç–æ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                showMobileNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º –¥–µ–π—Å—Ç–≤–∏—è');
                return;
            }

            performRedo();
        }

        // –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–≤—Ç–æ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
        function performRedo() {
            isRedoing = true;
            try {
                const nextState = redoHistory.pop();
                if (!nextState) {
                    console.warn('‚ö†Ô∏è –ù–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞');
                    return;
                }

                // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ undo, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ–≤—Ç–æ—Ä
                const currentSnapshot = createFullGanttSnapshot();
                undoHistory.push(currentSnapshot);
                if (undoHistory.length > MAX_UNDO_HISTORY) {
                    undoHistory.shift();
                }

                const restored = applySnapshotState(nextState, '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è...');
                if (!restored) {
                    return;
                }

                saveUndoHistory();
                updateUndoButtonState();
                lastActionWasReset = false;

                console.log('‚úÖ –î–µ–π—Å—Ç–≤–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–æ, –æ—Å—Ç–∞–ª–æ—Å—å –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞:', redoHistory.length);
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ –¥–µ–π—Å—Ç–≤–∏—è:', e);
                showMobileNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ –¥–µ–π—Å—Ç–≤–∏—è: ' + e.message);
            } finally {
                isRedoing = false;
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–≤–º–µ—Å—Ç–æ alert)
        function showMobileNotification(message) {
            // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
            const existing = document.getElementById('mobileNotification');
            if (existing) {
                existing.remove();
            }
            
            const isMobile = window.innerWidth <= 1024;
            const notification = document.createElement('div');
            notification.id = 'mobileNotification';
            
            const baseStyles = `
                position: fixed;
                top: ${isMobile ? '20px' : '50%'};
                left: 50%;
                transform: translateX(-50%) ${isMobile ? '' : 'translateY(-50%)'};
                background: rgba(244, 67, 54, 0.95);
                color: white;
                padding: ${isMobile ? '14px 20px' : '16px 32px'};
                border-radius: ${isMobile ? '12px' : '8px'};
                z-index: 10001;
                font-weight: 500;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
                text-align: center;
                word-wrap: break-word;
                max-width: ${isMobile ? '90%' : '500px'};
                font-size: ${isMobile ? '13px' : '15px'};
                line-height: 1.4;
            `;
            
            notification.style.cssText = baseStyles;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.3s ease-out';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 4000);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        function showLoadingIndicator(message) {
            // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å
            hideLoadingIndicator();
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –º–æ–±–∏–ª—å–Ω–æ–µ –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
            const isMobile = window.innerWidth <= 1024;
            
            const indicator = document.createElement('div');
            indicator.id = 'undoLoadingIndicator';
            
            // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –∏ –¥–µ—Å–∫—Ç–æ–ø–æ–≤
            const baseStyles = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.85);
                color: white;
                border-radius: ${isMobile ? '12px' : '8px'};
                z-index: 10000;
                font-weight: 500;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
                text-align: center;
                word-wrap: break-word;
                max-width: ${isMobile ? '90%' : 'auto'};
            `;
            
            const mobileStyles = isMobile ? `
                padding: 16px 24px;
                font-size: 14px;
                min-width: 200px;
            ` : `
                padding: 20px 40px;
                font-size: 16px;
            `;
            
            indicator.style.cssText = baseStyles + mobileStyles;
            indicator.textContent = message || '–ó–∞–≥—Ä—É–∑–∫–∞...';
            document.body.appendChild(indicator);
        }
        
        // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        function hideLoadingIndicator() {
            const indicator = document.getElementById('undoLoadingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–º–µ–Ω—ã
        function cancelUndo() {
            const modal = document.getElementById('undoConfirmModal');
            if (modal) {
                modal.style.display = 'none';
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.position = '';
                    modalContent.style.top = '';
                    modalContent.style.left = '';
                    modalContent.style.transform = '';
                    modalContent.style.margin = '';
                    modalContent.style.width = '';
                    modalContent.style.maxWidth = '';
                }
            }
        }
        
        // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–º–µ–Ω—É –¥–µ–π—Å—Ç–≤–∏—è
        function confirmUndo() {
            performUndo();
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏ (–æ—Ç–º–µ–Ω–∞ / –ø–æ–≤—Ç–æ—Ä)
        function updateUndoButtonState() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            if (!undoBtn) {
                console.warn('‚ö†Ô∏è updateUndoButtonState: –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —á–µ—Ä–µ–∑ canEdit()
            const canEditMode = canEdit && canEdit();
            const hasHistory = undoHistory.length > 0 && canEditMode && currentCompany;
            const hasRedoHistory = redoHistory.length > 0 && canEditMode && currentCompany;
            
            console.log('üîò updateUndoButtonState:', {
                historyLength: undoHistory.length,
                redoHistoryLength: redoHistory.length,
                canEditMode: canEditMode,
                currentCompany: currentCompany,
                hasHistory: hasHistory,
                hasRedoHistory: hasRedoHistory
            });
            
            if (hasHistory) {
                undoBtn.classList.remove('disabled');
                undoBtn.disabled = false;
                console.log('   ‚úÖ –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –ê–ö–¢–ò–í–ù–ê');
            } else {
                undoBtn.classList.add('disabled');
                undoBtn.disabled = true;
                console.log('   ‚ùå –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê');
                if (undoHistory.length === 0) {
                    console.log('      –ü—Ä–∏—á–∏–Ω–∞: –∏—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞');
                }
                if (!canEditMode) {
                    console.log('      –ü—Ä–∏—á–∏–Ω–∞: —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                }
                if (!currentCompany) {
                    console.log('      –ü—Ä–∏—á–∏–Ω–∞: –∫–æ–º–ø–∞–Ω–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞');
                }
            }

            if (redoBtn) {
                if (hasRedoHistory) {
                    redoBtn.classList.remove('disabled');
                    redoBtn.disabled = false;
                    console.log('   ‚úÖ –ö–Ω–æ–ø–∫–∞ –ø–æ–≤—Ç–æ—Ä–∞ –ê–ö–¢–ò–í–ù–ê');
                } else {
                    redoBtn.classList.add('disabled');
                    redoBtn.disabled = true;
                    console.log('   ‚ùå –ö–Ω–æ–ø–∫–∞ –ø–æ–≤—Ç–æ—Ä–∞ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê');
                }
            }
        }

        // –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
        function clearUndoHistory() {
            undoHistory = [];
            redoHistory = [];
            const key = getUndoHistoryKey();
            if (key) {
                try {
                    localStorage.removeItem(key);
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–º–µ–Ω—ã:', e);
                }
            }
            updateUndoButtonState();
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadFullGanttState() {
            try {
                if (!currentCompany) {
                    console.warn('‚ö†Ô∏è –ö–æ–º–ø–∞–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞');
                    return false;
                }
                
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞
                try {
                    const companyParam = `?company=${currentCompany}`;
                    const companyInfoRes = await fetch(`/api/company-info${companyParam}`);
                    if (companyInfoRes.ok) {
                        const companyInfo = await companyInfoRes.json();
                        if (companyInfo && companyInfo.chartType) {
                            const chartType = companyInfo.chartType;
                            console.log('üìä –¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏:', chartType);
                            
                            // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤, –≤–∫–ª—é—á–∞—è Praktis ID
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                            companyChartType = chartType;
                        }
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏:', e);
                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø
                }
                
                const companyParam = `?company=${currentCompany}`;
                console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏:', currentCompany);
                const res = await fetch(`/api/gantt-state${companyParam}`);
                if (!res.ok) {
                    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞:', res.status, res.statusText);
                    return false;
                }
                const data = await res.json();
                console.log('üì¶ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞:', data ? '–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã' : 'null');
                
                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º false
                if (!data) {
                    console.log('‚ÑπÔ∏è –§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
                    return false;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∑–∞–¥–∞—á
                if (!data.tasks || !Array.isArray(data.tasks)) {
                    console.warn('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –º–∞—Å—Å–∏–≤ –∑–∞–¥–∞—á, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
                    return false;
                }
                
                // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ –∑–∞–¥–∞—á –ø—É—Å—Ç–æ–π, —Ç–æ–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                if (data.tasks.length === 0) {
                    console.warn('‚ö†Ô∏è –ú–∞—Å—Å–∏–≤ –∑–∞–¥–∞—á –ø—É—Å—Ç–æ–π, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
                    return false;
                }

                console.log('‚úÖ –ù–∞–π–¥–µ–Ω–æ –∑–∞–¥–∞—á –≤ –¥–∞–Ω–Ω—ã—Ö:', data.tasks.length);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é –¥–∞–Ω–Ω—ã—Ö (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç baseline –∏–ª–∏ –Ω–æ–≤—ã–π –ø–æ–ª–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)
                const isFullFormat = data.version && data.version === '1.0';

                if (isFullFormat) {
                    console.log('‚úÖ –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: –ø–æ–ª–Ω—ã–π (version 1.0)');
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º startDate –ø—Ä–æ–µ–∫—Ç–∞
                    if (data.startDate) {
                        if (data.startDate instanceof Date) {
                            startDate = new Date(data.startDate);
                        } else if (typeof data.startDate === 'string') {
                            const parts = data.startDate.split('-');
                            if (parts.length === 3) {
                                startDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                            }
                        }
                    }

                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–¥–∞—á–∏
                    tasks = data.tasks.map(task => {
                        // –ü—Ä–∞–≤–∏–ª—å–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –∑–∞–¥–∞—á —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é
                        let taskName = '';
                        let taskNameField = '';
                        
                        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: task.task > task.name > –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
                        if (task.task) {
                            taskName = task.task;
                            taskNameField = task.task;
                        } else if (task.name) {
                            taskName = task.name;
                            taskNameField = task.name;
                        }
                        
                        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –æ–±–∞ –ø–æ–ª—è
                        const taskObj = {
                            id: task.id,
                            stage: task.stage || '',
                            substage: task.substage || '',
                            control: task.control || task.controlType || '', // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è controlType
                            name: taskName,
                            task: taskNameField,
                            days: task.days || 0,
                            status: task.status || 'pending',
                            dateStatuses: task.dateStatuses || {},
                            dateComments: task.dateComments || {},
                            responsible: task.responsible || '',
                            link: task.link || '–û_–ù', // –í—Å–µ –∑–∞–¥–∞—á–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –û_–ù (–ø–µ—Ä–≤–∞—è —Ç–æ–∂–µ, –Ω–æ select –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)
                            onTravel: task.onTravel || false,
                            dates: [],
                            startDate: null,
                            endDate: null
                        };

                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã
                        if (task.dates && Array.isArray(task.dates)) {
                            taskObj.dates = task.dates.map(dateStr => {
                                // –ï—Å–ª–∏ —É–∂–µ –æ–±—ä–µ–∫—Ç Date, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
                                if (dateStr instanceof Date) {
                                    return dateStr;
                                }
                                // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞, –ø–∞—Ä—Å–∏–º –µ—ë
                                if (typeof dateStr === 'string') {
                                    const parts = dateStr.split('-');
                                    if (parts.length === 3) {
                                        return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                                    }
                                }
                                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
                                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞—Ç—É:', dateStr);
                                return new Date();
                            });
                            if (taskObj.dates.length > 0) {
                                taskObj.startDate = taskObj.dates[0];
                                taskObj.endDate = taskObj.dates[taskObj.dates.length - 1];
                            }
                        }

                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º baseline –¥–∞–Ω–Ω—ã–µ
                        if (task.baselineDates && Array.isArray(task.baselineDates)) {
                            taskObj.baselineDates = task.baselineDates;
                        }
                        if (task.baselineStartDate) {
                            const parts = task.baselineStartDate.split('-');
                            taskObj.baselineStartDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                        }
                        if (task.baselineEndDate) {
                            const parts = task.baselineEndDate.split('-');
                            taskObj.baselineEndDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                        }

                        return taskObj;
                    });

                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    if (data.settings) {
                        if (data.settings.ganttBarStyle) ganttBarStyle = data.settings.ganttBarStyle;
                        if (data.settings.showLink !== undefined) {
                            showLink = data.settings.showLink;
                            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –∏ –∫–ª–∞—Å—Å–∞ body
                            const linkBtn = document.getElementById('linkToggleBtn');
                            if (linkBtn) {
                                if (showLink) {
                                    linkBtn.classList.add('active');
                                    document.body.classList.add('show-link');
                                } else {
                                    linkBtn.classList.remove('active');
                                    document.body.classList.remove('show-link');
                                }
                            }
                        }
                        if (data.settings.showResponsible !== undefined) showResponsible = data.settings.showResponsible;
                        if (data.settings.zoomLevel) zoomLevel = data.settings.zoomLevel;
                    }

                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º baselineSnapshot
                    if (data.baselineSnapshot) {
                        baselineSnapshot = data.baselineSnapshot;
                        console.log('‚úÖ baselineSnapshot –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
                        applyBaselineToTasks();
                    } else {
                        // –ï—Å–ª–∏ baselineSnapshot –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–æ –µ—Å—Ç—å baselineDates –≤ –∑–∞–¥–∞—á–∞—Ö, –ø—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        const hasBaselineDates = tasks.some(t => Array.isArray(t.baselineDates) && t.baselineDates.length > 0);
                        if (hasBaselineDates) {
                            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º baselineSnapshot –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
                            baselineSnapshot = buildBaselineSnapshot();
                            console.log('‚úÖ baselineSnapshot –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ baselineDates –∑–∞–¥–∞—á');
                        } else {
                            baselineSnapshot = null;
                            console.log('‚ÑπÔ∏è baselineSnapshot –Ω–µ –Ω–∞–π–¥–µ–Ω, –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω –Ω–µ –∑–∞–¥–∞–Ω');
                        }
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ ID
                    if (tasks.length > 0) {
                        nextTaskId = Math.max(...tasks.map(t => t.id)) + 1;
                    }

                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –∏ —Ç–∞–±–ª–∏—Ü—É
                    updateStatistics();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            if (searchResults.length > 0) {
                highlightSearchResults();
            }
                    renderGantt();
                    renderTable();
                    renderStageTabs();
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è baselineSnapshot
                    updateBaselineToggleButton();
                    autoSaveGanttState(); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏

                    console.log('‚úÖ –ü–æ–ª–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –∑–∞–¥–∞—á:', tasks.length);
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º lastSavedState –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
                    lastSavedState = JSON.parse(JSON.stringify(data));
                    console.log('‚úÖ lastSavedState –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π');
                    
                    return true;
                } else {
                    // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç baseline - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É
                    console.warn('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –≤ —Å—Ç–∞—Ä–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (–±–µ–∑ version), –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
                    return false;
                }
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞:', e);
                return false;
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å baseline –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–±–µ–∑ –¥–∏–∞–ª–æ–≥–æ–≤, –ø—Ä–æ—Å—Ç–æ best-effort)
        async function saveBaselineToServer(snapshot) {
            try {
                const companyParam = currentCompany ? `?company=${currentCompany}` : '';
                await fetch(`/api/gantt-state${companyParam}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(snapshot)
                });
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:', e);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å baseline-–ø–ª–∞–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞ (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
        async function loadBaselineFromServer() {
            try {
                const companyParam = currentCompany ? `?company=${currentCompany}` : '';
                const res = await fetch(`/api/gantt-state${companyParam}`);
                if (!res.ok) return;
                const data = await res.json();
                if (!data || !Array.isArray(data.tasks)) return;
                baselineSnapshot = data;
                applyBaselineToTasks();
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                updateBaselineToggleButton();
            } catch (e) {
                // —Ç–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞:', e);
            }
        }

        function showBaselineToast(message) {
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            let el = document.getElementById('baselineToast');
            if (!el) {
                el = document.createElement('div');
                el.id = 'baselineToast';
                el.className = 'baseline-toast';
                document.body.appendChild(el);
                console.log('Baseline toast element created');
            }
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –≤–∏–¥–∏–º
            el.textContent = message;
            el.style.display = 'block';
            el.classList.add('visible');
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
            if (baselineToastTimer) {
                clearTimeout(baselineToastTimer);
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            baselineToastTimer = setTimeout(() => {
                if (el) {
                    el.classList.remove('visible');
                    setTimeout(() => {
                        if (el && !el.classList.contains('visible')) {
                            el.style.display = 'none';
                        }
                    }, 300);
                }
            }, 3000);
            
            console.log('Baseline toast shown:', message);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ (–¥—É–±–ª–∏—Ä—É–µ—Ç F3)
        function toggleBaselineDisplay() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–¥–∞–Ω –ª–∏ –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω
            const hasBaseline =
                baselineSnapshot &&
                Array.isArray(baselineSnapshot.tasks) &&
                baselineSnapshot.tasks.some(t => Array.isArray(t.baselineDates) && t.baselineDates.length > 0);

            if (!hasBaseline) {
                if (isViewMode) {
                    showBaselineToast('–î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω –Ω–µ –∑–∞–¥–∞–Ω. –í —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–ª–∞–Ω–∞.');
                } else {
                    showBaselineToast('–ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω –Ω–µ –∑–∞–¥–∞–Ω. –ù–∞–∂–º–∏—Ç–µ F2, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –∫–∞–∫ –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π.');
                }
                return;
            }

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            showBaseline = !showBaseline;
            updateBaselineToggleButton();
            renderGantt();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ "–î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω"
        function updateBaselineToggleButton() {
            const btn = document.getElementById('baselineToggleBtn');
            if (!btn) return;
            
            if (showBaseline) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∞–∑–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞ (–¥—É–±–ª–∏—Ä—É–µ—Ç F2)
        function setBaselinePlan() {
            if (!canEdit()) {
                showBaselineToast('–í —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–µ–ª—å–∑—è –∑–∞–¥–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω. –ú–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ.');
                return;
            }

            const newSnapshot = buildBaselineSnapshot();
            const hasExistingBaseline =
                baselineSnapshot &&
                Array.isArray(baselineSnapshot.tasks) &&
                baselineSnapshot.tasks.some(t => Array.isArray(t.baselineDates) && t.baselineDates.length > 0);

            console.log('setBaselinePlan called. hasExistingBaseline:', hasExistingBaseline, 'baselineSnapshot:', baselineSnapshot);

            if (hasExistingBaseline) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
                openBaselineConfirmModal(newSnapshot);
            } else {
                // –ü–µ—Ä–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞
                try {
                    baselineSnapshot = newSnapshot;
                    applyBaselineToTasks();
                    saveBaselineToServer(baselineSnapshot);
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —á—Ç–æ–±—ã baselineSnapshot –ø–æ–ø–∞–ª –≤ —Ñ–∞–π–ª
                    autoSaveGanttState();
                    console.log('Calling showBaselineToast for first time from button');
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É
                    showBaselineToast('–í—ã –∑–∞–¥–∞–ª–∏ –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω. –ù–∞–∂–º–∏—Ç–µ "–î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω" –∏–ª–∏ F3 –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
                    updateBaselineToggleButton();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –±–∞–∑–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞:', error);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    showBaselineToast('–í—ã –∑–∞–¥–∞–ª–∏ –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω. –ù–∞–∂–º–∏—Ç–µ "–î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω" –∏–ª–∏ F3 –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
                    updateBaselineToggleButton();
                }
            }
        }

        function openBaselineConfirmModal(snapshotToApply) {
            const modal = document.getElementById('baselineConfirmModal');
            if (!modal) return;
            pendingBaselineSnapshot = snapshotToApply;
            modal.style.display = 'block';
        }

        function closeBaselineConfirmModal() {
            const modal = document.getElementById('baselineConfirmModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞—Ç
        function openDateValidationModal(message) {
            const modal = document.getElementById('dateValidationModal');
            const msgEl = document.getElementById('dateValidationMessage');
            if (!modal || !msgEl) return;
            msgEl.textContent = message || '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞.';
            modal.style.display = 'block';
        }

        function closeDateValidationModal() {
            const modal = document.getElementById('dateValidationModal');
            if (!modal) return;
            modal.style.display = 'none';
        }

        function confirmBaselineOverwrite() {
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            if (!canEdit()) {
                showBaselineToast('–í —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–µ–ª—å–∑—è –∑–∞–¥–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω. –ú–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ.');
                pendingBaselineSnapshot = null;
                closeBaselineConfirmModal();
                return;
            }

            if (pendingBaselineSnapshot) {
                try {
                    baselineSnapshot = pendingBaselineSnapshot;
                    applyBaselineToTasks();
                    saveBaselineToServer(baselineSnapshot);
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —á—Ç–æ–±—ã baselineSnapshot –ø–æ–ø–∞–ª –≤ —Ñ–∞–π–ª
                    autoSaveGanttState();
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É
                    showBaselineToast('–ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω. –ù–∞–∂–º–∏—Ç–µ "–î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω" –∏–ª–∏ F3 –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
                    updateBaselineToggleButton();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ –±–∞–∑–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞:', error);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    showBaselineToast('–ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω. –ù–∞–∂–º–∏—Ç–µ "–î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω" –∏–ª–∏ F3 –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
                    updateBaselineToggleButton();
                }
            }
            pendingBaselineSnapshot = null;
            closeBaselineConfirmModal();
        }

        function cancelBaselineOverwrite() {
            pendingBaselineSnapshot = null;
            closeBaselineConfirmModal();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStatistics() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç—Ç–∞–ø–æ–≤ –∏–∑ —Ä–µ–¥–∞–∫—Ü–∏–∏ —ç—Ç–∞–ø–æ–≤ (stageConfig), –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è
            document.getElementById('totalStages').textContent = stageConfig.length;
            document.getElementById('totalTasks').textContent = tasks.length;
            
            // –ü–æ–¥—Å—á–µ—Ç —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –ø–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—é –∏–∑ –ì–∞–Ω—Ç–∞ (–º–µ–∂–¥—É –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç–æ–π –Ω–∞—á–∞–ª–∞ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç–æ–π –æ–∫–æ–Ω—á–∞–Ω–∏—è)
            // –ò—Å–∫–ª—é—á–∞–µ–º –¥–Ω–∏, –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ –≤—ã—Ö–æ–¥–Ω—ã–µ (weekend-manual) –≤—Ä—É—á–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
            let totalDays = 0;
            if (tasks.length > 0) {
                // –ù–∞—Ö–æ–¥–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∑–∞–¥–∞—á
                let minStartDate = null;
                // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∑–∞–¥–∞—á
                let maxEndDate = null;
                
                tasks.forEach(task => {
                    if (task.startDate) {
                        const startDate = new Date(task.startDate);
                        if (!minStartDate || startDate < minStartDate) {
                            minStartDate = startDate;
                        }
                    }
                    if (task.endDate) {
                        const endDate = new Date(task.endDate);
                        if (!maxEndDate || endDate > maxEndDate) {
                            maxEndDate = endDate;
                        }
                    }
                });
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–±–µ –¥–∞—Ç—ã, —Å—á–∏—Ç–∞–µ–º —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏ –º–µ–∂–¥—É –Ω–∏–º–∏, –∏—Å–∫–ª—é—á–∞—è –¥–Ω–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "weekend-manual"
                if (minStartDate && maxEndDate) {
                    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–Ω–∏, –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ –≤—ã—Ö–æ–¥–Ω—ã–µ –≤–æ –≤—Å–µ—Ö –∑–∞–¥–∞—á–∞—Ö
                    const weekendManualDates = new Set();
                    tasks.forEach(task => {
                        if (task.dateStatuses) {
                            Object.keys(task.dateStatuses).forEach(dateKey => {
                                if (task.dateStatuses[dateKey] === 'weekend-manual') {
                                    weekendManualDates.add(dateKey);
                                }
                            });
                        }
                    });
                    
                    // –°—á–∏—Ç–∞–µ–º —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏, –∏—Å–∫–ª—é—á–∞—è –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏
                    const workdays = getWorkdaysBetweenExcludingWeekends(minStartDate, maxEndDate, weekendManualDates);
                    totalDays = workdays.length;
                    
                    // –†–∞—Å—á–µ—Ç –Ω–µ–¥–µ–ª—å –∏ –º–µ—Å—è—Ü–µ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç –≤ –ì–∞–Ω—Ç–µ
                    // (–æ—Ç —Å–∞–º–æ–π —Ä–∞–Ω–Ω–µ–π –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –¥–æ —Å–∞–º–æ–π –ø–æ–∑–¥–Ω–µ–π –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è)
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –¥–æ –Ω–∞—á–∞–ª–∞ –¥–Ω—è –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
                    const startDate = new Date(minStartDate);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(maxEndDate);
                    endDate.setHours(0, 0, 0, 0);
                    
                    // –†–∞–∑–Ω–∏—Ü–∞ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω—è—Ö –º–µ–∂–¥—É –¥–∞—Ç–∞–º–∏ (–≤–∫–ª—é—á–∞—è –æ–±–µ –¥–∞—Ç—ã)
                    const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                    
                    // –ù–µ–¥–µ–ª–∏: –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –¥–Ω–∏ / 7 (–æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞)
                    // –°—á–∏—Ç–∞–µ–º –æ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –≤ –ì–∞–Ω—Ç–µ, –∞ –Ω–µ –æ—Ç —Å—É–º–º—ã —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
                    const totalWeeks = Math.round(daysDiff / 7);
                    
                    // –ú–µ—Å—è—Ü—ã: –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –¥–Ω–∏ / 30.44 (—Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ), –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞
                    const totalMonths = Math.round(daysDiff / 30.44);
                    
                    document.getElementById('totalWeeks').textContent = totalWeeks;
                    document.getElementById('totalMonths').textContent = totalMonths;
                } else {
                    document.getElementById('totalWeeks').textContent = '0';
                    document.getElementById('totalMonths').textContent = '0';
                }
            } else {
                document.getElementById('totalWeeks').textContent = '0';
                document.getElementById('totalMonths').textContent = '0';
            }
            document.getElementById('totalDays').textContent = totalDays;

            if (tasks.length > 0) {
                const lastTask = tasks[tasks.length - 1];
                const completionDate = new Date(lastTask.endDate);
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('completionDate').textContent = 
                    completionDate.toLocaleDateString('ru-RU', options);
            }

        }


        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ø—Ä–∏–º–µ–Ω–∏—Ç—å —à–∏—Ä–∏–Ω—É –∫ —ç–ª–µ–º–µ–Ω—Ç—É –∫–æ–ª–æ–Ω–∫–∏
        function applyColumnWidth(element, key) {
            if (!element || !ganttColumnWidths[key]) return;
            
            // –î–ª—è –∫–æ–ª–æ–Ω–æ–∫ "–°–≤—è–∑—å" –∏ "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" CSS —É–ø—Ä–∞–≤–ª—è–µ—Ç —à–∏—Ä–∏–Ω–æ–π —á–µ—Ä–µ–∑ –∞–Ω–∏–º–∞—Ü–∏—é
            // –ù–µ –ø—Ä–∏–º–µ–Ω—è–µ–º –∏–Ω–ª–∞–π–Ω-—Å—Ç–∏–ª–∏, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å CSS –∞–Ω–∏–º–∞—Ü–∏—é
            if (key === 'link' || key === 'responsible') {
                return;
            }
            
            const w = ganttColumnWidths[key];
            element.style.width = w + 'px';
            element.style.minWidth = w + 'px';
            element.style.maxWidth = w + 'px';
            element.style.flex = `0 0 ${w}px`;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ—Å–∞–π–∑–µ—Ä–∞ –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏
        function addColumnResizer(element, key) {
            if (!element) return;
            element.classList.add('gantt-resizable');
            const resizer = document.createElement('div');
            resizer.className = 'gantt-resizer';
            resizer.dataset.columnKey = key;

            let startX = 0;
            let startWidth = 0;

            function onMouseMove(e) {
                const delta = e.clientX - startX;
                const newWidth = Math.max(80, Math.min(500, startWidth + delta));
                ganttColumnWidths[key] = newWidth;
                renderGantt();
            }

            function onMouseUp() {
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('mouseup', onMouseUp);
            }

            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();
                startX = e.clientX;
                startWidth = ganttColumnWidths[key] || element.getBoundingClientRect().width;
                window.addEventListener('mousemove', onMouseMove);
                window.addEventListener('mouseup', onMouseUp);
            });

            element.appendChild(resizer);
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ–º –∫–æ–ª–æ–Ω–æ–∫ (–∑–∞–¥–∞—á–∞ + –¥–∞—Ç—ã + –¥–Ω–∏ + —Å–≤—è–∑—å/–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π)
       function updateStickyColumns() {
            const chart = document.getElementById('ganttChart');
            if (!chart) return;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ DOM –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω
            requestAnimationFrame(() => {
                const allSelectors = [
                    '.gantt-header-label',
                    '.gantt-label',
                    '.gantt-details-cell.start-col',
                    '.gantt-details-cell.end-col',
                    '.gantt-details-cell.days-col',
                    '.gantt-details-cell.link-cell',
                    '.gantt-details-cell.responsible-cell'
                ];

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ—à–ª—ã–µ —Å—Ç–∏–ª–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è
                chart.querySelectorAll(allSelectors.join(',')).forEach((el) => {
                    el.style.position = '';
                    el.style.left = '';
                    el.style.zIndex = '';
                    el.style.clipPath = '';
                    el.style.background = '';
                });

                const getWidth = (selector, fallback) => {
                    const el = chart.querySelector(selector);
                    if (el) {
                        const rect = el.getBoundingClientRect();
                        if (rect.width) return rect.width;
                    }
                    return fallback || 0;
                };

                const labelWidth = ganttColumnWidths.label || getWidth('.gantt-header-label', 180);
                const startWidth = ganttColumnWidths.start || getWidth('.gantt-details-cell.start-col', 120);
                const endWidth = ganttColumnWidths.end || getWidth('.gantt-details-cell.end-col', 120);
                const daysWidth = ganttColumnWidths.days || getWidth('.gantt-details-cell.days-col', 90);
                const linkWidth = getWidth('.gantt-details-cell.link-cell', 70);
                const respWidth = getWidth('.gantt-details-cell.responsible-cell', 200);

                let left = 0;

                const columns = [
                    { key: 'label', selector: '.gantt-header-label, .gantt-label', width: labelWidth, visible: stickyColumns.has('label') },
                    { key: 'start', selector: '.gantt-details-cell.start-col', width: startWidth, visible: stickyColumns.has('start') },
                    { key: 'end', selector: '.gantt-details-cell.end-col', width: endWidth, visible: stickyColumns.has('end') },
                    { key: 'days', selector: '.gantt-details-cell.days-col', width: daysWidth, visible: stickyColumns.has('days') },
                    { key: 'link', selector: '.gantt-details-cell.link-cell', width: linkWidth, visible: stickyColumns.has('link') && document.body.classList.contains('show-link') },
                    { key: 'responsible', selector: '.gantt-details-cell.responsible-cell', width: respWidth, visible: stickyColumns.has('responsible') && document.body.classList.contains('show-responsible') },
                ];

                const applyLeft = (selector, z) => {
                    // –ü–æ–ª—É—á–∞–µ–º computed background –æ–¥–∏–Ω —Ä–∞–∑
                    const rootStyle = getComputedStyle(document.documentElement);
                    let bgColor = rootStyle.getPropertyValue('--color-bg').trim();
                    if (!bgColor || bgColor === '') {
                        // Fallback –Ω–∞ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç –∏–∑ body
                        bgColor = getComputedStyle(document.body).backgroundColor || '#f5f5f5';
                    }
                    
                    const elements = chart.querySelectorAll(selector);
                    if (elements.length === 0) {
                        console.warn(`‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞: ${selector}`);
                        return;
                    }
                    
                    console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${elements.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞: ${selector}, left: ${left}px`);
                    
                    elements.forEach((el) => {
                        el.style.position = 'sticky';
                        el.style.left = `${left}px`;
                        el.style.zIndex = z;
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º background —è–≤–Ω–æ –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤, —á—Ç–æ–±—ã sticky —Ä–∞–±–æ—Ç–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ
                        el.style.background = bgColor;
                        el.style.backgroundColor = bgColor;
                        // –£–±–∏—Ä–∞–µ–º clipPath, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é
                        el.style.clipPath = '';
                        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –≤–∏–¥–µ–Ω
                        el.style.visibility = 'visible';
                        el.style.opacity = '1';
                    });
                };
                
                const resetSticky = (selector) => {
                    chart.querySelectorAll(selector).forEach((el) => {
                        el.style.position = '';
                        el.style.left = '';
                        el.style.zIndex = '';
                        el.style.background = '';
                        el.style.clipPath = '';
                    });
                };

                columns.forEach((col) => {
                    if (!col.visible) {
                        resetSticky(col.selector);
                        return;
                    }
                    applyLeft(col.selector, col.key === 'label' ? 11 : 7);
                    left += col.width;
                });

                chart.classList.toggle('has-sticky-columns', left > 0);
                chart.style.setProperty('--sticky-left-width', `${left}px`);
                
                console.log(`‚úÖ updateStickyColumns –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ —Å—Ç–æ–ª–±—Ü–æ–≤: ${left > 0 ? '–¥–∞' : '–Ω–µ—Ç'}, –æ–±—â–∞—è —à–∏—Ä–∏–Ω–∞: ${left}px`);
            });
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è
        function updateStickyButtons() {
            const map = {
                label: 'stickyLabelToggle',
                start: 'stickyStartToggle',
                end: 'stickyEndToggle',
                days: 'stickyDaysToggle',
                link: 'stickyLinkToggle',
                responsible: 'stickyResponsibleToggle'
            };
            Object.entries(map).forEach(([key, id]) => {
                const input = document.getElementById(id);
                if (!input) return;
                const isActive = stickyColumns.has(key);
                input.checked = isActive;
                const wrapper = input.closest('.header-sticky-toggle');
                if (wrapper) {
                    wrapper.classList.toggle('active', isActive);
                }
            });
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–ª–æ–Ω–∫–∏
        function toggleStickyColumn(columnKey) {
            if (stickyColumns.has(columnKey)) {
                stickyColumns.delete(columnKey);
            } else {
                stickyColumns.add(columnKey);
            }
            updateStickyButtons();
            updateStickyColumns();
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∏–º–≤–æ–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–µ—â–∞—é—Ç—Å—è –≤ —à–∏—Ä–∏–Ω—É
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –µ–≥–æ –∫–∞–∂–¥—ã–π —Ä–∞–∑
        let measureElement = null;
        function getMeasureElement() {
            if (!measureElement) {
                measureElement = document.createElement('span');
                measureElement.style.position = 'absolute';
                measureElement.style.visibility = 'hidden';
                measureElement.style.whiteSpace = 'nowrap';
                measureElement.style.fontSize = '11px';
                measureElement.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                measureElement.style.fontWeight = '500';
                document.body.appendChild(measureElement);
            }
            return measureElement;
        }

        function calculateVisibleChars(text, maxWidth, fontSize = 11, fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif') {
            if (!text || text.length === 0) return 0;
            
            const measureEl = getMeasureElement();
            measureEl.style.fontSize = fontSize + 'px';
            measureEl.style.fontFamily = fontFamily;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–º–µ—â–∞–µ—Ç—Å—è –ª–∏ –≤–µ—Å—å —Ç–µ–∫—Å—Ç
            measureEl.textContent = text;
            const fullWidth = measureEl.offsetWidth;
            
            // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø–æ–º–µ—â–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª–Ω—É—é –¥–ª–∏–Ω—É
            if (fullWidth <= maxWidth) {
                return text.length;
            }
            
            // –ë–∏–Ω–∞—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∏–º–≤–æ–ª–æ–≤
            let left = 0;
            let right = text.length;
            let result = 0;
            
            while (left <= right) {
                const mid = Math.floor((left + right) / 2);
                const testText = text.substring(0, mid);
                
                measureEl.textContent = testText;
                const testWidth = measureEl.offsetWidth;
                
                if (testWidth <= maxWidth) {
                    result = mid;
                    left = mid + 1;
                } else {
                    right = mid - 1;
                }
            }
            
            return result;
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ –≤ –ª–µ–≤–æ–π –∫–æ–ª–æ–Ω–∫–µ (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        function renderTaskLabelContent(labelElement, task, index) {
            labelElement.innerHTML = '';
            const taskName = task.task || task.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º data-tooltip —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∑–∞–¥–∞—á–∏
            // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º HTML-—Å—É—â–Ω–æ—Å—Ç–∏, —Ç–∞–∫ –∫–∞–∫ CSS attr() –∏—Ö –Ω–µ –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç
            // setAttribute –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è HTML-–∞—Ç—Ä–∏–±—É—Ç–æ–≤
            if (taskName && taskName.trim()) {
                labelElement.setAttribute('data-tooltip', taskName);
            } else {
                labelElement.removeAttribute('data-tooltip');
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —à–∏—Ä–∏–Ω—É —Å—Ç–æ–ª–±—Ü–∞
            const columnWidth = ganttColumnWidths.label || 260;
            // –í—ã—á–∏—Ç–∞–µ–º padding (8px —Å–ª–µ–≤–∞ + 10px —Å–ø—Ä–∞–≤–∞ = 18px) –∏ –≥—Ä–∞–Ω–∏—Ü—É (2px)
            const availableWidth = columnWidth - 18 - 2;
            
            // –í—ã—á–∏—Å–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ–º–µ—Å—Ç–∏—Ç—Å—è –≤ –¥–æ—Å—Ç—É–ø–Ω—É—é —à–∏—Ä–∏–Ω—É
            const visibleChars = calculateVisibleChars(taskName, availableWidth);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ–±—Ä–µ–∑–∞—Ç—å —Ç–µ–∫—Å—Ç
            const needsTruncation = visibleChars < taskName.length;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è
            let displayName;
            if (needsTruncation) {
                displayName = taskName.substring(0, visibleChars) + '...';
            } else {
                displayName = taskName;
            }
            
            // –ò–∫–æ–Ω–∫–∞ —Å–∞–º–æ–ª–µ—Ç–∏–∫–∞ –¥–ª—è –∑–∞–¥–∞—á "–Ω–∞ –≤—ã–µ–∑–¥–µ"
            const isOnTravel = task.onTravel === true || task.onTravel === 'true';
            if (isOnTravel) {
                const travelIcon = document.createElement('span');
                travelIcon.className = 'travel-icon-row';
                travelIcon.textContent = '‚úà';
                travelIcon.title = '–ù–∞ –≤—ã–µ–∑–¥–µ';
                travelIcon.style.marginRight = '4px';
                labelElement.appendChild(travelIcon);
            }
            
            const span = document.createElement('span');
            span.textContent = displayName;
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π title, —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É –±—Ä–∞—É–∑–µ—Ä–∞
            span.removeAttribute('title');

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–¥–∏–Ω–∞—Ä–Ω–æ–≥–æ –∫–ª–∏–∫–∞ - —Ç–æ–ª—å–∫–æ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
            const handleSingleClick = (e) => {
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ drag and drop –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ label
                if (e) {
                    e.preventDefault();
                    // –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ, —á—Ç–æ–±—ã —Å—Ç—Ä–æ–∫–∞ –º–æ–≥–ª–∞ –≤—ã–¥–µ–ª–∏—Ç—å—Å—è
                }
                
                // –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é —Å—Ç—Ä–æ–∫—É
                const row = labelElement.closest('.gantt-row');
                
                // –í—ã–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ label (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ Shift –¥–ª—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞)
                if (row && row.dataset.taskId) {
                    const taskId = parseInt(row.dataset.taskId);
                    if (taskId) {
                        if (e && e.shiftKey) {
                            selectTask(taskId, { range: true });
                        } else {
                            selectTask(taskId, { range: false });
                        }
                    }
                }
            };

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ - –æ—Ç–∫—Ä—ã—Ç–∏–µ –∏–Ω–ø—É—Ç–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const startEditing = (e) => {
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ drag and drop –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ label
                if (e) {
                    e.preventDefault();
                    e.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ –¥–ª—è –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞
                }
                
                if (!canEdit()) {
                    return; // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –ª–∏ —É–∂–µ —ç—Ç–∞ –∑–∞–¥–∞—á–∞
                if (labelElement.querySelector('input.gantt-task-input')) {
                    return; // –£–∂–µ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                }
                
                // –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é —Å—Ç—Ä–æ–∫—É
                const row = labelElement.closest('.gantt-row');
                
                // –í—ã–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                if (row && row.dataset.taskId) {
                    const taskId = parseInt(row.dataset.taskId);
                    if (taskId) {
                        selectTask(taskId, { range: false });
                    }
                }
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'gantt-task-input';
                input.value = task.task || task.name || '';

                labelElement.innerHTML = '';
                labelElement.appendChild(input);
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Ñ–æ–∫—É—Å–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å drag
                setTimeout(() => {
                    input.focus();
                    input.select();
                }, 10);

                // –û—Ç–∫–ª—é—á–∞–µ–º drag and drop –¥–ª—è —Å—Ç—Ä–æ–∫–∏
                let wasDraggable = false;
                if (row) {
                    wasDraggable = row.draggable;
                    row.draggable = false;
                }

                const finish = (save) => {
                    if (save) {
                        const newName = input.value.trim();
                        if (newName) {
                            task.task = newName;
                            task.name = newName; // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –æ–±–∞ –ø–æ–ª—è
                        }
                    }
                    
                    // –í–∫–ª—é—á–∞–µ–º drag and drop –æ–±—Ä–∞—Ç–Ω–æ
                    if (row && wasDraggable) {
                        row.draggable = true;
                    }
                    
                    renderTaskLabelContent(labelElement, task, index);
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º data-tooltip –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
                    const taskName = task.task || task.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                    if (taskName && taskName.trim()) {
                        labelElement.setAttribute('data-tooltip', taskName);
                    }
                    renderTable();
                };

                input.addEventListener('blur', () => finish(true));
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        finish(false);
                    }
                });
                
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ drag and drop –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å input
                input.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                });
                input.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                input.addEventListener('select', (e) => {
                    e.stopPropagation();
                });
            };

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–¥–∏–Ω–∞—Ä–Ω–æ–≥–æ –∫–ª–∏–∫–∞ - —Ç–æ–ª—å–∫–æ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            labelElement.addEventListener('click', handleSingleClick);
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ - –æ—Ç–∫—Ä—ã—Ç–∏–µ –∏–Ω–ø—É—Ç–∞
            labelElement.addEventListener('dblclick', startEditing);
            // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞ mousedown –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è drag
            labelElement.addEventListener('mousedown', (e) => {
                // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ input –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º drag
                if (!e.target.classList.contains('gantt-task-input') && 
                    !e.target.closest('input.gantt-task-input')) {
                    e.stopPropagation();
                }
            });

            labelElement.appendChild(span);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –ø–æ–∑–∏—Ü–∏–π –º–µ—Ç–æ–∫ —ç—Ç–∞–ø–æ–≤ (–≤—ã–Ω–µ—Å–µ–Ω–∞ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –º–æ–¥—É–ª—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ setZoom)
        function recalculateStageLabelsPositions() {
            const chartContainer = document.getElementById('ganttChart');
            if (!chartContainer) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ (DOM –≥–æ—Ç–æ–≤)
            const hasRows = chartContainer.querySelector('.gantt-row');
            if (!hasRows) {
                // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫ –µ—â–µ –Ω–µ—Ç, –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º –ø–µ—Ä–µ—Å—á–µ—Ç
                setTimeout(() => recalculateStageLabelsPositions(), 50);
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–Ω–æ–≤–æ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ DOM –∏–∑–º–µ–Ω–∏–ª—Å—è)
            const currentChartContainerParent = chartContainer.closest('.chart-container');
            const currentStageLabelsContainer = currentChartContainerParent 
                ? currentChartContainerParent.querySelector('.gantt-stage-labels')
                : chartContainer.querySelector('.gantt-stage-labels');
            
            // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤—ã—Ö–æ–¥–∏–º
            if (!currentStageLabelsContainer || !currentChartContainerParent) {
                return;
            }
            
            // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º tasksByStage –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            const tasksByStageRecalc = {};
            tasks.forEach((task, index) => {
                const stage = task.stage || '–ë–µ–∑ —ç—Ç–∞–ø–∞';
                if (!tasksByStageRecalc[stage]) {
                    tasksByStageRecalc[stage] = [];
                }
                tasksByStageRecalc[stage].push({ task, index });
            });
            
            // –í—ã—á–∏—Å–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é (–≤—ã—Å–æ—Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
            const header = document.querySelector('.gantt-header');
            const headerHeight = header ? header.offsetHeight : 80;
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–µ—Ç–æ–∫ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π
            Object.keys(tasksByStageRecalc).forEach((stageName, stageIndex) => {
                const stageTasks = tasksByStageRecalc[stageName];
                const stageLabel = currentStageLabelsContainer.querySelector(`.gantt-stage-label[data-stage-name="${stageName}"]`);
                
                if (!stageLabel) {
                    return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
                }
                
                const isStageCollapsed = collapsedStages.has(stageName);
                
                // –í—ã—á–∏—Å–ª—è–µ–º –≤—ã—Å–æ—Ç—É —ç—Ç–∞–ø–∞ (—Å—É–º–º–∞ –≤—ã—Å–æ—Ç –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ —ç—Ç–∞–ø–∞)
                let stageHeight = 0;
                let actualTop = headerHeight; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                
                if (isStageCollapsed) {
                    // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —ç—Ç–∞–ø–∞ –≤ –¥–∏–∞–≥—Ä–∞–º–º–µ –ì–∞–Ω—Ç–∞
                    const stageRow = chartContainer.querySelector(`.gantt-row[data-stage-name="${stageName}"]`);
                    if (stageRow) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º offsetTop –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ)
                        stageHeight = stageRow.offsetHeight || 35;
                        // –í—ã—á–∏—Å–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–∏–∞–≥—Ä–∞–º–º—ã
                        // –î–æ–±–∞–≤–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –≤–Ω–∏–∑ (10px) –¥–ª—è —É—á–µ—Ç–∞ padding –º–µ—Ç–∫–∏ (8px) –∏ –ª—É—á—à–µ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
                        actualTop = stageRow.offsetTop + 10;
                    } else {
                        stageHeight = 35;
                    }
                } else {
                    // –î–ª—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã—Ö —ç—Ç–∞–ø–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏ –∏ —Å—É–º–º–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—ã
                    if (stageTasks.length > 0) {
                        const firstTaskRow = chartContainer.querySelector(`.gantt-row[data-task-id="${stageTasks[0].task.id}"]`);
                        if (firstTaskRow && firstTaskRow.style.display !== 'none') {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º offsetTop –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                            // –î–æ–±–∞–≤–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –≤–Ω–∏–∑ (10px) –¥–ª—è —É—á–µ—Ç–∞ padding –º–µ—Ç–∫–∏ (8px) –∏ –ª—É—á—à–µ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
                            actualTop = firstTaskRow.offsetTop + 10;
                            
                            // –°—É–º–º–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—ã –≤—Å–µ—Ö –≤–∏–¥–∏–º—ã—Ö –∑–∞–¥–∞—á —ç—Ç–∞–ø–∞
                            stageTasks.forEach(({ task }) => {
                                const taskRow = chartContainer.querySelector(`.gantt-row[data-task-id="${task.id}"]`);
                                if (taskRow && !taskRow.classList.contains('stage-collapsed') && taskRow.style.display !== 'none') {
                                    stageHeight += (taskRow.offsetHeight || 35);
                                }
                            });
                        }
                    }
                    
                    // –ï—Å–ª–∏ –≤—ã—Å–æ—Ç–∞ –Ω–µ –≤—ã—á–∏—Å–ª–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é
                    if (stageHeight === 0) {
                        stageHeight = stageTasks.length * 35;
                    }
                }
                
                // –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –Ω–µ –≤—ã—á–∏—Å–ª–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                if (actualTop === headerHeight && stageIndex > 0) {
                    // –î–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —ç—Ç–∞–ø–æ–≤ –ø—ã—Ç–∞–µ–º—Å—è –≤—ã—á–∏—Å–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö
                    const prevStageName = Object.keys(tasksByStageRecalc)[stageIndex - 1];
                    const prevStageLabel = currentStageLabelsContainer.querySelector(`.gantt-stage-label[data-stage-name="${prevStageName}"]`);
                    if (prevStageLabel) {
                        const prevTop = parseFloat(prevStageLabel.style.top) || 0;
                        const prevHeight = parseFloat(prevStageLabel.style.height) || 35;
                        actualTop = prevTop + prevHeight + 2;
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –º–µ—Ç–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
                stageLabel.style.top = Math.max(0, actualTop) + 'px';
                stageLabel.style.height = stageHeight + 'px';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–µ—Ä–µ–¥ —ç—Ç–∞–ø–æ–º (–µ—Å–ª–∏ –µ—Å—Ç—å) - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –º–µ—Ç–∫–∏
                if (stageIndex > 0) {
                    let divider = currentChartContainerParent.querySelector(`.gantt-stage-divider[data-stage-index="${stageIndex}"]`);
                    if (!divider) {
                        // –°–æ–∑–¥–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                        divider = document.createElement('div');
                        divider.className = 'gantt-stage-divider';
                        divider.setAttribute('data-stage-index', stageIndex);
                        currentChartContainerParent.appendChild(divider);
                    }
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–∑–∏—Ü–∏—é –º–µ—Ç–∫–∏ –º–∏–Ω—É—Å 2px –¥–ª—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è
                    divider.style.top = (actualTop - 2) + 'px';
                }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç—Ç–∞–ø–∞, –µ—Å–ª–∏ –æ–Ω —Å–≤–µ—Ä–Ω—É—Ç
            const stageNames = Object.keys(tasksByStageRecalc);
            if (stageNames.length > 0) {
                const lastStageName = stageNames[stageNames.length - 1];
                const isLastStageCollapsed = collapsedStages.has(lastStageName);
                if (isLastStageCollapsed) {
                    // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç—Ç–∞–ø–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –º–µ—Ç–∫–∏
                    const lastStageLabel = currentStageLabelsContainer.querySelector(`.gantt-stage-label[data-stage-name="${lastStageName}"]`);
                    if (lastStageLabel) {
                        const lastTop = parseFloat(lastStageLabel.style.top) || 0;
                        const lastHeight = parseFloat(lastStageLabel.style.height) || 35;
                        const lastDividerTop = lastTop + lastHeight - 2;
                        
                        let lastDivider = currentChartContainerParent.querySelector('.gantt-stage-divider[data-stage-index="last"]');
                        if (!lastDivider) {
                            lastDivider = document.createElement('div');
                            lastDivider.className = 'gantt-stage-divider';
                            lastDivider.setAttribute('data-stage-index', 'last');
                            currentChartContainerParent.appendChild(lastDivider);
                        }
                        lastDivider.style.top = lastDividerTop + 'px';
                    }
                } else {
                    // –£–¥–∞–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç—Ç–∞–ø–∞, –µ—Å–ª–∏ –æ–Ω —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç
                    const lastDivider = currentChartContainerParent.querySelector('.gantt-stage-divider[data-stage-index="last"]');
                    if (lastDivider) {
                        lastDivider.remove();
                    }
                }
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–∏–∞–≥—Ä–∞–º–º—ã –ì–∞–Ω—Ç–∞
        function renderGantt() {
            const chartContainer = document.getElementById('ganttChart');
            if (!chartContainer) {
                console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç ganttChart –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM!');
                return;
            }
            chartContainer.innerHTML = '';

            if (!tasks.length) {
                console.warn('‚ö†Ô∏è –ú–∞—Å—Å–∏–≤ –∑–∞–¥–∞—á –ø—É—Å—Ç–æ–π, –≥—Ä–∞—Ñ–∏–∫ –Ω–µ –±—É–¥–µ—Ç –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω');
                return;
            }

            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç –ø—Ä–æ–µ–∫—Ç–∞
            const projectFirstDate = new Date(tasks[0].startDate);
            const realLastTaskDate = new Date(tasks[tasks.length - 1].endDate);

            // –ü—Ä–∞–≤—ã–π –∫—Ä–∞–π –ø—Ä–æ–µ–∫—Ç–∞:
            //  - –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ: –¥–æ –∫–æ–Ω—Ü–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≥–æ–¥–∞ (—Å–µ—Ä—ã–π "—Ö–≤–æ—Å—Ç")
            //  - –≤ —Ä–µ–∂–∏–º–µ —ç–∫—Å–ø–æ—Ä—Ç–∞: —Ç–æ–ª—å–∫–æ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–¥–∞—á–∏
            let projectLastDate;
            if (isExporting) {
                projectLastDate = new Date(realLastTaskDate);
            } else {
                projectLastDate = new Date(realLastTaskDate);
                const calendarEnd = new Date(realLastTaskDate.getFullYear() + 1, 11, 31); // 31 –¥–µ–∫–∞–±—Ä—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≥–æ–¥–∞
                if (calendarEnd > projectLastDate) {
                    projectLastDate = calendarEnd;
                }
            }

            // –í–∏–¥–∏–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω: –ª–∏–±–æ –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç, –ª–∏–±–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –º–µ—Å—è—Ü
            const firstDate = viewStartDate ? new Date(viewStartDate) : projectFirstDate;
            const lastDate = viewEndDate ? new Date(viewEndDate) : projectLastDate;

            // –ë–∞–∑–æ–≤–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å: –ø–∏–∫—Å–µ–ª–µ–π –Ω–∞ –¥–µ–Ω—å (—É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å –∑—É–º–æ–º)
            const pxPerDay = 4 * zoomLevel;

            // –†–µ–∂–∏–º —à–∫–∞–ª—ã –ø–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏:
            //  - –¥–Ω–∏: –∫–æ–≥–¥–∞ –¥–µ–Ω—å –∫—Ä—É–ø–Ω—ã–π (‚âà7px –∏ –±–æ–ª—å—à–µ)
            //  - –Ω–µ–¥–µ–ª–∏: —Å—Ä–µ–¥–Ω–∏–π –º–∞—Å—à—Ç–∞–± (‚âà3‚Äì7px –Ω–∞ –¥–µ–Ω—å)
            //  - –º–µ—Å—è—Ü—ã: –∫–æ–≥–¥–∞ –¥–Ω–∏ –æ—á–µ–Ω—å –ø–ª–æ—Ç–Ω—ã–µ (<3px –Ω–∞ –¥–µ–Ω—å)
            let scaleMode;
            if (pxPerDay >= 7) {
                scaleMode = 'day';
            } else if (pxPerDay >= 3) {
                scaleMode = 'week';
            } else {
                scaleMode = 'month';
            }
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –º–∞—Å—à—Ç–∞–± –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
            currentScaleMode = scaleMode;

            // –§–æ—Ä–º–∏—Ä—É–µ–º –µ–¥–∏–Ω–∏—Ü—ã –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π —à–∫–∞–ª—ã
            const timelineUnits = [];

            if (scaleMode === 'day') {
                // –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –æ—Ç–¥–µ–ª—å–Ω–æ
                let currentDate = new Date(firstDate);
                while (currentDate <= lastDate) {
                    timelineUnits.push({
                        type: 'day',
                        start: new Date(currentDate),
                        end: new Date(currentDate),
                        label: String(currentDate.getDate())
                    });
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            } else if (scaleMode === 'week') {
                // –ù–µ–¥–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø–æ 7 –¥–Ω–µ–π, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫—É (–∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –Ω–µ–¥–µ–ª–∏)
                let weekStart = new Date(firstDate);
                // –ü–µ—Ä–µ–º–∞—Ç—ã–≤–∞–µ–º –∫ –±–ª–∏–∂–∞–π—à–µ–º—É –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫—É –Ω–∞–∑–∞–¥
                while (weekStart.getDay() !== 1) { // 1 = –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
                    weekStart.setDate(weekStart.getDate() - 1);
                }

                while (weekStart <= lastDate) {
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6); // –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫‚Äì–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ

                    const labelFrom = weekStart.getDate();
                    const labelTo = weekEnd.getDate();
                    const monthNameShort = weekStart.toLocaleDateString('ru-RU', { month: 'short' });

                    // –î–ª—è –Ω–µ–¥–µ–ª—å, –≥–¥–µ –æ–±–µ –¥–∞—Ç—ã –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 3‚Äì9),
                    // –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –≤–æ–∫—Ä—É–≥ —Ç–∏—Ä–µ: "3 - 9".
                    // –î–ª—è 6‚Äì12, 20‚Äì26 –∏ —Ç.–ø. —Ñ–æ—Ä–º–∞—Ç –æ—Å—Ç–∞—ë—Ç—Å—è "6-12", "20-26".
                    const rangeCompact = `${labelFrom}-${labelTo}`;
                    const rangeWithSpaces = `${labelFrom} - ${labelTo}`;
                    const daysLabel = (labelFrom < 10 && labelTo < 10) ? rangeWithSpaces : rangeCompact;

                    timelineUnits.push({
                        type: 'week',
                        start: new Date(weekStart),
                        end: new Date(weekEnd),
                        label: `${daysLabel} ${monthNameShort}`,
                        daysLabel,
                        monthLabel: monthNameShort
                    });

                    weekStart.setDate(weekStart.getDate() + 7);
                }
            } else {
                // –ü–æ –º–µ—Å—è—Ü–∞–º
                let current = new Date(firstDate.getFullYear(), firstDate.getMonth(), 1);
                while (current <= lastDate) {
                    const y = current.getFullYear();
                    const m = current.getMonth();
                    const monthStart = new Date(y, m, 1);
                    let monthEnd = new Date(y, m + 1, 0);
                    if (monthStart < firstDate) monthStart.setTime(firstDate.getTime());
                    if (monthEnd > lastDate) monthEnd.setTime(lastDate.getTime());

                    const monthName = current.toLocaleDateString('ru-RU', { month: 'long' });

                    timelineUnits.push({
                        type: 'month',
                        start: monthStart,
                        end: monthEnd,
                        label: `${monthName} ${y}`
                    });

                    current.setMonth(current.getMonth() + 1);
                }
            }

            const msInDay = 24 * 60 * 60 * 1000;

            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –æ—Å–Ω–æ–≤–Ω–æ–π —à–∫–∞–ª–æ–π
            const header = document.createElement('div');
            header.className = 'gantt-header';

            // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ (label + details header)
            const headerFirstRow = document.createElement('div');
            headerFirstRow.className = 'gantt-header-first-row';
            headerFirstRow.style.display = 'flex';

            const headerLabel = document.createElement('div');
            headerLabel.className = 'gantt-header-label';
            headerLabel.innerHTML = `
                <label class="header-sticky-toggle" data-tooltip="–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü '–ó–∞–¥–∞—á–∞'">
                    <input type="checkbox" id="stickyLabelToggle" onchange="toggleStickyColumn('label')">
                    <span class="header-sticky-switch"></span>
                </label>
                <span class="header-label-text">–ó–∞–¥–∞—á–∞</span>
            `;
            applyColumnWidth(headerLabel, 'label');
            addColumnResizer(headerLabel, 'label');
            headerFirstRow.appendChild(headerLabel);

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫: –¥–∞—Ç—ã –∏ —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏
            const detailsHeader = document.createElement('div');
            detailsHeader.className = 'gantt-details-header';
            detailsHeader.innerHTML = `
                <div class="gantt-details-cell start-col">
                    <label class="header-sticky-toggle" data-tooltip="–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'">
                        <input type="checkbox" id="stickyStartToggle" onchange="toggleStickyColumn('start')">
                        <span class="header-sticky-switch"></span>
                    </label>
                    <span class="header-label-text">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</span>
                </div>
                <div class="gantt-details-cell end-col">
                    <label class="header-sticky-toggle" data-tooltip="–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è'">
                        <input type="checkbox" id="stickyEndToggle" onchange="toggleStickyColumn('end')">
                        <span class="header-sticky-switch"></span>
                    </label>
                    <span class="header-label-text">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</span>
                </div>
                <div class="gantt-details-cell days-col">
                    <label class="header-sticky-toggle" data-tooltip="–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü '–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π'">
                        <input type="checkbox" id="stickyDaysToggle" onchange="toggleStickyColumn('days')">
                        <span class="header-sticky-switch"></span>
                    </label>
                    <span class="header-label-text">–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π</span>
                </div>
                <div class="gantt-details-cell link-cell">
                    <label class="header-sticky-toggle" data-tooltip="–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü '–°–≤—è–∑—å'">
                        <input type="checkbox" id="stickyLinkToggle" onchange="toggleStickyColumn('link')">
                        <span class="header-sticky-switch"></span>
                    </label>
                    <span class="header-label-text">–°–≤—è–∑—å</span>
                </div>
                <div class="gantt-details-cell responsible-cell">
                    <label class="header-sticky-toggle" data-tooltip="–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'">
                        <input type="checkbox" id="stickyResponsibleToggle" onchange="toggleStickyColumn('responsible')">
                        <span class="header-sticky-switch"></span>
                    </label>
                    <span class="header-label-text">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</span>
                </div>
            `;

            const headerCells = detailsHeader.querySelectorAll('.gantt-details-cell');
            if (headerCells[0]) {
                applyColumnWidth(headerCells[0], 'start');
                addColumnResizer(headerCells[0], 'start');
            }
            if (headerCells[1]) {
                applyColumnWidth(headerCells[1], 'end');
                addColumnResizer(headerCells[1], 'end');
            }
            if (headerCells[2]) {
                applyColumnWidth(headerCells[2], 'days');
            }
            if (headerCells[3]) {
                applyColumnWidth(headerCells[3], 'responsible');
            }

            headerFirstRow.appendChild(detailsHeader);
            header.appendChild(headerFirstRow);

            const datesRow = document.createElement('div');
            datesRow.className = 'gantt-header-dates-row';

            timelineUnits.forEach((unit, unitIdx) => {
                const cell = document.createElement('div');
                cell.className = 'gantt-header-cell';
                const unitDays = Math.round((unit.end - unit.start) / msInDay) + 1;
                const width = Math.max(30, unitDays * pxPerDay);
                cell.style.minWidth = width + 'px';
                cell.style.width = width + 'px';

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–æ–¥–ø–∏—Å–∏ —à–∫–∞–ª—ã
                if (scaleMode === 'week' && unit.type === 'week' && unit.daysLabel && unit.monthLabel) {
                    const daysSpan = document.createElement('span');
                    daysSpan.className = 'gantt-header-week-days';
                    daysSpan.textContent = unit.daysLabel;

                    const monthSpan = document.createElement('span');
                    monthSpan.className = 'gantt-header-week-month';
                    monthSpan.textContent = unit.monthLabel;

                    cell.appendChild(daysSpan);
                    cell.appendChild(monthSpan);
                } else {
                    cell.textContent = unit.label;
                }

                const isFutureUnit = unit.start > realLastTaskDate;

                if (scaleMode === 'day') {
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö –∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ —Ç–æ–ª—å–∫–æ –≤ –¥–Ω–µ–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ
                    cell.title = unit.start.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' });
                    const key = formatDateKey(unit.start);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                    if (customCalendar[key]) {
                        if (customCalendar[key] === 'holiday') {
                            cell.classList.add('gantt-holiday');
                        } else {
                            // –†–∞–±–æ—á–∏–π –¥–µ–Ω—å - —É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å—ã –≤—ã—Ö–æ–¥–Ω—ã—Ö
                            cell.classList.remove('gantt-holiday', 'gantt-weekend');
                        }
                    } else if (!isWorkday(unit.start)) {
                        // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤
                        cell.classList.add(holidays.includes(key) ? 'gantt-holiday' : 'gantt-weekend');
                    } else {
                        // –†–∞–±–æ—á–∏–π –¥–µ–Ω—å - —É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å—ã –≤—ã—Ö–æ–¥–Ω—ã—Ö
                        cell.classList.remove('gantt-holiday', 'gantt-weekend');
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–Ω—è (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
                    if (canEdit()) {
                        cell.style.cursor = 'pointer';
                        cell.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const dateKey = formatDateKey(unit.start);
                            const rect = cell.getBoundingClientRect();
                            openDayStatusMenu(rect.left + rect.width / 2, rect.bottom + 5, dateKey, cell);
                        });
                    }
                } else if (scaleMode === 'week') {
                    const fromStr = unit.start.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' });
                    const toStr = unit.end.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' });
                    cell.title = `${fromStr} ‚Äî ${toStr}`;
                } else {
                    const fromStr = unit.start.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' });
                    const toStr = unit.end.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' });
                    cell.title = `${fromStr} ‚Äî ${toStr}`;
                }

                if (isFutureUnit) {
                    cell.classList.add('gantt-future-header');
                }

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞—Ç—ã –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
                cell.setAttribute('data-start-date', unit.start.toISOString());
                cell.setAttribute('data-end-date', unit.end.toISOString());

                // –ö–ª–∏–∫ –ø–æ –º–µ—Å—è—Ü—É –≤ —Ä–µ–∂–∏–º–µ –º–µ—Å—è—Ü–µ–≤: –∑—É–º –¥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞
                if (scaleMode === 'month' && unit.type === 'month') {
                    cell.style.cursor = 'pointer';
                    cell.addEventListener('click', () => {
                        // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü —Ü–µ–ª–∏–∫–æ–º
                        viewStartDate = new Date(unit.start.getFullYear(), unit.start.getMonth(), 1);
                        viewEndDate = new Date(unit.start.getFullYear(), unit.start.getMonth() + 1, 0);
                        // —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± –¥–æ –¥–Ω–µ–≤–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è
                        setZoom(2); // max –∑—É–º ‚Üí —Ç–æ—á–Ω–æ —Ä–µ–∂–∏–º –¥–Ω–µ–π
                    });
                }

                datesRow.appendChild(cell);
            });

            header.appendChild(datesRow);

            chartContainer.appendChild(header);

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ —ç—Ç–∞–ø–∞–º
            const tasksByStage = {};
            tasks.forEach((task, index) => {
                const stage = task.stage || '–ë–µ–∑ —ç—Ç–∞–ø–∞';
                if (!tasksByStage[stage]) {
                    tasksByStage[stage] = [];
                }
                tasksByStage[stage].push({ task, index });
            });

            // –ü–æ–ª—É—á–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            const chartContainerParent = chartContainer.closest('.chart-container');
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–µ—Ç–æ–∫ –∏ –≤—Å–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
            if (chartContainerParent) {
                const oldLabelsContainer = chartContainerParent.querySelector('.gantt-stage-labels');
                if (oldLabelsContainer) {
                    oldLabelsContainer.remove();
                }
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
                const oldDividers = chartContainerParent.querySelectorAll('.gantt-stage-divider');
                oldDividers.forEach(divider => divider.remove());
            } else {
                // Fallback: –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω .chart-container, –∏—â–µ–º –≤ chartContainer
                const oldLabelsContainer = chartContainer.querySelector('.gantt-stage-labels');
                if (oldLabelsContainer) {
                    oldLabelsContainer.remove();
                }
            }

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å
            if (chartContainerParent) {
                const oldControlsContainer = chartContainerParent.querySelector('.gantt-stage-controls');
                if (oldControlsContainer) {
                    oldControlsContainer.remove();
                }
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–µ—Ç–æ–∫ —ç—Ç–∞–ø–æ–≤
            const stageLabelsContainer = document.createElement('div');
            stageLabelsContainer.className = 'gantt-stage-labels';
            // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –≤ .chart-container, —á—Ç–æ–±—ã –æ–Ω–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–ª–∏—Å—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–µ–≥–æ
            if (chartContainerParent) {
                chartContainerParent.appendChild(stageLabelsContainer);
                
                // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–Ω–∞–¥ –º–µ—Ç–∫–∞–º–∏ —ç—Ç–∞–ø–æ–≤)
                const controlsContainer = document.createElement('div');
                controlsContainer.className = 'gantt-stage-controls';
                
                // –ö–Ω–æ–ø–∫–∞ "+" –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
                const collapseBtn = document.createElement('button');
                collapseBtn.className = 'gantt-stage-control-btn';
                collapseBtn.textContent = '+';
                collapseBtn.title = '–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ —ç—Ç–∞–ø—ã';
                collapseBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    collapseAllStages();
                });
                
                // –ö–Ω–æ–ø–∫–∞ "-" –¥–ª—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
                const expandBtn = document.createElement('button');
                expandBtn.className = 'gantt-stage-control-btn';
                expandBtn.textContent = '‚àí';
                expandBtn.title = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ —ç—Ç–∞–ø—ã';
                expandBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    expandAllStages();
                });
                
                controlsContainer.appendChild(collapseBtn);
                controlsContainer.appendChild(expandBtn);
                chartContainerParent.appendChild(controlsContainer);
            } else {
                // Fallback: –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω .chart-container, –¥–æ–±–∞–≤–ª—è–µ–º –≤ chartContainer
                chartContainer.appendChild(stageLabelsContainer);
            }

            const rowHeight = 35; // –í—ã—Å–æ—Ç–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –∑–∞–¥–∞—á–∏ (min-height –∏–∑ CSS)

            // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∑–∞–¥–∞—á–∏ –ø–æ —ç—Ç–∞–ø–∞–º (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
            Object.keys(tasksByStage).forEach((stageName, stageIndex) => {
                const stageTasks = tasksByStage[stageName];
                const isStageCollapsed = collapsedStages.has(stageName);

                // –ï—Å–ª–∏ —ç—Ç–∞–ø —Å–≤–µ—Ä–Ω—É—Ç, —Å–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É —ç—Ç–∞–ø–∞ –≤–º–µ—Å—Ç–æ –≤—Å–µ—Ö –∑–∞–¥–∞—á
                if (isStageCollapsed) {
                    const stageRow = createStageRow(stageName, stageTasks, stageIndex, timelineUnits, pxPerDay, ganttBarStyle);
                    chartContainer.appendChild(stageRow);
                    return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É –∑–∞–¥–∞—á —ç—Ç–∞–ø–∞
                }

                // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞
                stageTasks.forEach(({ task, index }) => {
                const row = document.createElement('div');
                row.className = 'gantt-row';
                row.dataset.taskId = String(task.id);
                
                // –ï—Å–ª–∏ —ç—Ç–∞–ø —Å–≤–µ—Ä–Ω—É—Ç, —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –∑–∞–¥–∞—á
                if (isStageCollapsed) {
                    row.classList.add('stage-collapsed');
                }

                // –°—Ç–∞—Ç—É—Å —Å—Ç—Ä–æ–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç—Ç–∞–ø–∞
                if (currentStageFilter !== 'all') {
                    if (isTaskInCurrentStage(task)) {
                        row.classList.add('stage-active');
                    } else {
                        row.classList.add('inactive');
                    }
                }

                // Drag & drop –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –∑–∞–¥–∞—á)
                row.draggable = true;
                row.addEventListener('dragstart', (e) => {
                    // –ù–µ –Ω–∞—á–∏–Ω–∞–µ–º drag, –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –Ω–∞ label, input –∏–ª–∏ bar
                    const target = e.target;
                    if (target && (
                        target.closest('.gantt-label') || 
                        target.classList.contains('gantt-task-input') ||
                        target.closest('input.gantt-task-input') ||
                        target.closest('.gantt-bar') ||
                        target.classList.contains('gantt-bar')
                    )) {
                        e.preventDefault();
                        return;
                    }
                    
                    // –ï—Å–ª–∏ –Ω–∞—á–∞—Ç–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –±–∞—Ä–∞, –Ω–µ –Ω–∞—á–∏–Ω–∞–µ–º drag —Å—Ç—Ä–æ–∫–∏
                    if (draggingBarTaskId !== null && draggingBarTaskId !== undefined) {
                        e.preventDefault();
                        return;
                    }
                    
                    draggingTaskId = task.id;
                    row.classList.add('dragging');
                    if (e.dataTransfer) {
                        e.dataTransfer.effectAllowed = 'move';
                    }
                });

                row.addEventListener('dragend', () => {
                    draggingTaskId = null;
                    row.classList.remove('dragging');
                    document.querySelectorAll('.gantt-row-drop-target').forEach(el => el.classList.remove('gantt-row-drop-target'));
                });

                const label = document.createElement('div');
                label.className = 'gantt-label';
                applyColumnWidth(label, 'label');
                renderTaskLabelContent(label, task, index);
                
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –Ω–∞—á–∞–ª–æ drag –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ label (–ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è label)
                // –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ, —á—Ç–æ–±—ã —Å—Ç—Ä–æ–∫–∞ –º–æ–≥–ª–∞ –≤—ã–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ
                label.addEventListener('mousedown', (e) => {
                    // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ input –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º drag, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–ª–∏–∫
                    if (!e.target.classList.contains('gantt-task-input') && 
                        !e.target.closest('input.gantt-task-input')) {
                        // –¢–æ–ª—å–∫–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º drag, –Ω–æ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
                    }
                });
                
                row.appendChild(label);

                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ "–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ / –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è / –†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π"
                const detailsRow = document.createElement('div');
                detailsRow.className = 'gantt-details-row';

                const startCell = document.createElement('div');
                startCell.className = 'gantt-details-cell start-col';
                const startInput = document.createElement('input');
                startInput.type = 'date';
                startInput.className = 'gantt-details-input';
                startInput.value = task.startDate ? formatDateForInput(task.startDate) : '';
                startInput.setAttribute('data-index', index);
                startInput.setAttribute('data-field', 'startDate');
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                if (isViewMode) {
                    startInput.setAttribute('readonly', 'readonly');
                } else {
                    startInput.addEventListener('change', onTaskTableInputChange);
                }
                startCell.appendChild(startInput);
                applyColumnWidth(startCell, 'start');

                const endCell = document.createElement('div');
                endCell.className = 'gantt-details-cell end-col';
                const endInput = document.createElement('input');
                endInput.type = 'date';
                endInput.className = 'gantt-details-input';
                endInput.value = task.endDate ? formatDateForInput(task.endDate) : '';
                endInput.setAttribute('data-index', index);
                endInput.setAttribute('data-field', 'endDate');
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                if (isViewMode) {
                    endInput.setAttribute('readonly', 'readonly');
                } else {
                    endInput.addEventListener('change', onTaskTableInputChange);
                }
                endCell.appendChild(endInput);
                applyColumnWidth(endCell, 'end');

                const daysCell = document.createElement('div');
                daysCell.className = 'gantt-details-cell days-col';
                const daysInput = document.createElement('input');
                daysInput.type = 'number';
                daysInput.min = '0';
                daysInput.className = 'gantt-details-input';
                daysInput.value = task.days;
                daysInput.setAttribute('data-index', index);
                daysInput.setAttribute('data-field', 'days');
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                if (isViewMode) {
                    daysInput.setAttribute('readonly', 'readonly');
                } else {
                    daysInput.addEventListener('change', onTaskTableInputChange);
                }
                daysCell.appendChild(daysInput);
                applyColumnWidth(daysCell, 'days');

                detailsRow.appendChild(startCell);
                detailsRow.appendChild(endCell);
                detailsRow.appendChild(daysCell);

                // –Ø—á–µ–π–∫–∞ "–°–≤—è–∑—å" –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
                const linkCell = document.createElement('div');
                linkCell.className = 'gantt-details-cell link-cell';
                const linkSelect = document.createElement('select');
                linkSelect.className = 'gantt-details-input link-select';
                linkSelect.setAttribute('data-index', index);
                linkSelect.setAttribute('data-field', 'link');
                
                // –û–ø—Ü–∏–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ (–±–µ–∑ –ø—É—Å—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è)
                const options = [
                    { value: '–û_–ù', text: '–û_–ù', tooltip: '–æ–∫–æ–Ω—á–∞–Ω–∏–µ - –Ω–∞—á–∞–ª–æ' },
                    { value: '–ù_–ù', text: '–ù_–ù', tooltip: '–Ω–∞—á–∞–ª–æ - –Ω–∞—á–∞–ª–æ' },
                    { value: '–û_–û', text: '–û_–û', tooltip: '–æ–∫–æ–Ω—á–∞–Ω–∏–µ - –æ–∫–æ–Ω—á–∞–Ω–∏–µ' }
                ];
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å–≤—è–∑–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –û_–ù, –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏)
                const linkValue = index === 0 ? '–û_–ù' : (task.link || '–û_–ù');
                if (index === 0) {
                    task.link = '–û_–ù'; // –ü–µ—Ä–≤–∞—è –∑–∞–¥–∞—á–∞ —Ç–æ–∂–µ –∏–º–µ–µ—Ç —Å–≤—è–∑—å, –Ω–æ –æ–Ω–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
                } else if (!task.link) {
                    task.link = '–û_–ù';
                }
                
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    if (opt.value === linkValue) {
                        option.selected = true;
                    }
                    linkSelect.appendChild(option);
                });
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                function updateLinkTooltip() {
                    const selectedValue = linkSelect.value;
                    const selectedOption = options.find(opt => opt.value === selectedValue);
                    if (selectedOption && selectedOption.tooltip) {
                        linkSelect.setAttribute('data-tooltip', selectedOption.tooltip);
                    } else {
                        linkSelect.removeAttribute('data-tooltip');
                    }
                }
                updateLinkTooltip();
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –û_–ù –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
                if (!task.link) {
                    task.link = '–û_–ù';
                    linkSelect.value = '–û_–ù';
                    updateLinkTooltip();
                }
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–ª–∏ –¥–ª—è –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏
                if (isViewMode || index === 0) {
                    linkSelect.setAttribute('disabled', 'disabled');
                } else {
                    linkSelect.addEventListener('change', function(event) {
                        updateLinkTooltip();
                        // –°–æ–∑–¥–∞–µ–º —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π event, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                        if (!event || !event.target) {
                            event = { target: this };
                        }
                        onTaskTableInputChange(event);
                    });
                }
                linkCell.appendChild(linkSelect);
                applyColumnWidth(linkCell, 'link');
                detailsRow.appendChild(linkCell);

                // –Ø—á–µ–π–∫–∞ "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
                const respCell = document.createElement('div');
                respCell.className = 'gantt-details-cell responsible-cell';
                if (task.responsible) {
                    respCell.setAttribute('data-tooltip', task.responsible);
                }
                const respInput = document.createElement('input');
                respInput.type = 'text';
                respInput.className = 'gantt-details-input';
                respInput.value = task.responsible || '';
                respInput.setAttribute('data-index', index);
                respInput.setAttribute('data-field', 'responsible');
                respInput.addEventListener('change', onTaskTableInputChange);
                respCell.appendChild(respInput);
                applyColumnWidth(respCell, 'responsible');
                detailsRow.appendChild(respCell);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —è—á–µ–π–∫–∏ –¥–µ—Ç–∞–ª–µ–π –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Shift+–∫–ª–∏–∫–∞
                detailsRow.addEventListener('click', (event) => {
                    // –ï—Å–ª–∏ —ç—Ç–æ Shift+–∫–ª–∏–∫, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
                    if (event.shiftKey) {
                        event.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ, —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç—Ä–æ–∫–∏ –¥–≤–∞–∂–¥—ã
                        handleTaskRowClick(task.id, event);
                    }
                    // –ü—Ä–∏ –æ–±—ã—á–Ω–æ–º –∫–ª–∏–∫–µ –ø–æ–∑–≤–æ–ª—è–µ–º —Å–æ–±—ã—Ç–∏—é –≤—Å–ø–ª—ã–≤–∞—Ç—å –¥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å—Ç—Ä–æ–∫–∏
                });
                
                row.appendChild(detailsRow);

            timelineUnits.forEach((unit, unitIdx) => {
                    const cell = document.createElement('div');
                    cell.className = 'gantt-cell';
                    const unitDays = Math.round((unit.end - unit.start) / msInDay) + 1;
                    const width = Math.max(30, unitDays * pxPerDay);
                    cell.style.minWidth = width + 'px';
                    cell.style.width = width + 'px';

                    const isFutureUnit = unit.start > realLastTaskDate;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –∑–∞–¥–∞—á–∏ —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—É—â–µ–π –µ–¥–∏–Ω–∏—Ü—ã –≤—Ä–µ–º–µ–Ω–∏
                    // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å—Ç—Ä–æ–∫: –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ Date –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    const unitDatesForTask = (task.dates || []).filter(d => {
                        const dateObj = d instanceof Date ? d : new Date(d);
                        if (isNaN(dateObj.getTime())) return false;
                        const time = dateObj.getTime();
                        return time >= unit.start.getTime() && time <= unit.end.getTime();
                    });

                    // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ –¥–Ω–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "weekend-manual"
                    // (–∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ –≤ task.dates, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π)
                    let hasWeekendManualInUnit = false;
                    let weekendManualDate = null;
                    if (task.dateStatuses) {
                        const unitStartTime = unit.start.getTime();
                        const unitEndTime = unit.end.getTime();
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –¥–∞—Ç—ã –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ
                        let checkDate = new Date(unit.start);
                        while (checkDate.getTime() <= unitEndTime) {
                            const dateKey = formatDateKey(checkDate);
                            if (task.dateStatuses[dateKey] === 'weekend-manual') {
                                hasWeekendManualInUnit = true;
                                weekendManualDate = new Date(checkDate);
                                break;
                            }
                            checkDate.setDate(checkDate.getDate() + 1);
                        }
                    }

                    const hasWorkInUnit = unitDatesForTask.length > 0 || hasWeekendManualInUnit;

                    if (hasWorkInUnit) {
                        // –í–ê–ñ–ù–û: –ö–∞–∂–¥–∞—è —è—á–µ–π–∫–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
                        // –°—Ç–∞—Ç—É—Å –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –¥–Ω—é –≤ —è—á–µ–π–∫–µ, –∞ –Ω–µ –∫–æ –≤—Å–µ–π –∑–∞–¥–∞—á–µ
                        // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫—Ä–∞—Å–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —è—á–µ–π–∫–µ, –∞ –Ω–µ –≤—Å–µ–π —Å—Ç—Ä–æ–∫–µ
                        // –í —Ä–µ–∂–∏–º–µ "—Ç–æ—á–µ–∫" –ø–æ–∫—Ä–∞—Å–∫–∞ –ø–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º –¥–Ω—è–º
                        // –í —Ä–µ–∂–∏–º–µ "–ø–æ–ª–æ—Å" —Ä–∏—Å—É–µ–º –±–æ–ª–µ–µ —à–∏—Ä–æ–∫–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã, –Ω–æ —Å—Ç–∞—Ç—É—Å –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –æ—Ç–¥–µ–ª—å–Ω—ã–º –¥–Ω—è–º

                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å–Ω—É—é –¥–∞—Ç—É –∏ –µ—ë —Å—Ç–∞—Ç—É—Å
                        let representativeDate;
                        let repDateStr;
                        let statusForDate;
                        
                        if (hasWeekendManualInUnit && weekendManualDate) {
                            // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                            representativeDate = weekendManualDate;
                            repDateStr = formatDateKey(representativeDate);
                            statusForDate = 'weekend-manual';
                        } else if (unitDatesForTask.length > 0) {
                            // –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
                            representativeDate = unitDatesForTask[0];
                            repDateStr = formatDateKey(representativeDate);
                            // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –¥–∞—Ç—ã, –∞ –ù–ï –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
                            // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫—Ä–∞—Å–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —è—á–µ–π–∫–µ, –∞ –Ω–µ –≤—Å–µ–π —Å—Ç—Ä–æ–∫–µ
                            statusForDate = task.dateStatuses && task.dateStatuses[repDateStr] ? task.dateStatuses[repDateStr] : 'pending';
                            // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º task.status, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏, –∞ –Ω–µ —Å—Ç–∞—Ç—É—Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –¥–∞—Ç—ã
                        } else {
                            // Fallback (–Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                            representativeDate = unit.start;
                            repDateStr = formatDateKey(representativeDate);
                            statusForDate = 'pending';
                        }

                        const bar = document.createElement('div');

                        // –ü–æ–¥–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –±–∞—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
                        let barClasses = 'gantt-bar';
                        if (statusForDate === 'completed') {
                            barClasses += ' completed';
                        } else if (statusForDate === 'in-progress') {
                            barClasses += ' in-progress';
                        } else if (statusForDate === 'weekend-manual') {
                            barClasses += ' gantt-weekend';
                        }
                        bar.className = barClasses;
                        
                        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ bar –∫–ª–∏–∫–∞–±–µ–ª–µ–Ω –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤—ã—à–µ –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                        bar.style.position = 'relative';
                        bar.style.zIndex = '10';
                        bar.style.pointerEvents = 'auto';
                        bar.style.width = '100%'; // –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É —è—á–µ–π–∫–∏
                        bar.style.minHeight = '24px'; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∫–ª–∏–∫–∞
                        bar.style.alignSelf = 'center'; // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏

                        // –ï—Å–ª–∏ –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã –µ—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –¥–æ–±–∞–≤–ª—è–µ–º data-tooltip,
                        // —á—Ç–æ–±—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞—Å—å –ø–æ–¥—Å–∫–∞–∑–∫–∞ —Å —á—ë—Ä–Ω—ã–º —Ñ–æ–Ω–æ–º.
                        if (task.dateComments && task.dateComments[repDateStr]) {
                            const formattedComment = formatCommentForTooltip(task.dateComments[repDateStr]);
                            bar.setAttribute('data-tooltip', formattedComment);
                        }

                        // –í —Ä–µ–∂–∏–º–µ –ø–æ–ª–æ—Å —É–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª –∏ —É–ø—Ä–∞–≤–ª—è–µ–º —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º/–≥—Ä–∞–Ω–∏—Ü–∞–º–∏
                        if (ganttBarStyle === 'segments') {
                            bar.textContent = '';

                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–Ω–∏ –∑–∞–¥–∞—á–∏ –≤ —Å–æ—Å–µ–¥–Ω–∏—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö –≤—Ä–µ–º–µ–Ω–∏,
                            // —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –Ω–∞—á–∞–ª–æ —ç—Ç–æ, —Å–µ—Ä–µ–¥–∏–Ω–∞ –∏–ª–∏ –∫–æ–Ω–µ—Ü –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –æ—Ç—Ä–µ–∑–∫–∞.
                            // –£—á–∏—Ç—ã–≤–∞–µ–º –∫–∞–∫ —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏, —Ç–∞–∫ –∏ –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏
                            const hasPrev = unitIdx > 0 && (
                                task.dates.some(d => {
                                    const t = d.getTime();
                                    const prev = timelineUnits[unitIdx - 1];
                                    return t >= prev.start.getTime() && t <= prev.end.getTime();
                                }) ||
                                (task.dateStatuses && Object.keys(task.dateStatuses).some(dateKey => {
                                    if (task.dateStatuses[dateKey] === 'weekend-manual') {
                                        const date = parseDateFromInput(dateKey);
                                        if (date) {
                                            const t = date.getTime();
                                            const prev = timelineUnits[unitIdx - 1];
                                            return t >= prev.start.getTime() && t <= prev.end.getTime();
                                        }
                                    }
                                    return false;
                                }))
                            );
                            const hasNext = unitIdx < timelineUnits.length - 1 && (
                                task.dates.some(d => {
                                    const t = d.getTime();
                                    const next = timelineUnits[unitIdx + 1];
                                    return t >= next.start.getTime() && t <= next.end.getTime();
                                }) ||
                                (task.dateStatuses && Object.keys(task.dateStatuses).some(dateKey => {
                                    if (task.dateStatuses[dateKey] === 'weekend-manual') {
                                        const date = parseDateFromInput(dateKey);
                                        if (date) {
                                            const t = date.getTime();
                                            const next = timelineUnits[unitIdx + 1];
                                            return t >= next.start.getTime() && t <= next.end.getTime();
                                        }
                                    }
                                    return false;
                                }))
                            );

                            if (hasPrev && hasNext) {
                                bar.classList.add('segment-middle');
                            } else if (!hasPrev && hasNext) {
                                bar.classList.add('segment-start');
                            } else if (hasPrev && !hasNext) {
                                bar.classList.add('segment-end');
                            } else if (!hasPrev && !hasNext) {
                                // –û–¥–∏–Ω–æ—á–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç ‚Äî –∑–∞–¥–∞—á–∞ —É–º–µ—â–∞–µ—Ç—Å—è –≤ –æ–¥–Ω—É –µ–¥–∏–Ω–∏—Ü—É –≤—Ä–µ–º–µ–Ω–∏,
                                // –ø–æ—ç—Ç–æ–º—É —Å–∫—Ä—É–≥–ª—è–µ–º –æ–±–∞ –∫—Ä–∞—è.
                                bar.classList.add('segment-single');
                            }
                        } else {
                            bar.textContent = '‚ñ†';
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É —Å–∞–º–æ–ª–µ—Ç–∏–∫–∞, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ "–Ω–∞ –≤—ã–µ–∑–¥–µ"
                        if (task.onTravel) {
                            const travelIcon = document.createElement('span');
                            travelIcon.className = 'gantt-travel-icon';
                            travelIcon.textContent = '‚úà';
                            travelIcon.title = '–ù–∞ –≤—ã–µ–∑–¥–µ';
                            travelIcon.style.position = 'absolute';
                            travelIcon.style.top = '2px';
                            travelIcon.style.right = '2px';
                            travelIcon.style.zIndex = '15';
                            bar.appendChild(travelIcon);
                        }

                        // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π title –æ—Ç–∫–ª—é—á–∞–µ–º, —á—Ç–æ–±—ã –ø–æ –Ω–∞–≤–µ–¥–µ–Ω–∏—é
                        // –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ —á—ë—Ä–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.
                        bar.title = '';

                        bar.style.cursor = 'pointer';
                        
                        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–∫–∞/—Ç–∞–ø–∞
                        function handleBarClick(event, clientX, clientY) {
                            console.log('üéØ handleBarClick –≤—ã–∑–≤–∞–Ω–∞!', { taskId: task.id, clientX, clientY, shiftKey: event.shiftKey });
                            
                            event.stopPropagation();
                            
                            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º Shift+–∫–ª–∏–∫ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∑–∞–¥–∞—á
                            if (event.shiftKey) {
                                console.log('‚ö†Ô∏è Shift+–∫–ª–∏–∫ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é');
                                handleTaskRowClick(task.id, event);
                                // –ü—Ä–∏ Shift+–∫–ª–∏–∫–µ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–æ–≤, —Ç–æ–ª—å–∫–æ –≤—ã–¥–µ–ª—è–µ–º –∑–∞–¥–∞—á–∏
                                return;
                            }
                            
                            // –û–±—ã—á–Ω—ã–π –∫–ª–∏–∫ - –µ—Å–ª–∏ –µ—Å—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏ —Ç–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞ –≤ –Ω–∏—Ö, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                            // –ò–Ω–∞—á–µ –≤—ã–¥–µ–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É
                            if (selectedTaskIds.size > 0 && selectedTaskIds.has(task.id)) {
                                // –ó–∞–¥–∞—á–∞ —É–∂–µ –≤—ã–¥–µ–ª–µ–Ω–∞ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ, –Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º lastSelectedTaskId
                                selectTask(task.id, { preserveSelection: true });
                            } else {
                                // –û–±—ã—á–Ω—ã–π –∫–ª–∏–∫ - –≤—ã–¥–µ–ª—è–µ–º —Ç–æ–ª—å–∫–æ —ç—Ç—É –∑–∞–¥–∞—á—É
                                handleTaskRowClick(task.id, event);
                            }

                            const canEditResult = canEdit();
                            console.log('üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ canEdit():', canEditResult);
                            
                            if (!canEditResult) {
                                console.warn('‚ö†Ô∏è –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ');
                                return; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                            }
                            
                            console.log('‚úÖ –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å');

                            const barElement = event.currentTarget || event.target;
                            
                            // –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–∞–º–æ–π —è—á–µ–π–∫–∏ (bar), —á—Ç–æ–±—ã –º–µ–Ω—é –ø–æ—è–≤–ª—è–ª–æ—Å—å —Ä—è–¥–æ–º —Å –Ω–µ–π
                            // –≠—Ç–æ –Ω–∞–¥–µ–∂–Ω–µ–µ, —á–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω—ã–º–∏
                            const barRect = barElement ? barElement.getBoundingClientRect() : null;
                            if (!barRect) {
                                console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏!');
                                return;
                            }
                            
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π —è—á–µ–π–∫–∏ –∏ —Ü–µ–Ω—Ç—Ä –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–Ω—é
                            const clickX = barRect.right; // –ü—Ä–∞–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ —è—á–µ–π–∫–∏
                            const clickY = barRect.top + barRect.height / 2; // –¶–µ–Ω—Ç—Ä —è—á–µ–π–∫–∏ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
                            
                            console.log('üñ±Ô∏è –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏ –¥–ª—è –º–µ–Ω—é:', { 
                                barRect: { left: barRect.left, top: barRect.top, right: barRect.right, bottom: barRect.bottom, width: barRect.width, height: barRect.height },
                                clickX, 
                                clickY
                            });
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —ç–ª–µ–º–µ–Ω—Ç —è—á–µ–π–∫–∏ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–Ω—é
                            const targetBarElement = barElement;

                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ –¥–∞—Ç—ã –≤—ã–±—Ä–∞–Ω—ã
                            // –í–ê–ñ–ù–û: –í –¥–µ—Ç–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ –∫–∞–∂–¥–∞—è —è—á–µ–π–∫–∞ –¥–æ–ª–∂–Ω–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
                            // –°—Ç–∞—Ç—É—Å –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –¥–Ω—é, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –∫–ª–∏–∫–Ω—É–ª–∏
                            let selectedDates = [];
                            
                            // –í –¥–µ—Ç–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ –≤—Å–µ–≥–¥–∞ –±–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É –∏–∑ —è—á–µ–π–∫–∏
                            // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫—Ä–∞—Å–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —è—á–µ–π–∫–µ, –∞ –Ω–µ –≤—Å–µ–π —Å—Ç—Ä–æ–∫–µ
                            if (unitDatesForTask.length > 0) {
                                // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é –¥–∞—Ç—É –∏–∑ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ (–º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É)
                                // –í –¥–µ—Ç–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ –∫–∞–∂–¥–∞—è —è—á–µ–π–∫–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –æ–¥–∏–Ω –¥–µ–Ω—å
                                const firstDate = unitDatesForTask[0];
                                selectedDates = [formatDateKey(firstDate)];
                            } else if (hasWeekendManualInUnit && weekendManualDate) {
                                // –ï—Å–ª–∏ –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ –µ—Å—Ç—å –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                                selectedDates = [formatDateKey(weekendManualDate)];
                            } else {
                                // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞—Ç –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
                                selectedDates = [formatDateKey(unit.start)];
                            }
                            
                            // –í —Ä–µ–∂–∏–º–µ –ø–æ–ª–æ—Å —Ç–∞–∫–∂–µ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å —Ç–æ–ª—å–∫–æ –∫ –æ–¥–Ω–æ–π –¥–∞—Ç–µ –∏–∑ —è—á–µ–π–∫–∏
                            // (–Ω–µ –∫–æ –≤—Å–µ–º –¥–∞—Ç–∞–º –∑–∞–¥–∞—á–∏), —á—Ç–æ–±—ã –∫–∞–∂–¥–∞—è —è—á–µ–π–∫–∞ –∫—Ä–∞—Å–∏–ª–∞—Å—å –æ—Ç–¥–µ–ª—å–Ω–æ

                            // –ï—Å–ª–∏ –∑–∞–∂–∞—Ç Ctrl/Cmd - –¥–æ–±–∞–≤–ª—è–µ–º/—É–±–∏—Ä–∞–µ–º –∏–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
                            if (isCtrlPressed || event.ctrlKey || event.metaKey) {
                                event.preventDefault();
                                
                                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –¥–∞—Ç –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ
                                let hasSelected = false;
                                selectedDates.forEach(dateStr => {
                                    const cellKey = `${task.id}:${dateStr}`;
                                    if (selectedCells.has(cellKey)) {
                                        selectedCells.delete(cellKey);
                                        hasSelected = false;
                                    } else {
                                        selectedCells.add(cellKey);
                                        hasSelected = true;
                                    }
                                });
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                                updateCellSelection();
                                
                                // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —è—á–µ–π–∫–∏, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
                                if (selectedCells.size > 0) {
                                    openStatusMenuForMultipleSelection(clickX, clickY, targetBarElement);
                                } else {
                                    closeStatusMenu();
                                }
                            } else {
                                // –û–±—ã—á–Ω—ã–π –∫–ª–∏–∫ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä —è—á–µ–µ–∫, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á
                                // (–≤—ã–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, –Ω–æ –Ω–µ –¥–ª—è –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞)
                                if (selectedCells.size > 0) {
                                    selectedCells.clear();
                                    updateCellSelection();
                                }
                                
                                // –£–ë–†–ê–ù–û: –ú–∞—Å—Å–æ–≤–æ–µ –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–º –∑–∞–¥–∞—á–∞–º
                                // –¢–µ–ø–µ—Ä—å —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –∫–ª–∏–∫–Ω—É–ª–∏
                                // –ú–∞—Å—Å–æ–≤–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ Shift –æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ, –≤—Å—Ç–∞–≤–∫–∞ –∏ —Ç.–¥.)
                                
                                // –í—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–¥–Ω–æ–π —è—á–µ–π–∫–∏, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –∫–ª–∏–∫–Ω—É–ª–∏
                                console.log('üìã –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –¥–ª—è –æ–¥–Ω–æ–π —è—á–µ–π–∫–∏:', { clickX, clickY, taskId: task.id, selectedDates });
                                openStatusMenu(clickX, clickY, task.id, selectedDates, targetBarElement);
                            }
                            
                            console.log('‚úÖ handleBarClick –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                        }
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ (–¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞)
                        bar.addEventListener('click', (event) => {
                            // –ï—Å–ª–∏ –±—ã–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ —Ä–µ–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ (–¥–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏ > –ø–æ—Ä–æ–≥–∞)
                            if (isDraggingBar) {
                                console.log('‚ö†Ô∏è –ö–ª–∏–∫ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω - –±—ã–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ');
                                return;
                            }
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏ –ø–æ—Å–ª–µ mousedown
                            // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ 300–º—Å –∏ –±—ã–ª–æ –¥–≤–∏–∂–µ–Ω–∏–µ, —ç—Ç–æ –º–æ–≥–ª–æ –±—ã—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
                            if (draggingBarTaskId === task.id && Date.now() - dragStartTime < 300) {
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏
                                const wasMovement = Math.abs(event.clientX - dragStartX) > DRAG_THRESHOLD || 
                                                   Math.abs(event.clientY - dragStartY) > DRAG_THRESHOLD;
                                if (wasMovement) {
                                    console.log('‚ö†Ô∏è –ö–ª–∏–∫ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω - –±—ã–ª–æ –¥–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏');
                                    return;
                                }
                            }
                            
                            console.log('üñ±Ô∏è –ö–ª–∏–∫ –Ω–∞ bar:', { taskId: task.id, date: repDateStr });
                            event.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ, —á—Ç–æ–±—ã —è—á–µ–π–∫–∞ –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏–ª–∞ –∫–ª–∏–∫
                            handleBarClick(event, event.clientX, event.clientY);
                        });
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ touchstart –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö (–¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è)
                        bar.addEventListener('touchstart', (event) => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                            if (!canEdit()) {
                                event.stopPropagation();
                                return;
                            }
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –∑–∞–∂–∞—Ç Shift/Ctrl
                            if (event.shiftKey || event.ctrlKey || event.metaKey) {
                                event.stopPropagation();
                                return;
                            }
                            
                            const touch = event.touches[0];
                            if (touch) {
                                // –û—Ç–∫–ª—é—á–∞–µ–º HTML5 drag & drop –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π —Å—Ç—Ä–æ–∫–µ
                                dragStartRow = row;
                                if (row.draggable) {
                                    row.draggable = false;
                                }
                                
                                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
                                draggingBarTaskId = task.id;
                                dragStartX = touch.clientX;
                                dragStartY = touch.clientY;
                                dragStartDate = new Date(task.startDate);
                                dragStartCell = cell;
                                dragStartTime = Date.now();
                                
                                event.stopPropagation();
                                
                                console.log('üéØ –ù–∞—á–∞–ª–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –±–∞—Ä–∞ (touch):', {
                                    taskId: task.id,
                                    startDate: formatDateKey(dragStartDate),
                                    startX: dragStartX,
                                    startY: dragStartY
                                });
                            }
                        });
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ touch (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
                        bar.addEventListener('touchend', (event) => {
                            // –ï—Å–ª–∏ –±—ã–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º touch
                            if (isDraggingBar) {
                                console.log('‚ö†Ô∏è Touch –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω - –±—ã–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ');
                                return;
                            }
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ touchstart
                            if (draggingBarTaskId === task.id && Date.now() - dragStartTime < 300) {
                                const touch = event.changedTouches[0];
                                if (touch) {
                                    const wasMovement = Math.abs(touch.clientX - dragStartX) > DRAG_THRESHOLD || 
                                                       Math.abs(touch.clientY - dragStartY) > DRAG_THRESHOLD;
                                    if (wasMovement) {
                                        console.log('‚ö†Ô∏è Touch –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω - –±—ã–ª–æ –¥–≤–∏–∂–µ–Ω–∏–µ');
                                        return;
                                    }
                                }
                            }
                            
                            event.preventDefault();
                            event.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ
                            const touch = event.changedTouches[0];
                            if (touch) {
                                console.log('üì± Touch –Ω–∞ bar:', { taskId: task.id, date: repDateStr });
                                handleBarClick(event, touch.clientX, touch.clientY);
                            }
                        });
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ mousedown –¥–ª—è drag & drop –∏ —Ä–µ—Å–∞–π–∑–∞ –±–∞—Ä–æ–≤ –≤ –¥–∏–∞–≥—Ä–∞–º–º–µ –ì–∞–Ω—Ç–∞
                        bar.addEventListener('mousedown', (event) => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                            if (!canEdit()) {
                                event.stopPropagation();
                                return;
                            }
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –ª–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏ –∏ –Ω–µ –∑–∞–∂–∞—Ç Shift/Ctrl
                            if (event.button !== 0 || event.shiftKey || event.ctrlKey || event.metaKey) {
                                event.stopPropagation();
                                return;
                            }
                            
                            // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                            if (index === 0) {
                                console.log('üü¢ –ü–µ—Ä–≤–∞—è –∑–∞–¥–∞—á–∞: –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ mousedown –≤—ã–∑–≤–∞–Ω', { taskId: task.id, index });
                            }
                            
                            // –û—Ç–∫–ª—é—á–∞–µ–º HTML5 drag & drop –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π —Å—Ç—Ä–æ–∫–µ, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å
                            // —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º –±–∞—Ä–∞
                            dragStartRow = row;
                            if (row.draggable) {
                                row.draggable = false;
                            }
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫—É—Ä—Å–æ—Ä —É –∫—Ä–∞—è –±–∞—Ä–∞ (–¥–ª—è —Ä–µ—Å–∞–π–∑–∞)
                            const barRect = bar.getBoundingClientRect();
                            const distanceFromRightEdge = barRect.right - event.clientX;
                            const distanceFromLeftEdge = event.clientX - barRect.left;
                            const isNearRightEdge = distanceFromRightEdge >= 0 && distanceFromRightEdge <= RESIZE_EDGE_THRESHOLD;
                            const isNearLeftEdge = distanceFromLeftEdge >= 0 && distanceFromLeftEdge <= RESIZE_EDGE_THRESHOLD;
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ—Ç –±–∞—Ä –ø–æ—Å–ª–µ–¥–Ω–∏–º/–ø–µ—Ä–≤—ã–º –≤ –∑–∞–¥–∞—á–µ
                            const allBarsInRow = row.querySelectorAll('.gantt-bar');
                            const isLastBar = allBarsInRow.length > 0 && allBarsInRow[allBarsInRow.length - 1] === bar;
                            const isFirstBar = allBarsInRow.length > 0 && allBarsInRow[0] === bar;
                            
                            if (isNearRightEdge && isLastBar) {
                                // –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ—Å–∞–π–∑ —Å–ø—Ä–∞–≤–∞ (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è)
                                resizingBarTaskId = task.id;
                                resizeStartX = event.clientX;
                                resizeStartDays = task.days || task.dates.length || 1;
                                resizeStartEndDate = task.endDate ? new Date(task.endDate) : null;
                                resizeStartStartDate = task.startDate ? new Date(task.startDate) : null;
                                resizeDirection = 'right';
                                
                                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ –∏ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
                                event.stopPropagation();
                                event.preventDefault();
                                
                                console.log('üìê –ù–∞—á–∞–ª–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ä–µ—Å–∞–π–∑–∞ –±–∞—Ä–∞ (—Å–ø—Ä–∞–≤–∞):', {
                                    taskId: task.id,
                                    taskIndex: index,
                                    startDays: resizeStartDays,
                                    endDate: resizeStartEndDate ? formatDateKey(resizeStartEndDate) : null,
                                    startX: resizeStartX,
                                    direction: 'right',
                                    isFirstTask: index === 0
                                });
                            } else if (isNearLeftEdge && isFirstBar) {
                                // –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ—Å–∞–π–∑ —Å–ª–µ–≤–∞ (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞)
                                resizingBarTaskId = task.id;
                                resizeStartX = event.clientX;
                                resizeStartDays = task.days || task.dates.length || 1;
                                resizeStartEndDate = task.endDate ? new Date(task.endDate) : null;
                                resizeStartStartDate = task.startDate ? new Date(task.startDate) : null;
                                resizeDirection = 'left';
                                
                                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ –∏ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
                                event.stopPropagation();
                                event.preventDefault();
                                
                                console.log('üìê –ù–∞—á–∞–ª–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ä–µ—Å–∞–π–∑–∞ –±–∞—Ä–∞ (—Å–ª–µ–≤–∞):', {
                                    taskId: task.id,
                                    taskIndex: index,
                                    startDays: resizeStartDays,
                                    startDate: resizeStartStartDate ? formatDateKey(resizeStartStartDate) : null,
                                    startX: resizeStartX,
                                    direction: 'left',
                                    isFirstTask: index === 0
                                });
                            } else {
                                // –û–±—ã—á–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
                                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
                                draggingBarTaskId = task.id;
                                dragStartX = event.clientX;
                                dragStartY = event.clientY;
                                dragStartDate = new Date(task.startDate);
                                dragStartCell = cell;
                                dragStartTime = Date.now();
                                
                                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—Ä–∏ mousedown –∏ –≤—Å–ø–ª—ã—Ç–∏–µ –¥–æ —Å—Ç—Ä–æ–∫–∏
                                event.stopPropagation();
                                event.preventDefault();
                                
                                console.log('üéØ –ù–∞—á–∞–ª–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –±–∞—Ä–∞:', {
                                    taskId: task.id,
                                    taskIndex: index,
                                    startDate: formatDateKey(dragStartDate),
                                    startX: dragStartX,
                                    startY: dragStartY,
                                    isFirstTask: index === 0
                                });
                            }
                        });

                        cell.appendChild(bar);
                        
                        // –ï—Å–ª–∏ –≤ —è—á–µ–π–∫–µ –µ—Å—Ç—å bar, —è—á–µ–π–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –∫–ª–∏–∫–∏
                        // –ö–ª–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –∫ bar
                        cell.style.pointerEvents = 'none';
                    } else {
                        // –ï—Å–ª–∏ –≤ —è—á–µ–π–∫–µ –Ω–µ—Ç bar, —Ä–∞–∑—Ä–µ—à–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ —è—á–µ–π–∫–µ
                        cell.style.pointerEvents = 'auto';
                    }
                    
                    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ bar –≤—Å–µ–≥–¥–∞ –∫–ª–∏–∫–∞–±–µ–ª–µ–Ω, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                    const existingBar = cell.querySelector('.gantt-bar');
                    if (existingBar) {
                        existingBar.style.pointerEvents = 'auto';
                        existingBar.style.minWidth = '20px'; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –∫–ª–∏–∫–∞
                    }
                    
                    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∂—ë–ª—Ç–æ–π –ø–æ–ª–æ—Å—ã –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ (baseline) –ø–æ–¥ —Ç–µ–∫—É—â–∏–º –±–∞—Ä–æ–º/—è—á–µ–π–∫–æ–π.
                    // –í–ê–ñ–ù–û: baseline —Ä–∏—Å—É–µ–º –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –µ—Å—Ç—å –ª–∏ —Å–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞ –≤ —ç—Ç–æ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ,
                    // —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ –∏—Å—Ö–æ–¥–Ω—ã–π –ø–ª–∞–Ω –¥–∞–∂–µ –ø–æ—Å–ª–µ —Å–¥–≤–∏–≥–æ–≤ –∑–∞–¥–∞—á.
                    if (showBaseline && Array.isArray(task.baselineDates) && task.baselineDates.length) {
                        const unitStartTime = unit.start.getTime();
                        const unitEndTime = unit.end.getTime();
                        const hasBaselineInUnit = task.baselineDates.some(d => {
                            const t = d.getTime();
                            return t >= unitStartTime && t <= unitEndTime;
                        });

                        if (hasBaselineInUnit) {
                            const baselineBar = document.createElement('div');
                            baselineBar.className = 'baseline-bar';
                            baselineBar.style.pointerEvents = 'none'; // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ baseline –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–ª–∏–∫–∏
                            baselineBar.style.zIndex = '100'; // –≤—ã—Å–æ–∫–∏–π z-index –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞
                            cell.appendChild(baselineBar);
                        }
                    }

                    if (isFutureUnit) {
                        cell.classList.add('gantt-future-cell');
                    }

                    row.appendChild(cell);
                });

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ drag-over / drop –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –∑–∞–¥–∞—á
                row.addEventListener('dragover', (e) => {
                    if (draggingTaskId === null || draggingTaskId === task.id) return;
                    e.preventDefault();
                    row.classList.add('gantt-row-drop-target');
                });

                row.addEventListener('dragleave', () => {
                    row.classList.remove('gantt-row-drop-target');
                });

                row.addEventListener('drop', (e) => {
                    if (!canEdit()) {
                        e.preventDefault();
                        return;
                    }
                    if (draggingTaskId === null || draggingTaskId === task.id) return;
                    e.preventDefault();
                    row.classList.remove('gantt-row-drop-target');

                    const fromIndex = tasks.findIndex(t => t.id === draggingTaskId);
                    const targetId = task.id;
                    if (fromIndex === -1) return;

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º
                    addToUndoHistory();

                    console.log('üîÑ DRAG&DROP: –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏');
                    console.log('   –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–∞—è –∑–∞–¥–∞—á–∞ ID:', draggingTaskId);
                    console.log('   –°—Ç–∞—Ä—ã–π –∏–Ω–¥–µ–∫—Å:', fromIndex);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –î–û –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    const movedTaskBefore = tasks[fromIndex];
                    console.log('   üìã –î–û –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è - –∑–∞–¥–∞—á–∞:', movedTaskBefore.task || movedTaskBefore.name);
                    console.log('   üìã –î–û –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è - –¥–∞—Ç—ã:', movedTaskBefore.dates?.map(d => formatDateKey(d)));
                    console.log('   üìã –î–û –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è - —Å—Ç–∞—Ç—É—Å—ã –¥–∞—Ç:', movedTaskBefore.dateStatuses);
                    console.log('   üìã –î–û –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:', movedTaskBefore.dateComments);
                    console.log('   üìã –î–û –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è - –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å:', movedTaskBefore.status);

                    const [moved] = tasks.splice(fromIndex, 1);
                    const targetIndex = tasks.findIndex(t => t.id === targetId);
                    let newIndex;
                    if (targetIndex === -1) {
                        // –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∫–ª–∞–¥—ë–º –≤ –∫–æ–Ω–µ—Ü
                        tasks.push(moved);
                        newIndex = tasks.length - 1;
                    } else {
                        tasks.splice(targetIndex, 0, moved);
                        newIndex = targetIndex;
                    }

                    console.log('   –ù–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å:', newIndex);
                    console.log('   üìã –ü–û–°–õ–ï –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (–¥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞) - —Å—Ç–∞—Ç—É—Å—ã –¥–∞—Ç:', moved.dateStatuses);
                    console.log('   üìã –ü–û–°–õ–ï –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (–¥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞) - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:', moved.dateComments);

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å –∫–∞–∫–æ–≥–æ –º–µ—Å—Ç–∞ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –¥–∞—Ç—ã:
                    // –±–µ—Ä—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –º–µ–∂–¥—É —Å—Ç–∞—Ä–æ–π –∏ –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–µ–π
                    // –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–ø–æ—á–∫—É, –Ω–∞—á–∏–Ω–∞—è —Å —ç—Ç–æ–π –∑–∞–¥–∞—á–∏ –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ
                    const startIndex = Math.min(fromIndex, newIndex);
                    console.log('   üî¢ –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ—Å—á–µ—Ç —Å –∏–Ω–¥–µ–∫—Å–∞:', startIndex);
                    recalculateDatesFrom(startIndex);

                    console.log('   üìã –ü–û–°–õ–ï –ø–µ—Ä–µ—Å—á–µ—Ç–∞ - —Å—Ç–∞—Ç—É—Å—ã –¥–∞—Ç:', moved.dateStatuses);
                    console.log('   üìã –ü–û–°–õ–ï –ø–µ—Ä–µ—Å—á–µ—Ç–∞ - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:', moved.dateComments);
                    console.log('   üìã –ü–û–°–õ–ï –ø–µ—Ä–µ—Å—á–µ—Ç–∞ - –Ω–æ–≤—ã–µ –¥–∞—Ç—ã:', moved.dates?.map(d => formatDateKey(d)));

                    draggingTaskId = null;
                    updateStatistics();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            if (searchResults.length > 0) {
                highlightSearchResults();
            }
                    renderGantt();
                    renderTable();
                });

                // –ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ –ì–∞–Ω—Ç–∞ ‚Äî –≤—ã–±–∏—Ä–∞–µ–º –∑–∞–¥–∞—á—É (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ Shift)
                row.addEventListener('click', (event) => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –Ω–µ –Ω–∞ input –∏–ª–∏ select –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏ (–∫—Ä–æ–º–µ Shift+–∫–ª–∏–∫–∞)
                    const target = event.target;
                    const isInputElement = target.tagName === 'INPUT' || 
                                         target.tagName === 'SELECT' || 
                                         target.tagName === 'TEXTAREA' ||
                                         target.closest('input, select, textarea');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –Ω–µ –Ω–∞ —è—á–µ–π–∫–µ —Å –±–∞—Ä–æ–º –∏–ª–∏ –Ω–∞ —Å–∞–º–æ–º –±–∞—Ä–µ
                    const isBarCell = target.closest('.gantt-bar') || 
                                     target.closest('.gantt-cell')?.querySelector('.gantt-bar');
                    
                    // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–∞ —è—á–µ–π–∫–µ —Å –±–∞—Ä–æ–º, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
                    // (–±–∞—Ä —Å–∞–º –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–ª–∏–∫ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–æ–≤)
                    if (isBarCell) {
                        return;
                    }
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ Shift+–∫–ª–∏–∫, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —ç–ª–µ–º–µ–Ω—Ç–∞
                    if (event.shiftKey) {
                        handleTaskRowClick(task.id, event);
                        return;
                    }
                    
                    // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–∞ input/select –ø—Ä–∏ –æ–±—ã—á–Ω–æ–º –∫–ª–∏–∫–µ, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                    if (isInputElement) {
                        return;
                    }
                    
                    // –û–±—ã—á–Ω—ã–π –∫–ª–∏–∫ –Ω–∞ —Å—Ç—Ä–æ–∫—É - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                    handleTaskRowClick(task.id, event);
                });

                chartContainer.appendChild(row);
                });

            });

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç—å—é –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
            function updateVerticalScrollVisibility() {
                const chartContainerElement = document.querySelector('.chart-container');
                if (!chartContainerElement) return;
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —ç—Ç–∞–ø—ã –∏–∑ –∑–∞–¥–∞—á
                const allStages = new Set();
                tasks.forEach(task => {
                    const stage = task.stage || '–ë–µ–∑ —ç—Ç–∞–ø–∞';
                    allStages.add(stage);
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ —ç—Ç–∞–ø—ã —Å–≤–µ—Ä–Ω—É—Ç—ã
                const allStagesCollapsed = allStages.size > 0 && allStages.size === collapsedStages.size && 
                    Array.from(allStages).every(stageName => collapsedStages.has(stageName));
                
                // –ï—Å–ª–∏ –≤—Å–µ —ç—Ç–∞–ø—ã —Å–≤–µ—Ä–Ω—É—Ç—ã - —Å–∫—Ä—ã–≤–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª
                if (allStagesCollapsed) {
                    chartContainerElement.style.overflowY = 'hidden';
                } else {
                    // –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —ç—Ç–∞–ø —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª
                    chartContainerElement.style.overflowY = 'auto';
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —ç—Ç–∞–ø–∞
            function toggleStageCollapse(stageName) {
                const isCollapsed = collapsedStages.has(stageName);
                
                if (isCollapsed) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø–µ—Ä–µ–¥ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ–º
                    const scrollY = window.scrollY || window.pageYOffset;
                    const scrollX = window.scrollX || window.pageXOffset;
                    
                    // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–∏–∞–≥—Ä–∞–º–º—ã
                    const currentChartContainer = document.getElementById('ganttChart');
                    const chartScrollTop = currentChartContainer ? currentChartContainer.scrollTop : 0;
                    const chartScrollLeft = currentChartContainer ? currentChartContainer.scrollLeft : 0;
                    
                    // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —ç—Ç–∞–ø: —É–¥–∞–ª—è–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–≤–µ—Ä–Ω—É—Ç—ã—Ö –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
                    collapsedStages.delete(stageName);
                    
                    // –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –∏ —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
                    renderGantt();
                    renderTable();
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
                    requestAnimationFrame(() => {
                        window.scrollTo(scrollX, scrollY);
                        const newChartContainer = document.getElementById('ganttChart');
                        if (newChartContainer) {
                            newChartContainer.scrollTop = chartScrollTop;
                            newChartContainer.scrollLeft = chartScrollLeft;
                        }
                    });
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç–∫—É —ç—Ç–∞–ø–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
                    setTimeout(() => {
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –µ—â–µ —Ä–∞–∑
                        requestAnimationFrame(() => {
                            window.scrollTo(scrollX, scrollY);
                            const newChartContainer = document.getElementById('ganttChart');
                            if (newChartContainer) {
                                newChartContainer.scrollTop = chartScrollTop;
                                newChartContainer.scrollLeft = chartScrollLeft;
                            }
                        });
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç–∫—É —ç—Ç–∞–ø–∞ –Ω–∞–ø—Ä—è–º—É—é
                        const stageLabel = document.querySelector(`.gantt-stage-label[data-stage-name="${stageName}"]`);
                        if (stageLabel) {
                            stageLabel.style.display = '';
                            stageLabel.classList.remove('collapsed');
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É —ç—Ç–∞–ø–∞ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é
                        updateStageLabel(stageName, false);
                        
                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –≤—Å–µ—Ö –º–µ—Ç–æ–∫ —ç—Ç–∞–ø–æ–≤ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
                        recalculateStageLabelsPositions();
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
                        updateVerticalScrollVisibility();
                        
                        // –§–∏–Ω–∞–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
                        setTimeout(() => {
                            requestAnimationFrame(() => {
                                window.scrollTo(scrollX, scrollY);
                                const newChartContainer = document.getElementById('ganttChart');
                                if (newChartContainer) {
                                    newChartContainer.scrollTop = chartScrollTop;
                                    newChartContainer.scrollLeft = chartScrollLeft;
                                }
                            });
                        }, 100);
                    }, 150);
                } else {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø–µ—Ä–µ–¥ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ–º
                    const scrollY = window.scrollY || window.pageYOffset;
                    const scrollX = window.scrollX || window.pageXOffset;
                    
                    // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–∏–∞–≥—Ä–∞–º–º—ã
                    const currentChartContainer = document.getElementById('ganttChart');
                    const chartScrollTop = currentChartContainer ? currentChartContainer.scrollTop : 0;
                    const chartScrollLeft = currentChartContainer ? currentChartContainer.scrollLeft : 0;
                    
                    // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —ç—Ç–∞–ø
                    collapsedStages.add(stageName);
                    
                    // –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞—Ä–æ–≤ —Å–≤–µ—Ä–Ω—É—Ç—ã—Ö —ç—Ç–∞–ø–æ–≤
                    renderGantt();
                    renderTable();
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
                    requestAnimationFrame(() => {
                        window.scrollTo(scrollX, scrollY);
                        const newChartContainer = document.getElementById('ganttChart');
                        if (newChartContainer) {
                            newChartContainer.scrollTop = chartScrollTop;
                            newChartContainer.scrollLeft = chartScrollLeft;
                        }
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É —ç—Ç–∞–ø–∞
                    setTimeout(() => {
                        updateStageLabel(stageName, true);
                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –≤—Å–µ—Ö –º–µ—Ç–æ–∫ —ç—Ç–∞–ø–æ–≤ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
                        recalculateStageLabelsPositions();
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
                        updateVerticalScrollVisibility();
                        
                        // –§–∏–Ω–∞–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
                        requestAnimationFrame(() => {
                            window.scrollTo(scrollX, scrollY);
                            const newChartContainer = document.getElementById('ganttChart');
                            if (newChartContainer) {
                                newChartContainer.scrollTop = chartScrollTop;
                                newChartContainer.scrollLeft = chartScrollLeft;
                            }
                        });
                    }, 150);
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
            function collapseAllStages() {
                const chartContainer = document.getElementById('ganttChart');
                if (!chartContainer) return;
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —ç—Ç–∞–ø—ã –∏–∑ –∑–∞–¥–∞—á
                const allStages = new Set();
                tasks.forEach(task => {
                    const stage = task.stage || '–ë–µ–∑ —ç—Ç–∞–ø–∞';
                    allStages.add(stage);
                });
                
                // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—Å–µ —ç—Ç–∞–ø—ã
                allStages.forEach(stageName => {
                    if (!collapsedStages.has(stageName)) {
                        collapsedStages.add(stageName);
                    }
                });
                
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
                renderGantt();
                
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –º–µ—Ç–∫–∏ —ç—Ç–∞–ø–æ–≤ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
                setTimeout(() => {
                    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–µ—Ç–∫–∏ —ç—Ç–∞–ø–æ–≤ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ —Å–µ–ª–µ–∫—Ç–æ—Ä
                    const allStageLabels = document.querySelectorAll('.gantt-stage-label');
                    allStageLabels.forEach(label => {
                        label.style.display = 'none';
                    });
                    
                    // –¢–∞–∫–∂–µ –≤—ã–∑—ã–≤–∞–µ–º updateStageLabel –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞)
                    allStages.forEach(stageName => {
                        updateStageLabel(stageName, true);
                    });
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
                    updateVerticalScrollVisibility();
                }, 150);
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
            function expandAllStages() {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —ç—Ç–∞–ø—ã –∏–∑ –∑–∞–¥–∞—á
                const allStages = new Set();
                tasks.forEach(task => {
                    const stage = task.stage || '–ë–µ–∑ —ç—Ç–∞–ø–∞';
                    allStages.add(stage);
                });
                
                // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—Å–µ —ç—Ç–∞–ø—ã
                collapsedStages.clear();
                
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
                renderGantt();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –º–µ—Ç–∫–∏ —ç—Ç–∞–ø–æ–≤ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
                setTimeout(() => {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –º–µ—Ç–∫–∏ —ç—Ç–∞–ø–æ–≤ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ —Å–µ–ª–µ–∫—Ç–æ—Ä
                    const allStageLabels = document.querySelectorAll('.gantt-stage-label');
                    allStageLabels.forEach(label => {
                        label.style.display = '';
                    });
                    
                    // –¢–∞–∫–∂–µ –≤—ã–∑—ã–≤–∞–µ–º updateStageLabel –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
                    allStages.forEach(stageName => {
                        updateStageLabel(stageName, false);
                    });
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
                    updateVerticalScrollVisibility();
                }, 150);
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ —ç—Ç–∞–ø–∞ (—Å–≤–µ—Ä–Ω—É—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
            function createStageRow(stageName, stageTasks, stageIndex, timelineUnits, pxPerDay, ganttBarStyle) {
                const stageData = calculateStageData(stageTasks);
                const stageMatch = stageName.match(/^(–≠—Ç–∞–ø\s+\d+)/);
                const stageNumber = stageMatch ? stageMatch[1] : stageName;
                
                const row = document.createElement('div');
                row.className = 'gantt-row stage-row-collapsed';
                row.dataset.stageName = stageName;
                row.dataset.isStageRow = 'true';
                
                // –ù–µ –¥–µ–ª–∞–µ–º —Å—Ç—Ä–æ–∫—É —ç—Ç–∞–ø–∞ draggable
                row.draggable = false;
                
                // Label —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —ç—Ç–∞–ø–∞
                const label = document.createElement('div');
                label.className = 'gantt-label';
                applyColumnWidth(label, 'label');
                const labelSpan = document.createElement('span');
                labelSpan.textContent = stageNumber;
                labelSpan.style.fontWeight = '600';
                labelSpan.style.color = 'var(--color-primary)';
                label.appendChild(labelSpan);
                row.appendChild(label);
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ "–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ / –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è / –†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π"
                const detailsRow = document.createElement('div');
                detailsRow.className = 'gantt-details-row';
                
                // –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
                const startCell = document.createElement('div');
                startCell.className = 'gantt-details-cell';
                const startInput = document.createElement('input');
                startInput.type = 'date';
                startInput.className = 'gantt-details-input';
                startInput.value = stageData.startDate ? formatDateForInput(stageData.startDate) : '';
                startInput.setAttribute('readonly', 'readonly');
                startInput.setAttribute('disabled', 'disabled');
                startCell.appendChild(startInput);
                applyColumnWidth(startCell, 'start');
                
                // –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                const endCell = document.createElement('div');
                endCell.className = 'gantt-details-cell';
                const endInput = document.createElement('input');
                endInput.type = 'date';
                endInput.className = 'gantt-details-input';
                endInput.value = stageData.endDate ? formatDateForInput(stageData.endDate) : '';
                endInput.setAttribute('readonly', 'readonly');
                endInput.setAttribute('disabled', 'disabled');
                endCell.appendChild(endInput);
                applyColumnWidth(endCell, 'end');
                
                // –†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
                const daysCell = document.createElement('div');
                daysCell.className = 'gantt-details-cell';
                const daysInput = document.createElement('input');
                daysInput.type = 'number';
                daysInput.min = '0';
                daysInput.className = 'gantt-details-input';
                daysInput.value = stageData.workdays;
                daysInput.setAttribute('readonly', 'readonly');
                daysInput.setAttribute('disabled', 'disabled');
                daysCell.appendChild(daysInput);
                applyColumnWidth(daysCell, 'days');
                
                detailsRow.appendChild(startCell);
                detailsRow.appendChild(endCell);
                detailsRow.appendChild(daysCell);
                
                // –Ø—á–µ–π–∫–∞ "–°–≤—è–∑—å" - –ø—É—Å—Ç–∞—è –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è —Å—Ç—Ä–æ–∫–∏ —ç—Ç–∞–ø–∞
                const linkCell = document.createElement('div');
                linkCell.className = 'gantt-details-cell link-cell';
                const linkSelect = document.createElement('select');
                linkSelect.className = 'link-select';
                linkSelect.disabled = true;
                linkCell.appendChild(linkSelect);
                detailsRow.appendChild(linkCell);
                
                // –Ø—á–µ–π–∫–∞ "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" - –ø—É—Å—Ç–∞—è –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è —Å—Ç—Ä–æ–∫–∏ —ç—Ç–∞–ø–∞
                const respCell = document.createElement('div');
                respCell.className = 'gantt-details-cell responsible-cell';
                respCell.textContent = '';
                detailsRow.appendChild(respCell);
                
                row.appendChild(detailsRow);
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏ —ç—Ç–∞–ø–∞ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –±–∞—Ä–æ–≤
                let stageWorkdays = [];
                if (stageData.startDate && stageData.endDate) {
                    stageWorkdays = getWorkdaysBetween(stageData.startDate, stageData.endDate);
                }
                
                // –°–æ–∑–¥–∞–µ–º —è—á–µ–π–∫–∏ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª—ã —Å –±–∞—Ä–∞–º–∏ –¥–ª—è —ç—Ç–∞–ø–∞
                const msInDay = 24 * 60 * 60 * 1000;
                timelineUnits.forEach((unit, unitIdx) => {
                    const cell = document.createElement('div');
                    cell.className = 'gantt-cell';
                    const unitDays = Math.round((unit.end - unit.start) / msInDay) + 1;
                    const width = Math.max(30, unitDays * pxPerDay);
                    cell.style.minWidth = width + 'px';
                    cell.style.width = width + 'px';
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏ —ç—Ç–∞–ø–∞ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—É—â–µ–π –µ–¥–∏–Ω–∏—Ü—ã –≤—Ä–µ–º–µ–Ω–∏
                    const unitDatesForStage = stageWorkdays.filter(d => {
                        const time = d.getTime();
                        return time >= unit.start.getTime() && time <= unit.end.getTime();
                    });
                    
                    const hasWorkInUnit = unitDatesForStage.length > 0;
                    
                    if (hasWorkInUnit) {
                        // –°–æ–∑–¥–∞–µ–º –±–∞—Ä –¥–ª—è —ç—Ç–∞–ø–∞
                        const bar = document.createElement('div');
                        bar.className = 'gantt-bar'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ç–∞—Ç—É—Å "pending" (—Å–∏–Ω–∏–π)
                        
                        // –í —Ä–µ–∂–∏–º–µ –ø–æ–ª–æ—Å —É–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª –∏ —É–ø—Ä–∞–≤–ª—è–µ–º —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º/–≥—Ä–∞–Ω–∏—Ü–∞–º–∏
                        if (ganttBarStyle === 'segments') {
                            bar.textContent = '';
                            
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–Ω–∏ —ç—Ç–∞–ø–∞ –≤ —Å–æ—Å–µ–¥–Ω–∏—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö –≤—Ä–µ–º–µ–Ω–∏
                            const hasPrev = unitIdx > 0 && stageWorkdays.some(d => {
                                const t = d.getTime();
                                const prev = timelineUnits[unitIdx - 1];
                                return t >= prev.start.getTime() && t <= prev.end.getTime();
                            });
                            const hasNext = unitIdx < timelineUnits.length - 1 && stageWorkdays.some(d => {
                                const t = d.getTime();
                                const next = timelineUnits[unitIdx + 1];
                                return t >= next.start.getTime() && t <= next.end.getTime();
                            });
                            
                            if (hasPrev && hasNext) {
                                bar.classList.add('segment-middle');
                            } else if (!hasPrev && hasNext) {
                                bar.classList.add('segment-start');
                            } else if (hasPrev && !hasNext) {
                                bar.classList.add('segment-end');
                            } else if (!hasPrev && !hasNext) {
                                bar.classList.add('segment-single');
                            }
                        } else {
                            bar.textContent = '‚ñ†';
                        }
                        
                        bar.title = '';
                        bar.style.cursor = 'pointer';
                        
                        // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –±–∞—Ä —ç—Ç–∞–ø–∞ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —ç—Ç–∞–ø
                        bar.addEventListener('click', (event) => {
                            event.stopPropagation();
                            toggleStageCollapse(stageName);
                        });
                        
                        cell.appendChild(bar);
                    }
                    
                    row.appendChild(cell);
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —ç—Ç–∞–ø–∞
                row.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleStageCollapse(stageName);
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫—É—Ä—Å–æ—Ä pointer –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏
                row.style.cursor = 'pointer';
                
                return row;
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∑–∞–¥–∞—á —ç—Ç–∞–ø–∞
            function updateStageTasksVisibility(stageName, isCollapsing) {
                const tasksByStage = {};
                tasks.forEach((task, index) => {
                    const stage = task.stage || '–ë–µ–∑ —ç—Ç–∞–ø–∞';
                    if (!tasksByStage[stage]) {
                        tasksByStage[stage] = [];
                    }
                    tasksByStage[stage].push({ task, index });
                });

                const stageTasks = tasksByStage[stageName] || [];
                
                if (isCollapsing) {
                    // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º: –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞—Ä–æ–≤ —Å–≤–µ—Ä–Ω—É—Ç—ã—Ö —ç—Ç–∞–ø–æ–≤
                    // renderGantt() —É–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ toggleStageCollapse(), –ø–æ—ç—Ç–æ–º—É –∑–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
                    const firstTableRow = document.querySelector(`#tasksTableBody tr[data-task-id="${stageTasks[0].task.id}"]`);
                    if (firstTableRow) {
                        const oldStageTableRow = document.querySelector(`#tasksTableBody tr[data-stage-name="${stageName}"]`);
                        if (oldStageTableRow) {
                            oldStageTableRow.remove();
                        }
                        const stageTableRow = createStageTableRow(stageName, stageTasks);
                        firstTableRow.parentNode.insertBefore(stageTableRow, firstTableRow);
                    }
                } else {
                    // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º: —É–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —ç—Ç–∞–ø–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–¥–∞—á–∏
                    // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —ç—Ç–∞–ø–∞ –∏–∑ –¥–∏–∞–≥—Ä–∞–º–º—ã –ì–∞–Ω—Ç–∞
                    const stageRow = chartContainer.querySelector(`[data-stage-name="${stageName}"]`);
                    if (stageRow) {
                        stageRow.remove();
                    }
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —ç—Ç–∞–ø–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–¥–∞—á
                    const stageTableRow = document.querySelector(`#tasksTableBody tr[data-stage-name="${stageName}"]`);
                    if (stageTableRow) {
                        stageTableRow.remove();
                    }
                    
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –∑–∞–¥–∞—á –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
                    setTimeout(() => {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ —ç—Ç–∞–ø–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                        stageTasks.forEach(({ task }, index) => {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –≤ –¥–∏–∞–≥—Ä–∞–º–º–µ –ì–∞–Ω—Ç–∞
                            const taskRow = chartContainer.querySelector(`[data-task-id="${task.id}"]`);
                            if (taskRow) {
                                // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å stage-collapsed, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                                taskRow.classList.remove('stage-collapsed');
                                taskRow.style.display = '';
                                taskRow.style.visibility = 'visible';
                                setTimeout(() => {
                                    taskRow.classList.add('expanding');
                                    setTimeout(() => {
                                        taskRow.classList.remove('expanding');
                                    }, 300);
                                }, index * 50);
                            }
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ –∑–∞–¥–∞—á
                            const tableRow = document.querySelector(`#tasksTableBody tr[data-task-id="${task.id}"]`);
                            if (tableRow) {
                                // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å stage-collapsed, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                                tableRow.classList.remove('stage-collapsed');
                                tableRow.style.display = '';
                                tableRow.style.visibility = 'visible';
                                setTimeout(() => {
                                    tableRow.classList.add('expanding');
                                    setTimeout(() => {
                                        tableRow.classList.remove('expanding');
                                    }, 300);
                                }, index * 50);
                            }
                        });
                    }, 50);
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏ —ç—Ç–∞–ø–∞
            function updateStageLabel(stageName, isCollapsing) {
                const stageLabel = document.querySelector(`.gantt-stage-label[data-stage-name="${stageName}"]`);
                if (!stageLabel) return;

                if (isCollapsing) {
                    // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º: —Å–∫—Ä—ã–≤–∞–µ–º –º–µ—Ç–∫—É —ç—Ç–∞–ø–∞ (—Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–∞ —ç—Ç–∞–ø–∞)
                    stageLabel.style.display = 'none';
                    
                    // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É —ç—Ç–∞–ø–∞ –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                    const tasksByStage = {};
                    tasks.forEach((task, index) => {
                        const stage = task.stage || '–ë–µ–∑ —ç—Ç–∞–ø–∞';
                        if (!tasksByStage[stage]) {
                            tasksByStage[stage] = [];
                        }
                        tasksByStage[stage].push({ task, index });
                    });
                    
                    const stageTasks = tasksByStage[stageName] || [];
                    if (stageTasks.length > 0) {
                        const firstTaskRow = chartContainer.querySelector(`[data-task-id="${stageTasks[0].task.id}"]`);
                        if (firstTaskRow) {
                            const rowRect = firstTaskRow.getBoundingClientRect();
                            const chartContainerParent = chartContainer.closest('.chart-container');
                            if (chartContainerParent) {
                                const containerRect = chartContainerParent.getBoundingClientRect();
                                const stageTop = rowRect.top - containerRect.top;
                                stageLabel.style.top = stageTop + 'px';
                                stageLabel.style.height = '35px';
                            }
                        }
                    }
                } else {
                    // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç–∫—É —ç—Ç–∞–ø–∞ –æ–±—Ä–∞—Ç–Ω–æ
                    stageLabel.style.display = '';
                    stageLabel.classList.remove('collapsed');
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É —ç—Ç–∞–ø–∞
                    const tasksByStage = {};
                    tasks.forEach((task, index) => {
                        const stage = task.stage || '–ë–µ–∑ —ç—Ç–∞–ø–∞';
                        if (!tasksByStage[stage]) {
                            tasksByStage[stage] = [];
                        }
                        tasksByStage[stage].push({ task, index });
                    });
                    
                    const stageTasks = tasksByStage[stageName] || [];
                    if (stageTasks.length > 0) {
                        const firstTaskRow = chartContainer.querySelector(`[data-task-id="${stageTasks[0].task.id}"]`);
                        if (firstTaskRow) {
                            const rowRect = firstTaskRow.getBoundingClientRect();
                            const chartContainerParent = chartContainer.closest('.chart-container');
                            if (chartContainerParent) {
                                const containerRect = chartContainerParent.getBoundingClientRect();
                                const stageTop = rowRect.top - containerRect.top;
                                
                                // –í—ã—á–∏—Å–ª—è–µ–º –≤—ã—Å–æ—Ç—É —ç—Ç–∞–ø–∞
                                let stageHeight = 0;
                                stageTasks.forEach(({ task }) => {
                                    const taskRow = chartContainer.querySelector(`[data-task-id="${task.id}"]`);
                                    if (taskRow && !taskRow.classList.contains('stage-collapsed')) {
                                        stageHeight += taskRow.offsetHeight || 35;
                                    }
                                });
                                
                                stageLabel.style.top = stageTop + 'px';
                                stageLabel.style.height = stageHeight + 'px';
                            }
                        }
                    }
                }
            }

            // –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞—á —Å–æ–∑–¥–∞–µ–º –º–µ—Ç–∫–∏ —ç—Ç–∞–ø–æ–≤ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            function createStageLabels() {
                // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–Ω–æ–≤–æ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ DOM –∏–∑–º–µ–Ω–∏–ª—Å—è)
                const currentChartContainerParent = chartContainer.closest('.chart-container');
                const currentStageLabelsContainer = currentChartContainerParent 
                    ? currentChartContainerParent.querySelector('.gantt-stage-labels')
                    : chartContainer.querySelector('.gantt-stage-labels');
                
                // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤—ã—Ö–æ–¥–∏–º
                if (!currentStageLabelsContainer || !currentChartContainerParent) {
                    console.warn('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–µ—Ç–æ–∫ —ç—Ç–∞–ø–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å
                const oldControlsContainer = currentChartContainerParent.querySelector('.gantt-stage-controls');
                if (oldControlsContainer) {
                    oldControlsContainer.remove();
                }
                
                // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–Ω–∞–¥ –º–µ—Ç–∫–∞–º–∏ —ç—Ç–∞–ø–æ–≤)
                const controlsContainer = document.createElement('div');
                controlsContainer.className = 'gantt-stage-controls';
                
                // –ö–Ω–æ–ø–∫–∞ "+" –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
                const collapseBtn = document.createElement('button');
                collapseBtn.className = 'gantt-stage-control-btn';
                collapseBtn.textContent = '+';
                collapseBtn.title = '–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ —ç—Ç–∞–ø—ã';
                collapseBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    collapseAllStages();
                });
                
                // –ö–Ω–æ–ø–∫–∞ "-" –¥–ª—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
                const expandBtn = document.createElement('button');
                expandBtn.className = 'gantt-stage-control-btn';
                expandBtn.textContent = '‚àí';
                expandBtn.title = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ —ç—Ç–∞–ø—ã';
                expandBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    expandAllStages();
                });
                
                controlsContainer.appendChild(collapseBtn);
                controlsContainer.appendChild(expandBtn);
                currentChartContainerParent.appendChild(controlsContainer);
                
                // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–∫–∏ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
                currentStageLabelsContainer.innerHTML = '';
                const oldDividers = currentChartContainerParent.querySelectorAll('.gantt-stage-divider');
                oldDividers.forEach(divider => divider.remove());
                
                const headerHeight = header.offsetHeight || 80;
                let currentTop = headerHeight;
                
                // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∑–∞–≥–æ–ª–æ–≤–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ .chart-container
                if (currentChartContainerParent && header) {
                    const headerRect = header.getBoundingClientRect();
                    const containerRect = currentChartContainerParent.getBoundingClientRect();
                    currentTop = Math.max(0, headerRect.top - containerRect.top);
                }
                
                // –í—ã—á–∏—Å–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é (–≤—ã—Å–æ—Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
                let accumulatedTop = headerHeight;
                
                // –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∫–∏ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
                Object.keys(tasksByStage).forEach((stageName, stageIndex) => {
                    const stageTasks = tasksByStage[stageName];
                    const isStageCollapsed = collapsedStages.has(stageName);
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –≤—ã—Å–æ—Ç—É —ç—Ç–∞–ø–∞ (—Å—É–º–º–∞ –≤—ã—Å–æ—Ç –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ —ç—Ç–∞–ø–∞)
                    let stageHeight = 0;
                    let actualTopForLabel = accumulatedTop;
                    
                    if (isStageCollapsed) {
                        const stageRow = chartContainer.querySelector(`[data-stage-name="${stageName}"]`);
                        if (stageRow) {
                            stageHeight = stageRow.offsetHeight || 35;
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é —Å—Ç—Ä–æ–∫–∏ —ç—Ç–∞–ø–∞
                            // –î–æ–±–∞–≤–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –≤–Ω–∏–∑ (10px) –¥–ª—è —É—á–µ—Ç–∞ padding –º–µ—Ç–∫–∏ (8px) –∏ –ª—É—á—à–µ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
                            actualTopForLabel = stageRow.offsetTop + 10;
                        } else {
                            stageHeight = 35;
                        }
                    } else {
                        // –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
                        if (stageTasks.length > 0) {
                            const firstTaskRow = chartContainer.querySelector(`[data-task-id="${stageTasks[0].task.id}"]`);
                            if (firstTaskRow && !firstTaskRow.classList.contains('stage-collapsed')) {
                                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏
                                // –î–æ–±–∞–≤–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –≤–Ω–∏–∑ (10px) –¥–ª—è —É—á–µ—Ç–∞ padding –º–µ—Ç–∫–∏ (8px) –∏ –ª—É—á—à–µ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
                                actualTopForLabel = firstTaskRow.offsetTop + 10;
                            }
                        }
                        
                        stageTasks.forEach(({ task }) => {
                            const taskRow = chartContainer.querySelector(`[data-task-id="${task.id}"]`);
                            if (taskRow && !taskRow.classList.contains('stage-collapsed')) {
                                stageHeight += taskRow.offsetHeight || 35;
                            }
                        });
                    }
                    
                    // –ï—Å–ª–∏ –≤—ã—Å–æ—Ç–∞ –Ω–µ –≤—ã—á–∏—Å–ª–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é
                    if (stageHeight === 0) {
                        stageHeight = isStageCollapsed ? 35 : (stageTasks.length * 35);
                    }
                    
                    // –ï—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
                    if (actualTopForLabel === accumulatedTop && stageIndex > 0) {
                        // –î–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —ç—Ç–∞–ø–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
                        actualTopForLabel = accumulatedTop;
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω—É—é –ø–æ–ª–æ—Å—É –ø–µ—Ä–µ–¥ —ç—Ç–∞–ø–æ–º (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ)
                    if (stageIndex > 0) {
                        const divider = document.createElement('div');
                        divider.className = 'gantt-stage-divider';
                        divider.setAttribute('data-stage-index', stageIndex);
                        divider.style.top = (actualTopForLabel - 2) + 'px';
                        currentChartContainerParent.appendChild(divider);
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∫—É —ç—Ç–∞–ø–∞
                    const stageLabel = document.createElement('div');
                    stageLabel.className = 'gantt-stage-label';
                    const stageMatch = stageName.match(/^(–≠—Ç–∞–ø\s+\d+)/);
                    const stageNumber = stageMatch ? stageMatch[1] : stageName;
                    stageLabel.textContent = stageNumber;
                    stageLabel.setAttribute('data-stage-name', stageName);
                    stageLabel.style.top = actualTopForLabel + 'px';
                    stageLabel.style.height = stageHeight + 'px';
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–≤–µ—Ä–Ω—É—Ç –ª–∏ —ç—Ç–∞–ø
                    if (isStageCollapsed) {
                        stageLabel.classList.add('collapsed');
                        stageLabel.style.height = '35px';
                        stageLabel.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –º–µ—Ç–∫—É –ø—Ä–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏
                        stageHeight = 35;
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
                    stageLabel.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleStageCollapse(stageName);
                    });
                    
                    
                    currentStageLabelsContainer.appendChild(stageLabel);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —ç—Ç–∞–ø–∞
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –∏ –≤—ã—Å–æ—Ç—É —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
                    accumulatedTop = actualTopForLabel + stageHeight + 2;
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç—Ç–∞–ø–∞, –µ—Å–ª–∏ –æ–Ω —Å–≤–µ—Ä–Ω—É—Ç
                const stageNames = Object.keys(tasksByStage);
                if (stageNames.length > 0) {
                    const lastStageName = stageNames[stageNames.length - 1];
                    const isLastStageCollapsed = collapsedStages.has(lastStageName);
                    if (isLastStageCollapsed) {
                        // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç—Ç–∞–ø–∞
                        // accumulatedTop —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–∑–∏—Ü–∏—é –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç—Ç–∞–ø–∞ (–≤–∫–ª—é—á–∞—è –æ—Ç—Å—Ç—É–ø 2px)
                        // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –∫–æ–Ω—Ü–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç—Ç–∞–ø–∞, —Ç–æ –µ—Å—Ç—å –Ω–∞ accumulatedTop - 2
                        let lastDivider = currentChartContainerParent.querySelector('.gantt-stage-divider[data-stage-index="last"]');
                        if (!lastDivider) {
                            lastDivider = document.createElement('div');
                            lastDivider.className = 'gantt-stage-divider';
                            lastDivider.setAttribute('data-stage-index', 'last');
                            currentChartContainerParent.appendChild(lastDivider);
                        }
                        lastDivider.style.top = (accumulatedTop - 2) + 'px';
                    } else {
                        // –£–¥–∞–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç—Ç–∞–ø–∞, –µ—Å–ª–∏ –æ–Ω —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç
                        const lastDivider = currentChartContainerParent.querySelector('.gantt-stage-divider[data-stage-index="last"]');
                        if (lastDivider) {
                            lastDivider.remove();
                        }
                    }
                }
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å–µ—Ö –º–µ—Ç–æ–∫ (–¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ)
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–µ—Ä–µ—Å—á–µ—Ç–æ–≤ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        recalculateStageLabelsPositions();
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                        setTimeout(() => {
                            recalculateStageLabelsPositions();
                        }, 100);
                    });
                });
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ –ø–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫
            updateStickyColumns();

            // –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∫–∏ —ç—Ç–∞–ø–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º requestAnimationFrame –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ DOM
            requestAnimationFrame(() => {
                setTimeout(() => {
                    createStageLabels();
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç —á–µ—Ä–µ–∑ –±–æ–ª—å—à–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                    setTimeout(() => {
                        recalculateStageLabelsPositions();
                    }, 300);
                }, 100);
            });

            // –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ (–µ—Å–ª–∏ –±—ã–ª–∞)
            applySelectionHighlight();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            setTimeout(() => {
                updateVerticalScrollVisibility();
            }, 100);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —Ñ–æ–Ω –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è –∑–∞–¥–∞—á
            // (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –Ω–∞ —Ñ–æ–Ω, –∞ –Ω–µ –Ω–∞ –∑–∞–¥–∞—á—É)
            if (chartContainer && !chartContainer.hasAttribute('data-selection-handler')) {
                chartContainer.setAttribute('data-selection-handler', 'true');
                chartContainer.addEventListener('click', (event) => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –±—ã–ª –Ω–∞ —Ñ–æ–Ω (–Ω–µ –Ω–∞ –∑–∞–¥–∞—á—É, –Ω–µ –Ω–∞ —è—á–µ–π–∫—É, –Ω–µ –Ω–∞ –±–∞—Ä)
                    const target = event.target;
                    if (target && 
                        !target.closest('.gantt-row') && 
                        !target.closest('.gantt-bar') && 
                        !target.closest('.gantt-cell') &&
                        !target.closest('.gantt-label') &&
                        !target.closest('.gantt-details-cell')) {
                        // –ö–ª–∏–∫ –Ω–∞ —Ñ–æ–Ω - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á
                        clearSelection();
                    }
                });
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —ç—Ç–∞–ø–∞ (–¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞, –æ–∫–æ–Ω—á–∞–Ω–∏—è, —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π)
        function calculateStageData(stageTasks) {
            if (!stageTasks || stageTasks.length === 0) {
                return { startDate: null, endDate: null, workdays: 0 };
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è
            let minStartDate = null;
            let maxEndDate = null;
            
            stageTasks.forEach(({ task }) => {
                if (task.startDate) {
                    const startDate = task.startDate instanceof Date ? task.startDate : new Date(task.startDate);
                    if (!minStartDate || startDate < minStartDate) {
                        minStartDate = startDate;
                    }
                }
                if (task.endDate) {
                    const endDate = task.endDate instanceof Date ? task.endDate : new Date(task.endDate);
                    if (!maxEndDate || endDate > maxEndDate) {
                        maxEndDate = endDate;
                    }
                }
            });
            
            // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –º–µ–∂–¥—É –¥–∞—Ç–∞–º–∏
            let workdays = 0;
            if (minStartDate && maxEndDate) {
                const workdaysArray = getWorkdaysBetween(minStartDate, maxEndDate);
                workdays = workdaysArray.length;
            }
            
            return { startDate: minStartDate, endDate: maxEndDate, workdays };
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ —ç—Ç–∞–ø–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ –∑–∞–¥–∞—á
        function createStageTableRow(stageName, stageTasks) {
            const stageData = calculateStageData(stageTasks);
            const stageMatch = stageName.match(/^(–≠—Ç–∞–ø\s+\d+)/);
            const stageNumber = stageMatch ? stageMatch[1] : stageName;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—Ç–æ–ª–±—Ü–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
            const columns = skeletonColumns || [
                { id: 'stage', name: '–≠—Ç–∞–ø', field: 'stage', order: 0 },
                { id: 'control', name: '–í–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è', field: 'control', order: 1 },
                { id: 'task', name: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ', field: 'task', order: 2 }
            ];
            const sortedColumns = [...columns].sort((a, b) => a.order - b.order);
            
            const row = document.createElement('tr');
            row.className = 'stage-row-collapsed';
            row.dataset.stageName = stageName;
            row.dataset.isStageRow = 'true';
            
            // –Ø—á–µ–π–∫–∞ —Å –Ω–æ–º–µ—Ä–æ–º (–ø—É—Å—Ç–∞—è –¥–ª—è —Å—Ç—Ä–æ–∫–∏ —ç—Ç–∞–ø–∞)
            const numCell = document.createElement('td');
            numCell.textContent = '';
            row.appendChild(numCell);
            
            // –Ø—á–µ–π–∫–∞ "–í—ã–±–æ—Ä —ç—Ç–∞–ø–∞" (–ø—É—Å—Ç–∞—è –¥–ª—è —Å—Ç—Ä–æ–∫–∏ —ç—Ç–∞–ø–∞)
            const stageSelectCell = document.createElement('td');
            stageSelectCell.textContent = '';
            row.appendChild(stageSelectCell);
            
            // –Ø—á–µ–π–∫–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ - –ø–µ—Ä–≤–∞—è —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —ç—Ç–∞–ø–∞, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—É—Å—Ç—ã–µ
            sortedColumns.forEach((col, colIndex) => {
                const cell = document.createElement('td');
                if (colIndex === 0 && col.field === 'stage') {
                    // –ü–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–æ–±—ã—á–Ω–æ "–≠—Ç–∞–ø") - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = stageNumber;
                    nameSpan.style.fontWeight = '600';
                    nameSpan.style.color = 'var(--color-primary)';
                    cell.appendChild(nameSpan);
                } else {
                    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ - –ø—É—Å—Ç—ã–µ
                    cell.textContent = '';
                }
                row.appendChild(cell);
            });
            
            // –Ø—á–µ–π–∫–∞ —Å –¥–∞—Ç–æ–π –Ω–∞—á–∞–ª–∞
            const startCell = document.createElement('td');
            const startInput = document.createElement('input');
            startInput.type = 'date';
            startInput.className = 'tasks-table-input';
            startInput.value = stageData.startDate ? formatDateForInput(stageData.startDate) : '';
            startInput.setAttribute('readonly', 'readonly');
            startInput.setAttribute('disabled', 'disabled');
            startCell.appendChild(startInput);
            row.appendChild(startCell);
            
            // –Ø—á–µ–π–∫–∞ —Å –¥–∞—Ç–æ–π –æ–∫–æ–Ω—á–∞–Ω–∏—è
            const endCell = document.createElement('td');
            const endInput = document.createElement('input');
            endInput.type = 'date';
            endInput.className = 'tasks-table-input';
            endInput.value = stageData.endDate ? formatDateForInput(stageData.endDate) : '';
            endInput.setAttribute('readonly', 'readonly');
            endInput.setAttribute('disabled', 'disabled');
            endCell.appendChild(endInput);
            row.appendChild(endCell);
            
            // –Ø—á–µ–π–∫–∞ —Å —Ä–∞–±–æ—á–∏–º–∏ –¥–Ω—è–º–∏
            const daysCell = document.createElement('td');
            const daysInput = document.createElement('input');
            daysInput.type = 'number';
            daysInput.className = 'tasks-table-input';
            daysInput.min = '0';
            daysInput.value = stageData.workdays;
            daysInput.setAttribute('readonly', 'readonly');
            daysInput.setAttribute('disabled', 'disabled');
            daysCell.appendChild(daysInput);
            row.appendChild(daysCell);
            
            // –Ø—á–µ–π–∫–∞ "–°–≤—è–∑—å" (–ø—É—Å—Ç–∞—è –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è —Å—Ç—Ä–æ–∫–∏ —ç—Ç–∞–ø–∞)
            const linkCell = document.createElement('td');
            linkCell.className = 'table-col-link';
            const linkSelect = document.createElement('select');
            linkSelect.className = 'link-select';
            linkSelect.disabled = true;
            linkCell.appendChild(linkSelect);
            row.appendChild(linkCell);
            
            // –Ø—á–µ–π–∫–∞ "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" (–ø—É—Å—Ç–∞—è –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è —Å—Ç—Ä–æ–∫–∏ —ç—Ç–∞–ø–∞)
            const respCell = document.createElement('td');
            respCell.className = 'table-col-responsible';
            respCell.textContent = '';
            row.appendChild(respCell);
            
            // –Ø—á–µ–π–∫–∞ "–°—Ç–∞—Ç—É—Å" (–ø—É—Å—Ç–∞—è –¥–ª—è —Å—Ç—Ä–æ–∫–∏ —ç—Ç–∞–ø–∞)
            const statusCell = document.createElement('td');
            statusCell.textContent = '';
            row.appendChild(statusCell);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —ç—Ç–∞–ø–∞
            row.addEventListener('click', (e) => {
                e.stopPropagation();
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —ç—Ç–∞–ø–∞ –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
                const isCollapsed = collapsedStages.has(stageName);
                if (isCollapsed) {
                    collapsedStages.delete(stageName);
                } else {
                    collapsedStages.add(stageName);
                }
                renderGantt();
                renderTable();
            });
            
            return row;
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
        function updateTableHeader() {
            const thead = document.querySelector('#tasksTable thead tr');
            if (!thead) {
                console.warn('‚ö†Ô∏è –®–∞–ø–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞');
                return;
            }

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—Ç–æ–ª–±—Ü–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
            const columns = skeletonColumns || [
                { id: 'stage', name: '–≠—Ç–∞–ø', field: 'stage', order: 0 },
                { id: 'control', name: '–í–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è', field: 'control', order: 1 },
                { id: 'task', name: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ', field: 'task', order: 2 }
            ];

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–æ–ª–±—Ü—ã –ø–æ –ø–æ—Ä—è–¥–∫—É
            const sortedColumns = [...columns].sort((a, b) => a.order - b.order);

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤
            const headerCells = [
                '<th>‚Ññ –ø/–ø</th>',
                '<th>–í—ã–±–æ—Ä —ç—Ç–∞–ø–∞</th>',
                ...sortedColumns.map(col => `<th>${col.name}</th>`),
                '<th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th>',
                '<th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>',
                '<th>–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π</th>',
                '<th class="table-col-link">–°–≤—è–∑—å</th>',
                '<th class="table-col-responsible">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>',
                '<th>–°—Ç–∞—Ç—É—Å</th>'
            ];

            thead.innerHTML = headerCells.join('');
            console.log('‚úÖ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –æ–±–Ω–æ–≤–ª–µ–Ω, —Å—Ç–æ–ª–±—Ü–æ–≤:', headerCells.length);
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
        function renderTable() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–µ–¥ –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π
            updateTableHeader();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º onTravel –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á, –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
            tasks.forEach(task => {
                if (task.onTravel === undefined) {
                    task.onTravel = false;
                }
            });
            
            const tbody = document.getElementById('tasksTableBody');
            tbody.innerHTML = '';

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—Ç–æ–ª–±—Ü–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
            const columns = skeletonColumns || [
                { id: 'stage', name: '–≠—Ç–∞–ø', field: 'stage', order: 0 },
                { id: 'control', name: '–í–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è', field: 'control', order: 1 },
                { id: 'task', name: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ', field: 'task', order: 2 }
            ];
            const sortedColumns = [...columns].sort((a, b) => a.order - b.order);

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ —ç—Ç–∞–ø–∞–º
            const tasksByStage = {};
            tasks.forEach((task, index) => {
                const stage = task.stage || '–ë–µ–∑ —ç—Ç–∞–ø–∞';
                if (!tasksByStage[stage]) {
                    tasksByStage[stage] = [];
                }
                tasksByStage[stage].push({ task, index });
            });

            // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∑–∞–¥–∞—á–∏ –ø–æ —ç—Ç–∞–ø–∞–º
            Object.keys(tasksByStage).forEach((stageName, stageIndex) => {
                const stageTasks = tasksByStage[stageName];
                const isStageCollapsed = collapsedStages.has(stageName);

                // –ï—Å–ª–∏ —ç—Ç–∞–ø —Å–≤–µ—Ä–Ω—É—Ç, —Å–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É —ç—Ç–∞–ø–∞ –≤–º–µ—Å—Ç–æ –≤—Å–µ—Ö –∑–∞–¥–∞—á
                if (isStageCollapsed) {
                    const stageTableRow = createStageTableRow(stageName, stageTasks);
                    tbody.appendChild(stageTableRow);
                    return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É –∑–∞–¥–∞—á —ç—Ç–∞–ø–∞
                }

                // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞
                stageTasks.forEach(({ task, index }) => {
                const row = document.createElement('tr');
                row.dataset.taskId = String(task.id);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–≤–µ—Ä–Ω—É—Ç –ª–∏ —ç—Ç–∞–ø –∑–∞–¥–∞—á–∏
                const taskStage = task.stage || '–ë–µ–∑ —ç—Ç–∞–ø–∞';
                if (collapsedStages.has(taskStage)) {
                    row.classList.add('stage-collapsed');
                }

                // –°—Ç–∞—Ç—É—Å —Å—Ç—Ä–æ–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç—Ç–∞–ø–∞
                if (currentStageFilter !== 'all') {
                    if (isTaskInCurrentStage(task)) {
                        row.classList.add('stage-active');
                    } else {
                        row.classList.add('inactive');
                    }
                }
                const startStr = task.startDate ? formatDateForInput(task.startDate) : '';
                const endStr = task.endDate ? formatDateForInput(task.endDate) : '';

                // –†–∞–∑–±–∏—Ä–∞–µ–º —ç—Ç–∞–ø –Ω–∞ –ø—Ä–µ—Ñ–∏–∫—Å "–≠—Ç–∞–ø N" –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —Ö–≤–æ—Å—Ç
                let stagePrefix = '';
                let stageSuffix = task.stage || '';
                let currentStageShort = '';
                const stageMatch = (task.stage || '').match(/^(–≠—Ç–∞–ø\s+\d+\.?\s*)(.*)$/);
                if (stageMatch) {
                    stagePrefix = stageMatch[1];
                    stageSuffix = stageMatch[2] || '';
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞ (–±–µ–∑ —Ç–æ—á–∫–∏ –∏ –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –∫–æ–Ω—Ü–µ)
                    currentStageShort = stageMatch[1].trim().replace(/\.$/, '');
                } else if (task.stage) {
                    // –ï—Å–ª–∏ —ç—Ç–∞–ø –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É "–≠—Ç–∞–ø N", –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ —Ü–µ–ª–∏–∫–æ–º
                    currentStageShort = task.stage;
                }

                // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤
                const availableStages = getAvailableStages();
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —ç—Ç–∞–ø –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–±—Ä–∞–Ω
                let selectedStage = '';
                if (currentStageShort) {
                    // –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–ª–∏ —ç—Ç–∞–ø, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ç–µ–∫—É—â–µ–≥–æ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è
                    const matchedStage = availableStages.find(s => s === currentStageShort || s.startsWith(currentStageShort));
                    selectedStage = matchedStage || currentStageShort;
                } else if (task.stage) {
                    // –ï—Å–ª–∏ —ç—Ç–∞–ø –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É "–≠—Ç–∞–ø N", –∏—â–µ–º –µ–≥–æ –≤ —Å–ø–∏—Å–∫–µ
                    const matchedStage = availableStages.find(s => s === task.stage);
                    selectedStage = matchedStage || (availableStages.length > 0 ? availableStages[0] : '');
                } else {
                    // –ï—Å–ª–∏ —ç—Ç–∞–ø–∞ –Ω–µ—Ç, –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
                    selectedStage = availableStages.length > 0 ? availableStages[0] : '';
                }
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è select
                let stageSelectOptions = '';
                availableStages.forEach(stage => {
                    const isSelected = stage === selectedStage;
                    stageSelectOptions += `<option value="${stage.replace(/"/g, '&quot;')}" ${isSelected ? 'selected' : ''}>${stage}</option>`;
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (–¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞)
                const isEditable = canEdit();
                const disabledAttr = isEditable ? '' : 'disabled';

                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫
                const fullStage = task.stage || '';
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —è—á–µ–π–∫–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
                const columnCells = sortedColumns.map(col => {
                    let cellContent = '';
                    let tooltipAttr = '';
                    
                    if (col.field === 'stage') {
                        // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Å—Ç–æ–ª–±—Ü–∞ "–≠—Ç–∞–ø"
                        const fullValue = task.stage || '';
                        // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –∏ –∞–º–ø–µ—Ä—Å–∞–Ω–¥—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏ –≤ HTML-–∞—Ç—Ä–∏–±—É—Ç
                        const escapedValue = fullValue ? fullValue.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';
                        tooltipAttr = escapedValue ? `data-tooltip="${escapedValue}"` : '';
                        cellContent = `
                            <span class="stage-prefix">${stagePrefix}</span>
                            <input type="text"
                                   class="tasks-table-input"
                                   data-index="${index}"
                                   data-field="stageSuffix"
                                   data-prefix="${stagePrefix}"
                                   title=""
                                   ${isEditable ? '' : 'readonly'}>
                        `;
                    } else {
                        // –û–±—ã—á–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã
                        const value = task[col.field] || '';
                        // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –∏ –∞–º–ø–µ—Ä—Å–∞–Ω–¥—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏ –≤ HTML-–∞—Ç—Ä–∏–±—É—Ç
                        const escapedValue = value ? value.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';
                        tooltipAttr = escapedValue ? `data-tooltip="${escapedValue}"` : '';
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª–µ –¥–ª—è data-field: –¥–ª—è task –∏—Å–ø–æ–ª—å–∑—É–µ–º taskTitle, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - –∏–º—è –ø–æ–ª—è
                        const dataField = col.field === 'task' ? 'taskTitle' : col.field;
                        
                        // –û–±—ã—á–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã - –±–µ–∑ —Å–∞–º–æ–ª–µ—Ç–∞ (—Å–∞–º–æ–ª–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –∫–æ–ª–æ–Ω–∫–µ —Å –Ω–æ–º–µ—Ä–æ–º)
                        cellContent = `
                            <input type="text"
                                   class="tasks-table-input"
                                   data-index="${index}"
                                   data-field="${dataField}"
                                   title=""
                                   ${isEditable ? '' : 'readonly'}>
                        `;
                    }
                    
                    const cellClassAttr = '';
                    return `<td${cellClassAttr} ${tooltipAttr}>${cellContent}</td>`;
                }).join('');
                
                // –ò–∫–æ–Ω–∫–∞ —Å–∞–º–æ–ª–µ—Ç–∏–∫–∞ –≤ –∫–æ–ª–æ–Ω–∫–µ —Å –Ω–æ–º–µ—Ä–æ–º, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ "–Ω–∞ –≤—ã–µ–∑–¥–µ"
                const isOnTravel = task.onTravel === true || task.onTravel === 'true';
                const travelIconRow = isOnTravel 
                    ? '<span class="travel-icon-row" title="–ù–∞ –≤—ã–µ–∑–¥–µ">‚úà</span>' 
                    : '';
                
                row.innerHTML = `
                    <td class="task-number-cell">
                        ${travelIconRow}
                        <span>${index + 1}</span>
                    </td>
                    <td>
                        <select class="tasks-table-input-select" data-index="${index}" data-field="stageSelect" ${disabledAttr}>
                            ${stageSelectOptions}
                        </select>
                    </td>
                    ${columnCells}
                    <td>
                        <input type="date"
                               class="tasks-table-input"
                               value="${startStr}"
                               data-index="${index}"
                               data-field="startDate"
                               ${isEditable ? '' : 'readonly'}>
                    </td>
                    <td>
                        <input type="date"
                               class="tasks-table-input"
                               value="${endStr}"
                               data-index="${index}"
                               data-field="endDate"
                               ${isEditable ? '' : 'readonly'}>
                    </td>
                    <td>
                        <input type="number"
                               class="tasks-table-input"
                               min="0"
                               value="${task.days}"
                               data-index="${index}"
                               data-field="days"
                               ${isEditable ? '' : 'readonly'}>
                    </td>
                    <td class="table-col-link">
                        <select class="tasks-table-input link-select"
                                data-index="${index}"
                                data-field="link"
                                ${isEditable && index > 0 ? '' : 'disabled'}>
                            <option value="–û_–ù" ${(task.link === '–û_–ù' || !task.link) ? 'selected' : ''}>–û_–ù</option>
                            <option value="–ù_–ù" ${task.link === '–ù_–ù' ? 'selected' : ''}>–ù_–ù</option>
                            <option value="–û_–û" ${task.link === '–û_–û' ? 'selected' : ''}>–û_–û</option>
                        </select>
                    </td>
                    <td class="table-col-responsible" ${task.responsible ? `data-tooltip="${task.responsible.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"` : ''}>
                        <input type="text"
                               class="tasks-table-input"
                               value="${task.responsible || ''}"
                               data-index="${index}"
                               data-field="responsible">
                    </td>
                    <td>
                        <select class="tasks-table-input-select" data-index="${index}" data-field="status" ${disabledAttr}>
                            <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞</option>
                            <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>–í —Ä–∞–±–æ—Ç–µ</option>
                            <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                        </select>
                    </td>
                `;

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
                sortedColumns.forEach(col => {
                    if (col.field === 'stage') {
                        // –ü–æ–ª–µ —ç—Ç–∞–ø–∞ ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ö–≤–æ—Å—Ç –ø–æ—Å–ª–µ "–≠—Ç–∞–ø N."
                        const stageInput = row.querySelector('input[data-field="stageSuffix"]');
                        if (stageInput) {
                            stageInput.value = stageSuffix;
                        }
                    } else if (col.field === 'task') {
                        // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ –≤ input
                        const titleInput = row.querySelector('input[data-field="taskTitle"]');
                        if (titleInput) {
                            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—è task –∏ name
                            if (task.task && !task.name) {
                                task.name = task.task;
                            } else if (task.name && !task.task) {
                                task.task = task.name;
                            }
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É (–Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
                            titleInput.value = task.task || task.name || '';
                        }
                    } else {
                        // –û–±—ã—á–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã
                        const input = row.querySelector(`input[data-field="${col.field}"]`);
                        if (input) {
                            input.value = task[col.field] || '';
                        }
                    }
                });

                // Drag & drop –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
                row.draggable = canEdit(); // –ë–ª–æ–∫–∏—Ä—É–µ–º drag&drop –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                row.addEventListener('dragstart', (e) => {
                    if (!canEdit()) {
                        e.preventDefault();
                        return;
                    }
                    draggingTaskId = task.id;
                    row.classList.add('dragging');
                    if (e.dataTransfer) {
                        e.dataTransfer.effectAllowed = 'move';
                    }
                });

                row.addEventListener('dragend', () => {
                    draggingTaskId = null;
                    row.classList.remove('dragging');
                    tbody.querySelectorAll('.table-row-drop-target').forEach(el => el.classList.remove('table-row-drop-target'));
                });

                row.addEventListener('dragover', (e) => {
                    if (draggingTaskId === null || draggingTaskId === task.id) return;
                    e.preventDefault();
                    row.classList.add('table-row-drop-target');
                });

                row.addEventListener('dragleave', () => {
                    row.classList.remove('table-row-drop-target');
                });

                row.addEventListener('drop', (e) => {
                    if (!canEdit()) {
                        e.preventDefault();
                        return;
                    }
                    if (draggingTaskId === null || draggingTaskId === task.id) return;
                    e.preventDefault();
                    row.classList.remove('table-row-drop-target');

                    const fromIndex = tasks.findIndex(t => t.id === draggingTaskId);
                    const targetId = task.id;
                    if (fromIndex === -1) return;

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º
                    addToUndoHistory();

                    console.log('üîÑ DRAG&DROP (—Ç–∞–±–ª–∏—Ü–∞): –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏');
                    console.log('   –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–∞—è –∑–∞–¥–∞—á–∞ ID:', draggingTaskId);
                    console.log('   –°—Ç–∞—Ä—ã–π –∏–Ω–¥–µ–∫—Å:', fromIndex);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –î–û –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    const movedTaskBefore = tasks[fromIndex];
                    console.log('   üìã –î–û –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è - –∑–∞–¥–∞—á–∞:', movedTaskBefore.task || movedTaskBefore.name);
                    console.log('   üìã –î–û –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è - –¥–∞—Ç—ã:', movedTaskBefore.dates?.map(d => formatDateKey(d)));
                    console.log('   üìã –î–û –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è - —Å—Ç–∞—Ç—É—Å—ã –¥–∞—Ç:', movedTaskBefore.dateStatuses);
                    console.log('   üìã –î–û –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:', movedTaskBefore.dateComments);
                    console.log('   üìã –î–û –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è - –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å:', movedTaskBefore.status);

                    const [moved] = tasks.splice(fromIndex, 1);
                    const targetIndex = tasks.findIndex(t => t.id === targetId);
                    let newIndex;
                    if (targetIndex === -1) {
                        tasks.push(moved);
                        newIndex = tasks.length - 1;
                    } else {
                        tasks.splice(targetIndex, 0, moved);
                        newIndex = targetIndex;
                    }

                    console.log('   –ù–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å:', newIndex);
                    console.log('   üìã –ü–û–°–õ–ï –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (–¥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞) - —Å—Ç–∞—Ç—É—Å—ã –¥–∞—Ç:', moved.dateStatuses);
                    console.log('   üìã –ü–û–°–õ–ï –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (–¥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞) - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:', moved.dateComments);

                    const startIndex = Math.min(fromIndex, newIndex);
                    console.log('   üî¢ –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ—Å—á–µ—Ç —Å –∏–Ω–¥–µ–∫—Å–∞:', startIndex);
                    recalculateDatesFrom(startIndex);

                    console.log('   üìã –ü–û–°–õ–ï –ø–µ—Ä–µ—Å—á–µ—Ç–∞ - —Å—Ç–∞—Ç—É—Å—ã –¥–∞—Ç:', moved.dateStatuses);
                    console.log('   üìã –ü–û–°–õ–ï –ø–µ—Ä–µ—Å—á–µ—Ç–∞ - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:', moved.dateComments);
                    console.log('   üìã –ü–û–°–õ–ï –ø–µ—Ä–µ—Å—á–µ—Ç–∞ - –Ω–æ–≤—ã–µ –¥–∞—Ç—ã:', moved.dates?.map(d => formatDateKey(d)));

                    draggingTaskId = null;
                    updateStatistics();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            if (searchResults.length > 0) {
                highlightSearchResults();
            }
                    renderGantt();
                    renderTable();
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ mousedown –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –∫–ª–∏–∫–∞ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –≤—ã–¥–µ–ª–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞
                let isSelectingText = false;
                row.addEventListener('mousedown', (event) => {
                    const target = event.target;
                    const isInputElement = target.tagName === 'INPUT' || 
                                         target.tagName === 'SELECT' || 
                                         target.tagName === 'TEXTAREA' ||
                                         target.closest('input, select, textarea');
                    
                    if (isInputElement && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA')) {
                        // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ–ª–µ –≤–≤–æ–¥–∞, —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
                        isSelectingText = true;
                        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è, —á—Ç–æ–±—ã –∫–ª–∏–∫ —Å—Ç—Ä–æ–∫–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
                        event.stopPropagation();
                    } else {
                        isSelectingText = false;
                    }
                });
                
                // –ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ —Ç–∞–±–ª–∏—Ü—ã ‚Äî –≤—ã–±–æ—Ä –∑–∞–¥–∞—á–∏ –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∞ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ Shift)
                row.addEventListener('click', (event) => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –Ω–µ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏–ª–∏ select
                    const target = event.target;
                    const isInputElement = target.tagName === 'INPUT' || 
                                         target.tagName === 'SELECT' || 
                                         target.tagName === 'TEXTAREA' ||
                                         target.closest('input, select, textarea');
                    
                    // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫ —Å—Ç—Ä–æ–∫–∏
                    if (isInputElement) {
                        return;
                    }
                    
                    // –ï—Å–ª–∏ –∏–¥–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫ —Å—Ç—Ä–æ–∫–∏
                    if (isSelectingText) {
                        return;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏–¥–µ—Ç –ª–∏ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                    const activeElement = document.activeElement;
                    if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                        const input = activeElement;
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                        if (input.selectionStart !== null && input.selectionEnd !== null && 
                            input.selectionStart !== input.selectionEnd) {
                            return; // –ò–¥–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫ —Å—Ç—Ä–æ–∫–∏
                        }
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏–¥–µ—Ç –ª–∏ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                    const selection = window.getSelection();
                    if (selection && selection.toString().length > 0) {
                        return; // –ò–¥–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫ —Å—Ç—Ä–æ–∫–∏
                    }
                    
                    handleTaskRowClick(task.id, event);
                });
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–∏ –º—ã—à–∏
                row.addEventListener('mouseup', (event) => {
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –¥–∞—Ç—å –±—Ä–∞—É–∑–µ—Ä—É –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
                    setTimeout(() => {
                        isSelectingText = false;
                    }, 10);
                });

                tbody.appendChild(row);
                }); // –ö–æ–Ω–µ—Ü forEach –ø–æ stageTasks
            }); // –ö–æ–Ω–µ—Ü forEach –ø–æ —ç—Ç–∞–ø–∞–º (Object.keys(tasksByStage))

            // –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ (–µ—Å–ª–∏ –±—ã–ª–∞)
            applySelectionHighlight();

            // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            tbody.querySelectorAll('.tasks-table-input, .tasks-table-input-select').forEach(input => {
                input.addEventListener('change', onTaskTableInputChange);
            });
            
            // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö input –ø–æ–ª–µ–π –≤ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —É—Ä–æ–≤–Ω–µ tbody, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å (–ø–æ –∞—Ç—Ä–∏–±—É—Ç—É)
            if (!tbody.hasAttribute('data-text-modal-handlers')) {
                tbody.setAttribute('data-text-modal-handlers', 'true');
                
                tbody.addEventListener('click', (e) => {
                    const input = e.target;
                    if (input && 
                        input.tagName === 'INPUT' &&
                        input.classList.contains('tasks-table-input') && 
                        input.type === 'text' && 
                        !input.hasAttribute('readonly') && 
                        canEdit() &&
                        (input.closest('#tasksTable') || input.closest('.tasks-table'))) {
                        
                        console.log('üñ±Ô∏è Click –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ):', input.getAttribute('data-field'));
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        input.blur();
                        setTimeout(() => {
                            openTextInputModal(input);
                        }, 50);
                        return false;
                    }
                }, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
                
                tbody.addEventListener('focus', (e) => {
                    const input = e.target;
                    if (input && 
                        input.tagName === 'INPUT' &&
                        input.classList.contains('tasks-table-input') && 
                        input.type === 'text' && 
                        !input.hasAttribute('readonly') && 
                        canEdit() &&
                        (input.closest('#tasksTable') || input.closest('.tasks-table'))) {
                        
                        console.log('üéØ Focus –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ):', input.getAttribute('data-field'));
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        input.blur();
                        setTimeout(() => {
                            openTextInputModal(input);
                        }, 50);
                        return false;
                    }
                }, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
                
                tbody.addEventListener('touchstart', (e) => {
                    const input = e.target;
                    if (input && 
                        input.tagName === 'INPUT' &&
                        input.classList.contains('tasks-table-input') && 
                        input.type === 'text' && 
                        !input.hasAttribute('readonly') && 
                        canEdit() &&
                        (input.closest('#tasksTable') || input.closest('.tasks-table'))) {
                        
                        console.log('üëÜ Touchstart –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ):', input.getAttribute('data-field'));
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        input.blur();
                        setTimeout(() => {
                            openTextInputModal(input);
                        }, 50);
                        return false;
                    }
                }, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
            }
            
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è select "–°–≤—è–∑—å" - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
            tbody.querySelectorAll('select.link-select[data-field="link"]').forEach(select => {
                const tooltips = {
                    '–û_–ù': '–æ–∫–æ–Ω—á–∞–Ω–∏–µ - –Ω–∞—á–∞–ª–æ',
                    '–ù_–ù': '–Ω–∞—á–∞–ª–æ - –Ω–∞—á–∞–ª–æ',
                    '–û_–û': '–æ–∫–æ–Ω—á–∞–Ω–∏–µ - –æ–∫–æ–Ω—á–∞–Ω–∏–µ'
                };
                
                function updateTooltip() {
                    const value = select.value;
                    const tooltip = tooltips[value] || '';
                    if (tooltip) {
                        select.setAttribute('data-tooltip', tooltip);
                    } else {
                        select.removeAttribute('data-tooltip');
                    }
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
                updateTooltip();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
                select.addEventListener('change', updateTooltip);
            });
            
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è select —Å—Ç–∞—Ç—É—Å–∞ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–∞ –≤–º–µ—Å—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
            tbody.querySelectorAll('select[data-field="status"]').forEach(select => {
                // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                select.addEventListener('mousedown', (event) => {
                    if (!canEdit()) {
                        event.preventDefault();
                        return;
                    }
                    event.preventDefault();
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    
                    const index = parseInt(select.getAttribute('data-index'), 10);
                    const task = tasks[index];
                    if (!task) return;
                    
                    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã select –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–Ω—é
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º getBoundingClientRect() –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport
                    const rect = select.getBoundingClientRect();
                    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é —Å–ø—Ä–∞–≤–∞ –æ—Ç select, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞—è –ø–æ –≤–µ—Ä—Ö–Ω–µ–º—É –∫—Ä–∞—é
                    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã getBoundingClientRect() —É–∂–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport
                    const x = rect.right; // –ü—Ä–∞–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ select
                    const y = rect.top; // –í–µ—Ä—Ö–Ω–∏–π –∫—Ä–∞–π select (–º–µ–Ω—é –±—É–¥–µ—Ç –≤—ã—Ä–æ–≤–Ω–µ–Ω–æ –ø–æ –≤–µ—Ä—Ö–Ω–µ–º—É –∫—Ä–∞—é)
                    
                    console.log('üìç Select –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', { 
                        left: rect.left, 
                        right: rect.right, 
                        top: rect.top, 
                        bottom: rect.bottom,
                        width: rect.width,
                        height: rect.height,
                        x: x,
                        y: y
                    });
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                    lastClickCoordinates.x = x;
                    lastClickCoordinates.y = y;
                    
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–∞ —Ä—è–¥–æ–º —Å select
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
                    const taskDates = task.dates || [];
                    const dateStrs = taskDates.map(d => formatDateKey(d));
                    
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
                    openStatusMenu(x, y, task.id, dateStrs);
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –º–µ–Ω—é –±—ã–ª–æ –æ—Ç–∫—Ä—ã—Ç–æ –∏–∑ select
                    statusMenuOpenedFromSelect = true;
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ click –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ select
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture —Ñ–∞–∑—É, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–æ –¥–æ–π–¥–µ—Ç –¥–æ window.onclick
                select.addEventListener('click', (event) => {
                    if (!canEdit()) {
                        event.preventDefault();
                        event.stopPropagation();
                        event.stopImmediatePropagation();
                        return;
                    }
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è, —á—Ç–æ–±—ã window.onclick –Ω–µ –∑–∞–∫—Ä—ã–ª –º–µ–Ω—é
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ select
                    event.preventDefault();
                }, true); // true = capture —Ñ–∞–∑–∞
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ mouseup –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é –ø—Ä–∏ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–∏ –∫–Ω–æ–ø–∫–∏ –º—ã—à–∏
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture —Ñ–∞–∑—É, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–æ –¥–æ–π–¥–µ—Ç –¥–æ window.onclick
                select.addEventListener('mouseup', (event) => {
                    if (!canEdit()) {
                        event.preventDefault();
                        event.stopPropagation();
                        event.stopImmediatePropagation();
                        return;
                    }
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è, —á—Ç–æ–±—ã window.onclick –Ω–µ –∑–∞–∫—Ä—ã–ª –º–µ–Ω—é
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ select
                    event.preventDefault();
                }, true); // true = capture —Ñ–∞–∑–∞
                
                // –¢–∞–∫–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º touch —Å–æ–±—ã—Ç–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                select.addEventListener('touchstart', (event) => {
                    if (!canEdit()) {
                        event.preventDefault();
                        return;
                    }
                    event.preventDefault();
                    event.stopPropagation();
                    
                    const index = parseInt(select.getAttribute('data-index'), 10);
                    const task = tasks[index];
                    if (!task) return;
                    
                    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–∞–ø–∞ –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é —Ä—è–¥–æ–º —Å select
                    const rect = select.getBoundingClientRect();
                    const touch = event.touches[0];
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–∞–ø–∞, –Ω–æ –µ—Å–ª–∏ –æ–Ω–∏ –¥–∞–ª–µ–∫–æ –æ—Ç select, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–∑–∏—Ü–∏—é select
                    const tapX = touch.clientX;
                    const tapY = touch.clientY;
                    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é —Å–ø—Ä–∞–≤–∞ –æ—Ç select, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞—è –ø–æ –≤–µ—Ä—Ö–Ω–µ–º—É –∫—Ä–∞—é
                    const x = rect.right; // –ü—Ä–∞–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ select
                    const y = rect.top; // –í–µ—Ä—Ö–Ω–∏–π –∫—Ä–∞–π select (–º–µ–Ω—é –±—É–¥–µ—Ç –≤—ã—Ä–æ–≤–Ω–µ–Ω–æ –ø–æ –≤–µ—Ä—Ö–Ω–µ–º—É –∫—Ä–∞—é)
                    
                    console.log('üìç Touch –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', { 
                        tapX, 
                        tapY,
                        selectLeft: rect.left,
                        selectRight: rect.right,
                        selectTop: rect.top,
                        selectBottom: rect.bottom,
                        finalX: x,
                        finalY: y
                    });
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                    lastClickCoordinates.x = x;
                    lastClickCoordinates.y = y;
                    
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–∞ —Ä—è–¥–æ–º —Å select
                    const taskDates = task.dates || [];
                    const dateStrs = taskDates.map(d => formatDateKey(d));
                    
                    openStatusMenu(x, y, task.id, dateStrs);
                });
            });
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
            if (searchResults.length > 0) {
                highlightSearchResults();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π –≤ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
        function onTaskTableInputChange(event) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ .call(this) –±–µ–∑ event
            if (!event || !event.target) {
                if (this && this.nodeName) {
                    // –ï—Å–ª–∏ this - —ç—Ç–æ —ç–ª–µ–º–µ–Ω—Ç (input/select), —Å–æ–∑–¥–∞–µ–º —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π event
                    event = { target: this };
                } else {
                    console.error('onTaskTableInputChange: –Ω–µ—Ç event –∏ –Ω–µ—Ç this');
                    return;
                }
            }
            
            if (!canEdit()) {
                if (event.preventDefault) {
                    event.preventDefault();
                }
                if (event.target && event.target.blur) {
                    event.target.blur();
                }
                return; // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            }
            const input = event.target;
            const index = parseInt(input.getAttribute('data-index'), 10);
            const field = input.getAttribute('data-field');
            const task = tasks[index];
            if (!task) return;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—è –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const undoKey = `undo_${index}_${field}`;
            if (!window[undoKey]) {
                console.log(`üìù –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–º–µ–Ω—ã: –∏–∑–º–µ–Ω–µ–Ω–∏–µ ${field} –∑–∞–¥–∞—á–∏ ${index}`);
                addToUndoHistory();
                window[undoKey] = true;
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç–º–µ–Ω–∏—Ç—å —Å–µ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π
                setTimeout(() => {
                    delete window[undoKey];
                }, 1000);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ –ø–æ–ª—è
            if (field === 'taskTitle') {
                task.task = input.value || '';
                task.name = task.task; // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –æ–±–∞ –ø–æ–ª—è
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º td
                const td = input.closest('td');
                if (td) {
                    if (task.task) {
                        td.setAttribute('data-tooltip', task.task);
                    } else {
                        td.removeAttribute('data-tooltip');
                    }
                }
            } else if (field === 'stageSelect') {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —ç—Ç–∞–ø–∞ —á–µ—Ä–µ–∑ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                const newStageShort = input.value;
                const oldStage = task.stage || '';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –Ω–æ–≤—ã–π —ç—Ç–∞–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º (–Ω–µ "–≠—Ç–∞–ø N")
                const isNewStageCustom = !newStageShort.match(/^–≠—Ç–∞–ø\s+\d+$/);
                
                let newStage;
                if (isNewStageCustom) {
                    // –ï—Å–ª–∏ –Ω–æ–≤—ã–π —ç—Ç–∞–ø - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ –µ—Å—Ç—å, –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—É—Ñ—Ñ–∏–∫—Å–∞
                    newStage = newStageShort;
                } else {
                    // –ï—Å–ª–∏ –Ω–æ–≤—ã–π —ç—Ç–∞–ø - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π "–≠—Ç–∞–ø N", –∏–∑–≤–ª–µ–∫–∞–µ–º —Å—É—Ñ—Ñ–∏–∫—Å –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —ç—Ç–∞–ø–∞
                    let stageSuffix = '';
                    const oldStageMatch = oldStage.match(/^(–≠—Ç–∞–ø\s+\d+\.?\s*)(.*)$/);
                    if (oldStageMatch) {
                        stageSuffix = oldStageMatch[2] || '';
                    }
                    
                    // –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —ç—Ç–∞–ø: –ø—Ä–µ—Ñ–∏–∫—Å + —Å—É—Ñ—Ñ–∏–∫—Å (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    if (stageSuffix.trim()) {
                        // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—É—Ñ—Ñ–∏–∫—Å, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –∫ –Ω–æ–≤–æ–º—É —ç—Ç–∞–ø—É
                        newStage = `${newStageShort}. ${stageSuffix.trim()}`;
                    } else {
                        // –ï—Å–ª–∏ —Å—É—Ñ—Ñ–∏–∫—Å–∞ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞
                        newStage = newStageShort;
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —ç—Ç–∞–ø —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏ (–Ω–µ –≥—Ä—É–ø–ø–æ–≤–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ)
                task.stage = newStage;
                
                // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —ç—Ç–∞–ø–æ–≤ –∏ –≤–∫–ª–∞–¥–∫–∏
                initializeStageConfig();
                renderStageTabs();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∏ —Ç–∞–±–ª–∏—Ü—ã
                renderGantt();
                renderTable();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                debouncedSave();
            } else if (field === 'stageSuffix') {
                const oldStage = task.stage || '';
                const prefix = input.getAttribute('data-prefix') || '';
                const suffix = (input.value || '').trim();

                // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å "–≠—Ç–∞–ø N", –±–ª–æ–∫–∏—Ä—É–µ–º –µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
                let newStage;
                if (prefix) {
                    newStage = suffix ? (prefix + ' ' + suffix) : prefix.trim();
                } else {
                    // –î–ª—è –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Å—Ç—Ä–æ–∫ (–±–µ–∑ "–≠—Ç–∞–ø N") —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –≤—Å—ë —Ü–µ–ª–∏–∫–æ–º
                    newStage = suffix;
                }

                // –ì—Ä—É–ø–ø–æ–≤–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ: –º–µ–Ω—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —É –≤—Å–µ—Ö –∑–∞–¥–∞—á
                // —Å —Ç–µ–º –∂–µ –∏—Å—Ö–æ–¥–Ω—ã–º —ç—Ç–∞–ø–æ–º
                if (oldStage && oldStage !== newStage) {
                    tasks.forEach(t => {
                        if (t.stage === oldStage) {
                            t.stage = newStage;
                        }
                    });
                }
                task.stage = newStage;

                // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —ç—Ç–∞–ø–æ–≤ –∏ –≤–∫–ª–∞–¥–∫–∏
                initializeStageConfig();
                renderStageTabs();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º td
                const td = input.closest('td');
                if (td) {
                    if (task.stage) {
                        td.setAttribute('data-tooltip', task.stage);
                    } else {
                        td.removeAttribute('data-tooltip');
                    }
                }
            } else if (field === 'control') {
                task.control = input.value || '';
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º td
                const td = input.closest('td');
                if (td) {
                    if (task.control) {
                        td.setAttribute('data-tooltip', task.control);
                    } else {
                        td.removeAttribute('data-tooltip');
                    }
                }
            } else if (field === 'startDate') {
                task.startDate = parseDateFromInput(input.value);

                // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏ –æ–Ω–∞ —Å—Ç–∞–ª–∞ —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ ‚Äî –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –µ—ë –≤–ø–µ—Ä—ë–¥
                if (task.startDate && task.endDate && task.endDate < task.startDate) {
                    task.endDate = new Date(task.startDate);
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–ø—É—Ç—ã –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è (–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ, –∏ –≤ –ì–∞–Ω—Ç–µ)
                    document
                        .querySelectorAll(`input[data-index="${index}"][data-field="endDate"]`)
                        .forEach(inp => {
                            inp.value = formatDateForInput(task.endDate);
                        });
                }
            } else if (field === 'endDate') {
                const newEnd = parseDateFromInput(input.value);

                // –ü—Ä–∞–≤–∏–ª–æ: –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞
                if (task.startDate && newEnd && newEnd < task.startDate) {
                    task.endDate = new Date(task.startDate);
                    input.value = formatDateForInput(task.endDate);
                    openDateValidationModal('–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞.');
                } else {
                    task.endDate = newEnd;
                }
            } else if (field === 'days') {
                const val = parseInt(input.value, 10);
                task.days = isNaN(val) || val < 0 ? 0 : val;
            } else if (field === 'link') {
                task.link = input.value || '';
            } else if (field === 'responsible') {
                task.responsible = input.value || '';
                // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ data-tooltip –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π <td> (—Ç–∞–±–ª–∏—Ü–∞),
                // —á—Ç–æ–±—ã –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ –º–æ–∂–Ω–æ –±—ã–ª–æ —É–≤–∏–¥–µ—Ç—å –≤—Å–µ—Ö –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –≤ –µ–¥–∏–Ω–æ–º —Å—Ç–∏–ª–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫.
                const td = input.closest('.table-col-responsible');
                if (td) {
                    if (task.responsible) {
                        td.setAttribute('data-tooltip', task.responsible);
                    } else {
                        td.removeAttribute('data-tooltip');
                    }
                }
                // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –≤ –ì–∞–Ω—Ç–µ (–µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –≤–∏–¥–Ω–∞)
                const ganttRow = document.querySelector(`.gantt-row[data-task-id="${task.id}"]`);
                if (ganttRow) {
                    const ganttRespCell = ganttRow.querySelector('.gantt-details-cell input[data-field="responsible"]')?.parentElement;
                    if (ganttRespCell) {
                        if (task.responsible) {
                            ganttRespCell.setAttribute('data-tooltip', task.responsible);
                        } else {
                            ganttRespCell.removeAttribute('data-tooltip');
                        }
                    }
                }
            } else if (field === 'status') {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ select —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–∞
                // –≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏—Ç—Å—è –¥—Ä—É–≥–∏–º —Å–ø–æ—Å–æ–±–æ–º
                // –ù–æ –æ–±—ã—á–Ω–æ –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ select
                const newStatus = input.value;
                const oldStatus = task.status;
                
                // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª—Å—è (–Ω–µ —á–µ—Ä–µ–∑ –º–µ–Ω—é), –ø—Ä–∏–º–µ–Ω—è–µ–º –µ–≥–æ
                if (newStatus !== oldStatus) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ—Ç–∫–∞—Ç–∞, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏—Ç
                    input.value = oldStatus; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ select
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —ç–ª–µ–º–µ–Ω—Ç–∞ select –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                    const rect = input.getBoundingClientRect();
                    lastClickCoordinates.x = rect.left + rect.width / 2;
                    lastClickCoordinates.y = rect.top + rect.height / 2;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞
                    openScaleWarning(newStatus, null, true, index);
                }
                return; // –ù–µ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å —Å—Ä–∞–∑—É, –∂–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            }

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π.
            // –õ–æ–≥–∏–∫–∞:
            // - –º–µ–Ω—è–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ ‚Üí —Ñ–∏–∫—Å–∏—Ä—É–µ–º days –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—É –∫–æ–Ω—Ü–∞;
            //   –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï: –¥–ª—è —Å–≤—è–∑–∏ –û_–û (–æ–∫–æ–Ω—á–∞–Ω–∏–µ-–æ–∫–æ–Ω—á–∞–Ω–∏–µ) –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ days;
            // - –º–µ–Ω—è–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è ‚Üí —Ñ–∏–∫—Å–∏—Ä—É–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º days;
            // - –º–µ–Ω—è–µ–º days ‚Üí —Å—á–∏—Ç–∞–µ–º –æ—Ç –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–ª–∏ –æ—Ç –¥–∞—Ç—ã –∫–æ–Ω—Ü–∞.
            if (field === 'startDate') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Å–≤—è–∑–∏
                const linkType = task.link || '–û_–ù';
                
                if (linkType === '–û_–û') {
                    // –î–ª—è —Å–≤—è–∑–∏ –û_–û: –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏
                    if (task.startDate && task.endDate) {
                        // –û–±–µ –¥–∞—Ç—ã –∑–∞–¥–∞–Ω—ã ‚Üí –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
                        // –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω–æ–π (–Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è)
                        const dates = getWorkdaysBetween(task.startDate, task.endDate);
                        task.dates = dates;
                        task.days = dates.length;
                    } else if (task.startDate && task.days > 0) {
                        // –ï—Å–ª–∏ –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –∑–∞–¥–∞–Ω–∞, –Ω–æ –µ—Å—Ç—å —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏ - —Å—á–∏—Ç–∞–µ–º –æ—Ç –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞
                        const dates = getTaskDates(task.startDate, task.days);
                        task.dates = dates;
                        task.startDate = dates[0];
                        task.endDate = dates[dates.length - 1];
                    }
                } else {
                    // –î–ª—è —Å–≤—è–∑–µ–π –û_–ù –∏ –ù_–ù: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞
                    if (task.startDate && task.days > 0) {
                        // –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ + —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏ ‚Üí —Å—á–∏—Ç–∞–µ–º –¥–∞—Ç—É –∫–æ–Ω—Ü–∞
                        const dates = getTaskDates(task.startDate, task.days);
                        task.dates = dates;
                        task.startDate = dates[0];
                        task.endDate = dates[dates.length - 1];
                    } else if (task.startDate && task.endDate) {
                        // –û–±–µ –¥–∞—Ç—ã –∑–∞–¥–∞–Ω—ã ‚Üí –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
                        const dates = getWorkdaysBetween(task.startDate, task.endDate);
                        task.dates = dates;
                        task.days = dates.length;
                    }
                }
                
                // –ï—Å–ª–∏ —É —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–∏ —Å–≤—è–∑—å –ù_–ù, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –µ—ë –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞
                if (index < tasks.length - 1) {
                    const nextTask = tasks[index + 1];
                    if (nextTask.link === '–ù_–ù' && task.startDate) {
                        nextTask.startDate = new Date(task.startDate);
                        recalculateTaskDatesWithWeekends(nextTask);
                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏
                        recalculateFollowingTasks(index + 1);
                    }
                }
            } else if (field === 'endDate') {
                if (task.startDate && task.endDate) {
                    // –§–∏–∫—Å–∏—Ä—É–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞, –¥–≤–∏–≥–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω–µ—Ü ‚Üí —Å—á–∏—Ç–∞–µ–º –Ω–æ–≤—ã–µ —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏
                    const dates = getWorkdaysBetween(task.startDate, task.endDate);
                    task.dates = dates;
                    task.days = dates.length;
                } else if (task.endDate && task.days > 0) {
                    // –ï—Å—Ç—å –¥–∞—Ç–∞ –∫–æ–Ω—Ü–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π ‚Üí —Å—á–∏—Ç–∞–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–∞–∑–∞–¥
                    const dates = getWorkdaysBackward(task.endDate, task.days);
                    task.dates = dates;
                    task.startDate = dates[0];
                    task.endDate = dates[dates.length - 1];
                }
                
                // –ï—Å–ª–∏ —É —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–∏ —Å–≤—è–∑—å –û_–û, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –µ—ë –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è
                if (index < tasks.length - 1) {
                    const nextTask = tasks[index + 1];
                    if (nextTask.link === '–û_–û' && task.endDate) {
                        nextTask.endDate = new Date(task.endDate);
                        if (nextTask.days > 0) {
                            const dates = getWorkdaysBackward(nextTask.endDate, nextTask.days);
                            nextTask.dates = dates;
                            nextTask.startDate = dates[0];
                            nextTask.endDate = dates[dates.length - 1];
                        }
                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏
                        recalculateFollowingTasks(index + 1);
                    }
                }
            } else if (field === 'days') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Å–≤—è–∑–∏
                const linkType = task.link || '–û_–ù';
                
                if (linkType === '–û_–û') {
                    // –î–ª—è —Å–≤—è–∑–∏ –û_–û: –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–∞–∑–∞–¥
                    if (task.endDate && task.days > 0) {
                        // –ï—Å—Ç—å –¥–∞—Ç–∞ –∫–æ–Ω—Ü–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π ‚Üí —Å—á–∏—Ç–∞–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–∞–∑–∞–¥
                        // –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π (–Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è)
                        const dates = getWorkdaysBackward(task.endDate, task.days);
                        task.dates = dates;
                        task.startDate = dates[0];
                        // task.endDate –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º
                    } else if (task.startDate && task.days > 0) {
                        // –ï—Å–ª–∏ –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –∑–∞–¥–∞–Ω–∞, –Ω–æ –µ—Å—Ç—å –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ - —Å—á–∏—Ç–∞–µ–º –æ—Ç –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞
                        const dates = getTaskDates(task.startDate, task.days);
                        task.dates = dates;
                        task.startDate = dates[0];
                        task.endDate = dates[dates.length - 1];
                    }
                } else {
                    // –î–ª—è —Å–≤—è–∑–µ–π –û_–ù –∏ –ù_–ù: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞
                    if (task.startDate && task.days > 0) {
                        // –ï—Å—Ç—å –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π ‚Üí —Å—á–∏—Ç–∞–µ–º –¥–∞—Ç—É –∫–æ–Ω—Ü–∞
                        const dates = getTaskDates(task.startDate, task.days);
                        task.dates = dates;
                        task.startDate = dates[0];
                        task.endDate = dates[dates.length - 1];
                    } else if (task.endDate && task.days > 0) {
                        // –ï—Å—Ç—å –¥–∞—Ç–∞ –∫–æ–Ω—Ü–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π ‚Üí —Å—á–∏—Ç–∞–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–∞–∑–∞–¥
                        const dates = getWorkdaysBackward(task.endDate, task.days);
                        task.dates = dates;
                        task.startDate = dates[0];
                        task.endDate = dates[dates.length - 1];
                    }
                }
            }

            // –ü—Ä–∏ —Ä—É—á–Ω–æ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–∞—Ç/–∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π –æ—á–∏—â–∞–µ–º
            // –ø–æ–∫—Ä–∞—Å–∫—É –ø–æ –¥–Ω—è–º, —á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å—Ç–∞—Ç—É—Å
            // –ø–æ —Å—Ç—Ä–æ–∫–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ –ø–æ–ª–µ "status")
            if (field === 'startDate' || field === 'endDate' || field === 'days') {
                task.dateStatuses = {};
                if (task.status === 'in-progress' || task.status === 'completed') {
                    task.dates.forEach(d => {
                        const key = formatDateKey(d);
                        task.dateStatuses[key] = task.status;
                    });
                }
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤—è–∑–∏
            if (field === 'link') {
                const linkType = input.value || '–û_–ù';
                task.link = linkType;
                
                console.log(`üîó –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–≤—è–∑–∏ –∑–∞–¥–∞—á–∏ ${index} –Ω–∞ ${linkType}`);
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—ã —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–≤—è–∑–∏
                if (index > 0) {
                    const prevTask = tasks[index - 1];
                    
                    if (linkType === '–ù_–ù') {
                        // –ù_–ù: –Ω–∞—á–∞–ª–æ-–Ω–∞—á–∞–ª–æ - –∑–∞–¥–∞—á–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤ —Ç—É –∂–µ –¥–∞—Ç—É, —á—Ç–æ –∏ –ø—Ä–µ–¥—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫
                        if (prevTask.startDate) {
                            task.startDate = new Date(prevTask.startDate);
                            if (task.days > 0) {
                                recalculateTaskDatesWithWeekends(task);
                            }
                            console.log(`  ‚úÖ –ù_–ù: –∑–∞–¥–∞—á–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è ${formatDateForInput(task.startDate)}`);
                        } else {
                            console.warn(`  ‚ö†Ô∏è –ù_–ù: —É –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–¥–∞—á–∏ –Ω–µ—Ç –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞`);
                        }
                    } else if (linkType === '–û_–û') {
                        // –û_–û: –æ–∫–æ–Ω—á–∞–Ω–∏–µ-–æ–∫–æ–Ω—á–∞–Ω–∏–µ - –∑–∞–¥–∞—á–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –≤ —Ç—É –∂–µ –¥–∞—Ç—É, —á—Ç–æ –∏ –ø—Ä–µ–¥—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫
                        if (prevTask.endDate) {
                            task.endDate = new Date(prevTask.endDate);
                            if (task.days > 0) {
                                const dates = getWorkdaysBackward(task.endDate, task.days);
                                task.dates = dates;
                                task.startDate = dates[0];
                                task.endDate = dates[dates.length - 1];
                            }
                            console.log(`  ‚úÖ –û_–û: –∑–∞–¥–∞—á–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è ${formatDateForInput(task.endDate)}`);
                        } else {
                            console.warn(`  ‚ö†Ô∏è –û_–û: —É –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–¥–∞—á–∏ –Ω–µ—Ç –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è`);
                        }
                    } else if (linkType === '–û_–ù') {
                        // –û_–ù: –æ–∫–æ–Ω—á–∞–Ω–∏–µ-–Ω–∞—á–∞–ª–æ - –∑–∞–¥–∞—á–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π
                        if (prevTask.endDate) {
                            const newStart = new Date(prevTask.endDate);
                            newStart.setDate(newStart.getDate() + 1);
                            // –ò—â–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
                            while (!isWorkday(newStart)) {
                                newStart.setDate(newStart.getDate() + 1);
                            }
                            task.startDate = newStart;
                            if (task.days > 0) {
                                recalculateTaskDatesWithWeekends(task);
                            }
                            console.log(`  ‚úÖ –û_–ù: –∑–∞–¥–∞—á–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è ${formatDateForInput(task.startDate)}`);
                        } else {
                            console.warn(`  ‚ö†Ô∏è –û_–ù: —É –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–¥–∞—á–∏ –Ω–µ—Ç –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è`);
                        }
                    }
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –¥–∞—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–≤—è–∑–∏
                task.dateStatuses = {};
            }

            // –ñ—ë—Å—Ç–∫–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏
            // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–¥–≤–∏–≥–∞—é—Ç—Å—è —Ç–∞–∫, —á—Ç–æ–±—ã –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π
            // —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π, –ø—Ä–∏ —ç—Ç–æ–º —Å–≤–æ—ë
            // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –∫–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç.
            // –¢–µ–ø–µ—Ä—å —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–∏–ø —Å–≤—è–∑–∏ –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏.
            recalculateFollowingTasks(index);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ input –ø–æ–ª—è—Ö —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á–µ—Ç–∞
            // (–¥–æ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–∞–∑—É)
            const allInputs = document.querySelectorAll(`[data-index="${index}"]`);
            allInputs.forEach(inp => {
                const field = inp.getAttribute('data-field');
                if (field === 'startDate' && task.startDate) {
                    inp.value = formatDateForInput(task.startDate);
                } else if (field === 'endDate' && task.endDate) {
                    inp.value = formatDateForInput(task.endDate);
                } else if (field === 'days') {
                    inp.value = task.days;
                }
            });

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∏ –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π
            const scrollY = window.scrollY || window.pageYOffset;
            const scrollX = window.scrollX || window.pageXOffset;
            
            // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–∏–∞–≥—Ä–∞–º–º—ã, –µ—Å–ª–∏ –µ—Å—Ç—å
            const chartContainer = document.getElementById('ganttChart');
            const chartScrollTop = chartContainer ? chartContainer.scrollTop : 0;
            const chartScrollLeft = chartContainer ? chartContainer.scrollLeft : 0;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏ —É–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É
            const activeElement = document.activeElement;
            const activeElementInfo = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA') 
                ? { element: activeElement, selectionStart: activeElement.selectionStart, selectionEnd: activeElement.selectionEnd }
                : null;
            
            if (activeElementInfo) {
                activeElementInfo.element.blur();
            }

            updateStatistics();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            if (searchResults.length > 0) {
                highlightSearchResults();
            }
            // –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É –ì–∞–Ω—Ç–∞, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å input –ø–æ–ª—è –≤ –Ω–µ–π
            renderGantt();
            renderTable();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å—Ä–∞–∑—É, –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
            window.scrollTo(scrollX, scrollY);
            const newChartContainer = document.getElementById('ganttChart');
            if (newChartContainer) {
                newChartContainer.scrollTop = chartScrollTop;
                newChartContainer.scrollLeft = chartScrollLeft;
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏)
            if (activeElementInfo && document.contains(activeElementInfo.element)) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–æ–∫—É—Å–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
                requestAnimationFrame(() => {
                    try {
                        activeElementInfo.element.focus({ preventScroll: true });
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞, –µ—Å–ª–∏ —ç—Ç–æ input
                        if (activeElementInfo.element.setSelectionRange && 
                            activeElementInfo.selectionStart !== null && 
                            activeElementInfo.selectionEnd !== null) {
                            activeElementInfo.element.setSelectionRange(
                                activeElementInfo.selectionStart, 
                                activeElementInfo.selectionEnd
                            );
                        }
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–æ–∫—É—Å–∞
                    }
                });
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
            console.log('üìù –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏:', field, '–¥–ª—è –∑–∞–¥–∞—á–∏:', task.task || task.name);
            
            // –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π (–¥–∞—Ç—ã, —Å—Ç–∞—Ç—É—Å—ã, —Å–≤—è–∑–∏) —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
            if (field === 'startDate' || field === 'endDate' || field === 'days' || field === 'status' || field === 'link') {
                console.log('üíæ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã/—Å—Ç–∞—Ç—É—Å–∞/—Å–≤—è–∑–∏, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ');
                saveFullGanttState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ä–∞–∑—É
            } else {
                autoSaveGanttState(); // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π - —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞—Ç—ã –ø–æ –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—Å–æ—Ä–∞ –≤ —è—á–µ–π–∫–µ –¥–∏–∞–≥—Ä–∞–º–º—ã –ì–∞–Ω—Ç–∞
        function getDateFromCellPosition(cell, clientX) {
            console.log('üéØ getDateFromCellPosition –≤—ã–∑–≤–∞–Ω–∞', { cell, clientX });
            if (!cell) {
                console.log('‚ùå cell = null');
                return null;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–∏–∞–≥—Ä–∞–º–º—ã
            const chartContainer = document.getElementById('ganttChart');
            if (!chartContainer) {
                console.log('‚ùå ganttChart –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return null;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é —Å—Ç—Ä–æ–∫—É —è—á–µ–π–∫–∏
            const parentRow = cell.closest('.gantt-row');
            if (!parentRow) {
                console.log('‚ùå parentRow –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return null;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —è—á–µ–π–∫–∏ –≤ –µ—ë —Å—Ç—Ä–æ–∫–µ
            // –í–ê–ñ–ù–û: –∏—â–µ–º —Ç–æ–ª—å–∫–æ .gantt-cell (–Ω–µ .gantt-details-cell!)
            const cellsInRow = Array.from(parentRow.querySelectorAll('.gantt-cell'));
            const cellIndex = cellsInRow.indexOf(cell);
            console.log('üî¢ –ò–Ω–¥–µ–∫—Å —è—á–µ–π–∫–∏ –≤ —Å—Ç—Ä–æ–∫–µ:', cellIndex, '–∏–∑', cellsInRow.length, '—è—á–µ–µ–∫');
            if (cellIndex === -1) {
                console.log('‚ùå –Ø—á–µ–π–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ .gantt-cell');
                return null;
            }
            
            // –ò—â–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —è—á–µ–π–∫—É –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
            const header = chartContainer.querySelector('.gantt-header');
            if (!header) return null;
            
            // –í–ê–ñ–ù–û: –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ —è—á–µ–π–∫–∏ –∏–º–µ—é—Ç –∫–ª–∞—Å—Å .gantt-header-cell, –Ω–µ .gantt-cell!
            const headerCells = Array.from(header.querySelectorAll('.gantt-header-cell'));
            console.log('üîç getDateFromCellPosition: –Ω–∞–π–¥–µ–Ω–æ —è—á–µ–µ–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞:', headerCells.length, ', –∏–Ω–¥–µ–∫—Å —è—á–µ–π–∫–∏:', cellIndex);
            if (cellIndex < headerCells.length) {
                const headerCell = headerCells[cellIndex];
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞ –∏–ª–∏ title
                const startDateStr = headerCell.getAttribute('data-start-date');
                console.log('üìÖ startDateStr –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞:', startDateStr);
                if (startDateStr) {
                    const startDate = new Date(startDateStr);
                    console.log('üìÖ startDate –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞:', startDate, 'valid:', !isNaN(startDate.getTime()));
                    if (!isNaN(startDate.getTime())) {
                        // –í —Ä–µ–∂–∏–º–µ –¥–Ω–µ–π –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ —è—á–µ–π–∫–∏
                        if (currentScaleMode === 'day') {
                            console.log('‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞—Ç—É (—Ä–µ–∂–∏–º –¥–Ω–µ–π):', formatDateKey(startDate));
                            return new Date(startDate);
                        }
                        
                        // –í —Ä–µ–∂–∏–º–µ –Ω–µ–¥–µ–ª—å/–º–µ—Å—è—Ü–µ–≤ –≤—ã—á–∏—Å–ª—è–µ–º —Ç–æ—á–Ω—É—é –¥–∞—Ç—É –ø–æ –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—Å–æ—Ä–∞
                        const cellRect = cell.getBoundingClientRect();
                        const relativeX = clientX - cellRect.left;
                        const cellWidth = cellRect.width;
                        
                        // –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
                        const endDateStr = headerCell.getAttribute('data-end-date');
                        if (endDateStr) {
                            const endDate = new Date(endDateStr);
                            if (!isNaN(endDate.getTime())) {
                                // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ
                                const daysInInterval = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                                
                                // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤–Ω—É—Ç—Ä–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ (0..1)
                                const position = Math.max(0, Math.min(1, relativeX / cellWidth));
                                
                                // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –≤ –¥–Ω—è—Ö
                                const dayOffset = Math.floor(position * daysInInterval);
                                
                                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –¥–∞—Ç—É
                                const newDate = new Date(startDate);
                                newDate.setDate(newDate.getDate() + dayOffset);
                                
                                // –ò—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
                                while (!isWorkday(newDate) && newDate <= endDate) {
                                    newDate.setDate(newDate.getDate() + 1);
                                }
                                
                                // –ï—Å–ª–∏ –≤—ã—à–ª–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
                                if (newDate > endDate) {
                                    let lastWorkday = new Date(endDate);
                                    while (!isWorkday(lastWorkday) && lastWorkday >= startDate) {
                                        lastWorkday.setDate(lastWorkday.getDate() - 1);
                                    }
                                    return lastWorkday >= startDate ? lastWorkday : startDate;
                                }
                                
                                return newDate;
                            }
                        }
                        
                        // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞
                        return new Date(startDate);
                    }
                }
                
                // Fallback: –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É –∏–∑ title
                const title = headerCell.getAttribute('title');
                if (title) {
                    // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –∏–∑ title (—Ñ–æ—Ä–º–∞—Ç: "1 —è–Ω–≤–∞—Ä—è 2025 –≥.")
                    const dateMatch = title.match(/(\d{1,2})\s+(\w+)\s+(\d{4})/);
                    if (dateMatch) {
                        const day = parseInt(dateMatch[1]);
                        const monthName = dateMatch[2];
                        const year = parseInt(dateMatch[3]);
                        
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞ –≤ –Ω–æ–º–µ—Ä
                        const monthNames = {
                            '—è–Ω–≤–∞—Ä—è': 0, '—Ñ–µ–≤—Ä–∞–ª—è': 1, '–º–∞—Ä—Ç–∞': 2, '–∞–ø—Ä–µ–ª—è': 3,
                            '–º–∞—è': 4, '–∏—é–Ω—è': 5, '–∏—é–ª—è': 6, '–∞–≤–≥—É—Å—Ç–∞': 7,
                            '—Å–µ–Ω—Ç—è–±—Ä—è': 8, '–æ–∫—Ç—è–±—Ä—è': 9, '–Ω–æ—è–±—Ä—è': 10, '–¥–µ–∫–∞–±—Ä—è': 11
                        };
                        const month = monthNames[monthName.toLowerCase()];
                        if (month !== undefined) {
                            return new Date(year, month, day);
                        }
                    }
                }
            }
            
            // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç
            console.warn('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback —Ä–∞—Å—á–µ—Ç –¥–∞—Ç—ã (data-start-date –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ)');
            const cellRect = cell.getBoundingClientRect();
            const chartRect = chartContainer.getBoundingClientRect();
            const pxPerDay = 4 * zoomLevel;
            
            if (tasks.length === 0) {
                console.log('‚ùå –ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è fallback —Ä–∞—Å—á–µ—Ç–∞');
                return null;
            }
            const projectFirstDate = new Date(tasks[0].startDate);
            
            // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –æ—Ç –Ω–∞—á–∞–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞ —Å —É—á–µ—Ç–æ–º –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—Å–æ—Ä–∞
            const relativeX = clientX - cellRect.left;
            const daysOffset = Math.floor((cellRect.left - chartRect.left + relativeX) / pxPerDay);
            const newDate = new Date(projectFirstDate);
            newDate.setDate(newDate.getDate() + daysOffset);
            
            console.log('üìä Fallback —Ä–∞—Å—á–µ—Ç:', {
                projectFirstDate: formatDateKey(projectFirstDate),
                cellLeft: cellRect.left,
                chartLeft: chartRect.left,
                clientX,
                relativeX,
                pxPerDay,
                zoomLevel,
                daysOffset,
                resultDate: formatDateKey(newDate)
            });
            
            // –ò—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
            while (!isWorkday(newDate)) {
                newDate.setDate(newDate.getDate() + 1);
            }
            
            console.log('‚úÖ Fallback —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è:', formatDateKey(newDate));
            return newDate;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —è—á–µ–π–∫–∏ –ø–æ –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—Å–æ—Ä–∞
        function getCellFromPosition(clientX, clientY) {
            const chartContainer = document.getElementById('ganttChart');
            if (!chartContainer) return null;
            
            // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
            const elementUnderCursor = document.elementFromPoint(clientX, clientY);
            if (!elementUnderCursor) return null;
            
            // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç - —ç—Ç–æ –±–∞—Ä, –∏—â–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é —è—á–µ–π–∫—É
            if (elementUnderCursor.classList.contains('gantt-bar')) {
                return elementUnderCursor.closest('.gantt-cell');
            }
            
            // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é —è—á–µ–π–∫—É (.gantt-cell)
            let cell = elementUnderCursor.closest('.gantt-cell');
            
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —è—á–µ–π–∫—É (–≤–æ–∑–º–æ–∂–Ω–æ, pointerEvents: none), 
            // –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º pointer-events –Ω–∞ –±–∞—Ä–∞—Ö –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
            if (!cell) {
                const bars = chartContainer.querySelectorAll('.gantt-bar');
                const originalPointerEvents = [];
                
                // –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –±–∞—Ä—ã –æ—Ç pointer events
                bars.forEach((bar, i) => {
                    originalPointerEvents[i] = bar.style.pointerEvents;
                    bar.style.pointerEvents = 'none';
                });
                
                // –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–∏—Å–∫
                const elementAgain = document.elementFromPoint(clientX, clientY);
                if (elementAgain) {
                    cell = elementAgain.closest('.gantt-cell');
                }
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º pointer-events
                bars.forEach((bar, i) => {
                    bar.style.pointerEvents = originalPointerEvents[i] || '';
                });
            }
            
            return cell;
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ –¥–∞—Ç—ã (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ Date)
        function safeGetTime(date) {
            if (!date) return NaN;
            if (date instanceof Date) return date.getTime();
            const d = new Date(date);
            return d.getTime();
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ Date
        function ensureDate(date) {
            if (!date) return null;
            if (date instanceof Date) return date;
            return new Date(date);
        }

        // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ –ø–æ—Å–ª–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –≤ —Å—Ç—Ä–æ–≥–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        function recalculateFollowingTasks(changedIndex) {
            console.log('üî¢ recalculateFollowingTasks: –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å –∏–Ω–¥–µ–∫—Å–∞', changedIndex);
            for (let i = changedIndex + 1; i < tasks.length; i++) {
                const prevTask = tasks[i - 1];
                const task = tasks[i];
                
                // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–∞—Ç—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–¥–∞—á–∏ (–ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ Date)
                if (prevTask.startDate && !(prevTask.startDate instanceof Date)) {
                    prevTask.startDate = new Date(prevTask.startDate);
                }
                if (prevTask.endDate && !(prevTask.endDate instanceof Date)) {
                    prevTask.endDate = new Date(prevTask.endDate);
                }
                
                // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–∞—Ç—ã —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏
                if (task.startDate && !(task.startDate instanceof Date)) {
                    task.startDate = new Date(task.startDate);
                }
                if (task.endDate && !(task.endDate instanceof Date)) {
                    task.endDate = new Date(task.endDate);
                }
                
                // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –º–∞—Å—Å–∏–≤ –¥–∞—Ç –∑–∞–¥–∞—á–∏
                if (task.dates && Array.isArray(task.dates)) {
                    task.dates = task.dates.map(d => d instanceof Date ? d : new Date(d)).filter(d => !isNaN(d.getTime()));
                }
                
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ task.days –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∞—Ç –∏–ª–∏ 1 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
                if (!task.days || task.days <= 0) {
                    task.days = task.dates && task.dates.length > 0 ? task.dates.length : 1;
                    console.log(`   ‚ö†Ô∏è task.days –¥–ª—è –∑–∞–¥–∞—á–∏ ${i} –±—ã–ª–æ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:`, task.days);
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –û_–ù, –µ—Å–ª–∏ —Å–≤—è–∑–∏ –Ω–µ—Ç
                if (!task.link) {
                    task.link = '–û_–ù';
                }
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–≤—è–∑–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –û_–ù)
                const linkType = task.link || '–û_–ù';
                
                let newStart, newEnd;
                let shouldRecalculate = false;

                if (linkType === '–ù_–ù') {
                    // –ù_–ù: –Ω–∞—á–∞–ª–æ-–Ω–∞—á–∞–ª–æ - –∑–∞–¥–∞—á–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤ —Ç—É –∂–µ –¥–∞—Ç—É, —á—Ç–æ –∏ –ø—Ä–µ–¥—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫
                    if (!prevTask.startDate) continue;
                    newStart = new Date(prevTask.startDate);
                    const taskStartTime = safeGetTime(task.startDate);
                    shouldRecalculate = isNaN(taskStartTime) || taskStartTime !== newStart.getTime();
                    
                    if (shouldRecalculate) {
                        task.startDate = newStart;
                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—ã —Å —É—á–µ—Ç–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
                        recalculateTaskDatesWithWeekends(task);
                    }
                } else if (linkType === '–û_–û') {
                    // –û_–û: –æ–∫–æ–Ω—á–∞–Ω–∏–µ-–æ–∫–æ–Ω—á–∞–Ω–∏–µ - –∑–∞–¥–∞—á–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –≤ —Ç—É –∂–µ –¥–∞—Ç—É, —á—Ç–æ –∏ –ø—Ä–µ–¥—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫
                    if (!prevTask.endDate) continue;
                    newEnd = new Date(prevTask.endDate);
                    const taskEndTime = safeGetTime(task.endDate);
                    shouldRecalculate = isNaN(taskEndTime) || taskEndTime !== newEnd.getTime();
                    
                    if (shouldRecalculate) {
                        task.endDate = newEnd;
                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–∞–∑–∞–¥ –æ—Ç –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è
                        const daysCount = task.days || 1;
                        const dates = getWorkdaysBackward(task.endDate, daysCount);
                        if (dates && dates.length > 0) {
                            task.dates = dates;
                            task.startDate = dates[0];
                            task.endDate = dates[dates.length - 1];
                        }
                    }
                } else {
                    // –û_–ù (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é): –æ–∫–æ–Ω—á–∞–Ω–∏–µ-–Ω–∞—á–∞–ª–æ - –∑–∞–¥–∞—á–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π
                    if (!prevTask.endDate) continue;
                    newStart = new Date(prevTask.endDate);
                    newStart.setDate(newStart.getDate() + 1);
                    // –ò—â–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
                    while (!isWorkday(newStart)) {
                        newStart.setDate(newStart.getDate() + 1);
                    }
                    const taskStartTime = safeGetTime(task.startDate);
                    shouldRecalculate = isNaN(taskStartTime) || taskStartTime !== newStart.getTime();
                    
                    if (shouldRecalculate) {
                        task.startDate = newStart;
                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—ã —Å —É—á–µ—Ç–æ–º –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–Ω–µ–π (weekend-manual)
                        recalculateTaskDatesWithWeekends(task);
                    }
                }

                if (!shouldRecalculate) {
                    console.log(`   ‚è≠Ô∏è  –î–∞—Ç—ã –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –¥–ª—è –∑–∞–¥–∞—á–∏ ${i}, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);
                    continue;
                }

                console.log(`\n   üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á–∏ ${i}:`, task.task || task.name || `ID ${task.id}`);
                console.log(`   üîó –¢–∏–ø —Å–≤—è–∑–∏: ${linkType}`);
                console.log('   üìÖ –°—Ç–∞—Ä–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:', task.startDate ? formatDateKey(task.startDate) : '–Ω–µ—Ç');
                console.log('   üìÖ –ù–æ–≤–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:', formatDateKey(task.startDate));
                console.log('   üìÖ –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:', task.endDate ? formatDateKey(task.endDate) : '–Ω–µ—Ç');
                console.log('   üìÖ –°—Ç–∞—Ä—ã–µ –¥–∞—Ç—ã:', task.dates?.map(d => formatDateKey(d)) || []);
                console.log('   üìä –°—Ç–∞—Ä—ã–µ —Å—Ç–∞—Ç—É—Å—ã –¥–∞—Ç:', task.dateStatuses);
                console.log('   üí¨ –°—Ç–∞—Ä—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:', task.dateComments);

                console.log('   üìÖ –ù–æ–≤—ã–µ –¥–∞—Ç—ã:', task.dates?.map(d => formatDateKey(d)) || []);
                console.log('   ‚ö†Ô∏è  –°–ë–†–û–° —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–∞—Ç!');
                console.log('      - –°—Ç–∞—Ç—É—Å—ã –î–û —Å–±—Ä–æ—Å–∞:', task.dateStatuses);
                console.log('      - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –î–û —Å–±—Ä–æ—Å–∞:', task.dateComments);

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –¥–∞—Ç –¥–ª—è —Å–¥–≤–∏–Ω—É—Ç—ã—Ö –∑–∞–¥–∞—á
                task.dateStatuses = {};
                
                console.log('      - –°—Ç–∞—Ç—É—Å—ã –ü–û–°–õ–ï —Å–±—Ä–æ—Å–∞:', task.dateStatuses);
                console.log('   ‚ùå –í–°–ï –°–¢–ê–¢–£–°–´ –£–î–ê–õ–ï–ù–´!');
            }
            console.log('üî¢ recalculateFollowingTasks: –ü–µ—Ä–µ—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω\n');
        }

        // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –¥–∞—Ç—ã –∑–∞–¥–∞—á –Ω–∞—á–∏–Ω–∞—è —Å —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å–ª–µ drag&drop)
        function recalculateDatesFrom(startIndex) {
            if (startIndex < 0 || startIndex >= tasks.length) return;
            console.log('üî¢ recalculateDatesFrom: –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å –∏–Ω–¥–µ–∫—Å–∞', startIndex);
            autoSaveGanttState();
            let prevTask = null;
            if (startIndex > 0) {
                prevTask = tasks[startIndex - 1];
            }

            for (let i = startIndex; i < tasks.length; i++) {
                const task = tasks[i];
                console.log(`\n   üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á–∏ ${i}:`, task.task || task.name || `ID ${task.id}`);

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –û_–ù, –µ—Å–ª–∏ —Å–≤—è–∑–∏ –Ω–µ—Ç
                if (!task.link && i > 0) {
                    task.link = '–û_–ù';
                }
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–≤—è–∑–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –û_–ù –¥–ª—è –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏ –Ω–µ—Ç —Å–≤—è–∑–∏)
                const linkType = task.link || '–û_–ù';
                
                let dates;
                
                if (i === 0) {
                    // –î–ª—è –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ—ë —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞
                    const newStart = new Date(task.startDate);
                    dates = getTaskDates(newStart, task.days);
                } else if (prevTask) {
                    if (linkType === '–ù_–ù') {
                        // –ù_–ù: –Ω–∞—á–∞–ª–æ-–Ω–∞—á–∞–ª–æ - –∑–∞–¥–∞—á–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤ —Ç—É –∂–µ –¥–∞—Ç—É, —á—Ç–æ –∏ –ø—Ä–µ–¥—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫
                        if (prevTask.startDate) {
                            const newStart = new Date(prevTask.startDate);
                            dates = getTaskDates(newStart, task.days);
                        } else {
                            continue;
                        }
                    } else if (linkType === '–û_–û') {
                        // –û_–û: –æ–∫–æ–Ω—á–∞–Ω–∏–µ-–æ–∫–æ–Ω—á–∞–Ω–∏–µ - –∑–∞–¥–∞—á–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –≤ —Ç—É –∂–µ –¥–∞—Ç—É, —á—Ç–æ –∏ –ø—Ä–µ–¥—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫
                        if (prevTask.endDate) {
                            const newEnd = new Date(prevTask.endDate);
                            dates = getWorkdaysBackward(newEnd, task.days);
                        } else {
                            continue;
                        }
                    } else {
                        // –û_–ù (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é): –æ–∫–æ–Ω—á–∞–Ω–∏–µ-–Ω–∞—á–∞–ª–æ - –∑–∞–¥–∞—á–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π
                        if (prevTask.endDate) {
                            const newStart = new Date(prevTask.endDate);
                            newStart.setDate(newStart.getDate() + 1);
                            dates = getTaskDates(newStart, task.days);
                        } else {
                            continue;
                        }
                    }
                } else {
                    continue;
                }

                console.log('   üìÖ –°—Ç–∞—Ä–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:', task.startDate ? formatDateKey(task.startDate) : '–Ω–µ—Ç');
                console.log('   üìÖ –ù–æ–≤–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:', formatDateKey(dates[0]));
                console.log('   üìÖ –°—Ç–∞—Ä—ã–µ –¥–∞—Ç—ã:', task.dates?.map(d => formatDateKey(d)) || []);
                console.log('   üìä –°—Ç–∞—Ä—ã–µ —Å—Ç–∞—Ç—É—Å—ã –¥–∞—Ç:', task.dateStatuses);
                console.log('   üí¨ –°—Ç–∞—Ä—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:', task.dateComments);

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –¥–∞—Ç
                const oldDateStatuses = { ...task.dateStatuses };
                const oldDateComments = { ...(task.dateComments || {}) };
                const oldDates = [...(task.dates || [])];
                
                console.log('   üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ:');
                console.log('      - –°—Ç–∞—Ç—É—Å—ã:', oldDateStatuses);
                console.log('      - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:', oldDateComments);
                console.log('      - –°—Ç–∞—Ä—ã–µ –¥–∞—Ç—ã:', oldDates.map(d => formatDateKey(d)));
                
                task.dates = dates;
                task.startDate = dates[0];
                task.endDate = dates[dates.length - 1];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º prevTask –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
                prevTask = task;

                console.log('   üìÖ –ù–æ–≤—ã–µ –¥–∞—Ç—ã:', dates.map(d => formatDateKey(d)));
                console.log('   ‚ö†Ô∏è  –°–ë–†–û–° —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤!');
                console.log('      - –°—Ç–∞—Ç—É—Å—ã –î–û —Å–±—Ä–æ—Å–∞:', task.dateStatuses);
                console.log('      - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –î–û —Å–±—Ä–æ—Å–∞:', task.dateComments);

                // –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–ø–æ—á–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∫—Ä–∞—Å–∫—É –¥–∞—Ç
                // –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ –∫–æ –≤—Å–µ–º –¥–∞—Ç–∞–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                // –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –¥–∞—Ç –¥–æ–ª–∂–Ω—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –≤—Ä—É—á–Ω—É—é
                task.dateStatuses = {};
                task.dateComments = {};
                
                console.log('      - –°—Ç–∞—Ç—É—Å—ã –ü–û–°–õ–ï —Å–±—Ä–æ—Å–∞:', task.dateStatuses);
                console.log('      - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ü–û–°–õ–ï —Å–±—Ä–æ—Å–∞:', task.dateComments);
                console.log('   ‚ùå –í–°–ï –°–¢–ê–¢–£–°–´ –ò –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò –£–î–ê–õ–ï–ù–´!');

                // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –±—ã–ª–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞, –Ω–æ –¥–∞—Ç—ã –æ—Å—Ç–∞–ª–∏—Å—å —Ç–µ–º–∏ –∂–µ (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ),
                // –º–æ–∂–Ω–æ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã, –Ω–æ –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤ –¥–∞—Ç—ã –º–µ–Ω—è—é—Ç—Å—è,
                // –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã

                prevEnd = task.endDate;
            }
            console.log('üî¢ recalculateDatesFrom: –ü–µ—Ä–µ—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω\n');
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
        function copyTask(taskId) {
            const index = tasks.findIndex(t => t.id === taskId);
            if (index === -1) return;
            
            const task = tasks[index];
            // –°–æ–∑–¥–∞–µ–º –≥–ª—É–±–æ–∫—É—é –∫–æ–ø–∏—é –∑–∞–¥–∞—á–∏
            copiedTask = {
                stage: task.stage,
                control: task.control,
                task: task.task,
                days: task.days,
                substage: task.substage || '',
                status: task.status || 'pending',
                dateStatuses: task.dateStatuses ? { ...task.dateStatuses } : {},
                dateComments: task.dateComments ? { ...task.dateComments } : {},
                link: task.link || '',
                responsible: task.responsible || '',
                onTravel: task.onTravel || false
            };
            
            console.log('‚úÖ –ó–∞–¥–∞—á–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞:', copiedTask);
        }

        // –í—Å—Ç–∞–≤–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏
        function pasteTask() {
            if (!canEdit()) {
                return; // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å—Ç–∞–≤–∫—É –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            }
            
            if (copiedTask === null) return;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π –∑–∞–¥–∞—á–∏
            addToUndoHistory();
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –ø–æ—Å–ª–µ –∫–∞–∫–æ–π –∑–∞–¥–∞—á–∏ –≤—Å—Ç–∞–≤–ª—è—Ç—å
            const baseId = getPrimarySelectedTaskId();
            let insertIndex;
            
            if (baseId !== null) {
                // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏
                const index = tasks.findIndex(t => t.id === baseId);
                if (index === -1) return;
                insertIndex = index + 1;
                
                const selectedTask = tasks[index];
                if (!selectedTask.endDate) return;
                
                // –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏: —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –ø–æ—Å–ª–µ –∫–æ–Ω—Ü–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π
                let newStart = new Date(selectedTask.endDate);
                do {
                    newStart.setDate(newStart.getDate() + 1);
                } while (!isWorkday(newStart));
                
                const newDates = getTaskDates(newStart, copiedTask.days);
                
                const newTask = {
                    id: nextTaskId++,
                    stage: copiedTask.stage,
                    control: copiedTask.control,
                    task: copiedTask.task,
                    days: copiedTask.days,
                    substage: copiedTask.substage,
                    startDate: newDates[0],
                    endDate: newDates[newDates.length - 1],
                    dates: newDates,
                    status: copiedTask.status,
                    dateStatuses: {},
                    dateComments: {},
                    link: copiedTask.link,
                    responsible: copiedTask.responsible,
                    onTravel: copiedTask.onTravel || false
                };
                
                // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –ø–æ—Å–ª–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π
                tasks.splice(insertIndex, 0, newTask);
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏
                recalculateFollowingTasks(insertIndex);
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏, –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü
                const lastTask = tasks[tasks.length - 1];
                if (!lastTask || !lastTask.endDate) return;
                
                let newStart = new Date(lastTask.endDate);
                do {
                    newStart.setDate(newStart.getDate() + 1);
                } while (!isWorkday(newStart));
                
                const newDates = getTaskDates(newStart, copiedTask.days);
                
                const newTask = {
                    id: nextTaskId++,
                    stage: copiedTask.stage,
                    control: copiedTask.control,
                    task: copiedTask.task,
                    days: copiedTask.days,
                    substage: copiedTask.substage,
                    startDate: newDates[0],
                    endDate: newDates[newDates.length - 1],
                    dates: newDates,
                    status: copiedTask.status,
                    dateStatuses: {},
                    dateComments: {},
                    link: copiedTask.link,
                    responsible: copiedTask.responsible,
                    onTravel: copiedTask.onTravel || false
                };
                
                tasks.push(newTask);
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∏ –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π
            const scrollY = window.scrollY || window.pageYOffset;
            const scrollX = window.scrollX || window.pageXOffset;
            
            const chartContainer = document.getElementById('ganttChart');
            const chartScrollTop = chartContainer ? chartContainer.scrollTop : 0;
            const chartScrollLeft = chartContainer ? chartContainer.scrollLeft : 0;
            
            const activeElement = document.activeElement;
            const activeElementInfo = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA') 
                ? { element: activeElement, selectionStart: activeElement.selectionStart, selectionEnd: activeElement.selectionEnd }
                : null;
            
            if (activeElementInfo) {
                activeElementInfo.element.blur();
            }

            updateStatistics();
            
            if (searchResults.length > 0) {
                highlightSearchResults();
            }
            renderGantt();
            renderTable();

            window.scrollTo(scrollX, scrollY);
            const newChartContainer = document.getElementById('ganttChart');
            if (newChartContainer) {
                newChartContainer.scrollTop = chartScrollTop;
                newChartContainer.scrollLeft = chartScrollLeft;
            }
            
            if (activeElementInfo && document.contains(activeElementInfo.element)) {
                requestAnimationFrame(() => {
                    try {
                        activeElementInfo.element.focus({ preventScroll: true });
                        if (activeElementInfo.element.setSelectionRange && 
                            activeElementInfo.selectionStart !== null && 
                            activeElementInfo.selectionEnd !== null) {
                            activeElementInfo.element.setSelectionRange(
                                activeElementInfo.selectionStart, 
                                activeElementInfo.selectionEnd
                            );
                        }
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–æ–∫—É—Å–∞
                    }
                });
            }
            
            // –í—ã–¥–µ–ª—è–µ–º –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É
            if (insertIndex !== undefined && tasks[insertIndex]) {
                selectedTaskIds.clear();
                selectedTaskIds.add(tasks[insertIndex].id);
                lastSelectedTaskId = tasks[insertIndex].id;
                highlightSelectedTasks();
            }
            
            console.log('‚úÖ –ó–∞–¥–∞—á–∞ –≤—Å—Ç–∞–≤–ª–µ–Ω–∞');
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ "–Ω–∞ –≤—ã–µ–∑–¥–µ" –¥–ª—è –∑–∞–¥–∞—á–∏ (Ctrl+Q)
        function toggleTaskTravelStatus(taskId) {
            if (!canEdit()) {
                return; // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            }
            
            const index = tasks.findIndex(t => t.id === taskId);
            if (index === -1) {
                console.log('‚ö†Ô∏è –ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', taskId);
                return;
            }
            
            const task = tasks[index];
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª–µ onTravel, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if (task.onTravel === undefined) {
                task.onTravel = false;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
            addToUndoHistory();
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ç—É—Å "–Ω–∞ –≤—ã–µ–∑–¥–µ"
            task.onTravel = !task.onTravel;
            
            console.log(`üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ "–Ω–∞ –≤—ã–µ–∑–¥–µ" –¥–ª—è –∑–∞–¥–∞—á–∏ ${taskId}: ${task.onTravel ? '–≤–∫–ª—é—á–µ–Ω–æ' : '–≤—ã–∫–ª—é—á–µ–Ω–æ'}`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            updateStatistics();
            if (currentView === 'gantt') {
                renderGantt();
            }
            renderTable();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            console.log('üíæ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ "–Ω–∞ –≤—ã–µ–∑–¥–µ", —Å–æ—Ö—Ä–∞–Ω—è–µ–º');
            saveFullGanttState();
            
            console.log(`‚úÖ –ó–∞–¥–∞—á–∞ ${task.onTravel ? '–æ—Ç–º–µ—á–µ–Ω–∞' : '—Å–Ω—è—Ç–∞ –æ—Ç–º–µ—Ç–∫–∞'} –∫–∞–∫ "–Ω–∞ –≤—ã–µ–∑–¥–µ"`);
        }

        // –í—Å—Ç–∞–≤–∫–∞ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω–æ–π (Insert)
        function insertTaskBelowSelected() {
            if (!canEdit()) {
                return; // –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –∑–∞–¥–∞—á–∏
            addToUndoHistory();
            
            const baseId = getPrimarySelectedTaskId();
            if (baseId === null) return;

            const index = tasks.findIndex(t => t.id === baseId);
            if (index === -1) return;

            const selectedTask = tasks[index];
            if (!selectedTask.endDate) return;

            // –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏: —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –ø–æ—Å–ª–µ –∫–æ–Ω—Ü–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π
            let newStart = new Date(selectedTask.endDate);
            do {
                newStart.setDate(newStart.getDate() + 1);
            } while (!isWorkday(newStart));

            const newDates = getTaskDates(newStart, 1); // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 1 —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å

            const newTask = {
                id: nextTaskId++,
                stage: selectedTask.stage,
                control: selectedTask.control,
                task: '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞',
                days: 1,
                substage: '',
                startDate: newDates[0],
                endDate: newDates[newDates.length - 1],
                dates: newDates,
                status: 'pending',
                dateStatuses: {},
                link: '',
                responsible: '',
                onTravel: false
            };

            // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π
            tasks.splice(index + 1, 0, newTask);

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏, —á—Ç–æ–±—ã –æ–Ω–∏ —à–ª–∏ –ø–æ—Å–ª–µ –Ω–æ–≤–æ–π
            recalculateFollowingTasks(index + 1);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∏ –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π
            const scrollY = window.scrollY || window.pageYOffset;
            const scrollX = window.scrollX || window.pageXOffset;
            
            // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–∏–∞–≥—Ä–∞–º–º—ã, –µ—Å–ª–∏ –µ—Å—Ç—å
            const chartContainer = document.getElementById('ganttChart');
            const chartScrollTop = chartContainer ? chartContainer.scrollTop : 0;
            const chartScrollLeft = chartContainer ? chartContainer.scrollLeft : 0;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏ —É–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É
            const activeElement = document.activeElement;
            const activeElementInfo = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA') 
                ? { element: activeElement, selectionStart: activeElement.selectionStart, selectionEnd: activeElement.selectionEnd }
                : null;
            
            if (activeElementInfo) {
                activeElementInfo.element.blur();
            }

            updateStatistics();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            if (searchResults.length > 0) {
                highlightSearchResults();
            }
            renderGantt();
            renderTable();

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å—Ä–∞–∑—É, –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
            window.scrollTo(scrollX, scrollY);
            const newChartContainer = document.getElementById('ganttChart');
            if (newChartContainer) {
                newChartContainer.scrollTop = chartScrollTop;
                newChartContainer.scrollLeft = chartScrollLeft;
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏)
            if (activeElementInfo && document.contains(activeElementInfo.element)) {
                requestAnimationFrame(() => {
                    try {
                        activeElementInfo.element.focus({ preventScroll: true });
                        if (activeElementInfo.element.setSelectionRange && 
                            activeElementInfo.selectionStart !== null && 
                            activeElementInfo.selectionEnd !== null) {
                            activeElementInfo.element.setSelectionRange(
                                activeElementInfo.selectionStart, 
                                activeElementInfo.selectionEnd
                            );
                        }
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–æ–∫—É—Å–∞
                    }
                });
            }

            // –í—ã–¥–µ–ª—è–µ–º —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É
            selectTask(newTask.id);
	    autoSaveGanttState();
            autoSaveGanttState(); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á (Delete)
        function deleteSelectedTask() {
            if (!canEdit()) {
                return; // –ë–ª–æ–∫–∏—Ä—É–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            }
            if (!selectedTaskIds.size) return;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –∑–∞–¥–∞—á–∏
            addToUndoHistory();

            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –≤—Å–µ—Ö –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∏—Ö –î–û —É–¥–∞–ª–µ–Ω–∏—è
            const indices = [];
            const deletedTasksInfo = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É–¥–∞–ª—è–µ–º—ã—Ö –∑–∞–¥–∞—á–∞—Ö
            
            tasks.forEach((t, idx) => {
                if (selectedTaskIds.has(t.id)) {
                    indices.push(idx);
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞—á–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
                    const taskInfo = {
                        id: t.id,
                        taskIndex: idx,
                        taskName: t.task || t.name || `–ó–∞–¥–∞—á–∞ ${idx + 1}`,
                        stage: t.stage || '',
                        control: t.control || t.controlType || '',
                        startDate: t.startDate ? formatDateKey(t.startDate) : null,
                        endDate: t.endDate ? formatDateKey(t.endDate) : null,
                        days: t.days || 0,
                        status: t.status || 'pending',
                        link: t.link || '',
                        responsible: t.responsible || '',
                        dateStatuses: t.dateStatuses ? JSON.parse(JSON.stringify(t.dateStatuses)) : {},
                        dateComments: t.dateComments ? JSON.parse(JSON.stringify(t.dateComments)) : {}
                    };
                    deletedTasksInfo.push(taskInfo);
                }
            });

            if (!indices.length) return;

            const firstIndex = Math.min(...indices);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
            if (!window.pendingDeletedTasks) {
                window.pendingDeletedTasks = [];
            }
            window.pendingDeletedTasks.push(...deletedTasksInfo);

            // –£–¥–∞–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Å –∫–æ–Ω—Ü–∞, —á—Ç–æ–±—ã –Ω–µ —Å–±–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
            indices
                .sort((a, b) => b - a)
                .forEach(i => {
                    tasks.splice(i, 1);
                });

            selectedTaskIds.clear();
            lastSelectedTaskId = null;

            if (!tasks.length) {
                // –ï—Å–ª–∏ –∑–∞–¥–∞—á –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –±–µ–∑ –ø–µ—Ä–µ—Å—á—ë—Ç–∞
                updateStatistics();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            if (searchResults.length > 0) {
                highlightSearchResults();
            }
                renderGantt();
                renderTable();
                return;
            }

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–ø–æ—á–∫—É –¥–∞—Ç –Ω–∞—á–∏–Ω–∞—è —Å –ø–æ–∑–∏—Ü–∏–∏, –≥–¥–µ –±—ã–ª–∞ –ø–µ—Ä–≤–∞—è —É–¥–∞–ª—ë–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞
            const startIndex = Math.min(firstIndex, tasks.length - 1);
            if (startIndex === 0) {
                recalculateDatesFrom(0);
            } else {
                recalculateFollowingTasks(startIndex - 1);
            }
		autoSaveGanttState();

            // –°—Ç–∞–≤–∏–º –∫—É—Ä—Å–æ—Ä –Ω–∞ –∑–∞–¥–∞—á—É, –∫–æ—Ç–æ—Ä–∞—è —Å—Ç–∞–ª–∞ –Ω–∞ –º–µ—Å—Ç–æ –ø–µ—Ä–≤–æ–π —É–¥–∞–ª—ë–Ω–Ω–æ–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
            const newIndex = Math.min(startIndex, tasks.length - 1);
            const newSelected = tasks[newIndex];
            if (newSelected) {
                selectedTaskIds.add(newSelected.id);
                lastSelectedTaskId = newSelected.id;
            }

            updateStatistics();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            if (searchResults.length > 0) {
                highlightSearchResults();
            }
            renderGantt();
            renderTable();

            applySelectionHighlight();
            autoSaveGanttState(); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
        }

        // –û–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
        function openDeleteConfirm() {
            if (!selectedTaskIds.size) return;
            const modal = document.getElementById('deleteConfirmModal');
            if (!modal) return;
            modal.style.display = 'block';
            isDeleteConfirmOpen = true;
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä—è–¥–æ–º —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π
            const primaryTaskId = getPrimarySelectedTaskId();
            if (primaryTaskId) {
                // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ –∏–ª–∏ –≤ –¥–∏–∞–≥—Ä–∞–º–º–µ –ì–∞–Ω—Ç–∞
                const tableRow = document.querySelector(`#tasksTableBody tr[data-task-id="${primaryTaskId}"]`);
                const ganttRow = document.querySelector(`.gantt-row[data-task-id="${primaryTaskId}"]`);
                const referenceElement = tableRow || ganttRow;
                
                if (referenceElement) {
                    // –î–≤–æ–π–Ω–æ–π requestAnimationFrame –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏–ª—Å—è
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            const modalContent = modal.querySelector('.modal-content');
                            if (!modalContent) return;
                            
                            const elementRect = referenceElement.getBoundingClientRect();
                            const viewportHeight = window.innerHeight;
                            const viewportWidth = window.innerWidth;
                            
                            // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
                            const modalRect = modalContent.getBoundingClientRect();
                            const modalHeight = modalRect.height || 200;
                            const modalWidth = Math.min(modalRect.width || 500, viewportWidth - 40);
                            
                            // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ —Å–≤–µ—Ä—Ö—É –∏ —Å–Ω–∏–∑—É –æ—Ç —Å—Ç—Ä–æ–∫–∏
                            const spaceBelow = viewportHeight - elementRect.bottom;
                            const spaceAbove = elementRect.top;
                            
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≥–¥–µ –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞ - —Å–≤–µ—Ä—Ö—É –∏–ª–∏ —Å–Ω–∏–∑—É
                            let topPosition;
                            if (spaceBelow < modalHeight + 20 && spaceAbove > spaceBelow) {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–¥ —Å—Ç—Ä–æ–∫–æ–π
                                topPosition = elementRect.top - modalHeight - 20;
                            } else {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥ —Å—Ç—Ä–æ–∫–æ–π
                                topPosition = elementRect.bottom + 20;
                            }
                            
                            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ–∫–Ω–æ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞
                            const minTop = 20;
                            const maxTop = viewportHeight - modalHeight - 20;
                            topPosition = Math.max(minTop, Math.min(topPosition, maxTop));
                            
                            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å—Ç—Ä–æ–∫–∏, –Ω–æ –Ω–µ –≤—ã—Ö–æ–¥–∏–º –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞
                            let leftPosition = elementRect.left + (elementRect.width / 2) - (modalWidth / 2);
                            const minLeft = 20;
                            const maxLeft = viewportWidth - modalWidth - 20;
                            leftPosition = Math.max(minLeft, Math.min(leftPosition, maxLeft));
                            
                            // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                            modalContent.style.setProperty('position', 'fixed', 'important');
                            modalContent.style.setProperty('top', topPosition + 'px', 'important');
                            modalContent.style.setProperty('left', leftPosition + 'px', 'important');
                            modalContent.style.setProperty('transform', 'none', 'important');
                            modalContent.style.setProperty('margin', '0', 'important');
                            modalContent.style.setProperty('width', 'calc(100% - 40px)', 'important');
                            modalContent.style.setProperty('max-width', '500px', 'important');
                        });
                    });
                } else {
                    // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
                    requestAnimationFrame(() => {
                        const modalContent = modal.querySelector('.modal-content');
                        if (modalContent) {
                            modalContent.style.removeProperty('position');
                            modalContent.style.removeProperty('top');
                            modalContent.style.removeProperty('left');
                            modalContent.style.removeProperty('transform');
                            modalContent.style.removeProperty('margin');
                            modalContent.style.removeProperty('width');
                            modalContent.style.removeProperty('max-width');
                        }
                    });
                }
            }
        }

        function cancelDeleteTask() {
            const modal = document.getElementById('deleteConfirmModal');
            if (modal) {
                modal.style.display = 'none';
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.removeProperty('position');
                    modalContent.style.removeProperty('top');
                    modalContent.style.removeProperty('left');
                    modalContent.style.removeProperty('transform');
                    modalContent.style.removeProperty('margin');
                    modalContent.style.removeProperty('width');
                    modalContent.style.removeProperty('max-width');
                }
            }
            isDeleteConfirmOpen = false;
        }

        function confirmDeleteTask() {
            deleteSelectedTask();
            cancelDeleteTask();
        }

// –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ html2pdf.js –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
let html2pdfLoaded = false;
let html2pdfLoading = false;

function loadHtml2Pdf() {
    return new Promise((resolve, reject) => {
        // –ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
        if (html2pdfLoaded && typeof html2pdf !== 'undefined') {
            resolve();
            return;
        }
        
        // –ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –∂–¥—ë–º
        if (html2pdfLoading) {
            const checkInterval = setInterval(() => {
                if (html2pdfLoaded && typeof html2pdf !== 'undefined') {
                    clearInterval(checkInterval);
                    resolve();
                }
            }, 100);
            return;
        }
        
        // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        html2pdfLoading = true;
        const script = document.createElement('script');
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é, —á—Ç–æ–±—ã –Ω–µ –Ω–∞—Ä—É—à–∞—Ç—å CSP (connect-src 'self')
        script.src = 'html2pdf.bundle.min.js?v=0.10.1';
        script.async = true;
        script.onload = () => {
            html2pdfLoaded = true;
            html2pdfLoading = false;
            if (typeof html2pdf !== 'undefined') {
                resolve();
            } else {
                reject(new Error('html2pdf –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è'));
            }
        };
        script.onerror = () => {
            html2pdfLoading = false;
            reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å html2pdf.js. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.'));
        };
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç 10 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            if (!html2pdfLoaded) {
                html2pdfLoading = false;
                script.remove();
                reject(new Error('–¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ html2pdf.js'));
            }
        }, 10000);
        
        document.head.appendChild(script);
    });
}

// –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –¥–∞—Ç–æ–π/–≤—Ä–µ–º–µ–Ω–µ–º
function generateExportFileName(extension) {
    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    const nameEl = document.getElementById('companyNameDisplay');
    let companyNameText = '';
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–∞
    if (nameEl) {
        if (nameEl.classList.contains('has-value')) {
            companyNameText = nameEl.innerText || nameEl.textContent || '';
        }
    }
    
    // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
    if ((!companyNameText || companyNameText.trim() === '') && typeof companyName !== 'undefined' && companyName) {
        companyNameText = companyName;
    }
    
    // –ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –∑–∞–¥–∞–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ
    if (!companyNameText || companyNameText.trim() === '' || companyNameText === '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏') {
        companyNameText = 'ICONA';
    }
    
    // –û—á–∏—â–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    // –£–±–∏—Ä–∞–µ–º: / \ : * ? " < > |
    companyNameText = companyNameText
        .replace(/[/\\:*?"<>|]/g, '')
        .replace(/\s+/g, '_') // –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
        .replace(/_+/g, '_') // –£–±–∏—Ä–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
        .replace(/^_+|_+$/g, '') // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
        .trim();
    
    // –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ
    if (!companyNameText) {
        companyNameText = 'ICONA';
    }
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD_HH-MM-SS
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    
    const dateTime = `${year}-${month}-${day}_${hours}-${minutes}-${seconds}`;
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
    const fileName = `–ì—Ä–∞—Ñ–∏–∫_–≤–Ω–µ–¥—Ä–µ–Ω–∏—è_${companyNameText}_${dateTime}.${extension}`;
    
    return fileName;
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ–∫–Ω–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ PDF —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ª–∏—Å—Ç–æ–≤ A3 –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—Ç—Å—Ç—É–ø–æ–≤
async function showPDFPreview(scaleMode = 'day', includeDiagram = true) {
    if (!tasks || !tasks.length) return;
    
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'pdfPreviewModal';
    modal.style.zIndex = '10004';
    
    const modalContent = document.createElement('div');
    modalContent.className = 'modal-content';
    modalContent.style.maxWidth = '98%';
    modalContent.style.width = '1600px';
    modalContent.style.maxHeight = '98vh';
    modalContent.style.display = 'flex';
    modalContent.style.flexDirection = 'column';
    modalContent.style.padding = '20px';
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    const header = document.createElement('div');
    header.style.display = 'flex';
    header.style.justifyContent = 'space-between';
    header.style.alignItems = 'center';
    header.style.marginBottom = '20px';
    header.style.paddingBottom = '15px';
    header.style.borderBottom = '2px solid #e0e0e0';
    
    const title = document.createElement('h2');
    title.textContent = '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä PDF - –õ–∏—Å—Ç—ã A3 (–∞–ª—å–±–æ–º–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è)';
    title.style.margin = '0';
    title.style.fontSize = '20px';
    title.style.color = '#333';
    
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '√ó';
    closeBtn.style.background = 'none';
    closeBtn.style.border = 'none';
    closeBtn.style.fontSize = '32px';
    closeBtn.style.cursor = 'pointer';
    closeBtn.style.color = '#666';
    closeBtn.style.padding = '0';
    closeBtn.style.width = '40px';
    closeBtn.style.height = '40px';
    closeBtn.style.lineHeight = '1';
    
    const closeModal = () => {
        if (modal.parentNode) document.body.removeChild(modal);
        if (window.previewExportWrapper && window.previewExportWrapper.parentNode) {
            document.body.removeChild(window.previewExportWrapper);
        }
    };
    
    closeBtn.onclick = closeModal;
    
    header.appendChild(title);
    header.appendChild(closeBtn);
    
    // –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ—Ç—Å—Ç—É–ø–æ–≤
    const settingsPanel = document.createElement('div');
    settingsPanel.style.background = '#f5f5f5';
    settingsPanel.style.padding = '15px';
    settingsPanel.style.borderRadius = '8px';
    settingsPanel.style.marginBottom = '15px';
    settingsPanel.style.display = 'grid';
    settingsPanel.style.gridTemplateColumns = 'repeat(auto-fit, minmax(200px, 1fr))';
    settingsPanel.style.gap = '15px';
    
    const createMarginInput = (label, defaultValue, unit = 'mm') => {
        const container = document.createElement('div');
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.style.gap = '5px';
        
        const labelEl = document.createElement('label');
        labelEl.textContent = label;
        labelEl.style.fontSize = '13px';
        labelEl.style.fontWeight = '500';
        labelEl.style.color = '#555';
        
        const inputContainer = document.createElement('div');
        inputContainer.style.display = 'flex';
        inputContainer.style.alignItems = 'center';
        inputContainer.style.gap = '5px';
        
        const input = document.createElement('input');
        input.type = 'number';
        input.value = defaultValue;
        input.min = '0';
        input.max = '50';
        input.step = '1';
        input.style.width = '80px';
        input.style.padding = '6px 8px';
        input.style.border = '1px solid #ddd';
        input.style.borderRadius = '4px';
        input.style.fontSize = '14px';
        
        const unitSpan = document.createElement('span');
        unitSpan.textContent = unit;
        unitSpan.style.fontSize = '13px';
        unitSpan.style.color = '#666';
        
        inputContainer.appendChild(input);
        inputContainer.appendChild(unitSpan);
        
        container.appendChild(labelEl);
        container.appendChild(inputContainer);
        
        return { container, input };
    };
    
    const topMargin = createMarginInput('–û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É', '8');
    const bottomMargin = createMarginInput('–û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É', '5');
    const leftMargin = createMarginInput('–û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞', '5');
    const rightMargin = createMarginInput('–û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞', '5');
    
    settingsPanel.appendChild(topMargin.container);
    settingsPanel.appendChild(bottomMargin.container);
    settingsPanel.appendChild(leftMargin.container);
    settingsPanel.appendChild(rightMargin.container);
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑–º–µ—Ä–µ –ª–∏—Å—Ç–∞
    const pageInfo = document.createElement('div');
    pageInfo.style.background = '#e3f2fd';
    pageInfo.style.padding = '10px 15px';
    pageInfo.style.borderRadius = '6px';
    pageInfo.style.marginBottom = '15px';
    pageInfo.style.fontSize = '13px';
    pageInfo.style.color = '#1976d2';
    pageInfo.innerHTML = '<strong>–†–∞–∑–º–µ—Ä –ª–∏—Å—Ç–∞:</strong> A3 –∞–ª—å–±–æ–º–Ω–∞—è (420mm √ó 297mm)';
    settingsPanel.appendChild(pageInfo);
    
    // –û–±–ª–∞—Å—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å –ª–∏—Å—Ç–∞–º–∏
    const previewArea = document.createElement('div');
    previewArea.style.flex = '1';
    previewArea.style.overflow = 'auto';
    previewArea.style.border = '2px solid #ddd';
    previewArea.style.borderRadius = '8px';
    previewArea.style.background = '#f0f0f0';
    previewArea.style.padding = '30px';
    previewArea.style.minHeight = '500px';
    previewArea.style.display = 'flex';
    previewArea.style.flexDirection = 'column';
    previewArea.style.alignItems = 'center';
    previewArea.style.gap = '20px';
    
    // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
    const actionsPanel = document.createElement('div');
    actionsPanel.style.display = 'flex';
    actionsPanel.style.justifyContent = 'flex-end';
    actionsPanel.style.gap = '10px';
    actionsPanel.style.marginTop = '15px';
    actionsPanel.style.paddingTop = '15px';
    actionsPanel.style.borderTop = '2px solid #e0e0e0';
    
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = '–û—Ç–º–µ–Ω–∞';
    cancelBtn.style.padding = '10px 20px';
    cancelBtn.style.border = '1px solid #ddd';
    cancelBtn.style.borderRadius = '6px';
    cancelBtn.style.background = '#fff';
    cancelBtn.style.cursor = 'pointer';
    cancelBtn.style.fontSize = '14px';
    cancelBtn.onclick = closeModal;
    
    const exportBtn = document.createElement('button');
    exportBtn.textContent = '–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å PDF';
    exportBtn.style.padding = '10px 20px';
    exportBtn.style.border = 'none';
    exportBtn.style.borderRadius = '6px';
    exportBtn.style.background = '#2196f3';
    exportBtn.style.color = '#fff';
    exportBtn.style.cursor = 'pointer';
    exportBtn.style.fontSize = '14px';
    exportBtn.style.fontWeight = '500';
    
    // –ö–Ω–æ–ø–∫–∞ –ø–µ—á–∞—Ç–∏
    const printBtn = document.createElement('button');
    printBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø–µ—á–∞—Ç—å';
    printBtn.style.padding = '10px 20px';
    printBtn.style.border = 'none';
    printBtn.style.borderRadius = '6px';
    printBtn.style.background = '#4caf50';
    printBtn.style.color = '#fff';
    printBtn.style.cursor = 'pointer';
    printBtn.style.fontSize = '14px';
    printBtn.style.fontWeight = '500';
    
    modalContent.appendChild(header);
    modalContent.appendChild(settingsPanel);
    modalContent.appendChild(previewArea);
    modalContent.appendChild(actionsPanel);
    actionsPanel.appendChild(cancelBtn);
    actionsPanel.appendChild(printBtn);
    actionsPanel.appendChild(exportBtn);
    modal.appendChild(modalContent);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingIndicator = document.createElement('div');
    loadingIndicator.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞...';
    loadingIndicator.style.position = 'fixed';
    loadingIndicator.style.top = '50%';
    loadingIndicator.style.left = '50%';
    loadingIndicator.style.transform = 'translate(-50%, -50%)';
    loadingIndicator.style.padding = '20px 40px';
    loadingIndicator.style.background = 'rgba(0, 0, 0, 0.8)';
    loadingIndicator.style.color = '#fff';
    loadingIndicator.style.borderRadius = '8px';
    loadingIndicator.style.zIndex = '999999';
    loadingIndicator.style.fontSize = '16px';
    loadingIndicator.style.fontWeight = '600';
    document.body.appendChild(loadingIndicator);
    
    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ª–∏—Å—Ç–∞ A3
    const createPagePreview = (section, pageNumber, margins) => {
        // A3 landscape: 420mm √ó 297mm
        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: 1mm = 3.779527559px –ø—Ä–∏ 96 DPI
        // –ú–∞—Å—à—Ç–∞–± –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: 0.4 (—á—Ç–æ–±—ã –ø–æ–º–µ—Å—Ç–∏–ª–æ—Å—å –Ω–∞ —ç–∫—Ä–∞–Ω–µ, –Ω–æ –±—ã–ª–æ –≤–∏–¥–Ω–æ –¥–µ—Ç–∞–ª–∏)
        const scale = 0.4;
        const mmToPx = 3.779527559; // 1mm –≤ –ø–∏–∫—Å–µ–ª—è—Ö –ø—Ä–∏ 96 DPI
        const pageWidth = 420 * mmToPx * scale; // –®–∏—Ä–∏–Ω–∞ A3 landscape –≤ –ø–∏–∫—Å–µ–ª—è—Ö
        const pageHeight = 297 * mmToPx * scale; // –í—ã—Å–æ—Ç–∞ A3 landscape –≤ –ø–∏–∫—Å–µ–ª—è—Ö
        
        const pageContainer = document.createElement('div');
        pageContainer.style.position = 'relative';
        pageContainer.style.width = pageWidth + 'px';
        pageContainer.style.height = pageHeight + 'px';
        pageContainer.style.margin = '0 auto 20px auto';
        pageContainer.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        pageContainer.style.background = '#fff';
        pageContainer.style.border = '2px solid #333';
        pageContainer.style.borderRadius = '4px';
        pageContainer.style.overflow = 'hidden';
        
        // –ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const pageNumberEl = document.createElement('div');
        pageNumberEl.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageNumber}`;
        pageNumberEl.style.position = 'absolute';
        pageNumberEl.style.top = '5px';
        pageNumberEl.style.right = '10px';
        pageNumberEl.style.fontSize = '11px';
        pageNumberEl.style.color = '#666';
        pageNumberEl.style.fontWeight = '500';
        pageNumberEl.style.zIndex = '10';
        pageContainer.appendChild(pageNumberEl);
        
        // –û–±–ª–∞—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏
        const contentArea = document.createElement('div');
        const marginLeftPx = margins.left * mmToPx * scale;
        const marginTopPx = margins.top * mmToPx * scale;
        const marginRightPx = margins.right * mmToPx * scale;
        const marginBottomPx = margins.bottom * mmToPx * scale;
        
        contentArea.style.position = 'absolute';
        contentArea.style.left = marginLeftPx + 'px';
        contentArea.style.top = marginTopPx + 'px';
        contentArea.style.width = (pageWidth - marginLeftPx - marginRightPx) + 'px';
        contentArea.style.height = (pageHeight - marginTopPx - marginBottomPx) + 'px';
        contentArea.style.overflow = 'hidden';
        contentArea.style.border = '1px dashed #2196f3';
        contentArea.style.background = '#fafafa';
        contentArea.style.boxSizing = 'border-box';
        
        // –ö–ª–æ–Ω–∏—Ä—É–µ–º —Å–µ–∫—Ü–∏—é –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        const sectionClone = section.cloneNode(true);
        // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç, —á—Ç–æ–±—ã –æ–Ω –ø–æ–º–µ—Å—Ç–∏–ª—Å—è –≤ –æ–±–ª–∞—Å—Ç—å —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏
        const contentScale = (pageWidth - marginLeftPx - marginRightPx) / (420 * mmToPx);
        sectionClone.style.transform = `scale(${contentScale})`;
        sectionClone.style.transformOrigin = 'top left';
        sectionClone.style.width = (420 * mmToPx) + 'px';
        sectionClone.style.position = 'relative';
        sectionClone.style.margin = '0';
        sectionClone.style.padding = '0';
        sectionClone.style.border = 'none';
        sectionClone.style.background = 'transparent';
        
        // –£–±–∏—Ä–∞–µ–º page-break —Å—Ç–∏–ª–∏ –∏–∑ –∫–ª–æ–Ω–∞
        sectionClone.style.pageBreakBefore = 'none';
        sectionClone.style.pageBreakAfter = 'none';
        sectionClone.style.breakBefore = 'none';
        sectionClone.style.breakAfter = 'none';
        
        contentArea.appendChild(sectionClone);
        pageContainer.appendChild(contentArea);
        
        // –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏
        const tooltip = document.createElement('div');
        tooltip.style.position = 'absolute';
        tooltip.style.bottom = '-25px';
        tooltip.style.left = '50%';
        tooltip.style.transform = 'translateX(-50%)';
        tooltip.style.fontSize = '10px';
        tooltip.style.color = '#888';
        tooltip.style.whiteSpace = 'nowrap';
        tooltip.textContent = `A3 –∞–ª—å–±–æ–º–Ω–∞—è: 420mm √ó 297mm (–º–∞—Å—à—Ç–∞–± –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ ${(scale * 100).toFixed(0)}%)`;
        pageContainer.appendChild(tooltip);
        
        return pageContainer;
    };
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    const updatePreview = () => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ previewArea —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
        if (!previewArea || !previewArea.parentNode) {
            return;
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        isUpdatingPreview = true;
        
        // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –î–û –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π DOM
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π –º–µ—Ç–æ–¥ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤–∏–¥–∏–º–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
        const savedScrollTop = previewArea.scrollTop;
        const savedScrollLeft = previewArea.scrollLeft;
        const savedScrollHeight = previewArea.scrollHeight;
        const savedClientHeight = previewArea.clientHeight;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –∑–∞—â–∏—Ç—ã
        savedScrollPosition = {
            scrollTop: savedScrollTop,
            scrollLeft: savedScrollLeft,
            scrollHeight: savedScrollHeight,
            clientHeight: savedClientHeight
        };
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —ç–ª–µ–º–µ–Ω—Ç –±—ã–ª –≤–∏–¥–µ–Ω –≤ —Ü–µ–Ω—Ç—Ä–µ —ç–∫—Ä–∞–Ω–∞ (–¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)
        const viewportCenter = savedScrollTop + previewArea.clientHeight / 2;
        let visiblePageIndex = -1;
        let relativePositionInPage = 0; // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (0-1)
        let targetPageId = null; // ID –∏–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
        
        const pagePreviews = previewArea.querySelectorAll('.pdf-preview-page-container');
        pagePreviews.forEach((page, index) => {
            const pageTop = page.offsetTop;
            const pageBottom = pageTop + page.offsetHeight;
            if (viewportCenter >= pageTop && viewportCenter <= pageBottom) {
                visiblePageIndex = index;
                // –í—ã—á–∏—Å–ª—è–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                const positionInPage = viewportCenter - pageTop;
                relativePositionInPage = positionInPage / page.offsetHeight;
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                const pageNumberEl = page.querySelector('div[style*="position: absolute"]');
                if (pageNumberEl) {
                    targetPageId = pageNumberEl.textContent.trim();
                }
            }
        });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–∫–∂–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –æ—Ç –Ω–∞—á–∞–ª–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ –Ω–∞–π–¥–µ–º)
        const relativeScrollPosition = savedScrollHeight > 0 ? savedScrollTop / savedScrollHeight : 0;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ sessionStorage –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫)
        try {
            sessionStorage.setItem('pdfPreviewScroll', JSON.stringify({
                scrollTop: savedScrollTop,
                scrollLeft: savedScrollLeft,
                scrollHeight: savedScrollHeight,
                visiblePageIndex: visiblePageIndex,
                relativePosition: relativePositionInPage,
                relativeScroll: relativeScrollPosition,
                targetPageId: targetPageId
            }));
        } catch (e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ sessionStorage
        }
        
        const margins = {
            top: parseFloat(topMargin.input.value) || 8,
            bottom: parseFloat(bottomMargin.input.value) || 5,
            left: parseFloat(leftMargin.input.value) || 5,
            right: parseFloat(rightMargin.input.value) || 5
        };
        
        window.previewMargins = margins;
        
        // –í–†–ï–ú–ï–ù–ù–û –ë–õ–û–ö–ò–†–£–ï–ú –ü–†–û–ö–†–£–¢–ö–£ - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å
        previewArea.style.overflow = 'hidden';
        
        // –û—á–∏—â–∞–µ–º –æ–±–ª–∞—Å—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º replaceChildren –≤–º–µ—Å—Ç–æ innerHTML –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π
        const scrollBeforeClear = previewArea.scrollTop;
        const scrollLeftBeforeClear = previewArea.scrollLeft;
        
        if (previewArea.replaceChildren) {
            previewArea.replaceChildren(); // –ë–æ–ª–µ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π –º–µ—Ç–æ–¥
        } else {
            previewArea.innerHTML = ''; // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        }
        
        // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É (–µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä —Å–±—Ä–æ—Å–∏–ª)
        if (previewArea.scrollTop !== scrollBeforeClear) {
            previewArea.scrollTop = scrollBeforeClear;
            previewArea.scrollLeft = scrollLeftBeforeClear;
        }
        
        if (!window.previewExportWrapper) {
            previewArea.style.overflow = 'auto';
            return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã –≤ —Å–µ–∫—Ü–∏—è—Ö (–∫—Ä–æ–º–µ —Ç–∏—Ç—É–ª—å–Ω–æ–≥–æ –ª–∏—Å—Ç–∞)
        const sections = window.previewExportWrapper.querySelectorAll('.pdf-page-section');
        sections.forEach((section, index) => {
            // –¢–∏—Ç—É–ª—å–Ω—ã–π –ª–∏—Å—Ç (index === 0) –∏–º–µ–µ—Ç —Å–≤–æ–∏ –æ—Ç—Å—Ç—É–ø—ã, –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –∏—Ö
            if (index === 0) return;
            
            section.style.paddingTop = margins.top + 'mm';
            section.style.paddingBottom = margins.bottom + 'mm';
            section.style.paddingLeft = '0'; // –£–±–∏—Ä–∞–µ–º padding —Å–ª–µ–≤–∞ - —Ç–∞–±–ª–∏—Ü—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –æ—Ç –∫—Ä–∞—è
            section.style.paddingRight = margins.right + 'mm';
        });
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º DocumentFragment –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –≤—Å—Ç–∞–≤–∫–∏ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å—Ä–∞–∑—É
        const fragment = document.createDocumentFragment();
        sections.forEach((section, idx) => {
            const pagePreview = createPagePreview(section, idx + 1, margins);
            fragment.appendChild(pagePreview);
        });
        
        // –í—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –æ–¥–Ω–∏–º –¥–µ–π—Å—Ç–≤–∏–µ–º - —ç—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –∏ –Ω–∞–¥–µ–∂–Ω–µ–µ
        previewArea.appendChild(fragment);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
        previewArea.setAttribute('data-saved-scroll-top', savedScrollTop);
        previewArea.setAttribute('data-saved-scroll-left', savedScrollLeft);
        previewArea.setAttribute('data-visible-page-index', visiblePageIndex);
        previewArea.setAttribute('data-relative-position', relativePositionInPage);
        previewArea.setAttribute('data-relative-scroll', relativeScrollPosition);
        if (targetPageId) {
            previewArea.setAttribute('data-target-page-id', targetPageId);
        }
        
        // –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ü–†–û–ö–†–£–¢–ö–£ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π –º–µ—Ç–æ–¥ - –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ –∏ –∑–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é restoreScroll –î–û —Å–æ–∑–¥–∞–Ω–∏—è observer
        const restoreScroll = () => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–º–µ—é—Ç —Ä–∞–∑–º–µ—Ä—ã (–±—Ä–∞—É–∑–µ—Ä –∏—Ö –æ—Ç—Ä–∏—Å–æ–≤–∞–ª)
            const newPagePreviews = previewArea.querySelectorAll('.pdf-preview-page-container');
            const hasValidSizes = newPagePreviews.length > 0 && 
                                  Array.from(newPagePreviews).some(page => page.offsetHeight > 0);
            
            if (!hasValidSizes) {
                return false;
            }
            
            // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ sessionStorage (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ)
            let savedData = null;
            try {
                const stored = sessionStorage.getItem('pdfPreviewScroll');
                if (stored) {
                    savedData = JSON.parse(stored);
                }
            } catch (e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
            }
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ data-–∞—Ç—Ä–∏–±—É—Ç—ã
            const targetScrollTop = savedData ? savedData.scrollTop : (parseFloat(previewArea.getAttribute('data-saved-scroll-top')) || savedScrollTop);
            const targetScrollLeft = savedData ? savedData.scrollLeft : (parseFloat(previewArea.getAttribute('data-saved-scroll-left')) || savedScrollLeft);
            const targetVisiblePageIndex = savedData ? savedData.visiblePageIndex : (parseInt(previewArea.getAttribute('data-visible-page-index')) || visiblePageIndex);
            const targetRelativePosition = savedData ? savedData.relativePosition : (parseFloat(previewArea.getAttribute('data-relative-position')) || relativePositionInPage);
            const targetRelativeScroll = savedData ? savedData.relativeScroll : (parseFloat(previewArea.getAttribute('data-relative-scroll')) || relativeScrollPosition);
            const savedTargetPageId = savedData ? savedData.targetPageId : previewArea.getAttribute('data-target-page-id');
            
            // –ú–µ—Ç–æ–¥ 1: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –Ω–æ–º–µ—Ä—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Å–∞–º—ã–π —Ç–æ—á–Ω—ã–π)
            if (savedTargetPageId && newPagePreviews.length > 0) {
                for (let i = 0; i < newPagePreviews.length; i++) {
                    const page = newPagePreviews[i];
                    const pageNumberEl = page.querySelector('div[style*="position: absolute"]');
                    if (pageNumberEl && pageNumberEl.textContent.trim() === savedTargetPageId) {
                        const targetHeight = page.offsetHeight;
                        if (targetHeight > 0) {
                            const targetTop = page.offsetTop;
                            const targetPosition = targetTop + (targetHeight * targetRelativePosition);
                            const newScrollTop = Math.max(0, targetPosition - previewArea.clientHeight / 2);
                            previewArea.scrollTop = newScrollTop;
                            previewArea.scrollLeft = targetScrollLeft;
                            return true;
                        }
                    }
                }
            }
            
            // –ú–µ—Ç–æ–¥ 2: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –≤–∏–¥–∏–º–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É (–∏–Ω–¥–µ–∫—Å —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
            if (targetVisiblePageIndex >= 0 && targetVisiblePageIndex < newPagePreviews.length) {
                const targetPage = newPagePreviews[targetVisiblePageIndex];
                const targetHeight = targetPage.offsetHeight;
                
                if (targetHeight > 0) {
                    const targetTop = targetPage.offsetTop;
                    const targetPosition = targetTop + (targetHeight * targetRelativePosition);
                    const newScrollTop = Math.max(0, targetPosition - previewArea.clientHeight / 2);
                    previewArea.scrollTop = newScrollTop;
                    previewArea.scrollLeft = targetScrollLeft;
                    return true;
                }
            }
            
            // –ú–µ—Ç–æ–¥ 3: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –æ—Ç –Ω–∞—á–∞–ª–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π)
            const newScrollHeight = previewArea.scrollHeight;
            if (newScrollHeight > 0 && newScrollHeight > previewArea.clientHeight) {
                const newScrollTop = targetRelativeScroll * newScrollHeight;
                const maxScrollTop = Math.max(0, newScrollHeight - previewArea.clientHeight);
                const restoredScrollTop = Math.min(newScrollTop, maxScrollTop);
                previewArea.scrollTop = restoredScrollTop;
                previewArea.scrollLeft = targetScrollLeft;
                return true;
            }
            
            // –ú–µ—Ç–æ–¥ 4: –ü—Ä–æ—Å—Ç–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
            const maxScrollTop = Math.max(0, previewArea.scrollHeight - previewArea.clientHeight);
            if (maxScrollTop > 0) {
                const restoredScrollTop = Math.min(targetScrollTop, maxScrollTop);
                previewArea.scrollTop = restoredScrollTop;
                previewArea.scrollLeft = targetScrollLeft;
                return true;
            }
            
            return false;
        };
        
        // –°–æ–∑–¥–∞–µ–º MutationObserver –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        let observer = null;
        if (window.MutationObserver) {
            observer = new MutationObserver(() => {
                if (isUpdatingPreview) {
                    const currentScroll = previewArea.scrollTop;
                    const targetScroll = parseFloat(previewArea.getAttribute('data-saved-scroll-top')) || savedScrollTop;
                    // –ï—Å–ª–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —Å–±—Ä–æ—Å–∏–ª–∞—Å—å - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
                    if (currentScroll < 50 && targetScroll > 50) {
                        const newPagePreviews = previewArea.querySelectorAll('.pdf-preview-page-container');
                        if (newPagePreviews.length > 0) {
                            restoreScroll();
                        }
                    }
                }
            });
            
            // –ù–∞—á–∏–Ω–∞–µ–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ previewArea
            observer.observe(previewArea, {
                childList: true,
                subtree: true,
                attributes: false
            });
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        previewArea.style.overflow = 'auto';
        
        // –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ï –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–æ–¥–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
        let restoreSuccess = false;
        let restoreAttempts = 0;
        const maxAttempts = 30; // –£–≤–µ–ª–∏—á–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
        
        const aggressiveRestore = () => {
            if (restoreSuccess || restoreAttempts >= maxAttempts) {
                if (restoreAttempts >= maxAttempts) {
                    // –£–¥–∞–ª—è–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                    previewArea.removeAttribute('data-saved-scroll-top');
                    previewArea.removeAttribute('data-saved-scroll-left');
                    previewArea.removeAttribute('data-visible-page-index');
                    previewArea.removeAttribute('data-relative-position');
                    previewArea.removeAttribute('data-relative-scroll');
                    previewArea.removeAttribute('data-target-page-id');
                    try {
                        sessionStorage.removeItem('pdfPreviewScroll');
                    } catch (e) {}
                    isUpdatingPreview = false;
                    savedScrollPosition = null;
                }
                return;
            }
            
            const currentScrollTop = previewArea.scrollTop;
            const targetScrollTop = parseFloat(previewArea.getAttribute('data-saved-scroll-top')) || savedScrollTop;
            
            // –ï—Å–ª–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤ –Ω–∞—á–∞–ª–µ, –Ω–æ –º—ã –±—ã–ª–∏ –Ω–µ –≤ –Ω–∞—á–∞–ª–µ - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
            if (currentScrollTop < 50 && targetScrollTop > 50) {
                if (restoreScroll()) {
                    restoreSuccess = true;
                }
            } else if (Math.abs(currentScrollTop - targetScrollTop) > 10) {
                // –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è —Å–∏–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è - –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
                if (restoreScroll()) {
                    restoreSuccess = true;
                }
            } else {
                // –ü–æ–∑–∏—Ü–∏—è –±–ª–∏–∑–∫–∞ –∫ –Ω—É–∂–Ω–æ–π - —Å—á–∏—Ç–∞–µ–º —É—Å–ø–µ—à–Ω—ã–º
                restoreSuccess = true;
            }
            
            restoreAttempts++;
        };
        
        // –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ï –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ - –Ω–µ –∂–¥–µ–º —Ç–∞–π–º–∞—É—Ç—ã
        restoreScroll();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ setInterval (–±–æ–ª–µ–µ —á–∞—Å—Ç–æ–µ)
        const restoreInterval = setInterval(() => {
            aggressiveRestore();
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ø—ã—Ç–æ–∫
            if (restoreSuccess || restoreAttempts >= maxAttempts) {
                clearInterval(restoreInterval);
            }
        }, 20); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 20ms (–±—ã—Å—Ç—Ä–µ–µ)
        
        // –¢–∞–∫–∂–µ –ø—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞–¥—Ä–æ–≤ –∞–Ω–∏–º–∞—Ü–∏–∏
        requestAnimationFrame(() => {
            if (!restoreSuccess) restoreScroll();
            requestAnimationFrame(() => {
                if (!restoreSuccess) restoreScroll();
                setTimeout(() => {
                    if (!restoreSuccess) restoreScroll();
                }, 5);
            });
        });
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è)
        setTimeout(() => {
            clearInterval(restoreInterval);
            if (!restoreSuccess) {
                aggressiveRestore(); // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            }
            
            // –û—Ç–∫–ª—é—á–∞–µ–º MutationObserver
            if (observer) {
                observer.disconnect();
                observer = null;
            }
        }, 1500);
    };
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É –∏–∑ exportPDF)
    // –í—Ä–µ–º–µ–Ω–Ω–æ —Å–æ–∑–¥–∞–µ–º exportWrapper –≤—Ä—É—á–Ω—É—é, –∫–æ–ø–∏—Ä—É—è –ª–æ–≥–∏–∫—É –∏–∑ exportPDF
    // –ù–æ –ø—Ä–æ—â–µ –≤—ã–∑–≤–∞—Ç—å prepareExportContent, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å, –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞–ø—Ä—è–º—É—é
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
    setTimeout(async () => {
        // –í—ã–∑—ã–≤–∞–µ–º exportPDF, –Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º exportWrapper –¥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞
        // –ò–ª–∏ —Å–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –≤—Ä—É—á–Ω—É—é
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —Å–æ–∑–¥–∞–¥–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞–ø—Ä—è–º—É—é, –∏—Å–ø–æ–ª—å–∑—É—è –ª–æ–≥–∏–∫—É –∏–∑ exportPDF
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ: –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º prepareExportContent, –µ—Å–ª–∏ –æ–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç wrapper
        // –ò–ª–∏ —Å–æ–∑–¥–∞–µ–º wrapper –≤—Ä—É—á–Ω—É—é
        const wrapper = await createPreviewContent(scaleMode, includeDiagram);
        
        if (!wrapper) {
            document.body.removeChild(loadingIndicator);
            alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
            return;
        }
        
        window.previewExportWrapper = wrapper;
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        let isUpdatingPreview = false;
        let savedScrollPosition = null;
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        const scrollProtection = () => {
            if (isUpdatingPreview && savedScrollPosition !== null) {
                const currentScroll = previewArea.scrollTop;
                // –ï—Å–ª–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —Å–±—Ä–æ—Å–∏–ª–∞—Å—å –≤ –Ω–∞—á–∞–ª–æ –≤–æ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è - –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
                if (currentScroll < 50 && savedScrollPosition.scrollTop > 50) {
                    previewArea.scrollTop = savedScrollPosition.scrollTop;
                    previewArea.scrollLeft = savedScrollPosition.scrollLeft;
                }
            }
        };
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        previewArea.addEventListener('scroll', scrollProtection, { passive: true });
        
        // Debounce —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —á–∞—Å—Ç—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        let updatePreviewTimeout = null;
        const debouncedUpdatePreview = () => {
            if (updatePreviewTimeout) {
                clearTimeout(updatePreviewTimeout);
            }
            updatePreviewTimeout = setTimeout(() => {
                updatePreview();
            }, 150); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
        };
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ—Ç—Å—Ç—É–ø–æ–≤ —Å debounce
        [topMargin.input, bottomMargin.input, leftMargin.input, rightMargin.input].forEach(input => {
            input.addEventListener('input', debouncedUpdatePreview);
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ input
            input.addEventListener('focus', (e) => {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø–µ—Ä–µ–¥ —Ñ–æ–∫—É—Å–æ–º
                const savedScrollTop = previewArea.scrollTop;
                const savedScrollLeft = previewArea.scrollLeft;
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                setTimeout(() => {
                    if (previewArea.scrollTop !== savedScrollTop) {
                        previewArea.scrollTop = savedScrollTop;
                    }
                    if (previewArea.scrollLeft !== savedScrollLeft) {
                        previewArea.scrollLeft = savedScrollLeft;
                    }
                }, 0);
            });
        });
        
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        const images = wrapper.querySelectorAll('img');
        const imagePromises = Array.from(images).map(img => {
            if (img.complete) return Promise.resolve();
            return new Promise((resolve) => {
                img.onload = resolve;
                img.onerror = resolve;
                setTimeout(resolve, 2000);
            });
        });
        
        Promise.all(imagePromises).then(() => {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
            updatePreview();
            
            document.body.removeChild(loadingIndicator);
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—á–∞—Ç–∏
            printBtn.onclick = () => {
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—á–∞—Ç–∏ —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º –∏–∑ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏');
                    return;
                }
                
                // –ö–ª–æ–Ω–∏—Ä—É–µ–º wrapper –¥–ª—è –ø–µ—á–∞—Ç–∏
                const printContent = wrapper.cloneNode(true);
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏
                const printStyles = `
                    <style>
                        @page {
                            size: A3 landscape;
                            margin: 0;
                        }
                        * {
                            box-sizing: border-box;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: Arial, sans-serif;
                        }
                        .pdf-page-section {
                            width: 100% !important;
                            page-break-before: always;
                            page-break-inside: avoid;
                            break-before: page;
                            break-inside: avoid;
                            margin: 0 !important;
                            padding: 0 !important;
                            position: relative !important;
                        }
                        .pdf-page-section:first-child {
                            page-break-before: auto;
                            break-before: auto;
                        }
                        /* –õ–æ–≥–æ—Ç–∏–ø –Ω–∞ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ - –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ */
                        .pdf-page-logo {
                            position: absolute !important;
                            top: 12px !important;
                            right: 12px !important;
                            width: 80px !important;
                            height: 80px !important;
                            z-index: 1000 !important;
                            pointer-events: none !important;
                            opacity: 0.28 !important;
                        }
                        .pdf-page-logo img {
                            width: 100% !important;
                            height: 100% !important;
                            object-fit: contain !important;
                            display: block !important;
                        }
                        table {
                            width: 100% !important;
                            border-collapse: collapse;
                        }
                        @media print {
                            .pdf-page-section {
                                page-break-before: always;
                                page-break-inside: avoid;
                                position: relative !important;
                            }
                            .pdf-page-section:first-child {
                                page-break-before: auto;
                            }
                            .pdf-page-logo {
                                position: absolute !important;
                                top: 12px !important;
                                right: 12px !important;
                                width: 80px !important;
                                height: 80px !important;
                                z-index: 1000 !important;
                                pointer-events: none !important;
                                opacity: 0.28 !important;
                            }
                        }
                    </style>
                `;
                
                printWindow.document.write(printStyles);
                printWindow.document.body.appendChild(printContent);
                printWindow.document.close();
                
                // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                setTimeout(() => {
                    printWindow.print();
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ—Å–ª–µ –ø–µ—á–∞—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                    // printWindow.close();
                }, 500);
            };
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞
            exportBtn.onclick = async () => {
                const margins = {
                    top: parseFloat(topMargin.input.value) || 8,
                    bottom: parseFloat(bottomMargin.input.value) || 5,
                    left: parseFloat(leftMargin.input.value) || 5,
                    right: parseFloat(rightMargin.input.value) || 5
                };
                
                // –°—Ä–∞–∑—É —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ html2pdf –±–µ–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–µ—á–∞—Ç–∏
                closeModal();
                await exportPDFWithMargins(scaleMode, includeDiagram, margins, wrapper);
            };
        });
    }, 100);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞
    modal.onclick = (e) => {
        if (e.target === modal) closeModal();
    };
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
    const handleEscape = (e) => {
        if (e.key === 'Escape' && modal.parentNode) {
            closeModal();
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–≥–∏–∫—É –∏–∑ exportPDF, –Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç wrapper –±–µ–∑ —ç–∫—Å–ø–æ—Ä—Ç–∞
async function createPreviewContent(scaleMode, includeDiagram) {
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç, –≤—ã–∑—ã–≤–∞—è exportPDF, –Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º wrapper –¥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞
    return new Promise((resolve) => {
        let capturedWrapper = null;
        let checkCount = 0;
        const maxChecks = 100; // –ú–∞–∫—Å–∏–º—É–º 1 —Å–µ–∫—É–Ω–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
        
        const checkInterval = setInterval(() => {
            checkCount++;
            const wrapper = document.querySelector('.pdf-export-wrapper') || 
                          document.querySelector('div[style*="420mm"]');
            if (wrapper && !capturedWrapper) {
                capturedWrapper = wrapper;
                clearInterval(checkInterval);
                // –í—Ä–µ–º–µ–Ω–Ω–æ —É–¥–∞–ª—è–µ–º –∏–∑ DOM
                if (wrapper.parentNode) {
                    wrapper.parentNode.removeChild(wrapper);
                }
                resolve(wrapper);
            } else if (checkCount >= maxChecks) {
                clearInterval(checkInterval);
                resolve(null);
            }
        }, 10);
        
        // –í—ã–∑—ã–≤–∞–µ–º exportPDF - –æ–Ω–∞ —Å–æ–∑–¥–∞—Å—Ç wrapper –∏ –¥–æ–±–∞–≤–∏—Ç –≤ DOM
        // –ù–æ –æ–Ω–∞ —Ç–∞–∫–∂–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç, –ø–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å wrapper
        exportPDF(scaleMode, includeDiagram, null).catch(() => {
            clearInterval(checkInterval);
            if (!capturedWrapper) {
                resolve(null);
            }
        });
        
        // –¢–∞–π–º–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ exportPDF –Ω–µ —Å–æ–∑–¥–∞—Å—Ç wrapper
        setTimeout(() => {
            clearInterval(checkInterval);
            if (!capturedWrapper) {
                resolve(null);
            }
        }, 3000);
    });
}

// –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ PDF —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –æ—Ç—Å—Ç—É–ø–æ–≤
async function exportPDFWithMargins(scaleMode, includeDiagram, margins, exportWrapper) {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É html2pdf.js
    try {
        await loadHtml2Pdf();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ html2pdf.js:', error);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF.');
        return;
    }
    
    if (typeof html2pdf === 'undefined') {
        alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ html2pdf –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞.');
        return;
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Ç—Å—Ç—É–ø—ã –∫ —Å–µ–∫—Ü–∏—è–º
    // –í–ê–ñ–ù–û: –¢–∏—Ç—É–ª—å–Ω—ã–π –ª–∏—Å—Ç (–ø–µ—Ä–≤–∞—è —Å–µ–∫—Ü–∏—è) –∏–º–µ–µ—Ç —Å–≤–æ–∏ –æ—Ç—Å—Ç—É–ø—ã –∏ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∞—Ç—å –æ—Ç—Å—Ç—É–ø—ã –∏–∑ margins
    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ —É–∂–µ –∏–º–µ—é—Ç –æ—Ç—Å—Ç—É–ø—ã 50px —Å–ª–µ–≤–∞ –∏ —Å–ø—Ä–∞–≤–∞, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≤ createPageSection
    const sections = exportWrapper.querySelectorAll('.pdf-page-section');
    sections.forEach((section, index) => {
        // –¢–∏—Ç—É–ª—å–Ω—ã–π –ª–∏—Å—Ç (index === 0) –∏–º–µ–µ—Ç —Å–≤–æ–∏ –æ—Ç—Å—Ç—É–ø—ã (60px 40px), –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –∏—Ö
        if (index === 0) {
            return;
        }
        
        // –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–µ–∫—Ü–∏–π –æ—Ç—Å—Ç—É–ø—ã —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ createPageSection (50px —Å–ª–µ–≤–∞ –∏ —Å–ø—Ä–∞–≤–∞, 20px —Å–≤–µ—Ä—Ö—É –∏ —Å–Ω–∏–∑—É)
        // –ù–µ –ø—Ä–∏–º–µ–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –∏–∑ margins, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥–≤–æ–π–Ω—ã—Ö –æ—Ç—Å—Ç—É–ø–æ–≤
        section.style.boxSizing = 'border-box';
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingIndicator = document.createElement('div');
    loadingIndicator.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF...';
    loadingIndicator.style.position = 'fixed';
    loadingIndicator.style.top = '50%';
    loadingIndicator.style.left = '50%';
    loadingIndicator.style.transform = 'translate(-50%, -50%)';
    loadingIndicator.style.padding = '20px 40px';
    loadingIndicator.style.background = 'rgba(0, 0, 0, 0.8)';
    loadingIndicator.style.color = '#fff';
    loadingIndicator.style.borderRadius = '8px';
    loadingIndicator.style.zIndex = '999999';
    loadingIndicator.style.fontSize = '16px';
    loadingIndicator.style.fontWeight = '600';
    document.body.appendChild(loadingIndicator);
    
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏
    setTimeout(() => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏ –ø–µ—Ä–µ–¥ —ç–∫—Å–ø–æ—Ä—Ç–æ–º
        const sections = exportWrapper.querySelectorAll('.pdf-page-section');
        console.log(`–≠–∫—Å–ø–æ—Ä—Ç PDF: –Ω–∞–π–¥–µ–Ω–æ ${sections.length} —Å–µ–∫—Ü–∏–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞`);
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ —Å–µ–∫—Ü–∏–∏ –≤–∏–¥–Ω—ã –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω—ã
        sections.forEach((section, idx) => {
            section.style.display = 'block';
            section.style.visibility = 'visible';
            section.style.opacity = '1';
            section.style.position = 'relative';
            section.style.pageBreakBefore = idx === 0 ? 'auto' : 'always';
            section.style.pageBreakAfter = 'auto';
            section.style.pageBreakInside = 'avoid';
            section.style.breakBefore = idx === 0 ? 'auto' : 'page';
            section.style.breakAfter = 'auto';
            section.style.breakInside = 'avoid';
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–µ–∫—Ü–∏—è –∏–º–µ–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É
            if (!section.offsetHeight && !section.scrollHeight) {
                section.style.minHeight = '1123px'; // A3 –≤—ã—Å–æ—Ç–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
            }
        });
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ wrapper –≤ DOM –∏ –≤–∏–¥–∏–º
        if (!exportWrapper.parentNode) {
            document.body.appendChild(exportWrapper);
        }
        exportWrapper.style.display = 'block';
        exportWrapper.style.visibility = 'visible';
        exportWrapper.style.opacity = '1';
        exportWrapper.style.position = 'absolute';
        exportWrapper.style.left = '-9999px'; // –í—ã–Ω–æ—Å–∏–º –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –≤–∏–¥–∏–º–æ—Å—Ç–∏, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –≤ DOM
        exportWrapper.style.top = '0';
        
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É wrapper, —á—Ç–æ–±—ã –≤—Å–µ —Å–µ–∫—Ü–∏–∏ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
        const totalHeight = Array.from(sections).reduce((sum, section) => {
            const sectionHeight = section.offsetHeight || section.scrollHeight || 1123;
            return sum + sectionHeight;
        }, 0);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—É—é –≤—ã—Å–æ—Ç—É –¥–ª—è –≤—Å–µ—Ö —Å–µ–∫—Ü–∏–π
        exportWrapper.style.height = Math.max(totalHeight, sections.length * 1123) + 'px';
        exportWrapper.style.width = '1587px'; // A3 —à–∏—Ä–∏–Ω–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
        console.log(`–≠–∫—Å–ø–æ—Ä—Ç PDF: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤—ã—Å–æ—Ç–∞ wrapper ${exportWrapper.style.height} –¥–ª—è ${sections.length} —Å–µ–∫—Ü–∏–π`);
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º wrapper, —á—Ç–æ–±—ã –≤—Å–µ —Å–µ–∫—Ü–∏–∏ –±—ã–ª–∏ "–≤–∏–¥–∏–º—ã" –¥–ª—è html2canvas
        // –≠—Ç–æ –≤–∞–∂–Ω–æ, —Ç–∞–∫ –∫–∞–∫ html2canvas –º–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω–µ viewport
        const originalScrollTop = exportWrapper.scrollTop;
        const originalScrollLeft = exportWrapper.scrollLeft;
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ –≤—Å–µ —Å–µ–∫—Ü–∏–∏, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω—ã
        sections.forEach((section, idx) => {
            section.scrollIntoView({ behavior: 'instant', block: 'start' });
        });
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –≤ –Ω–∞—á–∞–ª–æ
        exportWrapper.scrollTop = 0;
        exportWrapper.scrollLeft = 0;
        
        const actualWidth = Math.max(exportWrapper.scrollWidth || 0, exportWrapper.offsetWidth || 0, 1587);
        const actualHeight = Math.max(exportWrapper.scrollHeight || 0, exportWrapper.offsetHeight || 0, totalHeight || sections.length * 1123);
        
        // –í–ê–ñ–ù–û: –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º margin –≤ html2pdf, —Ç–∞–∫ –∫–∞–∫ –æ—Ç—Å—Ç—É–ø—ã —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ —Å–µ–∫—Ü–∏—è–º —á–µ—Ä–µ–∑ padding
        // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ margin –≤ html2pdf —Å–æ–∑–¥–∞–µ—Ç –¥–≤–æ–π–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –∏ —Å–º–µ—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        const opt = {
            margin: [0, 0, 0, 0], // [top, right, bottom, left] - –ù–£–õ–ï–í–´–ï –æ—Ç—Å—Ç—É–ø—ã, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ —É–∂–µ –≤ padding —Å–µ–∫—Ü–∏–π
            filename: generateExportFileName('pdf'),
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: {
                scale: 2,
                useCORS: true,
                logging: true, // –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                windowWidth: actualWidth,
                windowHeight: actualHeight,
                allowTaint: true,
                backgroundColor: '#ffffff',
                scrollX: 0,
                scrollY: 0,
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º onclone callback –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≤—Å–µ—Ö —Å–µ–∫—Ü–∏–π
                onclone: (clonedDoc) => {
                    const clonedSections = clonedDoc.querySelectorAll('.pdf-page-section');
                    console.log(`–í –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ –Ω–∞–π–¥–µ–Ω–æ ${clonedSections.length} —Å–µ–∫—Ü–∏–π (–æ–∂–∏–¥–∞–ª–æ—Å—å ${sections.length})`);
                    clonedSections.forEach((section, idx) => {
                        if (section.style.display === 'none' || section.style.visibility === 'hidden') {
                            console.warn(`–°–µ–∫—Ü–∏—è ${idx} —Å–∫—Ä—ã—Ç–∞ –≤ –∫–ª–æ–Ω–µ, –¥–µ–ª–∞–µ–º –≤–∏–¥–∏–º–æ–π`);
                            section.style.display = 'block';
                            section.style.visibility = 'visible';
                        }
                        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ —Å–µ–∫—Ü–∏–∏ –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ —Ä–∞–∑—Ä—ã–≤–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
                        section.style.pageBreakBefore = idx === 0 ? 'auto' : 'always';
                        section.style.pageBreakAfter = 'auto';
                        section.style.pageBreakInside = 'avoid';
                        section.style.breakBefore = idx === 0 ? 'auto' : 'page';
                        section.style.breakAfter = 'auto';
                        section.style.breakInside = 'avoid';
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Ç—Å—Ç—É–ø—ã –∫ —Å–µ–∫—Ü–∏—è–º (–∫—Ä–æ–º–µ —Ç–∏—Ç—É–ª—å–Ω–æ–≥–æ –ª–∏—Å—Ç–∞)
                        if (idx > 0) {
                            section.style.paddingLeft = '50px';
                            section.style.paddingRight = '50px';
                            section.style.paddingTop = '20px';
                            section.style.paddingBottom = '20px';
                        }
                        section.style.boxSizing = 'border-box';
                        section.style.width = '100%';
                        
                        // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑—Ä—ã–≤–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –∫ —Ç–∞–±–ª–∏—Ü–∞–º –∏ —Å—Ç—Ä–æ–∫–∞–º –≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ü–∏–π
                        const ganttTables = section.querySelectorAll('table.gantt-diagram-table');
                        ganttTables.forEach(table => {
                            // –¢–∞–±–ª–∏—Ü—ã –¥–∏–∞–≥—Ä–∞–º–º—ã –Ω–µ –¥–æ–ª–∂–Ω—ã —Ä–∞–∑—Ä—ã–≤–∞—Ç—å—Å—è (–æ–Ω–∏ —É–∂–µ —Ä–∞–∑–±–∏—Ç—ã –Ω–∞ chunks)
                            table.style.pageBreakInside = 'avoid';
                            table.style.breakInside = 'avoid';
                            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É
                            table.style.width = '100%';
                            table.style.maxWidth = '100%';
                            table.style.marginLeft = '0';
                            table.style.marginRight = '0';
                            
                            // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ –∫ —Å—Ç—Ä–æ–∫–∞–º —Ç–∞–±–ª–∏—Ü—ã
                            const rows = table.querySelectorAll('tr');
                            rows.forEach(tr => {
                                tr.style.pageBreakInside = 'avoid';
                                tr.style.breakInside = 'avoid';
                            });
                        });
                        
                        // –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ù–ï –¥–æ–ª–∂–Ω–∞ —Ä–∞–∑—Ä—ã–≤–∞—Ç—å—Å—è (—É–∂–µ —Ä–∞–∑–±–∏—Ç–∞ –Ω–∞ chunks)
                        const detailTables = section.querySelectorAll('table.detail-tasks-table');
                        detailTables.forEach(table => {
                            table.style.pageBreakInside = 'avoid';
                            table.style.breakInside = 'avoid';
                            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É
                            table.style.width = '100%';
                            table.style.maxWidth = '100%';
                            
                            // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ –∫ —Å—Ç—Ä–æ–∫–∞–º —Ç–∞–±–ª–∏—Ü—ã
                            const rows = table.querySelectorAll('tr');
                            rows.forEach(tr => {
                                tr.style.pageBreakInside = 'avoid';
                                tr.style.breakInside = 'avoid';
                            });
                        });
                    });
                    console.log(`–í—Å–µ ${clonedSections.length} —Å–µ–∫—Ü–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤ –∫–ª–æ–Ω–µ`);
                }
            },
            jsPDF: { 
                orientation: 'landscape', 
                unit: 'mm', 
                format: 'a3',
                compress: false // –û—Ç–∫–ª—é—á–∞–µ–º —Å–∂–∞—Ç–∏–µ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
            },
            pagebreak: { 
                mode: ['css', 'legacy'], // –£–±–∏—Ä–∞–µ–º 'avoid-all', —Ç–∞–∫ –∫–∞–∫ –æ–Ω –º–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —Å–µ–∫—Ü–∏–∏
                before: '.pdf-page-section',
                after: ['.pdf-page-section'],
                avoid: ['table', 'tr', '.pdf-page-section table', '.pdf-page-section tr'] // –ò–∑–±–µ–≥–∞–µ–º —Ä–∞–∑—Ä—ã–≤–∞ —Ç–∞–±–ª–∏—Ü –∏ —Å—Ç—Ä–æ–∫ –≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ü–∏–π
            }
        };
        
        html2pdf()
            .set(opt)
            .from(exportWrapper)
            .outputPdf('blob')
            .then((pdfBlob) => {
                const url = URL.createObjectURL(pdfBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = opt.filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                
                if (exportWrapper.parentNode) {
                    document.body.removeChild(exportWrapper);
                }
                loadingIndicator.textContent = 'PDF –≥–æ—Ç–æ–≤!';
                setTimeout(() => {
                    if (loadingIndicator.parentNode) {
                        document.body.removeChild(loadingIndicator);
                    }
                }, 3000);
            })
            .catch((err) => {
                console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF:', err);
                if (exportWrapper.parentNode) {
                    document.body.removeChild(exportWrapper);
                }
                if (loadingIndicator.parentNode) {
                    document.body.removeChild(loadingIndicator);
                }
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF: ' + (err.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            });
    }, 500);
}

// –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF: –¥–µ—Ç–∞–ª—å–Ω—ã–π –ì–∞–Ω—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –º–∞—Å—à—Ç–∞–±—É + —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
async function exportPDF(scaleMode = 'day', includeDiagram = true, margins = null) {
    if (!tasks || !tasks.length) {
        console.error('–≠–∫—Å–ø–æ—Ä—Ç PDF: –Ω–µ—Ç –∑–∞–¥–∞—á –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        alert('–û—à–∏–±–∫–∞: –Ω–µ—Ç –∑–∞–¥–∞—á –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF');
        return;
    }
    
    console.log('–ù–∞—á–∞–ª–æ —ç–∫—Å–ø–æ—Ä—Ç–∞ PDF:', {
        tasksCount: tasks.length,
        scaleMode,
        includeDiagram,
        margins
    });
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É html2pdf.js –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
    try {
        await loadHtml2Pdf();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ html2pdf.js:', error);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        return;
    }
    
    if (typeof html2pdf === 'undefined') {
        alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ html2pdf –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        return;
    }

    const logoEl = document.getElementById('companyLogo');
    const nameDisplay = document.getElementById('companyNameDisplay');

    // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
    // A3 landscape: 420mm —à–∏—Ä–∏–Ω–∞ √ó 297mm –≤—ã—Å–æ—Ç–∞ = 1587px √ó 1123px (–ø—Ä–∏ 96 DPI, 3.779527559px/mm)
    const mmToPx = 3.779527559;
    const a3WidthPx = 420 * mmToPx; // ‚âà 1587px
    const a3HeightPx = 297 * mmToPx; // ‚âà 1123px
    
    const exportWrapper = document.createElement('div');
    exportWrapper.style.width = a3WidthPx + 'px'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∏–∫—Å–µ–ª–∏ –≤–º–µ—Å—Ç–æ mm –¥–ª—è html2canvas
    exportWrapper.style.maxWidth = a3WidthPx + 'px';
    exportWrapper.style.margin = '0';
    exportWrapper.style.background = '#ffffff';
    exportWrapper.style.fontFamily = window.getComputedStyle(document.body).fontFamily || 'sans-serif';
    exportWrapper.style.fontSize = '10px';
    exportWrapper.style.color = '#000';
    exportWrapper.style.visibility = 'visible';
    exportWrapper.style.display = 'block';
    exportWrapper.style.opacity = '1';
    exportWrapper.style.boxSizing = 'border-box'; // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–æ–≤ —Å —É—á–µ—Ç–æ–º padding
    exportWrapper.style.overflow = 'visible'; // –ü–æ–∑–≤–æ–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç—É –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞

    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —à–∞–ø–∫–∏ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º
    const createHeader = (isFirstPage = false) => {
        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.alignItems = 'center';
        header.style.gap = '16px';
        header.style.marginBottom = '12px';

        if (logoEl) {
            const logoClone = logoEl.cloneNode(true);
            logoClone.style.width = '40px';
            logoClone.style.height = '40px';
            logoClone.style.borderRadius = '8px';
            logoClone.style.border = '1px solid #e0e0e0';
            logoClone.style.objectFit = 'contain';
            logoClone.style.background = '#fafafa';
            logoClone.style.padding = '4px';
            header.appendChild(logoClone);
        }

        const nameBlock = document.createElement('div');
        const title = document.createElement('div');
        title.textContent = `–ì—Ä–∞—Ñ–∏–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏ –æ–±—É—á–µ–Ω–∏—è`;
        title.style.fontSize = '14px';
        title.style.fontWeight = '600';

        const company = document.createElement('div');
        const currentNameText =
            nameDisplay && nameDisplay.classList.contains('has-value')
                ? (nameDisplay.innerText || nameDisplay.textContent)
                : '';
        company.innerText = currentNameText || '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏';
        company.style.marginTop = '2px';
        company.style.fontSize = '12px';
        company.style.fontWeight = '600';

        nameBlock.appendChild(title);
        nameBlock.appendChild(company);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        if (isFirstPage) {
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const objectNameDisplay = document.getElementById('companyObjectNameDisplay');
            let objectName = '';
            
            if (objectNameDisplay && objectNameDisplay.style.display !== 'none') {
                objectName = (objectNameDisplay.innerText || objectNameDisplay.textContent || '').trim();
            }
            
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ —ç–ª–µ–º–µ–Ω—Ç–µ, –ø—Ä–æ–±—É–µ–º –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
            if (!objectName && typeof companyObjectName !== 'undefined' && companyObjectName) {
                objectName = String(companyObjectName).trim();
            }
            
            if (objectName && objectName.length > 0) {
                const object = document.createElement('div');
                object.innerText = objectName;
                object.style.marginTop = '4px';
                object.style.fontSize = '11px';
                object.style.fontWeight = '500';
                object.style.color = '#2196f3';
                nameBlock.appendChild(object);
            }
        }
        
        header.appendChild(nameBlock);
        
        return header;
    };

    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ–∫—Ü–∏–∏ —Å —à–∞–ø–∫–æ–π –∏ —Ä–∞–∑—Ä—ã–≤–æ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    const createPageLogo = () => {
        const logoContainer = document.createElement('div');
        logoContainer.className = 'pdf-page-logo';
        logoContainer.style.position = 'absolute';
        logoContainer.style.top = '12px';
        logoContainer.style.right = '12px';
        logoContainer.style.width = '80px';
        logoContainer.style.height = '80px';
        logoContainer.style.zIndex = 1000;
        logoContainer.style.pointerEvents = 'none';
        logoContainer.style.opacity = '0.28';
        
        const logoImg = document.createElement('img');
        logoImg.src = 'logo.png';
        logoImg.alt = '–õ–æ–≥–æ—Ç–∏–ø';
        logoImg.style.width = '100%';
        logoImg.style.height = '100%';
        logoImg.style.objectFit = 'contain';
        logoImg.style.display = 'block';
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (fallback –Ω–∞ favicon.png)
        logoImg.onerror = function() {
            this.src = 'favicon.png';
        };
        
        logoContainer.appendChild(logoImg);
        return logoContainer;
    };

    const createPageSection = (isFirst = false) => {
        const section = document.createElement('div');
        section.className = 'pdf-page-section';
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ—á–Ω—É—é —à–∏—Ä–∏–Ω—É A3 landscape
        section.style.width = a3WidthPx + 'px';
        section.style.maxWidth = a3WidthPx + 'px';
        section.style.minHeight = a3HeightPx + 'px';
        section.style.height = 'auto';
        
        section.style.position = 'relative';
        section.style.background = '#ffffff';
        section.style.boxSizing = 'border-box';
        section.style.margin = '0';
        section.style.overflow = 'visible';
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã —Å–ª–µ–≤–∞ –∏ —Å–ø—Ä–∞–≤–∞ –ø–æ 50 –ø–∏–∫—Å–µ–ª–µ–π
        section.style.paddingLeft = '50px';
        section.style.paddingRight = '50px';
        section.style.paddingTop = '30px'; // –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –¥–ª—è —Ç–∞–±–ª–∏—Ü
        section.style.paddingBottom = '30px';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–æ—Ç–∏–ø –≤ –ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª
        section.appendChild(createPageLogo());
        
        // –î–æ–±–∞–≤–ª—è–µ–º —à–∞–ø–∫—É –≤ –∫–∞–∂–¥—É—é —Å–µ–∫—Ü–∏—é (–ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ)
        section.appendChild(createHeader(isFirst));
        
        return section;
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —è—á–µ–π–∫–∏ —Å –≥—Ä–∞–Ω–∏—Ü–µ–π
    const addCellBorder = (td) => {
        td.style.border = '1px solid #cccccc';
        td.style.padding = '2px 3px';
    };

    // –õ–æ–∫–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã –≤ –∫–ª—é—á YYYY-MM-DD
    const formatDateKeyLocal = (date) => {
        if (typeof date === 'string') {
            return date;
        }
        if (!(date instanceof Date)) {
            if (typeof date === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(date)) {
                return date;
            }
            const parsedDate = new Date(date);
            if (isNaN(parsedDate.getTime())) {
                return '';
            }
            date = parsedDate;
        }
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫ –∑–∞–¥–∞—á
    const calculateTaskMetrics = () => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        let completed = 0;
        let overdue = 0;
        let pending = 0;
        let projectStartDate = null;
        let projectEndDate = null;
        
        tasks.forEach(task => {
            // –§–∏–∫—Å–∏—Ä—É–µ–º —Å—Ç–∞—Ä—Ç/–æ–∫–æ–Ω—á–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
            let startCandidate = null;
            if (task.startDate) {
                const d = new Date(task.startDate);
                if (!isNaN(d.getTime())) startCandidate = d;
            } else if (Array.isArray(task.dates) && task.dates.length > 0) {
                const d = new Date(task.dates[0]);
                if (!isNaN(d.getTime())) startCandidate = d;
            }
            if (startCandidate) {
                if (!projectStartDate || startCandidate < projectStartDate) {
                    projectStartDate = startCandidate;
                }
            }

            let endCandidate = null;
            if (task.endDate) {
                const d = new Date(task.endDate);
                if (!isNaN(d.getTime())) endCandidate = d;
            } else if (Array.isArray(task.dates) && task.dates.length > 0) {
                const d = new Date(task.dates[task.dates.length - 1]);
                if (!isNaN(d.getTime())) endCandidate = d;
            }
            if (endCandidate) {
                if (!projectEndDate || endCandidate > projectEndDate) {
                    projectEndDate = endCandidate;
                }
            }

            if (!task.dates || task.dates.length === 0) {
                pending++;
                return;
            }
            
            const statuses = task.dateStatuses || {};
            const workDays = (task.dates || []).filter(d => {
                const dateObj = d instanceof Date ? d : new Date(d);
                if (isNaN(dateObj.getTime())) return false;
                const dateKey = formatDateKeyLocal(dateObj);
                return statuses[dateKey] !== 'weekend-manual';
            });
            
            if (workDays.length === 0) {
                pending++;
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã
            const allCompleted = workDays.every(d => {
                const dateKey = formatDateKeyLocal(d);
                return statuses[dateKey] === 'completed';
            });
            
            if (allCompleted) {
                completed++;
            } else {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞ –ª–∏ –∑–∞–¥–∞—á–∞
                const endDate = task.endDate ? new Date(task.endDate) : null;
                if (endDate) {
                    endDate.setHours(0, 0, 0, 0);
                    if (endDate < today) {
                        overdue++;
                    } else {
                        pending++;
                    }
                } else {
                    pending++;
                }
            }
        });
        
        return { completed, overdue, pending, projectStartDate, projectEndDate };
    };

    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏—Ç—É–ª—å–Ω–æ–≥–æ –ª–∏—Å—Ç–∞
    const createTitlePage = () => {
        const titleSection = document.createElement('div');
        titleSection.className = 'pdf-page-section';
        titleSection.style.width = a3WidthPx + 'px';
        titleSection.style.minHeight = a3HeightPx + 'px';
        titleSection.style.height = a3HeightPx + 'px';
        titleSection.style.maxHeight = a3HeightPx + 'px';
        titleSection.style.position = 'relative';
        titleSection.style.background = '#ffffff';
        titleSection.style.display = 'flex';
        titleSection.style.flexDirection = 'column';
        titleSection.style.justifyContent = 'space-between';
        titleSection.style.alignItems = 'center';
        titleSection.style.padding = '80px 50px 60px 50px';
        titleSection.style.boxSizing = 'border-box';
        titleSection.style.overflow = 'hidden';
        
        // –õ–æ–≥–æ—Ç–∏–ø —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª)
        titleSection.appendChild(createPageLogo());

        // –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å: –õ–æ–≥–æ—Ç–∏–ø –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ
        const topSection = document.createElement('div');
        topSection.style.width = '100%';
        topSection.style.display = 'flex';
        topSection.style.flexDirection = 'column';
        topSection.style.alignItems = 'center';
        topSection.style.textAlign = 'center';
        
        // –õ–æ–≥–æ—Ç–∏–ø –∫–æ–º–ø–∞–Ω–∏–∏
        if (logoEl && logoEl.src) {
            const logoClone = document.createElement('img');
            logoClone.src = logoEl.src;
            logoClone.style.width = '250px';
            logoClone.style.height = '250px';
            logoClone.style.borderRadius = '16px';
            logoClone.style.border = '3px solid #e0e0e0';
            logoClone.style.objectFit = 'contain';
            logoClone.style.background = '#fafafa';
            logoClone.style.padding = '12px';
            logoClone.style.display = 'block';
            logoClone.style.margin = '0 auto 40px auto';
            topSection.appendChild(logoClone);
        }
        
        // –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
        const currentNameText =
            nameDisplay && nameDisplay.classList.contains('has-value')
                ? (nameDisplay.innerText || nameDisplay.textContent)
                : '';
        
        const companyNameTitle = document.createElement('div');
        companyNameTitle.textContent = currentNameText || '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏';
        companyNameTitle.style.fontSize = '36px';
        companyNameTitle.style.fontWeight = '700';
        companyNameTitle.style.color = '#333333';
        companyNameTitle.style.marginBottom = '20px';
        topSection.appendChild(companyNameTitle);
        
        // –ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
        const objectNameDisplay = document.getElementById('companyObjectNameDisplay');
        let objectName = '';
        if (objectNameDisplay && objectNameDisplay.style.display !== 'none') {
            objectName = (objectNameDisplay.innerText || objectNameDisplay.textContent || '').trim();
        }
        if (!objectName && typeof companyObjectName !== 'undefined' && companyObjectName) {
            objectName = String(companyObjectName).trim();
        }
        
        if (objectName && objectName.length > 0) {
            const objectNameTitle = document.createElement('div');
            objectNameTitle.textContent = objectName;
            objectNameTitle.style.fontSize = '28px';
            objectNameTitle.style.fontWeight = '600';
            objectNameTitle.style.color = '#2196f3';
            objectNameTitle.style.marginBottom = '20px';
            topSection.appendChild(objectNameTitle);
        }
        
        const chartTypeTitle = document.createElement('div');
        chartTypeTitle.textContent = `–ì—Ä–∞—Ñ–∏–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏ –æ–±—É—á–µ–Ω–∏—è`;
        chartTypeTitle.style.fontSize = '22px';
        chartTypeTitle.style.fontWeight = '500';
        chartTypeTitle.style.color = '#666666';
        topSection.appendChild(chartTypeTitle);
        
        titleSection.appendChild(topSection);
        
        // –ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const metrics = calculateTaskMetrics();
        const formatDateForTitle = (date) => {
            if (!date) return '‚Äî';
            const d = date instanceof Date ? date : new Date(date);
            return isNaN(d.getTime()) ? '‚Äî' : d.toLocaleDateString('ru-RU');
        };
        const metricsContainer = document.createElement('div');
        metricsContainer.style.width = '100%';
        metricsContainer.style.maxWidth = '100%';
        metricsContainer.style.display = 'flex';
        metricsContainer.style.justifyContent = 'space-between';
        metricsContainer.style.gap = '20px';
        metricsContainer.style.flexWrap = 'nowrap';
        metricsContainer.style.padding = '0 10px';
        
        // –ú–µ—Ç—Ä–∏–∫–∞: –ó–∞–∫—Ä—ã—Ç–æ
        const completedCell = document.createElement('div');
        completedCell.style.flex = '1';
        completedCell.style.textAlign = 'center';
        completedCell.style.padding = '30px 20px';
        completedCell.style.background = '#e8f5e9';
        completedCell.style.borderRadius = '12px';
        completedCell.style.border = '3px solid #4caf50';
        completedCell.style.display = 'flex';
        completedCell.style.flexDirection = 'column';
        completedCell.style.alignItems = 'center';
        completedCell.style.justifyContent = 'center';
        
        const completedLabel = document.createElement('div');
        completedLabel.textContent = '–ó–∞–∫—Ä—ã—Ç–æ';
        completedLabel.style.fontSize = '18px';
        completedLabel.style.color = '#666';
        completedLabel.style.marginBottom = '12px';
        completedLabel.style.fontWeight = '600';
        completedCell.appendChild(completedLabel);
        
        const completedValue = document.createElement('div');
        completedValue.textContent = String(metrics.completed);
        completedValue.style.fontSize = '48px';
        completedValue.style.fontWeight = '700';
        completedValue.style.color = '#4caf50';
        completedCell.appendChild(completedValue);
        
        metricsContainer.appendChild(completedCell);
        
        // –ú–µ—Ç—Ä–∏–∫–∞: –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
        const overdueCell = document.createElement('div');
        overdueCell.style.flex = '1';
        overdueCell.style.textAlign = 'center';
        overdueCell.style.padding = '30px 20px';
        overdueCell.style.background = '#ffebee';
        overdueCell.style.borderRadius = '12px';
        overdueCell.style.border = '3px solid #f44336';
        overdueCell.style.display = 'flex';
        overdueCell.style.flexDirection = 'column';
        overdueCell.style.alignItems = 'center';
        overdueCell.style.justifyContent = 'center';
        
        const overdueLabel = document.createElement('div');
        overdueLabel.textContent = '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ';
        overdueLabel.style.fontSize = '18px';
        overdueLabel.style.color = '#666';
        overdueLabel.style.marginBottom = '12px';
        overdueLabel.style.fontWeight = '600';
        overdueCell.appendChild(overdueLabel);
        
        const overdueValue = document.createElement('div');
        overdueValue.textContent = String(metrics.overdue);
        overdueValue.style.fontSize = '48px';
        overdueValue.style.fontWeight = '700';
        overdueValue.style.color = '#f44336';
        overdueCell.appendChild(overdueValue);
        
        metricsContainer.appendChild(overdueCell);
        
        // –ú–µ—Ç—Ä–∏–∫–∞: –ü—Ä–µ–¥—Å—Ç–æ–∏—Ç
        const pendingCell = document.createElement('div');
        pendingCell.style.flex = '1';
        pendingCell.style.textAlign = 'center';
        pendingCell.style.padding = '30px 20px';
        pendingCell.style.background = '#e3f2fd';
        pendingCell.style.borderRadius = '12px';
        pendingCell.style.border = '3px solid #2196f3';
        pendingCell.style.display = 'flex';
        pendingCell.style.flexDirection = 'column';
        pendingCell.style.alignItems = 'center';
        pendingCell.style.justifyContent = 'center';
        
        const pendingLabel = document.createElement('div');
        pendingLabel.textContent = '–ü—Ä–µ–¥—Å—Ç–æ–∏—Ç';
        pendingLabel.style.fontSize = '18px';
        pendingLabel.style.color = '#666';
        pendingLabel.style.marginBottom = '12px';
        pendingLabel.style.fontWeight = '600';
        pendingCell.appendChild(pendingLabel);
        
        const pendingValue = document.createElement('div');
        pendingValue.textContent = String(metrics.pending);
        pendingValue.style.fontSize = '48px';
        pendingValue.style.fontWeight = '700';
        pendingValue.style.color = '#2196f3';
        pendingCell.appendChild(pendingValue);
        
        metricsContainer.appendChild(pendingCell);

        // –ú–µ—Ç—Ä–∏–∫–∞: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
        const startCell = document.createElement('div');
        startCell.style.flex = '1';
        startCell.style.textAlign = 'center';
        startCell.style.padding = '26px 18px';
        startCell.style.background = '#f5f5f5';
        startCell.style.borderRadius = '12px';
        startCell.style.border = '3px solid #d0d0d0';
        startCell.style.display = 'flex';
        startCell.style.flexDirection = 'column';
        startCell.style.alignItems = 'center';
        startCell.style.justifyContent = 'center';

        const startLabel = document.createElement('div');
        startLabel.textContent = '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞';
        startLabel.style.fontSize = '18px';
        startLabel.style.color = '#666';
        startLabel.style.marginBottom = '12px';
        startLabel.style.fontWeight = '600';
        startCell.appendChild(startLabel);

        const startValue = document.createElement('div');
        startValue.textContent = formatDateForTitle(metrics.projectStartDate);
        startValue.style.fontSize = '32px';
        startValue.style.fontWeight = '700';
        startValue.style.color = '#424242';
        startCell.appendChild(startValue);

        metricsContainer.appendChild(startCell);

        // –ú–µ—Ç—Ä–∏–∫–∞: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
        const endCell = document.createElement('div');
        endCell.style.flex = '1';
        endCell.style.textAlign = 'center';
        endCell.style.padding = '26px 18px';
        endCell.style.background = '#f5f5f5';
        endCell.style.borderRadius = '12px';
        endCell.style.border = '3px solid #d0d0d0';
        endCell.style.display = 'flex';
        endCell.style.flexDirection = 'column';
        endCell.style.alignItems = 'center';
        endCell.style.justifyContent = 'center';

        const endLabel = document.createElement('div');
        endLabel.textContent = '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è';
        endLabel.style.fontSize = '18px';
        endLabel.style.color = '#666';
        endLabel.style.marginBottom = '12px';
        endLabel.style.fontWeight = '600';
        endCell.appendChild(endLabel);

        const endValue = document.createElement('div');
        endValue.textContent = formatDateForTitle(metrics.projectEndDate);
        endValue.style.fontSize = '32px';
        endValue.style.fontWeight = '700';
        endValue.style.color = '#424242';
        endCell.appendChild(endValue);

        metricsContainer.appendChild(endCell);
        
        titleSection.appendChild(metricsContainer);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–æ–Ω—Ç–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω
        console.log('–¢–∏—Ç—É–ª—å–Ω—ã–π –ª–∏—Å—Ç —Å–æ–∑–¥–∞–Ω:', {
            hasContent: titleSection.children.length > 0,
            metrics: metrics,
            companyName: currentNameText || '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏',
            objectName: objectName
        });
        
        return titleSection;
    };

    // –°–æ–∑–¥–∞–µ–º —Ç–∏—Ç—É–ª—å–Ω—ã–π –ª–∏—Å—Ç –ø–µ—Ä–≤—ã–º
    const titlePage = createTitlePage();
    exportWrapper.appendChild(titlePage);
    console.log('–¢–∏—Ç—É–ª—å–Ω—ã–π –ª–∏—Å—Ç —Å–æ–∑–¥–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω', titlePage);

    let diagramRendered = false;
    const shouldIncludeDiagram = includeDiagram !== false;

    if (shouldIncludeDiagram) {
        const timelineUnits = buildExportTimeline(scaleMode);
        if (!timelineUnits.length) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é —à–∫–∞–ª—É –¥–ª—è PDF. –ë—É–¥–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü–∞.');
        } else {
            diagramRendered = true;
            const scaleLabel = getExportScaleLabel(scaleMode);

            const statusColors = {
                pending: '#1e88e5',
                'in-progress': '#ff9800',
                completed: '#4caf50',
                'weekend-manual': '#ffe0e0'
            };

            const unitsPerPage = scaleMode === 'day' ? 22 : scaleMode === 'week' ? 12 : 6;
            const chunks = [];
            for (let i = 0; i < timelineUnits.length; i += unitsPerPage) {
                const chunk = timelineUnits.slice(i, i + unitsPerPage);
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–ø—É—Å—Ç—ã–µ chunks
                if (chunk && chunk.length > 0) {
                    chunks.push(chunk);
                }
            }

            // –°–æ–∑–¥–∞–µ–º —Å–µ–∫—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å chunks –∏ –∑–∞–¥–∞—á–∏
            if (chunks.length > 0 && tasks && tasks.length > 0) {
                chunks.forEach((chunk, chunkIdx) => {
                    // –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Å–µ–∫—Ü–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ chunk —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π —à–∞–ø–∫–æ–π
                    // –ü–µ—Ä–≤–∞—è —Å–µ–∫—Ü–∏—è –ø–æ—Å–ª–µ —Ç–∏—Ç—É–ª—å–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å pageBreakBefore
                    // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –ø—É—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞ –º–µ–∂–¥—É —Ç–∏—Ç—É–ª—å–Ω—ã–º –ª–∏—Å—Ç–æ–º –∏ –ø–µ—Ä–≤–æ–π —Å–µ–∫—Ü–∏–µ–π
                    const isFirstAfterTitle = chunkIdx === 0;
                    const section = createPageSection(isFirstAfterTitle);

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∏–∞–≥—Ä–∞–º–º—ã
                const ganttTitle = document.createElement('div');
                ganttTitle.textContent = `–î–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞ (${scaleLabel})`;
                ganttTitle.style.fontSize = '12px';
                ganttTitle.style.fontWeight = '600';
                // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É - —Ç–∞–±–ª–∏—Ü–∞ –≤—Å–µ–≥–¥–∞ –≤–≤–µ—Ä—Ö—É –ª–∏—Å—Ç–∞
                ganttTitle.style.marginTop = '4px';
                ganttTitle.style.marginBottom = '6px';
                ganttTitle.style.marginLeft = '0'; // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –æ—Ç –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è —Å–µ–∫—Ü–∏–∏ (—Å —É—á–µ—Ç–æ–º padding 50px)
                ganttTitle.style.marginRight = '0';
                ganttTitle.style.textAlign = 'left'; // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é –≤ —Ä–∞–º–∫–∞—Ö —Å–µ–∫—Ü–∏–∏
                section.appendChild(ganttTitle);

                const ganttTable = document.createElement('table');
                ganttTable.className = 'gantt-diagram-table';
                ganttTable.style.borderCollapse = 'collapse';
                ganttTable.style.width = '100%';
                ganttTable.style.fontSize = '9px';
                ganttTable.style.marginBottom = '10px';
                ganttTable.style.marginLeft = '0';
                ganttTable.style.marginRight = '0';
                ganttTable.style.marginTop = '0';
                ganttTable.style.tableLayout = 'auto';

                // –ë–∞–∑–æ–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤
                const baseHeaders = ['–ó–∞–¥–∞—á–∞', '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è', '–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π'];
                
                // –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞–∑–æ–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
                const baseMaxLengths = baseHeaders.map((header, idx) => {
                    let maxLength = header.length;
                    tasks.forEach(task => {
                        let value = '';
                        if (idx === 0) {
                            // –ó–∞–¥–∞—á–∞ - –±–µ—Ä–µ–º –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–±–µ–∑ –æ–±—Ä–µ–∑–∫–∏)
                            value = task.task || '';
                            if (task.onTravel === true || task.onTravel === 'true') {
                                value = '‚úà ' + value;
                            }
                        } else if (idx === 1) {
                            // –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π
                            value = task.responsible || '';
                        } else if (idx === 2) {
                            // –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
                            value = task.startDate ? task.startDate.toLocaleDateString('ru-RU') : '';
                        } else if (idx === 3) {
                            // –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                            value = task.endDate ? task.endDate.toLocaleDateString('ru-RU') : '';
                        } else if (idx === 4) {
                            // –†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
                            value = task.days != null ? String(task.days) : '';
                        }
                        if (value.length > maxLength) {
                            maxLength = value.length;
                        }
                    });
                    return maxLength;
                });
                
                // –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞ —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å—Ç–æ–ª–±—Ü–æ–≤ —Å –¥–∞—Ç–∞–º–∏
                let maxDateLabelLength = 0;
                chunk.forEach(unit => {
                    const labelLength = (unit.label || '').length;
                    if (labelLength > maxDateLabelLength) {
                        maxDateLabelLength = labelLength;
                    }
                });
                
                // –í—ã—á–∏—Å–ª—è–µ–º —à–∏—Ä–∏–Ω—É –¥–ª—è –≤—Å–µ—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∏–º–≤–æ–ª–æ–≤
                // –î–ª—è —à—Ä–∏—Ñ—Ç–∞ 9px –ø—Ä–∏–º–µ—Ä–Ω–æ 6px –Ω–∞ —Å–∏–º–≤–æ–ª
                const charWidthBase = 6; // –ø—Ä–∏–º–µ—Ä–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –æ–¥–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –¥–ª—è —à—Ä–∏—Ñ—Ç–∞ 9px
                const charWidthDate = 5.5; // –ø—Ä–∏–º–µ—Ä–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –æ–¥–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –¥–ª—è –¥–∞—Ç
                const padding = 10; // –æ—Ç—Å—Ç—É–ø—ã —Å–ª–µ–≤–∞ –∏ —Å–ø—Ä–∞–≤–∞
                
                // –í—ã—á–∏—Å–ª—è–µ–º —à–∏—Ä–∏–Ω—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞–∑–æ–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
                const baseColumnWidths = baseMaxLengths.map((maxLength, idx) => {
                    if (idx === 0) {
                        // –ü–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü "–ó–∞–¥–∞—á–∞" - –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É
                        const calculatedWidth = (maxLength * charWidthBase) + padding;
                        return `${Math.min(Math.max(calculatedWidth, 150), 300)}px`;
                    }
                    return `${Math.max((maxLength * charWidthBase) + padding, 50)}px`;
                });
                
                // –í—ã—á–∏—Å–ª—è–µ–º —à–∏—Ä–∏–Ω—É –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ –¥–∞—Ç
                const dateColumnWidth = maxDateLabelLength > 0 
                    ? `${Math.max((maxDateLabelLength * charWidthDate) + padding, 35)}px` 
                    : '35px';

                const headerTr = document.createElement('tr');
                baseHeaders.forEach((text, idx) => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    th.style.background = '#f5f5f5';
                    th.style.color = '#222222';
                    th.style.fontWeight = '600';
                    th.style.fontSize = '9px';
                    th.style.padding = '4px 6px';
                    th.style.whiteSpace = idx === 0 ? 'normal' : 'nowrap';
                    th.style.width = baseColumnWidths[idx] || 'auto';
                    th.style.minWidth = baseColumnWidths[idx] || 'auto';
                    th.style.maxWidth = baseColumnWidths[idx] || 'auto';
                    addCellBorder(th);
                    headerTr.appendChild(th);
                });

                chunk.forEach(unit => {
                    const th = document.createElement('th');
                    th.textContent = unit.label;
                    th.style.background = '#e3f2fd';
                    th.style.color = '#222222';
                    th.style.fontWeight = '600';
                    th.style.fontSize = '8px';
                    th.style.padding = '4px 3px';
                    th.style.whiteSpace = 'nowrap';
                    th.style.width = dateColumnWidth;
                    th.style.minWidth = dateColumnWidth;
                    th.style.maxWidth = dateColumnWidth;
                    addCellBorder(th);
                    headerTr.appendChild(th);
                });

                ganttTable.appendChild(headerTr);

                tasks.forEach(task => {
                    const tr = document.createElement('tr');
                    // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ó–∞–ø—Ä–µ—â–∞–µ–º —Ä–∞–∑—Ä—ã–≤ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
                    tr.style.pageBreakInside = 'avoid';
                    tr.style.breakInside = 'avoid';

                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–∞–º–æ–ª–µ—Ç–∏–∫ –∫ –Ω–∞–∑–≤–∞–Ω–∏—é –∑–∞–¥–∞—á–∏, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ "–Ω–∞ –≤—ã–µ–∑–¥–µ"
                    let taskName = task.task || '';
                    if (task.onTravel === true || task.onTravel === 'true') {
                        taskName = '‚úà ' + taskName;
                    }

                    const baseValues = [
                        taskName,
                        task.responsible || '',
                        task.startDate ? task.startDate.toLocaleDateString('ru-RU') : '',
                        task.endDate ? task.endDate.toLocaleDateString('ru-RU') : '',
                        task.days != null ? String(task.days) : ''
                    ];

                    baseValues.forEach((val, idx) => {
                        const td = document.createElement('td');
                        td.textContent = val;
                        td.style.fontSize = '9px';
                        td.style.padding = '3px 6px';
                        td.style.whiteSpace = idx === 0 ? 'normal' : 'nowrap';
                        if (idx < baseColumnWidths.length) {
                            td.style.width = baseColumnWidths[idx];
                            td.style.minWidth = baseColumnWidths[idx];
                            td.style.maxWidth = baseColumnWidths[idx];
                        }
                        addCellBorder(td);
                        tr.appendChild(td);
                    });

                    const statuses = task.dateStatuses || {};

                    chunk.forEach(unit => {
                        const td = document.createElement('td');
                        td.style.width = dateColumnWidth;
                        td.style.minWidth = dateColumnWidth;
                        td.style.maxWidth = dateColumnWidth;
                        td.style.padding = '3px';
                        addCellBorder(td);

                        const unitStart = unit.start.getTime();
                        const unitEnd = unit.end.getTime();

                        let hasWorkday = false;
                        let intervalStatus = 'pending';

                        if (Array.isArray(task.dates)) {
                            const daysInUnit = task.dates.filter(d => {
                                const dateObj = d instanceof Date ? d : new Date(d);
                                if (isNaN(dateObj.getTime())) return false;
                                const t = dateObj.getTime();
                                return t >= unitStart && t <= unitEnd;
                            });

                            if (daysInUnit.length > 0) {
                                hasWorkday = true;
                                if (scaleMode === 'day' && daysInUnit.length === 1) {
                                    const key = formatDateKey(daysInUnit[0]);
                                    intervalStatus = statuses[key] || 'pending';
                                } else {
                                    const statusesInUnit = new Set();
                                    daysInUnit.forEach(d => {
                                        const key = formatDateKey(d);
                                        const s = statuses[key];
                                        if (s) statusesInUnit.add(s);
                                    });
                                    if (statusesInUnit.has('completed')) intervalStatus = 'completed';
                                    else if (statusesInUnit.has('in-progress')) intervalStatus = 'in-progress';
                                    else if (statusesInUnit.has('weekend-manual')) intervalStatus = 'weekend-manual';
                                    else intervalStatus = 'pending';
                                }
                            }
                        }

                        if (hasWorkday) {
                            const color = statusColors[intervalStatus] || statusColors.pending;
                            td.style.background = color;
                        }

                        tr.appendChild(td);
                    });

                    ganttTable.appendChild(tr);
                });

                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—Ü–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ
                    if (ganttTable.rows.length > 1) { // –ë–æ–ª—å—à–µ 1, –ø–æ—Ç–æ–º—É —á—Ç–æ –µ—Å—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
                        section.appendChild(ganttTable);
                        exportWrapper.appendChild(section);
                    }
                });
            }
        }
    }

    // --- –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ ---
    // –†–∞–∑–±–∏–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –Ω–∞ chunks, –∫–∞–∂–¥—ã–π –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ —Å–æ–∑–¥–∞–Ω–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Å–µ–∫—Ü–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã, —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å pageBreakBefore –¥–ª—è –ø–µ—Ä–≤–æ–π —Å–µ–∫—Ü–∏–∏
    const hasDiagramSections = exportWrapper.querySelectorAll('.pdf-page-section').length > 1; // –ë–æ–ª—å—à–µ 1, –ø–æ—Ç–æ–º—É —á—Ç–æ –µ—Å—Ç—å —Ç–∏—Ç—É–ª—å–Ω—ã–π –ª–∏—Å—Ç
    if (tasks && tasks.length > 0) {
        // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ A3
        // –í—ã—Å–æ—Ç–∞ A3: 297mm ‚âà 1123px
        // –í—ã—Å–æ—Ç–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏: –ø—Ä–∏–º–µ—Ä–Ω–æ 25px
        // –í—ã—Å–æ—Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã: –ø—Ä–∏–º–µ—Ä–Ω–æ 30px
        // –í—ã—Å–æ—Ç–∞ padding —Å–µ–∫—Ü–∏–∏: 20px —Å–≤–µ—Ä—Ö—É + 20px —Å–Ω–∏–∑—É = 40px
        // –í—ã—Å–æ—Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ "–î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á": –ø—Ä–∏–º–µ—Ä–Ω–æ 30px
        // –î–æ—Å—Ç—É–ø–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —Å—Ç—Ä–æ–∫: 1123 - 40 - 30 - 30 = 1023px
        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ: 1023 / 25 ‚âà 40 —Å—Ç—Ä–æ–∫
        const rowsPerPage = 35; // –ë–µ—Ä–µ–º —Å –∑–∞–ø–∞—Å–æ–º –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        
        // –†–∞–∑–±–∏–≤–∞–µ–º –∑–∞–¥–∞—á–∏ –Ω–∞ chunks
        const detailChunks = [];
        for (let i = 0; i < tasks.length; i += rowsPerPage) {
            detailChunks.push(tasks.slice(i, i + rowsPerPage));
        }
        
        console.log(`–î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞: ${tasks.length} –∑–∞–¥–∞—á —Ä–∞–∑–±–∏—Ç–æ –Ω–∞ ${detailChunks.length} chunks –ø–æ ${rowsPerPage} —Å—Ç—Ä–æ–∫`);
        
        // –°–æ–∑–¥–∞–µ–º —Å–µ–∫—Ü–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ chunk
        detailChunks.forEach((chunk, chunkIdx) => {
            // –ü–µ—Ä–≤—ã–π chunk –ø–æ—Å–ª–µ —Ç–∏—Ç—É–ª—å–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ (–µ—Å–ª–∏ –Ω–µ—Ç —Å–µ–∫—Ü–∏–π –¥–∏–∞–≥—Ä–∞–º–º—ã) –Ω–µ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å pageBreakBefore
            // isFirstAfterTitle = true –æ–∑–Ω–∞—á–∞–µ—Ç –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å pageBreakBefore
            const isFirstAfterTitle = chunkIdx === 0 && !hasDiagramSections;
            const detailSection = createPageSection(isFirstAfterTitle);
            
            // –ó–∞–ø—Ä–µ—â–∞–µ–º —Ä–∞–∑—Ä—ã–≤ —Å–µ–∫—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏
            detailSection.style.pageBreakInside = 'avoid';
            detailSection.style.breakInside = 'avoid';
            detailSection.style.overflow = 'visible';
            detailSection.style.minHeight = 'auto';
            detailSection.style.height = 'auto';

            const detailTitle = document.createElement('div');
            detailTitle.textContent = chunkIdx === 0 ? '–î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á' : `–î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ ${chunkIdx + 1})`;
            detailTitle.style.fontSize = '12px';
            detailTitle.style.fontWeight = '600';
            // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É - —Ç–∞–±–ª–∏—Ü–∞ –≤—Å–µ–≥–¥–∞ –≤–≤–µ—Ä—Ö—É –ª–∏—Å—Ç–∞
            detailTitle.style.marginTop = '4px';
            detailTitle.style.marginBottom = '6px';
            detailTitle.style.marginLeft = '0'; // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –æ—Ç –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è —Å–µ–∫—Ü–∏–∏ (—Å —É—á–µ—Ç–æ–º padding 50px)
            detailTitle.style.marginRight = '0';
            detailTitle.style.textAlign = 'left'; // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é –≤ —Ä–∞–º–∫–∞—Ö —Å–µ–∫—Ü–∏–∏
            detailSection.appendChild(detailTitle);

            const detailTable = document.createElement('table');
            detailTable.className = 'detail-tasks-table';
            detailTable.style.borderCollapse = 'collapse';
            detailTable.style.width = '100%';
            detailTable.style.marginBottom = '10px';
            detailTable.style.marginLeft = '0';
            detailTable.style.marginRight = '0';
            detailTable.style.marginTop = '0';
            detailTable.style.tableLayout = 'auto';
            detailTable.style.fontSize = '9px';

            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã (–ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º chunk)
            const detailHeaderTr = document.createElement('tr');
            const detailHeaders = [
                { text: '‚Ññ –ø/–ø', width: '40px' },
                { text: '–≠—Ç–∞–ø', width: 'auto' },
                { text: '–í–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è', width: 'auto' },
                { text: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ', width: 'auto' },
                { text: '–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π', width: '80px' },
                { text: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', width: 'auto' },
                { text: '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', width: '90px' },
                { text: '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è', width: '90px' },
                { text: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –¥–∞—Ç–∞–º', width: 'auto' }
            ];
            
            detailHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.text;
                th.style.background = '#f5f5f5';
                th.style.color = '#222222';
                th.style.fontWeight = '600';
                th.style.fontSize = '9px';
                th.style.padding = '4px 6px';
                th.style.whiteSpace = 'nowrap';
                if (header.width !== 'auto') {
                    th.style.width = header.width;
                    th.style.minWidth = header.width;
                }
                addCellBorder(th);
                detailHeaderTr.appendChild(th);
            });
            detailTable.appendChild(detailHeaderTr);

            // –°—Ç—Ä–æ–∫–∏ –∑–∞–¥–∞—á –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ chunk
            chunk.forEach((task, idx) => {
                const tr = document.createElement('tr');
                
                // –ó–∞–ø—Ä–µ—â–∞–µ–º —Ä–∞–∑—Ä—ã–≤ —Å—Ç—Ä–æ–∫–∏ –≤–Ω—É—Ç—Ä–∏
                tr.style.pageBreakInside = 'avoid';
                tr.style.breakInside = 'avoid';

                let commentsSummary = '';
                if (task.dateComments) {
                    const entries = Object.entries(task.dateComments)
                        .filter(([, text]) => text && String(text).trim().length > 0)
                        .sort(([d1], [d2]) => (d1 < d2 ? -1 : d1 > d2 ? 1 : 0))
                        .map(([date, text]) => `${date}: ${String(text).trim()}`);
                    commentsSummary = entries.join('; ');
                }

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–∞–º–æ–ª–µ—Ç–∏–∫ –∫ –Ω–∞–∑–≤–∞–Ω–∏—é –∑–∞–¥–∞—á–∏, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ "–Ω–∞ –≤—ã–µ–∑–¥–µ"
                let taskName = task.task || '';
                if (task.onTravel === true || task.onTravel === 'true') {
                    taskName = '‚úà ' + taskName;
                }
                
                // –í—ã—á–∏—Å–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–¥–∞—á–∏
                const globalIdx = (chunkIdx * rowsPerPage) + idx;
                
                const cells = [
                    globalIdx + 1,
                    task.stage || '',
                    task.control || '',
                    taskName,
                    task.days != null ? String(task.days) : '',
                    task.responsible || '',
                    task.startDate ? task.startDate.toLocaleDateString('ru-RU') : '',
                    task.endDate ? task.endDate.toLocaleDateString('ru-RU') : '',
                    commentsSummary
                ];

                cells.forEach((val, cellIdx) => {
                    const td = document.createElement('td');
                    td.textContent = val;
                    td.style.fontSize = '9px';
                    td.style.padding = '3px 6px';
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
                    if (cellIdx === 0) {
                        td.style.width = '40px';
                        td.style.minWidth = '40px';
                        td.style.whiteSpace = 'nowrap';
                    } else if (cellIdx === 4) {
                        td.style.width = '80px';
                        td.style.minWidth = '80px';
                        td.style.whiteSpace = 'nowrap';
                    } else if (cellIdx === 6 || cellIdx === 7) {
                        td.style.width = '90px';
                        td.style.minWidth = '90px';
                        td.style.whiteSpace = 'nowrap';
                    } else if (cellIdx === 3 || cellIdx === 8) {
                        td.style.whiteSpace = 'normal';
                    } else {
                        td.style.whiteSpace = 'nowrap';
                    }
                    
                    addCellBorder(td);
                    tr.appendChild(td);
                });

                detailTable.appendChild(tr);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—Ü–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ
            if (detailTable.rows.length > 1) { // –ë–æ–ª—å—à–µ 1, –ø–æ—Ç–æ–º—É —á—Ç–æ –µ—Å—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
                detailSection.appendChild(detailTable);
                exportWrapper.appendChild(detailSection);
            }
        });
    }

    // --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF ---
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingIndicator = document.createElement('div');
    loadingIndicator.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF...';
    loadingIndicator.style.position = 'fixed';
    loadingIndicator.style.top = '50%';
    loadingIndicator.style.left = '50%';
    loadingIndicator.style.transform = 'translate(-50%, -50%)';
    loadingIndicator.style.padding = '20px 40px';
    loadingIndicator.style.background = 'rgba(0, 0, 0, 0.8)';
    loadingIndicator.style.color = '#fff';
    loadingIndicator.style.borderRadius = '8px';
    loadingIndicator.style.zIndex = '999999';
    loadingIndicator.style.fontSize = '16px';
    loadingIndicator.style.fontWeight = '600';
    document.body.appendChild(loadingIndicator);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
    const sections = exportWrapper.querySelectorAll('.pdf-page-section');
    if (sections.length === 0) {
        console.error('–ù–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF');
        if (loadingIndicator.parentNode) {
            document.body.removeChild(loadingIndicator);
        }
        alert('–û—à–∏–±–∫–∞: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Å–µ–∫—Ü–∏–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –∫–æ–Ω—Ç–µ–Ω—Ç (–Ω–µ –ø—É—Å—Ç—ã–µ)
    const validSections = Array.from(sections).filter(section => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ–∫—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∏–¥–∏–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
        const hasContent = section.children.length > 0 && 
                          (section.textContent.trim().length > 0 || 
                           section.querySelector('table') || 
                           section.querySelector('img'));
        if (!hasContent) {
            console.warn('–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—É—Å—Ç–∞—è —Å–µ–∫—Ü–∏—è, —É–¥–∞–ª—è–µ–º:', section);
            section.remove();
        }
        return hasContent;
    });

    console.log(`–≠–∫—Å–ø–æ—Ä—Ç PDF: —Å–æ–∑–¥–∞–Ω–æ ${validSections.length} —Å–µ–∫—Ü–∏–π (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ ${sections.length}, —É–¥–∞–ª–µ–Ω–æ ${sections.length - validSections.length} –ø—É—Å—Ç—ã—Ö)`);
    
    if (validSections.length === 0) {
        console.error('–ù–µ—Ç –≤–∞–ª–∏–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF');
        if (loadingIndicator.parentNode) {
            document.body.removeChild(loadingIndicator);
        }
        alert('–û—à–∏–±–∫–∞: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF');
        if (exportWrapper.parentNode) {
            document.body.removeChild(exportWrapper);
        }
        return;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º CSS —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑—Ä—ã–≤–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
    const style = document.createElement('style');
    style.textContent = `
        * {
            box-sizing: border-box;
        }
        .pdf-page-section {
            width: 100% !important;
            margin: 0 auto !important;
            box-sizing: border-box !important;
            overflow: visible !important;
            min-height: auto !important;
            height: auto !important;
            position: relative !important;
        }
        /* –õ–æ–≥–æ—Ç–∏–ø –Ω–∞ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ - –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏ –æ—Ç—Å—Ç—É–ø–æ–≤ */
        .pdf-page-logo {
            position: absolute !important;
            top: 12px !important;
            right: 12px !important;
            width: 80px !important;
            height: 80px !important;
            z-index: 1000 !important;
            pointer-events: none !important;
            opacity: 0.28 !important;
        }
        .pdf-page-logo img {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain !important;
            display: block !important;
        }
        .pdf-page-section table {
            margin-left: 0 !important;
            margin-right: 0 !important;
            width: 100% !important;
            table-layout: fixed !important;
            min-width: 100% !important;
        }
        /* –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ó–∞–ø—Ä–µ—â–∞–µ–º —Ä–∞–∑—Ä—ã–≤ —Ç–∞–±–ª–∏—Ü –¥–∏–∞–≥—Ä–∞–º–º—ã –ì–∞–Ω—Ç–∞ (–æ–Ω–∏ —É–∂–µ —Ä–∞–∑–±–∏—Ç—ã –Ω–∞ chunks) */
        .pdf-page-section table.gantt-diagram-table {
            page-break-inside: avoid !important;
            break-inside: avoid !important;
            width: 100% !important;
            max-width: 100% !important;
            margin-left: 0 !important; /* –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è */
        }
        /* –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ù–ï –¥–æ–ª–∂–Ω–∞ —Ä–∞–∑—Ä—ã–≤–∞—Ç—å—Å—è (—É–∂–µ —Ä–∞–∑–±–∏—Ç–∞ –Ω–∞ chunks) */
        .pdf-page-section table.detail-tasks-table {
            page-break-inside: avoid !important;
            break-inside: avoid !important;
            width: 100% !important;
            max-width: 100% !important;
            margin-left: 0 !important; /* –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è */
        }
        .pdf-page-section table th,
        .pdf-page-section table td {
            overflow: visible !important;
            word-wrap: break-word !important;
            page-break-inside: avoid !important;
            break-inside: avoid !important;
        }
        .pdf-page-section table tr {
            /* –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ó–∞–ø—Ä–µ—â–∞–µ–º —Ä–∞–∑—Ä—ã–≤ —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã */
            page-break-inside: avoid !important;
            break-inside: avoid !important;
        }
        @media print {
            .pdf-page-section {
                page-break-before: always;
                page-break-inside: avoid;
                break-before: page;
                break-inside: avoid;
                position: relative !important;
            }
            .pdf-page-section:first-child {
                page-break-before: auto;
                break-before: auto;
            }
            /* –õ–æ–≥–æ—Ç–∏–ø –Ω–∞ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–∏ –ø–µ—á–∞—Ç–∏ */
            .pdf-page-logo {
                position: absolute !important;
                top: 12px !important;
                right: 12px !important;
                width: 80px !important;
                height: 80px !important;
                z-index: 1000 !important;
                pointer-events: none !important;
                opacity: 0.28 !important;
            }
            /* –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ó–∞–ø—Ä–µ—â–∞–µ–º —Ä–∞–∑—Ä—ã–≤ —Ç–∞–±–ª–∏—Ü –¥–∏–∞–≥—Ä–∞–º–º—ã –ì–∞–Ω—Ç–∞ (–æ–Ω–∏ —É–∂–µ —Ä–∞–∑–±–∏—Ç—ã –Ω–∞ chunks) */
            .pdf-page-section table.gantt-diagram-table {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                width: 100% !important;
                max-width: 100% !important;
                margin-left: 0 !important; /* –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è */
            }
            /* –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ù–ï –¥–æ–ª–∂–Ω–∞ —Ä–∞–∑—Ä—ã–≤–∞—Ç—å—Å—è (—É–∂–µ —Ä–∞–∑–±–∏—Ç–∞ –Ω–∞ chunks) */
            .pdf-page-section table.detail-tasks-table {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                width: 100% !important;
                max-width: 100% !important;
                margin-left: 0 !important; /* –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è */
            }
            .pdf-page-section tr {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
        }
    `;
    exportWrapper.appendChild(style);

    document.body.appendChild(exportWrapper);

    // –î–∞–µ–º –≤—Ä–µ–º—è DOM –æ–±–Ω–æ–≤–∏—Ç—å—Å—è –ø–µ—Ä–µ–¥ —ç–∫—Å–ø–æ—Ä—Ç–æ–º
    setTimeout(async () => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–Ω
        const sections = exportWrapper.querySelectorAll('.pdf-page-section');
        if (sections.length === 0) {
            console.error('–ù–µ—Ç —Å–µ–∫—Ü–∏–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF');
            if (loadingIndicator.parentNode) {
                document.body.removeChild(loadingIndicator);
            }
            if (exportWrapper.parentNode) {
                document.body.removeChild(exportWrapper);
            }
            alert('–û—à–∏–±–∫–∞: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF');
            return;
        }
        
        console.log(`–≠–∫—Å–ø–æ—Ä—Ç PDF: –Ω–∞–π–¥–µ–Ω–æ ${sections.length} —Å–µ–∫—Ü–∏–π`);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ–∫—Ü–∏–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –∫–æ–Ω—Ç–µ–Ω—Ç
        sections.forEach((section, idx) => {
            const hasContent = section.children.length > 0 && 
                              (section.textContent.trim().length > 0 || 
                               section.querySelector('table') || 
                               section.querySelector('img'));
            console.log(`–°–µ–∫—Ü–∏—è ${idx}:`, {
                hasContent,
                childrenCount: section.children.length,
                textLength: section.textContent.trim().length,
                hasTable: !!section.querySelector('table'),
                hasImg: !!section.querySelector('img')
            });
            
            if (!hasContent) {
                console.warn(`–°–µ–∫—Ü–∏—è ${idx} –ø—É—Å—Ç–∞—è!`);
            }
        });
        
        // –û—Ç—Å—Ç—É–ø—ã —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –≤ createPageSection, –Ω–µ –Ω—É–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω—è—Ç—å –∏—Ö
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ wrapper –≤ DOM –∏ –≤–∏–¥–∏–º –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å–µ–∫—Ü–∏–π
        exportWrapper.style.position = 'absolute';
        exportWrapper.style.left = '-9999px'; // –ó–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —ç–∫—Ä–∞–Ω–∞, –Ω–æ –≤–∏–¥–∏–º –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
        exportWrapper.style.top = '0';
        exportWrapper.style.visibility = 'visible';
        exportWrapper.style.opacity = '1';
        exportWrapper.style.display = 'block';
        
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ —Å–µ–∫—Ü–∏—è—Ö
        const images = exportWrapper.querySelectorAll('img');
        const imagePromises = Array.from(images).map(img => {
            if (img.complete) return Promise.resolve();
            return new Promise((resolve) => {
                img.onload = resolve;
                img.onerror = resolve; // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
                setTimeout(resolve, 2000); // –¢–∞–π–º–∞—É—Ç 2 —Å–µ–∫—É–Ω–¥—ã
            });
        });
        
        await Promise.all(imagePromises);
        console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${images.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`);
        
        // –ù–û–í–´–ô –ü–û–î–•–û–î: –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∂–¥—É—é —Å–µ–∫—Ü–∏—é –æ—Ç–¥–µ–ª—å–Ω–æ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å–≤–æ—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ PDF
        // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã –í–°–ï–ì–î–ê –≤–≤–µ—Ä—Ö—É –ª–∏—Å—Ç–∞ –∏ –ù–ï —Ä–∞–∑—Ä—ã–≤–∞—é—Ç—Å—è –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏
        try {
            console.log('–ù–∞—á–∞–ª–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ PDF: —Å–µ–∫—Ü–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ =', sections.length);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º html2canvas
            if (typeof html2canvas === 'undefined') {
                // –ï—Å–ª–∏ html2canvas –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º jsPDF
            if (typeof window.jspdf === 'undefined' && typeof window.jsPDF === 'undefined') {
                // –ï—Å–ª–∏ jsPDF –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
            
            // –ü–æ–ª—É—á–∞–µ–º jsPDF –∏–∑ window
            const { jsPDF } = window.jspdf || window;
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π PDF –¥–æ–∫—É–º–µ–Ω—Ç A3 landscape
            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a3'
            });
            
            // –†–∞–∑–º–µ—Ä—ã A3 landscape –≤ –º–º
            const pageWidth = 420; // A3 landscape —à–∏—Ä–∏–Ω–∞
            const pageHeight = 297; // A3 landscape –≤—ã—Å–æ—Ç–∞
            
            let isFirstPage = true;
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∂–¥—É—é —Å–µ–∫—Ü–∏—é –æ—Ç–¥–µ–ª—å–Ω–æ
            for (let i = 0; i < sections.length; i++) {
                const section = sections[i];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                loadingIndicator.textContent = `–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF... ${i + 1}/${sections.length}`;
                
                console.log(`–†–µ–Ω–¥–µ—Ä–∏–º —Å–µ–∫—Ü–∏—é ${i + 1}/${sections.length}`);
                
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–µ–∫—Ü–∏—è –≤–∏–¥–∏–º–∞
                section.style.display = 'block';
                section.style.visibility = 'visible';
                section.style.opacity = '1';
                section.style.position = 'relative';
                section.style.left = '0';
                section.style.top = '0';
                
                // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
                await new Promise(resolve => setTimeout(resolve, 100));
                
                try {
                    // –†–µ–Ω–¥–µ—Ä–∏–º —Å–µ–∫—Ü–∏—é –≤ canvas
                    const canvas = await html2canvas(section, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        windowWidth: section.scrollWidth,
                        windowHeight: section.scrollHeight,
                        width: section.scrollWidth,
                        height: section.scrollHeight,
                        x: 0,
                        y: 0,
                        scrollX: 0,
                        scrollY: 0,
                        allowTaint: true,
                        imageTimeout: 15000
                    });
                    
                    console.log(`–°–µ–∫—Ü–∏—è ${i + 1} –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–∞:`, {
                        canvasWidth: canvas.width,
                        canvasHeight: canvas.height,
                        sectionWidth: section.scrollWidth,
                        sectionHeight: section.scrollHeight
                    });
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º canvas –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    const imgData = canvas.toDataURL('image/jpeg', 0.98);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
                    if (!isFirstPage) {
                        pdf.addPage('a3', 'landscape');
                    }
                    isFirstPage = false;
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –≤–ø–∏—Å—ã–≤–∞–Ω–∏—è –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    // –û—Å—Ç–∞–≤–ª—è–µ–º –Ω—É–ª–µ–≤—ã–µ –æ—Ç—Å—Ç—É–ø—ã - –≤—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–Ω—è—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
                    const imgWidth = pageWidth;
                    const imgHeight = (canvas.height * pageWidth) / canvas.width;
                    
                    // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã—à–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø–æ –≤—ã—Å–æ—Ç–µ
                    if (imgHeight > pageHeight) {
                        const scaledHeight = pageHeight;
                        const scaledWidth = (canvas.width * pageHeight) / canvas.height;
                        pdf.addImage(imgData, 'JPEG', 0, 0, scaledWidth, scaledHeight);
                    } else {
                        // –†–∞–∑–º–µ—â–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã (y = 0)
                        pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                    }
                    
                    console.log(`–°–µ–∫—Ü–∏—è ${i + 1} –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ PDF`);
                    
                } catch (err) {
                    console.error(`–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å–µ–∫—Ü–∏–∏ ${i + 1}:`, err);
                    throw err;
                }
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º PDF
            const filename = generateExportFileName('pdf');
            pdf.save(filename);
            
            console.log('PDF —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
            
            // –£–¥–∞–ª—è–µ–º wrapper
            if (exportWrapper.parentNode) {
                document.body.removeChild(exportWrapper);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
            loadingIndicator.textContent = 'PDF –≥–æ—Ç–æ–≤!';
            setTimeout(() => {
                if (loadingIndicator.parentNode) {
                    document.body.removeChild(loadingIndicator);
                }
            }, 3000);
            
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF:', err);
            console.error('–°—Ç–µ–∫ –æ—à–∏–±–∫–∏:', err.stack);
            if (exportWrapper.parentNode) {
                document.body.removeChild(exportWrapper);
            }
            if (loadingIndicator.parentNode) {
                document.body.removeChild(loadingIndicator);
            }
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF: ' + (err.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    }, 800); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
}

        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª—ã –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel (–¥–Ω–∏/–Ω–µ–¥–µ–ª–∏/–º–µ—Å—è—Ü—ã/–≥–æ–¥—ã)
        function buildExportTimeline(scaleMode) {
            if (!tasks.length) return [];

            const projectFirstDate = new Date(tasks[0].startDate);
            const realLastTaskDate = new Date(tasks[tasks.length - 1].endDate);
            const msInDay = 24 * 60 * 60 * 1000;

            const units = [];

            if (scaleMode === 'day') {
                let currentDate = new Date(projectFirstDate);
                while (currentDate <= realLastTaskDate) {
                    units.push({
                        type: 'day',
                        start: new Date(currentDate),
                        end: new Date(currentDate),
                        label: currentDate.toLocaleDateString('ru-RU')
                    });
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            } else if (scaleMode === 'week') {
                let weekStart = new Date(projectFirstDate);
                while (weekStart.getDay() !== 1) { // –∫ –±–ª–∏–∂–∞–π—à–µ–º—É –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫—É –Ω–∞–∑–∞–¥
                    weekStart.setDate(weekStart.getDate() - 1);
                }
                while (weekStart <= realLastTaskDate) {
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    const label = `${weekStart.toLocaleDateString('ru-RU')} ‚Äî ${weekEnd.toLocaleDateString('ru-RU')}`;
                    units.push({
                        type: 'week',
                        start: new Date(weekStart),
                        end: new Date(weekEnd),
                        label
                    });
                    weekStart.setDate(weekStart.getDate() + 7);
                }
            } else if (scaleMode === 'month') {
                let current = new Date(projectFirstDate.getFullYear(), projectFirstDate.getMonth(), 1);
                while (current <= realLastTaskDate) {
                    const y = current.getFullYear();
                    const m = current.getMonth();
                    const monthStart = new Date(y, m, 1);
                    const monthEnd = new Date(y, m + 1, 0);
                    const label = current.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
                    units.push({
                        type: 'month',
                        start: monthStart,
                        end: monthEnd,
                        label
                    });
                    current.setMonth(current.getMonth() + 1);
                }
            } else if (scaleMode === 'year') {
                let currentYear = projectFirstDate.getFullYear();
                const lastYear = realLastTaskDate.getFullYear();
                while (currentYear <= lastYear) {
                    const yearStart = new Date(currentYear, 0, 1);
                    const yearEnd = new Date(currentYear, 11, 31);
                    units.push({
                        type: 'year',
                        start: yearStart,
                        end: yearEnd,
                        label: String(currentYear)
                    });
                    currentYear++;
                }
            }

            return units;
        }

        function getExportScaleLabel(scaleMode) {
            switch (scaleMode) {
                case 'day': return '–ì–∞–Ω—Ç (–¥–Ω–∏)';
                case 'week': return '–ì–∞–Ω—Ç (–Ω–µ–¥–µ–ª–∏)';
                case 'month': return '–ì–∞–Ω—Ç (–º–µ—Å—è—Ü—ã)';
                case 'year': return '–ì–∞–Ω—Ç (–≥–æ–¥—ã)';
                default: return '–ì–∞–Ω—Ç';
            }
        }

        // –ü–æ–¥–±–æ—Ä —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤ –ø–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (–ø—Ä–∏–±–ª–∏–∂—ë–Ω–Ω—ã–π –∞–≤—Ç–æ‚Äë–ø–æ–¥–±–æ—Ä)
        function buildAutoColumnWidths(aoa) {
            if (!Array.isArray(aoa) || !aoa.length) return [];

            const colCount = aoa.reduce((max, row) => Math.max(max, row.length), 0);
            const maxLens = new Array(colCount).fill(0);

            aoa.forEach(row => {
                row.forEach((cell, colIdx) => {
                    if (cell === null || cell === undefined) return;
                    const text = String(cell);
                    if (text.length > maxLens[colIdx]) {
                        maxLens[colIdx] = text.length;
                    }
                });
            });

            return maxLens.map((len, idx) => {
                // –ë–∞–∑–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞: –ø–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ —à–∏—Ä–µ (–∑–∞–¥–∞—á–∏), –æ—Å—Ç–∞–ª—å–Ω—ã–µ —á—É—Ç—å —É–∂–µ
                const base = idx === 0 ? 20 : 8;
                const wch = Math.min(60, Math.max(base, len + 2));
                return { wch };
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü –∫–æ –≤—Å–µ–º —è—á–µ–π–∫–∞–º —Å –¥–∞–Ω–Ω—ã–º–∏
        function applyBordersToSheet(ws) {
            if (!ws || !ws['!ref']) return;
            
            const range = XLSX.utils.decode_range(ws['!ref']);
            if (!range) return;
            
            // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ —Å—Ç–æ–ª–±—Ü–µ A
            let lastRowWithData = -1;
            for (let r = range.e.r; r >= range.s.r; r--) {
                const cellAddr = XLSX.utils.encode_cell({ c: 0, r: r });
                const cell = ws[cellAddr];
                if (cell && cell.v !== undefined && cell.v !== null && String(cell.v).trim() !== '') {
                    lastRowWithData = r;
                    break;
                }
            }
            
            if (lastRowWithData === -1) return; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Å—Ç–æ–ª–±—Ü–µ A
            
            // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–æ–ª–±–µ—Ü —Å –¥–∞–Ω–Ω—ã–º–∏
            let lastColWithData = -1;
            for (let c = range.e.c; c >= range.s.c; c--) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏
                for (let r = range.s.r; r <= lastRowWithData; r++) {
                    const cellAddr = XLSX.utils.encode_cell({ c: c, r: r });
                    const cell = ws[cellAddr];
                    if (cell && cell.v !== undefined && cell.v !== null && String(cell.v).trim() !== '') {
                        lastColWithData = c;
                        break;
                    }
                }
                if (lastColWithData !== -1) break;
            }
            
            if (lastColWithData === -1) return; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Å—Ç–æ–ª–±—Ü–∞—Ö
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª—å –≥—Ä–∞–Ω–∏—Ü—ã
            const borderStyle = {
                style: 'thin',
                color: { rgb: '000000' }
            };
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∫–æ –≤—Å–µ–º —è—á–µ–π–∫–∞–º –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
            for (let r = range.s.r; r <= lastRowWithData; r++) {
                for (let c = range.s.c; c <= lastColWithData; c++) {
                    const cellAddr = XLSX.utils.encode_cell({ c: c, r: r });
                    let cell = ws[cellAddr];
                    
                    // –°–æ–∑–¥–∞—ë–º —è—á–µ–π–∫—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
                    if (!cell) {
                        cell = { v: '', t: 's' };
                        ws[cellAddr] = cell;
                    }
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–∏–ª—å, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                    if (!cell.s) {
                        cell.s = {};
                    }
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
                    if (!cell.s.border) {
                        cell.s.border = {};
                    }
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Å–µ –≥—Ä–∞–Ω–∏—Ü—ã (–≤–µ—Ä—Ö, –Ω–∏–∑, –ª–µ–≤–æ, –ø—Ä–∞–≤–æ)
                    cell.s.border.top = borderStyle;
                    cell.s.border.bottom = borderStyle;
                    cell.s.border.left = borderStyle;
                    cell.s.border.right = borderStyle;
                }
            }
        }

        function getExcelScaleModeValue() {
            const selectEl = document.getElementById('exportExcelScale') || document.getElementById('excelScaleMode');
            const rawMode = selectEl ? String(selectEl.value || '').toLowerCase() : 'day';
            let scaleMode = 'day';
            if (rawMode.startsWith('week') || rawMode.startsWith('–Ω–µ–¥')) scaleMode = 'week';
            else if (rawMode.startsWith('month') || rawMode.startsWith('–º–µ—Å')) scaleMode = 'month';
            else if (rawMode.startsWith('year') || rawMode.startsWith('–≥–æ–¥')) scaleMode = 'year';
            return scaleMode;
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
        function exportExcel() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const loadingIndicator = document.createElement('div');
            loadingIndicator.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Excel...';
            loadingIndicator.style.position = 'fixed';
            loadingIndicator.style.top = '50%';
            loadingIndicator.style.left = '50%';
            loadingIndicator.style.transform = 'translate(-50%, -50%)';
            loadingIndicator.style.padding = '20px 40px';
            loadingIndicator.style.background = 'rgba(0, 0, 0, 0.8)';
            loadingIndicator.style.color = '#fff';
            loadingIndicator.style.borderRadius = '8px';
            loadingIndicator.style.zIndex = '999999';
            loadingIndicator.style.fontSize = '16px';
            loadingIndicator.style.fontWeight = '600';
            document.body.appendChild(loadingIndicator);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout —á—Ç–æ–±—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Å–ø–µ–ª –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å—Å—è
            setTimeout(() => {
                try {
                    _exportExcelInternal(loadingIndicator);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ Excel:', error);
                    if (loadingIndicator.parentNode) {
                        document.body.removeChild(loadingIndicator);
                    }
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ Excel');
                }
            }, 100);
        }
        
        // –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞
        function _exportExcelInternal(loadingIndicator) {
            // –ï—Å–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ XLSX –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∫ CDN),
            // –¥–µ–ª–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —ç–∫—Å–ø–æ—Ä—Ç –≤ CSV, –∫–æ—Ç–æ—Ä—ã–π Excel —Å–ø–æ–∫–æ–π–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç.
            if (typeof XLSX === 'undefined') {
                try {
                    const scaleMode = getExcelScaleModeValue();

                    const timelineUnits = buildExportTimeline(scaleMode);

                    let csv = '\uFEFF';

                    // –ë–ª–æ–∫ 1: –ì–∞–Ω—Ç
                    if (timelineUnits.length) {
                        csv += '"' + getExportScaleLabel(scaleMode).replace(/"/g, '""') + '"\n';

                        const ganttHeader = ['–ó–∞–¥–∞—á–∞', '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è', '–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π'];
                        timelineUnits.forEach(unit => {
                            ganttHeader.push(unit.label);
                        });
                        csv += '"' + ganttHeader.map(v => String(v).replace(/"/g, '""')).join('";"') + '"\n';

                        tasks.forEach(task => {
                            const rowBase = [
                                task.task,
                                task.startDate ? task.startDate.toLocaleDateString('ru-RU') : '',
                                task.endDate ? task.endDate.toLocaleDateString('ru-RU') : '',
                                task.days
                            ];

                            const row = rowBase.map(v => String(v).replace(/"/g, '""'));

                            timelineUnits.forEach(unit => {
                                if (!task.startDate || !task.endDate || !Array.isArray(task.dates)) {
                                    row.push('');
                                    return;
                                }

                                const unitStart = unit.start.getTime();
                                const unitEnd = unit.end.getTime();
                                const hasWorkdayInUnit = task.dates.some(d => {
                                    const t = d.getTime();
                                    return t >= unitStart && t <= unitEnd;
                                });

                                row.push(hasWorkdayInUnit ? '‚ñ†' : '');
                            });

                            csv += '"' + row.join('";"') + '"\n';
                        });

                        csv += '\n\n';
                    }

                    // –ë–ª–æ–∫ 2: –¢–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á –∫–∞–∫ –µ—Å—Ç—å
                    csv += '"–¢–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á"\n';
                    csv += '"‚Ññ –ø/–ø";"–≠—Ç–∞–ø";"–í–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è";"–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ";"–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π";"–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π";"–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞";"–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è"\n';
                    tasks.forEach((task, index) => {
                        const row = [
                            index + 1,
                            task.stage,
                            task.control,
                            task.task,
                            task.days,
                            task.responsible || '',
                            task.startDate.toLocaleDateString('ru-RU'),
                            task.endDate.toLocaleDateString('ru-RU')
                        ].map(value => String(value).replace(/"/g, '""'));
                        csv += '"' + row.join('";"') + '"\n';
                    });

                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = generateExportFileName('csv');
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                    loadingIndicator.textContent = 'CSV –≥–æ—Ç–æ–≤!';
                    setTimeout(() => {
                        if (loadingIndicator.parentNode) {
                            document.body.removeChild(loadingIndicator);
                        }
                    }, 3000); // 3 —Å–µ–∫—É–Ω–¥—ã
                } catch (e) {
                    if (loadingIndicator.parentNode) {
                        document.body.removeChild(loadingIndicator);
                    }
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ Excel-—ç–∫—Å–ø–æ—Ä—Ç–∞.');
                }
                return;
            }

            const wb = XLSX.utils.book_new();

            const selectEl = document.getElementById('excelScaleMode');
            const rawMode = selectEl ? String(selectEl.value || '').toLowerCase() : 'day';
            let scaleMode = 'day';
            if (rawMode.startsWith('week') || rawMode.startsWith('–Ω–µ–¥')) scaleMode = 'week';
            else if (rawMode.startsWith('month') || rawMode.startsWith('–º–µ—Å')) scaleMode = 'month';
            else if (rawMode.startsWith('year') || rawMode.startsWith('–≥–æ–¥')) scaleMode = 'year';

            const timelineUnits = buildExportTimeline(scaleMode);

            // –õ–∏—Å—Ç 1: –ì–∞–Ω—Ç –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–∞—Å—à—Ç–∞–±–µ
            if (timelineUnits.length) {
                const ganttSheetName = getExportScaleLabel(scaleMode);
                const ganttData = [];

                const headerRow = ['–ó–∞–¥–∞—á–∞', '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è', '–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π'];
                timelineUnits.forEach(unit => {
                    headerRow.push(unit.label);
                });
                ganttData.push(headerRow);

                tasks.forEach(task => {
                    const row = [
                        task.task,
                        task.startDate ? task.startDate.toLocaleDateString('ru-RU') : '',
                        task.endDate ? task.endDate.toLocaleDateString('ru-RU') : '',
                        task.days
                    ];

                    timelineUnits.forEach(unit => {
                        if (!task.startDate || !task.endDate || !Array.isArray(task.dates)) {
                            row.push('');
                            return;
                        }

                        const unitStart = unit.start.getTime();
                        const unitEnd = unit.end.getTime();
                        const hasWorkdayInUnit = task.dates.some(d => {
                            const t = d.getTime();
                            return t >= unitStart && t <= unitEnd;
                        });

                        row.push(hasWorkdayInUnit ? '‚ñ†' : '');
                    });

                    ganttData.push(row);
                });

                const ganttWs = XLSX.utils.aoa_to_sheet(ganttData);
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è –ª–∏—Å—Ç–∞ –ì–∞–Ω—Ç–∞
                const ganttCols = buildAutoColumnWidths(ganttData);
                
                // –°—Ç–æ–ª–±–µ—Ü A (–∏–Ω–¥–µ–∫—Å 0) - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —à–∏—Ä–∏–Ω–∞ –ø–æ —Å–∞–º–æ–π –¥–ª–∏–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
                // –ù–∞—Ö–æ–¥–∏–º —Å–∞–º—É—é –¥–ª–∏–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É –≤ –ø–µ—Ä–≤–æ–º —Å—Ç–æ–ª–±—Ü–µ
                let maxLength = 0;
                ganttData.forEach(row => {
                    if (row[0] && String(row[0]).length > maxLength) {
                        maxLength = String(row[0]).length;
                    }
                });
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Å—Ç–æ–ª–±—Ü–∞ A –ø–æ —Å–∞–º–æ–π –¥–ª–∏–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ + –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø
                if (ganttCols[0]) {
                    ganttCols[0].wch = Math.max(20, maxLength + 2); // –º–∏–Ω–∏–º—É–º 20, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ
                }
                
                // –°—Ç–æ–ª–±–µ—Ü B (–∏–Ω–¥–µ–∫—Å 1) - "–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞" - —à–∏—Ä–∏–Ω–∞ 15
                if (ganttCols[1]) ganttCols[1].wch = 15;
                // –°—Ç–æ–ª–±–µ—Ü C (–∏–Ω–¥–µ–∫—Å 2) - "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è" - —à–∏—Ä–∏–Ω–∞ 15
                if (ganttCols[2]) ganttCols[2].wch = 15;
                // –°—Ç–æ–ª–±–µ—Ü D (–∏–Ω–¥–µ–∫—Å 3) - "–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π" - —à–∏—Ä–∏–Ω–∞ 15
                if (ganttCols[3]) ganttCols[3].wch = 15;
                // –°—Ç–æ–ª–±—Ü—ã E –∏ –¥–∞–ª–µ–µ (–∏–Ω–¥–µ–∫—Å 4+) - –¥–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞ - —à–∏—Ä–∏–Ω–∞ 10
                for (let i = 4; i < ganttCols.length; i++) {
                    if (ganttCols[i]) ganttCols[i].wch = 10;
                }
                ganttWs['!cols'] = ganttCols;

                // –ó–∞–∫—Ä–∞—à–∏–≤–∞–µ–º —è—á–µ–π–∫–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –ì–∞–Ω—Ç–∞ —Ü–≤–µ—Ç–æ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏.
                // –ö–æ–ª–æ–Ω–∫–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –∏–Ω–¥–µ–∫—Å–∞ 4 (0-based) ‚Äî –ø–æ—Å–ª–µ –±–∞–∑–æ–≤—ã—Ö –ø–æ–ª–µ–π.
                const ganttStartCol = 4;

                // –¶–≤–µ—Ç–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ü–≤–µ—Ç–∞–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:
                // —Å–∏–Ω–∏–π (–ø–ª–∞–Ω), –æ—Ä–∞–Ω–∂–µ–≤—ã–π (–≤ —Ä–∞–±–æ—Ç–µ), –∑–µ–ª—ë–Ω—ã–π (–∑–∞–≤–µ—Ä—à–µ–Ω–æ),
                // —Ä–æ–∑–æ–≤—ã–π (—Ä—É—á–Ω–æ–π –≤—ã—Ö–æ–¥–Ω–æ–π), –∂—ë–ª—Ç—ã–π (—Ä—É—á–Ω–æ–π –ø—Ä–∞–∑–¥–Ω–∏–∫).
                const fillStyles = {
                    pending: {
                        patternType: 'solid',
                        fgColor: { rgb: 'FF1E88E5' },
                        bgColor: { rgb: 'FF1E88E5' }
                    },
                    'in-progress': {
                        patternType: 'solid',
                        fgColor: { rgb: 'FFFF9800' },
                        bgColor: { rgb: 'FFFF9800' }
                    },
                    completed: {
                        patternType: 'solid',
                        fgColor: { rgb: 'FF4CAF50' },
                        bgColor: { rgb: 'FF4CAF50' }
                    },
                    'weekend-manual': {
                        patternType: 'solid',
                        fgColor: { rgb: 'FFFFE0E0' },
                        bgColor: { rgb: 'FFFFE0E0' }
                    }
                };

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ B, C, D (–∏–Ω–¥–µ–∫—Å—ã 1, 2, 3)
                // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å—Ç—Ä–æ–∫–∞–º (–≤–∫–ª—é—á–∞—è –∑–∞–≥–æ–ª–æ–≤–æ–∫)
                for (let rowIdx = 0; rowIdx < ganttData.length; rowIdx++) {
                    // –°—Ç–æ–ª–±–µ—Ü B (–∏–Ω–¥–µ–∫—Å 1) - "–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞"
                    const addrB = XLSX.utils.encode_cell({ c: 1, r: rowIdx });
                    if (ganttWs[addrB]) {
                        ganttWs[addrB].s = ganttWs[addrB].s || {};
                        ganttWs[addrB].s.alignment = { horizontal: 'center', vertical: 'center' };
                    }
                    // –°—Ç–æ–ª–±–µ—Ü C (–∏–Ω–¥–µ–∫—Å 2) - "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è"
                    const addrC = XLSX.utils.encode_cell({ c: 2, r: rowIdx });
                    if (ganttWs[addrC]) {
                        ganttWs[addrC].s = ganttWs[addrC].s || {};
                        ganttWs[addrC].s.alignment = { horizontal: 'center', vertical: 'center' };
                    }
                    // –°—Ç–æ–ª–±–µ—Ü D (–∏–Ω–¥–µ–∫—Å 3) - "–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π"
                    const addrD = XLSX.utils.encode_cell({ c: 3, r: rowIdx });
                    if (ganttWs[addrD]) {
                        ganttWs[addrD].s = ganttWs[addrD].s || {};
                        ganttWs[addrD].s.alignment = { horizontal: 'center', vertical: 'center' };
                    }
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å—Ç–æ–ª–±—Ü–æ–≤ E+ (–¥–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞)
                // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ (rowIdx = 0), —Å—Ç–æ–ª–±—Ü—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –∏–Ω–¥–µ–∫—Å–∞ 4
                for (let colIdx = 4; colIdx < ganttCols.length; colIdx++) {
                    const addr = XLSX.utils.encode_cell({ c: colIdx, r: 0 });
                    if (ganttWs[addr]) {
                        ganttWs[addr].s = ganttWs[addr].s || {};
                        ganttWs[addr].s.alignment = { horizontal: 'center', vertical: 'center' };
                    }
                }

                tasks.forEach((task, taskIdx) => {
                    // –í ganttData –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ (r=0) ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫,
                    // –¥–∞–ª–µ–µ –∏–¥—É—Ç —Å—Ç—Ä–æ–∫–∏ –∑–∞–¥–∞—á (r=1 + taskIdx)
                    const excelRow = 1 + taskIdx;
                    timelineUnits.forEach((unit, unitIdx) => {
                        const col = ganttStartCol + unitIdx;
                        const addr = XLSX.utils.encode_cell({ c: col, r: excelRow });
                        const cell = ganttWs[addr];
                        if (!cell || !cell.v) return; // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏

                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –≤—Ä–µ–º–µ–Ω–∏.
                        // –ï—Å–ª–∏ –º–∞—Å—à—Ç–∞–± = "–¥–Ω–∏" ‚Äî —Å—Ç—Ä–æ–≥–æ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –¥–Ω—è–º, –∫–∞–∫ –Ω–∞ –ì–∞–Ω—Ç–µ:
                        // –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –∏ –µ–≥–æ —Å—Ç–∞—Ç—É—Å –≤ dateStatuses
                        // (–∏–ª–∏ "pending", –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ—Ç). –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º.
                        let intervalStatus = 'pending';
                        const unitStart = unit.start.getTime();
                        const unitEnd = unit.end.getTime();

                        if (scaleMode === 'day') {
                            if (Array.isArray(task.dates) && task.dates.length) {
                                const day = task.dates.find(d => {
                                    const t = d.getTime();
                                    return t >= unitStart && t <= unitEnd;
                                });
                                if (day) {
                                    const key = formatDateKey(day);
                                    if (task.dateStatuses && task.dateStatuses[key]) {
                                        intervalStatus = task.dateStatuses[key];
                                    } else {
                                        intervalStatus = 'pending';
                                    }
                                }
                            }
                        } else if (task.dateStatuses) {
                            // –î–ª—è –Ω–µ–¥–µ–ª—å/–º–µ—Å—è—Ü–µ–≤/–≥–æ–¥–æ–≤ –∞–≥—Ä–µ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å—ã –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ
                            const statusesInUnit = new Set();
                            task.dates.forEach(d => {
                                const t = d.getTime();
                                if (t < unitStart || t > unitEnd) return;
                                const key = formatDateKey(d);
                                const s = task.dateStatuses[key];
                                if (s) statusesInUnit.add(s);
                            });

                            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –∑–∞–≤–µ—Ä—à–µ–Ω–æ > –≤ —Ä–∞–±–æ—Ç–µ > –≤—ã—Ö–æ–¥–Ω–æ–π > –ø–ª–∞–Ω
                            if (statusesInUnit.has('completed')) intervalStatus = 'completed';
                            else if (statusesInUnit.has('in-progress')) intervalStatus = 'in-progress';
                            else if (statusesInUnit.has('weekend-manual')) intervalStatus = 'weekend-manual';
                            else if (task.status) intervalStatus = task.status;
                            else intervalStatus = 'pending';
                        } else if (task.status) {
                            intervalStatus = task.status;
                        }

                        // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –¥–∞—Ç–∞–º –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—É—â–µ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –≤—Ä–µ–º–µ–Ω–∏
                        let commentsLines = [];
                        if (task.dateComments) {
                            task.dates.forEach(d => {
                                const t = d.getTime();
                                if (t < unitStart || t > unitEnd) return;
                                const key = formatDateKey(d);
                                const comment = task.dateComments[key];
                                if (comment && comment.trim().length > 0) {
                                    commentsLines.push(`${key}: ${comment.trim()}`);
                                }
                            });
                        }

                        const fill = fillStyles[intervalStatus] || fillStyles.pending;
                        cell.s = cell.s || {};
                        cell.s.fill = fill;
                        cell.s.alignment = cell.s.alignment || { horizontal: 'center', vertical: 'center' };

                        // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –¥–∞—Ç–∞–º –¥–ª—è —ç—Ç–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö
                        // –∫–∞–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π Excel (note), —á—Ç–æ–±—ã –±—ã–ª–∏ –≤–∏–¥–Ω—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –≤ Excel.
                        if (commentsLines.length > 0) {
                            const noteText = commentsLines.join('\n');
                            cell.c = cell.c || [];
                            cell.c.push({ t: noteText });
                        }
                    });
                });

                // –ü—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∫–æ –≤—Å–µ–º —è—á–µ–π–∫–∞–º —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ –ª–∏—Å—Ç–µ –ì–∞–Ω—Ç–∞
                applyBordersToSheet(ganttWs);

                XLSX.utils.book_append_sheet(wb, ganttWs, ganttSheetName);
            }

            // –õ–∏—Å—Ç 2: —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á –∫–∞–∫ –µ—Å—Ç—å
            const wsData = [
                [`–ì—Ä–∞—Ñ–∏–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏ –æ–±—É—á–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã ${chartTypeContainerName}`],
                [],
                ['‚Ññ –ø/–ø', '–≠—Ç–∞–ø', '–í–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è', '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ', '–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π', '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –¥–∞—Ç–∞–º']
            ];

            tasks.forEach((task, index) => {
                let commentsSummary = '';
                if (task.dateComments) {
                    const entries = Object.entries(task.dateComments)
                        .filter(([, text]) => text && String(text).trim().length > 0)
                        .sort(([d1], [d2]) => (d1 < d2 ? -1 : d1 > d2 ? 1 : 0))
                        .map(([date, text]) => `${date}: ${String(text).trim()}`);
                    commentsSummary = entries.join('; ');
                }

                wsData.push([
                    index + 1,
                    task.stage,
                    task.control,
                    task.task,
                    task.days,
                    task.responsible || '',
                    task.startDate.toLocaleDateString('ru-RU'),
                    task.endDate.toLocaleDateString('ru-RU'),
                    commentsSummary
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            // –ê–≤—Ç–æ‚Äë–ø–æ–¥–±–æ—Ä —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è —Ç–∞–±–ª–∏—á–Ω–æ–≥–æ –ª–∏—Å—Ç–∞
            const wsCols = buildAutoColumnWidths(wsData);
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è –ª–∏—Å—Ç–∞ "–ó–∞–¥–∞—á–∏"
            // –°—Ç–æ–ª–±–µ—Ü A (‚Ññ –ø/–ø) - —à–∏—Ä–∏–Ω–∞ 7, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É
            if (wsCols[0]) {
                wsCols[0].wch = 7;
            }
            // –°—Ç–æ–ª–±—Ü—ã B, C, D (–≠—Ç–∞–ø, –í–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è, –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ) - –ø–æ —Å–∞–º–æ–π –¥–ª–∏–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
            // –°—Ç–æ–ª–±–µ—Ü E (–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π) - —à–∏—Ä–∏–Ω–∞ 13, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É
            if (wsCols[4]) {
                wsCols[4].wch = 13;
            }
            // –°—Ç–æ–ª–±–µ—Ü F (–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π) - –ø–æ —Å–∞–º–æ–π –¥–ª–∏–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
            // –°—Ç–æ–ª–±—Ü—ã G, H (–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞, –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è) - —à–∏—Ä–∏–Ω–∞ 15
            if (wsCols[6]) wsCols[6].wch = 15;
            if (wsCols[7]) wsCols[7].wch = 15;
            // –°—Ç–æ–ª–±–µ—Ü I (–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏) - –ø–æ —Å–∞–º–æ–π –¥–ª–∏–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
            
            ws['!cols'] = wsCols;
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –ø–æ —Ü–µ–Ω—Ç—Ä—É –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ A –∏ E
            const range = XLSX.utils.decode_range(ws['!ref'] || 'A1');
            for (let row = 0; row <= range.e.r; row++) {
                // –°—Ç–æ–ª–±–µ—Ü A (‚Ññ –ø/–ø) - –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É
                const cellA = XLSX.utils.encode_cell({ c: 0, r: row });
                if (ws[cellA]) {
                    if (!ws[cellA].s) ws[cellA].s = {};
                    if (!ws[cellA].s.alignment) ws[cellA].s.alignment = {};
                    ws[cellA].s.alignment.horizontal = 'center';
                    ws[cellA].s.alignment.vertical = 'center';
                }
                // –°—Ç–æ–ª–±–µ—Ü E (–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π) - –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É
                const cellE = XLSX.utils.encode_cell({ c: 4, r: row });
                if (ws[cellE]) {
                    if (!ws[cellE].s) ws[cellE].s = {};
                    if (!ws[cellE].s.alignment) ws[cellE].s.alignment = {};
                    ws[cellE].s.alignment.horizontal = 'center';
                    ws[cellE].s.alignment.vertical = 'center';
                }
            }

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∫–æ –≤—Å–µ–º —è—á–µ–π–∫–∞–º —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ –ª–∏—Å—Ç–µ –∑–∞–¥–∞—á
            applyBordersToSheet(ws);

            XLSX.utils.book_append_sheet(wb, ws, '–ó–∞–¥–∞—á–∏');

            // –õ–∏—Å—Ç —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
            XLSX.writeFile(wb, generateExportFileName('xlsx'));
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            loadingIndicator.textContent = 'Excel –≥–æ—Ç–æ–≤!';
            setTimeout(() => {
                if (loadingIndicator.parentNode) {
                    document.body.removeChild(loadingIndicator);
                }
            }, 3000); // 3 —Å–µ–∫—É–Ω–¥—ã
        }

        function openExcelExportModal() {
            // –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –≤—ã–±–æ—Ä–æ–º —Ñ–æ—Ä–º–∞—Ç–∞
            openPDFExportModal('excel');
        }

        function closeExcelExportModal() {
            const modal = document.getElementById('excelExportModal');
            if (modal) {
                modal.style.display = 'none';
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.position = '';
                    modalContent.style.top = '';
                    modalContent.style.left = '';
                    modalContent.style.transform = '';
                    modalContent.style.margin = '';
                    modalContent.style.width = '';
                    modalContent.style.maxWidth = '';
                }
            }
        }

        function confirmExcelExport() {
            closeExcelExportModal();
            exportExcel();
        }

        function confirmExportByFormat() {
            const formatSelect = document.getElementById('exportFormatSelect');
            const format = formatSelect ? String(formatSelect.value || 'pdf').toLowerCase() : 'pdf';
            if (format === 'excel') {
                closePDFExportModal();
                exportExcel();
            } else {
                confirmPDFExport();
            }
        }

        function handleExportFormatChange() {
            const formatSelect = document.getElementById('exportFormatSelect');
            const format = formatSelect ? String(formatSelect.value || 'pdf').toLowerCase() : 'pdf';
            const pdfSection = document.getElementById('pdfExportSection');
            const excelSection = document.getElementById('excelExportSection');
            
            if (pdfSection) {
                pdfSection.style.display = format === 'pdf' ? 'block' : 'none';
            }
            if (excelSection) {
                excelSection.style.display = format === 'excel' ? 'block' : 'none';
            }
            
            if (format === 'pdf') {
                updatePDFPreview();
            }
        }

        // ========== –§–£–ù–ö–¶–ò–ò –ü–û–ò–°–ö–ê ==========
        
        let searchResults = [];
        let currentSearchIndex = -1;
        let searchHighlightedTasks = new Set();

        function openSearchModal() {
            // –§—É–Ω–∫—Ü–∏—è –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
            }
        }

        function closeSearchModal() {
            // –û—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            clearSearchHighlight();
            searchResults = [];
            currentSearchIndex = -1;
            updateSearchNavigation();
        }

        function performSearch() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            const query = searchInput.value.trim().toLowerCase();
            
            if (!query) {
                clearSearchResults();
                clearSearchHighlight();
                return;
            }

            // –ü–æ–∏—Å–∫ –ø–æ –∑–∞–¥–∞—á–∞–º
            searchResults = tasks.filter((task, index) => {
                const taskName = (task.task || task.name || '').toLowerCase();
                const stage = (task.stage || '').toLowerCase();
                const responsible = (task.responsible || '').toLowerCase();
                
                return taskName.includes(query) || 
                       stage.includes(query) || 
                       responsible.includes(query);
            });

            currentSearchIndex = -1;
            
            // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç—Ç–∞–ø—ã, –≥–¥–µ –µ—Å—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            const stagesWithResults = new Set();
            searchResults.forEach(task => {
                const taskStage = task.stage || '–ë–µ–∑ —ç—Ç–∞–ø–∞';
                stagesWithResults.add(taskStage);
            });
            
            // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º —ç—Ç–∞–ø—ã
            let needsRerender = false;
            stagesWithResults.forEach(stageName => {
                if (collapsedStages.has(stageName)) {
                    collapsedStages.delete(stageName);
                    needsRerender = true;
                }
            });
            
            if (needsRerender) {
                renderGantt();
                renderTable();
                // –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ —Å–Ω–æ–≤–∞ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                setTimeout(() => {
                    highlightSearchResults();
                    updateSearchNavigation();
                }, 100);
            } else {
                highlightSearchResults();
                updateSearchNavigation();
            }
        }

        function clearSearchResults() {
            searchResults = [];
            currentSearchIndex = -1;
            clearSearchHighlight();
            updateSearchNavigation();
        }

        function getPluralForm(count, one, few, many) {
            const mod10 = count % 10;
            const mod100 = count % 100;
            
            if (mod100 >= 11 && mod100 <= 19) return many;
            if (mod10 === 1) return one;
            if (mod10 >= 2 && mod10 <= 4) return few;
            return many;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function highlightSearchResults() {
            clearSearchHighlight();
            const activeTaskId = currentSearchIndex >= 0 && searchResults[currentSearchIndex] ? searchResults[currentSearchIndex].id : null;
            
            searchResults.forEach(task => {
                searchHighlightedTasks.add(task.id);
            });

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ (–≥–æ–ª—É–±–æ–≤–∞—Ç—ã–π —Ü–≤–µ—Ç)
            document.querySelectorAll('#tasksTableBody tr').forEach(tr => {
                const taskId = parseInt(tr.dataset.taskId);
                if (searchHighlightedTasks.has(taskId)) {
                    const isActive = activeTaskId === taskId;
                    tr.style.backgroundColor = isActive ? '#64b5f6' : '#e3f2fd';
                    tr.style.borderLeft = isActive ? '4px solid #0d47a1' : '4px solid #2196f3';
                }
            });

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤ –¥–∏–∞–≥—Ä–∞–º–º–µ –ì–∞–Ω—Ç–∞ (–≥–æ–ª—É–±–æ–≤–∞—Ç—ã–π —Ü–≤–µ—Ç)
            document.querySelectorAll('.gantt-row').forEach(row => {
                const taskId = parseInt(row.dataset.taskId);
                if (searchHighlightedTasks.has(taskId)) {
                    const isActive = activeTaskId === taskId;
                    row.style.backgroundColor = isActive ? '#64b5f6' : '#e3f2fd';
                    row.style.borderLeft = isActive ? '4px solid #0d47a1' : '4px solid #2196f3';
                }
            });
            
            updateSearchNavigation();
        }

        function clearSearchHighlight() {
            searchHighlightedTasks.clear();
            
            // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            document.querySelectorAll('#tasksTableBody tr').forEach(tr => {
                tr.style.backgroundColor = '';
                tr.style.borderLeft = '';
            });

            // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∏–∑ –¥–∏–∞–≥—Ä–∞–º–º—ã –ì–∞–Ω—Ç–∞
            document.querySelectorAll('.gantt-row').forEach(row => {
                row.style.backgroundColor = '';
                row.style.borderLeft = '';
            });
        }

        function selectSearchResult(index) {
            if (index < 0 || index >= searchResults.length) return;
            
            currentSearchIndex = index;
            const task = searchResults[index];
            
            // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º —ç—Ç–∞–ø, –µ—Å–ª–∏ –æ–Ω —Å–≤–µ—Ä–Ω—É—Ç
            const taskStage = task.stage || '–ë–µ–∑ —ç—Ç–∞–ø–∞';
            if (collapsedStages.has(taskStage)) {
                collapsedStages.delete(taskStage);
                renderGantt();
                renderTable();
            }
            
            // –í—ã–¥–µ–ª—è–µ–º –∑–∞–¥–∞—á—É
            selectTask(task.id, { range: false });
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –∑–∞–¥–∞—á–µ
            setTimeout(() => {
                const row = document.querySelector(`.gantt-row[data-task-id="${task.id}"]`);
                if (row) {
                    row.scrollIntoView({ block: 'center', behavior: 'smooth' });
                }
                
                const tableRow = document.querySelector(`#tasksTableBody tr[data-task-id="${task.id}"]`);
                if (tableRow) {
                    tableRow.scrollIntoView({ block: 'center', behavior: 'smooth' });
                }
            }, 100);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            highlightSearchResults();
            updateSearchNavigation();
        }

        function updateSearchNavigation() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ DOM –æ–±–Ω–æ–≤–ª–µ–Ω
            setTimeout(() => {
                const searchNav = document.getElementById('searchNavigation');
                const searchCounter = document.getElementById('searchCounter');
                const searchPrevBtn = document.getElementById('searchPrevBtn');
                const searchNextBtn = document.getElementById('searchNextBtn');
                
                if (!searchNav || !searchCounter) {
                    return;
                }
                
                if (searchResults.length > 0) {
                    searchNav.style.display = 'flex';
                    searchNav.style.visibility = 'visible';
                    const current = currentSearchIndex >= 0 ? currentSearchIndex + 1 : 0;
                    searchCounter.textContent = current > 0 ? `${current} –∏–∑ ${searchResults.length}` : `–ù–∞–π–¥–µ–Ω–æ: ${searchResults.length}`;
                    
                    if (searchPrevBtn) {
                        searchPrevBtn.disabled = false;
                        searchPrevBtn.style.opacity = '1';
                        searchPrevBtn.style.cursor = 'pointer';
                        searchPrevBtn.style.visibility = 'visible';
                    }
                    if (searchNextBtn) {
                        searchNextBtn.disabled = false;
                        searchNextBtn.style.opacity = '1';
                        searchNextBtn.style.cursor = 'pointer';
                        searchNextBtn.style.visibility = 'visible';
                    }
                } else {
                    searchNav.style.display = 'none';
                    searchNav.style.visibility = 'hidden';
                }
            }, 0);
        }

        function navigateToFirstResult() {
            if (searchResults.length === 0) return;
            selectSearchResult(0);
        }

        function navigateSearchResults(direction) {
            if (searchResults.length === 0) return;
            
            if (direction > 0) {
                // –í–ø–µ—Ä—ë–¥
                if (currentSearchIndex < 0) {
                    currentSearchIndex = 0;
                } else {
                    currentSearchIndex = (currentSearchIndex + 1) % searchResults.length;
                }
            } else {
                // –ù–∞–∑–∞–¥
                if (currentSearchIndex <= 0) {
                    currentSearchIndex = searchResults.length - 1;
                } else {
                    currentSearchIndex = currentSearchIndex - 1;
                }
            }
            
            selectSearchResult(currentSearchIndex);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞
        function initSearch() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                // –ü–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ (—Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π)
                let searchTimeout;
                searchInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        performSearch();
                    }, 300);
                });

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –ø–µ—Ä–≤–æ–π –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∑–∞–¥–∞—á–µ
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (searchResults.length > 0) {
                            if (e.shiftKey) {
                                navigateSearchResults(-1);
                            } else {
                                navigateSearchResults(1);
                            }
                        }
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        closeSearchModal();
                    }
                });

                // –°—Ç–∏–ª–∏ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
                searchInput.addEventListener('focus', () => {
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    searchInput.style.borderColor = isDark ? '#42a5f5' : '#2196f3';
                });

                searchInput.addEventListener('blur', () => {
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    searchInput.style.borderColor = isDark ? 'var(--color-border)' : '#e0e0e0';
                });
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ Ctrl+Enter –¥–ª—è —Ñ–æ–∫—É—Å–∞ –Ω–∞ –ø–æ–∏—Å–∫
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                    }
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ—Å–∞–π–∑–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ PDF
        function initPDFModalResize() {
            const modal = document.getElementById('pdfExportModal');
            const modalContent = modal ? modal.querySelector('.modal-content') : null;
            
            if (!modal || !modalContent) return;
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ö–µ–Ω–¥–ª—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            const oldHandles = modalContent.querySelectorAll('.resize-handle');
            oldHandles.forEach(handle => handle.remove());
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ —É–∂–µ —Ä–µ—Å–∞–π–∑
            if (modalContent.dataset.resizeInitialized === 'true') {
                return;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            if (!modalContent.style.width) {
                modalContent.style.width = '90%';
            }
            if (!modalContent.style.height) {
                modalContent.style.height = '85vh';
            }
            modalContent.style.position = 'relative';
            modalContent.style.margin = 'auto';
            
            // –°–æ–∑–¥–∞–µ–º —Ä–µ—Å–∞–π–∑-—Ö–µ–Ω–¥–ª—ã
            const handles = [
                { class: 'resize-handle-nw', cursor: 'nw-resize' },
                { class: 'resize-handle-ne', cursor: 'ne-resize' },
                { class: 'resize-handle-sw', cursor: 'sw-resize' },
                { class: 'resize-handle-se', cursor: 'se-resize' },
                { class: 'resize-handle-n', cursor: 'n-resize' },
                { class: 'resize-handle-s', cursor: 's-resize' },
                { class: 'resize-handle-w', cursor: 'w-resize' },
                { class: 'resize-handle-e', cursor: 'e-resize' }
            ];
            
            handles.forEach(handleConfig => {
                const handle = document.createElement('div');
                handle.className = `resize-handle ${handleConfig.class}`;
                handle.style.cursor = handleConfig.cursor;
                modalContent.appendChild(handle);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ä–µ—Å–∞–π–∑–∞
                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const startX = e.clientX;
                    const startY = e.clientY;
                    const startWidth = modalContent.offsetWidth;
                    const startHeight = modalContent.offsetHeight;
                    const modalRect = modal.getBoundingClientRect();
                    const contentRect = modalContent.getBoundingClientRect();
                    const startLeft = contentRect.left - modalRect.left;
                    const startTop = contentRect.top - modalRect.top;
                    
                    const isNW = handleConfig.class.includes('nw');
                    const isNE = handleConfig.class.includes('ne');
                    const isSW = handleConfig.class.includes('sw');
                    const isSE = handleConfig.class.includes('se');
                    const isN = handleConfig.class.includes('-n') && !isNW && !isNE;
                    const isS = handleConfig.class.includes('-s') && !isSW && !isSE;
                    const isW = handleConfig.class.includes('-w') && !isNW && !isSW;
                    const isE = handleConfig.class.includes('-e') && !isNE && !isSE;
                    
                    const onMouseMove = (e) => {
                        const deltaX = e.clientX - startX;
                        const deltaY = e.clientY - startY;
                        
                        let newWidth = startWidth;
                        let newHeight = startHeight;
                        let newLeft = startLeft;
                        let newTop = startTop;
                        
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–µ—Å–∞–π–∑–∞
                        if (isE || isNE || isSE) {
                            newWidth = Math.max(800, startWidth + deltaX);
                        } else if (isW || isNW || isSW) {
                            newWidth = Math.max(800, startWidth - deltaX);
                            newLeft = startLeft + deltaX;
                        }
                        
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Ä–µ—Å–∞–π–∑–∞
                        if (isS || isSW || isSE) {
                            newHeight = Math.max(600, startHeight + deltaY);
                        } else if (isN || isNW || isNE) {
                            newHeight = Math.max(600, startHeight - deltaY);
                            newTop = startTop + deltaY;
                        }
                        
                        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
                        const maxWidth = window.innerWidth * 0.98;
                        const maxHeight = window.innerHeight * 0.98;
                        newWidth = Math.min(newWidth, maxWidth);
                        newHeight = Math.min(newHeight, maxHeight);
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        modalContent.style.width = newWidth + 'px';
                        modalContent.style.height = newHeight + 'px';
                        
                        // –ï—Å–ª–∏ –∏–∑–º–µ–Ω—è–µ–º –ª–µ–≤—ã–π –∏–ª–∏ –≤–µ—Ä—Ö–Ω–∏–π –∫—Ä–∞–π, –Ω—É–∂–Ω–æ —Å–¥–≤–∏–Ω—É—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                        if (isW || isNW || isSW) {
                            // –ò–∑–º–µ–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–ª–µ–≤–∞
                            const deltaLeft = startWidth - newWidth;
                            const newLeft = startLeft + deltaLeft;
                            modalContent.style.left = newLeft + 'px';
                            modalContent.style.marginLeft = '0';
                        } else {
                            // –ï—Å–ª–∏ –Ω–µ –∏–∑–º–µ–Ω—è–µ–º –ª–µ–≤—É—é —Å—Ç–æ—Ä–æ–Ω—É, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
                            modalContent.style.left = 'auto';
                            modalContent.style.marginLeft = 'auto';
                        }
                        
                        if (isN || isNW || isNE) {
                            // –ò–∑–º–µ–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–≤–µ—Ä—Ö—É
                            const deltaTop = startHeight - newHeight;
                            const newTop = startTop + deltaTop;
                            modalContent.style.top = newTop + 'px';
                            modalContent.style.marginTop = '0';
                        } else {
                            // –ï—Å–ª–∏ –Ω–µ –∏–∑–º–µ–Ω—è–µ–º –≤–µ—Ä—Ö–Ω—é—é —Å—Ç–æ—Ä–æ–Ω—É, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
                            modalContent.style.top = 'auto';
                            modalContent.style.marginTop = 'auto';
                        }
                    };
                    
                    const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                    };
                    
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                    document.body.style.cursor = handleConfig.cursor;
                    document.body.style.userSelect = 'none';
                });
            });
            
            // –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ —Ä–µ—Å–∞–π–∑ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
            modalContent.dataset.resizeInitialized = 'true';
        }
        
        function openPDFExportModal(defaultFormat = 'pdf') {
            const modal = document.getElementById('pdfExportModal');
            if (modal) {
                modal.style.display = 'block';
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–µ–∫—Ü–∏–∏
                const formatSelect = document.getElementById('exportFormatSelect');
                if (formatSelect) {
                    formatSelect.value = defaultFormat || 'pdf';
                }
                handleExportFormatChange();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ—Å–∞–π–∑ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                initPDFModalResize();
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                if ((defaultFormat || 'pdf') === 'pdf') {
                    setTimeout(() => {
                        updatePDFPreview();
                    }, 100);
                }
                
                // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π
                const isMobile = window.innerWidth <= 1024;
                if (isMobile) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
                    requestAnimationFrame(() => {
                        // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –∑–∞–ø—É—Å–∫–∞ –º–æ–¥–∞–ª–∫–∏
                        const pdfButton = document.getElementById('exportUnifiedButton');
                        
                        if (pdfButton) {
                            const modalContent = modal.querySelector('.modal-content');
                            if (modalContent) {
                                const buttonRect = pdfButton.getBoundingClientRect();
                                
                                // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–æ –±—ã–ª–æ –≤–∏–¥–Ω–æ —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π
                                // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é: –µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –≤ –Ω–∏–∂–Ω–µ–π –ø–æ–ª–æ–≤–∏–Ω–µ —ç–∫—Ä–∞–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–¥ –Ω–µ–π, –∏–Ω–∞—á–µ - –ø–æ–¥ –Ω–µ–π
                                const viewportHeight = window.innerHeight;
                                const buttonBottom = buttonRect.bottom;
                                const spaceBelow = viewportHeight - buttonBottom;
                                const spaceAbove = buttonRect.top;
                                
                                // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport (—Ç–∞–∫ –∫–∞–∫ modal –∏–º–µ–µ—Ç position: fixed)
                                let topPosition;
                                if (spaceBelow < 500 && spaceAbove > spaceBelow) {
                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–¥ –∫–Ω–æ–ø–∫–æ–π
                                    topPosition = buttonRect.top - 550; // –≤—ã—Å–æ—Ç–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–≤–µ–ª–∏—á–∏–ª–∞—Å—å
                                } else {
                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π
                                    topPosition = buttonRect.bottom + 20; // –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø
                                }
                                
                                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ–∫–Ω–æ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞
                                const minTop = 20;
                                const maxTop = viewportHeight - 600;
                                topPosition = Math.max(minTop, Math.min(topPosition, maxTop));
                                
                                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ —Å !important —á–µ—Ä–µ–∑ setProperty –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è CSS
                                modalContent.style.setProperty('position', 'absolute', 'important');
                                modalContent.style.setProperty('top', topPosition + 'px', 'important');
                                modalContent.style.setProperty('left', '50%', 'important');
                                modalContent.style.setProperty('transform', 'translateX(-50%)', 'important');
                                modalContent.style.setProperty('margin', '0', 'important');
                                modalContent.style.setProperty('width', 'calc(100% - 40px)', 'important');
                                modalContent.style.setProperty('max-width', '900px', 'important');
                            }
                        }
                    });
                } else {
                    // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ CSS)
                    const modalContent = modal.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.style.position = '';
                        modalContent.style.top = '';
                        modalContent.style.left = '';
                        modalContent.style.transform = '';
                        modalContent.style.margin = '';
                        modalContent.style.width = '';
                        modalContent.style.maxWidth = '';
                    }
                }
            }
        }

        function closePDFExportModal() {
            const modal = document.getElementById('pdfExportModal');
            if (modal) {
                modal.style.display = 'none';
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ—Å–∞–π–∑
                    modalContent.dataset.resizeInitialized = 'false';
                    modalContent.style.position = '';
                    modalContent.style.top = '';
                    modalContent.style.left = '';
                    modalContent.style.transform = '';
                    modalContent.style.margin = '';
                    modalContent.style.width = '';
                    modalContent.style.height = '';
                    modalContent.style.maxWidth = '';
                    modalContent.style.maxHeight = '';
                }
            }
        }

        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –º–∞–∫–µ—Ç–æ–≤ –æ—Ç—Å—Ç—É–ø–æ–≤
        let pdfLayouts = JSON.parse(localStorage.getItem('pdfLayouts') || '{}');
        let currentPageMargins = {}; // –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        
        // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞–∫–µ—Ç–∞
        function savePDFLayout() {
            const layoutName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–∫–µ—Ç–∞:', '–ú–∞–∫–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
            if (!layoutName) return;
            
            const layout = {
                defaultMargins: {
                    top: parseFloat(document.getElementById('pdfMarginTop')?.value || 10),
                    bottom: parseFloat(document.getElementById('pdfMarginBottom')?.value || 20),
                    left: parseFloat(document.getElementById('pdfMarginLeft')?.value || 5),
                    right: parseFloat(document.getElementById('pdfMarginRight')?.value || 5)
                },
                pageMargins: currentPageMargins,
                timestamp: new Date().toISOString()
            };
            
            pdfLayouts[layoutName] = layout;
            localStorage.setItem('pdfLayouts', JSON.stringify(pdfLayouts));
            alert(`–ú–∞–∫–µ—Ç "${layoutName}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω!`);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–∫–µ—Ç–∞
        function loadPDFLayout() {
            const layoutNames = Object.keys(pdfLayouts);
            if (layoutNames.length === 0) {
                alert('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–∞–∫–µ—Ç–æ–≤');
                return;
            }
            
            const layoutName = prompt(`–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–∫–µ—Ç:\n${layoutNames.join('\n')}\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:`, layoutNames[0]);
            if (!layoutName || !pdfLayouts[layoutName]) return;
            
            const layout = pdfLayouts[layoutName];
            document.getElementById('pdfMarginTop').value = layout.defaultMargins.top;
            document.getElementById('pdfMarginBottom').value = layout.defaultMargins.bottom;
            document.getElementById('pdfMarginLeft').value = layout.defaultMargins.left;
            document.getElementById('pdfMarginRight').value = layout.defaultMargins.right;
            
            if (layout.pageMargins) {
                currentPageMargins = layout.pageMargins;
            }
            
            updatePDFPreview();
            alert(`–ú–∞–∫–µ—Ç "${layoutName}" –∑–∞–≥—Ä—É–∂–µ–Ω!`);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ—Ç—Å—Ç—É–ø–æ–≤ –∫–æ –≤—Å–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
        function applyMarginsToAll() {
            const margins = {
                top: parseFloat(document.getElementById('pdfMarginTop')?.value || 10),
                bottom: parseFloat(document.getElementById('pdfMarginBottom')?.value || 20),
                left: parseFloat(document.getElementById('pdfMarginLeft')?.value || 5),
                right: parseFloat(document.getElementById('pdfMarginRight')?.value || 5)
            };
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ –≤—Å–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ
            const pageElements = document.querySelectorAll('.pdf-preview-page-wrapper');
            pageElements.forEach((pageEl, index) => {
                const pageId = `page-${index}`;
                currentPageMargins[pageId] = { ...margins };
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–ø—É—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                const inputs = pageEl.querySelectorAll('.page-margin-input');
                inputs[0].value = margins.top;
                inputs[1].value = margins.bottom;
                inputs[2].value = margins.left;
                inputs[3].value = margins.right;
            });
            
            updatePDFPreview();
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–±–µ–∑ —ç–∫—Å–ø–æ—Ä—Ç–∞)
        async function createPDFPreviewContent(scaleMode, includeDiagram) {
            if (!tasks || !tasks.length) return null;
            
            const logoEl = document.getElementById('companyLogo');
            const nameDisplay = document.getElementById('companyNameDisplay');
            
            // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            const previewWrapper = document.createElement('div');
            previewWrapper.style.width = '420mm';
            previewWrapper.style.maxWidth = '100%';
            previewWrapper.style.margin = '0 auto';
            previewWrapper.style.background = '#ffffff';
            previewWrapper.style.fontFamily = window.getComputedStyle(document.body).fontFamily || 'sans-serif';
            previewWrapper.style.fontSize = '10px';
            previewWrapper.style.color = '#000';
            previewWrapper.style.visibility = 'visible';
            previewWrapper.style.display = 'block';
            previewWrapper.style.opacity = '1';
            previewWrapper.style.boxSizing = 'border-box';
            previewWrapper.style.overflow = 'visible';
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ exportPDF –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            // –ö–æ–ø–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏–∑ exportPDF
            // (—ç—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–∑–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞)
            
            // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —à–∞–ø–∫–∏
            const createHeader = (isFirstPage = false) => {
                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.alignItems = 'center';
                header.style.gap = '16px';
                header.style.marginBottom = '12px';
                
                if (logoEl) {
                    const logoClone = logoEl.cloneNode(true);
                    logoClone.style.width = '40px';
                    logoClone.style.height = '40px';
                    logoClone.style.borderRadius = '8px';
                    logoClone.style.border = '1px solid #e0e0e0';
                    logoClone.style.objectFit = 'contain';
                    logoClone.style.background = '#fafafa';
                    logoClone.style.padding = '4px';
                    header.appendChild(logoClone);
                }
                
                const nameBlock = document.createElement('div');
                const title = document.createElement('div');
                title.textContent = `–ì—Ä–∞—Ñ–∏–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏ –æ–±—É—á–µ–Ω–∏—è`;
                title.style.fontSize = '14px';
                title.style.fontWeight = '600';
                
                const company = document.createElement('div');
                const currentNameText = nameDisplay && nameDisplay.classList.contains('has-value')
                    ? (nameDisplay.innerText || nameDisplay.textContent) : '';
                company.innerText = currentNameText || '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏';
                company.style.marginTop = '2px';
                company.style.fontSize = '12px';
                company.style.fontWeight = '600';
                
                nameBlock.appendChild(title);
                nameBlock.appendChild(company);
                header.appendChild(nameBlock);
                
                return header;
            };
            
            // –°–æ–∑–¥–∞–µ–º —Å–µ–∫—Ü–∏—é –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            const section = document.createElement('div');
            section.className = 'pdf-page-section';
            section.style.width = '100%';
            section.style.padding = '10px';
            section.style.paddingBottom = '20px';
            section.style.background = '#ffffff';
            section.style.boxSizing = 'border-box';
            section.style.margin = '0';
            section.style.overflow = 'visible';
            
            section.appendChild(createHeader(true));
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
            const tableTitle = document.createElement('div');
            tableTitle.textContent = includeDiagram ? '–î–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞' : '–î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á';
            tableTitle.style.fontSize = '12px';
            tableTitle.style.fontWeight = '600';
            tableTitle.style.margin = '4px 0 6px 0';
            section.appendChild(tableTitle);
            
            // –°–æ–∑–¥–∞–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            const previewTable = document.createElement('table');
            previewTable.style.borderCollapse = 'collapse';
            previewTable.style.width = '100%';
            previewTable.style.fontSize = '9px';
            previewTable.style.marginBottom = '20px';
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
            const headerRow = document.createElement('tr');
            const headers = includeDiagram 
                ? ['–ó–∞–¥–∞—á–∞', '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è', '–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π']
                : ['‚Ññ', '–≠—Ç–∞–ø', '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ', '–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π', '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è'];
            
            headers.forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                th.style.background = '#f5f5f5';
                th.style.color = '#222222';
                th.style.fontWeight = '600';
                th.style.fontSize = '9px';
                th.style.border = '1px solid #cccccc';
                th.style.padding = '4px 6px';
                headerRow.appendChild(th);
            });
            previewTable.appendChild(headerRow);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –∑–∞–¥–∞—á –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            const previewTasks = tasks.slice(0, Math.min(10, tasks.length));
            previewTasks.forEach((task, idx) => {
                const tr = document.createElement('tr');
                
                if (includeDiagram) {
                    const cells = [
                        task.task || '',
                        task.startDate ? task.startDate.toLocaleDateString('ru-RU') : '',
                        task.endDate ? task.endDate.toLocaleDateString('ru-RU') : '',
                        task.days != null ? String(task.days) : ''
                    ];
                    cells.forEach(val => {
                        const td = document.createElement('td');
                        td.textContent = val;
                        td.style.border = '1px solid #cccccc';
                        td.style.padding = '4px 6px';
                        td.style.fontSize = '9px';
                        tr.appendChild(td);
                    });
                } else {
                    const cells = [
                        idx + 1,
                        task.stage || '',
                        task.task || '',
                        task.days != null ? String(task.days) : '',
                        task.startDate ? task.startDate.toLocaleDateString('ru-RU') : '',
                        task.endDate ? task.endDate.toLocaleDateString('ru-RU') : ''
                    ];
                    cells.forEach(val => {
                        const td = document.createElement('td');
                        td.textContent = val;
                        td.style.border = '1px solid #cccccc';
                        td.style.padding = '4px 6px';
                        td.style.fontSize = '9px';
                        tr.appendChild(td);
                    });
                }
                
                previewTable.appendChild(tr);
            });
            
            section.appendChild(previewTable);
            previewWrapper.appendChild(section);
            
            return previewWrapper;
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏
        function createPreviewPage(pageIndex, pageType, pageContent, defaultMargins) {
            const pageId = `page-${pageIndex}`;
            const margins = currentPageMargins[pageId] || defaultMargins;
            
            const pageWidthMM = 420;
            const pageHeightMM = 297;
            const mmToPx = 3.779527559;
            const previewScale = 0.45; // 45% –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
            
            const pageWidthPx = pageWidthMM * mmToPx * previewScale;
            const pageHeightPx = pageHeightMM * mmToPx * previewScale;
            
            const contentWidthPx = (pageWidthMM - margins.left - margins.right) * mmToPx * previewScale;
            const contentHeightPx = (pageHeightMM - margins.top - margins.bottom) * mmToPx * previewScale;
            
            // –û–±–µ—Ä—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const pageWrapper = document.createElement('div');
            pageWrapper.className = 'pdf-preview-page-wrapper';
            pageWrapper.style.marginBottom = '30px';
            pageWrapper.style.position = 'relative';
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –æ—Ç—Å—Ç—É–ø–æ–≤
            const pageHeader = document.createElement('div');
            pageHeader.style.display = 'flex';
            pageHeader.style.justifyContent = 'space-between';
            pageHeader.style.alignItems = 'center';
            pageHeader.style.marginBottom = '10px';
            pageHeader.style.padding = '8px 12px';
            pageHeader.style.background = '#f0f0f0';
            pageHeader.style.borderRadius = '4px';
            
            const pageTitle = document.createElement('div');
            pageTitle.style.fontWeight = '600';
            pageTitle.style.fontSize = '13px';
            pageTitle.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageIndex + 1}: ${pageType}`;
            pageHeader.appendChild(pageTitle);
            
            // –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—Å—Ç—É–ø–æ–≤ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const marginsControls = document.createElement('div');
            marginsControls.style.display = 'flex';
            marginsControls.style.gap = '6px';
            marginsControls.style.alignItems = 'center';
            
            const marginInputs = ['top', 'bottom', 'left', 'right'].map(side => {
                const label = document.createElement('label');
                label.style.fontSize = '11px';
                label.style.marginRight = '2px';
                label.textContent = side === 'top' ? '–í' : side === 'bottom' ? '–ù' : side === 'left' ? '–õ' : '–ü';
                
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'page-margin-input';
                input.min = '0';
                input.max = '50';
                input.step = '1';
                input.value = margins[side];
                input.style.width = '40px';
                input.style.padding = '3px';
                input.style.border = '1px solid #ddd';
                input.style.borderRadius = '3px';
                input.style.fontSize = '11px';
                input.oninput = () => {
                    currentPageMargins[pageId] = {
                        top: parseFloat(marginsControls.querySelectorAll('.page-margin-input')[0].value || margins.top),
                        bottom: parseFloat(marginsControls.querySelectorAll('.page-margin-input')[1].value || margins.bottom),
                        left: parseFloat(marginsControls.querySelectorAll('.page-margin-input')[2].value || margins.left),
                        right: parseFloat(marginsControls.querySelectorAll('.page-margin-input')[3].value || margins.right)
                    };
                    updatePDFPreview();
                };
                
                const wrapper = document.createElement('div');
                wrapper.style.display = 'flex';
                wrapper.style.alignItems = 'center';
                wrapper.style.gap = '2px';
                wrapper.appendChild(label);
                wrapper.appendChild(input);
                return wrapper;
            });
            
            marginInputs.forEach(wrapper => marginsControls.appendChild(wrapper));
            pageHeader.appendChild(marginsControls);
            pageWrapper.appendChild(pageHeader);
            
            // –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            const pageDiv = document.createElement('div');
            pageDiv.className = 'pdf-preview-page';
            pageDiv.style.width = pageWidthPx + 'px';
            pageDiv.style.minHeight = pageHeightPx + 'px';
            pageDiv.style.position = 'relative';
            pageDiv.style.background = 'white';
            pageDiv.style.border = '2px solid #2196f3';
            pageDiv.style.margin = '0 auto';
            pageDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            
            // –û–±–ª–∞—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            const contentArea = document.createElement('div');
            contentArea.style.position = 'absolute';
            contentArea.style.left = (margins.left * mmToPx * previewScale) + 'px';
            contentArea.style.top = (margins.top * mmToPx * previewScale) + 'px';
            contentArea.style.width = contentWidthPx + 'px';
            contentArea.style.minHeight = contentHeightPx + 'px';
            contentArea.style.overflow = 'hidden';
            contentArea.style.boxSizing = 'border-box';
            contentArea.style.border = '1px dashed #2196f3';
            contentArea.style.background = '#fafafa';
            
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
            if (pageContent) {
                const contentScale = contentWidthPx / (420 * mmToPx);
                pageContent.style.transform = `scale(${contentScale})`;
                pageContent.style.transformOrigin = 'top left';
                pageContent.style.width = (420 * mmToPx) + 'px';
                contentArea.appendChild(pageContent);
            }
            
            pageDiv.appendChild(contentArea);
            
            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç—Å—Ç—É–ø–æ–≤
            ['top', 'bottom', 'left', 'right'].forEach(side => {
                if (margins[side] > 0) {
                    const marginDiv = document.createElement('div');
                    marginDiv.className = 'pdf-preview-margin';
                    marginDiv.style.position = 'absolute';
                    marginDiv.style.background = 'rgba(255, 152, 0, 0.1)';
                    marginDiv.style.border = '2px dashed #ff9800';
                    
                    if (side === 'top') {
                        marginDiv.style.left = '0';
                        marginDiv.style.top = '0';
                        marginDiv.style.width = '100%';
                        marginDiv.style.height = (margins.top * mmToPx * previewScale) + 'px';
                        marginDiv.style.borderBottom = '2px dashed #ff9800';
                        marginDiv.style.borderTop = 'none';
                    } else if (side === 'bottom') {
                        marginDiv.style.left = '0';
                        marginDiv.style.bottom = '0';
                        marginDiv.style.width = '100%';
                        marginDiv.style.height = (margins.bottom * mmToPx * previewScale) + 'px';
                        marginDiv.style.borderTop = '2px dashed #ff9800';
                        marginDiv.style.borderBottom = 'none';
                    } else if (side === 'left') {
                        marginDiv.style.left = '0';
                        marginDiv.style.top = (margins.top * mmToPx * previewScale) + 'px';
                        marginDiv.style.width = (margins.left * mmToPx * previewScale) + 'px';
                        marginDiv.style.height = contentHeightPx + 'px';
                        marginDiv.style.borderRight = '2px dashed #ff9800';
                        marginDiv.style.borderLeft = 'none';
                    } else {
                        marginDiv.style.right = '0';
                        marginDiv.style.top = (margins.top * mmToPx * previewScale) + 'px';
                        marginDiv.style.width = (margins.right * mmToPx * previewScale) + 'px';
                        marginDiv.style.height = contentHeightPx + 'px';
                        marginDiv.style.borderLeft = '2px dashed #ff9800';
                        marginDiv.style.borderRight = 'none';
                    }
                    
                    pageDiv.appendChild(marginDiv);
                    
                    // –ü–æ–¥–ø–∏—Å—å –æ—Ç—Å—Ç—É–ø–∞
                    const label = document.createElement('div');
                    label.className = 'pdf-preview-margin-label';
                    label.textContent = margins[side] + '–º–º';
                    label.style.position = 'absolute';
                    label.style.fontSize = '10px';
                    label.style.color = '#ff9800';
                    label.style.background = 'rgba(255, 255, 255, 0.9)';
                    label.style.padding = '2px 4px';
                    label.style.borderRadius = '2px';
                    label.style.fontWeight = '600';
                    
                    if (side === 'top') {
                        label.style.top = ((margins.top * mmToPx * previewScale) / 2 - 8) + 'px';
                        label.style.left = '4px';
                    } else if (side === 'bottom') {
                        label.style.bottom = ((margins.bottom * mmToPx * previewScale) / 2 - 8) + 'px';
                        label.style.left = '4px';
                    } else if (side === 'left') {
                        label.style.left = ((margins.left * mmToPx * previewScale) / 2 - 12) + 'px';
                        label.style.top = (margins.top * mmToPx * previewScale + contentHeightPx / 2 - 8) + 'px';
                        label.style.transform = 'rotate(-90deg)';
                        label.style.transformOrigin = 'center';
                    } else {
                        label.style.right = ((margins.right * mmToPx * previewScale) / 2 - 12) + 'px';
                        label.style.top = (margins.top * mmToPx * previewScale + contentHeightPx / 2 - 8) + 'px';
                        label.style.transform = 'rotate(90deg)';
                        label.style.transformOrigin = 'center';
                    }
                    
                    pageDiv.appendChild(label);
                }
            });
            
            pageWrapper.appendChild(pageDiv);
            return pageWrapper;
        }
        
        async function updatePDFPreview() {
            const container = document.getElementById('pdfPreviewContainer');
            if (!container || !tasks || !tasks.length) return;
            
            // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –î–û –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
            const savedScrollTop = container.scrollTop;
            const savedScrollLeft = container.scrollLeft;
            const savedScrollHeight = container.scrollHeight;
            const savedClientHeight = container.clientHeight;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
            const relativeScrollPosition = savedScrollHeight > 0 ? savedScrollTop / savedScrollHeight : 0;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±—ã–ª–∞ –≤–∏–¥–Ω–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ —ç–∫—Ä–∞–Ω–∞
            const viewportCenter = savedScrollTop + container.clientHeight / 2;
            let visiblePageIndex = -1;
            const existingPages = container.querySelectorAll('.pdf-preview-page-wrapper');
            existingPages.forEach((page, index) => {
                const pageTop = page.offsetTop;
                const pageBottom = pageTop + page.offsetHeight;
                if (viewportCenter >= pageTop && viewportCenter <= pageBottom) {
                    visiblePageIndex = index;
                }
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ sessionStorage –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            try {
                sessionStorage.setItem('pdfPreviewScroll', JSON.stringify({
                    scrollTop: savedScrollTop,
                    scrollLeft: savedScrollLeft,
                    scrollHeight: savedScrollHeight,
                    relativeScroll: relativeScrollPosition,
                    visiblePageIndex: visiblePageIndex
                }));
            } catch (e) {}
            
            container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü...</div>';
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const modeRadio = document.querySelector('input[name="pdfContentMode"]:checked');
            const includeDiagram = modeRadio ? modeRadio.value !== 'table' : true;
            const selectEl = document.getElementById('pdfScaleMode');
            const scaleMode = selectEl ? selectEl.value : 'day';
            
            const defaultMargins = {
                top: parseFloat(document.getElementById('pdfMarginTop')?.value || 10),
                bottom: parseFloat(document.getElementById('pdfMarginBottom')?.value || 20),
                left: parseFloat(document.getElementById('pdfMarginLeft')?.value || 5),
                right: parseFloat(document.getElementById('pdfMarginRight')?.value || 5)
            };
            
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π wrapper –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–≥–∏–∫—É –∏–∑ exportPDF)
            // –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è —Å–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞–ø—Ä—è–º—É—é
            container.innerHTML = '';
            
            const pages = [];
            
            // –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1: –¢–∏—Ç—É–ª—å–Ω—ã–π –ª–∏—Å—Ç
            const titlePageContent = await createTitlePageForPreview();
            if (titlePageContent) {
                pages.push({ type: '–¢–∏—Ç—É–ª—å–Ω—ã–π –ª–∏—Å—Ç', content: titlePageContent });
            }
            
            // –°—Ç—Ä–∞–Ω–∏—Ü—ã –¥–∏–∞–≥—Ä–∞–º–º—ã –ì–∞–Ω—Ç–∞ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞)
            if (includeDiagram) {
                const diagramPages = await createDiagramPagesForPreview(scaleMode);
                pages.push(...diagramPages);
            }
            
            // –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
            const tablePageContent = await createTablePageForPreview();
            if (tablePageContent) {
                pages.push({ type: '–î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á', content: tablePageContent });
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            pages.forEach((page, index) => {
                const pageElement = createPreviewPage(index, page.type, page.content, defaultMargins);
                container.appendChild(pageElement);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å—Ç—Ä–∞–Ω–∏—Ü
            const countEl = document.getElementById('pdfPagesCount');
            if (countEl) {
                countEl.textContent = `–í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü: ${pages.length}`;
            }
            
            // –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ü–†–û–ö–†–£–¢–ö–£ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
            const restoreScroll = () => {
                const newPages = container.querySelectorAll('.pdf-preview-page-wrapper');
                if (newPages.length === 0) return false;
                
                // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ sessionStorage
                let savedData = null;
                try {
                    const stored = sessionStorage.getItem('pdfPreviewScroll');
                    if (stored) {
                        savedData = JSON.parse(stored);
                    }
                } catch (e) {}
                
                if (!savedData) {
                    savedData = {
                        scrollTop: savedScrollTop,
                        scrollLeft: savedScrollLeft,
                        relativeScroll: relativeScrollPosition,
                        visiblePageIndex: visiblePageIndex
                    };
                }
                
                // –ú–µ—Ç–æ–¥ 1: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –∏–Ω–¥–µ–∫—Å—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                if (savedData.visiblePageIndex >= 0 && savedData.visiblePageIndex < newPages.length) {
                    const targetPage = newPages[savedData.visiblePageIndex];
                    const targetTop = targetPage.offsetTop;
                    const newScrollTop = Math.max(0, targetTop - container.clientHeight / 2);
                    container.scrollTop = newScrollTop;
                    container.scrollLeft = savedData.scrollLeft || savedScrollLeft;
                    return true;
                }
                
                // –ú–µ—Ç–æ–¥ 2: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
                const newScrollHeight = container.scrollHeight;
                if (newScrollHeight > 0 && savedData.relativeScroll !== undefined) {
                    const newScrollTop = savedData.relativeScroll * newScrollHeight;
                    const maxScrollTop = Math.max(0, newScrollHeight - container.clientHeight);
                    const restoredScrollTop = Math.min(newScrollTop, maxScrollTop);
                    container.scrollTop = restoredScrollTop;
                    container.scrollLeft = savedData.scrollLeft || savedScrollLeft;
                    return true;
                }
                
                // –ú–µ—Ç–æ–¥ 3: –ü—Ä–æ—Å—Ç–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
                const maxScrollTop = Math.max(0, container.scrollHeight - container.clientHeight);
                if (maxScrollTop > 0 && savedData.scrollTop !== undefined) {
                    container.scrollTop = Math.min(savedData.scrollTop, maxScrollTop);
                    container.scrollLeft = savedData.scrollLeft || savedScrollLeft;
                    return true;
                }
                
                return false;
            };
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ä–∞–∑—É –∏ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞–¥—Ä–æ–≤
            requestAnimationFrame(() => {
                restoreScroll();
                requestAnimationFrame(() => {
                    restoreScroll();
                    setTimeout(() => {
                        restoreScroll();
                        // –û—á–∏—â–∞–µ–º sessionStorage –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
                        try {
                            sessionStorage.removeItem('pdfPreviewScroll');
                        } catch (e) {}
                    }, 50);
                });
            });
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
        async function createTitlePageForPreview() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –≤ exportPDF
            const titleDiv = document.createElement('div');
            titleDiv.style.padding = '40px';
            titleDiv.style.boxSizing = 'border-box';
            titleDiv.style.width = '100%';
            titleDiv.style.maxWidth = '600px';
            titleDiv.style.margin = '0 auto';
            titleDiv.style.display = 'block';
            titleDiv.style.textAlign = 'center';
            
            const logoEl = document.getElementById('companyLogo');
            if (logoEl && logoEl.src) {
                const logo = document.createElement('img');
                logo.src = logoEl.src;
                logo.style.width = '200px';
                logo.style.height = '200px';
                logo.style.borderRadius = '12px';
                logo.style.border = '2px solid #e0e0e0';
                logo.style.objectFit = 'contain';
                logo.style.background = '#fafafa';
                logo.style.padding = '8px';
                logo.style.display = 'block';
                logo.style.margin = '0 auto 30px auto';
                titleDiv.appendChild(logo);
            }
            
            const nameDisplay = document.getElementById('companyNameDisplay');
            const currentNameText = nameDisplay && nameDisplay.classList.contains('has-value')
                ? (nameDisplay.innerText || nameDisplay.textContent) : '';
            
            const companyNameTitle = document.createElement('div');
            companyNameTitle.textContent = currentNameText || '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏';
            companyNameTitle.style.fontSize = '28px';
            companyNameTitle.style.fontWeight = '700';
            companyNameTitle.style.color = '#333333';
            companyNameTitle.style.marginBottom = '15px';
            titleDiv.appendChild(companyNameTitle);
            
            // –ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
            const objectNameDisplay = document.getElementById('companyObjectNameDisplay');
            let objectName = '';
            if (objectNameDisplay && objectNameDisplay.style.display !== 'none') {
                objectName = (objectNameDisplay.innerText || objectNameDisplay.textContent || '').trim();
            }
            if (!objectName && typeof companyObjectName !== 'undefined' && companyObjectName) {
                objectName = String(companyObjectName).trim();
            }
            
            if (objectName && objectName.length > 0) {
                const objectNameTitle = document.createElement('div');
                objectNameTitle.textContent = objectName;
                objectNameTitle.style.fontSize = '22px';
                objectNameTitle.style.fontWeight = '600';
                objectNameTitle.style.color = '#2196f3';
                objectNameTitle.style.marginBottom = '15px';
                titleDiv.appendChild(objectNameTitle);
            }
            
            const subtitle = document.createElement('div');
            subtitle.textContent = '–ì—Ä–∞—Ñ–∏–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏ –æ–±—É—á–µ–Ω–∏—è';
            subtitle.style.fontSize = '18px';
            subtitle.style.fontWeight = '500';
            subtitle.style.color = '#666666';
            subtitle.style.marginBottom = '40px';
            titleDiv.appendChild(subtitle);
            
            // –ú–µ—Ç—Ä–∏–∫–∏
            if (typeof calculateTaskMetrics === 'function') {
                const metrics = calculateTaskMetrics();
                const metricsContainer = document.createElement('table');
                metricsContainer.style.width = '100%';
                metricsContainer.style.margin = '0 auto';
                metricsContainer.style.borderCollapse = 'separate';
                metricsContainer.style.borderSpacing = '15px';
                metricsContainer.style.tableLayout = 'fixed';
                
                const metricsRow = document.createElement('tr');
                
                // –ú–µ—Ç—Ä–∏–∫–∞: –ó–∞–∫—Ä—ã—Ç–æ
                const completedCell = document.createElement('td');
                completedCell.style.width = '33%';
                completedCell.style.textAlign = 'center';
                completedCell.style.padding = '20px';
                completedCell.style.background = '#e8f5e9';
                completedCell.style.borderRadius = '8px';
                completedCell.style.border = '2px solid #4caf50';
                
                const completedLabel = document.createElement('div');
                completedLabel.textContent = '–ó–∞–∫—Ä—ã—Ç–æ';
                completedLabel.style.fontSize = '14px';
                completedLabel.style.color = '#666';
                completedLabel.style.marginBottom = '8px';
                completedCell.appendChild(completedLabel);
                
                const completedValue = document.createElement('div');
                completedValue.textContent = String(metrics.completed);
                completedValue.style.fontSize = '36px';
                completedValue.style.fontWeight = '700';
                completedValue.style.color = '#4caf50';
                completedCell.appendChild(completedValue);
                
                metricsRow.appendChild(completedCell);
                
                // –ú–µ—Ç—Ä–∏–∫–∞: –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
                const overdueCell = document.createElement('td');
                overdueCell.style.width = '33%';
                overdueCell.style.textAlign = 'center';
                overdueCell.style.padding = '20px';
                overdueCell.style.background = '#ffebee';
                overdueCell.style.borderRadius = '8px';
                overdueCell.style.border = '2px solid #f44336';
                
                const overdueLabel = document.createElement('div');
                overdueLabel.textContent = '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ';
                overdueLabel.style.fontSize = '14px';
                overdueLabel.style.color = '#666';
                overdueLabel.style.marginBottom = '8px';
                overdueCell.appendChild(overdueLabel);
                
                const overdueValue = document.createElement('div');
                overdueValue.textContent = String(metrics.overdue);
                overdueValue.style.fontSize = '36px';
                overdueValue.style.fontWeight = '700';
                overdueValue.style.color = '#f44336';
                overdueCell.appendChild(overdueValue);
                
                metricsRow.appendChild(overdueCell);
                
                // –ú–µ—Ç—Ä–∏–∫–∞: –ü—Ä–µ–¥—Å—Ç–æ–∏—Ç
                const pendingCell = document.createElement('td');
                pendingCell.style.width = '33%';
                pendingCell.style.textAlign = 'center';
                pendingCell.style.padding = '20px';
                pendingCell.style.background = '#e3f2fd';
                pendingCell.style.borderRadius = '8px';
                pendingCell.style.border = '2px solid #2196f3';
                
                const pendingLabel = document.createElement('div');
                pendingLabel.textContent = '–ü—Ä–µ–¥—Å—Ç–æ–∏—Ç';
                pendingLabel.style.fontSize = '14px';
                pendingLabel.style.color = '#666';
                pendingLabel.style.marginBottom = '8px';
                pendingCell.appendChild(pendingLabel);
                
                const pendingValue = document.createElement('div');
                pendingValue.textContent = String(metrics.pending);
                pendingValue.style.fontSize = '36px';
                pendingValue.style.fontWeight = '700';
                pendingValue.style.color = '#2196f3';
                pendingCell.appendChild(pendingValue);
                
                metricsRow.appendChild(pendingCell);
                
                metricsContainer.appendChild(metricsRow);
                titleDiv.appendChild(metricsContainer);
            }
            
            return titleDiv;
        }
        
        async function createDiagramPagesForPreview(scaleMode) {
            const pages = [];
            if (!tasks || !tasks.length) return pages;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –≤ exportPDF
            const timelineUnits = buildExportTimeline(scaleMode);
            if (!timelineUnits.length) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é —à–∫–∞–ª—É –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
                return pages;
            }
            
            const scaleLabel = getExportScaleLabel(scaleMode);
            const statusColors = {
                pending: '#1e88e5',
                'in-progress': '#ff9800',
                completed: '#4caf50',
                'weekend-manual': '#ffe0e0'
            };
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü—ã —è—á–µ–π–∫–∏
            const addCellBorder = (td) => {
                td.style.border = '1px solid #cccccc';
                td.style.padding = '2px 3px';
            };
            
            // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã –≤ –∫–ª—é—á
            const formatDateKeyLocal = (date) => {
                if (typeof date === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(date)) {
                    return date;
                }
                const parsedDate = date instanceof Date ? date : new Date(date);
                if (isNaN(parsedDate.getTime())) return '';
                const year = parsedDate.getFullYear();
                const month = String(parsedDate.getMonth() + 1).padStart(2, '0');
                const day = String(parsedDate.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            // –†–∞–∑–±–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —à–∫–∞–ª—É –Ω–∞ chunks (—Å—Ç–æ–ª—å–∫–æ –∂–µ –µ–¥–∏–Ω–∏—Ü –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ –∏ –≤ exportPDF)
            const unitsPerPage = scaleMode === 'day' ? 22 : scaleMode === 'week' ? 12 : 6;
            const chunks = [];
            for (let i = 0; i < timelineUnits.length; i += unitsPerPage) {
                const chunk = timelineUnits.slice(i, i + unitsPerPage);
                if (chunk && chunk.length > 0) {
                    chunks.push(chunk);
                }
            }
            
            // –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ chunk
            chunks.forEach((chunk, chunkIdx) => {
                const diagramDiv = document.createElement('div');
                diagramDiv.style.padding = '20px';
                diagramDiv.style.boxSizing = 'border-box';
                
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∏–∞–≥—Ä–∞–º–º—ã
                const title = document.createElement('div');
                title.textContent = `–î–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞ (${scaleLabel})${chunks.length > 1 ? ` - –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${chunkIdx + 1} –∏–∑ ${chunks.length}` : ''}`;
                title.style.fontSize = '12px';
                title.style.fontWeight = '600';
                title.style.margin = '4px 0 6px 0';
                diagramDiv.appendChild(title);
                
                // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–∏–∞–≥—Ä–∞–º–º—ã
                const ganttTable = document.createElement('table');
                ganttTable.style.borderCollapse = 'collapse';
                ganttTable.style.width = '100%';
                ganttTable.style.fontSize = '8px';
                ganttTable.style.marginBottom = '20px';
                ganttTable.style.tableLayout = 'fixed';
                
                // –ë–∞–∑–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏
                const baseHeaders = ['–ó–∞–¥–∞—á–∞', '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è', '–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π'];
                const baseWidths = ['25%', '12%', '10%', '10%', '8%'];
                const dateColumnWidth = chunk.length > 0 ? `${35 / chunk.length}%` : '40px';
                
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
                const headerTr = document.createElement('tr');
                baseHeaders.forEach((text, idx) => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    th.style.background = '#f5f5f5';
                    th.style.color = '#222222';
                    th.style.fontWeight = '600';
                    th.style.fontSize = '8px';
                    th.style.whiteSpace = 'nowrap';
                    th.style.width = baseWidths[idx] || 'auto';
                    th.style.overflow = 'hidden';
                    th.style.textOverflow = 'ellipsis';
                    addCellBorder(th);
                    headerTr.appendChild(th);
                });
                
                // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ –¥–∞—Ç
                chunk.forEach(unit => {
                    const th = document.createElement('th');
                    th.textContent = unit.label;
                    th.style.background = '#e3f2fd';
                    th.style.color = '#222222';
                    th.style.fontWeight = '600';
                    th.style.fontSize = '7px';
                    th.style.whiteSpace = 'nowrap';
                    th.style.width = dateColumnWidth;
                    th.style.minWidth = '35px';
                    th.style.overflow = 'hidden';
                    th.style.textOverflow = 'ellipsis';
                    addCellBorder(th);
                    headerTr.appendChild(th);
                });
                
                ganttTable.appendChild(headerTr);
                
                // –°—Ç—Ä–æ–∫–∏ –∑–∞–¥–∞—á
                tasks.forEach(task => {
                    const tr = document.createElement('tr');
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–∞–º–æ–ª–µ—Ç–∏–∫ –∫ –Ω–∞–∑–≤–∞–Ω–∏—é –∑–∞–¥–∞—á–∏, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ "–Ω–∞ –≤—ã–µ–∑–¥–µ"
                    let taskName = task.task || '';
                    if (task.onTravel === true || task.onTravel === 'true') {
                        taskName = '‚úà ' + taskName;
                    }
                    
                    const baseValues = [
                        taskName,
                        task.responsible || '',
                        task.startDate ? task.startDate.toLocaleDateString('ru-RU') : '',
                        task.endDate ? task.endDate.toLocaleDateString('ru-RU') : '',
                        task.days != null ? String(task.days) : ''
                    ];
                    
                    baseValues.forEach((val, idx) => {
                        const td = document.createElement('td');
                        td.textContent = val;
                        td.style.fontSize = '8px';
                        td.style.whiteSpace = 'nowrap';
                        td.style.overflow = 'hidden';
                        td.style.textOverflow = 'ellipsis';
                        if (idx < baseWidths.length) {
                            td.style.width = baseWidths[idx];
                        }
                        addCellBorder(td);
                        tr.appendChild(td);
                    });
                    
                    const statuses = task.dateStatuses || {};
                    
                    // –Ø—á–µ–π–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –µ–¥–∏–Ω–∏—Ü—ã –≤—Ä–µ–º–µ–Ω–∏ –≤ chunk
                    chunk.forEach(unit => {
                        const td = document.createElement('td');
                        td.style.width = dateColumnWidth;
                        td.style.minWidth = '35px';
                        td.style.overflow = 'hidden';
                        addCellBorder(td);
                        
                        const unitStart = unit.start.getTime();
                        const unitEnd = unit.end.getTime();
                        
                        let hasWorkday = false;
                        let intervalStatus = 'pending';
                        
                        if (Array.isArray(task.dates)) {
                            const daysInUnit = task.dates.filter(d => {
                                const dateObj = d instanceof Date ? d : new Date(d);
                                if (isNaN(dateObj.getTime())) return false;
                                const t = dateObj.getTime();
                                return t >= unitStart && t <= unitEnd;
                            });
                            
                            if (daysInUnit.length > 0) {
                                hasWorkday = true;
                                if (scaleMode === 'day' && daysInUnit.length === 1) {
                                    const key = formatDateKeyLocal(daysInUnit[0]);
                                    intervalStatus = statuses[key] || 'pending';
                                } else {
                                    const statusesInUnit = new Set();
                                    daysInUnit.forEach(d => {
                                        const key = formatDateKeyLocal(d);
                                        const s = statuses[key];
                                        if (s) statusesInUnit.add(s);
                                    });
                                    if (statusesInUnit.has('completed')) intervalStatus = 'completed';
                                    else if (statusesInUnit.has('in-progress')) intervalStatus = 'in-progress';
                                    else if (statusesInUnit.has('weekend-manual')) intervalStatus = 'weekend-manual';
                                    else intervalStatus = 'pending';
                                }
                            }
                        }
                        
                        if (hasWorkday) {
                            const color = statusColors[intervalStatus] || statusColors.pending;
                            td.style.background = color;
                        }
                        
                        tr.appendChild(td);
                    });
                    
                    ganttTable.appendChild(tr);
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ
                if (ganttTable.rows.length > 1) {
                    diagramDiv.appendChild(ganttTable);
                    pages.push({ 
                        type: `–î–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞${chunks.length > 1 ? ` (—Å—Ç—Ä. ${chunkIdx + 1})` : ''}`, 
                        content: diagramDiv 
                    });
                }
            });
            
            return pages;
        }
        
        async function createTablePageForPreview() {
            const tableDiv = document.createElement('div');
            tableDiv.style.padding = '20px';
            tableDiv.style.boxSizing = 'border-box';
            
            const title = document.createElement('div');
            title.textContent = '–î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á';
            title.style.fontSize = '12px';
            title.style.fontWeight = '600';
            title.style.margin = '4px 0 6px 0';
            tableDiv.appendChild(title);
            
            const table = document.createElement('table');
            table.style.borderCollapse = 'collapse';
            table.style.width = '100%';
            table.style.fontSize = '9px';
            table.style.marginBottom = '20px';
            table.style.tableLayout = 'fixed';
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü—ã —è—á–µ–π–∫–∏
            const addCellBorder = (td) => {
                td.style.border = '1px solid #cccccc';
                td.style.padding = '2px 3px';
            };
            
            const headerRow = document.createElement('tr');
            const headers = [
                '‚Ññ –ø/–ø',
                '–≠—Ç–∞–ø',
                '–í–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è',
                '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ',
                '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞',
                '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è',
                '–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π',
                '–°—Ç–∞—Ç—É—Å',
                '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'
            ];
            
            headers.forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                th.style.background = '#f5f5f5';
                th.style.color = '#222222';
                th.style.fontWeight = '600';
                th.style.fontSize = '9px';
                th.style.whiteSpace = 'nowrap';
                th.style.overflow = 'hidden';
                th.style.textOverflow = 'ellipsis';
                addCellBorder(th);
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);
            
            tasks.forEach((task, idx) => {
                const tr = document.createElement('tr');
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–∞–º–æ–ª–µ—Ç–∏–∫ –∫ –Ω–∞–∑–≤–∞–Ω–∏—é –∑–∞–¥–∞—á–∏, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ "–Ω–∞ –≤—ã–µ–∑–¥–µ"
                let taskName = task.task || '';
                if (task.onTravel === true || task.onTravel === 'true') {
                    taskName = '‚úà ' + taskName;
                }
                
                const cells = [
                    idx + 1,
                    task.stage || '',
                    task.controlType || '',
                    taskName,
                    task.startDate ? task.startDate.toLocaleDateString('ru-RU') : '',
                    task.endDate ? task.endDate.toLocaleDateString('ru-RU') : '',
                    task.days != null ? String(task.days) : '',
                    task.status === 'completed' ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : 
                    task.status === 'in-progress' ? '–í —Ä–∞–±–æ—Ç–µ' : '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞',
                    task.comment || ''
                ];
                
                cells.forEach(val => {
                    const td = document.createElement('td');
                    td.textContent = val;
                    td.style.fontSize = '9px';
                    td.style.whiteSpace = 'nowrap';
                    td.style.overflow = 'hidden';
                    td.style.textOverflow = 'ellipsis';
                    addCellBorder(td);
                    tr.appendChild(td);
                });
                
                table.appendChild(tr);
            });
            
            tableDiv.appendChild(table);
            return tableDiv;
        }
        
        function confirmPDFExport() {
            const selectEl = document.getElementById('pdfScaleMode');
            const rawMode = selectEl ? String(selectEl.value || '').toLowerCase() : 'day';
            let scaleMode = 'day';
            if (rawMode.startsWith('week') || rawMode.startsWith('–Ω–µ–¥')) scaleMode = 'week';
            else if (rawMode.startsWith('month') || rawMode.startsWith('–º–µ—Å')) scaleMode = 'month';
            const modeRadio = document.querySelector('input[name="pdfContentMode"]:checked');
            const includeDiagram = modeRadio ? modeRadio.value !== 'table' : true;
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—Å—Ç—É–ø–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ)
            const defaultMargins = {
                top: parseFloat(document.getElementById('pdfMarginTop')?.value || 10),
                bottom: parseFloat(document.getElementById('pdfMarginBottom')?.value || 20),
                left: parseFloat(document.getElementById('pdfMarginLeft')?.value || 5),
                right: parseFloat(document.getElementById('pdfMarginRight')?.value || 5)
            };
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö, –∏–Ω–∞—á–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
            const margins = Object.keys(currentPageMargins).length > 0 ? currentPageMargins : defaultMargins;
            
            closePDFExportModal();
            // –°—Ä–∞–∑—É —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ html2pdf
            exportPDF(scaleMode, includeDiagram, margins);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–µ—á–∞—Ç–∏ —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ–∫–Ω–æ Windows
        async function printPDFWithStandardDialog(scaleMode, includeDiagram, margins) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É html2pdf –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                await loadHtml2Pdf();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ html2pdf.js:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞.');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—á–∞—Ç–∏
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É—è —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –≤ exportPDF
            // –ù–æ –±–µ–∑ —ç–∫—Å–ø–æ—Ä—Ç–∞, —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –æ–∫–Ω–µ –ø–µ—á–∞—Ç–∏
            const tempWrapper = document.createElement('div');
            tempWrapper.style.position = 'absolute';
            tempWrapper.style.left = '-9999px';
            tempWrapper.style.top = '0';
            document.body.appendChild(tempWrapper);
            
            // –í—ã–∑—ã–≤–∞–µ–º exportPDF, –Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º wrapper –¥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞
            let exportWrapper = null;
            const originalExportPDF = window.exportPDF;
            
            // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º exportPDF –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ wrapper
            window.exportPDF = async function(...args) {
                // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º wrapper
                const result = await originalExportPDF.apply(this, args);
                // –ò—â–µ–º wrapper –≤ DOM
                exportWrapper = document.querySelector('.pdf-export-wrapper') || 
                              document.querySelector('div[style*="420mm"]');
                return result;
            };
            
            // –í—ã–∑—ã–≤–∞–µ–º exportPDF –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            await exportPDF(scaleMode, includeDiagram, margins);
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
            window.exportPDF = originalExportPDF;
            
            // –ï—Å–ª–∏ wrapper –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ –≤—Ä—É—á–Ω—É—é
            if (!exportWrapper) {
                exportWrapper = document.querySelector('.pdf-export-wrapper') || 
                              document.querySelector('div[style*="420mm"]');
            }
            
            if (!exportWrapper) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏');
                if (tempWrapper.parentNode) {
                    document.body.removeChild(tempWrapper);
                }
                return;
            }
            
            // –ö–ª–æ–Ω–∏—Ä—É–µ–º wrapper –¥–ª—è –ø–µ—á–∞—Ç–∏
            const printContent = exportWrapper.cloneNode(true);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –∫ —Å–µ–∫—Ü–∏—è–º
            const printSections = printContent.querySelectorAll('.pdf-page-section');
            const marginKeys = margins && typeof margins === 'object' ? Object.keys(margins) : [];
            const hasIndividualMargins = marginKeys.length > 0 && 
                                         marginKeys.some(key => key.startsWith('page-')) &&
                                         !marginKeys.some(key => ['top', 'bottom', 'left', 'right'].includes(key));
            
            printSections.forEach((section, index) => {
                if (index === 0) return; // –¢–∏—Ç—É–ª—å–Ω—ã–π –ª–∏—Å—Ç –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                if (hasIndividualMargins) {
                    const pageId = `page-${index}`;
                    const pageMargins = margins[pageId] || {
                        top: 10,
                        bottom: 20,
                        left: 5,
                        right: 5
                    };
                    section.style.paddingTop = pageMargins.top + 'mm';
                    section.style.paddingBottom = pageMargins.bottom + 'mm';
                    section.style.paddingLeft = '0'; // –£–±–∏—Ä–∞–µ–º padding —Å–ª–µ–≤–∞ - —Ç–∞–±–ª–∏—Ü—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –æ—Ç –∫—Ä–∞—è
                    section.style.paddingRight = pageMargins.right + 'mm';
                } else if (margins && (margins.top || margins.bottom || margins.left || margins.right)) {
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±—â–∏–µ –æ—Ç—Å—Ç—É–ø—ã
                    section.style.paddingTop = (margins.top || 10) + 'mm';
                    section.style.paddingBottom = (margins.bottom || 20) + 'mm';
                    section.style.paddingLeft = '0'; // –£–±–∏—Ä–∞–µ–º padding —Å–ª–µ–≤–∞ - —Ç–∞–±–ª–∏—Ü—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –æ—Ç –∫—Ä–∞—è
                    section.style.paddingRight = (margins.right || 5) + 'mm';
                } else {
                    // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã
                    section.style.paddingTop = '10mm';
                    section.style.paddingBottom = '20mm';
                    section.style.paddingLeft = '0'; // –£–±–∏—Ä–∞–µ–º padding —Å–ª–µ–≤–∞ - —Ç–∞–±–ª–∏—Ü—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –æ—Ç –∫—Ä–∞—è
                    section.style.paddingRight = '5mm';
                }
            });
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏
            const printStyles = `
                <style>
                    @page {
                        size: A3 landscape;
                        margin: 0;
                    }
                    * {
                        box-sizing: border-box;
                    }
                    body {
                        margin: 0;
                        padding: 0;
                        font-family: Arial, sans-serif;
                    }
                    .pdf-page-section {
                        width: 100% !important;
                        page-break-before: always;
                        page-break-inside: avoid;
                        break-before: page;
                        break-inside: avoid;
                        margin: 0 !important;
                        position: relative !important;
                    }
                    .pdf-page-section:first-child {
                        page-break-before: auto;
                        break-before: auto;
                    }
                    /* –õ–æ–≥–æ—Ç–∏–ø –Ω–∞ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ - –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ */
                    .pdf-page-logo {
                        position: absolute !important;
                        top: 12px !important;
                        right: 12px !important;
                        width: 80px !important;
                        height: 80px !important;
                        z-index: 1000 !important;
                        pointer-events: none !important;
                        opacity: 0.28 !important;
                    }
                    .pdf-page-logo img {
                        width: 100% !important;
                        height: 100% !important;
                        object-fit: contain !important;
                        display: block !important;
                    }
                    table {
                        width: 100% !important;
                        border-collapse: collapse;
                    }
                    @media print {
                        .pdf-page-section {
                            page-break-before: always;
                            page-break-inside: avoid;
                            position: relative !important;
                        }
                        .pdf-page-section:first-child {
                            page-break-before: auto;
                        }
                        .pdf-page-logo {
                            position: absolute !important;
                            top: 12px !important;
                            right: 12px !important;
                            width: 80px !important;
                            height: 80px !important;
                            z-index: 1000 !important;
                            pointer-events: none !important;
                            opacity: 0.28 !important;
                        }
                    }
                </style>
            `;
            
            printWindow.document.write(printStyles);
            printWindow.document.body.appendChild(printContent);
            printWindow.document.close();
            
            // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏
            setTimeout(() => {
                printWindow.print();
            }, 500);
            
            // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π wrapper
            if (tempWrapper.parentNode) {
                document.body.removeChild(tempWrapper);
            }
        }

        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞
        function editStartDate() {
            const modal = document.getElementById('editModal');
            const input = document.getElementById('startDateInput');
            input.value = formatDateForInput(startDate);
            modal.style.display = 'block';
        }

        async function updateStartDate() {
            const input = document.getElementById('startDateInput');
            const newDate = parseDateFromInput(input.value);
            
            if (isWorkday(newDate)) {
                startDate = newDate;
                await initializeTasks();
                closeModal();
            } else {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å');
            }
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–±—Ä–æ—Å–∞ –ø–ª–∞–Ω–∞
        function resetSchedule() {
            if (!canEdit()) {
                return; // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–±—Ä–æ—Å –ø–ª–∞–Ω–∞ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            }
            
            const modal = document.getElementById('resetPlanConfirmModal');
            if (modal) {
                modal.style.display = 'block';
                
                // –î–æ–±–∞–≤–ª—è–µ–º —è–≤–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–ª–∏–∫–æ–≤ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.addEventListener('click', (e) => {
                        const target = e.target;
                        if (target.classList.contains('btn-primary') && target.textContent.trim().includes('–î–∞')) {
                            e.stopPropagation();
                            e.preventDefault();
                            confirmResetPlan();
                        } else if (target.classList.contains('btn-secondary') && target.textContent.trim().includes('–ù–µ—Ç')) {
                            e.stopPropagation();
                            e.preventDefault();
                            cancelResetPlan();
                        }
                    }, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
                }
                
                // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π
                const isMobile = window.innerWidth <= 1024;
                if (isMobile) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
                    requestAnimationFrame(() => {
                        // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É "–°–±—Ä–æ—Å–∏—Ç—å –ø–ª–∞–Ω"
                        const resetButton = document.querySelector('.reset-plan-btn');
                        
                        if (resetButton) {
                            const modalContent = modal.querySelector('.modal-content');
                            if (modalContent) {
                                const buttonRect = resetButton.getBoundingClientRect();
                                
                                // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–æ –±—ã–ª–æ –≤–∏–¥–Ω–æ —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π
                                // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é: –µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –≤ –Ω–∏–∂–Ω–µ–π –ø–æ–ª–æ–≤–∏–Ω–µ —ç–∫—Ä–∞–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–¥ –Ω–µ–π, –∏–Ω–∞—á–µ - –ø–æ–¥ –Ω–µ–π
                                const viewportHeight = window.innerHeight;
                                const buttonBottom = buttonRect.bottom;
                                const spaceBelow = viewportHeight - buttonBottom;
                                const spaceAbove = buttonRect.top;
                                
                                // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport (—Ç–∞–∫ –∫–∞–∫ modal –∏–º–µ–µ—Ç position: fixed)
                                let topPosition;
                                if (spaceBelow < 300 && spaceAbove > spaceBelow) {
                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–¥ –∫–Ω–æ–ø–∫–æ–π
                                    topPosition = buttonRect.top - 250; // –≤—ã—Å–æ—Ç–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏–º–µ—Ä–Ω–æ 250px
                                } else {
                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π
                                    topPosition = buttonRect.bottom + 20; // –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø
                                }
                                
                                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ–∫–Ω–æ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞
                                const minTop = 20;
                                const maxTop = viewportHeight - 300;
                                topPosition = Math.max(minTop, Math.min(topPosition, maxTop));
                                
                                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ —Å !important —á–µ—Ä–µ–∑ setProperty –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è CSS
                                modalContent.style.setProperty('position', 'absolute', 'important');
                                modalContent.style.setProperty('top', topPosition + 'px', 'important');
                                modalContent.style.setProperty('left', '50%', 'important');
                                modalContent.style.setProperty('transform', 'translateX(-50%)', 'important');
                                modalContent.style.setProperty('margin', '0', 'important');
                                modalContent.style.setProperty('width', 'calc(100% - 40px)', 'important');
                                modalContent.style.setProperty('max-width', '500px', 'important');
                            }
                        }
                    });
                } else {
                    // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ CSS)
                    const modalContent = modal.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.style.position = '';
                        modalContent.style.top = '';
                        modalContent.style.left = '';
                        modalContent.style.transform = '';
                        modalContent.style.margin = '';
                        modalContent.style.width = '';
                        modalContent.style.maxWidth = '';
                    }
                }
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–±—Ä–æ—Å–∞ –ø–ª–∞–Ω–∞
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –º–∞—Å—à—Ç–∞–±–µ
        function openScaleWarning(status, scaleMode, fromTable = false, taskIndex = null) {
            const modal = document.getElementById('scaleWarningModal');
            const warningText = document.getElementById('scaleWarningText');
            if (!modal || !warningText) return;
            
            // –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è,
            // —á—Ç–æ–±—ã currentStatusTarget –Ω–µ –±—ã–ª —Å–±—Ä–æ—à–µ–Ω
            // –ú–µ–Ω—é –±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω–æ, –Ω–æ currentStatusTarget –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞
            if (fromTable) {
                warningText.textContent = '–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –¥–ª—è –≤—Å–µ–≥–æ —Å—Ä–æ–∫–∞ –∑–∞–¥–∞—á–∏. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å?';
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                pendingStatusFromTable = { status, taskIndex };
                pendingStatusAfterScaleWarning = null;
            } else {
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–∞—Å—à—Ç–∞–±–∞
                let scaleText = '';
                if (scaleMode === 'week') {
                    scaleText = '–Ω–µ–¥–µ–ª–µ';
                } else if (scaleMode === 'month') {
                    scaleText = '–º–µ—Å—è—Ü—É';
                }
                
                warningText.textContent = `–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ–π ${scaleText}. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å?`;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                pendingStatusAfterScaleWarning = status;
                pendingStatusFromTable = null;
            }
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ body (–Ω–µ –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
            if (modal.parentElement !== document.body) {
                document.body.appendChild(modal);
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è –≤—Å–µ–≥–æ —ç–∫—Ä–∞–Ω–∞
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.75)';
            modal.style.zIndex = '10002';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.overflow = 'auto';
            modal.style.padding = '20px';
            modal.style.boxSizing = 'border-box';
            modal.classList.add('show');
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫ –Ω–∞—á–∞–ª—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –≤–∏–¥–∏–º–æ–π –∑–æ–Ω–µ
            modal.scrollTop = 0;
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.scrollTop = 0;
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Å—Ç–∏–ª–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
                modalContent.style.position = '';
                modalContent.style.top = '';
                modalContent.style.left = '';
                modalContent.style.transform = '';
                modalContent.style.margin = '';
                modalContent.style.width = '';
                modalContent.style.maxWidth = '';
            }
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫ –≤–µ—Ä—Ö—É –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            window.scrollTo(0, 0);
            if (document.documentElement) {
                document.documentElement.scrollTop = 0;
            }
            if (document.body) {
                document.body.scrollTop = 0;
            }
        }
        
        function cancelScaleWarning() {
            const modal = document.getElementById('scaleWarningModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                modal.style.position = '';
                modal.style.top = '';
                modal.style.left = '';
                modal.style.width = '';
                modal.style.height = '';
                modal.style.backgroundColor = '';
                modal.style.zIndex = '';
                modal.style.alignItems = '';
                modal.style.justifyContent = '';
                modal.style.overflow = '';
                modal.style.padding = '';
                modal.style.boxSizing = '';
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.position = '';
                    modalContent.style.top = '';
                    modalContent.style.left = '';
                    modalContent.style.transform = '';
                    modalContent.style.margin = '';
                    modalContent.style.width = '';
                    modalContent.style.maxWidth = '';
                }
            }
            pendingStatusAfterScaleWarning = null;
            pendingStatusTargetAfterScaleWarning = null;
            pendingStatusFromTable = null;
            closeStatusMenu();
        }
        
        function confirmScaleWarning() {
            const modal = document.getElementById('scaleWarningModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                modal.style.position = '';
                modal.style.top = '';
                modal.style.left = '';
                modal.style.width = '';
                modal.style.height = '';
                modal.style.backgroundColor = '';
                modal.style.zIndex = '';
                modal.style.alignItems = '';
                modal.style.justifyContent = '';
                modal.style.overflow = '';
                modal.style.padding = '';
                modal.style.boxSizing = '';
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            if (pendingStatusFromTable) {
                const { status, taskIndex } = pendingStatusFromTable;
                pendingStatusFromTable = null;
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –∫ –∑–∞–¥–∞—á–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                applyStatusFromTable(status, taskIndex);
                return;
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ –º–∞—Å—à—Ç–∞–±–∞ (–Ω–µ–¥–µ–ª—è/–º–µ—Å—è—Ü)
            if (pendingStatusAfterScaleWarning) {
                const status = pendingStatusAfterScaleWarning;
                pendingStatusAfterScaleWarning = null;
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º currentStatusTarget –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ
                if (pendingStatusTargetAfterScaleWarning) {
                    currentStatusTarget = pendingStatusTargetAfterScaleWarning;
                    pendingStatusTargetAfterScaleWarning = null;
                }
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å
                // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —Ç—Ä–µ–±—É–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                if (status === 'in-progress' || status === 'completed') {
                    pendingStatusForComment = status;
                    openStatusCommentModal();
                } else {
                    applyStatusToSelection(status);
                }
            }
        }
        
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫ –∑–∞–¥–∞—á–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        function applyStatusFromTable(status, taskIndex) {
            const task = tasks[taskIndex];
            if (!task) return;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞
            addToUndoHistory();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
            task.status = status;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ –≤—Å–µ–º –¥–∞—Ç–∞–º –∑–∞–¥–∞—á–∏
            task.dateStatuses = {};
            if (status === 'in-progress' || status === 'completed') {
                task.dates.forEach(d => {
                    const key = formatDateKey(d);
                    task.dateStatuses[key] = status;
                });
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ select
            const statusSelect = document.querySelector(`select[data-index="${taskIndex}"][data-field="status"]`);
            if (statusSelect) {
                statusSelect.value = status;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            updateStatistics();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            if (searchResults.length > 0) {
                highlightSearchResults();
            }
            if (currentView === 'gantt') {
                renderGantt();
            }
            renderTable();
            
            // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (—Å—Ç–∞—Ç—É—Å—ã)
            console.log('üíæ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: —Å—Ç–∞—Ç—É—Å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ');
            saveFullGanttState();
        }

        function cancelResetPlan() {
            const modal = document.getElementById('resetPlanConfirmModal');
            if (modal) {
                modal.style.display = 'none';
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.position = '';
                    modalContent.style.top = '';
                    modalContent.style.left = '';
                    modalContent.style.transform = '';
                    modalContent.style.margin = '';
                    modalContent.style.width = '';
                    modalContent.style.maxWidth = '';
                }
            }
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–±—Ä–æ—Å –ø–ª–∞–Ω–∞ –∫ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
        async function confirmResetPlan() {
            if (!canEdit()) {
                return; // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–±—Ä–æ—Å –ø–ª–∞–Ω–∞ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–º–µ–Ω—ã –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º
            // –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –æ—Ç–∫–∞—Ç–∏—Ç—å —Å–±—Ä–æ—Å —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–Ω–∞–∑–∞–¥"
            console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–º–µ–Ω—ã –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º');
            addToUndoHistory();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –±—ã–ª–æ —Å–±—Ä–æ—Å–æ–º –ø–ª–∞–Ω–∞
            lastActionWasReset = true;
            
            startDate = new Date(INITIAL_START_DATE);
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫–µ–ª–µ—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
            await loadSkeletonFromServer();
            
            await initializeTasks();
            renderGantt();
            renderTable();
            updateStatistics();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            if (searchResults.length > 0) {
                highlightSearchResults();
            }
            autoSaveGanttState(); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞
            cancelResetPlan(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        }
        

        function toggleView() {
            currentView = currentView === 'gantt' ? 'table' : 'gantt';
            updateViewToggleUI();
            updateViewPanelsUI();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞—Ä–æ–≤ –≤ –ì–∞–Ω—Ç–µ: —Ç–æ—á–∫–∏ –ø–æ –¥–Ω—è–º / —Å–ª–∏—Ç–Ω—ã–µ –ø–æ–ª–æ—Å—ã
        function toggleLinkColumn() {
            showLink = !showLink;

            const btn = document.getElementById('linkToggleBtn');
            if (btn) {
                if (showLink) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }

            // –£–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å–æ–º –Ω–∞ body –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è/—Å–∫—Ä—ã—Ç–∏—è –∫–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
            if (showLink) {
                document.body.classList.add('show-link');
            } else {
                document.body.classList.remove('show-link');
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∏ –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π
            const scrollY = window.scrollY || window.pageYOffset;
            const scrollX = window.scrollX || window.pageXOffset;
            const chartContainer = document.getElementById('ganttChart');
            const chartScrollTop = chartContainer ? chartContainer.scrollTop : 0;
            const chartScrollLeft = chartContainer ? chartContainer.scrollLeft : 0;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏ —É–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É
            const activeElement = document.activeElement;
            const activeElementInfo = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA') 
                ? { element: activeElement, selectionStart: activeElement.selectionStart, selectionEnd: activeElement.selectionEnd }
                : null;
            
            if (activeElementInfo) {
                activeElementInfo.element.blur();
            }

            renderGantt();
            renderTable();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å—Ä–∞–∑—É, –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
            window.scrollTo(scrollX, scrollY);
            const newChartContainer = document.getElementById('ganttChart');
            if (newChartContainer) {
                newChartContainer.scrollTop = chartScrollTop;
                newChartContainer.scrollLeft = chartScrollLeft;
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏)
            if (activeElementInfo && document.contains(activeElementInfo.element)) {
                requestAnimationFrame(() => {
                    try {
                        activeElementInfo.element.focus({ preventScroll: true });
                        if (activeElementInfo.element.setSelectionRange && 
                            activeElementInfo.selectionStart !== null && 
                            activeElementInfo.selectionEnd !== null) {
                            activeElementInfo.element.setSelectionRange(
                                activeElementInfo.selectionStart, 
                                activeElementInfo.selectionEnd
                            );
                        }
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–æ–∫—É—Å–∞
                    }
                });
            }
        }

        function toggleResponsibleColumn() {
            showResponsible = !showResponsible;

            const btn = document.getElementById('responsibleToggleBtn');
            if (btn) {
                if (showResponsible) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }

            // –£–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å–æ–º –Ω–∞ body –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è/—Å–∫—Ä—ã—Ç–∏—è –∫–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
            if (showResponsible) {
                document.body.classList.add('show-responsible');
            } else {
                document.body.classList.remove('show-responsible');
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∏ –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π
            const scrollY = window.scrollY || window.pageYOffset;
            const scrollX = window.scrollX || window.pageXOffset;
            const chartContainer = document.getElementById('ganttChart');
            const chartScrollTop = chartContainer ? chartContainer.scrollTop : 0;
            const chartScrollLeft = chartContainer ? chartContainer.scrollLeft : 0;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏ —É–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É
            const activeElement = document.activeElement;
            const activeElementInfo = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA') 
                ? { element: activeElement, selectionStart: activeElement.selectionStart, selectionEnd: activeElement.selectionEnd }
                : null;
            
            if (activeElementInfo) {
                activeElementInfo.element.blur();
            }

            renderGantt();
            renderTable();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å—Ä–∞–∑—É, –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
            window.scrollTo(scrollX, scrollY);
            const newChartContainer = document.getElementById('ganttChart');
            if (newChartContainer) {
                newChartContainer.scrollTop = chartScrollTop;
                newChartContainer.scrollLeft = chartScrollLeft;
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏)
            if (activeElementInfo && document.contains(activeElementInfo.element)) {
                requestAnimationFrame(() => {
                    try {
                        activeElementInfo.element.focus({ preventScroll: true });
                        if (activeElementInfo.element.setSelectionRange && 
                            activeElementInfo.selectionStart !== null && 
                            activeElementInfo.selectionEnd !== null) {
                            activeElementInfo.element.setSelectionRange(
                                activeElementInfo.selectionStart, 
                                activeElementInfo.selectionEnd
                            );
                        }
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–æ–∫—É—Å–∞
                    }
                });
            }
        }

        function toggleGanttBarStyle() {
            ganttBarStyle = ganttBarStyle === 'dots' ? 'segments' : 'dots';

            const btn = document.getElementById('ganttStyleToggleBtn');
            if (btn) {
                const labelSpan = btn.querySelector('span');
                if (ganttBarStyle === 'segments') {
                    // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –æ–±—â–∏–π –≤–∏–¥ (—Å–ø–ª–æ—à–Ω—ã–µ –ø–æ–ª–æ—Å—ã)
                    btn.classList.add('active');
                    if (labelSpan) labelSpan.textContent = '–û–±—â–∏–π –≤–∏–¥';
                } else {
                    // –î–µ—Ç–∞–ª—å–Ω—ã–π –≤–∏–¥ –ø–æ –¥–Ω—è–º ‚Äî –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
                    btn.classList.remove('active');
                    if (labelSpan) labelSpan.textContent = '–î–µ—Ç–∞–ª—å–Ω—ã–π –≤–∏–¥';
                }
            }

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å –Ω–∞ body, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–æ—Å.
            // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ç–æ—Ä–æ–π –∞—Ä–≥—É–º–µ–Ω—Ç —É classList.toggle –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –±–æ–ª–µ–µ —Å—Ç–∞—Ä—ã–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞–º–∏.
            if (ganttBarStyle === 'segments') {
                document.body.classList.add('gantt-style-segments');
            } else {
                document.body.classList.remove('gantt-style-segments');
            }

            renderGantt();
        }

        function updateViewToggleUI() {
            const ganttPart = document.querySelector('.view-toggle-gantt');
            const tablePart = document.querySelector('.view-toggle-table');
            if (!ganttPart || !tablePart) return;

            if (currentView === 'gantt') {
                ganttPart.classList.add('active');
                tablePart.classList.remove('active');
            } else {
                ganttPart.classList.remove('active');
                tablePart.classList.add('active');
            }
        }

        function updateViewPanelsUI() {
            const chartContainer = document.querySelector('.chart-container');
            const tableSection = document.querySelector('.table-section');
            if (!chartContainer || !tableSection) return;

            if (currentView === 'gantt') {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ì–∞–Ω—Ç —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –º–æ—Ä–≥–∞–Ω–∏—è
                chartContainer.classList.remove('view-hidden');
                chartContainer.classList.add('view-active');
                
                // –ó–∞—Ç–µ–º —Å–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
                tableSection.classList.remove('view-active');
                tableSection.classList.add('view-hidden');
            } else {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –º–æ—Ä–≥–∞–Ω–∏—è
                tableSection.classList.remove('view-hidden');
                tableSection.classList.add('view-active');
                
                // –ó–∞—Ç–µ–º —Å–∫—Ä—ã–≤–∞–µ–º –ì–∞–Ω—Ç
                chartContainer.classList.remove('view-active');
                chartContainer.classList.add('view-hidden');
            }
        }

        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç—Ç–∞–ø–æ–≤ ---

        function openStageSettingsModal(event) {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            if (!canEdit()) {
                return;
            }
            buildStageSettingsList();
            const modal = document.getElementById('stageSettingsModal');
            if (!modal) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–Ω–æ–ø–∫—É, –∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ –Ω–∞–∂–∞—Ç–∞
            const button = event ? (event.currentTarget || event.target) : document.querySelector('.stage-settings-btn');
            
            modal.style.display = 'block';
            
            // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –∏ –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π
            const isMobile = window.innerWidth <= 1024;
            if (isMobile && button) {
                // –î–≤–æ–π–Ω–æ–π requestAnimationFrame –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏–ª—Å—è
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        const modalContent = modal.querySelector('.modal-content');
                        if (!modalContent) return;
                        
                        const buttonRect = button.getBoundingClientRect();
                        const viewportHeight = window.innerHeight;
                        const viewportWidth = window.innerWidth;
                        
                        // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
                        const modalRect = modalContent.getBoundingClientRect();
                        const modalHeight = modalRect.height || 400; // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        const modalWidth = Math.min(modalRect.width || 500, viewportWidth - 40);
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ —Å–≤–µ—Ä—Ö—É –∏ —Å–Ω–∏–∑—É –æ—Ç –∫–Ω–æ–ø–∫–∏
                        const spaceBelow = viewportHeight - buttonRect.bottom;
                        const spaceAbove = buttonRect.top;
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≥–¥–µ –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞ - —Å–≤–µ—Ä—Ö—É –∏–ª–∏ —Å–Ω–∏–∑—É
                        let topPosition;
                        if (spaceBelow < modalHeight + 20 && spaceAbove > spaceBelow) {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–¥ –∫–Ω–æ–ø–∫–æ–π
                            topPosition = buttonRect.top - modalHeight - 20;
                        } else {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π
                            topPosition = buttonRect.bottom + 20;
                        }
                        
                        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ–∫–Ω–æ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞
                        const minTop = 20;
                        const maxTop = viewportHeight - modalHeight - 20;
                        topPosition = Math.max(minTop, Math.min(topPosition, maxTop));
                        
                        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
                        const leftPosition = (viewportWidth - modalWidth) / 2;
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                        modalContent.style.setProperty('position', 'fixed', 'important');
                        modalContent.style.setProperty('top', topPosition + 'px', 'important');
                        modalContent.style.setProperty('left', leftPosition + 'px', 'important');
                        modalContent.style.setProperty('transform', 'none', 'important');
                        modalContent.style.setProperty('margin', '0', 'important');
                        modalContent.style.setProperty('width', 'calc(100% - 40px)', 'important');
                        modalContent.style.setProperty('max-width', '500px', 'important');
                    });
                });
            } else {
                // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
                requestAnimationFrame(() => {
                    const modalContent = modal.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.style.removeProperty('position');
                        modalContent.style.removeProperty('top');
                        modalContent.style.removeProperty('left');
                        modalContent.style.removeProperty('transform');
                        modalContent.style.removeProperty('margin');
                        modalContent.style.removeProperty('width');
                        modalContent.style.removeProperty('max-width');
                    }
                });
            }
        }

        function closeStageSettingsModal() {
            const modal = document.getElementById('stageSettingsModal');
            if (modal) {
                modal.style.display = 'none';
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.removeProperty('position');
                    modalContent.style.removeProperty('top');
                    modalContent.style.removeProperty('left');
                    modalContent.style.removeProperty('transform');
                    modalContent.style.removeProperty('margin');
                    modalContent.style.removeProperty('width');
                    modalContent.style.removeProperty('max-width');
                }
            }

            // –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–∞–ø–æ–≤ –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º "–í—Å–µ —ç—Ç–∞–ø—ã"
            currentStageFilter = 'all';
            renderStageTabs();
            renderGantt();
            renderTable();
            applySelectionHighlight();
        }

        function openStageDeleteModal(shortName) {
            pendingStageToDelete = shortName;
            const modal = document.getElementById('stageDeleteModal');
            const text = document.getElementById('stageDeleteText');
            if (text && shortName) {
                text.textContent = `–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–∞–ø "${shortName}" —Å–æ –≤—Å–µ–º–∏ –µ–≥–æ –∑–∞–¥–∞—á–∞–º–∏?`;
            }
            if (modal) {
                modal.style.display = 'block';
            }
        }

        function openRenameStageModal(shortName) {
            pendingStageToRename = shortName;
            const modal = document.getElementById('renameStageModal');
            const input = document.getElementById('renameStageInput');
            if (input && shortName) {
                input.value = shortName;
            }
            if (modal) {
                modal.style.display = 'block';
                // –§–æ–∫—É—Å –Ω–∞ input –∏ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
                setTimeout(() => {
                    if (input) {
                        input.focus();
                        input.select();
                    }
                }, 100);
            }
        }

        function closeRenameStageModal() {
            const modal = document.getElementById('renameStageModal');
            if (modal) {
                modal.style.display = 'none';
            }
            pendingStageToRename = null;
            const input = document.getElementById('renameStageInput');
            if (input) {
                input.value = '';
            }
        }

        function confirmRenameStage() {
            if (!pendingStageToRename) return;
            const input = document.getElementById('renameStageInput');
            if (!input) return;
            
            const newName = input.value.trim();
            if (!newName || newName === pendingStageToRename) {
                closeRenameStageModal();
                return;
            }
            
            renameStage(pendingStageToRename, newName);
            closeRenameStageModal();
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —ç—Ç–∞–ø–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('renameStageModal');
            if (modal && event.target === modal) {
                closeRenameStageModal();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —ç—Ç–∞–ø–∞ –ø–æ Escape
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                const modal = document.getElementById('renameStageModal');
                if (modal && modal.style.display === 'block') {
                    closeRenameStageModal();
                }
            }
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–∞–∑–≤–∞–Ω–∏—è —ç—Ç–∞–ø–∞
        document.addEventListener('keydown', (event) => {
            const modal = document.getElementById('renameStageModal');
            if (modal && modal.style.display === 'block') {
                const input = document.getElementById('renameStageInput');
                if (input && document.activeElement === input) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        confirmRenameStage();
                    }
                }
            }
        });

        function openStatusCommentModal() {
            const modal = document.getElementById('statusCommentModal');
            const input = document.getElementById('statusCommentInput');
            if (!modal || !input || !pendingStatusForComment) return;
            
            // –ü—Ä—è—á–µ–º –º–µ–Ω—é, –Ω–æ –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º currentStatusTarget,
            // —á—Ç–æ–±—ã –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–º–µ–Ω–∏–ª—Å—è –∫ –Ω—É–∂–Ω—ã–º –¥–∞—Ç–∞–º.
            const menu = document.getElementById('statusMenu');
            if (menu) {
                menu.style.display = 'none';
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–ª—å —Å—Ç–∞—Ç—É—Å–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–Ω–∞–ø—à–æ—Ç,
            // —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –µ—ë –¥–∞–∂–µ –µ—Å–ª–∏ currentStatusTarget –≥–¥–µ-—Ç–æ –æ–±–Ω—É–ª–∏—Ç—Å—è.
            if (currentStatusTarget && currentStatusTarget.isMultiple) {
                // –î–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç
                window.__statusCommentTargetSnapshot = {
                    isMultiple: true,
                    cells: [...currentStatusTarget.cells],
                    groupedByTask: { ...currentStatusTarget.groupedByTask }
                };
            } else {
                window.__statusCommentTargetSnapshot = currentStatusTarget ? {
                    taskId: currentStatusTarget.taskId,
                    dateStrs: Array.isArray(currentStatusTarget.dateStrs)
                        ? [...currentStatusTarget.dateStrs]
                        : [currentStatusTarget.dateStrs]
                } : null;
            }
            
            input.value = '';
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ body (–Ω–µ –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
            if (modal.parentElement !== document.body) {
                document.body.appendChild(modal);
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è —ç–∫—Ä–∞–Ω–∞
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.zIndex = '10000';
            modal.style.overflow = 'auto';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Å—Ç–∏–ª–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.style.position = '';
                modalContent.style.top = '';
                modalContent.style.left = '';
                modalContent.style.transform = '';
                modalContent.style.margin = '';
                modalContent.style.width = '';
                modalContent.style.maxWidth = '';
                modalContent.style.maxHeight = '';
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
            modal.style.alignItems = '';
            modal.style.justifyContent = '';
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫ –≤–µ—Ä—Ö—É - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã
            window.scrollTo(0, 0);
            if (document.documentElement) {
                document.documentElement.scrollTop = 0;
                document.documentElement.scrollLeft = 0;
            }
            if (document.body) {
                document.body.scrollTop = 0;
                document.body.scrollLeft = 0;
            }
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            const scrollableElements = document.querySelectorAll('.gantt-chart, .chart-container, .tasks-table-wrapper, [style*="overflow"]');
            scrollableElements.forEach(el => {
                if (el.scrollTop !== undefined) {
                    el.scrollTop = 0;
                }
            });
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'flex' –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤ –Ω–∞—á–∞–ª–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            modal.scrollTop = 0;
            modal.scrollLeft = 0;
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            setTimeout(() => {
                // –ï—â–µ —Ä–∞–∑ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
                window.scrollTo(0, 0);
                if (document.documentElement) {
                    document.documentElement.scrollTop = 0;
                }
                if (document.body) {
                    document.body.scrollTop = 0;
                }
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤—Å–µ —Å–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –µ—â–µ —Ä–∞–∑
                scrollableElements.forEach(el => {
                    if (el.scrollTop !== undefined) {
                        el.scrollTop = 0;
                    }
                });
                
                modal.scrollTop = 0;
                if (modalContent) {
                    modalContent.scrollTop = 0;
                }
                input.focus();
            }, 100);
        }

        function confirmStatusComment() {
            const modal = document.getElementById('statusCommentModal');
            const input = document.getElementById('statusCommentInput');
            if (!modal || !input || !pendingStatusForComment) return;
            const text = input.value || '';
            const status = pendingStatusForComment;
            pendingStatusForComment = null;
            modal.style.display = 'none';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.style.position = '';
                modalContent.style.top = '';
                modalContent.style.left = '';
                modalContent.style.transform = '';
                modalContent.style.margin = '';
                modalContent.style.width = '';
                modalContent.style.maxWidth = '';
                modalContent.style.maxHeight = '';
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            modal.style.position = '';
            modal.style.top = '';
            modal.style.left = '';
            modal.style.width = '';
            modal.style.height = '';
            modal.style.zIndex = '';
            modal.style.overflow = '';
            modal.style.alignItems = '';
            modal.style.justifyContent = '';
            
            // –£–ë–†–ê–ù–û: –ú–∞—Å—Å–æ–≤–æ–µ –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–º –∑–∞–¥–∞—á–∞–º
            // –¢–µ–ø–µ—Ä—å —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –∫–ª–∏–∫–Ω—É–ª–∏
            // –ú–∞—Å—Å–æ–≤–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ Shift –æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ, –≤—Å—Ç–∞–≤–∫–∞ –∏ —Ç.–¥.)
            
            const targetSnapshot = window.__statusCommentTargetSnapshot || null;
            applyStatusToSelection(status, text, targetSnapshot);
        }

        function cancelStatusComment() {
            const modal = document.getElementById('statusCommentModal');
            if (modal) {
                modal.style.display = 'none';
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.position = '';
                    modalContent.style.top = '';
                    modalContent.style.left = '';
                    modalContent.style.transform = '';
                    modalContent.style.margin = '';
                    modalContent.style.width = '';
                    modalContent.style.maxWidth = '';
                    modalContent.style.maxHeight = '';
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                modal.style.position = '';
                modal.style.top = '';
                modal.style.left = '';
                modal.style.width = '';
                modal.style.height = '';
                modal.style.zIndex = '';
                modal.style.overflow = '';
                modal.style.alignItems = '';
                modal.style.justifyContent = '';
            }
            pendingStatusForComment = null;
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–π input
        let currentTextInputElement = null;

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
        function openTextInputModal(inputElement) {
            console.log('üîç openTextInputModal –≤—ã–∑–≤–∞–Ω–∞', inputElement);
            
            if (!canEdit()) {
                console.log('‚ùå –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                return;
            }
            
            if (!inputElement) {
                console.log('‚ùå inputElement –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω');
                return;
            }
            
            currentTextInputElement = inputElement;
            const modal = document.getElementById('textInputModal');
            const textarea = document.getElementById('textInputModalTextarea');
            const title = document.getElementById('textInputModalTitle');
            const label = document.getElementById('textInputModalLabel');
            
            if (!modal) {
                console.error('‚ùå –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ textInputModal –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ DOM');
                return;
            }
            
            if (!textarea) {
                console.error('‚ùå textarea textInputModalTextarea –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ DOM');
                return;
            }
            
            console.log('‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–π–¥–µ–Ω–æ, –æ—Ç–∫—Ä—ã–≤–∞–µ–º...');
            console.log('üìã –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è:', inputElement.value);
            console.log('üìã data-field:', inputElement.getAttribute('data-field'));
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è –∏–∑ data-field
            const fieldName = inputElement.getAttribute('data-field');
            const fieldLabels = {
                'stageSuffix': '–≠—Ç–∞–ø',
                'taskTitle': '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ',
                'control': '–í–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è',
                'responsible': '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'
            };
            
            const fieldLabel = fieldLabels[fieldName] || '–ü–æ–ª–µ';
            title.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${fieldLabel}`;
            label.textContent = `–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è "${fieldLabel}":`;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            textarea.value = inputElement.value || '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            modal.style.display = 'block';
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä—è–¥–æ–º —Å input –ø–æ–ª–µ–º
            requestAnimationFrame(() => {
                const modalContent = modal.querySelector('.modal-content');
                if (!modalContent) return;
                
                const viewportHeight = window.innerHeight;
                const viewportWidth = window.innerWidth;
                const isMobile = window.innerWidth <= 1024;
                
                // –ü—Ä–∏–º–µ—Ä–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–±—É–¥—É—Ç —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ—Å–ª–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
                const estimatedModalWidth = isMobile ? Math.min(500, viewportWidth - 40) : 500;
                const estimatedModalHeight = 280;
                
                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã input –ø–æ–ª—è
                const rect = inputElement.getBoundingClientRect();
                const inputTop = rect.top;
                const inputLeft = rect.left;
                const inputRight = rect.right;
                const inputBottom = rect.bottom;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
                const spaceBelow = viewportHeight - inputBottom;
                const spaceAbove = inputTop;
                const spaceRight = viewportWidth - inputRight;
                const spaceLeft = inputLeft;
                
                let topPosition, leftPosition;
                
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: —Å—Ç–∞—Ä–∞–µ–º—Å—è —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –Ω–∏–∂–µ input
                if (spaceBelow >= estimatedModalHeight + 20) {
                    // –†–∞–∑–º–µ—â–∞–µ–º –Ω–∏–∂–µ input
                    topPosition = inputBottom + 10;
                } else if (spaceAbove >= estimatedModalHeight + 20) {
                    // –†–∞–∑–º–µ—â–∞–µ–º –≤—ã—à–µ input
                    topPosition = inputTop - estimatedModalHeight - 10;
                } else {
                    // –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ - —Ä–∞–∑–º–µ—â–∞–µ–º –ø–æ —Ü–µ–Ω—Ç—Ä—É —ç–∫—Ä–∞–Ω–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ
                    topPosition = Math.max(20, (viewportHeight - estimatedModalHeight) / 2);
                }
                
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: —Å—Ç–∞—Ä–∞–µ–º—Å—è —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —Å–ø—Ä–∞–≤–∞ –æ—Ç input
                if (spaceRight >= estimatedModalWidth + 20) {
                    // –†–∞–∑–º–µ—â–∞–µ–º —Å–ø—Ä–∞–≤–∞ –æ—Ç input
                    leftPosition = inputRight + 10;
                } else if (spaceLeft >= estimatedModalWidth + 20) {
                    // –†–∞–∑–º–µ—â–∞–µ–º —Å–ª–µ–≤–∞ –æ—Ç input
                    leftPosition = inputLeft - estimatedModalWidth - 10;
                } else {
                    // –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ - —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
                    leftPosition = (viewportWidth - estimatedModalWidth) / 2;
                }
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ viewport
                const minTop = 20;
                const maxTop = viewportHeight - estimatedModalHeight - 20;
                topPosition = Math.max(minTop, Math.min(topPosition, maxTop));
                
                const minLeft = 20;
                const maxLeft = viewportWidth - estimatedModalWidth - 20;
                leftPosition = Math.max(minLeft, Math.min(leftPosition, maxLeft));
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                modalContent.style.setProperty('position', 'fixed', 'important');
                modalContent.style.setProperty('top', topPosition + 'px', 'important');
                modalContent.style.setProperty('left', leftPosition + 'px', 'important');
                modalContent.style.setProperty('transform', 'none', 'important');
                modalContent.style.setProperty('margin', '0', 'important');
                modalContent.style.setProperty('width', isMobile ? 'calc(100% - 40px)' : estimatedModalWidth + 'px', 'important');
                modalContent.style.setProperty('max-width', isMobile ? '500px' : '600px', 'important');
                modalContent.style.setProperty('z-index', '10001', 'important');
                
                // –ü–æ—Å–ª–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é —Å —É—á–µ—Ç–æ–º —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
                setTimeout(() => {
                    const actualRect = modalContent.getBoundingClientRect();
                    const actualHeight = actualRect.height;
                    const actualWidth = actualRect.width;
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    if (topPosition + actualHeight > viewportHeight - 20) {
                        topPosition = Math.max(20, viewportHeight - actualHeight - 20);
                        modalContent.style.setProperty('top', topPosition + 'px', 'important');
                    }
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    if (leftPosition + actualWidth > viewportWidth - 20) {
                        leftPosition = Math.max(20, viewportWidth - actualWidth - 20);
                        modalContent.style.setProperty('left', leftPosition + 'px', 'important');
                    }
                }, 10);
            });
            
            // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ textarea
            setTimeout(() => {
                textarea.focus();
                textarea.select();
            }, 100);
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function saveTextInputModal() {
            if (!currentTextInputElement) return;
            
            const modal = document.getElementById('textInputModal');
            const textarea = document.getElementById('textInputModalTextarea');
            
            if (!modal || !textarea) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º input
            currentTextInputElement.value = textarea.value;
            
            // –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
            const changeEvent = new Event('change', { bubbles: true });
            currentTextInputElement.dispatchEvent(changeEvent);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            closeTextInputModal();
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
        function closeTextInputModal() {
            const modal = document.getElementById('textInputModal');
            if (modal) {
                modal.style.display = 'none';
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.position = '';
                    modalContent.style.top = '';
                    modalContent.style.left = '';
                    modalContent.style.transform = '';
                    modalContent.style.margin = '';
                    modalContent.style.width = '';
                    modalContent.style.maxWidth = '';
                }
            }
            currentTextInputElement = null;
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('textInputModal');
            if (modal && event.target === modal) {
                closeTextInputModal();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ Escape
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                const modal = document.getElementById('textInputModal');
                if (modal && modal.style.display === 'block') {
                    closeTextInputModal();
                }
            }
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ Enter (Ctrl+Enter –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ Enter –≤ textarea)
        document.addEventListener('keydown', (event) => {
            const modal = document.getElementById('textInputModal');
            if (modal && modal.style.display === 'block') {
                const textarea = document.getElementById('textInputModalTextarea');
                if (textarea && document.activeElement === textarea) {
                    if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
                        event.preventDefault();
                        saveTextInputModal();
                    }
                }
            }
        });

        function cancelDeleteStage() {
            const modal = document.getElementById('stageDeleteModal');
            if (modal) {
                modal.style.display = 'none';
            }
            pendingStageToDelete = null;
        }

        function confirmDeleteStage() {
            if (!canEdit()) {
                return; // –ë–ª–æ–∫–∏—Ä—É–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            }
            if (pendingStageToDelete) {
                deleteStage(pendingStageToDelete);
            }
            cancelDeleteStage();
        }

        function buildStageSettingsList() {
            const list = document.getElementById('stageSettingsList');
            if (!list) return;
            list.innerHTML = '';

            stageConfig.forEach((shortName, index) => {
                const item = document.createElement('div');
                item.className = 'stage-settings-item';
                item.draggable = canEdit(); // –ë–ª–æ–∫–∏—Ä—É–µ–º drag&drop —ç—Ç–∞–ø–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                item.dataset.index = String(index);

                item.addEventListener('dragstart', () => {
                    if (!canEdit()) {
                        return;
                    }
                    draggedStageIndex = index;
                    item.classList.add('dragging');
                });

                item.addEventListener('dragend', () => {
                    draggedStageIndex = null;
                    item.classList.remove('dragging');
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });

                item.addEventListener('drop', (e) => {
                    if (!canEdit()) {
                        e.preventDefault();
                        return;
                    }
                    e.preventDefault();
                    if (draggedStageIndex === null) return;
                    const targetIndex = parseInt(item.dataset.index, 10);
                    if (targetIndex === draggedStageIndex) return;

                    const [moved] = stageConfig.splice(draggedStageIndex, 1);
                    stageConfig.splice(targetIndex, 0, moved);
                    draggedStageIndex = null;

                    buildStageSettingsList();
                    renderStageTabs();
                });

                const left = document.createElement('div');
                left.className = 'stage-settings-left';

                const handle = document.createElement('div');
                handle.className = 'stage-settings-handle';
                handle.textContent = '‚â°';

                const nameEl = document.createElement('div');
                nameEl.className = 'stage-settings-name';
                nameEl.textContent = shortName;
                nameEl.title = '–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å';

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –Ω–∞ –≤—Å–µ–π —Å—Ç—Ä–æ–∫–µ (–Ω–æ –Ω–µ –Ω–∞ –∫–Ω–æ–ø–∫–µ —É–¥–∞–ª–µ–Ω–∏—è)
                item.addEventListener('dblclick', (e) => {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫–µ —É–¥–∞–ª–µ–Ω–∏—è
                    if (e.target.closest('.stage-settings-delete-btn')) {
                        return;
                    }
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –≤–æ –≤—Ä–µ–º—è drag
                    if (item.classList.contains('dragging')) {
                        return;
                    }
                    // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    if (!canEdit()) {
                        return;
                    }
                    e.preventDefault();
                    e.stopPropagation();
                    openRenameStageModal(shortName);
                });

                left.appendChild(handle);
                left.appendChild(nameEl);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'stage-settings-delete-btn';
                deleteBtn.type = 'button';
                deleteBtn.innerHTML = '<span>‚úï</span><span>–£–¥–∞–ª–∏—Ç—å</span>';
                deleteBtn.addEventListener('click', () => {
                    if (!canEdit()) {
                        return; // –ë–ª–æ–∫–∏—Ä—É–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    }
                    openStageDeleteModal(shortName);
                });

                item.appendChild(left);
                item.appendChild(deleteBtn);

                list.appendChild(item);
            });
        }

        async function deleteStage(shortName) {
            stageConfig = stageConfig.filter(name => name !== shortName);
            projectData = projectData.filter(item => !item.stage || !item.stage.startsWith(shortName));

            if (currentStageFilter === shortName) {
                currentStageFilter = 'all';
            }

            await initializeTasks();
            renderStageTabs();
            buildStageSettingsList();
        }

        async function addNewStage() {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–∞ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            if (!canEdit()) {
                return;
            }
            let maxNumber = 0;
            stageConfig.forEach(name => {
                const match = name.match(/^–≠—Ç–∞–ø\s+(\d+)/);
                if (match) {
                    const num = parseInt(match[1], 10);
                    if (num > maxNumber) maxNumber = num;
                }
            });

            const newNumber = maxNumber + 1 || 1;
            const shortName = `–≠—Ç–∞–ø ${newNumber}`;
            stageConfig.push(shortName);

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–Ω—É –ø—É—Å—Ç—É—é –∑–∞–¥–∞—á—É –¥–ª—è –Ω–æ–≤–æ–≥–æ —ç—Ç–∞–ø–∞
            projectData.push({
                stage: `${shortName}. –ù–æ–≤—ã–π —ç—Ç–∞–ø`,
                control: '',
                task: '',
                days: 1,
                substage: ''
            });

            currentStageFilter = shortName;
            await initializeTasks();
            renderStageTabs();
            buildStageSettingsList();
        }

        async function renameStage(oldShortName, newShortName) {
            stageConfig = stageConfig.map(name => name === oldShortName ? newShortName : name);

            projectData.forEach(item => {
                if (!item.stage) return;
                if (item.stage.startsWith(oldShortName)) {
                    item.stage = newShortName + item.stage.slice(oldShortName.length);
                }
            });

            if (currentStageFilter === oldShortName) {
                currentStageFilter = newShortName;
            }

            await initializeTasks();
            renderStageTabs();
            buildStageSettingsList();
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–æ–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
        function setZoom(level) {
            // clamp –æ—Ç 0.4 –¥–æ 2.0
            zoomLevel = Math.max(0.4, Math.min(2, level));
            const range = document.getElementById('zoomRange');
            if (range) {
                range.value = Math.round(zoomLevel * 100);
            }

            // –ï—Å–ª–∏ —Å–∏–ª—å–Ω–æ –æ—Ç–¥–∞–ª—è–µ–º—Å—è –∏ —Ä–∞–Ω–µ–µ –±—ã–ª –≤—ã–±—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–µ—Å—è—Ü,
            // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º "–ª–æ–∫–∞–ª—å–Ω—ã–π" –¥–∏–∞–ø–∞–∑–æ–Ω –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç
            if (zoomLevel <= 1.0 && (viewStartDate || viewEndDate)) {
                viewStartDate = null;
                viewEndDate = null;
            }

            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∏–∞–≥—Ä–∞–º–º—É –ì–∞–Ω—Ç–∞
            if (currentView === 'gantt') {
                renderGantt();
                // –ú–µ—Ç–∫–∏ —ç—Ç–∞–ø–æ–≤ –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –∑—É–º–µ - –æ–Ω–∏ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö
            }
        }

        function onZoomChange(value) {
            const numeric = Number(value) || 100;
            setZoom(numeric / 100);
        }

        function increaseZoom() {
            // –±–æ–ª–µ–µ –∫—Ä—É–ø–Ω—ã–π —à–∞–≥, —á—Ç–æ–±—ã —Ä–µ–∂–∏–º—ã –º–∞—Å—à—Ç–∞–±–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞–ª–∏—Å—å –∑–∞–º–µ—Ç–Ω–µ–µ
            setZoom(zoomLevel + 0.25);
        }

        function decreaseZoom() {
            // –±–æ–ª–µ–µ –∫—Ä—É–ø–Ω—ã–π —à–∞–≥, —á—Ç–æ–±—ã —Ä–µ–∂–∏–º—ã –º–∞—Å—à—Ç–∞–±–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞–ª–∏—Å—å –∑–∞–º–µ—Ç–Ω–µ–µ
            setZoom(zoomLevel - 0.25);
        }

        // –†–µ–∂–∏–º "z + –∫–æ–ª–µ—Å–æ" –¥–ª—è –∑—É–º–∞ –ø–æ –¥–∏–∞–≥—Ä–∞–º–º–µ
        let isZoomKeyPressed = false;

        // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á (drag & drop)
        let draggingTaskId = null;

        // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –±–∞—Ä–æ–≤ –≤ –¥–∏–∞–≥—Ä–∞–º–º–µ –ì–∞–Ω—Ç–∞
        let isDraggingBar = false;
        let draggingBarTaskId = null;
        let dragStartX = 0;
        let dragStartY = 0;
        let dragStartDate = null;
        let dragStartCell = null;
        let dragStartTime = 0;
        let dragStartRow = null; // –°—Ç—Ä–æ–∫–∞, —É –∫–æ—Ç–æ—Ä–æ–π –æ—Ç–∫–ª—é—á–µ–Ω draggable
        const DRAG_THRESHOLD = 5; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è

        // –†–µ—Å–∞–π–∑ (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏) –±–∞—Ä–æ–≤ –≤ –¥–∏–∞–≥—Ä–∞–º–º–µ –ì–∞–Ω—Ç–∞
        let isResizingBar = false;
        let resizingBarTaskId = null;
        let resizeStartX = 0;
        let resizeStartDays = 0;
        let resizeStartEndDate = null;
        let resizeStartStartDate = null; // –î–ª—è —Ä–µ—Å–∞–π–∑–∞ —Å–ª–µ–≤–∞
        let resizeDirection = null; // 'left' –∏–ª–∏ 'right'
        const RESIZE_EDGE_THRESHOLD = 8; // –ó–æ–Ω–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∫—Ä–∞—è –±–∞—Ä–∞ (–≤ –ø–∏–∫—Å–µ–ª—è—Ö)

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫—É—Ä—Å–æ—Ä —É –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–∞—Ä–∞ –∑–∞–¥–∞—á–∏
        function isNearBarRightEdge(event, taskId) {
            // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –∑–∞–¥–∞—á–∏
            const taskRow = document.querySelector(`.gantt-row[data-task-id="${taskId}"]`);
            if (!taskRow) return false;
            
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –±–∞—Ä—ã –≤ —Å—Ç—Ä–æ–∫–µ –∑–∞–¥–∞—á–∏
            const bars = taskRow.querySelectorAll('.gantt-bar');
            if (bars.length === 0) return false;
            
            // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–∞—Ä (–ø—Ä–∞–≤—ã–π –∫—Ä–∞–π –∑–∞–¥–∞—á–∏)
            const lastBar = bars[bars.length - 1];
            const barRect = lastBar.getBoundingClientRect();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫—É—Ä—Å–æ—Ä —É –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è
            const distanceFromRightEdge = barRect.right - event.clientX;
            return distanceFromRightEdge >= 0 && distanceFromRightEdge <= RESIZE_EDGE_THRESHOLD;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫—É—Ä—Å–æ—Ä —É –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è –ø–µ—Ä–≤–æ–≥–æ –±–∞—Ä–∞ –∑–∞–¥–∞—á–∏
        function isNearBarLeftEdge(event, taskId) {
            // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –∑–∞–¥–∞—á–∏
            const taskRow = document.querySelector(`.gantt-row[data-task-id="${taskId}"]`);
            if (!taskRow) return false;
            
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –±–∞—Ä—ã –≤ —Å—Ç—Ä–æ–∫–µ –∑–∞–¥–∞—á–∏
            const bars = taskRow.querySelectorAll('.gantt-bar');
            if (bars.length === 0) return false;
            
            // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –±–∞—Ä (–ª–µ–≤—ã–π –∫—Ä–∞–π –∑–∞–¥–∞—á–∏)
            const firstBar = bars[0];
            const barRect = firstBar.getBoundingClientRect();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫—É—Ä—Å–æ—Ä —É –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è
            const distanceFromLeftEdge = event.clientX - barRect.left;
            return distanceFromLeftEdge >= 0 && distanceFromLeftEdge <= RESIZE_EDGE_THRESHOLD;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ—Å–∞–π–∑–∞
        function resetBarResizeState() {
            isResizingBar = false;
            resizingBarTaskId = null;
            resizeStartX = 0;
            resizeStartDays = 0;
            resizeStartEndDate = null;
            resizeStartStartDate = null;
            resizeDirection = null;
            document.body.style.cursor = '';
            
            // –£–±–∏—Ä–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –∏–Ω–¥–∏–∫–∞—Ü–∏—é
            document.querySelectorAll('.gantt-bar').forEach(bar => {
                bar.style.opacity = '';
            });
            document.querySelectorAll('.resize-target').forEach(c => c.classList.remove('resize-target'));
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–∞
        function openStatusMenu(x, y, taskId, dateStrs, targetElement = null) {
            // dateStrs –º–æ–∂–µ—Ç –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º –¥–∞—Ç (–¥–ª—è –Ω–µ–¥–µ–ª—å/–º–µ—Å—è—Ü–µ–≤) –∏–ª–∏ –æ–¥–Ω–æ–π –¥–∞—Ç–æ–π (–¥–ª—è –¥–Ω–µ–π)
            const dateArray = Array.isArray(dateStrs) ? dateStrs : [dateStrs];
            currentStatusTarget = { taskId, dateStrs: dateArray };
            
            console.log('üìÇ openStatusMenu –≤—ã–∑–≤–∞–Ω–∞:', { 
                taskId, 
                dateStrs: dateArray, 
                currentStatusTarget,
                targetElement: !!targetElement
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
            lastClickCoordinates.x = x;
            lastClickCoordinates.y = y;
            
            const menu = document.getElementById('statusMenu');
            if (!menu) {
                console.error('‚ùå –ú–µ–Ω—é statusMenu –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ DOM!');
                return;
            }
            
            console.log('‚úÖ –ú–µ–Ω—é –Ω–∞–π–¥–µ–Ω–æ:', menu);
            
            // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü–µ—Ä–µ–º–µ—â–∞–µ–º –º–µ–Ω—é –≤ body –°–†–ê–ó–£, –¥–æ –≤—Å–µ—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
            // –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–¥–µ–ª–∞–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–µ –≤–Ω—É—Ç—Ä–∏ requestAnimationFrame
            const wasInBody = menu.parentElement === document.body;
            if (!wasInBody) {
                console.log('‚ö†Ô∏è –ú–µ–Ω—é –Ω–µ –≤ body, –ø–µ—Ä–µ–º–µ—â–∞–µ–º –°–†–ê–ó–£...', { 
                    currentParent: menu.parentElement?.tagName, 
                    currentParentId: menu.parentElement?.id,
                    currentParentClass: menu.parentElement?.className,
                    currentParentTransform: menu.parentElement ? window.getComputedStyle(menu.parentElement).transform : 'none'
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ —Å—Ç–∏–ª–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ–º
                const oldDisplay = menu.style.display;
                const oldVisibility = menu.style.visibility;
                
                // –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                menu.style.display = 'none';
                
                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤ body
                document.body.appendChild(menu);
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
                menu.style.display = oldDisplay || 'none';
                menu.style.visibility = oldVisibility || 'visible';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ
                if (menu.parentElement !== document.body) {
                    console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –º–µ–Ω—é –≤ body!');
                    return;
                } else {
                    console.log('‚úÖ –ú–µ–Ω—é —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ –≤ body');
                }
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –í–°–ï —Å—Ç–∏–ª–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –°–†–ê–ó–£, —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
            // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã position: fixed
            menu.style.cssText = ''; // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –≤—Å–µ inline —Å—Ç–∏–ª–∏
            menu.style.margin = '0';
            menu.style.padding = '0';
            menu.style.width = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —à–∏—Ä–∏–Ω—É, —á—Ç–æ–±—ã –º–µ–Ω—é –º–æ–≥–ª–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–≤–æ—é –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—É—é —à–∏—Ä–∏–Ω—É
            menu.style.height = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã –º–µ–Ω—é –º–æ–≥–ª–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–≤–æ—é –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É
            menu.style.display = 'block';
            menu.style.visibility = 'visible';
            menu.style.opacity = '1';
            menu.style.position = 'fixed';
            menu.style.zIndex = '99999'; // –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π z-index
            menu.style.left = '0px'; // –í—Ä–µ–º–µ–Ω–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º, —á—Ç–æ–±—ã –º–µ–Ω—é –±—ã–ª–æ –≤–∏–¥–∏–º–æ
            menu.style.top = '0px'; // –í—Ä–µ–º–µ–Ω–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º, —á—Ç–æ–±—ã –º–µ–Ω—é –±—ã–ª–æ –≤–∏–¥–∏–º–æ
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å transform
            let menuParent = menu.parentElement;
            let hasTransformParent = false;
            while (menuParent && menuParent !== document.body) {
                const parentStyle = window.getComputedStyle(menuParent);
                if (parentStyle.transform && parentStyle.transform !== 'none') {
                    hasTransformParent = true;
                    console.warn('‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç —Å transform:', {
                        tagName: menuParent.tagName,
                        id: menuParent.id,
                        className: menuParent.className,
                        transform: parentStyle.transform
                    });
                }
                menuParent = menuParent.parentElement;
            }
            
            if (hasTransformParent) {
                console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ú–µ–Ω—é –≤—Å–µ –µ—â–µ –≤–Ω—É—Ç—Ä–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å transform!');
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –º–µ–Ω—é –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –µ–≥–æ
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–≤–æ–π–Ω–æ–π requestAnimationFrame –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç—Å—è
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    const menuRect = menu.getBoundingClientRect();
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    
                    // –í–ê–ñ–ù–û: –í—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏ –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
                    // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–∂–µ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã x, y - –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏!
                    let referenceX = 0;
                    let referenceY = 0;
                    let cellRect = null;
                    
                    if (targetElement) {
                        // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏ –°–ï–ô–ß–ê–°, –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
                        // getBoundingClientRect() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏ (viewport)
                        // –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ position: fixed —ç—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞–ø—Ä—è–º—É—é
                        // –ù–ï –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã x, y - –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ!
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –≤—Å–µ –µ—â–µ –≤ DOM
                        if (!targetElement.isConnected) {
                            console.error('‚ùå targetElement –±–æ–ª—å—à–µ –Ω–µ –≤ DOM!');
                            return;
                        }
                        
                        // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏
                        cellRect = targetElement.getBoundingClientRect();
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–∞–ª–∏–¥–Ω—ã
                        if (cellRect.width === 0 && cellRect.height === 0) {
                            console.warn('‚ö†Ô∏è –Ø—á–µ–π–∫–∞ –∏–º–µ–µ—Ç –Ω—É–ª–µ–≤–æ–π —Ä–∞–∑–º–µ—Ä, –≤–æ–∑–º–æ–∂–Ω–æ –æ–Ω–∞ —Å–∫—Ä—ã—Ç–∞');
                        }
                        
                        referenceX = cellRect.right; // –ü—Ä–∞–≤—ã–π –∫—Ä–∞–π —è—á–µ–π–∫–∏
                        referenceY = cellRect.top + cellRect.height / 2; // –¶–µ–Ω—Ç—Ä —è—á–µ–π–∫–∏ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
                        
                        console.log('üìç –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏ (—Å —É—á–µ—Ç–æ–º –ø—Ä–æ–∫—Ä—É—Ç–∫–∏):', { 
                            cellRect: { 
                                left: cellRect.left, 
                                top: cellRect.top, 
                                right: cellRect.right, 
                                bottom: cellRect.bottom, 
                                width: cellRect.width, 
                                height: cellRect.height 
                            },
                            scrollY: window.scrollY || window.pageYOffset,
                            scrollX: window.scrollX || window.pageXOffset,
                            viewportHeight: window.innerHeight,
                            viewportWidth: window.innerWidth,
                            referenceX, 
                            referenceY,
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —è—á–µ–π–∫–∞ –≤–∏–¥–∏–º–∞ –≤ viewport
                            isVisible: cellRect.top >= 0 && cellRect.top < window.innerHeight && cellRect.left >= 0 && cellRect.left < window.innerWidth,
                            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                            passedX: x,
                            passedY: y,
                            differenceX: Math.abs(referenceX - x),
                            differenceY: Math.abs(referenceY - y)
                        });
                    } else {
                        // –ï—Å–ª–∏ targetElement –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —è—á–µ–π–∫—É –ø–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                        // –ù–æ —ç—Ç–æ –Ω–µ –Ω–∞–¥–µ–∂–Ω–æ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ - –ª—É—á—à–µ –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å targetElement!
                        console.error('‚ùå targetElement –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω! –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω–æ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ):', { 
                            x, 
                            y,
                            scrollY: window.scrollY || window.pageYOffset,
                            scrollX: window.scrollX || window.pageXOffset
                        });
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–∞–∫ fallback, –Ω–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω–æ
                        referenceX = x;
                        referenceY = y;
                    }
                    
                    console.log('üìç –ù–∞—á–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–Ω—é:', { 
                        referenceX, 
                        referenceY, 
                        menuWidth: menuRect.width, 
                        menuHeight: menuRect.height, 
                        viewportHeight, 
                        viewportWidth,
                        scrollY: window.scrollY || window.pageYOffset,
                        scrollX: window.scrollX || window.pageXOffset,
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö viewport
                        isXInViewport: referenceX >= 0 && referenceX <= viewportWidth,
                        isYInViewport: referenceY >= 0 && referenceY <= viewportHeight
                    });
                    
                    const offset = 8; // –û—Ç—Å—Ç—É–ø –æ—Ç —è—á–µ–π–∫–∏
                    
                    // –í–ê–ñ–ù–û: –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ position: fixed –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport
                    // getBoundingClientRect() —É–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport, —Ç–∞–∫ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö –Ω–∞–ø—Ä—è–º—É—é
                    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é —Å–ø—Ä–∞–≤–∞ –æ—Ç —è—á–µ–π–∫–∏
                    let left = referenceX + offset;
                    
                    // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏ –∏–∑ getBoundingClientRect() –≤–º–µ—Å—Ç–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∫–ª–∏–∫–∞
                    // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–∂–µ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ (y) –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω—ã–º–∏, –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–∫—Ä—É—á–µ–Ω–∞
                    let top;
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å —è—á–µ–π–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–æ–Ω–∏ —É–∂–µ –≤ viewport)
                    if (cellRect) {
                        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é —Ç–∞–∫, —á—Ç–æ–±—ã –µ–≥–æ —Ü–µ–Ω—Ç—Ä –±—ã–ª —Ä—è–¥–æ–º —Å —Ü–µ–Ω—Ç—Ä–æ–º —è—á–µ–π–∫–∏
                        top = cellRect.top + (cellRect.height / 2) - (menuRect.height / 2);
                        console.log('üìç –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏ –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', {
                            cellTop: cellRect.top,
                            cellHeight: cellRect.height,
                            cellCenter: cellRect.top + (cellRect.height / 2),
                            calculatedTop: top,
                            menuHeight: menuRect.height
                        });
                    } else {
                        // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞, –Ω–æ —ç—Ç–æ –º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–Ω–æ
                        top = y - (menuRect.height / 2);
                        console.warn('‚ö†Ô∏è –Ø—á–µ–π–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω–æ):', {
                            clickY: y,
                            calculatedTop: top
                        });
                    }
                    
                    console.log('üìç –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –º–µ–Ω—é (–æ—Ç —Ç–æ—á–∫–∏ –∫–ª–∏–∫–∞):', { 
                        clickY: y, 
                        calculatedTop: top, 
                        menuHeight: menuRect.height,
                        viewportHeight 
                    });
                    
                    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é, —á—Ç–æ–±—ã –º–µ–Ω—é –≤—Å–µ–≥–¥–∞ –±—ã–ª–æ –≤–∏–¥–Ω–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö viewport
                    if (top < 15) {
                        // –ú–µ–Ω—é –Ω–µ –≤–ª–µ–∑–∞–µ—Ç —Å–≤–µ—Ä—Ö—É - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–µ—Ä—Ö—É —ç–∫—Ä–∞–Ω–∞
                        top = 15;
                        console.log('üìç –ú–µ–Ω—é –Ω–µ –≤–ª–µ–∑–∞–µ—Ç —Å–≤–µ—Ä—Ö—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–µ—Ä—Ö—É —ç–∫—Ä–∞–Ω–∞:', { top });
                    } else if (top + menuRect.height > viewportHeight - 15) {
                        // –ú–µ–Ω—é –Ω–µ –≤–ª–µ–∑–∞–µ—Ç —Å–Ω–∏–∑—É - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞, –Ω–æ —Å—Ç–∞—Ä–∞–µ–º—Å—è –±—ã—Ç—å –∫–∞–∫ –º–æ–∂–Ω–æ –±–ª–∏–∂–µ –∫ —è—á–µ–π–∫–µ
                        if (cellRect) {
                            top = Math.min(viewportHeight - menuRect.height - 15, cellRect.bottom + offset);
                        } else {
                            top = Math.min(viewportHeight - menuRect.height - 15, y - menuRect.height - offset);
                        }
                        // –ï—Å–ª–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–ª–∏–∑–∫–æ –∫ –Ω–∏–∂–Ω–µ–º—É –∫—Ä–∞—é
                        if (top < 15) {
                            top = viewportHeight - menuRect.height - 15;
                        }
                        console.log('üìç –ú–µ–Ω—é –Ω–µ –≤–ª–µ–∑–∞–µ—Ç —Å–Ω–∏–∑—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞:', { top, viewportHeight });
                    } else {
                        // –ú–µ–Ω—é –≤–ª–µ–∑–∞–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä—è–¥–æ–º —Å —è—á–µ–π–∫–æ–π
                        console.log('üìç –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Ä—è–¥–æ–º —Å —è—á–µ–π–∫–æ–π:', { top, menuHeight: menuRect.height });
                    }
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –µ—Å–ª–∏ —è—á–µ–π–∫–∞ –µ—Å—Ç—å, —Å—Ç–∞—Ä–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é —Ä—è–¥–æ–º —Å –Ω–µ–π
                    if (cellRect) {
                        const spaceBelow = viewportHeight - cellRect.bottom - 15;
                        const spaceAbove = cellRect.top - 15;
                        const cellCenter = cellRect.top + (cellRect.height / 2);
                        const distanceFromCell = Math.abs(top - (cellCenter - menuRect.height / 2));
                        
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ —Å–Ω–∏–∑—É –æ—Ç —è—á–µ–π–∫–∏ –ò —ç—Ç–æ –±–ª–∏–∂–µ –∫ —Ü–µ–Ω—Ç—Ä—É —è—á–µ–π–∫–∏
                        if (spaceBelow >= menuRect.height + offset) {
                            const preferredTop = cellRect.bottom + offset;
                            const newDistanceFromCell = Math.abs(preferredTop - (cellCenter - menuRect.height / 2));
                            if (preferredTop + menuRect.height <= viewportHeight - 15 && newDistanceFromCell < distanceFromCell) {
                                top = preferredTop;
                                console.log('üìç –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Å–Ω–∏–∑—É –æ—Ç —è—á–µ–π–∫–∏:', { top, cellRectBottom: cellRect.bottom });
                            }
                        }
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ —Å–≤–µ—Ä—Ö—É –æ—Ç —è—á–µ–π–∫–∏ –ò —ç—Ç–æ –±–ª–∏–∂–µ –∫ —Ü–µ–Ω—Ç—Ä—É —è—á–µ–π–∫–∏
                        else if (spaceAbove >= menuRect.height + offset) {
                            const preferredTop = cellRect.top - menuRect.height - offset;
                            const newDistanceFromCell = Math.abs(preferredTop - (cellCenter - menuRect.height / 2));
                            if (preferredTop >= 15 && newDistanceFromCell < distanceFromCell) {
                                top = preferredTop;
                                console.log('üìç –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Å–≤–µ—Ä—Ö—É –æ—Ç —è—á–µ–π–∫–∏:', { top, cellRectTop: cellRect.top });
                            }
                        }
                    }
                    
                    console.log('üìç –ü–æ–∑–∏—Ü–∏—è –º–µ–Ω—é –¥–æ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏:', { left, top, referenceX, referenceY });
                    
                    // –ï—Å–ª–∏ –º–µ–Ω—é –Ω–µ –≤–ª–µ–∑–∞–µ—Ç —Å–ø—Ä–∞–≤–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–≤–∞
                    if (left + menuRect.width > viewportWidth - 15) {
                        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–≤–∞ –æ—Ç —è—á–µ–π–∫–∏
                        if (cellRect) {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É —è—á–µ–π–∫–∏
                            left = cellRect.left - menuRect.width - offset;
                            console.log('üìç –ú–µ–Ω—é –Ω–µ –≤–ª–µ–∑–∞–µ—Ç —Å–ø—Ä–∞–≤–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–≤–∞:', { left, cellRectLeft: cellRect.left });
                        } else {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–º–µ—Ä–Ω—É—é —à–∏—Ä–∏–Ω—É —è—á–µ–π–∫–∏ (–æ–±—ã—á–Ω–æ 30-60px –≤ —Ä–µ–∂–∏–º–µ –¥–Ω–µ–π)
                            const estimatedCellWidth = 50;
                            left = referenceX - estimatedCellWidth - menuRect.width - offset;
                        }
                    }
                    
                    // –ï—Å–ª–∏ —Å–ª–µ–≤–∞ —Ç–æ–∂–µ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç –∏–ª–∏ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ª–µ–≤—ã–π –∫—Ä–∞–π, –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–ª–∏–∑–∫–æ –∫ —è—á–µ–π–∫–µ
                    if (left < 15) {
                        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ–º–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π
                        if (cellRect) {
                            left = cellRect.right + offset;
                            // –ï—Å–ª–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–ª–∏–∑–∫–æ –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é
                            if (left + menuRect.width > viewportWidth - 15) {
                                left = viewportWidth - menuRect.width - 15;
                            }
                        } else {
                            left = 15;
                        }
                    }
                    
                    // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)
                    if (top < 15) {
                        top = 15;
                    } else if (top + menuRect.height > viewportHeight - 15) {
                        top = viewportHeight - menuRect.height - 15;
                    }
                    
                    console.log('‚úÖ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –º–µ–Ω—é:', { 
                        left, 
                        top, 
                        referenceX, 
                        referenceY,
                        viewportHeight,
                        viewportWidth,
                        menuWidth: menuRect.width,
                        menuHeight: menuRect.height,
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–∑–∏—Ü–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö viewport
                        isLeftInViewport: left >= 0 && left <= viewportWidth,
                        isTopInViewport: top >= 0 && top <= viewportHeight,
                        scrollY: window.scrollY || window.pageYOffset
                    });
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –û–î–ò–ù –†–ê–ó - —Ä—è–¥–æ–º —Å —è—á–µ–π–∫–æ–π
                    // –í–ê–ñ–ù–û: –ü—Ä–∏ position: fixed –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport
                    // getBoundingClientRect() —É–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º !important –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ —Å—Ç–∏–ª–∏ –Ω–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
                    
                    // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º–µ–Ω—é –≤ body –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –ø–æ–∑–∏—Ü–∏–∏
                    if (menu.parentElement !== document.body) {
                        console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ú–µ–Ω—é –Ω–µ –≤ body –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –ø–æ–∑–∏—Ü–∏–∏!');
                        document.body.appendChild(menu);
                    }
                    
                    // –†–ê–î–ò–ö–ê–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í—Ä–µ–º–µ–Ω–Ω–æ —É–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –≤–ª–∏—è–Ω–∏–µ CSS
                    const originalClass = menu.className;
                    menu.className = ''; // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å –≤—Ä–µ–º–µ–Ω–Ω–æ
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å !important
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º setProperty –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
                    menu.style.setProperty('position', 'fixed', 'important');
                    menu.style.setProperty('margin', '0', 'important');
                    menu.style.setProperty('padding', '8px 0', 'important'); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º padding –∏–∑ CSS
                    menu.style.setProperty('transform', 'none', 'important');
                    menu.style.setProperty('left', `${left}px`, 'important');
                    menu.style.setProperty('top', `${top}px`, 'important');
                    menu.style.setProperty('display', 'block', 'important');
                    menu.style.setProperty('visibility', 'visible', 'important');
                    menu.style.setProperty('opacity', '1', 'important');
                    menu.style.setProperty('z-index', '99999', 'important');
                    menu.style.setProperty('background', 'var(--color-surface)', 'important');
                    menu.style.setProperty('border-radius', '6px', 'important');
                    menu.style.setProperty('box-shadow', 'var(--shadow-md)', 'important');
                    menu.style.setProperty('min-width', '180px', 'important');
                    menu.style.setProperty('border', '1px solid var(--color-border)', 'important');
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∏–ª–µ–π
                    menu.className = originalClass;
                    
                    // –°–ò–ù–•–†–û–ù–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–±–µ–∑ requestAnimationFrame)
                    // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                    const syncRect = menu.getBoundingClientRect();
                    const syncStyle = window.getComputedStyle(menu);
                    const syncDifference = Math.abs(syncRect.top - top);
                    
                    console.log('üîç –°–ò–ù–•–†–û–ù–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ–∑–∏—Ü–∏–∏:', {
                        expectedTop: top,
                        actualTop: syncRect.top,
                        difference: syncDifference,
                        position: syncStyle.position,
                        isInBody: menu.parentElement === document.body,
                        scrollY: window.scrollY || window.pageYOffset,
                        styleTop: menu.style.top,
                        computedTop: syncStyle.top
                    });
                    
                    // –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –°–†–ê–ó–£, —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                    if (syncDifference > 5) {
                        console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ü–æ–∑–∏—Ü–∏—è –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –°–†–ê–ó–£ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏!', {
                            expectedTop: top,
                            actualTop: syncRect.top,
                            difference: syncDifference,
                            scrollY: window.scrollY || window.pageYOffset
                        });
                        
                        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ body –µ—â–µ —Ä–∞–∑
                        if (menu.parentElement !== document.body) {
                            document.body.appendChild(menu);
                        }
                        
                        // –†–ê–î–ò–ö–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï: –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å–æ scrollY, –∑–Ω–∞—á–∏—Ç position: fixed –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º position: absolute —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport + scrollY
                        const scrollY = window.scrollY || window.pageYOffset;
                        const scrollX = window.scrollX || window.pageXOffset;
                        
                        if (Math.abs(syncDifference - scrollY) < 10) {
                            console.warn('‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞: position: fixed –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ò—Å–ø–æ–ª—å–∑—É–µ–º position: absolute —Å –∫–æ—Ä—Ä–µ–∫—Ü–∏–µ–π scrollY');
                            
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º absolute —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                            const absoluteTop = top + scrollY;
                            const absoluteLeft = left + scrollX;
                            
                            menu.style.cssText = '';
                            menu.className = originalClass; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å
                            menu.style.setProperty('position', 'absolute', 'important');
                            menu.style.setProperty('margin', '0', 'important');
                            menu.style.setProperty('padding', '8px 0', 'important');
                            menu.style.setProperty('transform', 'none', 'important');
                            menu.style.setProperty('left', `${absoluteLeft}px`, 'important');
                            menu.style.setProperty('top', `${absoluteTop}px`, 'important');
                            menu.style.setProperty('display', 'block', 'important');
                            menu.style.setProperty('visibility', 'visible', 'important');
                            menu.style.setProperty('opacity', '1', 'important');
                            menu.style.setProperty('z-index', '99999', 'important');
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                            const absoluteRect = menu.getBoundingClientRect();
                            const absoluteDifference = Math.abs(absoluteRect.top - top);
                            console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è position: absolute:', {
                                expectedTop: top,
                                actualTop: absoluteRect.top,
                                difference: absoluteDifference,
                                fixed: absoluteDifference <= 5
                            });
                        } else {
                            // –ü—Ä–æ–±—É–µ–º –∏—Å–ø—Ä–∞–≤–∏—Ç—å fixed –µ—â–µ —Ä–∞–∑
                            menu.style.cssText = '';
                            menu.className = originalClass;
                            menu.style.setProperty('position', 'fixed', 'important');
                            menu.style.setProperty('margin', '0', 'important');
                            menu.style.setProperty('padding', '8px 0', 'important');
                            menu.style.setProperty('transform', 'none', 'important');
                            menu.style.setProperty('left', `${left}px`, 'important');
                            menu.style.setProperty('top', `${top}px`, 'important');
                            menu.style.setProperty('display', 'block', 'important');
                            menu.style.setProperty('visibility', 'visible', 'important');
                            menu.style.setProperty('opacity', '1', 'important');
                            menu.style.setProperty('z-index', '99999', 'important');
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—â–µ —Ä–∞–∑
                            const retryRect = menu.getBoundingClientRect();
                            const retryDifference = Math.abs(retryRect.top - top);
                            console.log('üîç –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:', {
                                expectedTop: top,
                                actualTop: retryRect.top,
                                difference: retryDifference,
                                fixed: retryDifference <= 5
                            });
                        }
                    }
                    
                    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∏–ª–µ–π —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è)
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            const immediateRect = menu.getBoundingClientRect();
                            const immediateStyle = window.getComputedStyle(menu);
                            const actualTop = immediateRect.top;
                            const difference = Math.abs(actualTop - top);
                            
                            console.log('üîç –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ–∑–∏—Ü–∏–∏:', {
                                expectedTop: top,
                                actualTop: actualTop,
                                difference: difference,
                                position: immediateStyle.position,
                                isInBody: menu.parentElement === document.body,
                                actualParent: menu.parentElement?.tagName,
                                scrollY: window.scrollY || window.pageYOffset,
                                styleTop: menu.style.top
                            });
                            
                            // –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 5px, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º
                            if (difference > 5) {
                                console.warn('‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏—è –º–µ–Ω—é –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ–∂–∏–¥–∞–µ–º–æ–π! –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º...', {
                                    expectedTop: top,
                                    actualTop: actualTop,
                                    difference: difference
                                });
                                
                                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º–µ–Ω—é –≤ body
                                if (menu.parentElement !== document.body) {
                                    document.body.appendChild(menu);
                                    console.log('‚úÖ –ú–µ–Ω—é –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ –≤ body –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏');
                                }
                                
                                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤–ª–∏—è—Ç—å –Ω–∞ –ø–æ–∑–∏—Ü–∏—é
                                menu.style.setProperty('margin', '0', 'important');
                                menu.style.setProperty('padding', '0', 'important');
                                menu.style.setProperty('transform', 'none', 'important');
                                menu.style.setProperty('position', 'fixed', 'important');
                                
                                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∑–∞–Ω–æ–≤–æ
                                menu.style.setProperty('left', `${left}px`, 'important');
                                menu.style.setProperty('top', `${top}px`, 'important');
                                
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—â–µ —Ä–∞–∑ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                                requestAnimationFrame(() => {
                                    const correctedRect = menu.getBoundingClientRect();
                                    const correctedDifference = Math.abs(correctedRect.top - top);
                                    console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:', {
                                        expectedTop: top,
                                        actualTop: correctedRect.top,
                                        difference: correctedDifference,
                                        fixed: correctedDifference <= 5
                                    });
                                    
                                    // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑
                                    if (correctedDifference > 5) {
                                        console.error('‚ùå –ü–æ–∑–∏—Ü–∏—è –≤—Å–µ –µ—â–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è!', {
                                            expectedTop: top,
                                            actualTop: correctedRect.top,
                                            difference: correctedDifference
                                        });
                                    }
                                });
                            }
                        });
                    });
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                    setTimeout(() => {
                        const finalRect = menu.getBoundingClientRect();
                        const computedStyle = window.getComputedStyle(menu);
                        console.log('üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–µ–Ω—é –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ–∑–∏—Ü–∏–∏:', {
                            display: computedStyle.display,
                            visibility: computedStyle.visibility,
                            opacity: computedStyle.opacity,
                            position: computedStyle.position,
                            zIndex: computedStyle.zIndex,
                            styleLeft: menu.style.left,
                            styleTop: menu.style.top,
                            actualRect: { 
                                left: finalRect.left, 
                                top: finalRect.top, 
                                width: finalRect.width, 
                                height: finalRect.height 
                            },
                            expectedLeft: left,
                            expectedTop: top,
                            differenceLeft: Math.abs(finalRect.left - parseFloat(menu.style.left)),
                            differenceTop: Math.abs(finalRect.top - parseFloat(menu.style.top)),
                            isVisible: finalRect.width > 0 && finalRect.height > 0,
                            scrollY: window.scrollY || window.pageYOffset,
                            viewportHeight: window.innerHeight,
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ–Ω—é –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ä—è–¥–æ–º —Å —è—á–µ–π–∫–æ–π
                            cellRect: cellRect ? {
                                left: cellRect.left,
                                top: cellRect.top,
                                right: cellRect.right,
                                bottom: cellRect.bottom
                            } : null,
                            distanceFromCell: cellRect ? {
                                horizontal: Math.abs(finalRect.left - cellRect.right),
                                vertical: Math.abs(finalRect.top - (cellRect.top + cellRect.height / 2))
                            } : null
                        });
                    }, 100);
                    
                    console.log('‚úÖ –ú–µ–Ω—é –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ:', { 
                        left, 
                        top, 
                        referenceX, 
                        referenceY,
                        clickX: x, 
                        clickY: y, 
                        scrollY: window.scrollY || window.pageYOffset,
                        hasTargetElement: !!targetElement
                    });
                });
            });
        }

        function closeStatusMenu() {
            const menu = document.getElementById('statusMenu');
            if (menu) {
                menu.style.display = 'none';
            }
            currentStatusTarget = null;
            statusMenuOpenedFromSelect = false;
        }

        // –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π –æ—Ç–∫—Ä—ã—Ç–æ –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–∞ –¥–Ω—è
        let currentDayStatusTarget = null;

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞ –¥–Ω—è
        function openDayStatusMenu(x, y, dateKey, targetCell) {
            currentDayStatusTarget = { dateKey, targetCell };
            
            const menu = document.getElementById('dayStatusMenu');
            if (!menu) {
                console.error('‚ùå –ú–µ–Ω—é dayStatusMenu –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ DOM!');
                return;
            }
            
            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –º–µ–Ω—é –≤ body –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (menu.parentElement !== document.body) {
                document.body.appendChild(menu);
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º
            menu.style.cssText = '';
            menu.style.margin = '0';
            menu.style.padding = '0';
            menu.style.display = 'block';
            menu.style.visibility = 'visible';
            menu.style.opacity = '1';
            menu.style.position = 'fixed';
            menu.style.zIndex = '99999';
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    const menuRect = menu.getBoundingClientRect();
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    
                    let left = x - menuRect.width / 2;
                    let top = y;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã viewport
                    if (left < 10) left = 10;
                    if (left + menuRect.width > viewportWidth - 10) {
                        left = viewportWidth - menuRect.width - 10;
                    }
                    if (top + menuRect.height > viewportHeight - 10) {
                        top = y - menuRect.height - 5;
                    }
                    if (top < 10) top = 10;
                    
                    menu.style.left = left + 'px';
                    menu.style.top = top + 'px';
                });
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–µ–Ω—é
            const menuItems = menu.querySelectorAll('.status-menu-item');
            menuItems.forEach(item => {
                item.onclick = (e) => {
                    e.stopPropagation();
                    const status = item.getAttribute('data-day-status');
                    applyDayStatus(dateKey, status);
                    closeDayStatusMenu();
                };
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–µ–Ω—é
            const closeHandler = (e) => {
                if (!menu.contains(e.target) && e.target !== targetCell) {
                    closeDayStatusMenu();
                    document.removeEventListener('click', closeHandler);
                }
            };
            setTimeout(() => {
                document.addEventListener('click', closeHandler);
            }, 100);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–∞ –¥–Ω—è
        function closeDayStatusMenu() {
            const menu = document.getElementById('dayStatusMenu');
            if (menu) {
                menu.style.display = 'none';
            }
            currentDayStatusTarget = null;
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–Ω—è (—Ä–∞–±–æ—á–∏–π/–≤—ã—Ö–æ–¥–Ω–æ–π)
        function applyDayStatus(dateKey, status) {
            if (!canEdit()) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            if (status === 'workday') {
                customCalendar[dateKey] = 'workday';
            } else if (status === 'holiday') {
                customCalendar[dateKey] = 'holiday';
            } else if (status === 'reset') {
                // –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –∏–∑ customCalendar, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É —Å—Ç–∞—Ç—É—Å—É
                delete customCalendar[dateKey];
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            saveCompanyInfoLocally();
            saveCompanyInfoToServer();
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ —Å —É—á–µ—Ç–æ–º –Ω–æ–≤–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            recalculateTasksAfterCalendarChange();
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
            renderGantt();
            renderTable();
        }

        // –ü–µ—Ä–µ—Å—á–µ—Ç –∑–∞–¥–∞—á –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        function recalculateTasksAfterCalendarChange() {
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –Ω–∞—á–∏–Ω–∞—è —Å –ø–µ—Ä–≤–æ–π
            let currentStartDate = new Date(startDate);
            
            // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
            while (!isWorkday(currentStartDate)) {
                currentStartDate.setDate(currentStartDate.getDate() + 1);
            }
            
            tasks.forEach((task, index) => {
                if (!task.days || task.days <= 0) {
                    // –ï—Å–ª–∏ —É –∑–∞–¥–∞—á–∏ –Ω–µ—Ç —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—ë
                    return;
                }
                
                // –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞—á–∏, –µ—Å–ª–∏ –æ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
let taskStartDate = (task.startDate && task.startDate instanceof Date && !isNaN(task.startDate.getTime())) 
    ? new Date(task.startDate) 
    : currentStartDate;
const newDates = getTaskDates(taskStartDate, task.days);
                
                if (newDates.length > 0) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ (Date –æ–±—ä–µ–∫—Ç)
                    task.startDate = new Date(newDates[0]);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è (Date –æ–±—ä–µ–∫—Ç)
                    task.endDate = new Date(newDates[newDates.length - 1]);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ –¥–∞—Ç –∑–∞–¥–∞—á–∏ (Date –æ–±—ä–µ–∫—Ç—ã)
                    task.dates = newDates.map(d => new Date(d));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–∏
                    currentStartDate = new Date(task.endDate);
                    currentStartDate.setDate(currentStartDate.getDate() + 1);
                    
                    // –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
                    while (!isWorkday(currentStartDate)) {
                        currentStartDate.setDate(currentStartDate.getDate() + 1);
                    }
                }
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            autoSaveGanttState();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è —è—á–µ–µ–∫
        function updateCellSelection() {
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —è—á–µ–µ–∫
            document.querySelectorAll('.gantt-bar.cell-selected').forEach(bar => {
                bar.classList.remove('cell-selected');
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —è—á–µ–π–∫–∞–º
            selectedCells.forEach(cellKey => {
                const [taskId, dateStr] = cellKey.split(':');
                // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –±–∞—Ä—ã –¥–ª—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏ –∏ –¥–∞—Ç—ã
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;

                const date = parseDateFromInput(dateStr);
                if (!date) return;

                // –ù–∞—Ö–æ–¥–∏–º —è—á–µ–π–∫—É —Å —ç—Ç–æ–π –¥–∞—Ç–æ–π –≤ —Å—Ç—Ä–æ–∫–µ –∑–∞–¥–∞—á–∏
                const row = document.querySelector(`.gantt-row[data-task-id="${taskId}"]`);
                if (!row) return;

                // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —è—á–µ–π–∫–∏ –≤ —Å—Ç—Ä–æ–∫–µ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —è—á–µ–π–∫–∞ —ç—Ç—É –¥–∞—Ç—É
                const cells = row.querySelectorAll('.gantt-cell');
                cells.forEach(cell => {
                    const cellDates = cell.getAttribute('data-dates');
                    if (cellDates) {
                        try {
                            const dates = JSON.parse(cellDates);
                            if (dates.some(d => {
                                const dDate = new Date(d);
                                return dDate.getTime() === date.getTime();
                            })) {
                                const bar = cell.querySelector('.gantt-bar');
                                if (bar) {
                                    bar.classList.add('cell-selected');
                                }
                            }
                        } catch (e) {
                            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
                        }
                    }
                });
            });
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á (Shift+–∫–ª–∏–∫)
        function openStatusMenuForSelectedTasks(x, y, taskId, dateStrs, targetElement = null) {
            // –°–æ–∑–¥–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π target –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
            const selectedTasksArray = Array.from(selectedTaskIds);
            currentStatusTarget = {
                isSelectedTasks: true,
                taskIds: selectedTasksArray
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
            lastClickCoordinates.x = x;
            lastClickCoordinates.y = y;
            
            const menu = document.getElementById('statusMenu');
            if (!menu) return;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, —á—Ç–æ –∏ –≤ openStatusMenu
            const isMobile = window.innerWidth <= 1024;
            
            if (menu.parentElement !== document.body) {
                document.body.appendChild(menu);
            }
            
            menu.style.left = '';
            menu.style.top = '';
            menu.style.right = '';
            menu.style.bottom = '';
            menu.style.transform = '';
            menu.style.margin = '0';
            
            menu.style.display = 'block';
            menu.style.position = 'fixed';
            menu.style.zIndex = '200';
            
            requestAnimationFrame(() => {
                const menuRect = menu.getBoundingClientRect();
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω targetElement, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                let referenceX = x;
                let referenceY = y;
                let cellRect = null;
                
                if (targetElement) {
                    cellRect = targetElement.getBoundingClientRect();
                    referenceX = cellRect.right; // –ü—Ä–∞–≤—ã–π –∫—Ä–∞–π —è—á–µ–π–∫–∏
                    referenceY = cellRect.top + cellRect.height / 2; // –¶–µ–Ω—Ç—Ä —è—á–µ–π–∫–∏ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
                    console.log('üìç –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏ (–≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏):', { 
                        cellRect: { left: cellRect.left, top: cellRect.top, right: cellRect.right, bottom: cellRect.bottom, width: cellRect.width, height: cellRect.height },
                        referenceX, 
                        referenceY 
                    });
                } else {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                    if (typeof x !== 'number' || typeof y !== 'number' || isNaN(x) || isNaN(y) || x <= 0 || y <= 0) {
                        console.error('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞!');
                        return;
                    }
                    console.log('üìç –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏):', { x, y });
                }
                
                const offset = 8; // –û—Ç—Å—Ç—É–ø –æ—Ç —è—á–µ–π–∫–∏
                
                // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é —Å–ø—Ä–∞–≤–∞ –æ—Ç —è—á–µ–π–∫–∏
                let left = referenceX + offset;
                
                // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏ –∏–∑ getBoundingClientRect() –≤–º–µ—Å—Ç–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∫–ª–∏–∫–∞
                // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–∂–µ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                let top;
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å —è—á–µ–π–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–æ–Ω–∏ —É–∂–µ –≤ viewport)
                if (cellRect) {
                    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é —Ç–∞–∫, —á—Ç–æ–±—ã –µ–≥–æ —Ü–µ–Ω—Ç—Ä –±—ã–ª —Ä—è–¥–æ–º —Å —Ü–µ–Ω—Ç—Ä–æ–º —è—á–µ–π–∫–∏
                    top = cellRect.top + (cellRect.height / 2) - (menuRect.height / 2);
                    console.log('üìç –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏ –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏):', {
                        cellTop: cellRect.top,
                        cellHeight: cellRect.height,
                        cellCenter: cellRect.top + (cellRect.height / 2),
                        calculatedTop: top,
                        menuHeight: menuRect.height
                    });
                } else {
                    // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞, –Ω–æ —ç—Ç–æ –º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–Ω–æ
                    top = y - (menuRect.height / 2);
                    console.warn('‚ö†Ô∏è –Ø—á–µ–π–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω–æ):', {
                        clickY: y,
                        calculatedTop: top
                    });
                }
                
                // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é, —á—Ç–æ–±—ã –º–µ–Ω—é –≤—Å–µ–≥–¥–∞ –±—ã–ª–æ –≤–∏–¥–Ω–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö viewport
                if (top < 15) {
                    top = 15;
                } else if (top + menuRect.height > viewportHeight - 15) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å —è—á–µ–π–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
                    if (cellRect) {
                        top = Math.min(viewportHeight - menuRect.height - 15, cellRect.bottom + offset);
                    } else {
                        top = Math.min(viewportHeight - menuRect.height - 15, y - menuRect.height - offset);
                    }
                    if (top < 15) {
                        top = viewportHeight - menuRect.height - 15;
                    }
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –µ—Å–ª–∏ —è—á–µ–π–∫–∞ –µ—Å—Ç—å, —Å—Ç–∞—Ä–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é —Ä—è–¥–æ–º —Å –Ω–µ–π
                if (cellRect) {
                    const spaceBelow = viewportHeight - cellRect.bottom - 15;
                    const spaceAbove = cellRect.top - 15;
                    const cellCenter = cellRect.top + (cellRect.height / 2);
                    const distanceFromCell = Math.abs(top - (cellCenter - menuRect.height / 2));
                    
                    if (spaceBelow >= menuRect.height + offset) {
                        const preferredTop = cellRect.bottom + offset;
                        const newDistanceFromCell = Math.abs(preferredTop - (cellCenter - menuRect.height / 2));
                        if (preferredTop + menuRect.height <= viewportHeight - 15 && newDistanceFromCell < distanceFromCell) {
                            top = preferredTop;
                        }
                    } else if (spaceAbove >= menuRect.height + offset) {
                        const preferredTop = cellRect.top - menuRect.height - offset;
                        const newDistanceFromCell = Math.abs(preferredTop - (cellCenter - menuRect.height / 2));
                        if (preferredTop >= 15 && newDistanceFromCell < distanceFromCell) {
                            top = preferredTop;
                        }
                    }
                }
                
                // –ï—Å–ª–∏ –º–µ–Ω—é –Ω–µ –≤–ª–µ–∑–∞–µ—Ç —Å–ø—Ä–∞–≤–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–≤–∞
                if (left + menuRect.width > viewportWidth - 15) {
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–≤–∞ –æ—Ç —è—á–µ–π–∫–∏
                    if (cellRect) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É —è—á–µ–π–∫–∏
                        left = cellRect.left - menuRect.width - offset;
                    } else {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–º–µ—Ä–Ω—É—é —à–∏—Ä–∏–Ω—É —è—á–µ–π–∫–∏
                        const estimatedCellWidth = 50;
                        left = referenceX - estimatedCellWidth - menuRect.width - offset;
                    }
                }
                
                // –ï—Å–ª–∏ —Å–ª–µ–≤–∞ —Ç–æ–∂–µ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç –∏–ª–∏ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ª–µ–≤—ã–π –∫—Ä–∞–π, –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–ª–∏–∑–∫–æ –∫ —è—á–µ–π–∫–µ
                if (left < 15) {
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ–º–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π
                    if (cellRect) {
                        left = cellRect.right + offset;
                        // –ï—Å–ª–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–ª–∏–∑–∫–æ –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é
                        if (left + menuRect.width > viewportWidth - 15) {
                            left = viewportWidth - menuRect.width - 15;
                        }
                    } else {
                        left = 15;
                    }
                }
                
                // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è
                if (top < 15) {
                    top = 15;
                } else if (top + menuRect.height > viewportHeight - 15) {
                    top = viewportHeight - menuRect.height - 15;
                }
                
                console.log('‚úÖ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –º–µ–Ω—é (–≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏):', { left, top, referenceX, referenceY });
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Å !important –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏
                menu.style.setProperty('left', `${left}px`, 'important');
                menu.style.setProperty('top', `${top}px`, 'important');
                menu.style.setProperty('margin', '0', 'important');
                menu.style.setProperty('transform', 'none', 'important');
                menu.style.setProperty('display', 'block', 'important');
                menu.style.setProperty('visibility', 'visible', 'important');
                menu.style.setProperty('opacity', '1', 'important');
                menu.style.setProperty('position', 'fixed', 'important');
                menu.style.setProperty('z-index', '99999', 'important');
                
                // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∏–ª–µ–π —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        const immediateRect = menu.getBoundingClientRect();
                        const immediateStyle = window.getComputedStyle(menu);
                        const actualTop = immediateRect.top;
                        const difference = Math.abs(actualTop - top);
                        
                        console.log('üîç –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ–∑–∏—Ü–∏–∏ (–≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏):', {
                            expectedTop: top,
                            actualTop: actualTop,
                            difference: difference,
                            position: immediateStyle.position,
                            isInBody: menu.parentElement === document.body,
                            scrollY: window.scrollY || window.pageYOffset
                        });
                        
                        // –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 5px, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º
                        if (difference > 5) {
                            console.warn('‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏—è –º–µ–Ω—é –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ–∂–∏–¥–∞–µ–º–æ–π! –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º...', {
                                expectedTop: top,
                                actualTop: actualTop,
                                difference: difference
                            });
                            
                            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º–µ–Ω—é –≤ body
                            if (menu.parentElement !== document.body) {
                                document.body.appendChild(menu);
                            }
                            
                            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤–ª–∏—è—Ç—å –Ω–∞ –ø–æ–∑–∏—Ü–∏—é
                            menu.style.setProperty('margin', '0', 'important');
                            menu.style.setProperty('padding', '0', 'important');
                            menu.style.setProperty('transform', 'none', 'important');
                            menu.style.setProperty('position', 'fixed', 'important');
                            
                            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∑–∞–Ω–æ–≤–æ
                            menu.style.setProperty('left', `${left}px`, 'important');
                            menu.style.setProperty('top', `${top}px`, 'important');
                        }
                    });
                });
            });
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
        function openStatusMenuForMultipleSelection(x, y, targetElement = null) {
            // –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π target –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —è—á–µ–π–∫–∏
            const allSelectedCells = Array.from(selectedCells).map(cellKey => {
                const [taskId, dateStr] = cellKey.split(':');
                return { taskId, dateStr };
            });

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∑–∞–¥–∞—á–∞–º
            const groupedByTask = {};
            allSelectedCells.forEach(({ taskId, dateStr }) => {
                if (!groupedByTask[taskId]) {
                    groupedByTask[taskId] = [];
                }
                groupedByTask[taskId].push(dateStr);
            });

            // –°–æ–∑–¥–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π target –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
            currentStatusTarget = {
                isMultiple: true,
                cells: allSelectedCells,
                groupedByTask: groupedByTask
            };

            lastClickCoordinates.x = x;
            lastClickCoordinates.y = y;

            const menu = document.getElementById('statusMenu');
            if (!menu) return;

            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º–µ–Ω—é –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ body (–Ω–µ –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å transform)
            if (menu.parentElement !== document.body) {
                document.body.appendChild(menu);
            }

            // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –∏ –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä—è–¥–æ–º —Å —è—á–µ–π–∫–æ–π
            const isMobile = window.innerWidth <= 1024;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–æ–≤—ã—Ö
            menu.style.left = '';
            menu.style.top = '';
            menu.style.right = '';
            menu.style.bottom = '';
            menu.style.transform = '';
            menu.style.margin = '0';
            
            menu.style.display = 'block';
            menu.style.position = 'fixed';
            menu.style.zIndex = '200';

            requestAnimationFrame(() => {
                const menuRect = menu.getBoundingClientRect();
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω targetElement, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                let referenceX = x;
                let referenceY = y;
                let cellRect = null;
                
                if (targetElement) {
                    cellRect = targetElement.getBoundingClientRect();
                    referenceX = cellRect.right; // –ü—Ä–∞–≤—ã–π –∫—Ä–∞–π —è—á–µ–π–∫–∏
                    referenceY = cellRect.top + cellRect.height / 2; // –¶–µ–Ω—Ç—Ä —è—á–µ–π–∫–∏ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
                    console.log('üìç –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):', { 
                        cellRect: { left: cellRect.left, top: cellRect.top, right: cellRect.right, bottom: cellRect.bottom, width: cellRect.width, height: cellRect.height },
                        referenceX, 
                        referenceY 
                    });
                } else {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                    if (typeof x !== 'number' || typeof y !== 'number' || isNaN(x) || isNaN(y) || x <= 0 || y <= 0) {
                        console.error('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞!');
                        return;
                    }
                    console.log('üìç –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):', { x, y });
                }
                
                const offset = 8; // –û—Ç—Å—Ç—É–ø –æ—Ç —è—á–µ–π–∫–∏
                
                // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é —Å–ø—Ä–∞–≤–∞ –æ—Ç —è—á–µ–π–∫–∏
                let left = referenceX + offset;
                
                // –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–∞ –∂–µ, —á—Ç–æ –∏ –≤ openStatusMenu)
                let top;
                
                if (cellRect) {
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é —Å–Ω–∏–∑—É –æ—Ç —è—á–µ–π–∫–∏
                    const spaceBelow = viewportHeight - cellRect.bottom - 15; // –î–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ —Å–Ω–∏–∑—É
                    const spaceAbove = cellRect.top - 15; // –î–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ —Å–≤–µ—Ä—Ö—É
                    
                    if (spaceBelow >= menuRect.height + offset) {
                        // –ï—Å—Ç—å –º–µ—Å—Ç–æ —Å–Ω–∏–∑—É - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥ —è—á–µ–π–∫–æ–π
                        top = cellRect.bottom + offset;
                    } else if (spaceAbove >= menuRect.height + offset) {
                        // –ù–µ—Ç –º–µ—Å—Ç–∞ —Å–Ω–∏–∑—É, –Ω–æ –µ—Å—Ç—å —Å–≤–µ—Ä—Ö—É - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–¥ —è—á–µ–π–∫–æ–π
                        top = cellRect.top - menuRect.height - offset;
                    } else {
                        // –ù–µ—Ç –º–µ—Å—Ç–∞ –Ω–∏ —Å–Ω–∏–∑—É, –Ω–∏ —Å–≤–µ—Ä—Ö—É - –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–ª–∏–∑–∫–æ –∫ —è—á–µ–π–∫–µ
                        if (spaceBelow > spaceAbove) {
                            // –ë–æ–ª—å—à–µ –º–µ—Å—Ç–∞ —Å–Ω–∏–∑—É - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–Ω–∏–∑—É, –æ–±—Ä–µ–∑–∞—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                            top = cellRect.bottom + offset;
                            if (top + menuRect.height > viewportHeight - 15) {
                                top = viewportHeight - menuRect.height - 15;
                            }
                        } else {
                            // –ë–æ–ª—å—à–µ –º–µ—Å—Ç–∞ —Å–≤–µ—Ä—Ö—É - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–µ—Ä—Ö—É, –æ–±—Ä–µ–∑–∞—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                            top = cellRect.top - menuRect.height - offset;
                            if (top < 15) {
                                top = 15;
                            }
                        }
                    }
                } else {
                    // Fallback: –µ—Å–ª–∏ –Ω–µ—Ç cellRect, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
                    top = referenceY - (menuRect.height / 2);
                    if (top < 15) {
                        top = 15;
                    } else if (top + menuRect.height > viewportHeight - 15) {
                        top = viewportHeight - menuRect.height - 15;
                    }
                }
                
                // –ï—Å–ª–∏ –º–µ–Ω—é –Ω–µ –≤–ª–µ–∑–∞–µ—Ç —Å–ø—Ä–∞–≤–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–≤–∞
                if (left + menuRect.width > viewportWidth - 15) {
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–≤–∞ –æ—Ç —è—á–µ–π–∫–∏
                    if (cellRect) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É —è—á–µ–π–∫–∏
                        left = cellRect.left - menuRect.width - offset;
                    } else {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–º–µ—Ä–Ω—É—é —à–∏—Ä–∏–Ω—É —è—á–µ–π–∫–∏
                        const estimatedCellWidth = 50;
                        left = referenceX - estimatedCellWidth - menuRect.width - offset;
                    }
                }
                
                // –ï—Å–ª–∏ —Å–ª–µ–≤–∞ —Ç–æ–∂–µ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç –∏–ª–∏ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ª–µ–≤—ã–π –∫—Ä–∞–π, –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–ª–∏–∑–∫–æ –∫ —è—á–µ–π–∫–µ
                if (left < 15) {
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ–º–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π
                    if (cellRect) {
                        left = cellRect.right + offset;
                        // –ï—Å–ª–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–ª–∏–∑–∫–æ –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é
                        if (left + menuRect.width > viewportWidth - 15) {
                            left = viewportWidth - menuRect.width - 15;
                        }
                    } else {
                        left = 15;
                    }
                }
                
                // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è
                if (top < 15) {
                    top = 15;
                } else if (top + menuRect.height > viewportHeight - 15) {
                    top = viewportHeight - menuRect.height - 15;
                }

                menu.style.left = `${left}px`;
                menu.style.top = `${top}px`;
                
                // –î–≤–æ–π–Ω–æ–π requestAnimationFrame –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ —Å—Ç–∏–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        const actualRect = menu.getBoundingClientRect();
                        const scrollX = window.scrollX || window.pageXOffset;
                        const scrollY = window.scrollY || window.pageYOffset;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–¥–≤–∏–Ω—É–ª–æ—Å—å –ª–∏ –º–µ–Ω—é
                        const topDiff = Math.abs(actualRect.top - top);
                        const leftDiff = Math.abs(actualRect.left - left);
                        
                        console.log('‚úÖ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –º–µ–Ω—é (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):', { 
                            left, 
                            top, 
                            menuWidth: menuRect.width, 
                            menuHeight: menuRect.height,
                            actualLeft: actualRect.left,
                            actualTop: actualRect.top,
                            scrollX,
                            scrollY,
                            topDiff,
                            leftDiff,
                            computedLeft: window.getComputedStyle(menu).left,
                            computedTop: window.getComputedStyle(menu).top,
                            computedPosition: window.getComputedStyle(menu).position,
                            parentElement: menu.parentElement ? menu.parentElement.tagName : 'none',
                            parentTransform: menu.parentElement ? window.getComputedStyle(menu.parentElement).transform : 'none'
                        });
                        
                        // –ï—Å–ª–∏ –º–µ–Ω—é —Å–¥–≤–∏–Ω—É–ª–æ—Å—å, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é
                        if (topDiff > 5 || leftDiff > 5) {
                            console.warn('‚ö†Ô∏è –ú–µ–Ω—é —Å–¥–≤–∏–Ω—É–ª–æ—Å—å (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä)! –û–∂–∏–¥–∞–ª–æ—Å—å:', { left, top }, '–ü–æ–ª—É—á–∏–ª–æ—Å—å:', { 
                                left: actualRect.left, 
                                top: actualRect.top 
                            });
                            
                            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é —Å —É—á–µ—Ç–æ–º —Å–º–µ—â–µ–Ω–∏—è
                            // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë –∫ –Ω—É–∂–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
                            const topOffset = top - actualRect.top;
                            const leftOffset = left - actualRect.left;
                            const correctedTop = top + topOffset;
                            const correctedLeft = left + leftOffset;
                            
                            console.log('üîß –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):', { 
                                correctedLeft, 
                                correctedTop,
                                topOffset,
                                leftOffset,
                                originalTop: top,
                                actualTop: actualRect.top
                            });
                            menu.style.left = `${correctedLeft}px`;
                            menu.style.top = `${correctedTop}px`;
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—â–µ —Ä–∞–∑ –ø–æ—Å–ª–µ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
                            requestAnimationFrame(() => {
                                const finalRect = menu.getBoundingClientRect();
                                const finalTopDiff = Math.abs(finalRect.top - top);
                                const finalLeftDiff = Math.abs(finalRect.left - left);
                                
                                if (finalTopDiff > 5 || finalLeftDiff > 5) {
                                    console.error('‚ùå –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–µ –ø–æ–º–æ–≥–ª–∞ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä)! –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è:', {
                                        expected: { left, top },
                                        actual: { left: finalRect.left, top: finalRect.top }
                                    });
                                    
                                    // –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞–ø—Ä—è–º—É—é —Å —É—á–µ—Ç–æ–º –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                                    const scrollY = window.scrollY || window.pageYOffset;
                                    const scrollX = window.scrollX || window.pageXOffset;
                                    
                                    // –ü—Ä–æ–±—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport –±–µ–∑ —É—á–µ—Ç–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                                    menu.style.position = 'fixed';
                                    menu.style.left = `${left}px`;
                                    menu.style.top = `${top}px`;
                                    menu.style.margin = '0';
                                    menu.style.transform = 'none';
                                    
                                    console.log('üîÑ –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):', { left, top, scrollX, scrollY });
                                } else {
                                    console.log('‚úÖ –ö–æ—Ä—Ä–µ–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–∞ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä)!');
                                }
                            });
                        }
                    });
                });
            });
        }

        function applyStatusToSelection(status, commentText, targetOverride) {
            const target = targetOverride || currentStatusTarget;
            
            console.log('üîß applyStatusToSelection –≤—ã–∑–≤–∞–Ω–∞:', { 
                status, 
                hasTarget: !!target, 
                target: target,
                currentStatusTarget: currentStatusTarget,
                selectedTaskIds: Array.from(selectedTaskIds)
            });
            
            // –£–ë–†–ê–ù–û: –ú–∞—Å—Å–æ–≤–æ–µ –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–º –∑–∞–¥–∞—á–∞–º
            // –¢–µ–ø–µ—Ä—å —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –∫–ª–∏–∫–Ω—É–ª–∏
            // –ú–∞—Å—Å–æ–≤–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ Shift –æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ, –≤—Å—Ç–∞–≤–∫–∞ –∏ —Ç.–¥.)
            
            if (!target) {
                console.error('‚ùå –ù–µ—Ç target –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞!');
                return;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞
            addToUndoHistory();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –≤—ã–±–æ—Ä–æ–º
            if (target.isMultiple && target.cells) {
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä
                applyStatusToMultipleCells(status, commentText, target);
                return;
            }

            const { taskId, dateStrs } = target;
            console.log('üéØ –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –∫ –∑–∞–¥–∞—á–µ:', { taskId, dateStrs, status });
            
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            const task = tasks[taskIndex];
            if (!task) {
                console.error('‚ùå –ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!', { taskId, taskIndex, tasksLength: tasks.length });
                return;
            }
            
            console.log('‚úÖ –ó–∞–¥–∞—á–∞ –Ω–∞–π–¥–µ–Ω–∞:', { taskId, taskIndex, taskName: task.task || task.name });

            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É –∑–∞–¥–∞—á–∏ –µ—Å—Ç—å –æ–±—ä–µ–∫—Ç—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ –¥–∞—Ç–∞–º
            if (!task.dateStatuses) {
                task.dateStatuses = {};
            }
            if (!task.dateComments) {
                task.dateComments = {};
            }

            // –ü–∞—Ä—Å–∏–º –≤—Å–µ –¥–∞—Ç—ã –∏–∑ –º–∞—Å—Å–∏–≤–∞
            const targetDates = dateStrs.map(ds => {
                const parsed = parseDateFromInput(ds);
                return parsed;
            }).filter(d => d !== null);

            if (targetDates.length === 0) return;

            // –î–ª—è "–∑–∞–≤–µ—Ä—à–µ–Ω–æ" –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–∞—Ç—É –∏–∑ –º–∞—Å—Å–∏–≤–∞ (—Å–∞–º—É—é –ø–æ–∑–¥–Ω—é—é)
            const targetDate = status === 'completed' ? targetDates[targetDates.length - 1] : targetDates[0];

            if (status === 'completed') {
                // –ù–µ –¥–≤–∏–≥–∞–µ–º —Å—Ä–æ–∫–∏ –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á ‚Äî —Ç–æ–ª—å–∫–æ –æ—Ç–º–µ—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π
                const targetTime = targetDate.getTime();
                task.status = 'completed';
                task.dateStatuses = task.dateStatuses || {};

                // –ö—Ä–∞—Å–∏–º –≤—Å–µ –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ø–∞–¥–∞—é—Ç –¥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)
                (task.dates || []).forEach(d => {
                    const dateObj = d instanceof Date ? d : new Date(d);
                    if (!isNaN(dateObj.getTime()) && dateObj.getTime() <= targetTime) {
                        const ds = formatDateKey(dateObj);
                        task.dateStatuses[ds] = 'completed';
                    }
                });

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                if (commentText && commentText.trim().length > 0) {
                    const completionKey = formatDateKey(targetDate);
                    task.dateComments[completionKey] = commentText.trim();
                }
            } else if (status === 'in-progress') {
                // –í–ê–ñ–ù–û: –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å —Ç–æ–ª—å–∫–æ –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∞—Ç–∞–º (–Ω–µ –∫–æ –≤—Å–µ–π –∑–∞–¥–∞—á–µ)
                // –ö–∞–∂–¥–∞—è —è—á–µ–π–∫–∞ (–¥–µ–Ω—å) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
                // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫—Ä–∞—Å–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —è—á–µ–π–∫–µ, –∞ –Ω–µ –≤—Å–µ–π —Å—Ç—Ä–æ–∫–µ
                console.log('üü† –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å "–í —Ä–∞–±–æ—Ç–µ" –∫ –¥–∞—Ç–∞–º:', targetDates.map(d => formatDateKey(d)));
                console.log('üü† –í—Å–µ –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏:', task.dates.map(d => formatDateKey(d)));
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –¢–û–õ–¨–ö–û –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∞—Ç–∞–º
                targetDates.forEach(d => {
                    const key = formatDateKey(d);
                    task.dateStatuses[key] = 'in-progress';
                    console.log('   ‚úÖ –°—Ç–∞—Ç—É—Å –ø—Ä–∏–º–µ–Ω–µ–Ω –∫ –¥–∞—Ç–µ:', key);
                    if (commentText && commentText.trim().length > 0) {
                        task.dateComments[key] = commentText.trim();
                    }
                });
                
                // –í–ê–ñ–ù–û: –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏, –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–º–µ–Ω–µ–Ω —Ç–æ–ª—å–∫–æ –∫ –æ–¥–Ω–æ–π –¥–∞—Ç–µ
                // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫—Ä–∞—Å–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —è—á–µ–π–∫–µ, –∞ –Ω–µ –≤—Å–µ–π —Å—Ç—Ä–æ–∫–µ
                // –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –í–°–ï –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏ –∏–º–µ—é—Ç —Å—Ç–∞—Ç—É—Å "–í —Ä–∞–±–æ—Ç–µ"
                const allDatesHaveStatus = task.dates.every(d => {
                    const key = formatDateKey(d);
                    return task.dateStatuses[key] === 'in-progress';
                });
                
                console.log('üü† –í—Å–µ –¥–∞—Ç—ã –∏–º–µ—é—Ç —Å—Ç–∞—Ç—É—Å "–í —Ä–∞–±–æ—Ç–µ":', allDatesHaveStatus);
                console.log('üü† –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞—Ç:', targetDates.length);
                console.log('üü† –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∞—Ç –≤ –∑–∞–¥–∞—á–µ:', task.dates.length);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –í–°–ï –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏ –∏–º–µ—é—Ç —Å—Ç–∞—Ç—É—Å "–í —Ä–∞–±–æ—Ç–µ"
                if (allDatesHaveStatus && targetDates.length === task.dates.length) {
                    task.status = 'in-progress';
                    console.log('   ‚úÖ –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ "–í —Ä–∞–±–æ—Ç–µ"');
                } else if (task.dates.length === 1 && targetDates.length === 1) {
                    // –ï—Å–ª–∏ –≤ –∑–∞–¥–∞—á–µ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –¥–∞—Ç–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å
                    task.status = 'in-progress';
                    console.log('   ‚úÖ –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ "–í —Ä–∞–±–æ—Ç–µ" (–æ–¥–Ω–∞ –¥–∞—Ç–∞)');
                } else {
                    // –í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö –ù–ï –º–µ–Ω—è–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
                    // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫—Ä–∞—Å–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —è—á–µ–π–∫–µ, –∞ –Ω–µ –≤—Å–µ–π —Å—Ç—Ä–æ–∫–µ
                    console.log('   ‚ö†Ô∏è –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ –ù–ï –∏–∑–º–µ–Ω–µ–Ω (—Å—Ç–∞—Ç—É—Å –ø—Ä–∏–º–µ–Ω–µ–Ω —Ç–æ–ª—å–∫–æ –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∞—Ç–∞–º)');
                }
            } else if (status === 'pending') {
                // –í–æ–∑–≤—Ä–∞—Ç –∫ —Å—Ç–∞—Ç—É—Å—É "–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ"
                console.log('üîµ –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å "–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ" –∫ –¥–∞—Ç–∞–º:', targetDates.map(d => formatDateKey(d)));
                
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞—Ç (–≤ —Ä–∞–±–æ—Ç–µ, –∑–∞–≤–µ—Ä—à–µ–Ω–æ)
                targetDates.forEach(d => {
                    const key = formatDateKey(d);
                    // –£–¥–∞–ª—è–µ–º –ª—é–±–æ–π —Å—Ç–∞—Ç—É—Å –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã
                    if (task.dateStatuses && task.dateStatuses[key]) {
                        console.log('   üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –¥–∞—Ç—ã:', key, '—Å—Ç–∞—Ä—ã–π —Å—Ç–∞—Ç—É—Å:', task.dateStatuses[key]);
                        delete task.dateStatuses[key];
                    }
                    // –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã
                    if (task.dateComments && task.dateComments[key]) {
                        delete task.dateComments[key];
                    }
                });
                
                // –ï—Å–ª–∏ –≤—Å–µ –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å –∫ "–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ", –º–µ–Ω—è–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
                const hasAnyStatus = task.dates && task.dates.some(d => {
                    const key = formatDateKey(d);
                    return task.dateStatuses && task.dateStatuses[key] && 
                           (task.dateStatuses[key] === 'in-progress' || 
                            task.dateStatuses[key] === 'completed');
                });
                
                if (!hasAnyStatus) {
                    task.status = 'pending';
                }
            }

            console.log('üìä –°—Ç–∞—Ç—É—Å—ã –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:', task.dateStatuses);
            console.log('üîÑ –í—ã–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É –≥—Ä–∞—Ñ–∏–∫–∞...');
            
            closeStatusMenu();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∏ –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π
            const scrollY = window.scrollY || window.pageYOffset;
            const scrollX = window.scrollX || window.pageXOffset;
            const chartContainer = document.getElementById('ganttChart');
            const chartScrollTop = chartContainer ? chartContainer.scrollTop : 0;
            const chartScrollLeft = chartContainer ? chartContainer.scrollLeft : 0;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏ —É–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É
            const activeElement = document.activeElement;
            const activeElementInfo = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA') 
                ? { element: activeElement, selectionStart: activeElement.selectionStart, selectionEnd: activeElement.selectionEnd }
                : null;
            
            if (activeElementInfo) {
                activeElementInfo.element.blur();
            }

            updateStatistics();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            if (searchResults.length > 0) {
                highlightSearchResults();
            }
            if (currentView === 'gantt') {
                renderGantt();
            }
            renderTable();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å—Ä–∞–∑—É, –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
            window.scrollTo(scrollX, scrollY);
            const newChartContainer = document.getElementById('ganttChart');
            if (newChartContainer) {
                newChartContainer.scrollTop = chartScrollTop;
                newChartContainer.scrollLeft = chartScrollLeft;
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏)
            if (activeElementInfo && document.contains(activeElementInfo.element)) {
                requestAnimationFrame(() => {
                    try {
                        activeElementInfo.element.focus({ preventScroll: true });
                        if (activeElementInfo.element.setSelectionRange && 
                            activeElementInfo.selectionStart !== null && 
                            activeElementInfo.selectionEnd !== null) {
                            activeElementInfo.element.setSelectionRange(
                                activeElementInfo.selectionStart, 
                                activeElementInfo.selectionEnd
                            );
                        }
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–æ–∫—É—Å–∞
                    }
                });
            }
            
            // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (—Å—Ç–∞—Ç—É—Å—ã –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏)
            console.log('üíæ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: —Å—Ç–∞—Ç—É—Å/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ');
            saveFullGanttState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ä–∞–∑—É, –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ –≤—Å–µ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–º –∑–∞–¥–∞—á–∞–º (Shift+–∫–ª–∏–∫)
        function applyStatusToSelectedTasks(status, commentText) {
            if (selectedTaskIds.size === 0) return;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞
            addToUndoHistory();

            const affectedTaskIndices = new Set();

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ –≤—Å–µ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–º –∑–∞–¥–∞—á–∞–º
            selectedTaskIds.forEach(taskId => {
                const taskIndex = tasks.findIndex(t => t.id === taskId);
                const task = tasks[taskIndex];
                if (!task) return;

                affectedTaskIndices.add(taskIndex);

                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É –∑–∞–¥–∞—á–∏ –µ—Å—Ç—å –æ–±—ä–µ–∫—Ç—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                if (!task.dateStatuses) {
                    task.dateStatuses = {};
                }
                if (!task.dateComments) {
                    task.dateComments = {};
                }

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ –≤—Å–µ–º —è—á–µ–π–∫–∞–º –∑–∞–¥–∞—á–∏
                // –í–ê–ñ–ù–û: –î–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ—Å—Ç–∞—é—Ç—Å—è –ø–æ –ø–ª–∞–Ω—É (–Ω–µ –∏–∑–º–µ–Ω—è—é—Ç—Å—è)
                if (task.dates && task.dates.length > 0) {
                    task.dates.forEach(date => {
                        const key = formatDateKey(date);

                        if (status === 'completed') {
                            // –î–ª—è "–∑–∞–≤–µ—Ä—à–µ–Ω–æ" –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–æ –≤—Å–µ–º –¥–∞—Ç–∞–º –∑–∞–¥–∞—á–∏
                            task.dateStatuses[key] = 'completed';
                            if (commentText && commentText.trim().length > 0) {
                                task.dateComments[key] = commentText.trim();
                            }
                        } else if (status === 'in-progress') {
                            // –î–ª—è "–≤ —Ä–∞–±–æ—Ç–µ" –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–æ –≤—Å–µ–º –¥–∞—Ç–∞–º –∑–∞–¥–∞—á–∏
                            task.dateStatuses[key] = 'in-progress';
                            if (commentText && commentText.trim().length > 0) {
                                task.dateComments[key] = commentText.trim();
                            }
                        } else if (status === 'pending') {
                            // –í–æ–∑–≤—Ä–∞—Ç –∫ —Å—Ç–∞—Ç—É—Å—É "–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ"
                            if (task.dateStatuses[key]) {
                                delete task.dateStatuses[key];
                            }
                            if (task.dateComments[key]) {
                                delete task.dateComments[key];
                            }
                        }
                    });

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
                    // –í–ê–ñ–ù–û: –ù–µ –∏–∑–º–µ–Ω—è–µ–º –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è - –æ–Ω–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø–æ –ø–ª–∞–Ω—É
                    if (status === 'completed') {
                        task.status = 'completed';
                    } else if (status === 'in-progress') {
                        task.status = 'in-progress';
                    } else if (status === 'pending') {
                        task.status = 'pending';
                    }
                }
            });

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –∑–∞–¥–∞—á
            // –í–ê–ñ–ù–û: –î–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ—Å—Ç–∞—é—Ç—Å—è –ø–æ –ø–ª–∞–Ω—É
            // –î–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ completed, in-progress, pending –¥–∞—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –ø–æ –ø–ª–∞–Ω—É

            closeStatusMenu();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π
            const scrollY = window.scrollY || window.pageYOffset;
            const scrollX = window.scrollX || window.pageXOffset;
            const chartContainer = document.getElementById('ganttChart');
            const chartScrollTop = chartContainer ? chartContainer.scrollTop : 0;
            const chartScrollLeft = chartContainer ? chartContainer.scrollLeft : 0;

            updateStatistics();
            
            if (currentView === 'gantt') {
                renderGantt();
            }
            renderTable();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            window.scrollTo(scrollX, scrollY);
            const newChartContainer = document.getElementById('ganttChart');
            if (newChartContainer) {
                newChartContainer.scrollTop = chartScrollTop;
                newChartContainer.scrollLeft = chartScrollLeft;
            }
            
            // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            console.log('üíæ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–º–µ–Ω–µ–Ω –∫ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–º –∑–∞–¥–∞—á–∞–º, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ');
            saveFullGanttState();
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–º—É –≤—ã–±–æ—Ä—É —è—á–µ–µ–∫
        function applyStatusToMultipleCells(status, commentText, target) {
            if (!target.isMultiple || !target.cells) return;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞
            addToUndoHistory();

            // –°–æ–±–∏—Ä–∞–µ–º –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –¥–∞—Ç
            const affectedTaskIndices = new Set();

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –≤—ã–±—Ä–∞–Ω–Ω—É—é —è—á–µ–π–∫—É
            target.cells.forEach(({ taskId, dateStr }) => {
                const taskIndex = tasks.findIndex(t => t.id === taskId);
                const task = tasks[taskIndex];
                if (!task) return;

                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É –∑–∞–¥–∞—á–∏ –µ—Å—Ç—å –æ–±—ä–µ–∫—Ç—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                if (!task.dateStatuses) {
                    task.dateStatuses = {};
                }
                if (!task.dateComments) {
                    task.dateComments = {};
                }

                const date = parseDateFromInput(dateStr);
                if (!date) return;

                const key = formatDateKey(date);
                const dateTime = date.getTime();

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                if (status === 'completed') {
                    // –î–ª—è "–∑–∞–≤–µ—Ä—à–µ–Ω–æ" - –æ–±—Ä–µ–∑–∞–µ–º –∑–∞–¥–∞—á—É –¥–æ —ç—Ç–æ–π –¥–∞—Ç—ã
                    const newDates = (task.dates || []).filter(d => {
                        const dateObj = d instanceof Date ? d : new Date(d);
                        return !isNaN(dateObj.getTime()) && dateObj.getTime() <= dateTime;
                    }).map(d => d instanceof Date ? d : new Date(d));
                    if (newDates.length > 0) {
                        task.dates = newDates;
                        task.startDate = newDates[0];
                        task.endDate = newDates[newDates.length - 1];
                        task.days = newDates.length;
                    }
                    task.dateStatuses[key] = 'completed';
                    if (commentText && commentText.trim().length > 0) {
                        task.dateComments[key] = commentText.trim();
                    }
                    affectedTaskIndices.add(taskIndex);
                } else if (status === 'in-progress') {
                    task.dateStatuses[key] = 'in-progress';
                    if (commentText && commentText.trim().length > 0) {
                        task.dateComments[key] = commentText.trim();
                    }
                } else if (status === 'pending') {
                    // –í–æ–∑–≤—Ä–∞—Ç –∫ "–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ"
                    if (task.dateStatuses[key]) {
                        delete task.dateStatuses[key];
                    }
                    if (task.dateComments[key]) {
                        delete task.dateComments[key];
                    }
                }
            });

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –∑–∞–¥–∞—á
            // –î–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ completed, in-progress, pending –¥–∞—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –ø–æ –ø–ª–∞–Ω—É

            // –ù–∞—Ö–æ–¥–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –∑–∞—Ç—Ä–æ–Ω—É—Ç–æ–π –∑–∞–¥–∞—á–∏ –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö
            const minAffectedIndex = affectedTaskIndices.size > 0 
                ? Math.min(...Array.from(affectedTaskIndices))
                : -1;
            
            if (minAffectedIndex >= 0) {
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏, –Ω–∞—á–∏–Ω–∞—è —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–∞—Ç—Ä–æ–Ω—É—Ç–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
                recalculateFollowingTasks(minAffectedIndex);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–µ —Å—Ç–∞—Ç—É—Å—ã –∑–∞–¥–∞—á
            tasks.forEach(task => {
                if (!task.dateStatuses) return;
                
                const hasInProgressOrCompleted = task.dates.some(d => {
                    const key = formatDateKey(d);
                    return task.dateStatuses[key] === 'in-progress' || 
                           task.dateStatuses[key] === 'completed';
                });
                
                if (!hasInProgressOrCompleted) {
                    task.status = 'pending';
                } else {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –¥–∞—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã
                    const allCompleted = task.dates.every(d => {
                        const key = formatDateKey(d);
                        return task.dateStatuses[key] === 'completed';
                    });
                    if (allCompleted) {
                        task.status = 'completed';
                    } else {
                        task.status = 'in-progress';
                    }
                }
            });

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á
            tasks.forEach((task, index) => {
                if (task.status === 'completed') {
                    recalculateFollowingTasks(index);
                }
            });

            // –û—á–∏—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä
            selectedCells.clear();
            updateCellSelection();

            closeStatusMenu();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∏ –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π
            const scrollY = window.scrollY || window.pageYOffset;
            const scrollX = window.scrollX || window.pageXOffset;
            const chartContainer = document.getElementById('ganttChart');
            const chartScrollTop = chartContainer ? chartContainer.scrollTop : 0;
            const chartScrollLeft = chartContainer ? chartContainer.scrollLeft : 0;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏ —É–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É
            const activeElement = document.activeElement;
            const activeElementInfo = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA') 
                ? { element: activeElement, selectionStart: activeElement.selectionStart, selectionEnd: activeElement.selectionEnd }
                : null;
            
            if (activeElementInfo) {
                activeElementInfo.element.blur();
            }

            updateStatistics();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            if (searchResults.length > 0) {
                highlightSearchResults();
            }
            if (currentView === 'gantt') {
                renderGantt();
            }
            renderTable();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å—Ä–∞–∑—É, –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
            window.scrollTo(scrollX, scrollY);
            const newChartContainer = document.getElementById('ganttChart');
            if (newChartContainer) {
                newChartContainer.scrollTop = chartScrollTop;
                newChartContainer.scrollLeft = chartScrollLeft;
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏)
            if (activeElementInfo && document.contains(activeElementInfo.element)) {
                requestAnimationFrame(() => {
                    try {
                        activeElementInfo.element.focus({ preventScroll: true });
                        if (activeElementInfo.element.setSelectionRange && 
                            activeElementInfo.selectionStart !== null && 
                            activeElementInfo.selectionEnd !== null) {
                            activeElementInfo.element.setSelectionRange(
                                activeElementInfo.selectionStart, 
                                activeElementInfo.selectionEnd
                            );
                        }
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–æ–∫—É—Å–∞
                    }
                });
            }
            
            // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            console.log('üíæ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ');
            saveFullGanttState();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –ø–æ –ø—É–Ω–∫—Ç–∞–º –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–∞
        document.addEventListener('DOMContentLoaded', function() {
            const menu = document.getElementById('statusMenu');
            if (menu) {
                menu.querySelectorAll('.status-menu-item').forEach(item => {
                    item.addEventListener('click', (event) => {
                        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ, —á—Ç–æ–±—ã window.onclick –Ω–µ –∑–∞–∫—Ä—ã–ª –º–µ–Ω—é –¥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
                        event.stopPropagation();
                        event.stopImmediatePropagation();
                        
                        const status = item.getAttribute('data-status');
                        const target = currentStatusTarget;
                        
                        console.log('üìå –ö–ª–∏–∫ –Ω–∞ –ø—É–Ω–∫—Ç –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–∞:', { 
                            status, 
                            hasTarget: !!target, 
                            target: target,
                            selectedTaskIds: Array.from(selectedTaskIds)
                        });
                        
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥, —Ç–∞–∫ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —Å—Ç–∞—Ç—É—Å
                        statusMenuOpenedFromSelect = false;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Å—à—Ç–∞–± –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è - –µ—Å–ª–∏ –Ω–µ–¥–µ–ª—è –∏–ª–∏ –º–µ—Å—è—Ü, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                        if (currentScaleMode === 'week' || currentScaleMode === 'month') {
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º currentStatusTarget –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                            if (currentStatusTarget) {
                                // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é target –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                                if (currentStatusTarget.isMultiple && currentStatusTarget.cells) {
                                    pendingStatusTargetAfterScaleWarning = {
                                        isMultiple: true,
                                        cells: [...currentStatusTarget.cells],
                                        groupedByTask: currentStatusTarget.groupedByTask ? { ...currentStatusTarget.groupedByTask } : null
                                    };
                                } else {
                                    pendingStatusTargetAfterScaleWarning = {
                                        taskId: currentStatusTarget.taskId,
                                        dateStrs: Array.isArray(currentStatusTarget.dateStrs)
                                            ? [...currentStatusTarget.dateStrs]
                                            : [currentStatusTarget.dateStrs]
                                    };
                                }
                            }
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –º–∞—Å—à—Ç–∞–±–µ
                            openScaleWarning(status, currentScaleMode);
                            return; // –ù–µ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å —Å—Ä–∞–∑—É, –∂–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                        }
                        
                        // –£–ë–†–ê–ù–û: –ú–∞—Å—Å–æ–≤–æ–µ –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–º –∑–∞–¥–∞—á–∞–º
                        // –¢–µ–ø–µ—Ä—å —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –∫–ª–∏–∫–Ω—É–ª–∏
                        // –ú–∞—Å—Å–æ–≤–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ Shift –æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ, –≤—Å—Ç–∞–≤–∫–∞ –∏ —Ç.–¥.)
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –≤—ã–±–æ—Ä–æ–º
                        if (target && target.isMultiple && target.cells) {
                            // –î–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                            // –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ "–í —Ä–∞–±–æ—Ç–µ" –∏ "–ó–∞–≤–µ—Ä—à–µ–Ω–æ"
                            if (status === 'in-progress' || status === 'completed') {
                                pendingStatusForComment = status;
                                openStatusCommentModal();
                            } else {
                                // –î–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ä–∞–∑—É –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                                applyStatusToSelection(status);
                            }
                        } else {
                            // –û–±—ã—á–Ω—ã–π –≤—ã–±–æ—Ä - –∫–∞–∫ —Ä–∞–Ω—å—à–µ
                            if (status === 'in-progress' || status === 'completed') {
                                pendingStatusForComment = status;
                                openStatusCommentModal();
                            } else {
                                applyStatusToSelection(status);
                            }
                        }
                    });
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —Å–∞–º–æ –º–µ–Ω—é, —á—Ç–æ–±—ã –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –µ–≥–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω—É—Ç—Ä–∏
                menu.addEventListener('click', (event) => {
                    event.stopPropagation();
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ mousedown –Ω–∞ –º–µ–Ω—é, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –º—ã—à–∏
                menu.addEventListener('mousedown', (event) => {
                    event.stopPropagation();
                });
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω, –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–∞
        // –∏ —Å–±—Ä–æ—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π
        window.onclick = function(event) {
            const target = event.target;

            const modal = document.getElementById('editModal');
            if (target === modal) {
                modal.style.display = 'none';
            }

            const menu = document.getElementById('statusMenu');
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–∫—Ä—ã—Ç–æ –ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –º–∞—Å—à—Ç–∞–±–µ
            const scaleWarningModal = document.getElementById('scaleWarningModal');
            const isScaleWarningOpen = scaleWarningModal && scaleWarningModal.style.display !== 'none' && scaleWarningModal.classList.contains('show');
            
            if (menu && menu.style.display === 'block' && !menu.contains(target)) {
                // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –º–∞—Å—à—Ç–∞–±–µ
                if (isScaleWarningOpen) {
                    return; // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –ø–æ–∫–∞ –æ—Ç–∫—Ä—ã—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                }
                
                // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –Ω–∞ select —Å—Ç–∞—Ç—É—Å–∞ –∏–ª–∏ –µ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç
                const isStatusSelect = target.tagName === 'SELECT' && target.getAttribute('data-field') === 'status';
                const isInsideStatusSelect = target.closest('select[data-field="status"]') !== null;
                
                // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –∫–ª–∏–∫ –Ω–∞ —è—á–µ–π–∫—É —Ç–∞–±–ª–∏—Ü—ã, —Å–æ–¥–µ—Ä–∂–∞—â—É—é select —Å—Ç–∞—Ç—É—Å–∞
                const isStatusCell = target.closest('td') && target.closest('td').querySelector('select[data-field="status"]');
                
                // –ï—Å–ª–∏ –º–µ–Ω—é –±—ã–ª–æ –æ—Ç–∫—Ä—ã—Ç–æ –∏–∑ select, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –º—è–≥–∫—É—é –ª–æ–≥–∏–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
                if (statusMenuOpenedFromSelect) {
                    // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –Ω–∞ select –∏–ª–∏ –µ–≥–æ —è—á–µ–π–∫—É
                    if (!isStatusSelect && !isInsideStatusSelect && !isStatusCell) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º—ã—à–∏ - –µ—Å–ª–∏ –∫—É—Ä—Å–æ—Ä –Ω–∞–¥ –º–µ–Ω—é –∏–ª–∏ select, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º
                        const menuRect = menu.getBoundingClientRect();
                        const mouseX = event.clientX;
                        const mouseY = event.clientY;
                        const isOverMenu = mouseX >= menuRect.left && mouseX <= menuRect.right &&
                                          mouseY >= menuRect.top && mouseY <= menuRect.bottom;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫—É—Ä—Å–æ—Ä –Ω–∞–¥ select
                        const allStatusSelects = document.querySelectorAll('select[data-field="status"]');
                        let isOverSelect = false;
                        allStatusSelects.forEach(sel => {
                            const selRect = sel.getBoundingClientRect();
                            if (mouseX >= selRect.left && mouseX <= selRect.right &&
                                mouseY >= selRect.top && mouseY <= selRect.bottom) {
                                isOverSelect = true;
                            }
                        });
                        
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫—É—Ä—Å–æ—Ä –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–Ω–µ –º–µ–Ω—é –∏ select
                        if (!isOverMenu && !isOverSelect) {
                            closeStatusMenu();
                        }
                    }
                    // –ï—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –Ω–∞ select –∏–ª–∏ –µ–≥–æ —è—á–µ–π–∫—É, –º–µ–Ω—é –æ—Å—Ç–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º
                } else {
                    // –ï—Å–ª–∏ –º–µ–Ω—é –±—ã–ª–æ –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ –∏–∑ select, –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ä–∞–∑—É
                    if (!isStatusSelect && !isInsideStatusSelect && !isStatusCell) {
                        closeStatusMenu();
                    }
                }
            }

            // –°–±—Ä–æ—Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —è—á–µ–µ–∫
            if (selectedCells.size > 0) {
                const isGanttBar = target.closest('.gantt-bar');
                const isStatusMenu = target.closest('.status-menu');
                const isCommentModal = target.closest('#statusCommentModal');
                const isScaleWarningModal = target.closest('#scaleWarningModal');
                
                if (!isGanttBar && !isStatusMenu && !isCommentModal && !isScaleWarningModal) {
                    selectedCells.clear();
                    updateCellSelection();
                }
            }

            const deleteModal = document.getElementById('deleteConfirmModal');
            if (target === deleteModal) {
                cancelDeleteTask();
            }

            const resetPlanModal = document.getElementById('resetPlanConfirmModal');
            if (target === resetPlanModal) {
                cancelResetPlan();
            }

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é scaleWarningModal –∏–∑ —Å—Ç—Ä–æ–∫–∏ 17258
            if (scaleWarningModal && target === scaleWarningModal) {
                cancelScaleWarning();
            }

            const undoConfirmModal = document.getElementById('undoConfirmModal');
            if (target === undoConfirmModal) {
                cancelUndo();
            }

            const profileModal = document.getElementById('profileModal');
            if (target === profileModal) {
                closeProfileModal();
            }

            const statusCommentModal = document.getElementById('statusCommentModal');
            if (target === statusCommentModal) {
                cancelStatusComment();
            }

            const gantt = document.querySelector('.chart-container');
            const table = document.querySelector('.table-section');

            const insideGantt = gantt && gantt.contains(target);
            const insideTable = table && table.contains(target);
            const insideMenu = menu && menu.contains(target);
            const insideDeleteModal = deleteModal && deleteModal.contains(target);
            const insideResetPlanModal = resetPlanModal && resetPlanModal.contains(target);
            const insideUndoConfirmModal = undoConfirmModal && undoConfirmModal.contains(target);

            // –ö–ª–∏–∫ –ø–æ –ø—É—Å—Ç–æ–º—É –º–µ—Å—Ç—É –≤–Ω–µ –¥–∏–∞–≥—Ä–∞–º–º—ã/—Ç–∞–±–ª–∏—Ü—ã/–º–µ–Ω—é/–º–æ–¥–∞–ª–æ–∫
            // —Å–Ω–∏–º–∞–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á
            if (!insideGantt && !insideTable && !insideMenu && !insideDeleteModal && !insideResetPlanModal && !insideUndoConfirmModal) {
                clearSelection();
            }
        }

        // ========== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ü–†–û–§–ò–õ–Ø ==========
        let currentUser = null;

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadCurrentUser() {
            const userStr = localStorage.getItem('gantt-user');
            const ganttMode = localStorage.getItem('gantt-mode') || 'edit';
            const isViewMode = ganttMode === 'view';
            
            // –í —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
            if (isViewMode) {
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–ø—Ä–∞–≤–∫–∏ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                const helpBtn = document.getElementById('helpBtn');
                if (helpBtn) {
                    helpBtn.style.display = 'none';
                }
                return;
            }
            
            if (userStr) {
                try {
                    currentUser = JSON.parse(userStr);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è, –≤—ã–±–æ—Ä–∞ –∫–æ–º–ø–∞–Ω–∏–π –∏ –≤—ã—Ö–æ–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    showAuthButtons();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–ø—Ä–∞–≤–∫–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    const helpBtn = document.getElementById('helpBtn');
                    if (helpBtn) {
                        helpBtn.style.display = 'flex';
                    }
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                    setTimeout(() => {
                        const companiesBottomBtn = document.getElementById('companiesBottomBtn');
                        if (companiesBottomBtn) {
                            companiesBottomBtn.style.display = 'flex';
                            companiesBottomBtn.style.visibility = 'visible';
                            companiesBottomBtn.style.opacity = '1';
                            console.log('–ù–∏–∂–Ω—è—è –∫–Ω–æ–ø–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–∞ —á–µ—Ä–µ–∑ loadCurrentUser', {
                                display: companiesBottomBtn.style.display,
                                visibility: companiesBottomBtn.style.visibility,
                                computedDisplay: window.getComputedStyle(companiesBottomBtn).display
                            });
                        } else {
                            console.error('–ù–∏–∂–Ω—è—è –∫–Ω–æ–ø–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π –ù–ï –ù–ê–ô–î–ï–ù–ê –≤ loadCurrentUser!');
                        }
                    }, 200);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
                }
            } else {
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–ø—Ä–∞–≤–∫–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                const helpBtn = document.getElementById('helpBtn');
                if (helpBtn) {
                    helpBtn.style.display = 'none';
                }
            }
        }


        // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –∏ overlay
        function closeAllModalsAndOverlays() {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
            closeWelcomeModal();
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç—É—Ä, –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
            if (tourActive) {
                endTour();
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal) {
                    modal.style.display = 'none';
                }
            });
            
            // –£–±–∏—Ä–∞–µ–º overlay —Ç—É—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
            const tourOverlay = document.getElementById('tourOverlay');
            if (tourOverlay) {
                tourOverlay.classList.remove('active');
                tourOverlay.style.display = 'none';
            }
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ç—É—Ä–∞
            if (window.currentTourHighlight) {
                window.currentTourHighlight.remove();
                window.currentTourHighlight = null;
            }
            if (window.currentTourTooltip) {
                window.currentTourTooltip.remove();
                window.currentTourTooltip = null;
            }
        }

        // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—ã–±–æ—Ä–∞ –∫–æ–º–ø–∞–Ω–∏–π
        function goToCompanies() {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏ overlay –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º
            closeAllModalsAndOverlays();
            window.location.href = 'companies.html';
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        function logout() {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏ overlay –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º
            closeAllModalsAndOverlays();
            
            // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏–∑ localStorage
            localStorage.removeItem('gantt-user');
            localStorage.removeItem('gantt-mode');
            localStorage.removeItem('gantt-company');
            
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            window.location.href = 'auth.html';
        }

        // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let initialPosition = { x: 0, y: 0 };

        function initProfileModalDrag() {
            const modal = document.getElementById('profileModal');
            const modalContent = modal?.querySelector('.profile-modal-content');
            const modalHeader = modal?.querySelector('.profile-modal-header');
            
            if (!modalContent || !modalHeader) return;

            modalHeader.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('profile-modal-close')) {
                    return; // –ù–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
                }
                
                isDragging = true;
                const rect = modalContent.getBoundingClientRect();
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –æ—Ç —Ç–æ—á–∫–∏ –∫–ª–∏–∫–∞ –¥–æ –ª–µ–≤–æ–≥–æ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É–≥–ª–∞ –æ–∫–Ω–∞
                dragOffset.x = e.clientX - rect.left;
                dragOffset.y = e.clientY - rect.top;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –æ–∫–Ω–∞
                initialPosition.x = rect.left;
                initialPosition.y = rect.top;
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ fixed –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                modalContent.style.position = 'fixed';
                modalContent.style.left = rect.left + 'px';
                modalContent.style.top = rect.top + 'px';
                modalContent.style.margin = '0';
                modalContent.style.transition = 'none';
                
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const modalContent = document.querySelector('.profile-modal-content');
                if (!modalContent) return;

                // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é —Ç–∞–∫, —á—Ç–æ–±—ã —Ç–æ—á–∫–∞ –∫–ª–∏–∫–∞ –æ—Å—Ç–∞–≤–∞–ª–∞—Å—å –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
                let newX = e.clientX - dragOffset.x;
                let newY = e.clientY - dragOffset.y;
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ —ç–∫—Ä–∞–Ω–∞
                const maxX = window.innerWidth - modalContent.offsetWidth;
                const maxY = window.innerHeight - modalContent.offsetHeight;
                
                newX = Math.max(0, Math.min(newX, maxX));
                newY = Math.max(0, Math.min(newY, maxY));
                
                modalContent.style.left = newX + 'px';
                modalContent.style.top = newY + 'px';
            });

            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    const modalContent = document.querySelector('.profile-modal-content');
                    if (modalContent) {
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º transition –¥–ª—è –ø–ª–∞–≤–Ω—ã—Ö –∞–Ω–∏–º–∞—Ü–∏–π
                        modalContent.style.transition = '';
                        // –û—Å—Ç–∞–≤–ª—è–µ–º position: fixed, —á—Ç–æ–±—ã –æ–∫–Ω–æ –æ—Å—Ç–∞–ª–æ—Å—å –Ω–∞ –º–µ—Å—Ç–µ
                    }
                }
            });
        }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –±–∞—Ä–æ–≤ –≤ –¥–∏–∞–≥—Ä–∞–º–º–µ –ì–∞–Ω—Ç–∞
        document.addEventListener('mousemove', function(e) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ)
            if (draggingBarTaskId !== null && draggingBarTaskId !== undefined && !isDraggingBar) {
                const deltaX = Math.abs(e.clientX - dragStartX);
                const deltaY = Math.abs(e.clientY - dragStartY);
                
                // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏
                if (draggingBarTaskId === 0) {
                    console.log('üü¢ –ü–µ—Ä–≤–∞—è –∑–∞–¥–∞—á–∞ mousemove (drag):', {
                        draggingBarTaskId,
                        dragStartX,
                        dragStartY,
                        clientX: e.clientX,
                        clientY: e.clientY,
                        deltaX: deltaX.toFixed(2),
                        deltaY: deltaY.toFixed(2),
                        threshold: DRAG_THRESHOLD,
                        willActivate: deltaX > DRAG_THRESHOLD && deltaX > deltaY
                    });
                }
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–û–ú –¥–≤–∏–∂–µ–Ω–∏–∏ (deltaX > deltaY –∏ deltaX > –ø–æ—Ä–æ–≥–∞)
                // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏—é –ø—Ä–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ (–¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏)
                if (deltaX > DRAG_THRESHOLD && deltaX > deltaY) {
                    isDraggingBar = true;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º
                    addToUndoHistory();
                    
                    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                    document.querySelectorAll('.gantt-row').forEach(row => {
                        const rowTaskId = row.dataset.taskId;
                        if (rowTaskId && parseInt(rowTaskId) === draggingBarTaskId) {
                            row.querySelectorAll('.gantt-bar').forEach(bar => {
                                bar.style.opacity = '0.7';
                                bar.style.cursor = 'grabbing';
                            });
                        }
                    });
                    
                    document.body.style.cursor = 'grabbing';
                    
                    console.log('üéØ –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –±–∞—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ:', {
                        taskId: draggingBarTaskId,
                        deltaX: deltaX.toFixed(2),
                        deltaY: deltaY.toFixed(2)
                    });
                }
            }
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —É–∂–µ –Ω–∞—á–∞–ª–æ—Å—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ü–∏—é
            if (isDraggingBar && draggingBarTaskId !== null && draggingBarTaskId !== undefined) {
                // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –∑–∞–¥–∞—á–∏
                const taskRow = document.querySelector(`.gantt-row[data-task-id="${draggingBarTaskId}"]`);
                if (!taskRow) return;
                
                // –ù–∞—Ö–æ–¥–∏–º —è—á–µ–π–∫—É –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º –≤ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ
                const cells = Array.from(taskRow.querySelectorAll('.gantt-cell'));
                let targetCell = null;
                
                for (const cell of cells) {
                    const rect = cell.getBoundingClientRect();
                    if (e.clientX >= rect.left && e.clientX <= rect.right) {
                        targetCell = cell;
                        break;
                    }
                }
                
                if (!targetCell) return;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—É—é –¥–∞—Ç—É
                const newDate = getDateFromCellPosition(targetCell, e.clientX);
                if (!newDate) return;
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Ü–µ–ª–µ–≤–æ–π —è—á–µ–π–∫–∏
                cells.forEach(c => c.classList.remove('drag-target'));
                targetCell.classList.add('drag-target');
                
                document.body.style.cursor = 'grabbing';
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Å–∞–π–∑–∞ –±–∞—Ä–∞
            if (resizingBarTaskId !== null && resizingBarTaskId !== undefined && !isResizingBar) {
                const deltaX = Math.abs(e.clientX - resizeStartX);
                
                // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏
                if (resizingBarTaskId === 0) {
                    console.log('üìê –ü–µ—Ä–≤–∞—è –∑–∞–¥–∞—á–∞ mousemove (resize):', {
                        resizingBarTaskId,
                        resizeStartX,
                        clientX: e.clientX,
                        deltaX: deltaX.toFixed(2),
                        threshold: DRAG_THRESHOLD,
                        direction: resizeDirection,
                        willActivate: deltaX > DRAG_THRESHOLD
                    });
                } else {
                    console.log('üìê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä–æ–≥–∞ —Ä–µ—Å–∞–π–∑–∞:', { deltaX: deltaX.toFixed(1), threshold: DRAG_THRESHOLD, resizingBarTaskId });
                }
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ—Å–∞–π–∑ –ø—Ä–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏
                if (deltaX > DRAG_THRESHOLD) {
                    isResizingBar = true;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ —Ä–µ—Å–∞–π–∑–æ–º
                    addToUndoHistory();
                    
                    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Ä–µ—Å–∞–π–∑–∞
                    document.querySelectorAll('.gantt-row').forEach(row => {
                        const rowTaskId = row.dataset.taskId;
                        if (rowTaskId && parseInt(rowTaskId) === resizingBarTaskId) {
                            row.querySelectorAll('.gantt-bar').forEach(bar => {
                                bar.classList.add('resizing');
                            });
                        }
                    });
                    
                    document.body.style.cursor = 'ew-resize';
                    
                    console.log('üìê –†–µ—Å–∞–π–∑ –±–∞—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω:', {
                        taskId: resizingBarTaskId,
                        direction: resizeDirection,
                        deltaX: deltaX.toFixed(2),
                        startDays: resizeStartDays
                    });
                }
            }
            
            // –ï—Å–ª–∏ —Ä–µ—Å–∞–π–∑ —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ü–∏—é –∏ –≤—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            if (isResizingBar && resizingBarTaskId !== null && resizingBarTaskId !== undefined) {
                const taskRow = document.querySelector(`.gantt-row[data-task-id="${resizingBarTaskId}"]`);
                if (!taskRow) return;
                
                // –ù–∞—Ö–æ–¥–∏–º —è—á–µ–π–∫—É –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º –∏–ª–∏ –±–ª–∏–∂–∞–π—à—É—é –∫ –∫—É—Ä—Å–æ—Ä—É
                const cells = Array.from(taskRow.querySelectorAll('.gantt-cell'));
                let targetCell = null;
                let closestCell = null;
                let closestDistance = Infinity;
                
                for (const cell of cells) {
                    const rect = cell.getBoundingClientRect();
                    // –¢–æ—á–Ω–æ–µ –ø–æ–ø–∞–¥–∞–Ω–∏–µ
                    if (e.clientX >= rect.left && e.clientX <= rect.right) {
                        targetCell = cell;
                        break;
                    }
                    // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é —è—á–µ–π–∫—É —Å–ø—Ä–∞–≤–∞ –æ—Ç –∫—É—Ä—Å–æ—Ä–∞
                    const distance = Math.abs(rect.left - e.clientX);
                    if (rect.left >= e.clientX - 50 && distance < closestDistance) {
                        closestDistance = distance;
                        closestCell = cell;
                    }
                }
                
                // –ï—Å–ª–∏ —Ç–æ—á–Ω–æ –Ω–µ –ø–æ–ø–∞–ª–∏ - –±–µ—Ä—ë–º –±–ª–∏–∂–∞–π—à—É—é —è—á–µ–π–∫—É
                if (!targetCell && closestCell) {
                    targetCell = closestCell;
                }
                
                // –ï—Å–ª–∏ –∫—É—Ä—Å–æ—Ä –ø—Ä–∞–≤–µ–µ –≤—Å–µ—Ö —è—á–µ–µ–∫ - –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω—é—é
                if (!targetCell && cells.length > 0) {
                    const lastCell = cells[cells.length - 1];
                    const lastRect = lastCell.getBoundingClientRect();
                    if (e.clientX > lastRect.right) {
                        targetCell = lastCell;
                    }
                }
                
                if (targetCell) {
                    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Ü–µ–ª–µ–≤–æ–π —è—á–µ–π–∫–∏
                    cells.forEach(c => c.classList.remove('resize-target'));
                    targetCell.classList.add('resize-target');
                }
                
                document.body.style.cursor = 'ew-resize';
            }
            
            // –ï—Å–ª–∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è/—Ä–µ—Å–∞–π–∑–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä —Ä–µ—Å–∞–π–∑–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫—Ä–∞—è –±–∞—Ä–∞
            if (!isDraggingBar && (draggingBarTaskId === null || draggingBarTaskId === undefined) && 
                !isResizingBar && (resizingBarTaskId === null || resizingBarTaskId === undefined)) {
                // –ù–∞—Ö–æ–¥–∏–º –±–∞—Ä –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
                const elementUnderCursor = document.elementFromPoint(e.clientX, e.clientY);
                if (elementUnderCursor && elementUnderCursor.classList.contains('gantt-bar')) {
                    const bar = elementUnderCursor;
                    const barRect = bar.getBoundingClientRect();
                    const distanceFromRightEdge = barRect.right - e.clientX;
                    const distanceFromLeftEdge = e.clientX - barRect.left;
                    const isNearRightEdge = distanceFromRightEdge >= 0 && distanceFromRightEdge <= RESIZE_EDGE_THRESHOLD;
                    const isNearLeftEdge = distanceFromLeftEdge >= 0 && distanceFromLeftEdge <= RESIZE_EDGE_THRESHOLD;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ—Ç –±–∞—Ä –ø–æ—Å–ª–µ–¥–Ω–∏–º/–ø–µ—Ä–≤—ã–º –≤ –∑–∞–¥–∞—á–µ
                    const taskRow = bar.closest('.gantt-row');
                    if (taskRow) {
                        const allBarsInRow = taskRow.querySelectorAll('.gantt-bar');
                        const isLastBar = allBarsInRow.length > 0 && allBarsInRow[allBarsInRow.length - 1] === bar;
                        const isFirstBar = allBarsInRow.length > 0 && allBarsInRow[0] === bar;
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä —Ä–µ—Å–∞–π–∑–∞ –Ω–∞ –ø—Ä–∞–≤–æ–º –∫—Ä–∞—é –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–∞—Ä–∞ –∏–ª–∏ –ª–µ–≤–æ–º –∫—Ä–∞—é –ø–µ—Ä–≤–æ–≥–æ
                        if ((isNearRightEdge && isLastBar) || (isNearLeftEdge && isFirstBar)) {
                            bar.classList.add('resize-handle');
                        } else {
                            bar.classList.remove('resize-handle');
                        }
                    }
                }
                
                // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å resize-handle —Å–æ –≤—Å–µ—Ö –±–∞—Ä–æ–≤, –µ—Å–ª–∏ –∫—É—Ä—Å–æ—Ä –Ω–µ –Ω–∞–¥ –±–∞—Ä–æ–º
                if (!elementUnderCursor || !elementUnderCursor.classList.contains('gantt-bar')) {
                    document.querySelectorAll('.gantt-bar.resize-handle').forEach(bar => {
                        bar.classList.remove('resize-handle');
                    });
                }
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ touchmove –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –±–∞—Ä–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
        document.addEventListener('touchmove', function(e) {
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –∫–∞—Å–∞–Ω–∏–µ (–Ω–µ –∑—É–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–≤—É–º—è –ø–∞–ª—å—Ü–∞–º–∏)
            if (e.touches.length !== 1) return;
            
            const touch = e.touches[0];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ)
            if (draggingBarTaskId !== null && draggingBarTaskId !== undefined && !isDraggingBar) {
                const deltaX = Math.abs(touch.clientX - dragStartX);
                const deltaY = Math.abs(touch.clientY - dragStartY);
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–û–ú –¥–≤–∏–∂–µ–Ω–∏–∏
                if (deltaX > DRAG_THRESHOLD && deltaX > deltaY) {
                    isDraggingBar = true;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º
                    addToUndoHistory();
                    
                    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                    document.querySelectorAll('.gantt-row').forEach(row => {
                        const rowTaskId = row.dataset.taskId;
                        if (rowTaskId && parseInt(rowTaskId) === draggingBarTaskId) {
                            row.querySelectorAll('.gantt-bar').forEach(bar => {
                                bar.style.opacity = '0.7';
                            });
                        }
                    });
                    
                    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    e.preventDefault();
                    
                    console.log('üéØ –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –±–∞—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ (touch):', {
                        taskId: draggingBarTaskId,
                        deltaX: deltaX.toFixed(2),
                        deltaY: deltaY.toFixed(2)
                    });
                }
            }
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —É–∂–µ –Ω–∞—á–∞–ª–æ—Å—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ü–∏—é
            if (isDraggingBar && draggingBarTaskId !== null && draggingBarTaskId !== undefined) {
                // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –∑–∞–¥–∞—á–∏
                const taskRow = document.querySelector(`.gantt-row[data-task-id="${draggingBarTaskId}"]`);
                if (!taskRow) return;
                
                // –ù–∞—Ö–æ–¥–∏–º —è—á–µ–π–∫—É –ø–æ–¥ –∫–∞—Å–∞–Ω–∏–µ–º –≤ —Å—Ç—Ä–æ–∫–µ –∑–∞–¥–∞—á–∏
                const cells = Array.from(taskRow.querySelectorAll('.gantt-cell'));
                let targetCell = null;
                
                for (const cell of cells) {
                    const rect = cell.getBoundingClientRect();
                    if (touch.clientX >= rect.left && touch.clientX <= rect.right) {
                        targetCell = cell;
                        break;
                    }
                }
                
                if (!targetCell) return;
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Ü–µ–ª–µ–≤–æ–π —è—á–µ–π–∫–∏
                cells.forEach(c => c.classList.remove('drag-target'));
                targetCell.classList.add('drag-target');
                
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                e.preventDefault();
            }
        }, { passive: false });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ mouseup –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∏ —Ä–µ—Å–∞–π–∑–∞ –±–∞—Ä–æ–≤ (–¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –¥—Ä—É–≥–∏–º–∏)
        let barDragMouseUpHandler = function(e) {
            console.log('üñ±Ô∏è barDragMouseUpHandler –≤—ã–∑–≤–∞–Ω', { isDraggingBar, draggingBarTaskId, isResizingBar, resizingBarTaskId, clientX: e.clientX, clientY: e.clientY });
            
            // –£–±–∏—Ä–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –∏–Ω–¥–∏–∫–∞—Ü–∏—é —Ü–µ–ª–µ–≤—ã—Ö —è—á–µ–µ–∫
            document.querySelectorAll('.drag-target').forEach(c => c.classList.remove('drag-target'));
            document.querySelectorAll('.resize-target').forEach(c => c.classList.remove('resize-target'));
            document.querySelectorAll('.gantt-bar.resizing').forEach(bar => bar.classList.remove('resizing'));
            
            // ===== –û–ë–†–ê–ë–û–¢–ö–ê –†–ï–°–ê–ô–ó–ê =====
            if (resizingBarTaskId !== null && resizingBarTaskId !== undefined) {
                // –ï—Å–ª–∏ —Ä–µ—Å–∞–π–∑ –Ω–µ –Ω–∞—á–∞–ª—Å—è, –ø—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                if (!isResizingBar) {
                    console.log('‚ö†Ô∏è –ü—Ä–æ—Å—Ç–æ –∫–ª–∏–∫, –Ω–µ —Ä–µ—Å–∞–π–∑');
                    resetBarResizeState();
                    return;
                }
                
                // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–µ—Å–∞–π–∑
                isResizingBar = false;
                
                // –ù–∞—Ö–æ–¥–∏–º –∑–∞–¥–∞—á—É
                const taskIndex = tasks.findIndex(t => t.id === resizingBarTaskId);
                if (taskIndex === -1) {
                    console.error('‚ùå –ó–∞–¥–∞—á–∞ –¥–ª—è —Ä–µ—Å–∞–π–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', resizingBarTaskId);
                    resetBarResizeState();
                    return;
                }
                
                const task = tasks[taskIndex];
                const direction = resizeDirection; // 'left' –∏–ª–∏ 'right'
                
                console.log('üìê –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Å–∞–π–∑–∞:', { taskId: task.id, direction });
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –∏ –¥–Ω—è—Ö
                const deltaX = e.clientX - resizeStartX;
                
                // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É –ø–∏–∫—Å–µ–ª–µ–π –Ω–∞ —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –∏–∑ –±–∞—Ä–æ–≤ –∑–∞–¥–∞—á–∏
                let realPxPerDay = Math.max(30, 4 * zoomLevel); // fallback —Å —É—á—ë—Ç–æ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —à–∏—Ä–∏–Ω—ã —è—á–µ–π–∫–∏
                
                // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –±–∞—Ä—ã —ç—Ç–æ–π –∑–∞–¥–∞—á–∏ –∏ –≤—ã—á–∏—Å–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É –Ω–∞ –¥–µ–Ω—å
                const taskBars = document.querySelectorAll(`.gantt-bar[data-task-id="${resizingBarTaskId}"]`);
                if (taskBars.length > 0 && task.dates && task.dates.length > 0) {
                    let totalBarWidth = 0;
                    taskBars.forEach(bar => {
                        totalBarWidth += bar.getBoundingClientRect().width;
                    });
                    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –≤ –∑–∞–¥–∞—á–µ
                    const workDays = task.days || task.dates.length;
                    if (workDays > 0 && totalBarWidth > 0) {
                        realPxPerDay = totalBarWidth / workDays;
                    }
                }
                
                const daysDelta = Math.round(deltaX / realPxPerDay);
                
                console.log('üìê –°–º–µ—â–µ–Ω–∏–µ:', {
                    deltaX: deltaX.toFixed(0),
                    realPxPerDay: realPxPerDay.toFixed(1),
                    daysDelta: daysDelta,
                    direction: direction
                });
                
                if (direction === 'right') {
                    // ===== –†–ï–°–ê–ô–ó –°–ü–†–ê–í–ê (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è) =====
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ö–ê–õ–ï–ù–î–ê–†–ù–´–ï –¥–Ω–∏ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ —á–µ—Ä–µ–∑ –≤—ã—Ö–æ–¥–Ω—ã–µ
                    
                    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è (–≤ –ø–∏–∫—Å–µ–ª—è—Ö)
                    const MIN_RESIZE_DELTA_RIGHT = 5;
                    if (Math.abs(deltaX) < MIN_RESIZE_DELTA_RIGHT) {
                        console.log('‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Ä–µ—Å–∞–π–∑–∞ —Å–ø—Ä–∞–≤–∞');
                        resetBarResizeState();
                        return;
                    }
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º —à–∏—Ä–∏–Ω—É –æ–¥–Ω–æ–≥–æ –ö–ê–õ–ï–ù–î–ê–†–ù–û–ì–û –¥–Ω—è –∏–∑ —è—á–µ–µ–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                    let pxPerCalendarDayRight = Math.max(30, 4 * zoomLevel); // fallback
                    const headerCellsRight = document.querySelectorAll('.gantt-header-cell');
                    if (headerCellsRight.length > 0) {
                        const firstCell = headerCellsRight[0];
                        const rect = firstCell.getBoundingClientRect();
                        const startDateStr = firstCell.getAttribute('data-start-date');
                        const endDateStr = firstCell.getAttribute('data-end-date');
                        
                        if (startDateStr && endDateStr) {
                            const cellStart = new Date(startDateStr);
                            const cellEnd = new Date(endDateStr);
                            const cellDays = Math.round((cellEnd - cellStart) / (1000 * 60 * 60 * 24)) + 1;
                            if (cellDays > 0) {
                                pxPerCalendarDayRight = rect.width / cellDays;
                            }
                        }
                    }
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –≤ –ö–ê–õ–ï–ù–î–ê–†–ù–´–• –¥–Ω—è—Ö (–æ–∫—Ä—É–≥–ª—è–µ–º –∫ –Ω—É–ª—é)
                    const calendarDaysDeltaRight = Math.trunc(deltaX / pxPerCalendarDayRight);
                    
                    console.log('üìÖ –°–º–µ—â–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∞ (–∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –¥–Ω–∏):', {
                        deltaX: deltaX.toFixed(0),
                        pxPerCalendarDayRight: pxPerCalendarDayRight.toFixed(1),
                        calendarDaysDeltaRight: calendarDaysDeltaRight
                    });
                    
                    if (calendarDaysDeltaRight === 0) {
                        console.log('‚ö†Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω—è—Ö (—Å–ø—Ä–∞–≤–∞)');
                        resetBarResizeState();
                        return;
                    }
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è = –∏—Å—Ö–æ–¥–Ω–∞—è + –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –¥–Ω–∏
                    let newEndDate = new Date(resizeStartEndDate);
                    newEndDate.setDate(newEndDate.getDate() + calendarDaysDeltaRight);
                    
                    console.log('üìÖ –ù–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è (–¥–æ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏):', formatDateKey(newEndDate));
                    
                    // –ï—Å–ª–∏ –Ω–æ–≤–∞—è –¥–∞—Ç–∞ - –≤—ã—Ö–æ–¥–Ω–æ–π –∏–ª–∏ –ø—Ä–∞–∑–¥–Ω–∏–∫, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º
                    let dayOfWeekRight = newEndDate.getDay();
                    let dateKeyRight = formatDateKey(newEndDate);
                    let isWeekendRight = dayOfWeekRight === 0 || dayOfWeekRight === 6;
                    let isHolidayRight = holidays.some(h => formatDateKey(h) === dateKeyRight);
                    
                    // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–¥–≤–∏–≥–∞: –≤–ø—Ä–∞–≤–æ (+1) –∏–ª–∏ –≤–ª–µ–≤–æ (-1)
                    const searchDirectionRight = calendarDaysDeltaRight > 0 ? 1 : -1;
                    
                    while (isWeekendRight || isHolidayRight) {
                        newEndDate.setDate(newEndDate.getDate() + searchDirectionRight);
                        dayOfWeekRight = newEndDate.getDay();
                        dateKeyRight = formatDateKey(newEndDate);
                        isWeekendRight = dayOfWeekRight === 0 || dayOfWeekRight === 6;
                        isHolidayRight = holidays.some(h => formatDateKey(h) === dateKeyRight);
                    }
                    
                    console.log('üìÖ –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è (—Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å):', formatDateKey(newEndDate));
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞
                    const startDateRight = new Date(resizeStartStartDate);
                    if (newEndDate.getTime() < startDateRight.getTime()) {
                        console.log('‚ö†Ô∏è –ù–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞, –æ—Ç–º–µ–Ω–∞ —Ä–µ—Å–∞–π–∑–∞');
                        resetBarResizeState();
                        return;
                    }
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –º–µ–∂–¥—É startDate –∏ newEndDate
                    let newDays = 0;
                    let currentDateRight = new Date(startDateRight);
                    while (currentDateRight.getTime() <= newEndDate.getTime()) {
                        const dow = currentDateRight.getDay();
                        const dk = formatDateKey(currentDateRight);
                        const isWe = dow === 0 || dow === 6;
                        const isHol = holidays.some(h => formatDateKey(h) === dk);
                        
                        if (!isWe && !isHol) {
                            newDays++;
                        }
                        currentDateRight.setDate(currentDateRight.getDate() + 1);
                    }
                    
                    // –ú–∏–Ω–∏–º—É–º 1 —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
                    if (newDays < 1) {
                        newDays = 1;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π
                    if (newDays === resizeStartDays) {
                        console.log('‚ö†Ô∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, –æ—Ç–º–µ–Ω–∞ —Ä–µ—Å–∞–π–∑–∞');
                        resetBarResizeState();
                        return;
                    }
                    
                    console.log('üìê –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ—Å–∞–π–∑–∞ –±–∞—Ä–∞ (—Å–ø—Ä–∞–≤–∞):', {
                        taskId: resizingBarTaskId,
                        oldDays: resizeStartDays,
                        newDays: newDays,
                        oldEndDate: formatDateKey(resizeStartEndDate),
                        newEndDate: formatDateKey(newEndDate)
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á–∏
                    task.days = newDays;
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏ (startDate –æ—Å—Ç–∞—ë—Ç—Å—è, endDate –º–µ–Ω—è–µ—Ç—Å—è)
                    const newDates = getTaskDates(task.startDate, task.days);
                    if (!newDates || newDates.length === 0) {
                        console.error('‚ùå –û—à–∏–±–∫–∞: getTaskDates –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ!');
                        task.days = resizeStartDays;
                        resetBarResizeState();
                        return;
                    }
                    
                    task.dates = newDates;
                    task.endDate = newDates[newDates.length - 1];
                    
                    console.log('üìä –ù–æ–≤—ã–µ –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏ –ø–æ—Å–ª–µ —Ä–µ—Å–∞–π–∑–∞ (—Å–ø—Ä–∞–≤–∞):', {
                        days: task.days,
                        datesCount: task.dates.length,
                        startDate: formatDateKey(task.startDate),
                        endDate: formatDateKey(task.endDate)
                    });
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏
                    recalculateFollowingTasks(taskIndex);
                    
                } else if (direction === 'left') {
                    // ===== –†–ï–°–ê–ô–ó –°–õ–ï–í–ê (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞) =====
                    // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –≤ –ö–ê–õ–ï–ù–î–ê–†–ù–´–• –¥–Ω—è—Ö
                    
                    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è (–≤ –ø–∏–∫—Å–µ–ª—è—Ö)
                    const MIN_RESIZE_DELTA = 5;
                    if (Math.abs(deltaX) < MIN_RESIZE_DELTA) {
                        console.log('‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Ä–µ—Å–∞–π–∑–∞ —Å–ª–µ–≤–∞');
                        resetBarResizeState();
                        return;
                    }
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º —à–∏—Ä–∏–Ω—É –æ–¥–Ω–æ–≥–æ –ö–ê–õ–ï–ù–î–ê–†–ù–û–ì–û –¥–Ω—è –∏–∑ —è—á–µ–µ–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                    let pxPerCalendarDay = Math.max(30, 4 * zoomLevel); // fallback
                    const headerCells = document.querySelectorAll('.gantt-header-cell');
                    if (headerCells.length > 0) {
                        // –ë–µ—Ä—ë–º –ø–µ—Ä–≤—É—é —è—á–µ–π–∫—É –∏ –≤—ã—á–∏—Å–ª—è–µ–º px/–¥–µ–Ω—å
                        const firstCell = headerCells[0];
                        const rect = firstCell.getBoundingClientRect();
                        const startDateStr = firstCell.getAttribute('data-start-date');
                        const endDateStr = firstCell.getAttribute('data-end-date');
                        
                        if (startDateStr && endDateStr) {
                            const cellStart = new Date(startDateStr);
                            const cellEnd = new Date(endDateStr);
                            const cellDays = Math.round((cellEnd - cellStart) / (1000 * 60 * 60 * 24)) + 1;
                            if (cellDays > 0) {
                                pxPerCalendarDay = rect.width / cellDays;
                            }
                        }
                    }
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω—è—Ö (–æ–∫—Ä—É–≥–ª—è–µ–º –∫ –Ω—É–ª—é, —á—Ç–æ–±—ã –Ω–µ –ø—Ä—ã–≥–∞—Ç—å –ª–∏—à–Ω–∏–µ –¥–Ω–∏)
                    const calendarDaysDelta = Math.trunc(deltaX / pxPerCalendarDay);
                    
                    console.log('üìÖ –°–º–µ—â–µ–Ω–∏–µ (–∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –¥–Ω–∏):', {
                        deltaX: deltaX.toFixed(0),
                        pxPerCalendarDay: pxPerCalendarDay.toFixed(1),
                        calendarDaysDelta: calendarDaysDelta
                    });
                    
                    if (calendarDaysDelta === 0) {
                        console.log('‚ö†Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω—è—Ö');
                        resetBarResizeState();
                        return;
                    }
                    
                    // –ù–æ–≤–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ = –∏—Å—Ö–æ–¥–Ω–∞—è + —Å–º–µ—â–µ–Ω–∏–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω—è—Ö
                    let newStartDate = new Date(resizeStartStartDate);
                    newStartDate.setDate(newStartDate.getDate() + calendarDaysDelta);
                    
                    console.log('üìÖ –ù–æ–≤–∞—è –¥–∞—Ç–∞ (–¥–æ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏):', formatDateKey(newStartDate));
                    
                    // –ï—Å–ª–∏ –Ω–æ–≤–∞—è –¥–∞—Ç–∞ - –≤—ã—Ö–æ–¥–Ω–æ–π –∏–ª–∏ –ø—Ä–∞–∑–¥–Ω–∏–∫, —Å–¥–≤–∏–≥–∞–µ–º –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
                    let dayOfWeek = newStartDate.getDay();
                    let dateKey = formatDateKey(newStartDate);
                    let isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    let isHoliday = holidays.some(h => formatDateKey(h) === dateKey);
                    
                    // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–¥–≤–∏–≥–∞: –µ—Å–ª–∏ —Ç—è–Ω–µ–º –≤–ª–µ–≤–æ (—Ä–∞–Ω—å—à–µ) - –∏—â–µ–º —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å —Ä–∞–Ω—å—à–µ, –∏–Ω–∞—á–µ –ø–æ–∑–∂–µ
                    const searchDirection = calendarDaysDelta < 0 ? -1 : 1;
                    
                    while (isWeekend || isHoliday) {
                        newStartDate.setDate(newStartDate.getDate() + searchDirection);
                        dayOfWeek = newStartDate.getDay();
                        dateKey = formatDateKey(newStartDate);
                        isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                        isHoliday = holidays.some(h => formatDateKey(h) === dateKey);
                    }
                    
                    console.log('üìÖ –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ (—Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å):', formatDateKey(newStartDate));
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ–≤–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –ø–æ–∑–∂–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è
                    const endDate = new Date(resizeStartEndDate);
                    if (newStartDate.getTime() > endDate.getTime()) {
                        console.log('‚ö†Ô∏è –ù–æ–≤–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–æ–∑–∂–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è, –æ—Ç–º–µ–Ω–∞ —Ä–µ—Å–∞–π–∑–∞');
                        resetBarResizeState();
                        return;
                    }
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
                    let newDays = 0;
                    let currentDate = new Date(newStartDate);
                    while (currentDate.getTime() <= endDate.getTime()) {
                        const dayOfWeek = currentDate.getDay();
                        const dateKey = formatDateKey(currentDate);
                        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                        const isHoliday = holidays.some(h => formatDateKey(h) === dateKey);
                        
                        if (!isWeekend && !isHoliday) {
                            newDays++;
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    // –ú–∏–Ω–∏–º—É–º 1 —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
                    if (newDays < 1) {
                        newDays = 1;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –ª–∏ —á—Ç–æ-—Ç–æ
                    if (newDays === resizeStartDays && formatDateKey(newStartDate) === formatDateKey(resizeStartStartDate)) {
                        console.log('‚ö†Ô∏è –ù–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, –æ—Ç–º–µ–Ω–∞ —Ä–µ—Å–∞–π–∑–∞');
                        resetBarResizeState();
                        return;
                    }
                    
                    console.log('üìê –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ—Å–∞–π–∑–∞ –±–∞—Ä–∞ (—Å–ª–µ–≤–∞):', {
                        taskId: resizingBarTaskId,
                        oldStartDate: formatDateKey(resizeStartStartDate),
                        newStartDate: formatDateKey(newStartDate),
                        oldDays: resizeStartDays,
                        newDays: newDays
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–¥–∞—á—É
                    task.startDate = newStartDate;
                    task.days = newDays;
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏
                    const newDates = getTaskDates(task.startDate, task.days);
                    if (!newDates || newDates.length === 0) {
                        console.error('‚ùå –û—à–∏–±–∫–∞: getTaskDates –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ!');
                        task.startDate = resizeStartStartDate;
                        task.days = resizeStartDays;
                        resetBarResizeState();
                        return;
                    }
                    
                    task.dates = newDates;
                    task.endDate = newDates[newDates.length - 1];
                    
                    console.log('üìä –ù–æ–≤—ã–µ –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏ –ø–æ—Å–ª–µ —Ä–µ—Å–∞–π–∑–∞ (—Å–ª–µ–≤–∞):', {
                        days: task.days,
                        datesCount: task.dates.length,
                        startDate: formatDateKey(task.startDate),
                        endDate: formatDateKey(task.endDate)
                    });
                    
                    // –ü—Ä–∏ —Ä–µ—Å–∞–π–∑–µ —Å–ª–µ–≤–∞ –¥–ª—è –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏ (taskIndex === 0) –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏,
                    // —Ç–∞–∫ –∫–∞–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ
                    // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ —Å–ª–µ–≤–∞ –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏,
                    // –ø–æ—Ç–æ–º—É —á—Ç–æ endDate –æ—Å—Ç–∞–ª—Å—è –ø—Ä–µ–∂–Ω–∏–º
                    if (taskIndex === 0) {
                        recalculateFollowingTasks(taskIndex);
                    }
                } else {
                    console.error('‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å–∞–π–∑–∞:', direction);
                    resetBarResizeState();
                    return;
                }
                
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
                renderGantt();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                autoSaveGanttState();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ—Å–∞–π–∑–∞
                resetBarResizeState();
                
                console.log('‚úÖ –†–µ—Å–∞–π–∑ –∑–∞–≤–µ—Ä—à–µ–Ω');
                return;
            }
            
            // ===== –û–ë–†–ê–ë–û–¢–ö–ê –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø =====
            // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞—á–∞–ª–æ—Å—å, –ø—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            if (!isDraggingBar && draggingBarTaskId !== null && draggingBarTaskId !== undefined) {
                // –≠—Ç–æ –±—ã–ª –ø—Ä–æ—Å—Ç–æ –∫–ª–∏–∫, –Ω–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
                console.log('‚ö†Ô∏è –ü—Ä–æ—Å—Ç–æ –∫–ª–∏–∫, –Ω–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ');
                resetBarDragState();
                return;
            }
            
            if (!isDraggingBar || (draggingBarTaskId === null || draggingBarTaskId === undefined)) {
                console.log('‚ö†Ô∏è –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ, –≤—ã—Ö–æ–¥');
                resetBarDragState();
                return;
            }
            
            // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
            isDraggingBar = false;
            
            // –ù–∞—Ö–æ–¥–∏–º –∑–∞–¥–∞—á—É
            const taskIndex = tasks.findIndex(t => t.id === draggingBarTaskId);
            if (taskIndex === -1) {
                console.error('‚ùå –ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', draggingBarTaskId);
                resetBarDragState();
                return;
            }
            
            const task = tasks[taskIndex];
            
            // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –∑–∞–¥–∞—á–∏
            const taskRow = document.querySelector(`.gantt-row[data-task-id="${draggingBarTaskId}"]`);
            console.log('üîç taskRow:', taskRow);
            if (!taskRow) {
                console.log('‚ö†Ô∏è –°—Ç—Ä–æ–∫–∞ –∑–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –æ—Ç–º–µ–Ω–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è');
                resetBarDragState();
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º —è—á–µ–π–∫—É –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º –≤ —Å—Ç—Ä–æ–∫–µ –∑–∞–¥–∞—á–∏
            const cells = Array.from(taskRow.querySelectorAll('.gantt-cell'));
            console.log('üîç –ù–∞–π–¥–µ–Ω–æ —è—á–µ–µ–∫ .gantt-cell –≤ —Å—Ç—Ä–æ–∫–µ:', cells.length);
            let targetCell = null;
            
            for (const cell of cells) {
                const rect = cell.getBoundingClientRect();
                if (e.clientX >= rect.left && e.clientX <= rect.right) {
                    targetCell = cell;
                    console.log('‚úÖ –¶–µ–ª–µ–≤–∞—è —è—á–µ–π–∫–∞ –Ω–∞–π–¥–µ–Ω–∞:', { left: rect.left, right: rect.right, clientX: e.clientX });
                    break;
                }
            }
            
            if (!targetCell) {
                console.log('‚ö†Ô∏è –Ø—á–µ–π–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º. clientX:', e.clientX, '–Ø—á–µ–π–∫–∏:', cells.map(c => {
                    const r = c.getBoundingClientRect();
                    return { left: r.left, right: r.right };
                }));
                resetBarDragState();
                return;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—É—é –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞
            const newStartDate = getDateFromCellPosition(targetCell, e.clientX);
            if (!newStartDate) {
                console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–∞—Ç—É, –æ—Ç–º–µ–Ω–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è');
                resetBarDragState();
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
            if (newStartDate.getTime() === dragStartDate.getTime()) {
                console.log('‚ö†Ô∏è –î–∞—Ç–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –æ—Ç–º–µ–Ω–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è');
                resetBarDragState();
                return;
            }
            
            console.log('üéØ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –±–∞—Ä–∞:', {
                taskId: draggingBarTaskId,
                oldDate: formatDateKey(dragStartDate),
                newDate: formatDateKey(newStartDate)
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            const oldDays = task.days;
            const oldDatesCount = task.dates ? task.dates.length : 0;
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ task.days –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∞—Ç –∏–ª–∏ 1 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            if (!task.days || task.days <= 0) {
                task.days = task.dates && task.dates.length > 0 ? task.dates.length : 1;
                console.log('‚ö†Ô∏è task.days –±—ã–ª–æ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:', task.days);
            }
            
            // –ò–∑–º–µ–Ω—è–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞—á–∏
            task.startDate = new Date(newStartDate);
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏ —Å —É—á–µ—Ç–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
            const newDates = getTaskDates(task.startDate, task.days);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã
            if (!newDates || newDates.length === 0) {
                console.error('‚ùå –û—à–∏–±–∫–∞: getTaskDates –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤!', {
                    startDate: task.startDate,
                    days: task.days,
                    oldDays: oldDays,
                    oldDatesCount: oldDatesCount
                });
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—É—é –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞
                task.startDate = new Date(dragStartDate);
                resetBarDragState();
                return;
            }
            
            task.dates = newDates;
            task.endDate = newDates[newDates.length - 1];
            
            console.log('üìä –ù–æ–≤—ã–µ –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏:', {
                days: task.days,
                datesCount: task.dates.length,
                startDate: formatDateKey(task.startDate),
                endDate: formatDateKey(task.endDate)
            });
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –¥–∞—Ç (—Ç–∞–∫ –∫–∞–∫ –¥–∞—Ç—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)
            task.dateStatuses = {};
            task.dateComments = {};
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏
            recalculateFollowingTasks(taskIndex);
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
            renderGantt();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            autoSaveGanttState();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            resetBarDragState();
            
            console.log('‚úÖ –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
        };
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ mouseup –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –±–∞—Ä–æ–≤
        document.addEventListener('mouseup', barDragMouseUpHandler);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ touchend –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –±–∞—Ä–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
        document.addEventListener('touchend', function(e) {
            // –£–±–∏—Ä–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –∏–Ω–¥–∏–∫–∞—Ü–∏—é —Ü–µ–ª–µ–≤—ã—Ö —è—á–µ–µ–∫
            document.querySelectorAll('.drag-target').forEach(c => c.classList.remove('drag-target'));
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞—á–∞–ª–æ—Å—å, –ø—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            if (!isDraggingBar && draggingBarTaskId !== null && draggingBarTaskId !== undefined) {
                // –≠—Ç–æ –±—ã–ª –ø—Ä–æ—Å—Ç–æ –∫–ª–∏–∫, –Ω–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
                resetBarDragState();
                return;
            }
            
            if (!isDraggingBar || (draggingBarTaskId === null || draggingBarTaskId === undefined)) {
                resetBarDragState();
                return;
            }
            
            // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
            isDraggingBar = false;
            
            // –ù–∞—Ö–æ–¥–∏–º –∑–∞–¥–∞—á—É
            const taskIndex = tasks.findIndex(t => t.id === draggingBarTaskId);
            if (taskIndex === -1) {
                console.error('‚ùå –ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', draggingBarTaskId);
                resetBarDragState();
                return;
            }
            
            const task = tasks[taskIndex];
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∫–∞—Å–∞–Ω–∏–µ
            const touch = e.changedTouches[0];
            if (!touch) {
                resetBarDragState();
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –∑–∞–¥–∞—á–∏
            const taskRow = document.querySelector(`.gantt-row[data-task-id="${draggingBarTaskId}"]`);
            if (!taskRow) {
                console.log('‚ö†Ô∏è –°—Ç—Ä–æ–∫–∞ –∑–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –æ—Ç–º–µ–Ω–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è');
                resetBarDragState();
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º —è—á–µ–π–∫—É –ø–æ–¥ –∫–∞—Å–∞–Ω–∏–µ–º –≤ —Å—Ç—Ä–æ–∫–µ –∑–∞–¥–∞—á–∏
            const cells = Array.from(taskRow.querySelectorAll('.gantt-cell'));
            let targetCell = null;
            
            for (const cell of cells) {
                const rect = cell.getBoundingClientRect();
                if (touch.clientX >= rect.left && touch.clientX <= rect.right) {
                    targetCell = cell;
                    break;
                }
            }
            
            if (!targetCell) {
                console.log('‚ö†Ô∏è –Ø—á–µ–π–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –æ—Ç–º–µ–Ω–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è');
                resetBarDragState();
                return;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—É—é –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞
            const newStartDate = getDateFromCellPosition(targetCell, touch.clientX);
            if (!newStartDate) {
                console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–∞—Ç—É, –æ—Ç–º–µ–Ω–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è');
                resetBarDragState();
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
            if (newStartDate.getTime() === dragStartDate.getTime()) {
                console.log('‚ö†Ô∏è –î–∞—Ç–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –æ—Ç–º–µ–Ω–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è');
                resetBarDragState();
                return;
            }
            
            console.log('üéØ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –±–∞—Ä–∞ (touch):', {
                taskId: draggingBarTaskId,
                oldDate: formatDateKey(dragStartDate),
                newDate: formatDateKey(newStartDate)
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            const oldDays = task.days;
            const oldDatesCount = task.dates ? task.dates.length : 0;
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ task.days –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∞—Ç –∏–ª–∏ 1 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            if (!task.days || task.days <= 0) {
                task.days = task.dates && task.dates.length > 0 ? task.dates.length : 1;
                console.log('‚ö†Ô∏è task.days –±—ã–ª–æ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:', task.days);
            }
            
            // –ò–∑–º–µ–Ω—è–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞—á–∏
            task.startDate = new Date(newStartDate);
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏ —Å —É—á–µ—Ç–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
            const newDates = getTaskDates(task.startDate, task.days);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã
            if (!newDates || newDates.length === 0) {
                console.error('‚ùå –û—à–∏–±–∫–∞: getTaskDates –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤! (touch)', {
                    startDate: task.startDate,
                    days: task.days,
                    oldDays: oldDays,
                    oldDatesCount: oldDatesCount
                });
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—É—é –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞
                task.startDate = new Date(dragStartDate);
                resetBarDragState();
                return;
            }
            
            task.dates = newDates;
            task.endDate = newDates[newDates.length - 1];
            
            console.log('üìä –ù–æ–≤—ã–µ –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏ (touch):', {
                days: task.days,
                datesCount: task.dates.length,
                startDate: formatDateKey(task.startDate),
                endDate: formatDateKey(task.endDate)
            });
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –¥–∞—Ç (—Ç–∞–∫ –∫–∞–∫ –¥–∞—Ç—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)
            task.dateStatuses = {};
            task.dateComments = {};
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏
            recalculateFollowingTasks(taskIndex);
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
            renderGantt();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            autoSaveGanttState();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            resetBarDragState();
            
            console.log('‚úÖ –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ (touch)');
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –±–∞—Ä–∞
        function resetBarDragState() {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º draggable –Ω–∞ —Å—Ç—Ä–æ–∫–µ, –µ—Å–ª–∏ –±—ã–ª–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ
            if (dragStartRow && canEdit()) {
                dragStartRow.draggable = true;
            }
            
            isDraggingBar = false;
            draggingBarTaskId = null;
            dragStartX = 0;
            dragStartY = 0;
            dragStartDate = null;
            dragStartCell = null;
            dragStartTime = 0;
            dragStartRow = null;
            
            // –¢–∞–∫–∂–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ—Å–∞–π–∑–∞ (–µ—Å–ª–∏ –±—ã–ª–æ –∞–∫—Ç–∏–≤–Ω–æ)
            isResizingBar = false;
            resizingBarTaskId = null;
            resizeStartX = 0;
            resizeStartDays = 0;
            resizeStartEndDate = null;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            document.querySelectorAll('.gantt-bar').forEach(bar => {
                bar.style.opacity = '';
                bar.style.cursor = '';
                bar.classList.remove('resizing');
                bar.classList.remove('resize-handle');
            });
            
            // –£–±–∏—Ä–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –∏–Ω–¥–∏–∫–∞—Ü–∏—é —Ü–µ–ª–µ–≤—ã—Ö —è—á–µ–µ–∫
            document.querySelectorAll('.drag-target').forEach(c => c.classList.remove('drag-target'));
            document.querySelectorAll('.resize-target').forEach(c => c.classList.remove('resize-target'));
            
            document.body.style.cursor = '';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞ –æ–∫–Ω–∞ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è/—Ä–µ—Å–∞–π–∑–∞
        window.addEventListener('blur', function() {
            if (isDraggingBar || (draggingBarTaskId !== null && draggingBarTaskId !== undefined) || 
                isResizingBar || (resizingBarTaskId !== null && resizingBarTaskId !== undefined)) {
                console.log('‚ö†Ô∏è –û–∫–Ω–æ –ø–æ—Ç–µ—Ä—è–ª–æ —Ñ–æ–∫—É—Å, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è/—Ä–µ—Å–∞–π–∑–∞');
                resetBarDragState();
            }
        });

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è
        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            const modalContent = modal?.querySelector('.profile-modal-content');
            const nameInput = document.getElementById('profileName');
            const loginInput = document.getElementById('profileLogin');
            if (modal && currentUser && loginInput && nameInput) {
                nameInput.value = currentUser.name || '';
                loginInput.value = currentUser.login || '';
                document.getElementById('profilePassword').value = '';
                document.getElementById('profilePasswordConfirm').value = '';
                document.getElementById('profileMessage').classList.remove('show');
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                if (modalContent) {
                    modalContent.style.position = '';
                    modalContent.style.left = '';
                    modalContent.style.top = '';
                    modalContent.style.margin = '';
                    modalContent.style.transform = '';
                }
                
                modal.classList.add('show');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è
        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
        async function saveProfile(event) {
            event.preventDefault();
            
            const nameInput = document.getElementById('profileName');
            const loginInput = document.getElementById('profileLogin');
            const passwordInput = document.getElementById('profilePassword');
            const passwordConfirmInput = document.getElementById('profilePasswordConfirm');
            const messageEl = document.getElementById('profileMessage');
            
            const newName = nameInput.value.trim();
            const newLogin = loginInput.value.trim();
            const newPassword = passwordInput.value;
            const passwordConfirm = passwordConfirmInput.value;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            if (!newName) {
                messageEl.textContent = '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º';
                messageEl.className = 'profile-message error show';
                return;
            }

            if (!newLogin) {
                messageEl.textContent = '–õ–æ–≥–∏–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º';
                messageEl.className = 'profile-message error show';
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª–µ–π
            if (newPassword && newPassword !== passwordConfirm) {
                messageEl.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
                messageEl.className = 'profile-message error show';
                return;
            }

            if (newPassword && newPassword.length < 6) {
                messageEl.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
                messageEl.className = 'profile-message error show';
                return;
            }

            try {
                const updateData = {
                    oldLogin: currentUser.login,
                    newLogin: newLogin,
                    name: newName,
                    password: newPassword || null
                };

                const response = await fetch('/api/users/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();

                if (result.ok) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage
                    currentUser.name = newName;
                    currentUser.login = newLogin;
                    localStorage.setItem('gantt-user', JSON.stringify(currentUser));
                    
                    messageEl.textContent = '–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω';
                    messageEl.className = 'profile-message success show';
                    
                    setTimeout(() => {
                        closeProfileModal();
                    }, 1500);
                } else {
                    messageEl.textContent = result.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è';
                    messageEl.className = 'profile-message error show';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
                messageEl.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
                messageEl.className = 'profile-message error show';
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –∫–æ–º–ø–∞–Ω–∏–∏
        async function checkCompanyAccess() {
            if (!currentCompany) {
                // –ï—Å–ª–∏ –∫–æ–º–ø–∞–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞, —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
                return true;
            }

            const userStr = localStorage.getItem('gantt-user');
            if (!userStr) {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø (—Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞)
                return true;
            }

            try {
                const user = JSON.parse(userStr);
                // –ê–¥–º–∏–Ω—ã –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∫–æ–º–ø–∞–Ω–∏—è–º
                if (user.role === 'admin') {
                    return true;
                }
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ—Å—Ç—É–ø –∫ –∫–æ–º–ø–∞–Ω–∏–∏
                const userCompanies = user.companies || [];
                return userCompanies.includes(currentCompany);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞:', e);
                return true; // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –¥–∞–Ω–Ω—ã—Ö
            const hasAccess = await checkCompanyAccess();
            if (!hasAccess && currentCompany) {
                alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–∏. –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.');
                window.location.href = `auth.html?company=${currentCompany}`;
                return;
            }

            // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞
            await loadCompanyInfo();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫–µ–ª–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            await loadSkeletonFromServer();
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
            const fullStateLoaded = await loadFullGanttState();
            if (!fullStateLoaded) {
                // –ï—Å–ª–∏ –ø–æ–ª–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é...');
                await initializeTasks();
                // –ó–∞–≥—Ä—É–∂–∞–µ–º baseline –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                await loadBaselineFromServer();
            }
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≥—Ä–∞—Ñ–∏–∫ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω
            console.log('üìä –§–∏–Ω–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á:', tasks.length);
            if (tasks.length > 0) {
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∑–∞–¥–∞—á–∏ —Å —É—á–µ—Ç–æ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
                if (Object.keys(customCalendar).length > 0) {
                    console.log('üìÖ –ü–µ—Ä–µ—Å—á–µ—Ç –∑–∞–¥–∞—á —Å —É—á–µ—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è...');
                    recalculateTasksAfterCalendarChange();
                }
                
                console.log('‚úÖ –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –∏ —Ç–∞–±–ª–∏—Ü—ã...');
                renderGantt();
                renderTable();
                renderStageTabs();
                updateStickyButtons();
                updateStickyColumns();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º lastSavedState –ø–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω)
                if (!lastSavedState) {
                    const snapshot = createFullGanttSnapshot();
                    lastSavedState = JSON.parse(JSON.stringify(snapshot));
                    console.log('‚úÖ lastSavedState –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞');
                }
            } else {
                console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ú–∞—Å—Å–∏–≤ –∑–∞–¥–∞—á –ø—É—Å—Ç–æ–π –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏!');
                console.error('   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –≤—ã—à–µ.');
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω"
            updateBaselineToggleButton();
            loadCurrentUser();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–º–µ–Ω—ã –¥–µ–π—Å—Ç–≤–∏–π
            loadUndoHistory();
            
            // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ —Å—Ç–æ–ª–±–µ—Ü "‚Ññ –ø/–ø" —Å–æ–∑–¥–∞–Ω –≤ —à–∞–ø–∫–µ —Ç–∞–±–ª–∏—Ü—ã
            updateTableHeader();
            
            
            // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ–Ω—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            setTimeout(() => {
                const undoBtn = document.getElementById('undoBtn');
                if (undoBtn) {
                    undoBtn.style.display = 'inline-flex';
                    undoBtn.style.visibility = 'visible';
                    undoBtn.style.opacity = '1';
                    updateUndoButtonState();
                    console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ –∏ –ø–æ–∫–∞–∑–∞–Ω–∞');
                } else {
                    console.warn('‚ö†Ô∏è –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                }
            }, 100);
            
            // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const forceShowAuthButtons = () => {
                const userStr = localStorage.getItem('gantt-user');
                const ganttMode = localStorage.getItem('gantt-mode') || 'edit';
                const isViewMode = ganttMode === 'view';
                
                // –í —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                if (isViewMode) {
                    return;
                }
                
                if (userStr) {
                    const profileBtn = document.getElementById('profileBtn');
                    const companiesBottomBtn = document.getElementById('companiesBottomBtn');
                    const logoutBtn = document.getElementById('logoutBtn');
                    
                    console.log('üîç forceShowAuthButtons:', { 
                        profileBtn: !!profileBtn, 
                        companiesBottomBtn: !!companiesBottomBtn, 
                        logoutBtn: !!logoutBtn 
                    });
                    
                    if (profileBtn) {
                        profileBtn.style.display = 'flex';
                        profileBtn.style.visibility = 'visible';
                        profileBtn.style.opacity = '1';
                    }
                    if (companiesBottomBtn) {
                        companiesBottomBtn.style.display = 'flex';
                        companiesBottomBtn.style.visibility = 'visible';
                        companiesBottomBtn.style.opacity = '1';
                        console.log('‚úÖ –ù–∏–∂–Ω—è—è –∫–Ω–æ–ø–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ø–æ–∫–∞–∑–∞–Ω–∞!', {
                            display: companiesBottomBtn.style.display,
                            visibility: companiesBottomBtn.style.visibility,
                            opacity: companiesBottomBtn.style.opacity,
                            computedDisplay: window.getComputedStyle(companiesBottomBtn).display,
                            computedVisibility: window.getComputedStyle(companiesBottomBtn).visibility,
                            position: companiesBottomBtn.getBoundingClientRect()
                        });
                    } else {
                        console.error('‚ùå –ù–∏–∂–Ω—è—è –∫–Ω–æ–ø–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π –ù–ï –ù–ê–ô–î–ï–ù–ê –≤ DOM!');
                    }
                    if (logoutBtn) {
                        logoutBtn.style.display = 'flex';
                        logoutBtn.style.visibility = 'visible';
                        logoutBtn.style.opacity = '1';
                    }
                } else {
                    console.warn('‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (–Ω–µ—Ç gantt-user –≤ localStorage)');
                }
            };
            
            // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
            forceShowAuthButtons();
            setTimeout(forceShowAuthButtons, 100);
            setTimeout(forceShowAuthButtons, 500);
            setTimeout(forceShowAuthButtons, 1000);
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –∏ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            if (window.innerWidth <= 1024) {
                setTimeout(() => {
                    const companiesBottomBtn = document.getElementById('companiesBottomBtn');
                    if (companiesBottomBtn && localStorage.getItem('gantt-user')) {
                        companiesBottomBtn.style.display = 'flex';
                        companiesBottomBtn.style.visibility = 'visible';
                        companiesBottomBtn.style.opacity = '1';
                        console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–∞ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–∞/–º–æ–±–∏–ª—å–Ω–æ–≥–æ');
                    }
                }, 1500);
            }
            setTimeout(forceShowAuthButtons, 300);
            setTimeout(forceShowAuthButtons, 500);
            setTimeout(forceShowAuthButtons, 1000);
            setTimeout(forceShowAuthButtons, 2000);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è
            const profileBtn = document.getElementById('profileBtn');
            if (profileBtn) {
                profileBtn.addEventListener('click', openProfileModal);
            }
            
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', saveProfile);
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            initProfileModalDrag();

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            const profileModal = document.getElementById('profileModal');
            if (profileModal) {
                profileModal.addEventListener('click', function(e) {
                    if (e.target === profileModal && !isDragging) {
                        closeProfileModal();
                    }
                });
            }

            const chartContainer = document.querySelector('.chart-container');
            const tableSection = document.querySelector('.table-section');
            const stageButtons = document.querySelectorAll('.stage-tab-btn');
            const companyNameDisplay = document.getElementById('companyNameDisplay');
            const companyLogoInput = document.getElementById('companyLogoInput');
            const companyLogoWrapper = document.getElementById('companyLogoWrapper');

            if (companyNameDisplay) {
                // –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≥—Ä–∞—Ñ–∏–∫–∞
                // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—ã–±–æ—Ä–∞ –∫–æ–º–ø–∞–Ω–∏–π
                companyNameDisplay.contentEditable = 'false';
                companyNameDisplay.style.cursor = 'default';
            }

            // –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ—Ç–∏–ø–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≥—Ä–∞—Ñ–∏–∫–∞
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—ã–±–æ—Ä–∞ –∫–æ–º–ø–∞–Ω–∏–π
            if (companyLogoInput) {
                companyLogoInput.style.display = 'none';
            }
            
            if (companyLogoWrapper) {
                companyLogoWrapper.style.cursor = 'default';
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫–∏ —ç—Ç–∞–ø–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            renderStageTabs();

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è "–ì–∞–Ω—Ç / –¢–∞–±–ª–∏—Ü–∞" –∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏
            updateViewToggleUI();
            updateViewPanelsUI();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–∏—Å–∫
            initSearch();
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–°–±—Ä–æ—Å–∏—Ç—å –ø–ª–∞–Ω" –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            if (isViewMode) {
                const resetBtn = document.querySelector('.reset-plan-btn');
                if (resetBtn) {
                    resetBtn.classList.add('view-mode-disabled');
                }
            }

            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ/–æ—Ç–∂–∞—Ç–∏–µ –∫–ª–∞–≤–∏—à–∏ Z (–∏–ª–∏ —Ç–æ–π –∂–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫–ª–∞–≤–∏—à–∏ –≤ —Ä—É—Å—Å–∫–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–µ)
            window.addEventListener('keydown', (event) => {
                // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ Ctrl/Cmd –¥–ª—è –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞
                if (event.ctrlKey || event.metaKey) {
                    isCtrlPressed = true;
                }

                // –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–∏—Å–∫–∞ –ø–æ Ctrl+Enter –∏–ª–∏ Cmd+Enter
                if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                    const target = event.target;
                    // –ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º, –µ—Å–ª–∏ —Ñ–æ–∫—É—Å –≤ –∏–Ω–ø—É—Ç–µ/—Å–µ–ª–µ–∫—Ç–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ
                    if (
                        target instanceof HTMLInputElement ||
                        target instanceof HTMLTextAreaElement ||
                        target instanceof HTMLSelectElement ||
                        target.isContentEditable
                    ) {
                        return;
                    }
                    event.preventDefault();
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                    }
                    return;
                }
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º event.code, —á—Ç–æ–±—ã —Å–æ—á–µ—Ç–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–ª–æ –∏ –≤ —Ä—É—Å—Å–∫–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–µ (KeyZ = Z/–Ø)
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑—É–º–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –∑–∞–∂–∞—Ç Ctrl (Ctrl+Z –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–º–µ–Ω—ã)
                if (event.code === 'KeyZ' && !(event.ctrlKey || event.metaKey)) {
                    isZoomKeyPressed = true;
                }

                // –í—Å—Ç–∞–≤–∫–∞ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ –ø–æ–¥ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π –ø–æ –∫–ª–∞–≤–∏—à–µ Insert
                if (event.key === 'Insert') {
                    if (!canEdit()) {
                        return; // –ë–ª–æ–∫–∏—Ä—É–µ–º Insert –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    }
                    const target = event.target;
                    // –ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ, –µ—Å–ª–∏ —Ñ–æ–∫—É—Å –≤ –∏–Ω–ø—É—Ç–µ/—Å–µ–ª–µ–∫—Ç–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ
                    if (
                        target instanceof HTMLInputElement ||
                        target instanceof HTMLTextAreaElement ||
                        target instanceof HTMLSelectElement ||
                        target.isContentEditable
                    ) {
                        return;
                    }
                    event.preventDefault();
                    insertTaskBelowSelected();
                    return;
                }

                // –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏ –ø–æ –∫–ª–∞–≤–∏—à–µ Delete (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)
                if (event.key === 'Delete') {
                    if (!canEdit()) {
                        return; // –ë–ª–æ–∫–∏—Ä—É–µ–º Delete –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    }
                    const target = event.target;
                    if (
                        target instanceof HTMLInputElement ||
                        target instanceof HTMLTextAreaElement ||
                        target instanceof HTMLSelectElement ||
                        target.isContentEditable
                    ) {
                        return;
                    }
                    event.preventDefault();
                    openDeleteConfirm();
                    return;
                }

                // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –ø–æ Ctrl+C
                if ((event.ctrlKey || event.metaKey) && event.key === 'c') {
                    const target = event.target;
                    // –ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ, –µ—Å–ª–∏ —Ñ–æ–∫—É—Å –≤ –∏–Ω–ø—É—Ç–µ/textarea/select (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞)
                    if (
                        target instanceof HTMLInputElement ||
                        target instanceof HTMLTextAreaElement ||
                        target instanceof HTMLSelectElement ||
                        target.isContentEditable
                    ) {
                        return;
                    }
                    if (!canEdit()) {
                        return; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    }
                    const primaryTaskId = getPrimarySelectedTaskId();
                    if (primaryTaskId !== null) {
                        event.preventDefault();
                        copyTask(primaryTaskId);
                    }
                    return;
                }

                // –í—Å—Ç–∞–≤–∫–∞ –∑–∞–¥–∞—á–∏ –ø–æ Ctrl+V
                if ((event.ctrlKey || event.metaKey) && event.key === 'v') {
                    const target = event.target;
                    // –ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ, –µ—Å–ª–∏ —Ñ–æ–∫—É—Å –≤ –∏–Ω–ø—É—Ç–µ/textarea/select (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞)
                    if (
                        target instanceof HTMLInputElement ||
                        target instanceof HTMLTextAreaElement ||
                        target instanceof HTMLSelectElement ||
                        target.isContentEditable
                    ) {
                        return;
                    }
                    if (!canEdit()) {
                        return; // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å—Ç–∞–≤–∫—É –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    }
                    if (copiedTask !== null) {
                        event.preventDefault();
                        pasteTask();
                    }
                    return;
                }

                // –û—Ç–º–µ—Ç–∫–∞ –∑–∞–¥–∞—á–∏ –∫–∞–∫ "–Ω–∞ –≤—ã–µ–∑–¥–µ" –ø–æ Ctrl+Q
                if ((event.ctrlKey || event.metaKey) && (event.key === 'q' || event.key === 'Q' || event.keyCode === 81 || event.code === 'KeyQ')) {
                    const target = event.target;
                    // –ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ, –µ—Å–ª–∏ —Ñ–æ–∫—É—Å –≤ –∏–Ω–ø—É—Ç–µ/textarea/select
                    if (
                        target instanceof HTMLInputElement ||
                        target instanceof HTMLTextAreaElement ||
                        target instanceof HTMLSelectElement ||
                        target.isContentEditable
                    ) {
                        return;
                    }
                    if (!canEdit()) {
                        return; // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    }
                    event.preventDefault();
                    const primaryTaskId = getPrimarySelectedTaskId();
                    if (primaryTaskId !== null) {
                        toggleTaskTravelStatus(primaryTaskId);
                    } else {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–µ –≤—ã–¥–µ–ª–µ–Ω–∞
                        console.log('‚ö†Ô∏è –í—ã–¥–µ–ª–∏—Ç–µ –∑–∞–¥–∞—á—É –ø–µ—Ä–µ–¥ –Ω–∞–∂–∞—Ç–∏–µ–º Ctrl+Q');
                        showMobileNotification('–í—ã–¥–µ–ª–∏—Ç–µ –∑–∞–¥–∞—á—É –ø–µ—Ä–µ–¥ –Ω–∞–∂–∞—Ç–∏–µ–º Ctrl+Q');
                    }
                    return;
                }

                // –û—Ç–º–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ Ctrl+Z (–∞–Ω–≥–ª) –∏–ª–∏ Ctrl+–Ø (—Ä—É—Å)
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º event.code, —á—Ç–æ–±—ã —Å–æ—á–µ—Ç–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–ª–æ –∏ –≤ —Ä—É—Å—Å–∫–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–µ (KeyZ = Z/–Ø)
                if ((event.ctrlKey || event.metaKey) && event.code === 'KeyZ' && !event.shiftKey) {
                    const target = event.target;
                    // –ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ, –µ—Å–ª–∏ —Ñ–æ–∫—É—Å –≤ –∏–Ω–ø—É—Ç–µ/textarea/select (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—Ç–º–µ–Ω–∞ –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞)
                    if (
                        target instanceof HTMLInputElement ||
                        target instanceof HTMLTextAreaElement ||
                        target instanceof HTMLSelectElement ||
                        target.isContentEditable
                    ) {
                        return;
                    }
                    event.preventDefault();
                    undoLastAction();
                    return;
                }

                // –í–æ–∑–≤—Ä–∞—Ç –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ Ctrl+Shift+Z (–∞–Ω–≥–ª) –∏–ª–∏ Ctrl+Shift+–Ø (—Ä—É—Å)
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º event.code, —á—Ç–æ–±—ã —Å–æ—á–µ—Ç–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–ª–æ –∏ –≤ —Ä—É—Å—Å–∫–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–µ (KeyZ = Z/–Ø)
                if ((event.ctrlKey || event.metaKey) && event.code === 'KeyZ' && event.shiftKey) {
                    const target = event.target;
                    // –ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ, –µ—Å–ª–∏ —Ñ–æ–∫—É—Å –≤ –∏–Ω–ø—É—Ç–µ/textarea/select (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—Ç–º–µ–Ω–∞ –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞)
                    if (
                        target instanceof HTMLInputElement ||
                        target instanceof HTMLTextAreaElement ||
                        target instanceof HTMLSelectElement ||
                        target.isContentEditable
                    ) {
                        return;
                    }
                    event.preventDefault();
                    redoLastAction();
                    return;
                }

                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω–æ–≥–æ (baseline) –ø–ª–∞–Ω–∞ –ø–æ F2
                if (event.key === 'F2') {
                    const target = event.target;
                    if (
                        target instanceof HTMLInputElement ||
                        target instanceof HTMLTextAreaElement ||
                        target instanceof HTMLSelectElement ||
                        target.isContentEditable
                    ) {
                        return;
                    }
                    event.preventDefault();

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    if (!canEdit()) {
                        showBaselineToast('–í —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–µ–ª—å–∑—è –∑–∞–¥–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω. –ú–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ.');
                        return;
                    }

                    const newSnapshot = buildBaselineSnapshot();
                    const hasExistingBaseline =
                        baselineSnapshot &&
                        Array.isArray(baselineSnapshot.tasks) &&
                        baselineSnapshot.tasks.some(t => Array.isArray(t.baselineDates) && t.baselineDates.length > 0);

                    console.log('F2 pressed. hasExistingBaseline:', hasExistingBaseline, 'baselineSnapshot:', baselineSnapshot);

                    if (hasExistingBaseline) {
                        openBaselineConfirmModal(newSnapshot);
                    } else {
                        try {
                            baselineSnapshot = newSnapshot;
                            applyBaselineToTasks();
                            saveBaselineToServer(baselineSnapshot);
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —á—Ç–æ–±—ã baselineSnapshot –ø–æ–ø–∞–ª –≤ —Ñ–∞–π–ª
                            autoSaveGanttState();
                            console.log('Calling showBaselineToast for first time');
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É
                            showBaselineToast('–í—ã –∑–∞–¥–∞–ª–∏ –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω. –ù–∞–∂–º–∏—Ç–µ "–î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω" –∏–ª–∏ F3 –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
                            updateBaselineToggleButton();
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –±–∞–∑–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞:', error);
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                            showBaselineToast('–í—ã –∑–∞–¥–∞–ª–∏ –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω. –ù–∞–∂–º–∏—Ç–µ "–î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω" –∏–ª–∏ F3 –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
                            updateBaselineToggleButton();
                        }
                    }
                    return;
                }

                // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è baseline-–ø–æ–ª–æ—Å—ã –ø–æ F3
                if (event.key === 'F3') {
                    const target = event.target;
                    if (
                        target instanceof HTMLInputElement ||
                        target instanceof HTMLTextAreaElement ||
                        target instanceof HTMLSelectElement ||
                        target.isContentEditable
                    ) {
                        return;
                    }
                    event.preventDefault();

                    const hasBaseline =
                        baselineSnapshot &&
                        Array.isArray(baselineSnapshot.tasks) &&
                        baselineSnapshot.tasks.some(t => Array.isArray(t.baselineDates) && t.baselineDates.length > 0);

                    if (!hasBaseline) {
                        if (isViewMode) {
                            showBaselineToast('–î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω –Ω–µ –∑–∞–¥–∞–Ω. –í —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–ª–∞–Ω–∞.');
                        } else {
                            showBaselineToast('–ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω –Ω–µ –∑–∞–¥–∞–Ω. –ù–∞–∂–º–∏—Ç–µ F2, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –∫–∞–∫ –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π.');
                        }
                        return;
                    }

                    showBaseline = !showBaseline;
                    updateBaselineToggleButton();
                    renderGantt();
                    return;
                }

                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –º–∞—Å—à—Ç–∞–±–µ ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º Escape –∏ Enter
                const scaleWarningModal = document.getElementById('scaleWarningModal');
                if (scaleWarningModal && scaleWarningModal.style.display === 'block') {
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        cancelScaleWarning();
                        return;
                    }
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        confirmScaleWarning();
                        return;
                    }
                }
                
                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∫ —Å—Ç–∞—Ç—É—Å—É ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ Escape
                const statusCommentModal = document.getElementById('statusCommentModal');
                if (statusCommentModal && (statusCommentModal.style.display === 'flex' || statusCommentModal.style.display === 'block')) {
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        cancelStatusComment();
                        return;
                    }
                }

                // –ï—Å–ª–∏ —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ Escape
                const searchInput = document.getElementById('searchInput');
                if (searchInput && document.activeElement === searchInput) {
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        closeSearchModal();
                        searchInput.blur();
                        return;
                    }
                }

                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ Escape
                const profileModal = document.getElementById('profileModal');
                if (profileModal && profileModal.classList.contains('show')) {
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        closeProfileModal();
                        return;
                    }
                }

                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ
                if (isDeleteConfirmOpen) {
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        cancelDeleteTask();
                        return;
                    }
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        confirmDeleteTask();
                        return;
                    }
                }

                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–±—Ä–æ—Å–∞ –ø–ª–∞–Ω–∞ ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ
                const resetPlanModal = document.getElementById('resetPlanConfirmModal');
                if (resetPlanModal && resetPlanModal.style.display === 'block') {
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        cancelResetPlan();
                        return;
                    }
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        confirmResetPlan();
                        return;
                    }
                }

                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–º–µ–Ω—ã –¥–µ–π—Å—Ç–≤–∏—è ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ
                const undoConfirmModal = document.getElementById('undoConfirmModal');
                if (undoConfirmModal && undoConfirmModal.style.display === 'block') {
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        cancelUndo();
                        return;
                    }
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        confirmUndo();
                        return;
                    }
                }

                // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∑–∞–¥–∞—á–∞–º (ArrowUp / ArrowDown)
                if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                    const target = event.target;
                    if (
                        target instanceof HTMLInputElement ||
                        target instanceof HTMLTextAreaElement ||
                        target instanceof HTMLSelectElement ||
                        target.isContentEditable
                    ) {
                        return;
                    }

                    if (!tasks.length) return;

                    event.preventDefault();

                    // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–µ–Ω, –Ω–∞–≤–∏–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ø–æ–∏—Å–∫–∞
                    if (searchResults && searchResults.length > 0) {
                        let searchIndex = currentSearchIndex;
                        
                        if (searchIndex < 0) {
                            // –ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
                            const primaryId = getPrimarySelectedTaskId();
                            if (primaryId !== null) {
                                searchIndex = searchResults.findIndex(t => t.id === primaryId);
                            }
                            if (searchIndex < 0) {
                                // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞ –Ω–µ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö, –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–π/–ø–æ—Å–ª–µ–¥–Ω–µ–π
                                searchIndex = event.key === 'ArrowDown' ? 0 : searchResults.length - 1;
                            }
                        } else {
                            // –ù–∞–≤–∏–≥–∏—Ä—É–µ–º –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ø–æ–∏—Å–∫–∞
                            if (event.key === 'ArrowDown' && searchIndex < searchResults.length - 1) {
                                searchIndex += 1;
                            } else if (event.key === 'ArrowUp' && searchIndex > 0) {
                                searchIndex -= 1;
                            }
                        }

                        const newTask = searchResults[searchIndex];
                        if (!newTask) return;

                        currentSearchIndex = searchIndex;
                        
                        // –°—Ç—Ä–µ–ª–∫–∞–º–∏ –≤—Å–µ–≥–¥–∞ –≤—ã–±–∏—Ä–∞–µ–º –æ–¥–Ω—É –∑–∞–¥–∞—á—É (—Å–±—Ä–æ—Å –¥–∏–∞–ø–∞–∑–æ–Ω–∞)
                        selectTask(newTask.id, { range: false });
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞–¥–∞—á–∏
                        highlightSearchResults();

                        // –°–∫—Ä–æ–ª–ª–∏–º –ì–∞–Ω—Ç –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
                        const row = document.querySelector(`.gantt-row[data-task-id="${newTask.id}"]`);
                        if (row && row.scrollIntoView) {
                            row.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                        }
                        return;
                    }

                    // –û–±—ã—á–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤—Å–µ–º –∑–∞–¥–∞—á–∞–º (–∫–æ–≥–¥–∞ –ø–æ–∏—Å–∫ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω)
                    let currentIndex = -1;
                    const primaryId = getPrimarySelectedTaskId();
                    if (primaryId !== null) {
                        currentIndex = tasks.findIndex(t => t.id === primaryId);
                    }

                    if (currentIndex === -1) {
                        // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–π/–ø–æ—Å–ª–µ–¥–Ω–µ–π
                        currentIndex = event.key === 'ArrowDown' ? 0 : tasks.length - 1;
                    } else {
                        if (event.key === 'ArrowDown' && currentIndex < tasks.length - 1) {
                            currentIndex += 1;
                        } else if (event.key === 'ArrowUp' && currentIndex > 0) {
                            currentIndex -= 1;
                        }
                    }

                    const newTask = tasks[currentIndex];
                    if (!newTask) return;

                    // –°—Ç—Ä–µ–ª–∫–∞–º–∏ –≤—Å–µ–≥–¥–∞ –≤—ã–±–∏—Ä–∞–µ–º –æ–¥–Ω—É –∑–∞–¥–∞—á—É (—Å–±—Ä–æ—Å –¥–∏–∞–ø–∞–∑–æ–Ω–∞)
                    selectTask(newTask.id, { range: false });

                    // –°–∫—Ä–æ–ª–ª–∏–º –ì–∞–Ω—Ç –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
                    const row = document.querySelector(`.gantt-row[data-task-id="${newTask.id}"]`);
                    if (row && row.scrollIntoView) {
                        row.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    }
                    return;
                }
            });

            window.addEventListener('keyup', (event) => {
                // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ Ctrl/Cmd –¥–ª—è –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞
                if (!event.ctrlKey && !event.metaKey) {
                    isCtrlPressed = false;
                }
                
                if (event.code === 'KeyZ') {
                    isZoomKeyPressed = false;
                }
            });

            // –ö–æ–ª–µ—Å–æ –º—ã—à–∏ –Ω–∞–¥ –¥–∏–∞–≥—Ä–∞–º–º–æ–π: –ø—Ä–∏ –∑–∞–∂–∞—Ç–æ–π Z ‚Äî –∑—É–º, –ø—Ä–∏ Shift ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª, –∏–Ω–∞—á–µ –æ–±—ã—á–Ω—ã–π —Å–∫—Ä–æ–ª–ª
            const ganttChart = document.getElementById('ganttChart');
            if (ganttChart) {
                ganttChart.addEventListener('wheel', (event) => {
                    // –ï—Å–ª–∏ –∑–∞–∂–∞—Ç–∞ Z ‚Äî –∑—É–º
                    if (isZoomKeyPressed) {
                        event.preventDefault();
                        const direction = event.deltaY > 0 ? -1 : 1; // –≤–Ω–∏–∑ = –æ—Ç–¥–∞–ª–µ–Ω–∏–µ, –≤–≤–µ—Ä—Ö = –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ
                        const step = 0.1 * direction;
                        setZoom(zoomLevel + step);
                        return;
                    }
                    
                    // –ï—Å–ª–∏ –∑–∞–∂–∞—Ç Shift ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª
                    if (event.shiftKey) {
                        event.preventDefault();
                        ganttChart.scrollLeft += event.deltaY; // deltaY –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ –ø—Ä–∏ Shift
                        return;
                    }
                    
                    // –ò–Ω–∞—á–µ –æ–±—ã—á–Ω—ã–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º)
                }, { passive: false });
            }

            // Pinch-to-zoom –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ –ø–ª–∞–Ω—à–µ—Ç–æ–≤
            if (chartContainer) {
                let initialDistance = 0;
                let initialZoom = zoomLevel;
                let isPinching = false;
                let lastTouchTime = 0;
                let initialTouchElements = [null, null]; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                const touchThrottle = 8; // –£–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –±–æ–ª–µ–µ –æ—Ç–∑—ã–≤—á–∏–≤–æ–π —Ä–∞–±–æ—Ç—ã (~120fps)

                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ –∫–∞—Å–∞–Ω–∏—è
                // –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ª—é–±—ã—Ö —É–≥–ª–æ–≤ (–Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
                function getDistance(touch1, touch2) {
                    const dx = touch2.clientX - touch1.clientX;
                    const dy = touch2.clientY - touch1.clientY;
                    return Math.sqrt(dx * dx + dy * dy);
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ touch —Å–æ–±—ã—Ç–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –Ω–µ –Ω–∞ —è—á–µ–π–∫–µ –¥–Ω—è (–≥–¥–µ –ø—Ä–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è —Å—Ç–∞—Ç—É—Å—ã)
                function isNotOnDayCell(target) {
                    if (!target) return true;
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —è—á–µ–π–∫–æ–π –¥–Ω—è –∏–ª–∏ –µ—ë –¥–æ—á–µ—Ä–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º
                    const cell = target.closest('.gantt-cell');
                    return !cell; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º true, –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —è—á–µ–π–∫—É (–º–æ–∂–Ω–æ –∑—É–º–∏—Ç—å)
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –æ–±–∞ –∫–∞—Å–∞–Ω–∏—è –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤–Ω–µ —è—á–µ–µ–∫ –¥–Ω–µ–π
                function canZoom(event) {
                    if (event.touches.length !== 2) return false;
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ touchstart –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                    if (initialTouchElements[0] && initialTouchElements[1]) {
                        return isNotOnDayCell(initialTouchElements[0]) && isNotOnDayCell(initialTouchElements[1]);
                    }
                    
                    // Fallback: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–¥–ª—è touchmove)
                    const touch1 = event.touches[0];
                    const touch2 = event.touches[1];
                    
                    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ–¥ —Ç–æ—á–∫–∞–º–∏ –∫–∞—Å–∞–Ω–∏—è
                    const element1 = document.elementFromPoint(touch1.clientX, touch1.clientY);
                    const element2 = document.elementFromPoint(touch2.clientX, touch2.clientY);
                    
                    // –ó—É–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ, –µ—Å–ª–∏ –æ–±–∞ –∫–∞—Å–∞–Ω–∏—è –≤–Ω–µ —è—á–µ–µ–∫ –¥–Ω–µ–π
                    return isNotOnDayCell(element1) && isNotOnDayCell(element2);
                }

                chartContainer.addEventListener('touchstart', (event) => {
                    if (event.touches.length === 2) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                        const touch1 = event.touches[0];
                        const touch2 = event.touches[1];
                        initialTouchElements[0] = document.elementFromPoint(touch1.clientX, touch1.clientY);
                        initialTouchElements[1] = document.elementFromPoint(touch2.clientX, touch2.clientY);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±–∞ –∫–∞—Å–∞–Ω–∏—è –≤–Ω–µ —è—á–µ–µ–∫ –¥–Ω–µ–π
                        if (canZoom(event)) {
                            event.preventDefault();
                            isPinching = true;
                            initialDistance = getDistance(event.touches[0], event.touches[1]);
                            initialZoom = zoomLevel;
                            lastTouchTime = performance.now();
                        } else {
                            // –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∫–∞—Å–∞–Ω–∏–µ –Ω–∞ —è—á–µ–π–∫–µ –¥–Ω—è, –Ω–µ –Ω–∞—á–∏–Ω–∞–µ–º –∑—É–º
                            isPinching = false;
                            initialDistance = 0;
                            initialTouchElements = [null, null];
                        }
                    } else if (event.touches.length === 1) {
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –µ—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è –æ–¥–∏–Ω –ø–∞–ª–µ—Ü
                        isPinching = false;
                        initialDistance = 0;
                        initialTouchElements = [null, null];
                    }
                }, { passive: false });

                chartContainer.addEventListener('touchmove', (event) => {
                    if (event.touches.length === 2) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±–∞ –∫–∞—Å–∞–Ω–∏—è –≤—Å–µ –µ—â–µ –≤–Ω–µ —è—á–µ–µ–∫ –¥–Ω–µ–π
                        if (!canZoom(event)) {
                            // –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∫–∞—Å–∞–Ω–∏–µ –ø–æ–ø–∞–ª–æ –Ω–∞ —è—á–µ–π–∫—É –¥–Ω—è, –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º –∑—É–º
                            if (isPinching) {
                                isPinching = false;
                                initialDistance = 0;
                                initialTouchElements = [null, null];
                            }
                            return;
                        }
                        
                        event.preventDefault();
                        
                        const now = performance.now();
                        // Throttling –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–±–æ–ª–µ–µ —á–∞—Å—Ç—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
                        if (now - lastTouchTime < touchThrottle && isPinching && initialDistance > 0) {
                            return;
                        }
                        lastTouchTime = now;
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ø–∞–ª—å—Ü–∞–º–∏
                        const currentDistance = getDistance(event.touches[0], event.touches[1]);
                        
                        // –ï—Å–ª–∏ —ç—Ç–æ –Ω–∞—á–∞–ª–æ –∂–µ—Å—Ç–∞ –∏–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –±—ã–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
                        if (!isPinching || initialDistance === 0) {
                            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ª—é–±—ã—Ö —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π)
                            isPinching = true;
                            initialDistance = currentDistance;
                            initialZoom = zoomLevel;
                            return;
                        }
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º –º–∞—Å—à—Ç–∞–± –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
                        // –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ª—é–±—ã—Ö —É–≥–ª–æ–≤ –∏ –ª—é–±—ã—Ö —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π (–∫–æ—Ä–æ—Ç–∫–∏—Ö –∏ –¥–ª–∏–Ω–Ω—ã—Ö)
                        if (initialDistance > 0 && currentDistance > 0) {
                            const scale = currentDistance / initialDistance;
                            
                            // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é (–±–µ–∑ –∂–µ—Å—Ç–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)
                            // setZoom —É–∂–µ –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (0.4 - 2.0)
                            const newZoom = initialZoom * scale;
                            setZoom(newZoom);
                        }
                    } else if (event.touches.length === 1 && isPinching) {
                        // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è –æ–¥–∏–Ω –ø–∞–ª–µ—Ü –≤–æ –≤—Ä–µ–º—è –∂–µ—Å—Ç–∞, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
                        isPinching = false;
                        initialDistance = 0;
                        initialTouchElements = [null, null];
                    }
                }, { passive: false });

                chartContainer.addEventListener('touchend', (event) => {
                    if (event.touches.length < 2) {
                        isPinching = false;
                        initialDistance = 0;
                        initialTouchElements = [null, null];
                    }
                }, { passive: false });

                chartContainer.addEventListener('touchcancel', (event) => {
                    isPinching = false;
                    initialDistance = 0;
                    initialTouchElements = [null, null];
                }, { passive: false });
            }
        });

        // ========== –°–ò–°–¢–ï–ú–ê –ü–û–î–°–ö–ê–ó–û–ö –î–õ–Ø –ù–û–í–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ==========
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function isFirstLogin() {
            const userStr = localStorage.getItem('gantt-user');
            if (!userStr) {
                console.log('üîç isFirstLogin: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                return false;
            }
            
            try {
                const user = JSON.parse(userStr);
                const login = user.login || user.Login;
                if (!login) {
                    console.log('üîç isFirstLogin: –õ–æ–≥–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    return false;
                }
                
                const firstLoginKey = `firstLogin-${login}`;
                const hasLoggedIn = localStorage.getItem(firstLoginKey);
                
                console.log('üîç isFirstLogin:', { login, firstLoginKey, hasLoggedIn });
                
                if (!hasLoggedIn) {
                    // –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ö–æ–¥–∏–ª
                    localStorage.setItem(firstLoginKey, 'true');
                    console.log('‚úÖ isFirstLogin: –ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', login);
                    return true;
                }
                
                console.log('‚ÑπÔ∏è isFirstLogin: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', login, '—É–∂–µ –∑–∞—Ö–æ–¥–∏–ª —Ä–∞–Ω–µ–µ');
                return false;
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞:', e);
                return false;
            }
        }

        // –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ç—É—Ä–∞
        const tourSteps = [
            {
                element: 'header',
                title: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!',
                text: '–≠—Ç–æ –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è DeadLinePro. –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–¥–∞—á–∞–º–∏, –¥–∞—Ç–∞–º–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –ø—Ä–æ–µ–∫—Ç–∞.',
                position: 'bottom'
            },
            {
                element: '.stats',
                title: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞',
                text: '–í —ç—Ç–æ–º –±–ª–æ–∫–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç—Ç–∞–ø–æ–≤, –∑–∞–¥–∞—á, —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –∏ –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞.',
                position: 'bottom'
            },
            {
                element: '.controls',
                title: '–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è',
                text: '–ó–¥–µ—Å—å –Ω–∞—Ö–æ–¥—è—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è: —Å–±—Ä–æ—Å –ø–ª–∞–Ω–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∞, —ç–∫—Å–ø–æ—Ä—Ç –≤ PDF –∏ Excel. –ö–Ω–æ–ø–∫–∞ "–°–±—Ä–æ—Å–∏—Ç—å –ø–ª–∞–Ω" –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞—Ç—ã, —Å—Ç–∞—Ç—É—Å—ã –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–æ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.',
                position: 'bottom'
            },
            {
                element: '.reset-plan-btn',
                title: '–°–±—Ä–æ—Å –ø–ª–∞–Ω–∞',
                text: '–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞—Ç—ã, —Å—Ç–∞—Ç—É—Å—ã –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–æ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ø–æ—è–≤–∏—Ç—Å—è –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞.',
                position: 'bottom'
            },
            {
                element: '#helpBtn',
                title: '–°–ø—Ä–∞–≤–∫–∞',
                text: '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç—Ç—É –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –≥–æ—Ä—è—á–∏–º –∫–ª–∞–≤–∏—à–∞–º –∏ —Ñ—É–Ω–∫—Ü–∏—è–º —Å–∏—Å—Ç–µ–º—ã.',
                position: 'left'
            },
            {
                element: '#profileBtn',
                title: '–ü—Ä–æ—Ñ–∏–ª—å',
                text: '–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å: –∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.',
                position: 'left'
            },
            {
                element: '#logoutBtn',
                title: '–í—ã—Ö–æ–¥',
                text: '–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.',
                position: 'left'
            },
            {
                element: '#companiesBottomBtn',
                title: '–ö–æ–º–ø–∞–Ω–∏–∏',
                text: '–í–æ–∑–≤—Ä–∞—Ç –∫ —Å–ø–∏—Å–∫—É –∫–æ–º–ø–∞–Ω–∏–π.',
                position: 'bottom',
                temporaryShow: true
            },
            {
                element: '.gantt-chart',
                title: '–î–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞',
                text: '–û—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å. –ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≥—Ä–∞—Ñ–∏–∫ –∑–∞–¥–∞—á —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç, —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ —Å–≤—è–∑–µ–π –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏. –î–ª—è –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è/–æ—Ç–¥–∞–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª–∞–≤–∏—à—É Z + –∫–æ–ª–µ—Å–æ –º—ã—à–∏ –Ω–∞–¥ –¥–∏–∞–≥—Ä–∞–º–º–æ–π.',
                position: 'top'
            },
            {
                element: '.stage-settings-btn',
                title: '–†–µ–¥–∞–∫—Ü–∏—è —ç—Ç–∞–ø–æ–≤',
                text: '–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–∞–ø–æ–≤. –í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è —ç—Ç–∞–ø–æ–≤, –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å —ç—Ç–∞–ø—ã, –∏–∑–º–µ–Ω–∏—Ç—å –∏—Ö –ø–æ—Ä—è–¥–æ–∫.',
                position: 'bottom'
            },
            {
                element: '.gantt-stage-label',
                title: '–°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–æ–≤',
                text: '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –º–µ—Ç–∫—É —ç—Ç–∞–ø–∞ —Å–ª–µ–≤–∞ –æ—Ç –¥–∏–∞–≥—Ä–∞–º–º—ã, —á—Ç–æ–±—ã —Å–≤–µ—Ä–Ω—É—Ç—å –∏–ª–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞. –°–≤–µ—Ä–Ω—É—Ç—ã–π —ç—Ç–∞–ø –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π —Å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.',
                position: 'right',
                selector: 'first'
            },
            {
                element: '.link-toggle-btn',
                title: '–°—Ç–æ–ª–±–µ—Ü "–°–≤—è–∑—å"',
                text: '–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç/—Å–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç–æ–ª–±–µ—Ü "–°–≤—è–∑—å". –í —Å—Ç–æ–ª–±—Ü–µ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø —Å–≤—è–∑–∏ –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏: –û_–ù (–æ–∫–æ–Ω—á–∞–Ω–∏–µ-–Ω–∞—á–∞–ª–æ), –ù_–ù (–Ω–∞—á–∞–ª–æ-–Ω–∞—á–∞–ª–æ), –û_–û (–æ–∫–æ–Ω—á–∞–Ω–∏–µ-–æ–∫–æ–Ω—á–∞–Ω–∏–µ). –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–≤—è–∑–∏ –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è.',
                position: 'bottom'
            },
            {
                element: '.responsible-toggle-btn',
                title: '–°—Ç–æ–ª–±–µ—Ü "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π"',
                text: '–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç/—Å–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç–æ–ª–±–µ—Ü "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π". –í —ç—Ç–æ–º —Å—Ç–æ–ª–±—Ü–µ –º–æ–∂–Ω–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏.',
                position: 'bottom'
            },
            {
                element: '.baseline-toggle-btn',
                title: '–î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω',
                text: '–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω (F2) –∏ —Å–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω (F3). –ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º.',
                position: 'bottom'
            }
        ];

        let currentTourStep = 0;
        let tourActive = false;

        // –ó–∞–ø—É—Å–∫ —Ç—É—Ä–∞
        function startTour() {
            if (tourActive) return;
            
            tourActive = true;
            currentTourStep = 0;
            showTourStep(0);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —à–∞–≥ —Ç—É—Ä–∞
        function showTourStep(stepIndex) {
            if (stepIndex >= tourSteps.length) {
                endTour();
                return;
            }

            const step = tourSteps[stepIndex];
            let element;
            
            // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω —Å–µ–ª–µ–∫—Ç–æ—Ä 'first', –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
            if (step.selector === 'first') {
                const elements = document.querySelectorAll(step.element);
                element = elements.length > 0 ? elements[0] : null;
            } else {
                element = document.querySelector(step.element);
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –æ–Ω —Å–∫—Ä—ã—Ç)
            let originalDisplay = null;
            let wasHidden = false;
            
            if (!element) {
                // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —à–∞–≥
                setTimeout(() => showTourStep(stepIndex + 1), 500);
                return;
            }

            // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å–∫—Ä—ã—Ç –∏ –Ω—É–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å
            if (step.temporaryShow) {
                const computedStyle = window.getComputedStyle(element);
                if (computedStyle.display === 'none') {
                    originalDisplay = 'none';
                    wasHidden = true;
                    element.style.display = 'flex'; // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
                    console.log('‚úÖ –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–∞ —Å–∫—Ä—ã—Ç–∞—è –∫–Ω–æ–ø–∫–∞:', step.element);
                }
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º overlay
            const overlay = document.getElementById('tourOverlay');
            if (!overlay) {
                console.error('‚ùå Overlay –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                setTimeout(() => showTourStep(stepIndex + 1), 500);
                return;
            }
            overlay.classList.add('active');

            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
            const rect = element.getBoundingClientRect();
            if (rect.width === 0 || rect.height === 0) {
                console.warn('‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç –∏–º–µ–µ—Ç –Ω—É–ª–µ–≤–æ–π —Ä–∞–∑–º–µ—Ä:', step.element);
            }
            
            const highlight = document.createElement('div');
            highlight.className = 'tour-highlight';
            highlight.style.position = 'fixed';
            highlight.style.left = rect.left + 'px';
            highlight.style.top = rect.top + 'px';
            highlight.style.width = Math.max(rect.width, 40) + 'px';
            highlight.style.height = Math.max(rect.height, 40) + 'px';
            highlight.style.pointerEvents = 'none';
            highlight.style.zIndex = '10001';
            document.body.appendChild(highlight);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
            const tooltip = document.createElement('div');
            tooltip.className = 'tour-tooltip';
            tooltip.style.zIndex = '10002';
            tooltip.innerHTML = `
                <h3>${step.title}</h3>
                <p>${step.text}</p>
                <div class="tour-progress">–®–∞–≥ ${stepIndex + 1} –∏–∑ ${tourSteps.length}</div>
                <div class="tour-buttons">
                    <button class="tour-btn-skip" onclick="endTour()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
                    ${stepIndex < tourSteps.length - 1 
                        ? `<button class="tour-btn-next" onclick="nextTourStep()">–î–∞–ª–µ–µ</button>`
                        : `<button class="tour-btn-finish" onclick="endTour()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>`
                    }
                </div>
            `;
            document.body.appendChild(tooltip);

            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
            positionTooltip(tooltip, rect, step.position);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
            window.currentTourHighlight = highlight;
            window.currentTourTooltip = tooltip;
            window.currentTourElement = element;
            window.currentTourOriginalDisplay = originalDisplay;
            window.currentTourWasHidden = wasHidden;
        }

        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        function positionTooltip(tooltip, rect, position) {
            const tooltipRect = tooltip.getBoundingClientRect();
            const padding = 20;
            let left, top;

            switch (position) {
                case 'top':
                    left = rect.left + (rect.width - tooltipRect.width) / 2;
                    top = rect.top - tooltipRect.height - padding;
                    break;
                case 'bottom':
                    left = rect.left + (rect.width - tooltipRect.width) / 2;
                    top = rect.bottom + padding;
                    break;
                case 'left':
                    left = rect.left - tooltipRect.width - padding;
                    top = rect.top + (rect.height - tooltipRect.height) / 2;
                    break;
                case 'right':
                    left = rect.right + padding;
                    top = rect.top + (rect.height - tooltipRect.height) / 2;
                    break;
                default:
                    left = rect.left + (rect.width - tooltipRect.width) / 2;
                    top = rect.bottom + padding;
            }

            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞, –µ—Å–ª–∏ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            if (left < padding) left = padding;
            if (left + tooltipRect.width > viewportWidth - padding) {
                left = viewportWidth - tooltipRect.width - padding;
            }
            if (top < padding) top = padding;
            if (top + tooltipRect.height > viewportHeight - padding) {
                top = viewportHeight - tooltipRect.height - padding;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        // –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ —Ç—É—Ä–∞
        function nextTourStep() {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∑–∞–Ω
            if (window.currentTourWasHidden && window.currentTourElement && window.currentTourOriginalDisplay !== null) {
                window.currentTourElement.style.display = window.currentTourOriginalDisplay;
                console.log('‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏');
            }
            
            if (window.currentTourHighlight) {
                window.currentTourHighlight.remove();
            }
            if (window.currentTourTooltip) {
                window.currentTourTooltip.remove();
            }
            
            // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            window.currentTourElement = null;
            window.currentTourOriginalDisplay = null;
            window.currentTourWasHidden = false;
            
            currentTourStep++;
            showTourStep(currentTourStep);
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç—É—Ä–∞
        function endTour() {
            tourActive = false;
            const overlay = document.getElementById('tourOverlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∑–∞–Ω
            if (window.currentTourWasHidden && window.currentTourElement && window.currentTourOriginalDisplay !== null) {
                window.currentTourElement.style.display = window.currentTourOriginalDisplay;
                console.log('‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ç—É—Ä–∞');
            }
            
            if (window.currentTourHighlight) {
                window.currentTourHighlight.remove();
            }
            if (window.currentTourTooltip) {
                window.currentTourTooltip.remove();
            }
            
            // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            window.currentTourElement = null;
            window.currentTourOriginalDisplay = null;
            window.currentTourWasHidden = false;
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        function openWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –æ—Ç–∫—Ä—ã—Ç–æ (display: flex)');
            } else {
                console.error('‚ùå –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ welcomeModal –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ DOM!');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        function closeWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // –ó–∞–ø—É—Å–∫ —Ç—É—Ä–∞ –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        function startTourFromWelcome() {
            closeWelcomeModal();
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ –ø–µ—Ä–≤–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏
            requestAnimationFrame(() => {
                startTour();
            });
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–ø—Ä–∞–≤–∫–∏
        function openHelpModal() {
            const modal = document.getElementById('helpModal');
            modal.classList.add('active');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –±–µ–π–¥–∂ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è
            const badge = document.getElementById('helpBadge');
            if (badge) {
                badge.style.display = 'none';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–ø—Ä–∞–≤–∫–∏
        function closeHelpModal() {
            const modal = document.getElementById('helpModal');
            modal.classList.remove('active');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
        function showFeatureTooltip(element, text, position = 'top') {
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å
            const existingTooltip = document.querySelector('.feature-tooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }

            const tooltip = document.createElement('div');
            tooltip.className = 'feature-tooltip';
            tooltip.textContent = text;
            document.body.appendChild(tooltip);

            const rect = element.getBoundingClientRect();
            let left, top;

            switch (position) {
                case 'top':
                    left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2);
                    top = rect.top - tooltip.offsetHeight - 10;
                    break;
                case 'bottom':
                    left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2);
                    top = rect.bottom + 10;
                    break;
                case 'left':
                    left = rect.left - tooltip.offsetWidth - 10;
                    top = rect.top + (rect.height / 2) - (tooltip.offsetHeight / 2);
                    break;
                case 'right':
                    left = rect.right + 10;
                    top = rect.top + (rect.height / 2) - (tooltip.offsetHeight / 2);
                    break;
                default:
                    left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2);
                    top = rect.top - tooltip.offsetHeight - 10;
            }

            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–∏
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            if (left < 10) left = 10;
            if (left + tooltip.offsetWidth > viewportWidth - 10) {
                left = viewportWidth - tooltip.offsetWidth - 10;
            }
            if (top < 10) top = 10;
            if (top + tooltip.offsetHeight > viewportHeight - 10) {
                top = viewportHeight - tooltip.offsetHeight - 10;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';

            // –£–¥–∞–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –∏–ª–∏ –ø—Ä–∏ —É—Ö–æ–¥–µ –º—ã—à–∏
            const removeTooltip = () => {
                if (tooltip.parentNode) {
                    tooltip.remove();
                }
            };

            setTimeout(removeTooltip, 5000);
            element.addEventListener('mouseleave', removeTooltip, { once: true });
        }

        // –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –∫ —ç–ª–µ–º–µ–Ω—Ç—É
        function addNewFeatureBadge(element) {
            if (!element) return;
            
            const badge = document.createElement('span');
            badge.className = 'new-feature-badge';
            badge.textContent = '!';
            badge.title = '–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è';
            // –ù–µ –∏–∑–º–µ–Ω—è–µ–º position –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å –∞–±—Å–æ–ª—é—Ç–Ω—ã–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            // element.style.position = 'relative';
            // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –∏–º–µ–µ—Ç position –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–π–¥–∂–∞
            const computedPosition = window.getComputedStyle(element).position;
            if (computedPosition === 'static') {
                element.style.position = 'relative';
            }
            element.appendChild(badge);

            // –£–¥–∞–ª—è–µ–º –±–µ–π–¥–∂ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ
            const removeBadge = () => {
                badge.remove();
                element.removeEventListener('click', removeBadge);
            };
            element.addEventListener('click', removeBadge, { once: true });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥—Å–∫–∞–∑–æ–∫
        function initUserHelpSystem() {
            console.log('üöÄ initUserHelpSystem: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥—Å–∫–∞–∑–æ–∫');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–π –≤—Ö–æ–¥
            const isFirst = isFirstLogin();
            console.log('üîç initUserHelpSystem: isFirst =', isFirst);
            
            if (isFirst) {
                console.log('‚úÖ initUserHelpSystem: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞ –∫–Ω–æ–ø–∫–µ —Å–ø—Ä–∞–≤–∫–∏
                const badge = document.getElementById('helpBadge');
                if (badge) {
                    badge.style.display = 'flex';
                    console.log('‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞ –∫–Ω–æ–ø–∫–µ —Å–ø—Ä–∞–≤–∫–∏ –ø–æ–∫–∞–∑–∞–Ω');
                } else {
                    console.warn('‚ö†Ô∏è –ö–Ω–æ–ø–∫–∞ helpBadge –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                setTimeout(() => {
                    console.log('üì¢ –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è');
                    const modal = document.getElementById('welcomeModal');
                    if (modal) {
                        openWelcomeModal();
                        console.log('‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –æ—Ç–∫—Ä—ã—Ç–æ');
                    } else {
                        console.error('‚ùå –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ welcomeModal –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!');
                    }
                }, 1000);
            } else {
                console.log('‚ÑπÔ∏è initUserHelpSystem: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ö–æ–¥–∏–ª —Ä–∞–Ω–µ–µ, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º');
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∫–∏
            const helpBtn = document.getElementById('helpBtn');
            if (helpBtn) {
                helpBtn.addEventListener('click', openHelpModal);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
                if (isFirst) {
                    setTimeout(() => {
                        const showTooltip = () => {
                            showFeatureTooltip(helpBtn, '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –≥–æ—Ä—è—á–∏–º –∫–ª–∞–≤–∏—à–∞–º', 'left');
                            helpBtn.removeEventListener('mouseenter', showTooltip);
                        };
                        helpBtn.addEventListener('mouseenter', showTooltip, { once: true });
                    }, 2000);
                }
            }

            const helpModalClose = document.getElementById('helpModalClose');
            if (helpModalClose) {
                helpModalClose.addEventListener('click', closeHelpModal);
            }

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const helpModal = document.getElementById('helpModal');
            if (helpModal) {
                helpModal.addEventListener('click', (e) => {
                    if (e.target === helpModal) {
                        closeHelpModal();
                    }
                });
            }

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (helpModal && helpModal.classList.contains('active')) {
                        closeHelpModal();
                    }
                    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
                    const welcomeModal = document.getElementById('welcomeModal');
                    if (welcomeModal && welcomeModal.style.display === 'flex') {
                        closeWelcomeModal();
                    }
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
            const welcomeModal = document.getElementById('welcomeModal');
            if (welcomeModal) {
                welcomeModal.addEventListener('click', (e) => {
                    if (e.target === welcomeModal) {
                        closeWelcomeModal();
                    }
                });
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞
            if (isFirst) {
                setTimeout(() => {
                    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞ –∫–Ω–æ–ø–∫–µ –ø—Ä–æ—Ñ–∏–ª—è
                    const profileBtn = document.getElementById('profileBtn');
                    if (profileBtn && profileBtn.style.display !== 'none') {
                        addNewFeatureBadge(profileBtn);
                    }

                    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞ –∫–Ω–æ–ø–∫–µ –∫–æ–º–ø–∞–Ω–∏–π
                    const companiesBtn = document.getElementById('companiesBottomBtn');
                    if (companiesBtn && companiesBtn.style.display !== 'none') {
                        addNewFeatureBadge(companiesBtn);
                    }
                }, 3000);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ñ–ª–∞–≥–∞ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        // –ú–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∏–∑ –∫–æ–Ω—Å–æ–ª–∏: resetFirstLogin()
        function resetFirstLogin() {
            const userStr = localStorage.getItem('gantt-user');
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    const login = user.login || user.Login;
                    if (login) {
                        const firstLoginKey = `firstLogin-${login}`;
                        localStorage.removeItem(firstLoginKey);
                        console.log('‚úÖ –§–ª–∞–≥ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞ —Å–±—Ä–æ—à–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', login);
                        console.log('üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ');
                        return true;
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–ª–∞–≥–∞ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞:', e);
                }
            } else {
                console.warn('‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
            }
            return false;
        }
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏
        window.resetFirstLogin = resetFirstLogin;

        // –í—ã–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function initPage() {
            loadCurrentUser();
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É –ø–æ–¥—Å–∫–∞–∑–æ–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const userStr = localStorage.getItem('gantt-user');
            const ganttMode = localStorage.getItem('gantt-mode') || 'edit';
            if (userStr && ganttMode !== 'view') {
                console.log('üöÄ initPage: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥—Å–∫–∞–∑–æ–∫');
                initUserHelpSystem();
            } else {
                console.log('‚ÑπÔ∏è initPage: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏–ª–∏ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(initPage, 500);
            });
        } else {
            setTimeout(initPage, 500);
        }
    </script>
    
    <!-- Overlay –¥–ª—è —Ç—É—Ä–æ–≤ -->
    <div class="tour-overlay" id="tourOverlay"></div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–ø—Ä–∞–≤–∫–∏ -->
    <div class="help-modal" id="helpModal">
        <div class="help-modal-content">
            <div class="help-modal-header">
                <h2>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –≥–æ—Ä—è—á–∏–º –∫–ª–∞–≤–∏—à–∞–º</h2>
                <button class="help-modal-close" id="helpModalClose">&times;</button>
            </div>
            <div class="help-section">
                <h3>–û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
                <ul>
                    <li><span class="help-key">Insert</span> ‚Äî –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –ø–æ–¥ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π</li>
                    <li><span class="help-key">Delete</span> ‚Äî –£–¥–∞–ª–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É</li>
                    <li><span class="help-key">‚Üë</span> / <span class="help-key">‚Üì</span> ‚Äî –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∑–∞–¥–∞—á–∞–º</li>
                    <li><span class="help-key">Shift</span> + <span class="help-key">–ö–ª–∏–∫</span> ‚Äî –í—ã–¥–µ–ª–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á (–¥–∏–∞–ø–∞–∑–æ–Ω –æ—Ç –ø–µ—Ä–≤–æ–π –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏)</li>
                    <li><span class="help-key">Ctrl</span> + <span class="help-key">C</span> ‚Äî –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</li>
                    <li><span class="help-key">Ctrl</span> + <span class="help-key">V</span> ‚Äî –í—Å—Ç–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –ø–æ—Å–ª–µ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π</li>
                    <li><span class="help-key">Ctrl</span> + <span class="help-key">Q</span> ‚Äî –û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∫ "–Ω–∞ –≤—ã–µ–∑–¥–µ" (–∑–Ω–∞—á–æ–∫ —Å–∞–º–æ–ª–µ—Ç–∏–∫–∞)</li>
                    <li><span class="help-key">F2</span> ‚Äî –ó–∞–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω</li>
                    <li><span class="help-key">F3</span> ‚Äî –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞</li>
                </ul>
            </div>
            <div class="help-section">
                <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º–æ–π</h3>
                <ul>
                    <li><span class="help-key">Z</span> + <span class="help-key">–ö–æ–ª–µ—Å–æ –º—ã—à–∏</span> ‚Äî –ó—É–º (–ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ/–æ—Ç–¥–∞–ª–µ–Ω–∏–µ)</li>
                    <li><span class="help-key">Shift</span> + <span class="help-key">–ö–æ–ª–µ—Å–æ –º—ã—à–∏</span> ‚Äî –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª</li>
                    <li><span class="help-key">–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫</span> ‚Äî –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏</li>
                </ul>
            </div>
            <div class="help-section">
                <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                <ul>
                    <li><span class="help-key">Ctrl</span> + <span class="help-key">Z</span> ‚Äî –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ (–¥–æ 10 –¥–µ–π—Å—Ç–≤–∏–π)</li>
                    <li><span class="help-key">Ctrl</span> + <span class="help-key">Shift</span> + <span class="help-key">Z</span> ‚Äî –í–µ—Ä–Ω—É—Ç—å –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ</li>
                    <li><span class="help-key">Enter</span> ‚Äî –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–æ–ª–µ</li>
                    <li><span class="help-key">Escape</span> ‚Äî –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ / –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ</li>
                </ul>
            </div>
            <div class="help-section">
                <h3>–ü–æ–∏—Å–∫ –ø–æ –∑–∞–¥–∞—á–∞–º</h3>
                <ul>
                    <li><span class="help-key">Ctrl</span> + <span class="help-key">Enter</span> ‚Äî –û—Ç–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫ –ø–æ –∑–∞–¥–∞—á–∞–º (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ–∫—É—Å –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞)</li>
                    <li><span class="help-key">Enter</span> / <span class="help-key">Shift</span> + <span class="help-key">Enter</span> ‚Äî –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ø–æ–∏—Å–∫–∞</li>
                    <li><span class="help-key">Esc</span> ‚Äî –ó–∞–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫</li>
                </ul>
            </div>
            <div class="help-section">
                <h3>–≠–∫—Å–ø–æ—Ä—Ç</h3>
                <ul>
                    <li>–ö–Ω–æ–ø–∫–∞ <strong>"–í—ã–≥—Ä—É–∑–∏—Ç—å –≤ PDF"</strong> ‚Äî –≠–∫—Å–ø–æ—Ä—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –≤ PDF</li>
                    <li>–ö–Ω–æ–ø–∫–∞ <strong>"–í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel"</strong> ‚Äî –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel/CSV</li>
                </ul>
            </div>
        </div>
    </div>
    <footer class="footer">
        <p>&copy; 2025 SetlTech. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
    </footer>
</body>
</html>

