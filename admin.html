<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <!-- Open Graph –º–µ—Ç–∞—Ç–µ–≥–∏ –¥–ª—è –ø—Ä–µ–≤—å—é —Å—Å—ã–ª–æ–∫ -->
    <meta property="og:title" content="–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –ì—Ä–∞—Ñ–∏–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è ICONA">
    <meta property="og:description" content="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è ICONA">
    <meta property="og:image" content="logo.png">
    <meta property="og:type" content="website">
    <meta property="og:url" content="">
    <!-- xlsx.min.js –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel -->
    <script src="xlsx.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 50%, #2196f3 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω —Å –≤–æ–ª–Ω–∞–º–∏ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(100, 181, 246, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(66, 165, 245, 0.3) 0%, transparent 50%);
            animation: waveMove 20s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }

        @keyframes waveMove {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.1); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(100, 181, 246, 0.3);
            position: relative;
            overflow: hidden;
        }

        /* –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ */
        .logout-admin-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(100, 181, 246, 0.1);
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 8px 16px;
            color: #2196f3;
            font-size: 0.85rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 10;
        }

        .logout-admin-btn:hover {
            background: rgba(100, 181, 246, 0.2);
            border-color: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(100, 181, 246, 0.1) 0%, transparent 70%);
            animation: rotate  20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
            border-radius: 15px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
            position: relative;
        }

        .header-icon::before {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid white;
            border-radius: 8px;
            transform: rotate(45deg);
        }

        .header-icon::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 2px;
            top: 8px;
            left: 8px;
        }

        .header h1 {
            color: #1565c0;
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #64b5f6;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .admin-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .panel-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 10px 40px rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(100, 181, 246, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .panel-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(33, 150, 243, 0.3);
        }

        .panel-section h2 {
            color: #1565c0;
            font-size: 1.6rem;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #42a5f5;
            position: relative;
            font-weight: 700;
        }

        .panel-section h2::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #42a5f5, #2196f3);
            border-radius: 3px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            color: #1565c0;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.95rem;
            position: relative;
            padding-left: 20px;
        }

        .form-group label::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            color: #42a5f5;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(100, 181, 246, 0.3);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            color: #1565c0;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #42a5f5;
            box-shadow: 0 0 0 4px rgba(66, 165, 245, 0.15);
            background: white;
        }

        .form-group input::placeholder {
            color: #90caf9;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(239, 83, 80, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 83, 80, 0.4);
        }

        /* –ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è —Å–∫–µ–ª–µ—Ç–æ–Ω–æ–≤ –≤ —Å—Ç–∏–ª–µ Windows */
        .skeleton-row {
            position: relative;
        }

        #skeletonTable {
            border-collapse: separate;
            border-spacing: 0;
        }

        .skeleton-row {
            position: relative;
        }

        .skeleton-row td:last-child {
            position: relative;
            padding: 0 !important;
            width: 30px;
        }

        .skeleton-delete-btn {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 0;
            background: transparent;
            color: #666;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 300;
            transition: all 0.15s ease;
            position: absolute;
            top: 4px;
            right: 4px;
            padding: 0;
            margin: 0;
            z-index: 100;
        }

        .skeleton-delete-btn:hover {
            background: #e81123;
            color: white;
        }

        .skeleton-delete-btn:active {
            background: #c50e1f;
        }

        .skeleton-delete-btn-icon {
            position: relative;
            z-index: 1;
            line-height: 1;
            font-family: 'Segoe UI', 'Segoe UI Symbol', Arial, sans-serif;
            font-weight: 300;
        }

        /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ —Å—Ç—Ä–æ–∫—É */
        .skeleton-row .skeleton-delete-btn {
            opacity: 0.3;
            transition: opacity 0.2s ease;
        }

        .skeleton-row:hover .skeleton-delete-btn {
            opacity: 1;
        }

        /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –≤ —Å—Ç–∏–ª–µ Windows */
        .skeleton-type-delete-btn {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 4px;
            background: transparent;
            color: #666;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 300;
            transition: all 0.15s ease;
            padding: 0;
            margin: 0;
            flex-shrink: 0;
            align-self: flex-start;
            margin-top: -12px;
        }

        .skeleton-type-delete-btn:hover {
            background: #e81123;
            color: white;
            border-radius: 4px;
        }

        .skeleton-type-delete-btn:active {
            background: #c50e1f;
            border-radius: 4px;
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞ */
        .skeleton-type-delete-btn[data-tooltip] {
            position: relative;
        }

        .skeleton-type-delete-btn[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translate(-50%, 0);
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: bottom center;
            z-index: 9999;
            margin-bottom: 5px;
        }

        .skeleton-type-delete-btn[data-tooltip]:hover::after {
            opacity: 1;
            transform: translate(-50%, -6px);
            transition-delay: 1s;
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏—è–º–∏" */
        .logout-admin-btn[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translate(-50%, 0);
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: top center;
            z-index: 9999;
            margin-top: 5px;
        }

        .logout-admin-btn[data-tooltip]:hover::after {
            opacity: 1;
            transform: translate(-50%, 6px);
            transition-delay: 1s;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #90caf9 0%, #64b5f6 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(144, 202, 249, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(144, 202, 249, 0.4);
        }

        .users-list {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .users-list::-webkit-scrollbar {
            width: 8px;
        }

        .users-list::-webkit-scrollbar-track {
            background: rgba(100, 181, 246, 0.1);
            border-radius: 10px;
        }

        .users-list::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #42a5f5, #2196f3);
            border-radius: 10px;
        }

        .user-item {
            background: linear-gradient(135deg, rgba(100, 181, 246, 0.1) 0%, rgba(66, 165, 245, 0.05) 100%);
            border: 2px solid rgba(100, 181, 246, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .user-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #42a5f5, #2196f3);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .user-item:hover {
            background: linear-gradient(135deg, rgba(100, 181, 246, 0.2) 0%, rgba(66, 165, 245, 0.1) 100%);
            transform: translateX(8px);
            border-color: rgba(66, 165, 245, 0.4);
            box-shadow: 0 5px 20px rgba(33, 150, 243, 0.2);
        }

        .user-item:hover::before {
            transform: scaleY(1);
        }

        .user-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            box-shadow: 0 3px 10px rgba(33, 150, 243, 0.3);
            position: relative;
        }

        .user-avatar::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 3px solid white;
            border-radius: 50%;
        }

        .user-avatar::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            bottom: 5px;
            right: 5px;
        }

        .user-name {
            font-weight: 700;
            color: #1565c0;
            margin-bottom: 5px;
            font-size: 1.05rem;
        }

        .user-login {
            color: #64b5f6;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .user-role {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 8px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }

        .user-role.admin {
            background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
            color: white;
        }

        .user-role.user {
            background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
            color: white;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
            width: auto;
        }

        .message {
            padding: 18px 24px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: none;
            backdrop-filter: blur(10px);
            border: 2px solid;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.success {
            background: rgba(129, 199, 132, 0.2);
            color: #2e7d32;
            border-color: rgba(129, 199, 132, 0.5);
        }

        .message.error {
            background: rgba(239, 83, 80, 0.2);
            color: #c62828;
            border-color: rgba(239, 83, 80, 0.5);
        }

        .message.warning {
            background: rgba(255, 152, 0, 0.2);
            color: #e65100;
            border-color: rgba(255, 152, 0, 0.5);
        }

        .message.show {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: #90caf9;
        }

        .empty-state-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            position: relative;
        }

        .empty-state-icon::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 4px solid #90caf9;
            border-radius: 50%;
            opacity: 0.5;
        }

        .empty-state-icon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border: 4px solid #90caf9;
            border-radius: 50%;
            opacity: 0.7;
        }

        .empty-state p {
            font-size: 1.1rem;
            font-weight: 500;
            margin-top: 15px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h2 {
            color: #1565c0;
            font-size: 1.6rem;
            font-weight: 700;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: #999;
            cursor: pointer;
            line-height: 1;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: #1565c0;
        }

        /* –ß–µ–∫–±–æ–∫—Å—ã –∫–æ–º–ø–∞–Ω–∏–π */
        .company-checkbox {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
            cursor: pointer;
        }

        .company-checkbox:hover {
            background: rgba(100, 181, 246, 0.1);
        }

        .company-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: #42a5f5;
        }

        .company-checkbox input[type="checkbox"]:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .company-checkbox label {
            cursor: pointer;
            color: #1565c0;
            font-weight: 500;
            flex: 1;
        }

        .company-checkbox:has(input[type="checkbox"]:disabled) {
            opacity: 0.6;
        }

        .company-checkbox:has(input[type="checkbox"]:disabled):hover {
            background: transparent;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        .delete-user-modal {
            display: none;
            position: fixed;
            z-index: 10001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .delete-user-modal.show {
            display: flex;
        }

        .delete-user-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .delete-user-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .delete-user-modal-header h2 {
            color: #1565c0;
            font-size: 1.6rem;
            font-weight: 700;
            margin: 0;
        }

        .delete-user-modal-close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            line-height: 1;
            transition: color 0.3s ease;
        }

        .delete-user-modal-close:hover {
            color: #1565c0;
        }

        .delete-user-modal-content p {
            color: #666;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 25px;
            white-space: pre-line;
        }

        .delete-user-modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –∏ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media (max-width: 1024px) {
            .admin-panel {
                grid-template-columns: 1fr;
                gap: 25px;
            }

            .header {
                padding: 35px 30px;
            }

            .panel-section {
                padding: 30px;
            }

            .users-list {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .admin-panel {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .header {
                padding: 30px 25px;
                border-radius: 15px;
            }

            .header h1 {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }

            .header p {
                font-size: 1rem;
            }

            .panel-section {
                padding: 25px;
                border-radius: 15px;
            }

            .panel-section h2 {
                font-size: 1.4rem;
            }

            .form-group {
                margin-bottom: 18px;
            }

            .form-group input,
            .form-group select {
                padding: 12px 14px;
                font-size: 16px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iOS */
            }

            .btn {
                padding: 12px 20px;
                font-size: 0.9rem;
                min-height: 44px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è touch –Ω–∞ iOS */
                touch-action: manipulation; /* –£–ª—É—á—à–∞–µ—Ç –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å –Ω–∞ touch */
            }

            .user-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .user-actions {
                width: 100%;
                flex-direction: column;
                gap: 10px;
            }

            .user-actions .btn {
                width: 100%;
            }

            .users-list {
                grid-template-columns: 1fr;
            }

            .logout-admin-btn {
                top: 15px;
                right: 15px;
                padding: 7px 14px;
                font-size: 0.8rem;
            }

            .modal-content {
                width: 95%;
                max-width: 95%;
                padding: 25px 20px;
                margin: 5% auto;
            }

            .modal-header h2 {
                font-size: 1.4rem;
            }

            .delete-user-modal-content {
                padding: 25px 20px;
                width: 90%;
            }

            .delete-user-modal-header h2 {
                font-size: 1.4rem;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 25px 20px;
                border-radius: 12px;
            }

            .header h1 {
                font-size: 1.5rem;
                margin-bottom: 6px;
            }

            .header p {
                font-size: 0.9rem;
            }

            .panel-section {
                padding: 20px;
                border-radius: 12px;
            }

            .panel-section h2 {
                font-size: 1.2rem;
                margin-bottom: 20px;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-group label {
                font-size: 0.9rem;
                margin-bottom: 8px;
            }

            .form-group input,
            .form-group select {
                padding: 10px 12px;
                font-size: 16px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iOS */
                border-radius: 10px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.85rem;
                border-radius: 10px;
                min-height: 44px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è touch –Ω–∞ iOS */
                touch-action: manipulation; /* –£–ª—É—á—à–∞–µ—Ç –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å –Ω–∞ touch */
            }

            .user-item {
                padding: 15px;
                border-radius: 12px;
            }

            .user-name {
                font-size: 1rem;
            }

            .user-login {
                font-size: 0.8rem;
            }

            .user-role {
                font-size: 0.75rem;
                padding: 4px 8px;
            }

            .logout-admin-btn {
                top: 10px;
                right: 10px;
                padding: 6px 12px;
                font-size: 0.75rem;
            }

            .modal-content {
                width: 95%;
                max-width: 95%;
                padding: 20px 15px;
                margin: 10% auto;
                border-radius: 12px;
            }

            .modal-header h2 {
                font-size: 1.2rem;
            }

            .company-checkbox {
                padding: 10px;
                font-size: 0.85rem;
            }

            .delete-user-modal-content {
                padding: 20px 15px;
                width: 90%;
                border-radius: 12px;
            }

            .delete-user-modal-header h2 {
                font-size: 1.2rem;
            }

            .delete-user-modal-actions {
                flex-direction: column;
                gap: 10px;
            }

            .delete-user-modal-actions .btn {
                width: 100%;
            }
        }

        @media (max-width: 360px) {
            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.3rem;
            }

            .panel-section {
                padding: 15px;
            }

            .panel-section h2 {
                font-size: 1.1rem;
            }
        }

        /* –§—É—Ç—Ç–µ—Ä */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(100, 181, 246, 0.3);
            padding: 15px 20px;
            text-align: center;
            color: #64b5f6;
            font-size: 0.85rem;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(33, 150, 243, 0.1);
        }

        .footer p {
            margin: 0;
        }

        @media (max-width: 768px) {
            .footer {
                font-size: 0.75rem;
                padding: 12px 15px;
            }
        }
    </style>
</head>
<body>
    <!-- –ù–∞–¥–ø–∏—Å—å DeadLinePro –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
    <div style="position: fixed; top: 20px; right: 20px; z-index: 9999; font-size: 32px; font-weight: 600; color: rgba(33, 150, 243, 0.5); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; pointer-events: none; user-select: none;">DeadLinePro</div>
    <div class="container">
        <div class="header">
            <button class="logout-admin-btn" onclick="logoutFromAdmin()" data-tooltip="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏—è–º–∏">
                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏—è–º–∏
            </button>
            <div class="header-content">
                <div class="header-icon"></div>
                <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
                <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Å–∏—Å—Ç–µ–º—ã –¥–∏–∞–≥—Ä–∞–º–º—ã –ì–∞–Ω—Ç–∞</p>
            </div>
        </div>

        <div id="message" class="message"></div>

        <div class="admin-panel">
            <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <div class="panel-section">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                <form id="addUserForm">
                    <div class="form-group">
                        <label for="userName">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="text" id="userName" name="userName" required placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                    </div>
                    <div class="form-group">
                        <label for="userLogin">–õ–æ–≥–∏–Ω</label>
                        <input type="text" id="userLogin" name="userLogin" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
                    </div>
                    <div class="form-group">
                        <label for="userPassword">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="userPassword" name="userPassword" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                    </div>
                    <div class="form-group">
                        <label for="userRole">–†–æ–ª—å</label>
                        <select id="userRole" name="userRole" required>
                            <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                            <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                        </select>
                    </div>
                    <div class="form-group" id="userCompaniesGroup" style="display: none;">
                        <label for="userCompanies">–î–æ—Å—Ç—É–ø –∫ –∫–æ–º–ø–∞–Ω–∏—è–º *</label>
                        <div id="userCompaniesList" style="max-height: 200px; overflow-y: auto; border: 2px solid rgba(100, 181, 246, 0.3); border-radius: 10px; padding: 10px; background: rgba(255, 255, 255, 0.9);">
                            <p style="color: #999; font-size: 0.9rem;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π...</p>
                        </div>
                        <small>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏–∏, –∫ –∫–æ—Ç–æ—Ä—ã–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∫–æ–º–ø–∞–Ω–∏—è–º)</small>
                    </div>
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                </form>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <div class="panel-section">
                <h2>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="companySelectUsers">–ö–æ–º–ø–∞–Ω–∏—è</label>
                    <select id="companySelectUsers" name="companySelectUsers" style="width: 100%; padding: 14px 18px; border: 2px solid rgba(100, 181, 246, 0.3); border-radius: 12px; font-size: 1rem; background: rgba(255, 255, 255, 0.9); color: #1565c0;">
                        <option value="">–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏</option>
                    </select>
                </div>
                <div id="usersList" class="users-list">
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–µ–ª–µ—Ç–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
        <div class="panel-section" style="margin-top: 30px;">
            <h2>–°–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ü–∏—è —Å–∫–µ–ª–µ—Ç–æ–Ω–∞</h2>
            <div style="margin-bottom: 20px;">
                <div id="skeletonButtonsContainer" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                    <!-- –ö–Ω–æ–ø–∫–∏ —Å–∫–µ–ª–µ—Ç–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                <button class="btn btn-primary" style="width: auto; padding: 12px 24px; background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);" onclick="openCreateSkeletonModal()">
                    + –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
            <div id="skeletonEditorContainer" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <h3 id="skeletonEditorTitle" style="color: #1565c0; margin-bottom: 10px;"></h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-primary" style="width: auto; padding: 10px 20px;" onclick="addSkeletonTask()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
                        <button class="btn btn-secondary" style="width: auto; padding: 10px 20px;" onclick="openColumnsManager()">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞–º–∏</button>
                        <button class="btn btn-primary" style="width: auto; padding: 10px 20px;" onclick="saveSkeleton()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∫–µ–ª–µ—Ç</button>
                        <span id="skeletonSaveStatus" style="color: #2e7d32; font-weight: 600; align-self: center; display: none;">‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
                    </div>
                </div>
                <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                    <table id="skeletonTable" style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%); color: white; position: sticky; top: 0; z-index: 10;">
                                <th style="padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.3);">‚Ññ</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.3);">–≠—Ç–∞–ø</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.3);">–í–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.3);">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.3);">–î–Ω–µ–π</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.3);">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="skeletonTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- –õ–æ–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
        <div class="panel-section" style="margin-top: 30px;">
            <h2>–õ–æ–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
            <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                <div class="form-group" style="margin: 0; flex: 1; min-width: 200px;">
                    <label for="logCompanyFilter">–ö–æ–º–ø–∞–Ω–∏—è</label>
                    <select id="logCompanyFilter" name="logCompanyFilter" style="width: 100%; padding: 14px 18px; border: 2px solid rgba(100, 181, 246, 0.3); border-radius: 12px; font-size: 1rem; background: rgba(255, 255, 255, 0.9); color: #1565c0;">
                        <option value="">–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏</option>
                    </select>
                </div>
                <div class="form-group" style="margin: 0; flex: 1; min-width: 200px;">
                    <label for="logUserFilter">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                    <input type="text" id="logUserFilter" name="logUserFilter" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" style="width: 100%; padding: 14px 18px; border: 2px solid rgba(100, 181, 246, 0.3); border-radius: 12px; font-size: 1rem; background: rgba(255, 255, 255, 0.9); color: #1565c0;">
                </div>
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <button class="btn btn-primary" onclick="loadActivityLogs()" style="width: auto; padding: 14px 24px;">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    <button class="btn btn-secondary" onclick="exportActivityLogs('excel')" style="width: auto; padding: 14px 24px; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);">–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
                    <button class="btn btn-secondary" onclick="exportActivityLogs('txt')" style="width: auto; padding: 14px 24px; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);">–≠–∫—Å–ø–æ—Ä—Ç –≤ TXT</button>
                    <button class="btn btn-secondary" onclick="clearActivityLogs()" style="width: auto; padding: 14px 24px; background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
                </div>
            </div>
            <div style="overflow-x: auto; max-height: 600px; overflow-y: auto; border-radius: 10px; border: 2px solid rgba(100, 181, 246, 0.3);">
                <table id="activityLogsTable" style="width: 100%; border-collapse: collapse; background: white;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%); color: white; position: sticky; top: 0; z-index: 10;">
                            <th style="padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.3); min-width: 150px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.3); min-width: 150px;">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.3); min-width: 200px;">–î–µ–π—Å—Ç–≤–∏–µ</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.3); min-width: 150px;">–ö–æ–º–ø–∞–Ω–∏—è</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.3); min-width: 300px;">–î–µ—Ç–∞–ª–∏</th>
                        </tr>
                    </thead>
                    <tbody id="activityLogsTableBody">
                        <tr>
                            <td colspan="5" style="padding: 20px; text-align: center; color: #64b5f6;">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- –ë—ç–∫–∞–ø –∫–æ–º–ø–∞–Ω–∏–π -->
        <div class="panel-section" style="margin-top: 30px;">
            <h2>–ë—ç–∫–∞–ø –∫–æ–º–ø–∞–Ω–∏–π</h2>
            <p style="color: #64b5f6; margin-bottom: 20px; font-size: 0.95rem;">
                –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–∏ (–≥—Ä–∞—Ñ–∏–∫, –∑–∞–¥–∞—á–∏, —Å—Ç–∞—Ç—É—Å—ã, –¥–∞—Ç—ã, –Ω–∞–∑–≤–∞–Ω–∏–µ, –ª–æ–≥–æ—Ç–∏–ø) –∏–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏–∑ –±—ç–∫–∞–ø–∞.
            </p>
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div class="form-group">
                    <label for="backupCompanySelect">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é</label>
                    <select id="backupCompanySelect" name="backupCompanySelect" style="width: 100%; padding: 14px 18px; border: 2px solid rgba(100, 181, 246, 0.3); border-radius: 12px; font-size: 1rem; background: rgba(255, 255, 255, 0.9); color: #1565c0;">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é --</option>
                    </select>
                </div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="exportCompanyBackup()" style="width: auto; padding: 14px 24px; background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);">
                        üì• –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('restoreBackupInput').click()" style="width: auto; padding: 14px 24px; background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);">
                        üì§ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞
                    </button>
                    <input type="file" id="restoreBackupInput" accept=".json" style="display: none;" onchange="restoreCompanyBackup(event)">
                </div>
                <div id="backupStatus" style="display: none; padding: 15px; border-radius: 10px; margin-top: 10px;"></div>
            </div>
        </div>
        <!-- –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π –æ—Ç—Å—Ç—É–ø, —á—Ç–æ–±—ã –±–ª–æ–∫ –±—ç–∫–∞–ø–∞ –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª –∫ —Ñ—É—Ç–µ—Ä—É -->
        <div aria-hidden="true" style="width: 200px; height: 200px; opacity: 0; pointer-events: none;"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div id="deleteUserModal" class="delete-user-modal">
        <div class="delete-user-modal-content">
            <div class="delete-user-modal-header">
                <h2>–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?</h2>
                <span class="delete-user-modal-close" onclick="cancelDeleteUser()">&times;</span>
            </div>
            <p id="deleteUserText">–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?</p>
            <div class="delete-user-modal-actions">
                <button class="btn btn-danger" onclick="confirmDeleteUser()">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="cancelDeleteUser()">–ù–µ—Ç</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±—ç–∫–∞–ø–∞ -->
    <div id="restoreBackupModal" class="delete-user-modal">
        <div class="delete-user-modal-content">
            <div class="delete-user-modal-header">
                <h2>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±—ç–∫–∞–ø?</h2>
                <span class="delete-user-modal-close" onclick="cancelRestoreBackup()">&times;</span>
            </div>
            <p id="restoreBackupText">–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ –±—ç–∫–∞–ø–∞.</p>
            <div class="delete-user-modal-actions">
                <button class="btn btn-primary" onclick="confirmRestoreBackup()" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);">–î–∞, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="cancelRestoreBackup()">–ù–µ—Ç</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤ -->
    <div id="clearLogsModal" class="delete-user-modal">
        <div class="delete-user-modal-content">
            <div class="delete-user-modal-header">
                <h2>–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏?</h2>
                <span class="delete-user-modal-close" onclick="cancelClearLogs()">&times;</span>
            </div>
            <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ª–æ–≥–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            <div class="delete-user-modal-actions">
                <button class="btn btn-danger" onclick="confirmClearLogs()">–î–∞, –æ—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="cancelClearLogs()">–ù–µ—Ç</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞ -->
    <div id="deleteSkeletonTypeModal" class="delete-user-modal">
        <div class="delete-user-modal-content">
            <div class="delete-user-modal-header">
                <h2>–£–¥–∞–ª–∏—Ç—å —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞?</h2>
                <span class="delete-user-modal-close" onclick="cancelDeleteSkeletonType()">&times;</span>
            </div>
            <p id="deleteSkeletonTypeText">–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞?</p>
            <div class="delete-user-modal-actions">
                <button class="btn btn-danger" onclick="confirmDeleteSkeletonType()">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="cancelDeleteSkeletonType()">–ù–µ—Ç</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞ -->
    <div id="createSkeletonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞</h2>
                <button class="modal-close" onclick="closeCreateSkeletonModal()">&times;</button>
            </div>
            <div id="createSkeletonMessage" class="message"></div>
            <form id="createSkeletonForm">
                <div class="form-group">
                    <label for="containerName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ *</label>
                    <input type="text" id="containerName" name="containerName" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–°-2" 
                           style="width: 100%; padding: 12px 16px; border: 2px solid rgba(100, 181, 246, 0.3); border-radius: 10px; font-size: 1rem;">
                    <small>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π</small>
                </div>
                <div class="form-group">
                    <label for="chartTypeName">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞ *</label>
                    <input type="text" id="chartTypeName" name="chartTypeName" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–Ω–µ–¥—Ä–µ–Ω–∏–µ Praktis KC" 
                           style="width: 100%; padding: 12px 16px; border: 2px solid rgba(100, 181, 246, 0.3); border-radius: 10px; font-size: 1rem;">
                    <small>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏</small>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateSkeletonModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ —Å–∫–µ–ª–µ—Ç–∞ -->
    <div id="deleteSkeletonTaskModal" class="delete-user-modal">
        <div class="delete-user-modal-content">
            <div class="delete-user-modal-header">
                <h2>–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?</h2>
                <span class="delete-user-modal-close" onclick="cancelDeleteSkeletonTask()">&times;</span>
            </div>
            <p>–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É –∏–∑ —Å–∫–µ–ª–µ—Ç–∞?</p>
            <div class="delete-user-modal-actions">
                <button class="btn btn-danger" onclick="confirmDeleteSkeletonTask()">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="cancelDeleteSkeletonTask()">–ù–µ—Ç</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞–º–∏ -->
    <div id="columnsManagerModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞–º–∏ —Ç–∞–±–ª–∏—Ü—ã</h2>
                <button class="modal-close" onclick="closeColumnsManager()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <p style="margin-bottom: 20px; color: #666;">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å—Ç–æ–ª–±—Ü—ã –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –∑–∞–¥–∞—á. –≠—Ç–∏ —Å—Ç–æ–ª–±—Ü—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ –∑–∞–¥–∞—á –∫–æ–º–ø–∞–Ω–∏–∏.</p>
                <div id="columnsList" style="margin-bottom: 20px;">
                    <!-- –°–ø–∏—Å–æ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                    <button class="btn btn-primary" onclick="openAddColumnModal()">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü</button>
                    <button class="btn btn-secondary" onclick="closeColumnsManager()">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ -->
    <div id="addColumnModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü</h2>
                <button class="modal-close" onclick="closeAddColumnModal()">&times;</button>
            </div>
            <div id="addColumnMessage" class="message"></div>
            <form id="addColumnForm">
                <div class="form-group">
                    <label for="newColumnField">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è *</label>
                    <input type="text" id="newColumnField" name="newColumnField" required 
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: description" 
                           pattern="[a-zA-Z0-9_]+"
                           style="width: 100%; padding: 12px 16px; border: 2px solid rgba(100, 181, 246, 0.3); border-radius: 10px; font-size: 1rem;">
                    <small>–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è</small>
                </div>
                <div class="form-group">
                    <label for="newColumnName">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ *</label>
                    <input type="text" id="newColumnName" name="newColumnName" required 
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û–ø–∏—Å–∞–Ω–∏–µ" 
                           style="width: 100%; padding: 12px 16px; border: 2px solid rgba(100, 181, 246, 0.3); border-radius: 10px; font-size: 1rem;">
                    <small>–ù–∞–∑–≤–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ</small>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddColumnModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                <button class="modal-close" onclick="closeEditUserModal()">&times;</button>
            </div>
            <div id="editUserMessage" class="message"></div>
            <form id="editUserForm">
                <div class="form-group">
                    <label for="editUserName">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è *</label>
                    <input type="text" id="editUserName" name="editUserName" required placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                </div>
                <div class="form-group">
                    <label for="editUserLogin">–õ–æ–≥–∏–Ω</label>
                    <input type="text" id="editUserLogin" name="editUserLogin" readonly 
                           style="background: #f5f5f5; cursor: not-allowed;">
                    <small>–õ–æ–≥–∏–Ω –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å</small>
                </div>
                <div class="form-group">
                    <label for="editUserPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="editUserPassword" name="editUserPassword" 
                           placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å">
                </div>
                <div class="form-group">
                    <label for="editUserRole">–†–æ–ª—å *</label>
                    <select id="editUserRole" name="editUserRole" required>
                        <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                        <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editUserCompanies">–î–æ—Å—Ç—É–ø –∫ –∫–æ–º–ø–∞–Ω–∏—è–º</label>
                    <div id="editUserCompaniesList" style="max-height: 200px; overflow-y: auto; border: 2px solid rgba(100, 181, 246, 0.3); border-radius: 10px; padding: 10px; background: rgba(255, 255, 255, 0.9);">
                        <p style="color: #999; font-size: 0.9rem;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π...</p>
                    </div>
                    <small>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏–∏, –∫ –∫–æ—Ç–æ—Ä—ã–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∫–æ–º–ø–∞–Ω–∏—è–º)</small>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="button" class="btn btn-danger" onclick="closeEditUserModal()" style="flex: 1;">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentCompanyId = '';
        let allCompanies = [];
        let allUsers = [];
        let backupToRestore = null; // –î–∞–Ω–Ω—ã–µ –±—ç–∫–∞–ø–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type} show`;
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 3000);
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π
        async function loadCompanies() {
            try {
                const response = await fetch('/api/companies');
                allCompanies = await response.json() || [];
                const companySelectUsers = document.getElementById('companySelectUsers');
                const backupCompanySelect = document.getElementById('backupCompanySelect');
                
                // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                if (companySelectUsers) {
                    companySelectUsers.innerHTML = '<option value="">–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏</option>';
                    allCompanies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.id;
                        option.textContent = `${company.name} (${company.id})`;
                        companySelectUsers.appendChild(option);
                    });
                }
                
                // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π –¥–ª—è –±—ç–∫–∞–ø–∞
                if (backupCompanySelect) {
                    backupCompanySelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é --</option>';
                    allCompanies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.id;
                        option.textContent = `${company.name} (${company.id})`;
                        backupCompanySelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                allUsers = await response.json() || [];
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
                let filteredUsers = allUsers;
                if (currentCompanyId) {
                    // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ (–∞–¥–º–∏–Ω—ã –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è)
                    filteredUsers = allUsers.filter(user => {
                        // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
                        if (user.role === 'admin') {
                            return false;
                        }
                        // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –≤ —Å–ø–∏—Å–∫–µ
                        return user.companies && Array.isArray(user.companies) && user.companies.includes(currentCompanyId);
                    });
                } else {
                    // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ "–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏" –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –≤–∫–ª—é—á–∞—è –∞–¥–º–∏–Ω–æ–≤
                    filteredUsers = allUsers;
                }
                
                renderUsers(filteredUsers);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function renderUsers(users) {
            const usersList = document.getElementById('usersList');
            const MAIN_ADMIN_LOGIN = 'Driga_VA';
            
            if (users.length === 0) {
                usersList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    </div>
                `;
                return;
            }

            usersList.innerHTML = users.map((user, index) => {
                const userCompanies = user.companies || [];
                const companiesText = user.role === 'admin' 
                    ? '–î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∫–æ–º–ø–∞–Ω–∏—è–º' 
                    : (userCompanies.length > 0 
                        ? `–ö–æ–º–ø–∞–Ω–∏–∏: ${userCompanies.join(', ')}` 
                        : '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–º–ø–∞–Ω–∏—è–º');
                
                // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏
                const safeLogin = user.login.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const safeName = user.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const companiesJson = JSON.stringify(user.companies || []).replace(/"/g, '&quot;');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–ª–∞–≤–Ω—ã–º –∞–¥–º–∏–Ω–æ–º
                const isMainAdmin = user.login === MAIN_ADMIN_LOGIN;
                
                return `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-avatar"></div>
                        <div class="user-name">${user.name}${isMainAdmin ? ' <span style="color: #ff9800; font-size: 0.85rem;">(–ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω)</span>' : ''}</div>
                        <div class="user-login">–õ–æ–≥–∏–Ω: ${user.login}</div>
                        <div style="color: #64b5f6; font-size: 0.85rem; margin-top: 5px;">${companiesText}</div>
                        <span class="user-role ${user.role}">${user.role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</span>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-primary btn-small" 
                                data-user-login="${safeLogin}"
                                data-user-name="${safeName}"
                                data-user-role="${user.role}"
                                data-user-companies="${companiesJson}"
                                onclick="editUserFromButton(this)">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        ${isMainAdmin ? '' : `<button class="btn btn-danger btn-small" onclick="deleteUser('${safeLogin}')">–£–¥–∞–ª–∏—Ç—å</button>`}
                    </div>
                </div>
            `;
            }).join('');
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadCompaniesForAdd() {
            const companiesList = document.getElementById('userCompaniesList');
            if (!companiesList) return;

            try {
                const response = await fetch('/api/companies');
                const companies = await response.json() || [];
                
                if (companies.length === 0) {
                    companiesList.innerHTML = '<p style="color: #999; font-size: 0.9rem;">–ö–æ–º–ø–∞–Ω–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                    return;
                }

                companiesList.innerHTML = companies.map(company => {
                    return `
                        <div class="company-checkbox">
                            <input type="checkbox" id="add_company_${company.id}" value="${company.id}">
                            <label for="add_company_${company.id}">${company.name} (${company.id})</label>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π:', error);
                companiesList.innerHTML = '<p style="color: #ef5350; font-size: 0.9rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π</p>';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏ –≤ —Ñ–æ—Ä–º–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        document.getElementById('userRole').addEventListener('change', function(e) {
            const role = e.target.value;
            const companiesGroup = document.getElementById('userCompaniesGroup');
            const companiesList = document.getElementById('userCompaniesList');
            
            if (role === 'admin') {
                // –ï—Å–ª–∏ —Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –∫–æ–º–ø–∞–Ω–∏–π
                if (companiesGroup) {
                    companiesGroup.style.display = 'none';
                }
                // –°–Ω–∏–º–∞–µ–º –≤—Å–µ –≥–∞–ª–æ—á–∫–∏
                if (companiesList) {
                    const checkboxes = companiesList.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        cb.checked = false;
                    });
                }
            } else {
                // –ï—Å–ª–∏ —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –∫–æ–º–ø–∞–Ω–∏–π
                if (companiesGroup) {
                    companiesGroup.style.display = 'block';
                }
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–ø–∞–Ω–∏–∏, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç
                if (companiesList) {
                    const hasCompanies = companiesList.querySelectorAll('.company-checkbox').length > 0;
                    if (!hasCompanies || companiesList.innerHTML.includes('–ó–∞–≥—Ä—É–∑–∫–∞')) {
                        loadCompaniesForAdd();
                    }
                }
            }
        });

        // –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const role = document.getElementById('userRole').value;
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
            let selectedCompanies = [];
            if (role === 'user') {
                const checkboxes = document.querySelectorAll('#userCompaniesList input[type="checkbox"]:checked');
                selectedCompanies = Array.from(checkboxes).map(cb => cb.value);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∫–æ–º–ø–∞–Ω–∏—è
                if (selectedCompanies.length === 0) {
                    showMessage('–î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–æ–º–ø–∞–Ω–∏—é', 'error');
                    return;
                }
            }
            
            const formData = {
                name: document.getElementById('userName').value.trim(),
                login: document.getElementById('userLogin').value.trim(),
                password: document.getElementById('userPassword').value,
                role: role,
                companies: selectedCompanies
            };

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.ok) {
                    showMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                    document.getElementById('addUserForm').reset();
                    // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –∫–æ–º–ø–∞–Ω–∏–π –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã
                    const companiesGroup = document.getElementById('userCompaniesGroup');
                    if (companiesGroup) {
                        companiesGroup.style.display = 'none';
                    }
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∫–æ–º–ø–∞–Ω–∏–π
                    const checkboxes = document.querySelectorAll('#userCompaniesList input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        cb.checked = false;
                    });
                    loadUsers();
                } else {
                    showMessage(result.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                showMessage('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
            }
        });

        let userToEdit = null;

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫–Ω–æ–ø–∫–∏
        async function editUserFromButton(button) {
            const login = button.getAttribute('data-user-login');
            const name = button.getAttribute('data-user-name');
            const role = button.getAttribute('data-user-role');
            const companiesJson = button.getAttribute('data-user-companies');
            
            let companies = [];
            try {
                companies = JSON.parse(companiesJson.replace(/&quot;/g, '"'));
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–º–ø–∞–Ω–∏–π:', e);
            }
            
            await editUser(login, name, role, companies);
        }

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function editUser(login, name, role, companies) {
            userToEdit = { login, name, role, companies: companies || [] };
            const modal = document.getElementById('editUserModal');
            const messageEl = document.getElementById('editUserMessage');
            const nameInput = document.getElementById('editUserName');
            const loginInput = document.getElementById('editUserLogin');
            const passwordInput = document.getElementById('editUserPassword');
            const roleSelect = document.getElementById('editUserRole');
            const companiesList = document.getElementById('editUserCompaniesList');

            if (!modal || !nameInput || !loginInput || !roleSelect || !companiesList) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–ª–∞–≤–Ω—ã–º –∞–¥–º–∏–Ω–æ–º
            const isMainAdmin = login === MAIN_ADMIN_LOGIN;

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            nameInput.value = name;
            loginInput.value = login;
            loginInput.readOnly = true;
            passwordInput.value = '';
            roleSelect.value = role;
            messageEl.classList.remove('show');

            // –î–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞ –æ—Ç–∫–ª—é—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –∏ –∫–æ–º–ø–∞–Ω–∏–π
            if (isMainAdmin) {
                roleSelect.disabled = true;
                roleSelect.style.cursor = 'not-allowed';
                roleSelect.style.opacity = '0.6';
                if (companiesList) {
                    companiesList.style.pointerEvents = 'none';
                    companiesList.style.opacity = '0.6';
                }
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                messageEl.textContent = '–í–Ω–∏–º–∞–Ω–∏–µ: –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –∏ –¥–æ—Å—Ç—É–ø –∫ –∫–æ–º–ø–∞–Ω–∏—è–º';
                messageEl.className = 'message warning show';
            } else {
                roleSelect.disabled = false;
                roleSelect.style.cursor = 'pointer';
                roleSelect.style.opacity = '1';
                if (companiesList) {
                    companiesList.style.pointerEvents = 'auto';
                    companiesList.style.opacity = '1';
                }
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
            await loadCompaniesForEdit(companies);

            // –ï—Å–ª–∏ —Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –æ—Ç–∫–ª—é—á–∞–µ–º —á–µ–∫–±–æ–∫—Å—ã
            if (role === 'admin') {
                const checkboxes = companiesList.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.disabled = true;
                    cb.checked = false;
                });
            }

            modal.classList.add('show');
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        async function loadCompaniesForEdit(userCompanies) {
            const companiesList = document.getElementById('editUserCompaniesList');
            if (!companiesList) return;

            try {
                const response = await fetch('/api/companies');
                const companies = await response.json() || [];
                
                if (companies.length === 0) {
                    companiesList.innerHTML = '<p style="color: #999; font-size: 0.9rem;">–ö–æ–º–ø–∞–Ω–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                    return;
                }

                companiesList.innerHTML = companies.map(company => {
                    const isChecked = userCompanies.includes(company.id);
                    return `
                        <div class="company-checkbox">
                            <input type="checkbox" id="company_${company.id}" value="${company.id}" ${isChecked ? 'checked' : ''}>
                            <label for="company_${company.id}">${company.name} (${company.id})</label>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π:', error);
                companiesList.innerHTML = '<p style="color: #ef5350; font-size: 0.9rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π</p>';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function closeEditUserModal() {
            const modal = document.getElementById('editUserModal');
            if (modal) {
                modal.classList.remove('show');
            }
            userToEdit = null;
            document.getElementById('editUserForm').reset();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏ –≤ —Ñ–æ—Ä–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        document.getElementById('editUserRole').addEventListener('change', function(e) {
            const role = e.target.value;
            const companiesList = document.getElementById('editUserCompaniesList');
            
            if (role === 'admin') {
                // –ï—Å–ª–∏ —Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –æ—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã
                if (companiesList) {
                    const checkboxes = companiesList.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        cb.disabled = true;
                        cb.checked = false;
                    });
                }
            } else {
                // –ï—Å–ª–∏ —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –≤–∫–ª—é—á–∞–µ–º —á–µ–∫–±–æ–∫—Å—ã –æ–±—Ä–∞—Ç–Ω–æ
                if (companiesList) {
                    const checkboxes = companiesList.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        cb.disabled = false;
                    });
                }
            }
        });

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.getElementById('editUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!userToEdit) {
                return;
            }

            const name = document.getElementById('editUserName').value.trim();
            const password = document.getElementById('editUserPassword').value;
            const role = document.getElementById('editUserRole').value;
            const companiesList = document.getElementById('editUserCompaniesList');
            const messageEl = document.getElementById('editUserMessage');

            if (!name) {
                messageEl.textContent = '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ';
                messageEl.className = 'message error show';
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–ª–∞–≤–Ω—ã–º –∞–¥–º–∏–Ω–æ–º
            const isMainAdmin = userToEdit.login === MAIN_ADMIN_LOGIN;

            // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–æ–ª—å –Ω–µ –∞–¥–º–∏–Ω –∏ –Ω–µ –≥–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω)
            const selectedCompanies = [];
            if (role !== 'admin' && companiesList && !isMainAdmin) {
                const checkboxes = companiesList.querySelectorAll('input[type="checkbox"]:checked');
                checkboxes.forEach(cb => {
                    selectedCompanies.push(cb.value);
                });
            }

            try {
                const updateData = {
                    name: name
                };

                // –î–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–æ–ª—å –∏ –∫–æ–º–ø–∞–Ω–∏–∏
                if (!isMainAdmin) {
                    updateData.role = role;
                    updateData.companies = role === 'admin' ? [] : selectedCompanies;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω
                if (password && password.trim()) {
                    if (password.length < 6) {
                        messageEl.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
                        messageEl.className = 'message error show';
                        return;
                    }
                    updateData.password = password;
                }

                const response = await fetch(`/api/users/${encodeURIComponent(userToEdit.login)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();

                if (result.ok) {
                    messageEl.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω';
                    messageEl.className = 'message success show';
                    setTimeout(() => {
                        closeEditUserModal();
                        loadUsers();
                    }, 1000);
                } else {
                    messageEl.textContent = result.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                    messageEl.className = 'message error show';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                messageEl.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
                messageEl.className = 'message error show';
            }
        });

        let userToDelete = null;
        const MAIN_ADMIN_LOGIN = 'Driga_VA';

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function deleteUser(login) {
            // –ó–∞—â–∏—Ç–∞ –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            if (login === MAIN_ADMIN_LOGIN) {
                showMessage('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', 'error');
                return;
            }

            // –ù–∞—Ö–æ–¥–∏–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞
            const user = allUsers.find(u => u.login === login);
            const userName = user ? user.name : login;

            userToDelete = { login, name: userName };
            const modal = document.getElementById('deleteUserModal');
            const textEl = document.getElementById('deleteUserText');
            
            if (textEl) {
                textEl.textContent = `–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" (${login})?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`;
            }
            
            if (modal) {
                modal.classList.add('show');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function cancelDeleteUser() {
            const modal = document.getElementById('deleteUserModal');
            if (modal) {
                modal.classList.remove('show');
            }
            userToDelete = null;
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function confirmDeleteUser() {
            if (!userToDelete) {
                return;
            }

            const { login } = userToDelete;

            try {
                const response = await fetch(`/api/users/${encodeURIComponent(login)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.ok) {
                    showMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω', 'success');
                    cancelDeleteUser();
                    loadUsers();
                } else {
                    showMessage(result.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                    cancelDeleteUser();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                showMessage('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                cancelDeleteUser();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
        const companySelectUsers = document.getElementById('companySelectUsers');
        if (companySelectUsers) {
            companySelectUsers.addEventListener('change', function(e) {
                currentCompanyId = e.target.value;
                loadUsers();
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.getElementById('editUserModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditUserModal();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.getElementById('deleteUserModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cancelDeleteUser();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±—ç–∫–∞–ø–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.getElementById('restoreBackupModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cancelRestoreBackup();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±—ç–∫–∞–ø–∞ –ø–æ Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const restoreModal = document.getElementById('restoreBackupModal');
                if (restoreModal && restoreModal.classList.contains('show')) {
                    cancelRestoreBackup();
                }
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        const clearLogsModal = document.getElementById('clearLogsModal');
        if (clearLogsModal) {
            clearLogsModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    cancelClearLogs();
                }
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ —Å–∫–µ–ª–µ—Ç–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        const deleteSkeletonTaskModal = document.getElementById('deleteSkeletonTaskModal');
        if (deleteSkeletonTaskModal) {
            deleteSkeletonTaskModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    cancelDeleteSkeletonTask();
                }
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const editModal = document.getElementById('editUserModal');
                const deleteModal = document.getElementById('deleteUserModal');
                const clearLogsModal = document.getElementById('clearLogsModal');
                const deleteSkeletonModal = document.getElementById('deleteSkeletonTaskModal');
                const deleteSkeletonTypeModal = document.getElementById('deleteSkeletonTypeModal');
                const createSkeletonModal = document.getElementById('createSkeletonModal');
                const columnsManagerModal = document.getElementById('columnsManagerModal');
                const addColumnModal = document.getElementById('addColumnModal');
                if (editModal && editModal.classList.contains('show')) {
                    closeEditUserModal();
                } else if (deleteModal && deleteModal.classList.contains('show')) {
                    cancelDeleteUser();
                } else if (clearLogsModal && clearLogsModal.classList.contains('show')) {
                    cancelClearLogs();
                } else if (deleteSkeletonModal && deleteSkeletonModal.classList.contains('show')) {
                    cancelDeleteSkeletonTask();
                } else if (deleteSkeletonTypeModal && deleteSkeletonTypeModal.classList.contains('show')) {
                    cancelDeleteSkeletonType();
                } else if (createSkeletonModal && createSkeletonModal.classList.contains('show')) {
                    closeCreateSkeletonModal();
                } else if (addColumnModal && addColumnModal.classList.contains('show')) {
                    closeAddColumnModal();
                } else if (columnsManagerModal && columnsManagerModal.classList.contains('show')) {
                    closeColumnsManager();
                }
            }
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        function checkAuth() {
            const userStr = localStorage.getItem('gantt-user');
            if (!userStr) {
                window.location.href = 'auth.html';
                return false;
            }

            try {
                const currentUser = JSON.parse(userStr);
                if (currentUser.role !== 'admin') {
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–¥–º–∏–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—ã–±–æ—Ä–∞ –∫–æ–º–ø–∞–Ω–∏–π
                    window.location.href = 'companies.html';
                    return false;
                }
                return true;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
                window.location.href = 'auth.html';
                return false;
            }
        }

        // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π)
        function getUserContext() {
            try {
                const storedUser = localStorage.getItem('gantt-user');
                if (!storedUser) {
                    console.warn('‚ö†Ô∏è getUserContext: localStorage –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç gantt-user');
                    return { name: null, login: null };
                }
                
                const parsed = JSON.parse(storedUser);
                
                // –ë–æ–ª–µ–µ –∂–µ—Å—Ç–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ö–æ—Ç—è –±—ã name –∏–ª–∏ login
                if (!parsed || (typeof parsed !== 'object')) {
                    console.warn('‚ö†Ô∏è getUserContext: parsed –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º', parsed);
                    return { name: null, login: null };
                }
                
                const name = parsed.name ? String(parsed.name).trim() : null;
                const login = parsed.login ? String(parsed.login).trim() : null;
                
                // –ï—Å–ª–∏ –æ–±–∞ –ø–æ–ª—è –ø—É—Å—Ç—ã–µ –∏–ª–∏ null, —ç—Ç–æ –æ—à–∏–±–∫–∞
                if (!name && !login) {
                    console.error('‚ùå getUserContext: –∏ name, –∏ login –ø—É—Å—Ç—ã–µ!', parsed);
                    return { name: null, login: null };
                }
                
                return {
                    name: name || null,
                    login: login || null
                };
            } catch (e) {
                console.error('‚ùå getUserContext: –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ localStorage:', e);
                return { name: null, login: null };
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        function closeAllModals() {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal) {
                    // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å show
                    modal.classList.remove('show');
                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º display: none
                    modal.style.display = 'none';
                }
            });
        }

        // –í—ã—Ö–æ–¥ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—ã–±–æ—Ä–∞ –∫–æ–º–ø–∞–Ω–∏–π)
        function logoutFromAdmin() {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º
            closeAllModals();
            window.location.href = 'companies.html';
        }

        // ========== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –°–ö–ï–õ–ï–¢–û–í –ì–†–ê–§–ò–ö–û–í ==========
        let currentSkeletonType = null;
        let currentSkeletonData = [];
        let skeletonSaveTimeout = null;
        let selectedSkeletonRowIndex = -1;
        // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—Ç–æ–ª–±—Ü–æ–≤: –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ { id, name, field, order }
        // id - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ç–æ–ª–±—Ü–∞
        // name - –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞
        // field - –ø–æ–ª–µ –≤ –¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á–∏ (stage, control, task –∏ —Ç.–¥.)
        // order - –ø–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        let skeletonColumns = [
            { id: 'stage', name: '–≠—Ç–∞–ø', field: 'stage', order: 0 },
            { id: 'control', name: '–í–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è', field: 'control', order: 1 },
            { id: 'task', name: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ', field: 'task', order: 2 }
        ];
        let skeletonTaskToDelete = null;
        let chartTypesList = [];

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤
        async function loadChartTypes() {
            try {
                const response = await fetch('/api/chart-types');
                if (response.ok) {
                    chartTypesList = await response.json() || [];
                    renderSkeletonButtons();
                } else {
                    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤:', response.status, response.statusText);
                    // –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω (404), —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ç–∏–ø—ã
                    if (response.status === 404) {
                        chartTypesList = [
                            { id: 'icona', containerName: 'Icona', chartTypeName: '–í–Ω–µ–¥—Ä–µ–Ω–∏–µ Icona' },
                            { id: 'praktis', containerName: 'Praktis ID', chartTypeName: '–í–Ω–µ–¥—Ä–µ–Ω–∏–µ Praktis ID' }
                        ];
                    } else {
                        chartTypesList = [];
                    }
                    renderSkeletonButtons();
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤:', error);
                // –ü—Ä–∏ –æ—à–∏–±–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ç–∏–ø—ã
                chartTypesList = [
                    { id: 'icona', containerName: 'Icona', chartTypeName: '–í–Ω–µ–¥—Ä–µ–Ω–∏–µ Icona' },
                    { id: 'praktis', containerName: 'Praktis ID', chartTypeName: '–í–Ω–µ–¥—Ä–µ–Ω–∏–µ Praktis ID' }
                ];
                renderSkeletonButtons();
            }
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∫–Ω–æ–ø–∫–∏ —Å–∫–µ–ª–µ—Ç–æ–≤
        function renderSkeletonButtons() {
            const container = document.getElementById('skeletonButtonsContainer');
            if (!container) return;

            // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç –∏–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            if (!chartTypesList || chartTypesList.length === 0) {
                container.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 5px; margin-right: 10px;">
                        <button id="skeletonIconaBtn" class="btn ${currentSkeletonType === 'icona' ? 'btn-primary' : 'btn-secondary'}" style="width: auto; padding: 12px 24px;" onclick="openSkeletonEditor('icona')">
                            –°–∫–µ–ª–µ—Ç Icona
                        </button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px; margin-right: 10px;">
                        <button id="skeletonPraktisBtn" class="btn ${currentSkeletonType === 'praktis' ? 'btn-primary' : 'btn-secondary'}" style="width: auto; padding: 12px 24px;" onclick="openSkeletonEditor('praktis')">
                            –°–∫–µ–ª–µ—Ç Praktis ID
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = chartTypesList.map(chartType => {
                const isActive = currentSkeletonType === chartType.id;
                const btnClass = isActive ? 'btn-primary' : 'btn-secondary';
                // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ HTML
                const safeChartTypeName = (chartType.chartTypeName || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                    <div style="display: flex; align-items: flex-start; gap: 5px; margin-right: 10px; margin-bottom: 5px; position: relative;">
                        <button class="btn ${btnClass}" style="width: auto; padding: 12px 24px;" 
                                onclick="openSkeletonEditor('${chartType.id}')">
                            ${chartType.chartTypeName}
                        </button>
                        <button class="skeleton-type-delete-btn" 
                                onclick="deleteSkeletonType('${chartType.id}', '${safeChartTypeName}')" 
                                data-tooltip="–£–¥–∞–ª–∏—Ç—å —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞">
                            <span class="skeleton-delete-btn-icon">√ó</span>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // –û—Ç–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å–∫–µ–ª–µ—Ç–∞
        async function openSkeletonEditor(type) {
            currentSkeletonType = type;
            const container = document.getElementById('skeletonEditorContainer');
            const title = document.getElementById('skeletonEditorTitle');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            selectedSkeletonRowIndex = -1;
            
            // –ù–∞—Ö–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∏–ø–µ –≥—Ä–∞—Ñ–∏–∫–∞
            const chartType = chartTypesList.find(ct => ct.id === type);
            const chartTypeName = chartType ? chartType.chartTypeName : type;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            renderSkeletonButtons();
            
            title.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–µ–ª–µ—Ç–∞ –≥—Ä–∞—Ñ–∏–∫–∞: ${chartTypeName}`;
            
            container.style.display = 'block';
            await loadSkeleton(type);
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫–µ–ª–µ—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadSkeleton(type) {
            try {
                const response = await fetch(`/api/gantt-skeleton?chartType=${type}`);
                if (response.ok) {
                    const data = await response.json();
                    currentSkeletonData = data.skeleton || [];
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—Ç–æ–ª–±—Ü–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    if (data.columns && Array.isArray(data.columns) && data.columns.length > 0) {
                        skeletonColumns = data.columns;
                    } else {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã
                        skeletonColumns = [
                            { id: 'stage', name: '–≠—Ç–∞–ø', field: 'stage', order: 0 },
                            { id: 'control', name: '–í–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è', field: 'control', order: 1 },
                            { id: 'task', name: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ', field: 'task', order: 2 }
                        ];
                    }
                    renderSkeletonTable();
                } else {
                    showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–µ–ª–µ—Ç–∞', 'error');
                    currentSkeletonData = [];
                    renderSkeletonTable();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–µ–ª–µ—Ç–∞:', error);
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–µ–ª–µ—Ç–∞', 'error');
                currentSkeletonData = [];
                renderSkeletonTable();
            }
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å–∫–µ–ª–µ—Ç–∞
        function renderSkeletonTable() {
            const tbody = document.getElementById('skeletonTableBody');
            const thead = document.querySelector('#skeletonTable thead tr');
            if (!tbody || !thead) return;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
            const sortedColumns = [...skeletonColumns].sort((a, b) => a.order - b.order);
            const headerCells = [
                '<th style="padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.3);">‚Ññ</th>',
                ...sortedColumns.map(col => 
                    `<th style="padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.3);">${col.name}</th>`
                ),
                '<th style="padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.3);">–î–Ω–µ–π</th>',
                '<th style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.3);">–î–µ–π—Å—Ç–≤–∏—è</th>'
            ];
            thead.innerHTML = headerCells.join('');

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–æ–∫—É—Å–µ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π
            const activeElement = document.activeElement;
            let focusInfo = null;
            if (activeElement && activeElement.classList.contains('skeleton-input')) {
                const rowIndex = parseInt(activeElement.getAttribute('data-index'));
                const field = activeElement.getAttribute('data-field');
                const cursorPosition = activeElement.selectionStart;
                if (!isNaN(rowIndex) && field) {
                    focusInfo = { rowIndex, field, cursorPosition };
                }
            }

            const totalCols = 3 + sortedColumns.length; // ‚Ññ + —Å—Ç–æ–ª–±—Ü—ã + –î–Ω–µ–π + –î–µ–π—Å—Ç–≤–∏—è

            if (currentSkeletonData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${totalCols}" style="text-align: center; padding: 40px; color: #999;">–°–∫–µ–ª–µ—Ç –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É.</td></tr>`;
                return;
            }

            tbody.innerHTML = currentSkeletonData.map((task, index) => {
                const safeIndex = index;
                const isSelected = index === selectedSkeletonRowIndex;
                const rowStyle = isSelected 
                    ? 'border-bottom: 1px solid #e0e0e0; background-color: #e3f2fd; cursor: pointer;'
                    : 'border-bottom: 1px solid #e0e0e0; cursor: pointer;';
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —è—á–µ–π–∫–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
                const columnCells = sortedColumns.map(col => {
                    const value = task[col.field] || '';
                    return `
                        <td style="padding: 10px;">
                            <input type="text" class="skeleton-input" data-index="${safeIndex}" data-field="${col.field}" 
                                   value="${value.replace(/"/g, '&quot;')}" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;"
                                   onchange="updateSkeletonTask(${safeIndex}, '${col.field}', this.value)"
                                   onfocus="selectSkeletonRowSilent(${safeIndex})"
                                   oninput="updateSkeletonTask(${safeIndex}, '${col.field}', this.value)"
                                   onclick="event.stopPropagation();"
                                   onmousedown="event.stopPropagation();"
                                   onmouseup="event.stopPropagation();"
                                   onselectstart="event.stopPropagation();">
                        </td>
                    `;
                }).join('');

                return `
                    <tr class="skeleton-row" data-index="${safeIndex}" style="${rowStyle} position: relative;" 
                        onclick="if(event.target.tagName !== 'INPUT' && event.target.tagName !== 'BUTTON' && !event.target.closest('.skeleton-delete-btn')) selectSkeletonRow(${safeIndex})"
                        onmouseover="if(${safeIndex} !== selectedSkeletonRowIndex) this.style.backgroundColor='#f5f5f5'"
                        onmouseout="if(${safeIndex} !== selectedSkeletonRowIndex) this.style.backgroundColor=''">
                        <td style="padding: 10px; text-align: center; width: 50px;">${index + 1}</td>
                        ${columnCells}
                        <td style="padding: 10px;">
                            <input type="number" class="skeleton-input" data-index="${safeIndex}" data-field="days" 
                                   value="${task.days || 1}" min="1" 
                                   style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 5px;"
                                   onchange="updateSkeletonTask(${safeIndex}, 'days', parseInt(this.value) || 1)"
                                   onfocus="selectSkeletonRowSilent(${safeIndex})"
                                   oninput="updateSkeletonTask(${safeIndex}, 'days', parseInt(this.value) || 1)"
                                   onclick="event.stopPropagation();"
                                   onmousedown="event.stopPropagation();"
                                   onmouseup="event.stopPropagation();"
                                   onselectstart="event.stopPropagation();">
                        </td>
                        <td style="padding: 0; width: 0; position: relative; overflow: visible;">
                            <button class="skeleton-delete-btn" onclick="event.stopPropagation(); deleteSkeletonTask(${safeIndex});" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É">
                                <span class="skeleton-delete-btn-icon">√ó</span>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            if (focusInfo) {
                setTimeout(() => {
                    const input = tbody.querySelector(`input[data-index="${focusInfo.rowIndex}"][data-field="${focusInfo.field}"]`);
                    if (input) {
                        input.focus();
                        if (input.setSelectionRange && focusInfo.cursorPosition !== null) {
                            const pos = Math.min(focusInfo.cursorPosition, input.value.length);
                            input.setSelectionRange(pos, pos);
                        }
                    }
                }, 0);
            }
        }

        // –í—ã–¥–µ–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Å–∫–µ–ª–µ—Ç–∞ (—Å –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π)
        function selectSkeletonRow(index) {
            selectedSkeletonRowIndex = index;
            renderSkeletonTable();
        }

        // –í—ã–¥–µ–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Å–∫–µ–ª–µ—Ç–∞ –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ (—Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∏–ª—å)
        function selectSkeletonRowSilent(index) {
            if (selectedSkeletonRowIndex === index) {
                return; // –£–∂–µ –≤—ã–¥–µ–ª–µ–Ω–∞, –Ω–µ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å
            }
            const oldIndex = selectedSkeletonRowIndex;
            selectedSkeletonRowIndex = index;
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ —Å—Ç—Ä–æ–∫ –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            const rows = document.querySelectorAll('.skeleton-row');
            rows.forEach((row, i) => {
                if (i === index) {
                    row.style.backgroundColor = '#e3f2fd';
                } else if (i === oldIndex) {
                    row.style.backgroundColor = '';
                }
            });
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É –≤ —Å–∫–µ–ª–µ—Ç–µ
        function updateSkeletonTask(index, field, value) {
            if (index >= 0 && index < currentSkeletonData.length) {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –∑–∞–¥–∞—á–∏, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                if (!currentSkeletonData[index]) {
                    currentSkeletonData[index] = {};
                }
                currentSkeletonData[index][field] = value;
                autoSaveSkeleton();
            }
        }

        // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –ø–æ—Å–ª–µ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
        function addSkeletonTask() {
            const insertIndex = selectedSkeletonRowIndex >= 0 ? selectedSkeletonRowIndex + 1 : currentSkeletonData.length;
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –∑–∞–¥–∞—á–∏ —Å –ø–æ–ª—è–º–∏ –¥–ª—è –≤—Å–µ—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
            const newTask = { days: 1 };
            skeletonColumns.forEach(col => {
                newTask[col.field] = '';
            });
            currentSkeletonData.splice(insertIndex, 0, newTask);
            selectedSkeletonRowIndex = insertIndex;
            renderSkeletonTable();
            autoSaveSkeleton();
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
            setTimeout(() => {
                const newRow = document.querySelector(`tr[data-index="${insertIndex}"]`);
                if (newRow) {
                    const firstInput = newRow.querySelector('input');
                    if (firstInput) {
                        firstInput.focus();
                        firstInput.select();
                    }
                }
            }, 50);
        }

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
        function deleteSkeletonTask(index) {
            // –ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É
            if (index === undefined || index === null) {
                if (selectedSkeletonRowIndex >= 0 && selectedSkeletonRowIndex < currentSkeletonData.length) {
                    index = selectedSkeletonRowIndex;
                } else {
                    showMessage('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                    return;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏–Ω–¥–µ–∫—Å–∞
            if (index < 0 || index >= currentSkeletonData.length) {
                showMessage('–ù–µ–≤–µ—Ä–Ω—ã–π –∏–Ω–¥–µ–∫—Å –∑–∞–¥–∞—á–∏', 'error');
                return;
            }
            
            skeletonTaskToDelete = index;
            const modal = document.getElementById('deleteSkeletonTaskModal');
            if (modal) {
                modal.classList.add('show');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
        function cancelDeleteSkeletonTask() {
            const modal = document.getElementById('deleteSkeletonTaskModal');
            if (modal) {
                modal.classList.remove('show');
            }
            skeletonTaskToDelete = null;
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
        function confirmDeleteSkeletonTask() {
            if (skeletonTaskToDelete === null || skeletonTaskToDelete < 0 || skeletonTaskToDelete >= currentSkeletonData.length) {
                cancelDeleteSkeletonTask();
                return;
            }

            const index = skeletonTaskToDelete;
            currentSkeletonData.splice(index, 1);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É
            if (selectedSkeletonRowIndex >= currentSkeletonData.length) {
                selectedSkeletonRowIndex = currentSkeletonData.length > 0 ? currentSkeletonData.length - 1 : -1;
            } else if (selectedSkeletonRowIndex > index) {
                // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Å—Ç—Ä–æ–∫—É –≤—ã—à–µ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π, —É–º–µ–Ω—å—à–∞–µ–º –∏–Ω–¥–µ–∫—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è
                selectedSkeletonRowIndex--;
            }
            
            cancelDeleteSkeletonTask();
            renderSkeletonTable();
            autoSaveSkeleton();
        }

        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–∫–µ–ª–µ—Ç–∞
        function autoSaveSkeleton() {
            const statusEl = document.getElementById('skeletonSaveStatus');
            if (statusEl) {
                statusEl.style.display = 'none';
            }

            if (skeletonSaveTimeout) {
                clearTimeout(skeletonSaveTimeout);
            }

            skeletonSaveTimeout = setTimeout(async () => {
                await saveSkeleton(true);
            }, 1000);
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∫–µ–ª–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function saveSkeleton(silent = false) {
            if (!currentSkeletonType) return;

            // –ù–∞—Ö–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∏–ø–µ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
            const chartType = chartTypesList.find(ct => ct.id === currentSkeletonType);
            const containerName = chartType ? chartType.containerName : '';
            const chartTypeName = chartType ? chartType.chartTypeName : '';
            const { name: currentUserName, login: currentUserLogin } = getUserContext();

            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –Ω–µ –ª–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
            const userName = currentUserName || currentUserLogin;
            if (!userName) {
                console.warn('‚ö†Ô∏è saveSkeleton: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ');
            }

            try {
                const response = await fetch('/api/gantt-skeleton', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chartType: currentSkeletonType,
                        skeleton: currentSkeletonData,
                        columns: skeletonColumns,
                        containerName,
                        chartTypeName,
                        userName: userName || null, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º null –≤–º–µ—Å—Ç–æ '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                        userLogin: currentUserLogin || null
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.ok) {
                        if (!silent) {
                            showMessage('–°–∫–µ–ª–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
                        }
                        const statusEl = document.getElementById('skeletonSaveStatus');
                        if (statusEl) {
                            statusEl.style.display = 'inline';
                            setTimeout(() => {
                                statusEl.style.display = 'none';
                            }, 2000);
                        }
                    } else {
                        if (!silent) {
                            showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∫–µ–ª–µ—Ç–∞', 'error');
                        }
                    }
                } else {
                    if (!silent) {
                        showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∫–µ–ª–µ—Ç–∞', 'error');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∫–µ–ª–µ—Ç–∞:', error);
                if (!silent) {
                    showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∫–µ–ª–µ—Ç–∞', 'error');
                }
            }
        }

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–¢–û–õ–ë–¶–ê–ú–ò ==========
        
        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞–º–∏
        function openColumnsManager() {
            if (!currentSkeletonType) {
                showMessage('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∫–µ–ª–µ—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
                return;
            }
            const modal = document.getElementById('columnsManagerModal');
            if (modal) {
                modal.classList.add('show');
                renderColumnsList();
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞–º–∏
        function closeColumnsManager() {
            const modal = document.getElementById('columnsManagerModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤
        function renderColumnsList() {
            const container = document.getElementById('columnsList');
            if (!container) return;

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–æ–ª–±—Ü—ã –ø–æ –ø–æ—Ä—è–¥–∫—É
            const sortedColumns = [...skeletonColumns].sort((a, b) => a.order - b.order);

            container.innerHTML = sortedColumns.map((column, index) => {
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 12px; margin-bottom: 10px; background: #f5f5f5; border-radius: 8px; border: 1px solid #ddd;">
                        <input type="text" 
                               value="${column.name.replace(/"/g, '&quot;')}" 
                               onchange="updateColumnName('${column.id}', this.value)"
                               style="flex: 1; padding: 8px 12px; border: 2px solid rgba(100, 181, 246, 0.3); border-radius: 5px; font-size: 1rem;"
                               placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞">
                        <span style="color: #666; font-size: 0.9rem;">–ü–æ–ª–µ: <code>${column.field}</code></span>
                        <button class="btn btn-danger" 
                                onclick="deleteColumn('${column.id}')" 
                                style="width: auto; padding: 8px 16px;"
                                ${sortedColumns.length <= 1 ? 'disabled title="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–æ–ª–±–µ—Ü"' : ''}>
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                `;
            }).join('');
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞
        function updateColumnName(columnId, newName) {
            const column = skeletonColumns.find(c => c.id === columnId);
            if (column) {
                column.name = newName.trim() || column.name;
                autoSaveSkeleton();
            }
        }

        // –£–¥–∞–ª–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü
        function deleteColumn(columnId) {
            if (skeletonColumns.length <= 1) {
                showMessage('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–æ–ª–±–µ—Ü', 'error');
                return;
            }
            
            const index = skeletonColumns.findIndex(c => c.id === columnId);
            if (index >= 0) {
                skeletonColumns.splice(index, 1);
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å—Ç–æ–ª–±—Ü–æ–≤
                skeletonColumns.forEach((col, i) => {
                    col.order = i;
                });
                renderColumnsList();
                renderSkeletonTable();
                autoSaveSkeleton();
            }
        }

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
        function openAddColumnModal() {
            const modal = document.getElementById('addColumnModal');
            const form = document.getElementById('addColumnForm');
            const messageEl = document.getElementById('addColumnMessage');
            
            if (modal) {
                modal.classList.add('show');
                if (form) {
                    form.reset();
                }
                if (messageEl) {
                    messageEl.textContent = '';
                    messageEl.className = 'message';
                }
                // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ
                setTimeout(() => {
                    const fieldInput = document.getElementById('newColumnField');
                    if (fieldInput) {
                        fieldInput.focus();
                    }
                }, 100);
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞
        function closeAddColumnModal() {
            const modal = document.getElementById('addColumnModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ —Ñ–æ—Ä–º—ã)
        function addNewColumn() {
            const fieldInput = document.getElementById('newColumnField');
            const nameInput = document.getElementById('newColumnName');
            const messageEl = document.getElementById('addColumnMessage');
            
            if (!fieldInput || !nameInput) return;
            
            const newFieldName = fieldInput.value.trim();
            const newColumnName = nameInput.value.trim();
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª—è
            if (!newFieldName || !/^[a-zA-Z0-9_]+$/.test(newFieldName)) {
                if (messageEl) {
                    messageEl.textContent = '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è';
                    messageEl.className = 'message error show';
                }
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Å—Ç–æ–ª–±–µ—Ü —Å —Ç–∞–∫–∏–º –ø–æ–ª–µ–º
            if (skeletonColumns.find(c => c.field === newFieldName)) {
                if (messageEl) {
                    messageEl.textContent = '–°—Ç–æ–ª–±–µ—Ü —Å —Ç–∞–∫–∏–º –ø–æ–ª–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
                    messageEl.className = 'message error show';
                }
                return;
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è
            if (!newColumnName) {
                if (messageEl) {
                    messageEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞';
                    messageEl.className = 'message error show';
                }
                return;
            }

            const newColumn = {
                id: `col_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                name: newColumnName,
                field: newFieldName,
                order: skeletonColumns.length
            };

            skeletonColumns.push(newColumn);
            closeAddColumnModal();
            renderColumnsList();
            renderSkeletonTable();
            autoSaveSkeleton();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Å–∫–µ–ª–µ—Ç–∞
        document.addEventListener('keydown', function(e) {
            const container = document.getElementById('skeletonEditorContainer');
            if (!container || container.style.display === 'none') {
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–æ–∫—É—Å –Ω–µ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                // Insert - –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –ø–æ—Å–ª–µ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
                if (e.key === 'Insert' || (e.key === 'Enter' && e.ctrlKey)) {
                    e.preventDefault();
                    addSkeletonTask();
                    return;
                }
                // Delete - —É–¥–∞–ª–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ)
                if (e.key === 'Delete' && !e.target.value) {
                    e.preventDefault();
                    deleteSkeletonTask(selectedSkeletonRowIndex);
                    return;
                }
                return;
            }

            // Insert - –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –ø–æ—Å–ª–µ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
            if (e.key === 'Insert' || (e.key === 'Enter' && e.ctrlKey)) {
                e.preventDefault();
                addSkeletonTask();
                return;
            }

                // Delete - —É–¥–∞–ª–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É
            if (e.key === 'Delete' || e.key === 'Del') {
                e.preventDefault();
                deleteSkeletonTask(selectedSkeletonRowIndex);
                return;
            }

            // –°—Ç—Ä–µ–ª–∫–∏ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            if (e.key === 'ArrowUp' && selectedSkeletonRowIndex > 0) {
                e.preventDefault();
                selectSkeletonRow(selectedSkeletonRowIndex - 1);
                return;
            }
            if (e.key === 'ArrowDown' && selectedSkeletonRowIndex < currentSkeletonData.length - 1) {
                e.preventDefault();
                selectSkeletonRow(selectedSkeletonRowIndex + 1);
                return;
            }
        });

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞
        function openCreateSkeletonModal() {
            const modal = document.getElementById('createSkeletonModal');
            const form = document.getElementById('createSkeletonForm');
            const messageEl = document.getElementById('createSkeletonMessage');
            
            if (modal) {
                modal.classList.add('show');
                if (form) {
                    form.reset();
                }
                if (messageEl) {
                    messageEl.textContent = '';
                    messageEl.className = 'message';
                }
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞
        function closeCreateSkeletonModal() {
            const modal = document.getElementById('createSkeletonModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
        document.getElementById('addColumnForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addNewColumn();
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞
        document.getElementById('createSkeletonForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const containerName = document.getElementById('containerName').value.trim();
            const chartTypeName = document.getElementById('chartTypeName').value.trim();
            const { name: currentUserName, login: currentUserLogin } = getUserContext();
            const messageEl = document.getElementById('createSkeletonMessage');
            
            if (!containerName || !chartTypeName) {
                if (messageEl) {
                    messageEl.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                    messageEl.className = 'message error show';
                }
                return;
            }
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –Ω–µ –ª–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
            const userName = currentUserName || currentUserLogin;
            if (!userName) {
                console.warn('‚ö†Ô∏è createSkeletonForm: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ');
            }
            
            try {
                const response = await fetch('/api/chart-types', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        containerName,
                        chartTypeName,
                        userName: userName || null, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º null –≤–º–µ—Å—Ç–æ '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                        userLogin: currentUserLogin || null
                    })
                });
                
                const result = await response.json();
                
                if (result.ok && result.chartType) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤
                    await loadChartTypes();
                    
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞
                    closeCreateSkeletonModal();
                    openSkeletonEditor(result.chartType.id);
                    
                    showMessage('–ù–æ–≤—ã–π —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', 'success');
                } else {
                    if (messageEl) {
                        messageEl.textContent = result.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞';
                        messageEl.className = 'message error show';
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
                if (messageEl) {
                    messageEl.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
                    messageEl.className = 'message error show';
                }
            }
        });

        // –£–¥–∞–ª–∏—Ç—å —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞
        let skeletonTypeToDelete = null;

        function deleteSkeletonType(chartTypeId, chartTypeName) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ–ª—å–∑—è –ª–∏ —É–¥–∞–ª—è—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–∏–ø—ã
            if (chartTypeId === 'icona' || chartTypeId === 'praktis') {
                showMessage('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ (Icona –∏–ª–∏ Praktis ID)', 'error');
                return;
            }
            
            skeletonTypeToDelete = { id: chartTypeId, name: chartTypeName };
            const modal = document.getElementById('deleteSkeletonTypeModal');
            const textEl = document.getElementById('deleteSkeletonTypeText');
            
            if (textEl) {
                textEl.textContent = `–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ "${chartTypeName}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.\n\n‚Ä¢ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –∏—Ö –≥—Ä–∞—Ñ–∏–∫–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –∏ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç —Ä–∞–±–æ—Ç–∞—Ç—å\n‚Ä¢ –°–∫–µ–ª–µ—Ç (—à–∞–±–ª–æ–Ω) –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω\n‚Ä¢ –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ —ç—Ç–æ—Ç —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å–ø–∏—Å–∫–µ`;
            }
            
            if (modal) {
                modal.classList.add('show');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞
        function cancelDeleteSkeletonType() {
            const modal = document.getElementById('deleteSkeletonTypeModal');
            if (modal) {
                modal.classList.remove('show');
            }
            skeletonTypeToDelete = null;
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞
        async function confirmDeleteSkeletonType() {
            if (!skeletonTypeToDelete) {
                cancelDeleteSkeletonType();
                return;
            }

            const { id } = skeletonTypeToDelete;

            try {
                const response = await fetch(`/api/chart-types/${encodeURIComponent(id)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.ok) {
                    showMessage('–¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω', 'success');
                    cancelDeleteSkeletonType();
                    
                    // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ç–µ–∫—É—â–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π —Å–∫–µ–ª–µ—Ç, –∑–∞–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
                    if (currentSkeletonType === id) {
                        document.getElementById('skeletonEditorContainer').style.display = 'none';
                        currentSkeletonType = null;
                        currentSkeletonData = [];
                        selectedSkeletonRowIndex = -1;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤
                    await loadChartTypes();
                } else {
                    showMessage(result.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞', 'error');
                    cancelDeleteSkeletonType();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
                showMessage('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞', 'error');
                cancelDeleteSkeletonType();
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–µ–ª–µ—Ç–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.getElementById('createSkeletonModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCreateSkeletonModal();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        const deleteSkeletonTypeModal = document.getElementById('deleteSkeletonTypeModal');
        if (deleteSkeletonTypeModal) {
            deleteSkeletonTypeModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    cancelDeleteSkeletonType();
                }
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        const addColumnModal = document.getElementById('addColumnModal');
        if (addColumnModal) {
            addColumnModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAddColumnModal();
                }
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞–º–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        const columnsManagerModal = document.getElementById('columnsManagerModal');
        if (columnsManagerModal) {
            columnsManagerModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeColumnsManager();
                }
            });
        }

        // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –õ–û–ì–ê–ú–ò ==========

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        async function loadActivityLogs() {
            try {
                const companyFilter = document.getElementById('logCompanyFilter')?.value || '';
                const userFilter = document.getElementById('logUserFilter')?.value || '';
                
                let url = '/api/activity-logs?limit=1000';
                if (companyFilter) {
                    url += `&companyId=${encodeURIComponent(companyFilter)}`;
                }
                if (userFilter) {
                    url += `&userName=${encodeURIComponent(userFilter)}`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.ok) {
                    renderActivityLogs(result.logs || []);
                } else {
                    showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤', 'error');
                    renderActivityLogs([]);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', error);
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤', 'error');
                renderActivityLogs([]);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ª–æ–≥–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
        function renderActivityLogs(logs) {
            const tbody = document.getElementById('activityLogsTableBody');
            if (!tbody) return;
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #64b5f6;">–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
                return;
            }
            
            tbody.innerHTML = logs.map(log => {
                const userName = log.userName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                const dateTime = log.dateTime || new Date(log.timestamp).toLocaleString('ru-RU');
                let action = log.action || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ';
                const companyId = log.companyId || '';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
                const hasDeletedTasks = log.detailedChanges && Array.isArray(log.detailedChanges) && 
                    log.detailedChanges.some(change => change.changeType === 'deleted');
                
                if (hasDeletedTasks) {
                    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
                    const deletedCount = log.detailedChanges.filter(change => change.changeType === 'deleted').length;
                    const deletedTasks = log.detailedChanges.filter(change => change.changeType === 'deleted');
                    action = `‚ö†Ô∏è –£–î–ê–õ–ò–õ –ó–ê–î–ê–ß–£${deletedCount > 1 ? '–ò' : ''} (${deletedCount})`;
                }
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ –¥–µ—Ç–∞–ª–µ–π, –µ—Å–ª–∏ –µ—Å—Ç—å
                let companyName = companyId;
                let details = log.details || '';
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏, —Ñ–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                if (hasDeletedTasks) {
                    const deletedTasks = log.detailedChanges.filter(change => change.changeType === 'deleted');
                    const deletedDetails = deletedTasks.map(change => {
                        const taskName = change.taskName || `–ó–∞–¥–∞—á–∞ ${change.taskIndex + 1}`;
                        const info = [`"${taskName}"`];
                        if (change.stage) info.push(`–≠—Ç–∞–ø: ${change.stage}`);
                        if (change.oldStartDate) {
                            const dateStr = typeof formatDateForExport === 'function' 
                                ? formatDateForExport(change.oldStartDate) 
                                : change.oldStartDate;
                            info.push(`–ù–∞—á–∞–ª–æ: ${dateStr}`);
                        }
                        if (change.oldEndDate) {
                            const dateStr = typeof formatDateForExport === 'function' 
                                ? formatDateForExport(change.oldEndDate) 
                                : change.oldEndDate;
                            info.push(`–û–∫–æ–Ω—á–∞–Ω–∏–µ: ${dateStr}`);
                        }
                        if (change.oldStatus) {
                            const statusStr = typeof getStatusName === 'function' 
                                ? getStatusName(change.oldStatus) 
                                : change.oldStatus;
                            info.push(`–°—Ç–∞—Ç—É—Å: ${statusStr}`);
                        }
                        return info.join(', ');
                    });
                    details = `–£–î–ê–õ–ï–ù–û: ${deletedDetails.join('; ')}`;
                }
                
                // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ –¥–µ—Ç–∞–ª–µ–π (—Ñ–æ—Ä–º–∞—Ç: "... | –ö–æ–º–ø–∞–Ω–∏—è: –ù–∞–∑–≤–∞–Ω–∏–µ (ID)")
                const companyMatch = details.match(/–ö–æ–º–ø–∞–Ω–∏—è:\s*([^(]+)\s*\(([^)]+)\)/);
                if (companyMatch) {
                    companyName = companyMatch[1].trim() || companyMatch[2];
                    // –£–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ –¥–µ—Ç–∞–ª–µ–π, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
                    details = details.replace(/\s*\|\s*–ö–æ–º–ø–∞–Ω–∏—è:[^|]*$/, '').trim();
                }
                
                // –ï—Å–ª–∏ –∫–æ–º–ø–∞–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—á–µ—Ä–∫
                const companyDisplay = companyName && companyName !== companyId 
                    ? `${companyName} (${companyId})` 
                    : companyId || '‚Äî';
                
                // –°—Ç–∏–ª—å –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á - –∫—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω
                const rowStyle = hasDeletedTasks 
                    ? 'background-color: #ffebee; border-left: 4px solid #f44336;'
                    : '';
                const actionStyle = hasDeletedTasks
                    ? 'color: #d32f2f; font-weight: 700;'
                    : 'color: #1976d2; font-weight: 500;';
                
                return `
                    <tr style="border-bottom: 1px solid rgba(100, 181, 246, 0.2); ${rowStyle}">
                        <td style="padding: 12px; color: #1565c0; font-weight: 600;">${escapeHtml(userName)}</td>
                        <td style="padding: 12px; color: #64b5f6; white-space: nowrap;">${escapeHtml(dateTime)}</td>
                        <td style="padding: 12px; ${actionStyle}">${escapeHtml(action)}</td>
                        <td style="padding: 12px; color: #e91e63; font-weight: 500;">${escapeHtml(companyDisplay)}</td>
                        <td style="padding: 12px; color: #424242; max-width: 400px; word-wrap: break-word;">${escapeHtml(details)}</td>
                    </tr>
                `;
            }).join('');
        }

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤
        function openClearLogsModal() {
            const modal = document.getElementById('clearLogsModal');
            if (modal) {
                modal.classList.add('show');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤
        function cancelClearLogs() {
            const modal = document.getElementById('clearLogsModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—á–∏—Å—Ç–∫—É –ª–æ–≥–æ–≤
        async function confirmClearLogs() {
            try {
                const response = await fetch('/api/activity-logs', {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    showMessage('–õ–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã', 'success');
                    cancelClearLogs();
                    loadActivityLogs();
                } else {
                    showMessage(result.error || '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤', 'error');
                    cancelClearLogs();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤:', error);
                showMessage('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤', 'error');
                cancelClearLogs();
            }
        }

        // –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏ (—Å—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è, —Ç–µ–ø–µ—Ä—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ)
        function clearActivityLogs() {
            openClearLogsModal();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ Excel –∏–ª–∏ TXT
        async function exportActivityLogs(format) {
            try {
                const companyFilter = document.getElementById('logCompanyFilter')?.value || '';
                const userFilter = document.getElementById('logUserFilter')?.value || '';
                
                let url = '/api/activity-logs?limit=10000'; // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ª–æ–≥–∏
                if (companyFilter) {
                    url += `&companyId=${encodeURIComponent(companyFilter)}`;
                }
                if (userFilter) {
                    url += `&userName=${encodeURIComponent(userFilter)}`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (!result.ok || !result.logs) {
                    showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
                    return;
                }
                
                const logs = result.logs || [];
                if (logs.length === 0) {
                    showMessage('–ù–µ—Ç –ª–æ–≥–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
                    return;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏—è—Ö –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π
                let companiesMap = {};
                try {
                    const companiesResponse = await fetch('/api/companies');
                    const companies = await companiesResponse.json();
                    companies.forEach(c => {
                        companiesMap[c.id] = c.name || c.id;
                    });
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏:', e);
                }
                
                if (format === 'excel') {
                    exportToExcel(logs, companiesMap);
                } else if (format === 'txt') {
                    exportToTxt(logs, companiesMap);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ª–æ–≥–æ–≤:', error);
                showMessage('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ª–æ–≥–æ–≤', 'error');
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
        function exportToExcel(logs, companiesMap) {
            if (typeof XLSX === 'undefined') {
                showMessage('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ XLSX –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ xlsx.min.js', 'error');
                return;
            }
            
            const rows = [];
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            rows.push(['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', '–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è', '–î–µ–π—Å—Ç–≤–∏–µ', '–ö–æ–º–ø–∞–Ω–∏—è', '–ó–∞–¥–∞—á–∞', '–ò–∑–º–µ–Ω–µ–Ω–∏–µ', '–°—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ', '–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ']);
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –ª–æ–≥
            logs.forEach(log => {
                const userName = log.userName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                const dateTime = log.dateTime || new Date(log.timestamp).toLocaleString('ru-RU');
                const action = log.action || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ';
                const companyName = companiesMap[log.companyId] || log.companyId || '‚Äî';
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –≤—ã–≤–æ–¥–∏–º –∫–∞–∂–¥–æ–µ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
                if (log.detailedChanges && Array.isArray(log.detailedChanges) && log.detailedChanges.length > 0) {
                    log.detailedChanges.forEach(change => {
                        const taskName = change.taskName || `–ó–∞–¥–∞—á–∞ ${change.taskIndex + 1}`;
                        
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
                        if (change.changeType === 'deleted') {
                            // –î–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –≤—ã–≤–æ–¥–∏–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π
                            const deletedInfo = [];
                            if (change.stage) deletedInfo.push(`–≠—Ç–∞–ø: ${change.stage}`);
                            if (change.control) deletedInfo.push(`–í–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è: ${change.control}`);
                            if (change.oldStartDate) deletedInfo.push(`–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞: ${formatDateForExport(change.oldStartDate)}`);
                            if (change.oldEndDate) deletedInfo.push(`–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: ${formatDateForExport(change.oldEndDate)}`);
                            if (change.oldDays) deletedInfo.push(`–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π: ${change.oldDays}`);
                            if (change.oldStatus) deletedInfo.push(`–°—Ç–∞—Ç—É—Å: ${getStatusName(change.oldStatus)}`);
                            if (change.oldLink) deletedInfo.push(`–°–≤—è–∑—å: ${change.oldLink}`);
                            if (change.oldResponsible) deletedInfo.push(`–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: ${change.oldResponsible}`);
                            
                            rows.push([
                                userName,
                                dateTime,
                                '–£–î–ê–õ–ò–õ –ó–ê–î–ê–ß–£',
                                companyName,
                                taskName,
                                '–£–î–ê–õ–ï–ù–û',
                                deletedInfo.join('; ') || '–ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–µ',
                                '‚Äî'
                            ]);
                            
                            // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –¥–∞—Ç–∞–º, –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É
                            if (change.dateComments && Object.keys(change.dateComments).length > 0) {
                                const commentsList = Object.entries(change.dateComments)
                                    .map(([date, comment]) => `${formatDateForExport(date)}: ${comment}`)
                                    .join('; ');
                                rows.push([
                                    userName,
                                    dateTime,
                                    '–£–î–ê–õ–ò–õ –ó–ê–î–ê–ß–£',
                                    companyName,
                                    taskName,
                                    '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –¥–∞—Ç–∞–º',
                                    commentsList,
                                    '‚Äî'
                                ]);
                            }
                            return; // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∏–∑–º–µ–Ω–µ–Ω–∏—é
                        }
                        
                        // –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
                        if (change.oldStartDate !== change.newStartDate) {
                            rows.push([
                                userName,
                                dateTime,
                                action,
                                companyName,
                                taskName,
                                '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞',
                                formatDateForExport(change.oldStartDate),
                                formatDateForExport(change.newStartDate)
                            ]);
                        }
                        
                        // –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                        if (change.oldEndDate !== change.newEndDate) {
                            rows.push([
                                userName,
                                dateTime,
                                action,
                                companyName,
                                taskName,
                                '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è',
                                formatDateForExport(change.oldEndDate),
                                formatDateForExport(change.newEndDate)
                            ]);
                        }
                        
                        // –†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
                        if (change.oldDays !== change.newDays) {
                            rows.push([
                                userName,
                                dateTime,
                                action,
                                companyName,
                                taskName,
                                '–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π',
                                change.oldDays || '‚Äî',
                                change.newDays || '‚Äî'
                            ]);
                        }
                        
                        // –°—Ç–∞—Ç—É—Å
                        if (change.oldStatus !== change.newStatus) {
                            rows.push([
                                userName,
                                dateTime,
                                action,
                                companyName,
                                taskName,
                                '–°—Ç–∞—Ç—É—Å',
                                getStatusName(change.oldStatus) || '‚Äî',
                                getStatusName(change.newStatus) || '‚Äî'
                            ]);
                        }
                        
                        // –°–≤—è–∑—å
                        if (change.oldLink !== change.newLink) {
                            rows.push([
                                userName,
                                dateTime,
                                action,
                                companyName,
                                taskName,
                                '–°–≤—è–∑—å',
                                change.oldLink || '‚Äî',
                                change.newLink || '‚Äî'
                            ]);
                        }
                        
                        // –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π
                        if (change.oldResponsible !== change.newResponsible) {
                            rows.push([
                                userName,
                                dateTime,
                                action,
                                companyName,
                                taskName,
                                '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π',
                                change.oldResponsible || '‚Äî',
                                change.newResponsible || '‚Äî'
                            ]);
                        }
                        
                        // –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
                        if (change.oldName !== change.newName) {
                            rows.push([
                                userName,
                                dateTime,
                                action,
                                companyName,
                                taskName,
                                '–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏',
                                change.oldName || '‚Äî',
                                change.newName || '‚Äî'
                            ]);
                        }
                        
                        // –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –¥–Ω–µ–π (dateStatusChanges)
                        if (change.dateStatusChanges && Array.isArray(change.dateStatusChanges) && change.dateStatusChanges.length > 0) {
                            change.dateStatusChanges.forEach(dateStatusChange => {
                                rows.push([
                                    userName,
                                    dateTime,
                                    action,
                                    companyName,
                                    taskName,
                                    `–°—Ç–∞—Ç—É—Å –¥–Ω—è (${formatDateForExport(dateStatusChange.date)})`,
                                    dateStatusChange.oldStatusName || '‚Äî',
                                    dateStatusChange.newStatusName || '‚Äî'
                                ]);
                            });
                        }
                    });
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π, –≤—ã–≤–æ–¥–∏–º –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    rows.push([
                        userName,
                        dateTime,
                        action,
                        companyName,
                        '‚Äî',
                        '–û–±—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è',
                        '‚Äî',
                        log.details || '‚Äî'
                    ]);
                }
            });
            
            // –°–æ–∑–¥–∞–µ–º –∫–Ω–∏–≥—É Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(rows);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Å—Ç–æ–ª–±—Ü–æ–≤
            ws['!cols'] = [
                { wch: 20 }, // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                { wch: 20 }, // –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
                { wch: 20 }, // –î–µ–π—Å—Ç–≤–∏–µ
                { wch: 25 }, // –ö–æ–º–ø–∞–Ω–∏—è
                { wch: 40 }, // –ó–∞–¥–∞—á–∞
                { wch: 20 }, // –ò–∑–º–µ–Ω–µ–Ω–∏–µ
                { wch: 25 }, // –°—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                { wch: 25 }  // –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, '–õ–æ–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏');
            XLSX.writeFile(wb, `–õ–æ–≥–∏_–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showMessage('–õ–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ Excel', 'success');
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ TXT
        function exportToTxt(logs, companiesMap) {
            let txtContent = '–õ–û–ì–ò –ê–ö–¢–ò–í–ù–û–°–¢–ò\n';
            txtContent += '='.repeat(100) + '\n\n';
            
            logs.forEach(log => {
                const userName = log.userName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                const dateTime = log.dateTime || new Date(log.timestamp).toLocaleString('ru-RU');
                const action = log.action || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ';
                const companyName = companiesMap[log.companyId] || log.companyId || '‚Äî';
                
                txtContent += `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userName}\n`;
                txtContent += `–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: ${dateTime}\n`;
                txtContent += `–î–µ–π—Å—Ç–≤–∏–µ: ${action}\n`;
                txtContent += `–ö–æ–º–ø–∞–Ω–∏—è: ${companyName}\n`;
                txtContent += '-'.repeat(100) + '\n';
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –≤—ã–≤–æ–¥–∏–º –∫–∞–∂–¥–æ–µ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
                if (log.detailedChanges && Array.isArray(log.detailedChanges) && log.detailedChanges.length > 0) {
                    log.detailedChanges.forEach(change => {
                        const taskName = change.taskName || `–ó–∞–¥–∞—á–∞ ${change.taskIndex + 1}`;
                        
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
                        if (change.changeType === 'deleted') {
                            txtContent += `  ‚ö†Ô∏è –£–î–ê–õ–ï–ù–ê –ó–ê–î–ê–ß–ê: "${taskName}"\n`;
                            if (change.stage) txtContent += `    –≠—Ç–∞–ø: ${change.stage}\n`;
                            if (change.control) txtContent += `    –í–∏–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è: ${change.control}\n`;
                            if (change.oldStartDate) txtContent += `    –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞: ${formatDateForExport(change.oldStartDate)}\n`;
                            if (change.oldEndDate) txtContent += `    –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: ${formatDateForExport(change.oldEndDate)}\n`;
                            if (change.oldDays) txtContent += `    –†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π: ${change.oldDays}\n`;
                            if (change.oldStatus) txtContent += `    –°—Ç–∞—Ç—É—Å: ${getStatusName(change.oldStatus)}\n`;
                            if (change.oldLink) txtContent += `    –°–≤—è–∑—å: ${change.oldLink}\n`;
                            if (change.oldResponsible) txtContent += `    –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: ${change.oldResponsible}\n`;
                            
                            // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –¥–∞—Ç–∞–º
                            if (change.dateComments && Object.keys(change.dateComments).length > 0) {
                                txtContent += `    –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –¥–∞—Ç–∞–º:\n`;
                                Object.entries(change.dateComments).forEach(([date, comment]) => {
                                    txtContent += `      ${formatDateForExport(date)}: ${comment}\n`;
                                });
                            }
                            
                            txtContent += '\n';
                            return; // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∏–∑–º–µ–Ω–µ–Ω–∏—é
                        }
                        
                        txtContent += `  –ó–∞–¥–∞—á–∞: "${taskName}"\n`;
                        
                        // –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
                        if (change.oldStartDate !== change.newStartDate) {
                            txtContent += `    –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞: ${formatDateForExport(change.oldStartDate)} ‚Üí ${formatDateForExport(change.newStartDate)}\n`;
                        }
                        
                        // –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                        if (change.oldEndDate !== change.newEndDate) {
                            txtContent += `    –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: ${formatDateForExport(change.oldEndDate)} ‚Üí ${formatDateForExport(change.newEndDate)}\n`;
                        }
                        
                        // –†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
                        if (change.oldDays !== change.newDays) {
                            txtContent += `    –†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π: ${change.oldDays || '‚Äî'} ‚Üí ${change.newDays || '‚Äî'}\n`;
                        }
                        
                        // –°—Ç–∞—Ç—É—Å
                        if (change.oldStatus !== change.newStatus) {
                            txtContent += `    –°—Ç–∞—Ç—É—Å: ${getStatusName(change.oldStatus) || '‚Äî'} ‚Üí ${getStatusName(change.newStatus) || '‚Äî'}\n`;
                        }
                        
                        // –°–≤—è–∑—å
                        if (change.oldLink !== change.newLink) {
                            txtContent += `    –°–≤—è–∑—å: ${change.oldLink || '‚Äî'} ‚Üí ${change.newLink || '‚Äî'}\n`;
                        }
                        
                        // –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π
                        if (change.oldResponsible !== change.newResponsible) {
                            txtContent += `    –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: ${change.oldResponsible || '‚Äî'} ‚Üí ${change.newResponsible || '‚Äî'}\n`;
                        }
                        
                        // –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
                        if (change.oldName !== change.newName) {
                            txtContent += `    –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏: "${change.oldName || '‚Äî'}" ‚Üí "${change.newName || '‚Äî'}"\n`;
                        }
                        
                        txtContent += '\n';
                    });
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π, –≤—ã–≤–æ–¥–∏–º –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    txtContent += `  ${log.details || '–ù–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'}\n\n`;
                }
                
                txtContent += '='.repeat(100) + '\n\n';
            });
            
            // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `–õ–æ–≥–∏_–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('–õ–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ TXT', 'success');
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
        function formatDateForExport(dateStr) {
            if (!dateStr) return '‚Äî';
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) {
                    // –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        return `${parts[2]}.${parts[1]}.${parts[0]}`;
                    }
                    return dateStr;
                }
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            } catch (e) {
                return dateStr;
            }
        }

        // –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function getStatusName(status) {
            const statusNames = {
                'pending': '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞',
                'in-progress': '–í —Ä–∞–±–æ—Ç–µ',
                'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
                'holiday': '–ü—Ä–∞–∑–¥–Ω–∏–∫',
                'weekend': '–í—ã—Ö–æ–¥–Ω–æ–π'
            };
            return statusNames[status] || status || '‚Äî';
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π –≤ —Ñ–∏–ª—å—Ç—Ä–µ –ª–æ–≥–æ–≤
        function updateLogCompanyFilter() {
            const logCompanyFilter = document.getElementById('logCompanyFilter');
            if (!logCompanyFilter || !allCompanies) return;
            
            logCompanyFilter.innerHTML = '<option value="">–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏</option>';
            allCompanies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = `${company.name} (${company.id})`;
                logCompanyFilter.appendChild(option);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –¥–∞–Ω–Ω—ã—Ö
            if (!checkAuth()) {
                return;
            }
            // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            renderSkeletonButtons();
            // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–∏–ø—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤
            loadCompanies().then(() => {
                updateLogCompanyFilter();
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                loadCompaniesForAdd();
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ä–æ–ª—å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –∫–æ–º–ø–∞–Ω–∏–π
                const userRole = document.getElementById('userRole');
                if (userRole && userRole.value === 'user') {
                    const companiesGroup = document.getElementById('userCompaniesGroup');
                    if (companiesGroup) {
                        companiesGroup.style.display = 'block';
                    }
                }
            });
            loadUsers();
            loadChartTypes();
            loadActivityLogs();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const logCompanyFilter = document.getElementById('logCompanyFilter');
            const logUserFilter = document.getElementById('logUserFilter');
            
            if (logCompanyFilter) {
                logCompanyFilter.addEventListener('change', loadActivityLogs);
            }
            if (logUserFilter) {
                let userFilterTimeout;
                logUserFilter.addEventListener('input', function() {
                    clearTimeout(userFilterTimeout);
                    userFilterTimeout = setTimeout(loadActivityLogs, 500);
                });
            }
        });

        // –≠–∫—Å–ø–æ—Ä—Ç –±—ç–∫–∞–ø–∞ –∫–æ–º–ø–∞–Ω–∏–∏
        async function exportCompanyBackup() {
            const companySelect = document.getElementById('backupCompanySelect');
            const companyId = companySelect ? companySelect.value : '';
            const statusDiv = document.getElementById('backupStatus');
            
            if (!companyId) {
                showBackupStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞', 'error');
                return;
            }
            
            try {
                showBackupStatus('–°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞...', 'info');
                
                const response = await fetch(`/api/company-backup?company=${encodeURIComponent(companyId)}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞');
                }
                
                const backup = await response.json();
                
                // –°–æ–∑–¥–∞–µ–º blob –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-${companyId}-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showBackupStatus(`‚úÖ –ë—ç–∫–∞–ø –∫–æ–º–ø–∞–Ω–∏–∏ "${companyId}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ —Å–∫–∞—á–∞–Ω`, 'success');
                showMessage('–ë—ç–∫–∞–ø —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', 'success');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞:', error);
                showBackupStatus(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞: ${error.message}`, 'error');
                showMessage(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞: ${error.message}`, 'error');
            }
        }

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞
        async function restoreCompanyBackup(event) {
            const file = event.target.files[0];
            const statusDiv = document.getElementById('backupStatus');
            
            if (!file) {
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
            if (!file.name.endsWith('.json')) {
                showBackupStatus('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –í—ã–±–µ—Ä–∏—Ç–µ JSON —Ñ–∞–π–ª', 'error');
                event.target.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input
                return;
            }
            
            try {
                showBackupStatus('–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –±—ç–∫–∞–ø–∞...', 'info');
                
                const text = await file.text();
                const backup = JSON.parse(text);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±—ç–∫–∞–ø–∞
                if (!backup.companyId || (!backup.ganttState && !backup.companyInfo)) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –±—ç–∫–∞–ø–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ');
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –±—ç–∫–∞–ø–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
                backupToRestore = backup;
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                let warningText = `–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ "${backup.companyId}" –∏–∑ –±—ç–∫–∞–ø–∞.\n\n`;
                warningText += `–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç:\n`;
                if (backup.ganttState) {
                    warningText += `‚Ä¢ –ì—Ä–∞—Ñ–∏–∫ —Å–æ –≤—Å–µ–º–∏ –∑–∞–¥–∞—á–∞–º–∏, –¥–∞—Ç–∞–º–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏\n`;
                }
                if (backup.companyInfo) {
                    warningText += `‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏ (–Ω–∞–∑–≤–∞–Ω–∏–µ, –ª–æ–≥–æ—Ç–∏–ø)\n`;
                }
                warningText += `\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                const modal = document.getElementById('restoreBackupModal');
                const textEl = document.getElementById('restoreBackupText');
                
                if (textEl) {
                    textEl.textContent = warningText;
                }
                
                if (modal) {
                    modal.classList.add('show');
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input (—Ñ–∞–π–ª —É–∂–µ –ø—Ä–æ—á–∏—Ç–∞–Ω)
                event.target.value = '';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±—ç–∫–∞–ø–∞:', error);
                showBackupStatus(`‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±—ç–∫–∞–ø–∞: ${error.message}`, 'error');
                showMessage(`–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±—ç–∫–∞–ø–∞: ${error.message}`, 'error');
                event.target.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±—ç–∫–∞–ø–∞
        function cancelRestoreBackup() {
            const modal = document.getElementById('restoreBackupModal');
            if (modal) {
                modal.classList.remove('show');
            }
            backupToRestore = null;
            // –ù–ï —Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ - –æ–Ω–æ –¥–æ–ª–∂–Ω–æ –æ—Å—Ç–∞—Ç—å—Å—è –≤–∏–¥–∏–º—ã–º
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞
        async function confirmRestoreBackup() {
            if (!backupToRestore) {
                cancelRestoreBackup();
                return;
            }

            try {
                showBackupStatus('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...', 'info');
                
                const response = await fetch('/api/company-restore', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(backupToRestore)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±—ç–∫–∞–ø–∞');
                }
                
                const result = await response.json();
                
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±—ç–∫–∞–ø–∞:', result);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                if (result.noChanges) {
                    // –î–∞–Ω–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    let itemsText = [];
                    if (result.restored && result.restored.ganttState) itemsText.push('–≥—Ä–∞—Ñ–∏–∫');
                    if (result.restored && result.restored.companyInfo) itemsText.push('–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏');
                    
                    const messageText = `‚ÑπÔ∏è –ë—ç–∫–∞–ø –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ "${result.companyId}"\n` +
                        `–ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç ‚Äî –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Ç–∞ –∂–µ –≤–µ—Ä—Å–∏—è, —á—Ç–æ —É–∂–µ –µ—Å—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ\n` +
                        (itemsText.length > 0 ? `–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: ${itemsText.join(', ')}` : '');
                    
                    console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π:', messageText);
                    showBackupStatus(messageText, 'info');
                    showMessage(`–ë—ç–∫–∞–ø –∑–∞–≥—Ä—É–∂–µ–Ω. –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç ‚Äî –¥–∞–Ω–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã —Ç–µ–∫—É—â–∏–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ`, 'success');
                } else {
                    // –ï—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
                    let restoredItems = [];
                    if (result.restored && result.restored.ganttState) restoredItems.push('–≥—Ä–∞—Ñ–∏–∫');
                    if (result.restored && result.restored.companyInfo) restoredItems.push('–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏');
                    
                    const messageText = `‚úÖ –ë—ç–∫–∞–ø —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ "${result.companyId}"\n` +
                        `–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${restoredItems.join(', ')}`;
                    
                    console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏:', messageText);
                    showBackupStatus(messageText, 'success');
                    showMessage(`–ë—ç–∫–∞–ø —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ "${result.companyId}"`, 'success');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π
                await loadCompanies();
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                cancelRestoreBackup();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±—ç–∫–∞–ø–∞:', error);
                showBackupStatus(`‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±—ç–∫–∞–ø–∞: ${error.message}`, 'error');
                showMessage(`–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±—ç–∫–∞–ø–∞: ${error.message}`, 'error');
                cancelRestoreBackup();
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –±—ç–∫–∞–ø–∞
        function showBackupStatus(message, type) {
            const statusDiv = document.getElementById('backupStatus');
            if (!statusDiv) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç backupStatus –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }
            
            console.log('showBackupStatus –≤—ã–∑–≤–∞–Ω–∞:', { message, type });
            
            if (!message) {
                statusDiv.style.display = 'none';
                return;
            }
            
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            
            // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–ª–∞—Å—Å—ã
            statusDiv.className = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            if (type === 'success') {
                statusDiv.style.background = 'linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%)';
                statusDiv.style.color = '#2e7d32';
                statusDiv.style.border = '2px solid #4caf50';
            } else if (type === 'error') {
                statusDiv.style.background = 'linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%)';
                statusDiv.style.color = '#c62828';
                statusDiv.style.border = '2px solid #ef5350';
            } else {
                // info –∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π —Ç–∏–ø
                statusDiv.style.background = 'linear-gradient(135deg, #bbdefb 0%, #90caf9 100%)';
                statusDiv.style.color = '#1565c0';
                statusDiv.style.border = '2px solid #2196f3';
            }
            
            statusDiv.style.whiteSpace = 'pre-line';
            statusDiv.style.padding = '15px';
            statusDiv.style.borderRadius = '10px';
            statusDiv.style.marginTop = '10px';
            
            console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, —ç–ª–µ–º–µ–Ω—Ç –≤–∏–¥–∏–º:', statusDiv.style.display);
        }
    </script>
    
    <footer class="footer">
        <p>&copy; 2025 SetlTech. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
    </footer>
</body>
</html>
