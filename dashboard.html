<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>–î–∞—à–±–æ—Ä–¥ ‚Äî DeadlinePro</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <meta property="og:title" content="–î–∞—à–±–æ—Ä–¥ –ø—Ä–æ–µ–∫—Ç–æ–≤ ‚Äî DeadlinePro">
    <meta property="og:description" content="–û–±–∑–æ—Ä –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å –∫–ª—é—á–µ–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π">
    <meta property="og:image" content="logo.png">
    <meta property="og:type" content="website">
    
    <style>
        :root {
            --color-primary: #2196f3;
            --color-primary-hover: #42a5f5;
            --color-bg: #f5f5f5;
            --color-surface: #ffffff;
            --color-text: #212121;
            --color-text-secondary: #757575;
            --color-border: #e0e0e0;
            --color-success: #4caf50;
            --color-warning: #ff9800;
            --color-error: #f44336;
            --color-info: #2196f3;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --color-primary: #42a5f5;
            --color-primary-hover: #64b5f6;
            --color-bg: #121212;
            --color-surface: #1e1e1e;
            --color-text: #e0e0e0;
            --color-text-secondary: #b0b0b0;
            --color-border: #333333;
            --color-success: #66bb6a;
            --color-warning: #ffa726;
            --color-error: #ef5350;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: 
                linear-gradient(135deg, rgba(135, 206, 250, 0.3) 0%, rgba(176, 224, 230, 0.4) 50%, rgba(173, 216, 230, 0.3) 100%),
                radial-gradient(circle at 30% 50%, rgba(100, 180, 255, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, rgba(135, 206, 250, 0.15) 0%, transparent 50%);
            min-height: 100vh;
            padding: 20px;
            color: var(--color-text);
            background-color: var(--color-bg);
        }

        [data-theme="dark"] body {
            background: 
                linear-gradient(135deg, rgba(30, 30, 50, 0.4) 0%, rgba(20, 20, 40, 0.5) 50%, rgba(25, 25, 45, 0.4) 100%),
                radial-gradient(circle at 30% 50%, rgba(40, 40, 60, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, rgba(35, 35, 55, 0.2) 0%, transparent 50%);
        }

        .header {
            max-width: 1400px;
            margin: 0 auto 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: contain;
        }

        .header-title {
            font-size: 28px;
            font-weight: 600;
            color: var(--color-text);
        }

        .header-actions {
            position: relative;
            display: flex;
            gap: 10px;
            align-items: center;
            min-height: 80px;
            padding-right: 100px;
        }

        /* –ö—Ä—É–≥–ª—ã–µ –∫–Ω–æ–ø–∫–∏ –∫–∞–∫ –≤ companies.html */
        .companies-btn,
        .theme-toggle-btn,
        .pdf-export-btn {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #2c2c2c;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            overflow: visible;
            background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
            text-decoration: none;
            opacity: 0;
            transform: scale(0.8);
        }

        .companies-btn.show,
        .theme-toggle-btn.show,
        .pdf-export-btn.show {
            animation: fadeInScale 0.4s ease forwards;
        }

        .companies-btn {
            top: 30px;
            right: 80px;
        }

        .pdf-export-btn {
            top: 30px;
            right: 130px;
            background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
        }

        /* –ó–æ–ª–æ—Ç–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ PDF */
        .pdf-export-btn::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(255, 215, 0, 0.8);
            top: 50%;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            opacity: 0;
            z-index: 1001;
            transition: opacity 0.3s ease;
        }

        .pdf-export-btn:hover::after {
            opacity: 1;
            animation: rotateDot 2s linear infinite;
        }

        .theme-toggle-btn {
            top: 30px;
            right: 30px;
        }

        .companies-btn:hover:not(.animating),
        .theme-toggle-btn:hover:not(.animating),
        .pdf-export-btn:hover:not(.animating) {
            transform: translateY(-2px) scale(1.05) !important;
            box-shadow: 0 4px 12px rgba(66, 165, 245, 0.4) !important;
        }

        /* –ó–æ–ª–æ—Ç–∞—è —Ç–æ—á–∫–∞ */
        .companies-btn::after,
        .theme-toggle-btn::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(255, 215, 0, 0.8);
            top: 50%;
            left: 50%;
            transform: rotate(0deg) translateY(-20px) translateX(-50%);
            transform-origin: center center;
            opacity: 0;
            z-index: 1001;
            transition: opacity 0.3s ease;
        }

        .companies-btn:hover::after,
        .theme-toggle-btn:hover::after {
            opacity: 1 !important;
            animation: rotateDot 2s linear infinite !important;
        }

        .companies-btn-icon {
            width: 18px;
            height: 18px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='3' width='7' height='7'%3E%3C/rect%3E%3Crect x='14' y='3' width='7' height='7'%3E%3C/rect%3E%3Crect x='14' y='14' width='7' height='7'%3E%3C/rect%3E%3Crect x='3' y='14' width='7' height='7'%3E%3C/rect%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 1002;
        }

        .theme-toggle-btn::before {
            content: 'üåô';
            font-size: 20px;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.3s ease;
            display: inline-block;
            z-index: 1003;
            position: relative;
        }

        [data-theme="dark"] .theme-toggle-btn::before {
            content: '‚òÄÔ∏è';
        }

        @keyframes rotateDot {
            0% {
                transform: rotate(0deg) translateX(-50%) translateY(-20px);
            }
            100% {
                transform: rotate(360deg) translateX(-50%) translateY(-20px);
            }
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .companies-tooltip,
        .theme-tooltip,
        .pdf-export-tooltip {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            border-radius: 8px;
            background: #000000;
            color: #ffffff;
            font-size: 0.75rem;
            white-space: normal;
            min-width: max-content;
            max-width: 200px;
            word-wrap: break-word;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 10001;
            width: auto;
            height: auto;
        }

        .companies-btn[data-tooltip]:hover .companies-tooltip,
        .theme-toggle-btn[data-tooltip]:hover .theme-tooltip,
        .pdf-export-btn[data-tooltip]:hover .pdf-export-tooltip {
            opacity: 1 !important;
            transition-delay: 0.3s;
        }

        .pdf-export-btn::before {
            content: '';
            width: 20px;
            height: 20px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            display: inline-block;
            z-index: 1003;
            position: relative;
        }

        .pdf-export-btn:hover:not(.animating) {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(66, 165, 245, 0.4);
        }

        .filters {
            max-width: 1400px;
            margin: 0 auto 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-label {
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        .filter-select {
            padding: 10px 16px;
            border: 1px solid var(--color-border);
            border-radius: 14px;
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 14px;
            cursor: pointer;
            min-width: 150px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12' fill='none'%3E%3Cpath d='M2 4L6 8L10 4' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            padding-right: 36px;
        }

        .filter-select:hover {
            border-color: var(--color-primary);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
            transform: translateY(-1px);
        }

        .filter-select:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.15), 0 2px 8px rgba(33, 150, 243, 0.1);
            transform: translateY(-1px);
        }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ */
        .custom-select-wrapper {
            position: relative;
            min-width: 150px;
        }

        .custom-select {
            position: relative;
            cursor: pointer;
        }

        .custom-select-trigger {
            padding: 10px 16px;
            padding-right: 36px;
            border: 1px solid var(--color-border);
            border-radius: 14px;
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12' fill='none'%3E%3Cpath d='M2 4L6 8L10 4' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
        }

        .custom-select-trigger:hover {
            border-color: var(--color-primary);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
            transform: translateY(-1px);
        }

        .custom-select.open .custom-select-trigger {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.15), 0 2px 8px rgba(33, 150, 243, 0.1);
        }

        .custom-select-options {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 14px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px) scale(0.95);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 0;
        }

        .custom-select.open .custom-select-options {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: all;
            max-height: 300px;
        }

        .custom-select-option {
            padding: 10px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            color: var(--color-text);
            font-size: 14px;
        }

        .custom-select-option:first-child {
            border-top-left-radius: 14px;
            border-top-right-radius: 14px;
        }

        .custom-select-option:last-child {
            border-bottom-left-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        .custom-select-option:hover {
            background: rgba(33, 150, 243, 0.1);
            color: var(--color-primary);
        }

        .custom-select-option.selected {
            background: rgba(33, 150, 243, 0.15);
            color: var(--color-primary);
            font-weight: 500;
        }

        .stats-overview {
            max-width: 1400px;
            margin: 0 auto 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-border);
        }

        .stat-label {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: var(--color-text);
        }

        .stat-value.success {
            color: var(--color-success);
        }

        .stat-value.warning {
            color: var(--color-warning);
        }

        .stat-value.error {
            color: var(--color-error);
        }

        .companies-grid {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .company-card {
            background: var(--color-surface);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-border);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .company-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-primary);
        }

        .company-card.has-overdue {
            border-left: 4px solid var(--color-error);
        }

        .company-card.has-upcoming {
            border-left: 4px solid var(--color-warning);
        }

        .company-card.archived {
            position: relative;
        }

        .archive-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.95) 0%, rgba(211, 47, 47, 0.95) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(244, 67, 54, 0.8);
            border-radius: 6px;
            padding: 6px 12px;
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.4), 
                        0 0 0 1px rgba(255, 255, 255, 0.1) inset,
                        0 1px 2px rgba(0, 0, 0, 0.2);
            z-index: 10;
            transform: rotate(-2deg);
            font-family: 'Courier New', monospace;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .company-card-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 16px;
        }

        .company-logo {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: contain;
            background: var(--color-bg);
            padding: 4px;
            flex-shrink: 0;
        }

        .company-info {
            flex: 1;
            min-width: 0;
        }

        .company-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 4px;
            word-break: break-word;
        }

        .company-id {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .company-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .metric {
            display: flex;
            flex-direction: column;
        }

        .metric-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-text);
        }

        .metric-value.success {
            color: var(--color-success);
        }

        .metric-value.warning {
            color: var(--color-warning);
        }

        .metric-value.error {
            color: var(--color-error);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--color-bg);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-success), var(--color-primary));
            transition: width 0.3s ease;
        }

        .company-summary {
            margin-top: 16px;
            padding: 14px;
            background: linear-gradient(135deg, var(--color-bg) 0%, var(--color-surface) 100%);
            border-radius: 10px;
            border: 2px solid rgba(33, 150, 243, 0.3);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.08);
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .company-summary {
            background: linear-gradient(135deg, rgba(30, 30, 40, 0.8) 0%, rgba(40, 40, 50, 0.9) 100%);
            border-color: rgba(66, 165, 245, 0.4);
        }

        .company-summary:hover {
            border-color: var(--color-primary);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.12);
        }

        [data-theme="dark"] .company-summary:hover {
            border-color: rgba(66, 165, 245, 0.6);
            box-shadow: 0 4px 12px rgba(66, 165, 245, 0.2);
        }

        .company-summary-label {
            font-size: 13px;
            color: var(--color-primary);
            margin-bottom: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .company-summary-label::before {
            content: '';
            width: 16px;
            height: 16px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232196f3'%3E%3Cpath d='M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .company-summary-input {
            width: 100%;
            min-height: 80px;
            padding: 12px 14px;
            font-size: 13px;
            font-family: inherit;
            line-height: 1.6;
            color: var(--color-text);
            background: var(--color-surface);
            border: 2px solid rgba(33, 150, 243, 0.3);
            border-radius: 8px;
            resize: none;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .company-summary-input {
            background: rgba(50, 50, 60, 0.6);
            border-color: rgba(66, 165, 245, 0.4);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .company-summary-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px rgba(33, 150, 243, 0.15), inset 0 1px 3px rgba(0, 0, 0, 0.05);
            background: var(--color-surface);
        }

        [data-theme="dark"] .company-summary-input:focus {
            background: rgba(60, 60, 70, 0.8);
            box-shadow: 0 0 0 4px rgba(66, 165, 245, 0.2), inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .company-summary-input:disabled {
            background: var(--color-bg);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .company-summary-input::placeholder {
            color: var(--color-text-secondary);
            opacity: 0.5;
            font-style: italic;
        }

        .company-summary-save-btn {
            display: none;
            margin-top: 10px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
            align-self: flex-start;
        }

        .company-summary-save-btn:hover {
            background: linear-gradient(135deg, #45a049 0%, #388e3c 100%);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
            transform: translateY(-1px);
        }

        .company-summary-save-btn:active {
            transform: translateY(0);
        }

        .company-summary-save-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .company-summary.has-focus .company-summary-save-btn {
            display: block;
        }

        .company-summary-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –≤ —Å–µ–∫—Ü–∏—è—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤ –∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á */
        .deadline-task-name,
        .deadline-task-info {
            color: var(--color-text) !important;
        }

        [data-theme="dark"] .deadline-task-name,
        [data-theme="dark"] .deadline-task-info {
            color: #ffffff !important;
        }

        .company-actions {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--color-border);
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            flex: 1;
        }

        .btn-open-gantt {
            display: inline-block;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            color: white;
            background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 50%, #2196f3 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
            width: 100%;
            text-align: center;
        }

        .btn-open-gantt:hover {
            background: linear-gradient(135deg, #90caf9 0%, #64b5f6 50%, #42a5f5 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .btn-open-gantt:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);
        }

        /* –°–≤–µ—Ç–ª—è—á–∫–∏ */
        .firefly {
            position: fixed;
            left: 0;
            top: 0;
            width: 8px;
            height: 8px;
            background: rgba(186, 104, 200, 0.8);
            border-radius: 50%;
            box-shadow: 
                0 0 12px rgba(186, 104, 200, 1),
                0 0 24px rgba(186, 104, 200, 0.8),
                0 0 36px rgba(186, 104, 200, 0.6),
                0 0 48px rgba(186, 104, 200, 0.4);
            pointer-events: none;
            z-index: 1;
            will-change: transform;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-secondary);
            font-size: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 24px;
        }


        @media (max-width: 768px) {
            .companies-grid {
                grid-template-columns: 1fr;
            }

            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                padding-bottom: 100px;
            }

            .header-actions {
                position: fixed;
                top: 15px;
                right: 15px;
                z-index: 1000;
                min-height: 60px;
                padding-right: 150px;
            }

            .companies-btn {
                top: 15px;
                right: 115px;
            }

            .pdf-export-btn {
                top: 15px;
                right: 65px;
            }

            .theme-toggle-btn {
                top: 15px;
                right: 15px;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- –ù–∞–¥–ø–∏—Å—å DeadLinePro –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
    <div style="position: fixed; top: 20px; right: 20px; z-index: 9999; font-size: 32px; font-weight: 600; color: rgba(33, 150, 243, 0.5); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; pointer-events: none; user-select: none;">DeadLinePro</div>
    <!-- –°–≤–µ—Ç–ª—è—á–∫–∏ -->
    <div class="firefly" id="dashboard-firefly-1"></div>
    <div class="firefly" id="dashboard-firefly-2"></div>
    <div class="firefly" id="dashboard-firefly-3"></div>
    <div class="firefly" id="dashboard-firefly-4"></div>
    <div class="firefly" id="dashboard-firefly-5"></div>
    <div class="firefly" id="dashboard-firefly-6"></div>
    <div class="firefly" id="dashboard-firefly-7"></div>
    <div class="firefly" id="dashboard-firefly-8"></div>
    <div class="firefly" id="dashboard-firefly-9"></div>
    <div class="firefly" id="dashboard-firefly-10"></div>
    <div class="firefly" id="dashboard-firefly-11"></div>
    <div class="firefly" id="dashboard-firefly-12"></div>
    
    <div class="header">
        <div class="header-left">
            <img src="logo.png" alt="Logo" class="logo" onerror="this.src='favicon.png'">
            <h1 class="header-title">–î–∞—à–±–æ—Ä–¥ –ø—Ä–æ–µ–∫—Ç–æ–≤</h1>
        </div>
        <div class="header-actions">
            <a href="companies.html" class="companies-btn" id="companiesBtn" data-tooltip="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏—è–º–∏">
                <span class="companies-btn-icon"></span>
                <span class="companies-tooltip">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏—è–º–∏</span>
            </a>
            <button class="pdf-export-btn" id="pdfExportBtn" data-tooltip="–í—ã–≥—Ä—É–∑–∏—Ç—å –¥–∞—à–±–æ—Ä–¥ –≤ PDF" onclick="showPDFExportModal()">
                <span class="pdf-export-tooltip">–í—ã–≥—Ä—É–∑–∏—Ç—å –¥–∞—à–±–æ—Ä–¥ –≤ PDF</span>
            </button>
            <button class="theme-toggle-btn" id="themeToggleBtn" data-tooltip="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" onclick="toggleTheme()">
                <span class="theme-tooltip">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É</span>
            </button>
        </div>
    </div>

    <div class="filters">
        <div class="filter-group">
            <label class="filter-label">–°—Ç–∞—Ç—É—Å:</label>
            <div class="custom-select-wrapper">
                <div class="custom-select" id="statusFilterCustom">
                    <div class="custom-select-trigger" id="statusFilterTrigger">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</div>
                    <div class="custom-select-options">
                        <div class="custom-select-option selected" data-value="all">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</div>
                        <div class="custom-select-option" data-value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</div>
                        <div class="custom-select-option" data-value="archived">–ê—Ä—Ö–∏–≤–Ω—ã–µ</div>
                    </div>
                </div>
                <select class="filter-select" id="statusFilter" style="display: none;">
                    <option value="all" selected>–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>
                    <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="archived">–ê—Ä—Ö–∏–≤–Ω—ã–µ</option>
                </select>
            </div>
        </div>
        <div class="filter-group">
            <label class="filter-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
            <div class="custom-select-wrapper">
                <div class="custom-select" id="sortFilterCustom">
                    <div class="custom-select-trigger" id="sortFilterTrigger">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</div>
                    <div class="custom-select-options">
                        <div class="custom-select-option selected" data-value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</div>
                        <div class="custom-select-option" data-value="progress">–ü–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É</div>
                        <div class="custom-select-option" data-value="deadline">–ü–æ –¥–µ–¥–ª–∞–π–Ω—É</div>
                        <div class="custom-select-option" data-value="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –ø–µ—Ä–≤—ã–º–∏</div>
                    </div>
                </div>
                <select class="filter-select" id="sortFilter" style="display: none;">
                    <option value="name" selected>–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                    <option value="progress">–ü–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É</option>
                    <option value="deadline">–ü–æ –¥–µ–¥–ª–∞–π–Ω—É</option>
                    <option value="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –ø–µ—Ä–≤—ã–º–∏</option>
                </select>
            </div>
        </div>
        <div class="filter-group">
            <input type="text" class="filter-select" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
        </div>
    </div>

    <div class="stats-overview" id="statsOverview">
        <div class="stat-card">
            <div class="stat-label">–í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤</div>
            <div class="stat-value" id="totalProjects">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
            <div class="stat-value" id="totalTasks">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</div>
            <div class="stat-value error" id="overdueTasks">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
            <div class="stat-value success" id="avgProgress">0%</div>
        </div>
    </div>

    <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    <div id="emptyState" class="empty-state" style="display: none;">
        <div class="empty-state-icon">üìä</div>
        <div class="empty-state-title">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</div>
        <div class="empty-state-text">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∫–æ–º–ø–∞–Ω–∏—é, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</div>
        <a href="companies.html" class="btn btn-primary" style="margin-top: 20px;">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</a>
    </div>
    <div id="companiesGrid" class="companies-grid" style="display: none;"></div>

    <script>
        // ========== –¢–ï–ú–ê ==========
        function initTheme() {
            const savedTheme = localStorage.getItem('gantt-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('gantt-theme', newTheme);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        function checkAdminRole() {
            const userStr = localStorage.getItem('gantt-user');
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    isAdmin = user.role === 'admin';
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏:', e);
                    isAdmin = false;
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initTheme();
                checkAdminRole();
                showButtons();
                initCustomSelects();
            });
        } else {
            initTheme();
            checkAdminRole();
            showButtons();
            initCustomSelects();
        }

        function showButtons() {
            const companiesBtn = document.getElementById('companiesBtn');
            const pdfExportBtn = document.getElementById('pdfExportBtn');
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            
            if (companiesBtn) {
                setTimeout(() => {
                    companiesBtn.classList.add('show');
                }, 100);
            }
            
            if (pdfExportBtn) {
                setTimeout(() => {
                    pdfExportBtn.classList.add('show');
                }, 150);
            }
            
            if (themeToggleBtn) {
                setTimeout(() => {
                    themeToggleBtn.classList.add('show');
                }, 200);
            }
        }

        // ========== –§–£–ù–ö–¶–ò–ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò ==========
        function escapeHtml(text) {
            if (text == null) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== –î–ê–ù–ù–´–ï ==========
        let allCompanies = [];
        let allStats = [];
        let filteredCompanies = [];
        let isAdmin = false;

        // ========== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ==========
        async function loadCompanies() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
                const activeResponse = await fetch('/api/companies');
                if (!activeResponse.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π');
                }
                const activeCompanies = await activeResponse.json();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ö–∏–≤–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
                const archivedResponse = await fetch('/api/companies?archived=true');
                let archivedCompanies = [];
                if (archivedResponse.ok) {
                    archivedCompanies = await archivedResponse.json();
                }
                
                // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏
                allCompanies = [...activeCompanies, ...archivedCompanies];
                await loadStats();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π:', error);
                document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
            }
        }

        async function loadStats() {
            allStats = [];
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏—è—Ö –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
            const promises = allCompanies.map(async (company) => {
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ —Ä–µ–∑—é–º–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
                    const [ganttResponse, infoResponse, summaryResponse] = await Promise.all([
                        fetch(`/api/gantt-state?company=${encodeURIComponent(company.id)}`),
                        fetch(`/api/company-info?company=${encodeURIComponent(company.id)}`),
                        fetch(`/api/company-summary?company=${encodeURIComponent(company.id)}`)
                    ]);

                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–æ—Ç–∏–ø –∫–æ–º–ø–∞–Ω–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (infoResponse.ok) {
                        const companyInfo = await infoResponse.json();
                        if (companyInfo && companyInfo.logoData) {
                            company.logoData = companyInfo.logoData;
                        }
                        if (companyInfo && companyInfo.name) {
                            company.name = companyInfo.name;
                        }
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Å—å –æ–±—ä–µ–∫—Ç companyInfo –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                        if (companyInfo) {
                            company.companyInfo = companyInfo;
                        }
                    }

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—é–º–µ –∏–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ endpoint
                    if (summaryResponse.ok) {
                        const summaryData = await summaryResponse.json();
                        if (summaryData && summaryData.summary !== undefined) {
                            company.summary = summaryData.summary;
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                            originalSummaryValues[company.id] = summaryData.summary;
                        }
                    }

                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
                    if (ganttResponse.ok) {
                        const ganttData = await ganttResponse.json();
                        if (ganttData && ganttData.tasks && Array.isArray(ganttData.tasks)) {
                            const stats = calculateStats(ganttData.tasks);
                            return {
                                companyId: company.id,
                                ...stats
                            };
                        }
                    }

                    // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö - –ø—É—Å—Ç–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    return {
                        companyId: company.id,
                        totalTasks: 0,
                        completedTasks: 0,
                        inProgressTasks: 0,
                        pendingTasks: 0,
                        overdueTasks: 0,
                        overdueTasksList: [],
                        upcomingDeadlines: 0,
                        upcomingDeadlinesList: [],
                        progress: 0,
                        lastTaskDate: null,
                        projectStartDate: null,
                        projectEndDate: null
                    };
                } catch (error) {
                    console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è ${company.id}:`, error);
                    return {
                        companyId: company.id,
                        totalTasks: 0,
                        completedTasks: 0,
                        inProgressTasks: 0,
                        pendingTasks: 0,
                        overdueTasks: 0,
                        overdueTasksList: [],
                        upcomingDeadlines: 0,
                        upcomingDeadlinesList: [],
                        progress: 0,
                        lastTaskDate: null,
                        projectStartDate: null,
                        projectEndDate: null
                    };
                }
            });

            allStats = await Promise.all(promises);

            applyFilters();
            renderDashboard();
        }

        function calculateStats(tasks) {
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            const sevenDaysLater = new Date(now);
            sevenDaysLater.setDate(sevenDaysLater.getDate() + 7);

            let totalTasks = tasks.length;
            let completedTasks = 0;
            let inProgressTasks = 0;
            let pendingTasks = 0;
            let overdueTasks = 0;
            let upcomingDeadlines = 0;
            let lastTaskDate = null;
            let projectStartDate = null; // –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞—á)
            let projectEndDate = null; // –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∑–∞–¥–∞—á)
            const overdueTasksList = []; // –ú–∞—Å—Å–∏–≤ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
            const upcomingDeadlinesList = []; // –ú–∞—Å—Å–∏–≤ –±–ª–∏–∂–∞–π—à–∏—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤

            tasks.forEach(task => {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
                const status = task.status || 'pending';
                if (status === 'completed') {
                    completedTasks++;
                } else if (status === 'in-progress') {
                    inProgressTasks++;
                } else {
                    pendingTasks++;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞—á–∏
                const startDate = task.startDate ? new Date(task.startDate) : null;
                if (startDate) {
                    startDate.setHours(0, 0, 0, 0);
                    if (!projectStartDate || startDate < projectStartDate) {
                        projectStartDate = startDate;
                    }
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–¥–ª–∞–π–Ω
                const endDate = task.endDate ? new Date(task.endDate) : null;
                if (endDate) {
                    endDate.setHours(0, 0, 0, 0);

                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–∞—Ç—É
                    if (!lastTaskDate || endDate > lastTaskDate) {
                        lastTaskDate = endDate;
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
                    if (!projectEndDate || endDate > projectEndDate) {
                        projectEndDate = endDate;
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã –∏ –¥–∞—Ç–∞ –ø—Ä–æ—à–ª–∞)
                    if (status !== 'completed' && endDate < now) {
                        overdueTasks++;
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–π –∑–∞–¥–∞—á–µ
                        const taskName = task.task || task.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                        overdueTasksList.push({
                            name: taskName,
                            deadline: endDate,
                            daysOverdue: Math.floor((now - endDate) / (1000 * 60 * 60 * 24))
                        });
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–∏–∂–∞–π—à–∏–µ –¥–µ–¥–ª–∞–π–Ω—ã (–≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π)
                    if (status !== 'completed' && endDate >= now && endDate <= sevenDaysLater) {
                        upcomingDeadlines++;
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–ª–∏–∂–∞–π—à–µ–º –¥–µ–¥–ª–∞–π–Ω–µ
                        const taskName = task.task || task.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                        const daysUntil = Math.floor((endDate - now) / (1000 * 60 * 60 * 24));
                        upcomingDeadlinesList.push({
                            name: taskName,
                            deadline: endDate,
                            daysUntil: daysUntil
                        });
                    }
                }
            });

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ –¥–∞—Ç–µ (–±–ª–∏–∂–∞–π—à–∏–µ –ø–µ—Ä–≤—ã–º–∏)
            overdueTasksList.sort((a, b) => b.deadline - a.deadline);
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –±–ª–∏–∂–∞–π—à–∏–µ –¥–µ–¥–ª–∞–π–Ω—ã –ø–æ –¥–∞—Ç–µ (–±–ª–∏–∂–∞–π—à–∏–µ –ø–µ—Ä–≤—ã–º–∏)
            upcomingDeadlinesList.sort((a, b) => a.deadline - b.deadline);

            const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            return {
                totalTasks,
                completedTasks,
                inProgressTasks,
                pendingTasks,
                overdueTasks,
                overdueTasksList, // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
                upcomingDeadlines,
                upcomingDeadlinesList, // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –±–ª–∏–∂–∞–π—à–∏—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤
                progress,
                lastTaskDate,
                projectStartDate, // –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞
                projectEndDate // –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
            };
        }

        // ========== –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ò –°–û–†–¢–ò–†–û–í–ö–ê ==========
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            filteredCompanies = allCompanies.map(company => {
                const stats = allStats.find(s => s.companyId === company.id) || {
                    totalTasks: 0,
                    completedTasks: 0,
                    progress: 0,
                    overdueTasks: 0,
                    upcomingDeadlines: 0,
                    lastTaskDate: null
                };

                return { company, stats };
            });

            // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
            if (statusFilter === 'archived') {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞—Ä—Ö–∏–≤–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
                filteredCompanies = filteredCompanies.filter(({ company }) => company.archived === true);
            } else if (statusFilter === 'active') {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
                filteredCompanies = filteredCompanies.filter(({ company }) => !company.archived);
            }
            // –ï—Å–ª–∏ statusFilter === 'all', –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)

            // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É
            if (searchInput) {
                filteredCompanies = filteredCompanies.filter(({ company }) =>
                    company.name.toLowerCase().includes(searchInput) ||
                    company.id.toLowerCase().includes(searchInput)
                );
            }

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ (–∞—Ä—Ö–∏–≤–Ω—ã–µ –≤—Å–µ–≥–¥–∞ –≤ –∫–æ–Ω—Ü–µ)
            filteredCompanies.sort((a, b) => {
                // –°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –∞—Ä—Ö–∏–≤–Ω—ã–µ –∏ –Ω–µ–∞—Ä—Ö–∏–≤–Ω—ã–µ
                const aArchived = a.company.archived === true;
                const bArchived = b.company.archived === true;
                
                // –ï—Å–ª–∏ –æ–¥–∏–Ω –∞—Ä—Ö–∏–≤–Ω—ã–π, –∞ –¥—Ä—É–≥–æ–π –Ω–µ—Ç - –∞—Ä—Ö–∏–≤–Ω—ã–π –∏–¥–µ—Ç –≤ –∫–æ–Ω–µ—Ü
                if (aArchived && !bArchived) return 1;
                if (!aArchived && bArchived) return -1;
                
                // –ï—Å–ª–∏ –æ–±–∞ –∞—Ä—Ö–∏–≤–Ω—ã–µ –∏–ª–∏ –æ–±–∞ –Ω–µ–∞—Ä—Ö–∏–≤–Ω—ã–µ - –ø—Ä–∏–º–µ–Ω—è–µ–º –æ–±—ã—á–Ω—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
                switch (sortFilter) {
                    case 'name':
                        return a.company.name.localeCompare(b.company.name);
                    case 'progress':
                        return b.stats.progress - a.stats.progress;
                    case 'deadline':
                        if (!a.stats.lastTaskDate && !b.stats.lastTaskDate) return 0;
                        if (!a.stats.lastTaskDate) return 1;
                        if (!b.stats.lastTaskDate) return -1;
                        return a.stats.lastTaskDate - b.stats.lastTaskDate;
                    case 'overdue':
                        return b.stats.overdueTasks - a.stats.overdueTasks;
                    default:
                        return 0;
                }
            });
        }

        // ========== –†–ï–ù–î–ï–†–ò–ù–ì ==========
        function renderDashboard() {
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('emptyState');
            const companiesGrid = document.getElementById('companiesGrid');

            loading.style.display = 'none';

            if (filteredCompanies.length === 0) {
                emptyState.style.display = 'block';
                companiesGrid.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            companiesGrid.style.display = 'grid';

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateOverallStats();

            // –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π
            companiesGrid.innerHTML = filteredCompanies.map(({ company, stats }) => {
                const logoData = company.logoData || '';
                const hasOverdue = stats.overdueTasks > 0;
                const hasUpcoming = stats.upcomingDeadlines > 0;
                const isArchived = company.archived === true;
                
                let cardClass = 'company-card';
                if (isArchived) cardClass += ' archived';
                if (hasOverdue) cardClass += ' has-overdue';
                else if (hasUpcoming) cardClass += ' has-upcoming';

                const lastTaskDateStr = stats.lastTaskDate 
                    ? new Date(stats.lastTaskDate).toLocaleDateString('ru-RU')
                    : '‚Äî';

                const firstLetter = company.name ? company.name.charAt(0).toUpperCase() : '?';
                const logoContainerId = `logo-${company.id.replace(/[^a-zA-Z0-9]/g, '-')}`;
                const logoHtml = logoData 
                    ? `<img src="${escapeHtml(logoData)}" alt="${escapeHtml(company.name)}" class="company-logo" id="${logoContainerId}-img" onerror="document.getElementById('${logoContainerId}-fallback').style.display='flex'; this.style.display='none';">`
                    : '';
                const fallbackLogo = `<div class="company-logo" id="${logoContainerId}-fallback" style="background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover)); display: ${logoData ? 'none' : 'flex'}; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 24px; border-radius: 8px;">${escapeHtml(firstLetter)}</div>`;

                const summaryValue = company.summary || '';
                const summaryInputId = `summary-${company.id.replace(/[^a-zA-Z0-9]/g, '-')}`;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                if (!originalSummaryValues[company.id]) {
                    originalSummaryValues[company.id] = summaryValue;
                }
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                const startDateStr = stats.projectStartDate 
                    ? new Date(stats.projectStartDate).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' })
                    : '‚Äî';
                const endDateStr = stats.projectEndDate 
                    ? new Date(stats.projectEndDate).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' })
                    : '‚Äî';
                
                return `
                    <div class="${cardClass}">
                        ${isArchived ? '<div class="archive-badge">–ê—Ä—Ö–∏–≤</div>' : ''}
                        <div class="company-card-header">
                            ${logoHtml}
                            ${fallbackLogo}
                            <div class="company-info">
                                <div class="company-name">${escapeHtml(company.name)}</div>
                                <div class="company-id">ID: ${escapeHtml(company.id)}</div>
                                <div style="display: flex; gap: 15px; margin-top: 6px; font-size: 11px; color: var(--color-text-secondary);">
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="var(--color-primary)" xmlns="http://www.w3.org/2000/svg" style="opacity: 0.8;">
                                            <path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2.5-9H19V1h-2v1H7V1H5v1H3.5C2.67 2 2 2.67 2 3.5v17C2 21.33 2.67 22 3.5 22h17c.83 0 1.5-.67 1.5-1.5v-17C22 2.67 21.33 2 20.5 2zM20 20H4V9h16v11z"/>
                                        </svg>
                                        <span style="font-weight: 500; color: var(--color-primary);">–ù–∞—á–∞–ª–æ:</span> ${startDateStr}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="var(--color-error)" xmlns="http://www.w3.org/2000/svg" style="opacity: 0.8;">
                                            <path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2.5-9H19V1h-2v1H7V1H5v1H3.5C2.67 2 2 2.67 2 3.5v17C2 21.33 2.67 22 3.5 22h17c.83 0 1.5-.67 1.5-1.5v-17C22 2.67 21.33 2 20.5 2zM20 20H4V9h16v11z"/>
                                        </svg>
                                        <span style="font-weight: 500; color: var(--color-error);">–û–∫–æ–Ω—á–∞–Ω–∏–µ:</span> ${endDateStr}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="company-metrics">
                            <div class="metric">
                                <div class="metric-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                                <div class="metric-value">${stats.totalTasks}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                                <div class="metric-value success">${stats.completedTasks}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">–í —Ä–∞–±–æ—Ç–µ</div>
                                <div class="metric-value warning">${stats.inProgressTasks}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
                                <div class="metric-value ${stats.overdueTasks > 0 ? 'error' : ''}">${stats.overdueTasks}</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span class="metric-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                                <span class="metric-value" style="font-size: 16px;">${stats.progress}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${stats.progress}%"></div>
                            </div>
                        </div>
                        ${isAdmin ? `
                        <div class="company-summary" id="summary-container-${company.id.replace(/[^a-zA-Z0-9]/g, '-')}">
                            <div class="company-summary-label">–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –ø—Ä–æ–µ–∫—Ç–∞</div>
                            <textarea 
                                id="${summaryInputId}" 
                                class="company-summary-input" 
                                placeholder="–û–ø–∏—à–∏—Ç–µ —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞, –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏ –ø–ª–∞–Ω—ã –Ω–∞ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è..."
                                oninput="autoResizeTextarea(this)"
                                onclick="event.stopPropagation()"
                                onfocus="event.stopPropagation(); showSaveButton('${escapeHtml(company.id)}')"
                                onblur="handleSummaryBlur('${escapeHtml(company.id)}')"
                            >${escapeHtml(summaryValue)}</textarea>
                            <div class="company-summary-actions">
                                <button 
                                    class="company-summary-save-btn" 
                                    id="save-btn-${company.id.replace(/[^a-zA-Z0-9]/g, '-')}"
                                    onclick="event.stopPropagation(); saveCompanySummary('${escapeHtml(company.id)}')"
                                >
                                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        ${hasUpcoming && stats.upcomingDeadlinesList && stats.upcomingDeadlinesList.length > 0 ? `
                        <div class="upcoming-deadlines-section" style="margin-top: 12px; padding: 10px; background: rgba(255, 152, 0, 0.1); border-radius: 6px; font-size: 11px; position: relative; z-index: 1;">
                            <div style="font-weight: 600; margin-bottom: 6px; font-size: 12px; color: #ff9800;">‚ö†Ô∏è ${stats.upcomingDeadlines} –¥–µ–¥–ª–∞–π–Ω(–æ–≤) –≤ –±–ª–∏–∂–∞–π—à–∏–µ 7 –¥–Ω–µ–π</div>
                            ${stats.upcomingDeadlinesList.slice(0, 3).map(task => {
                                const deadlineStr = task.deadline.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                                return `<div style="margin-top: 4px; padding-left: 8px; border-left: 2px solid #ff9800;">
                                    <div class="deadline-task-name" style="font-weight: 500; opacity: 1 !important;">${escapeHtml(task.name)}</div>
                                    <div class="deadline-task-info" style="font-size: 10px; opacity: 0.8 !important;">–î–µ–¥–ª–∞–π–Ω: ${deadlineStr} (—á–µ—Ä–µ–∑ ${task.daysUntil} –¥–Ω.)</div>
                                </div>`;
                            }).join('')}
                            ${stats.upcomingDeadlinesList.length > 3 ? `<div class="deadline-task-info" style="margin-top: 4px; font-size: 10px; opacity: 0.8 !important;">...–∏ –µ—â–µ ${stats.upcomingDeadlinesList.length - 3}</div>` : ''}
                        </div>
                        ` : ''}
                        ${hasOverdue && stats.overdueTasksList && stats.overdueTasksList.length > 0 ? `
                        <div class="overdue-tasks-section" style="margin-top: 12px; padding: 10px; background: rgba(244, 67, 54, 0.1); border-radius: 6px; font-size: 11px; position: relative; z-index: 1;">
                            <div style="font-weight: 600; margin-bottom: 6px; font-size: 12px; color: #f44336;">üö® ${stats.overdueTasks} –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</div>
                            ${stats.overdueTasksList.slice(0, 3).map(task => {
                                const deadlineStr = task.deadline.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                                return `<div style="margin-top: 4px; padding-left: 8px; border-left: 2px solid #f44336;">
                                    <div class="deadline-task-name" style="font-weight: 500; opacity: 1 !important;">${escapeHtml(task.name)}</div>
                                    <div class="deadline-task-info" style="font-size: 10px; opacity: 0.8 !important;">–î–µ–¥–ª–∞–π–Ω: ${deadlineStr} (${task.daysOverdue} –¥–Ω.)</div>
                                </div>`;
                            }).join('')}
                            ${stats.overdueTasksList.length > 3 ? `<div class="deadline-task-info" style="margin-top: 4px; font-size: 10px; opacity: 0.8 !important;">...–∏ –µ—â–µ ${stats.overdueTasksList.length - 3}</div>` : ''}
                        </div>
                        ` : ''}
                        ${!isArchived ? `
                        <div class="company-actions" onclick="event.stopPropagation()">
                            <a href="implementation_schedule.html?company=${encodeURIComponent(company.id)}" class="btn-open-gantt">–û—Ç–∫—Ä—ã—Ç—å –≥—Ä–∞—Ñ–∏–∫</a>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –≤—Å–µ—Ö textarea –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            // –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–∑—é–º–µ
            setTimeout(() => {
                document.querySelectorAll('.company-summary-input').forEach(textarea => {
                    autoResizeTextarea(textarea);
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                    const companyId = textarea.id.replace('summary-', '').replace(/-/g, '');
                    const company = allCompanies.find(c => c.id === companyId || c.id.replace(/[^a-zA-Z0-9]/g, '-') === companyId);
                    if (company) {
                        originalSummaryValues[company.id] = textarea.value;
                    }
                });
            }, 0);
        }

        function updateOverallStats() {
            const totalProjects = filteredCompanies.length;
            let totalTasks = 0;
            let totalOverdue = 0;
            let totalProgress = 0;

            filteredCompanies.forEach(({ stats }) => {
                totalTasks += stats.totalTasks;
                totalOverdue += stats.overdueTasks;
                totalProgress += stats.progress;
            });

            const avgProgress = filteredCompanies.length > 0 
                ? Math.round(totalProgress / filteredCompanies.length) 
                : 0;

            document.getElementById('totalProjects').textContent = totalProjects;
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('overdueTasks').textContent = totalOverdue;
            document.getElementById('avgProgress').textContent = avgProgress + '%';
        }

        function openCompany(companyId) {
            window.location.href = `implementation_schedule.html?company=${encodeURIComponent(companyId)}`;
        }

        // ========== –ó–ê–ì–†–£–ó–ö–ê HTML2PDF ==========
        let html2pdfLoaded = false;
        let html2pdfLoading = false;

        function loadHtml2Pdf() {
            return new Promise((resolve, reject) => {
                // –ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
                if (html2pdfLoaded && typeof html2pdf !== 'undefined') {
                    resolve();
                    return;
                }
                
                // –ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –∂–¥—ë–º
                if (html2pdfLoading) {
                    const checkInterval = setInterval(() => {
                        if (html2pdfLoaded && typeof html2pdf !== 'undefined') {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                    return;
                }
                
                // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                html2pdfLoading = true;
                const script = document.createElement('script');
                script.src = 'html2pdf.bundle.min.js?v=0.10.1';
                script.async = true;
                script.onload = () => {
                    html2pdfLoaded = true;
                    html2pdfLoading = false;
                    if (typeof html2pdf !== 'undefined') {
                        resolve();
                    } else {
                        reject(new Error('html2pdf –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è'));
                    }
                };
                script.onerror = () => {
                    html2pdfLoading = false;
                    reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å html2pdf.js. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.'));
                };
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç 10 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    if (!html2pdfLoaded) {
                        html2pdfLoading = false;
                        script.remove();
                        reject(new Error('–¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ html2pdf.js'));
                    }
                }, 10000);
                
                document.head.appendChild(script);
            });
        }

        // ========== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –í–´–ë–û–†–ê –≠–ö–°–ü–û–†–¢–ê ==========
        function showPDFExportModal() {
            const modal = document.createElement('div');
            modal.id = 'pdfExportModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; border-radius: 16px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';
            
            modalContent.innerHTML = `
                <h2 style="margin: 0 0 20px 0; font-size: 24px; color: #212121; font-weight: 600; text-align: center;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞</h2>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="pdf-export-option" data-type="all" style="padding: 16px; border: 2px solid #e0e0e0; border-radius: 12px; background: white; cursor: pointer; font-size: 16px; font-weight: 500; color: #212121; transition: all 0.3s ease; text-align: left;">
                        <div style="font-weight: 600; margin-bottom: 4px;">–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏</div>
                        <div style="font-size: 13px; color: #757575;">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</div>
                    </button>
                    <button class="pdf-export-option" data-type="active" style="padding: 16px; border: 2px solid #e0e0e0; border-radius: 12px; background: white; cursor: pointer; font-size: 16px; font-weight: 500; color: #212121; transition: all 0.3s ease; text-align: left;">
                        <div style="font-weight: 600; margin-bottom: 4px;">–ê–∫—Ç–∏–≤–Ω—ã–µ</div>
                        <div style="font-size: 13px; color: #757575;">–¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</div>
                    </button>
                    <button class="pdf-export-option" data-type="archived" style="padding: 16px; border: 2px solid #e0e0e0; border-radius: 12px; background: white; cursor: pointer; font-size: 16px; font-weight: 500; color: #212121; transition: all 0.3s ease; text-align: left;">
                        <div style="font-weight: 600; margin-bottom: 4px;">–ê—Ä—Ö–∏–≤–Ω—ã–µ</div>
                        <div style="font-size: 13px; color: #757575;">–¢–æ–ª—å–∫–æ –∞—Ä—Ö–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</div>
                    </button>
                </div>
                <button id="cancelPdfExport" style="margin-top: 20px; padding: 12px; width: 100%; border: 1px solid #e0e0e0; border-radius: 8px; background: #f5f5f5; cursor: pointer; font-size: 14px; color: #757575; transition: all 0.3s ease;">
                    –û—Ç–º–µ–Ω–∞
                </button>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // –°—Ç–∏–ª–∏ –¥–ª—è –æ–ø—Ü–∏–π
            const style = document.createElement('style');
            style.textContent = `
                .pdf-export-option:hover {
                    border-color: #2196f3 !important;
                    background: #e3f2fd !important;
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
                }
                .pdf-export-option:active {
                    transform: translateY(0);
                }
                #cancelPdfExport:hover {
                    background: #eeeeee !important;
                    border-color: #bdbdbd !important;
                }
            `;
            document.head.appendChild(style);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            modalContent.querySelectorAll('.pdf-export-option').forEach(btn => {
                btn.addEventListener('click', () => {
                    const exportType = btn.getAttribute('data-type');
                    document.body.removeChild(modal);
                    document.head.removeChild(style);
                    exportDashboardToPDF(exportType);
                });
            });
            
            document.getElementById('cancelPdfExport').addEventListener('click', () => {
                document.body.removeChild(modal);
                document.head.removeChild(style);
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    document.head.removeChild(style);
                }
            });
        }

        // ========== –≠–ö–°–ü–û–†–¢ –î–ê–®–ë–û–†–î–ê –í PDF ==========
        async function exportDashboardToPDF(exportType = 'all') {
            try {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
                let companiesToExport = [];
                
                if (allCompanies && allCompanies.length > 0 && allStats && allStats.length > 0) {
                    // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–º–ø–∞–Ω–∏–π —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
                    const companiesWithStats = allCompanies.map(company => {
                        const stats = allStats.find(s => s.companyId === company.id);
                        return { company, stats: stats || {
                            totalTasks: 0,
                            completedTasks: 0,
                            inProgressTasks: 0,
                            pendingTasks: 0,
                            overdueTasks: 0,
                            overdueTasksList: [],
                            upcomingDeadlines: 0,
                            upcomingDeadlinesList: [],
                            progress: 0,
                            lastTaskDate: null,
                            projectStartDate: null,
                            projectEndDate: null
                        }};
                    });
                    
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–∏–ø—É —ç–∫—Å–ø–æ—Ä—Ç–∞
                    if (exportType === 'active') {
                        companiesToExport = companiesWithStats.filter(({ company }) => !company.archived);
                    } else if (exportType === 'archived') {
                        companiesToExport = companiesWithStats.filter(({ company }) => company.archived === true);
                    } else {
                        companiesToExport = companiesWithStats;
                    }
                } else {
                    alert('–ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
                    return;
                }
                
                if (companiesToExport.length === 0) {
                    alert(`–ù–µ—Ç ${exportType === 'active' ? '–∞–∫—Ç–∏–≤–Ω—ã—Ö' : exportType === 'archived' ? '–∞—Ä—Ö–∏–≤–Ω—ã—Ö' : ''} –∫–æ–º–ø–∞–Ω–∏–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.`);
                    return;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const loadingIndicator = document.createElement('div');
                loadingIndicator.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF...';
                loadingIndicator.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px 40px; border-radius: 8px; z-index: 100000; font-size: 16px;';
                document.body.appendChild(loadingIndicator);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É
                await loadHtml2Pdf();

                if (typeof html2pdf === 'undefined') {
                    alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ html2pdf –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                    document.body.removeChild(loadingIndicator);
                    return;
                }

                // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
                const exportWrapper = document.createElement('div');
                exportWrapper.style.cssText = 'position: fixed; top: 0; left: 0; width: 794px; min-height: 100px; background: white; padding: 40px; box-sizing: border-box; z-index: -9999; opacity: 0; pointer-events: none; overflow: visible;';
                exportWrapper.id = 'pdf-export-wrapper';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–æ—Ç–∏–ø –≤ –ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª
                const logoContainer = document.createElement('div');
                logoContainer.style.cssText = 'position: absolute; top: 20px; right: 20px; opacity: 0.3; z-index: 10;';
                logoContainer.innerHTML = `<img src="logo.png" alt="Logo" style="width: 80px; height: 80px; object-fit: contain;" onerror="this.style.display='none';">`;
                exportWrapper.appendChild(logoContainer);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                const headerTitle = exportType === 'archived' ? '–î–∞—à–±–æ—Ä–¥ –∞—Ä—Ö–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤' : '–î–∞—à–±–æ—Ä–¥ –ø—Ä–æ–µ–∫—Ç–æ–≤';
                const header = document.createElement('div');
                header.style.cssText = 'text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #2196f3; position: relative;';
                header.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px;">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="#2196f3" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                        </svg>
                        <h1 style="font-size: 32px; margin: 0; color: #212121; font-weight: 700;">${headerTitle}</h1>
                    </div>
                    <p style="font-size: 14px; color: #757575; margin: 0;">${new Date().toLocaleDateString('ru-RU', { day: '2-digit', month: 'long', year: 'numeric' })}</p>
                `;
                exportWrapper.appendChild(header);

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const statsSection = document.createElement('div');
                statsSection.style.cssText = 'margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, #f5f5f5 0%, #e8f4f8 100%); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
                const totalProjects = companiesToExport.length;
                const totalTasks = companiesToExport.reduce((sum, {stats}) => sum + (stats.totalTasks || 0), 0);
                const totalOverdue = companiesToExport.reduce((sum, {stats}) => sum + (stats.overdueTasks || 0), 0);
                const avgProgress = companiesToExport.length > 0 ? Math.round(companiesToExport.reduce((sum, {stats}) => sum + (stats.progress || 0), 0) / companiesToExport.length) : 0;
                
                statsSection.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="#2196f3" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                        <h2 style="font-size: 22px; margin: 0; color: #212121; font-weight: 600;">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 100%; box-sizing: border-box;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="#2196f3" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                                <div style="font-size: 11px; color: #757575; font-weight: 500;">–í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤</div>
                            </div>
                            <div style="font-size: 28px; font-weight: 700; color: #2196f3;">${totalProjects}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="#4caf50" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                                </svg>
                                <div style="font-size: 11px; color: #757575; font-weight: 500;">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                            </div>
                            <div style="font-size: 28px; font-weight: 700; color: #4caf50;">${totalTasks}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #f44336; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="#f44336" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                                </svg>
                                <div style="font-size: 11px; color: #757575; font-weight: 500;">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</div>
                            </div>
                            <div style="font-size: 28px; font-weight: 700; color: #f44336;">${totalOverdue}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="#4caf50" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                                <div style="font-size: 11px; color: #757575; font-weight: 500;">–°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
                            </div>
                            <div style="font-size: 28px; font-weight: 700; color: #4caf50;">${avgProgress}%</div>
                        </div>
                    </div>
                `;
                exportWrapper.appendChild(statsSection);

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–∞–∑–¥–µ–ª–∞ –∫–æ–º–ø–∞–Ω–∏–π
                const companiesHeader = document.createElement('div');
                companiesHeader.style.cssText = 'margin-top: 130px; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;';
                companiesHeader.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="#2196f3" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/>
                        </svg>
                        <h2 style="font-size: 22px; margin: 0; color: #212121; font-weight: 600;">–ö–æ–º–ø–∞–Ω–∏–∏ (${companiesToExport.length})</h2>
                    </div>
                `;
                exportWrapper.appendChild(companiesHeader);

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π —Å —Ñ–æ–Ω–æ–≤—ã–º–∏ –∏–∫–æ–Ω–∫–∞–º–∏
                const companiesGrid = document.createElement('div');
                companiesGrid.style.cssText = 'display: block; width: 100%; box-sizing: border-box; position: relative; min-height: 2000px;';
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –∏–∫–æ–Ω–∫–∏ (–≤–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏ - –±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω—ã–µ)
                const backgroundIcons = document.createElement('div');
                backgroundIcons.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; min-height: 2000px; z-index: 0; pointer-events: none; opacity: 0.25; overflow: hidden;';
                backgroundIcons.innerHTML = `
                    <svg style="position: absolute; top: 5%; left: 3%; width: 300px; height: 300px;" viewBox="0 0 24 24" fill="#2196f3" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/>
                    </svg>
                    <svg style="position: absolute; top: 25%; right: 5%; width: 280px; height: 280px;" viewBox="0 0 24 24" fill="#4caf50" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                    <svg style="position: absolute; top: 50%; left: 5%; width: 260px; height: 260px;" viewBox="0 0 24 24" fill="#ff9800" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                    </svg>
                    <svg style="position: absolute; top: 70%; right: 3%; width: 290px; height: 290px;" viewBox="0 0 24 24" fill="#f44336" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                    <svg style="position: absolute; top: 40%; left: 50%; transform: translateX(-50%); width: 220px; height: 220px;" viewBox="0 0 24 24" fill="#2196f3" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                    </svg>
                    <svg style="position: absolute; top: 15%; left: 50%; transform: translateX(-50%); width: 240px; height: 240px;" viewBox="0 0 24 24" fill="#4caf50" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    <svg style="position: absolute; top: 85%; left: 20%; width: 270px; height: 270px;" viewBox="0 0 24 24" fill="#2196f3" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/>
                    </svg>
                `;
                companiesGrid.appendChild(backgroundIcons);
                
                companiesToExport.forEach(({ company, stats }) => {
                    const card = document.createElement('div');
                    card.className = 'company-card';
                    card.style.cssText = 'border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; background: white; page-break-inside: avoid; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; width: 100%; box-sizing: border-box; break-inside: avoid; overflow: visible; position: relative; z-index: 1;';
                    
                    const logoData = company.logoData || '';
                    const firstLetter = company.name ? company.name.charAt(0).toUpperCase() : '?';
                    
                    let logoHtml = '';
                    if (logoData) {
                        logoHtml = `<img src="${logoData}" alt="${company.name}" style="width: 60px; height: 60px; border-radius: 10px; object-fit: contain; margin-right: 15px; border: 2px solid #e0e0e0;">`;
                    } else {
                        logoHtml = `<div style="width: 60px; height: 60px; background: linear-gradient(135deg, #2196f3, #42a5f5); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 28px; margin-right: 15px; box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);">${firstLetter}</div>`;
                    }
                    
                    const overdueTasksHtml = stats.overdueTasksList && stats.overdueTasksList.length > 0 
                        ? `<div style="margin-top: 12px; padding: 10px; background: rgba(244, 67, 54, 0.1); border-radius: 6px; font-size: 11px; border-left: 3px solid #f44336;">
                            <div style="display: flex; align-items: center; gap: 6px; font-weight: 600; margin-bottom: 6px; color: #f44336;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="#f44336" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                                </svg>
                                ${stats.overdueTasks} –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
                            </div>
                            ${stats.overdueTasksList.slice(0, 2).map(task => {
                                const deadlineStr = task.deadline.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                                return `<div style="margin-top: 4px; padding-left: 10px; border-left: 2px solid #f44336;">
                                    <div style="font-weight: 500; color: #000; font-size: 11px;">${escapeHtml(task.name)}</div>
                                    <div style="font-size: 10px; color: #000; opacity: 0.7;">–î–µ–¥–ª–∞–π–Ω: ${deadlineStr} (${task.daysOverdue} –¥–Ω.)</div>
                                </div>`;
                            }).join('')}
                        </div>`
                        : '';
                    
                    const upcomingDeadlinesHtml = stats.upcomingDeadlinesList && stats.upcomingDeadlinesList.length > 0 
                        ? `<div style="margin-top: 12px; padding: 10px; background: rgba(255, 152, 0, 0.1); border-radius: 6px; font-size: 11px; border-left: 3px solid #ff9800;">
                            <div style="display: flex; align-items: center; gap: 6px; font-weight: 600; margin-bottom: 6px; color: #ff9800;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="#ff9800" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                                </svg>
                                ${stats.upcomingDeadlines} –¥–µ–¥–ª–∞–π–Ω(–æ–≤) –≤ –±–ª–∏–∂–∞–π—à–∏–µ 7 –¥–Ω–µ–π
                            </div>
                            ${stats.upcomingDeadlinesList.slice(0, 2).map(task => {
                                const deadlineStr = task.deadline.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                                return `<div style="margin-top: 4px; padding-left: 10px; border-left: 2px solid #ff9800;">
                                    <div style="font-weight: 500; color: #000; font-size: 11px;">${escapeHtml(task.name)}</div>
                                    <div style="font-size: 10px; color: #000; opacity: 0.7;">–î–µ–¥–ª–∞–π–Ω: ${deadlineStr} (—á–µ—Ä–µ–∑ ${task.daysUntil} –¥–Ω.)</div>
                                </div>`;
                            }).join('')}
                        </div>`
                        : '';
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                    const startDateStr = stats.projectStartDate 
                        ? new Date(stats.projectStartDate).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' })
                        : '‚Äî';
                    const endDateStr = stats.projectEndDate 
                        ? new Date(stats.projectEndDate).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' })
                        : '‚Äî';
                    
                    card.innerHTML = `
                        <div style="display: flex; align-items: center; margin-bottom: 18px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">
                            ${logoHtml}
                            <div style="flex: 1;">
                                <div style="font-size: 20px; font-weight: 700; color: #212121; margin-bottom: 4px;">${escapeHtml(company.name)}</div>
                                <div style="font-size: 12px; color: #757575; display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="#757575" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                    ID: ${escapeHtml(company.id)}
                                </div>
                                <div style="display: flex; gap: 20px; font-size: 11px; color: #757575; margin-top: 6px;">
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="#2196f3" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2.5-9H19V1h-2v1H7V1H5v1H3.5C2.67 2 2 2.67 2 3.5v17C2 21.33 2.67 22 3.5 22h17c.83 0 1.5-.67 1.5-1.5v-17C22 2.67 21.33 2 20.5 2zM20 20H4V9h16v11z"/>
                                        </svg>
                                        <span style="font-weight: 500; color: #2196f3;">–ù–∞—á–∞–ª–æ:</span> ${startDateStr}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="#f44336" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2.5-9H19V1h-2v1H7V1H5v1H3.5C2.67 2 2 2.67 2 3.5v17C2 21.33 2.67 22 3.5 22h17c.83 0 1.5-.67 1.5-1.5v-17C22 2.67 21.33 2 20.5 2zM20 20H4V9h16v11z"/>
                                        </svg>
                                        <span style="font-weight: 500; color: #f44336;">–û–∫–æ–Ω—á–∞–Ω–∏–µ:</span> ${endDateStr}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; width: 100%; box-sizing: border-box;">
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 3px solid #2196f3;">
                                <div style="font-size: 10px; color: #757575; margin-bottom: 6px; font-weight: 500; text-transform: uppercase;">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                                <div style="font-size: 22px; font-weight: 700; color: #2196f3;">${stats.totalTasks || 0}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 3px solid #4caf50;">
                                <div style="font-size: 10px; color: #757575; margin-bottom: 6px; font-weight: 500; text-transform: uppercase;">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                                <div style="font-size: 22px; font-weight: 700; color: #4caf50;">${stats.completedTasks || 0}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 3px solid #ff9800;">
                                <div style="font-size: 10px; color: #757575; margin-bottom: 6px; font-weight: 500; text-transform: uppercase;">–í —Ä–∞–±–æ—Ç–µ</div>
                                <div style="font-size: 22px; font-weight: 700; color: #ff9800;">${stats.inProgressTasks || 0}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 3px solid ${stats.overdueTasks > 0 ? '#f44336' : '#757575'};">
                                <div style="font-size: 10px; color: #757575; margin-bottom: 6px; font-weight: 500; text-transform: uppercase;">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
                                <div style="font-size: 22px; font-weight: 700; color: ${stats.overdueTasks > 0 ? '#f44336' : '#757575'};}">${stats.overdueTasks || 0}</div>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <span style="font-size: 11px; color: #757575; font-weight: 500; text-transform: uppercase;">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                                <span style="font-size: 16px; font-weight: 700; color: #212121;">${stats.progress || 0}%</span>
                            </div>
                            <div style="width: 100%; height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="width: ${stats.progress || 0}%; height: 100%; background: linear-gradient(90deg, #4caf50, #2196f3); border-radius: 5px; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                        ${company.summary ? `<div style="margin-top: 12px; padding: 12px; background: linear-gradient(135deg, #f5f5f5 0%, #fafafa 100%); border-radius: 8px; font-size: 11px; color: #212121; border-left: 3px solid #2196f3;">
                            <div style="display: flex; align-items: center; gap: 6px; font-weight: 600; margin-bottom: 6px; color: #2196f3;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="#2196f3" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                                </svg>
                                –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ
                            </div>
                            <div style="line-height: 1.5;">${escapeHtml(company.summary)}</div>
                        </div>` : ''}
                        ${upcomingDeadlinesHtml}
                        ${overdueTasksHtml}
                    `;
                    companiesGrid.appendChild(card);
                });
                
                exportWrapper.appendChild(companiesGrid);
                document.body.appendChild(exportWrapper);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ñ–æ–Ω–æ–≤—ã—Ö –∏–∫–æ–Ω–æ–∫ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
                setTimeout(() => {
                    const actualHeight = companiesGrid.scrollHeight;
                    backgroundIcons.style.minHeight = actualHeight + 'px';
                    backgroundIcons.style.height = actualHeight + 'px';
                    console.log('–í—ã—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞:', actualHeight);
                }, 100);

                // –î–µ–ª–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∏–¥–∏–º—ã–º –¥–ª—è html2canvas (–Ω–æ –Ω–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
                exportWrapper.style.opacity = '1';
                exportWrapper.style.visibility = 'visible';

                // –ñ–¥–µ–º, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∑–∏–ª—Å—è –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
                await new Promise(resolve => setTimeout(resolve, 800));

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –µ—Å—Ç—å
                const hasContent = exportWrapper.children.length > 0 && exportWrapper.scrollHeight > 100;
                if (!hasContent) {
                    console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—É—Å—Ç–æ–π!', {
                        children: exportWrapper.children.length,
                        height: exportWrapper.scrollHeight,
                        companies: companiesToExport.length
                    });
                    alert('–û—à–∏–±–∫–∞: –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø—É—Å—Ç–æ–π. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏ –≤ –¥–∞—à–±–æ—Ä–¥–µ.');
                    document.body.removeChild(exportWrapper);
                    document.body.removeChild(loadingIndicator);
                    return;
                }

                console.log('–ö–æ–Ω—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞:', {
                    companies: companiesToExport.length,
                    height: exportWrapper.scrollHeight,
                    width: exportWrapper.scrollWidth
                });

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è PDF
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: `–î–∞—à–±–æ—Ä–¥_–ø—Ä–æ–µ–∫—Ç–æ–≤_${new Date().toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2, 
                        useCORS: true,
                        logging: false,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        width: 794,
                        height: exportWrapper.scrollHeight,
                        x: 0,
                        y: 0,
                        scrollX: 0,
                        scrollY: 0,
                        windowWidth: 794,
                        windowHeight: exportWrapper.scrollHeight
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'], avoid: ['.company-card'] }
                };

                console.log('–ù–∞—á–∏–Ω–∞–µ–º —ç–∫—Å–ø–æ—Ä—Ç PDF, –∫–æ–º–ø–∞–Ω–∏–π:', companiesToExport.length);
                console.log('–†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:', exportWrapper.scrollWidth, 'x', exportWrapper.scrollHeight);

                html2pdf()
                    .set(opt)
                    .from(exportWrapper)
                    .outputPdf('blob')
                    .then((pdfBlob) => {
                        const url = URL.createObjectURL(pdfBlob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = opt.filename;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        setTimeout(() => {
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        }, 100);
                        
                        if (exportWrapper.parentNode) {
                            document.body.removeChild(exportWrapper);
                        }
                        loadingIndicator.textContent = 'PDF –≥–æ—Ç–æ–≤!';
                        setTimeout(() => {
                            if (loadingIndicator.parentNode) {
                                document.body.removeChild(loadingIndicator);
                            }
                        }, 3000);
                    })
                    .catch((err) => {
                        console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF:', err);
                        if (exportWrapper.parentNode) {
                            document.body.removeChild(exportWrapper);
                        }
                        if (loadingIndicator.parentNode) {
                            document.body.removeChild(loadingIndicator);
                        }
                        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF: ' + (err.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ PDF: ' + (error.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        }

        // ========== –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ï–ó–Æ–ú–ï –ö–û–ú–ü–ê–ù–ò–ò ==========
        let originalSummaryValues = {}; // –•—Ä–∞–Ω–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

        function autoResizeTextarea(textarea) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π scrollHeight
            textarea.style.height = 'auto';
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—É—é –≤—ã—Å–æ—Ç—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function showSaveButton(companyId) {
            const containerId = `summary-container-${companyId.replace(/[^a-zA-Z0-9]/g, '-')}`;
            const container = document.getElementById(containerId);
            if (container) {
                container.classList.add('has-focus');
            }
        }

        function handleSummaryBlur(companyId) {
            // –ù–µ —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å—Ä–∞–∑—É, –¥–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ
            setTimeout(() => {
                const containerId = `summary-container-${companyId.replace(/[^a-zA-Z0-9]/g, '-')}`;
                const container = document.getElementById(containerId);
                const textarea = document.getElementById(`summary-${companyId.replace(/[^a-zA-Z0-9]/g, '-')}`);
                const saveBtn = document.getElementById(`save-btn-${companyId.replace(/[^a-zA-Z0-9]/g, '-')}`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ñ–æ–∫—É—Å –Ω–∞ –∫–Ω–æ–ø–∫–µ –∏–ª–∏ textarea
                if (container && document.activeElement !== textarea && document.activeElement !== saveBtn) {
                    container.classList.remove('has-focus');
                }
            }, 200);
        }

        async function saveCompanySummary(companyId) {
            const textareaId = `summary-${companyId.replace(/[^a-zA-Z0-9]/g, '-')}`;
            const textarea = document.getElementById(textareaId);
            const saveBtn = document.getElementById(`save-btn-${companyId.replace(/[^a-zA-Z0-9]/g, '-')}`);
            
            if (!textarea) {
                console.error('Textarea –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }

            const summary = textarea.value;
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤–æ –≤—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            }

            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                const userStr = localStorage.getItem('gantt-user');
                let userName = 'Unknown';
                let userLogin = null;
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (userStr) {
                    try {
                        const user = JSON.parse(userStr);
                        userLogin = user.login || null;
                        userName = user.name || user.login || 'Unknown';
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–∫–∞–∫ –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö –∫–æ–¥–∞)
                        if (userLogin) {
                            headers['X-User-Login'] = userLogin;
                        }
                        if (user.name) {
                            // –ö–æ–¥–∏—Ä—É–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ base64 –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
                            try {
                                const encodedName = btoa(encodeURIComponent(user.name));
                                headers['X-User-Name'] = encodedName;
                                headers['X-User-Name-Encoded'] = 'base64';
                            } catch (e) {
                                console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
                            }
                        }
                    } catch (e) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
                    }
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—é–º–µ —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π endpoint
                const saveResponse = await fetch(`/api/company-summary?company=${encodeURIComponent(companyId)}`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ 
                        summary: summary,
                        userName: userName,
                        userLogin: userLogin // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–∏–Ω –≤ body –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                    })
                });

                if (saveResponse.ok) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    const company = allCompanies.find(c => c.id === companyId);
                    if (company) {
                        company.summary = summary;
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ
                    originalSummaryValues[companyId] = summary;
                    
                    console.log(`–†–µ–∑—é–º–µ –∫–æ–º–ø–∞–Ω–∏–∏ ${companyId} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ`);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                    const originalBorder = textarea.style.borderColor;
                    textarea.style.borderColor = '#4caf50';
                    setTimeout(() => {
                        textarea.style.borderColor = originalBorder || '';
                    }, 1000);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                    if (saveBtn) {
                        saveBtn.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
                        setTimeout(() => {
                            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                            saveBtn.disabled = false;
                        }, 2000);
                    }
                } else {
                    const errorText = await saveResponse.text();
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—é–º–µ:', errorText);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—é–º–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—é–º–µ:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—é–º–µ.');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                }
            }
        }

        // ========== –ö–ê–°–¢–û–ú–ù–´–ï –í–´–ü–ê–î–ê–Æ–©–ò–ï –°–ü–ò–°–ö–ò ==========
        function initCustomSelects() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–µ–ª–µ–∫—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
            const statusSelect = document.getElementById('statusFilterCustom');
            const statusTrigger = document.getElementById('statusFilterTrigger');
            const statusOptions = statusSelect?.querySelectorAll('.custom-select-option');
            const statusNativeSelect = document.getElementById('statusFilter');

            if (statusSelect && statusTrigger && statusOptions && statusNativeSelect) {
                statusTrigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeAllSelects();
                    statusSelect.classList.toggle('open');
                });

                statusOptions.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const value = option.getAttribute('data-value');
                        const text = option.textContent;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–∏–≥–≥–µ—Ä
                        statusTrigger.textContent = text;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π select
                        statusNativeSelect.value = value;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Å
                        statusOptions.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                        statusSelect.classList.remove('open');
                        
                        // –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        applyFilters();
                        renderDashboard();
                    });
                });
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–µ–ª–µ–∫—Ç–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            const sortSelect = document.getElementById('sortFilterCustom');
            const sortTrigger = document.getElementById('sortFilterTrigger');
            const sortOptions = sortSelect?.querySelectorAll('.custom-select-option');
            const sortNativeSelect = document.getElementById('sortFilter');

            if (sortSelect && sortTrigger && sortOptions && sortNativeSelect) {
                sortTrigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeAllSelects();
                    sortSelect.classList.toggle('open');
                });

                sortOptions.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const value = option.getAttribute('data-value');
                        const text = option.textContent;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–∏–≥–≥–µ—Ä
                        sortTrigger.textContent = text;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π select
                        sortNativeSelect.value = value;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Å
                        sortOptions.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                        sortSelect.classList.remove('open');
                        
                        // –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        applyFilters();
                        renderDashboard();
                    });
                });
            }

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-select')) {
                    closeAllSelects();
                }
            });
        }

        function closeAllSelects() {
            document.querySelectorAll('.custom-select').forEach(select => {
                select.classList.remove('open');
            });
        }

        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========
        document.getElementById('statusFilter')?.addEventListener('change', () => {
            applyFilters();
            renderDashboard();
        });

        document.getElementById('sortFilter')?.addEventListener('change', () => {
            applyFilters();
            renderDashboard();
        });

        document.getElementById('searchInput')?.addEventListener('input', () => {
            applyFilters();
            renderDashboard();
        });

        // ========== –°–í–ï–¢–õ–Ø–ß–ö–ò ==========
        let fireflyAnimationIds = [];
        let fireflies = [];
        let mouseX = 0;
        let mouseY = 0;
        let isPageVisible = true;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('visibilitychange', () => {
            isPageVisible = !document.hidden;
        });

        function initFireflies() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Å–≤–µ—Ç–ª—è—á–∫–æ–≤
            for (let i = 1; i <= 12; i++) {
                const firefly = document.getElementById(`dashboard-firefly-${i}`);
                if (!firefly) continue;

                const fireflyData = {
                    element: firefly,
                    x: 0,
                    y: 0,
                    vx: 0,
                    vy: 0,
                    id: i
                };

                // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è - —Å–ª—É—á–∞–π–Ω–∞—è –≤–Ω—É—Ç—Ä–∏ —ç–∫—Ä–∞–Ω–∞
                fireflyData.x = Math.random() * (window.innerWidth - 20) + 10;
                fireflyData.y = Math.random() * (window.innerHeight - 20) + 10;
                
                // –ù–∞—á–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (—Ä–∞–∑–Ω–∞—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ)
                fireflyData.vx = (Math.random() - 0.5) * 2;
                fireflyData.vy = (Math.random() - 0.5) * 2;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é —á–µ—Ä–µ–∑ transform3d –¥–ª—è –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–≥–æ —É—Å–∫–æ—Ä–µ–Ω–∏—è
                fireflyData.element.style.transform = `translate3d(${fireflyData.x}px, ${fireflyData.y}px, 0)`;

                fireflies.push(fireflyData);
            }

            // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—Å–æ—Ä–∞ –¥–ª—è —Å–≤–µ—Ç–ª—è—á–∫–æ–≤ —Å throttling
            let lastMouseUpdate = 0;
            const mouseUpdateThrottle = 50; // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –º–∞–∫—Å–∏–º—É–º —Ä–∞–∑ –≤ 50ms
            
            function updateMousePosition(clientX, clientY) {
                const now = Date.now();
                if (now - lastMouseUpdate >= mouseUpdateThrottle) {
                    mouseX = clientX;
                    mouseY = clientY;
                    lastMouseUpdate = now;
                }
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏ –¥–ª—è —Å–≤–µ—Ç–ª—è—á–∫–æ–≤ —Å throttling
            document.addEventListener('mousemove', function(e) {
                updateMousePosition(e.clientX, e.clientY);
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ touch —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Å–≤–µ—Ç–ª—è—á–∫–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
            document.addEventListener('touchmove', function(e) {
                if (e.touches.length > 0) {
                    updateMousePosition(e.touches[0].clientX, e.touches[0].clientY);
                }
            }, { passive: true });

            function animateFireflies() {
                if (fireflies.length === 0) {
                    fireflyAnimationIds.forEach(id => cancelAnimationFrame(id));
                    fireflyAnimationIds = [];
                    return;
                }

                // –ü–∞—É–∑–∞ –∞–Ω–∏–º–∞—Ü–∏–∏, –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –≤–∏–¥–Ω–∞
                if (!isPageVisible) {
                    const animationId = requestAnimationFrame(animateFireflies);
                    fireflyAnimationIds = [animationId];
                    return;
                }

                const fireflySize = 8;
                const speed = 1.5;
                const bounceDamping = 0.8;
                const escapeSpeed = 3;
                const escapeRadius = 100;

                fireflies.forEach(firefly => {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ –∫—É—Ä—Å–æ—Ä–∞ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ - –∏–∑–±–µ–≥–∞–µ–º sqrt)
                    const dx = mouseX - firefly.x;
                    const dy = mouseY - firefly.y;
                    const distanceSquared = dx * dx + dy * dy;
                    const escapeRadiusSquared = escapeRadius * escapeRadius;
                    const isMouseNear = distanceSquared < escapeRadiusSquared;

                    // –£–±–µ–≥–∞–Ω–∏–µ –æ—Ç –∫—É—Ä—Å–æ—Ä–∞
                    if (isMouseNear) {
                        const dist = Math.sqrt(distanceSquared);
                        if (dist > 0) {
                            firefly.vx = (dx / dist) * escapeSpeed;
                            firefly.vy = (dy / dist) * escapeSpeed;
                        }
                    } else {
                        // –û–±—ã—á–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å –Ω–µ–±–æ–ª—å—à–∏–º —Å–ª—É—á–∞–π–Ω—ã–º —É—Å–∫–æ—Ä–µ–Ω–∏–µ–º (—Ä–µ–∂–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
                        if (Math.random() > 0.7) { // –¢–æ–ª—å–∫–æ –≤ 30% —Å–ª—É—á–∞–µ–≤
                            firefly.vx += (Math.random() - 0.5) * 0.1;
                            firefly.vy += (Math.random() - 0.5) * 0.1;
                        }
                        
                        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
                        const speedSquared = firefly.vx * firefly.vx + firefly.vy * firefly.vy;
                        const maxSpeed = 3;
                        if (speedSquared > maxSpeed * maxSpeed) {
                            const currentSpeed = Math.sqrt(speedSquared);
                            firefly.vx = (firefly.vx / currentSpeed) * maxSpeed;
                            firefly.vy = (firefly.vy / currentSpeed) * maxSpeed;
                        }
                    }

                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
                    firefly.x += firefly.vx * speed;
                    firefly.y += firefly.vy * speed;

                    // –û—Ç—Å–∫–æ–∫ –æ—Ç —Å—Ç–µ–Ω
                    if (firefly.x <= fireflySize) {
                        firefly.x = fireflySize;
                        firefly.vx = Math.abs(firefly.vx) * bounceDamping;
                    } else if (firefly.x >= window.innerWidth - fireflySize) {
                        firefly.x = window.innerWidth - fireflySize;
                        firefly.vx = -Math.abs(firefly.vx) * bounceDamping;
                    }

                    if (firefly.y <= fireflySize) {
                        firefly.y = fireflySize;
                        firefly.vy = Math.abs(firefly.vy) * bounceDamping;
                    } else if (firefly.y >= window.innerHeight - fireflySize) {
                        firefly.y = window.innerHeight - fireflySize;
                        firefly.vy = -Math.abs(firefly.vy) * bounceDamping;
                    }

                    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–µ–∑ transform –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                    if (firefly.element) {
                        firefly.element.style.transform = `translate3d(${firefly.x}px, ${firefly.y}px, 0)`;
                    }
                });

                const animationId = requestAnimationFrame(animateFireflies);
                fireflyAnimationIds = [animationId];
            }

            // –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏
            animateFireflies();
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        loadCompanies();
        initFireflies();
    </script>
</body>
</html>
